name: Sync External Specifications

on:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-specs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout documentation repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clone specs repository
        run: |
          git clone --depth 1 https://github.com/samueljklee/amplifier-next-specs.git specs-source

      - name: Generate specs content hash
        id: hash
        run: |
          # Create hash of source content for change detection
          CONTENT_HASH=$(find specs-source -name "*.md" -exec cat {} \; | sha256sum | cut -d' ' -f1)
          echo "content_hash=$CONTENT_HASH" >> $GITHUB_OUTPUT

          # Check if hash file exists and compare
          if [ -f .specs-hash ]; then
            PREVIOUS_HASH=$(cat .specs-hash)
            if [ "$CONTENT_HASH" = "$PREVIOUS_HASH" ] && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
              echo "changes_detected=false" >> $GITHUB_OUTPUT
            else
              echo "changes_detected=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Transform markdown to HTML
        if: steps.hash.outputs.changes_detected == 'true'
        run: |
          node scripts/transform-specs.js

      - name: Update index.html
        if: steps.hash.outputs.changes_detected == 'true'
        run: |
          node scripts/inject-specs.js

      - name: Update hash file
        if: steps.hash.outputs.changes_detected == 'true'
        run: |
          echo "${{ steps.hash.outputs.content_hash }}" > .specs-hash

      - name: Create Pull Request
        if: steps.hash.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: sync specifications from amplifier-next-specs'
          title: '[Auto] Sync External Specifications'
          body: |
            ## Automated Specification Sync

            This PR updates the documentation with the latest specifications from
            [amplifier-next-specs](https://github.com/samueljklee/amplifier-next-specs).

            ### Changes
            - Updated INDEX.md content
            - Synced specification directories: tools, hooks, recipes, collections, integrations

            ### Review Checklist
            - [ ] Verify HTML formatting renders correctly
            - [ ] Check code block syntax highlighting
            - [ ] Validate table layouts
            - [ ] Test navigation to Contribute > Specifications section

            ---
            *This PR was automatically generated by the specs sync workflow.*
          branch: auto/sync-specs
          delete-branch: true
          labels: |
            documentation
            automated
          assignees: ${{ github.repository_owner }}

      - name: No changes detected
        if: steps.hash.outputs.changes_detected == 'false'
        run: |
          echo "No changes detected in source specifications. Skipping PR creation."
