<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amplifier Documentation</title>
  <link rel="icon" type="image/png" href="amplifierlogo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
  <!-- Mermaid.js for diagram rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    /* =================================================================
       DESIGN TOKENS - OpenAI-inspired Dark Palette
       ================================================================= */
    :root {
      --bg-0: #000000;         /* Main background (Pitch black) */
      --bg-1: #0a0a0a;         /* Sidebar background */
      --bg-2: #171717;         /* Card/input background */
      --bg-3: #212121;         /* Elevated surfaces */
      --bg-hover: #1a1a1a;
      --text-0: #ffffff;       /* Primary text */
      --text-1: #e5e5e5;       /* Secondary text */
      --text-2: #a3a3a3;       /* Tertiary text */
      --text-3: #737373;       /* Muted text */
      --border: #262626;
      --border-subtle: #1f1f1f;
      --accent: #10a37f;       /* OpenAI Green */
      --accent-dim: rgba(16, 163, 127, 0.15);
      --blue: #3b82f6;
      --green: #10b981;
      --purple: #a855f7;
      --orange: #f97316;
      --red: #ef4444;
      --sidebar-width: 220px;
      --header-height: 56px;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', 'Consolas', monospace;
      --radius: 8px;
      --transition: 150ms ease;
    }

    /* =================================================================
       RESET
       ================================================================= */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--bg-0);
      color: var(--text-0);
      min-height: 100vh;
      font-size: 15px;
      line-height: 1.6;
    }

    a { color: var(--blue); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* List styles */
    ul, ol {
      margin: 12px 0;
      padding-left: 28px;
    }

    li {
      margin-bottom: 6px;
      line-height: 1.6;
    }

    ul li { list-style-type: disc; }
    ol li { list-style-type: decimal; }

    /* =================================================================
       NAV
       ================================================================= */
    .nav {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }

    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-left { display: flex; align-items: center; gap: 32px; }

    .nav-logo {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-0);
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      cursor: pointer;
    }

    .nav-logo img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .nav-links { display: flex; gap: 4px; }

    .nav-link {
      padding: 8px 12px;
      border-radius: 6px;
      color: var(--text-1);
      font-size: 14px;
      background: none;
      border: none;
      cursor: pointer;
      transition: all var(--transition);
    }

    .nav-link:hover { color: var(--text-0); background: var(--bg-2); }
    .nav-link.active { color: var(--text-0); background: var(--bg-2); }

    .nav-right { display: flex; align-items: center; gap: 12px; }

    /* Layout Toggle */
    .layout-toggle {
      display: flex;
      gap: 2px;
      background: var(--bg-2);
      padding: 3px;
      border-radius: 6px;
    }

    .toggle-btn {
      background: none;
      border: none;
      padding: 5px 8px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-2);
      transition: all var(--transition);
      display: flex;
      align-items: center;
    }

    .toggle-btn:hover { color: var(--text-0); }
    .toggle-btn.active { background: var(--bg-3); color: var(--text-0); }
    .toggle-btn svg { width: 16px; height: 16px; }

    /* Sidebar (for sidebar layout mode) */
    .sidebar {
      position: fixed;
      top: 56px;
      left: 0;
      width: var(--sidebar-width);
      height: calc(100vh - 56px);
      background: var(--bg-1);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px 0;
      display: none;
    }

    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 2px; }

    .sidebar-toggle-all {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
      margin: 0 8px 12px 8px;
      font-size: 12px;
      color: var(--text-2);
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .sidebar-toggle-all:hover {
      color: var(--text-0);
      background: var(--bg-3);
    }

    .sidebar-toggle-all svg {
      width: 14px;
      height: 14px;
      transition: transform var(--transition);
    }

    .sidebar-toggle-all.collapsed svg {
      transform: rotate(180deg);
    }

    .sidebar-group { margin-bottom: 8px; }

    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      user-select: none;
    }

    .sidebar-header:hover { color: var(--text-0); }

    .sidebar-arrow {
      width: 12px;
      height: 12px;
      margin-right: 6px;
      transition: transform var(--transition);
      color: var(--text-2);
    }

    .sidebar-header.open .sidebar-arrow { transform: rotate(90deg); }

    .sidebar-items { display: none; padding-left: 20px; }
    .sidebar-items.show { display: block; }

    .sidebar-item {
      display: block;
      padding: 6px 16px;
      font-size: 13px;
      color: var(--text-1);
      cursor: pointer;
      border-left: 2px solid transparent;
      transition: all var(--transition);
    }

    .sidebar-item:hover { color: var(--text-0); background: var(--bg-2); }
    .sidebar-item.active { color: var(--blue); border-left-color: var(--blue); background: rgba(59, 130, 246, 0.1); }

    /* Sidebar item with sub-items */
    .sidebar-item.has-children {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-item .item-arrow {
      width: 10px;
      height: 10px;
      transition: transform var(--transition);
      opacity: 0.5;
    }

    .sidebar-item.open .item-arrow { transform: rotate(90deg); }

    /* Sub-sub navigation (3rd level) */
    .sidebar-subitems {
      display: none;
      padding-left: 12px;
      margin-top: 4px;
    }

    .sidebar-subitems.show { display: block; }

    .sidebar-subitem {
      display: block;
      padding: 4px 12px;
      font-size: 12px;
      color: var(--text-2);
      cursor: pointer;
      border-left: 1px solid var(--border);
      transition: all var(--transition);
    }

    .sidebar-subitem:hover { color: var(--text-1); border-left-color: var(--text-2); }
    .sidebar-subitem.active { color: var(--accent); border-left-color: var(--accent); }

    .sidebar-item-wrap { margin-bottom: 2px; }

    /* Layout Modes */
    body.layout-top .sidebar { display: none !important; }
    body.layout-top .nav-links { display: none !important; }
    body.layout-top .section { margin-left: auto; margin-right: auto; padding-top: 72px; max-width: 900px; }
    body.layout-top .sub-nav { display: flex !important; justify-content: center; }

    body.layout-sidebar .sidebar { display: block !important; }
    body.layout-sidebar .nav-links { display: none !important; }
    body.layout-sidebar .section { margin-left: var(--sidebar-width); max-width: calc(900px + var(--sidebar-width)); }
    body.layout-sidebar .sub-nav { display: none !important; }

    /* Sub Navigation (horizontal, for top-nav mode) */
    .sub-nav {
      display: none;
      position: sticky;
      top: 56px;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 90;
      background: var(--bg-1);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      gap: 4px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      align-items: center;
      flex-wrap: nowrap;
    }

    .sub-nav::-webkit-scrollbar { height: 0; }

    .sub-nav-divider {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 8px;
      flex-shrink: 0;
      align-self: center;
    }

    .sub-nav-item {
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text-1);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      transition: all var(--transition);
      flex-shrink: 0;
    }

    .sub-nav-item:hover { color: var(--text-0); }
    .sub-nav-item.active { color: var(--blue); border-bottom-color: var(--blue); }

    .export-wrap { position: relative; }

    .export-btn {
      padding: 8px 14px;
      border-radius: 6px;
      background: var(--bg-2);
      color: var(--text-0);
      font-size: 14px;
      border: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .export-btn:hover { background: var(--bg-3); }

    .export-caret {
      font-size: 10px;
      transition: transform var(--transition);
    }

    .export-caret.open { transform: rotate(180deg); }

    .export-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      min-width: 220px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      display: none;
    }

    .export-menu.show { display: block; }

    .export-item {
      display: block;
      width: 100%;
      padding: 10px 14px;
      text-align: left;
      background: none;
      border: none;
      color: var(--text-0);
      font-size: 14px;
      cursor: pointer;
      transition: background var(--transition);
    }

    .export-item:hover { background: var(--bg-3); }
    .export-item span { color: var(--text-2); font-size: 12px; display: block; }

    .nav-github {
      padding: 8px 14px;
      border-radius: 6px;
      background: var(--bg-2);
      color: var(--text-0);
      font-size: 14px;
      border: 1px solid var(--border);
      text-decoration: none;
    }

    .nav-github:hover { background: var(--bg-3); text-decoration: none; }

    /* =================================================================
       SECTIONS
       ================================================================= */
    .section {
      max-width: 900px;
      margin: 0 auto;
      padding: 48px 24px;
      display: none;
    }

    .section.active { display: block; }

    .section h1 {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .section h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 40px 0 16px;
    }

    .section h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 24px 0 12px;
      color: var(--text-0);
    }

    .section-desc {
      color: var(--text-1);
      font-size: 16px;
      margin-bottom: 32px;
    }

    .section-desc code {
      background: var(--bg-2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 13px;
    }

    /* =================================================================
       HERO
       ================================================================= */
    .hero { text-align: center; padding: 48px 0; }

    .hero-eyebrow { font-size: 13px; color: var(--text-2); margin-bottom: 16px; }

    .hero-title {
      font-size: 48px;
      font-weight: 700;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, var(--text-0) 0%, var(--text-1) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-subtitle { font-size: 20px; color: var(--text-1); margin: 8px 0 24px; }

    .hero-description {
      color: var(--text-1);
      max-width: 540px;
      margin: 0 auto 32px;
      line-height: 1.7;
    }

    .hero-actions { display: flex; justify-content: center; gap: 12px; }

    .btn-primary {
      padding: 12px 24px;
      border-radius: 8px;
      background: var(--text-0);
      color: var(--bg-0);
      font-size: 15px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all var(--transition);
    }

    .btn-primary:hover { opacity: 0.9; }

    .btn-secondary {
      padding: 12px 24px;
      border-radius: 8px;
      background: var(--bg-2);
      color: var(--text-0);
      font-size: 15px;
      font-weight: 500;
      border: 1px solid var(--border);
      text-decoration: none;
    }

    .btn-secondary:hover { background: var(--bg-3); text-decoration: none; }

    /* =================================================================
       FEATURE CARDS
       ================================================================= */
    .feature-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 48px 0;
    }

    .feature-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      padding: 24px;
      background: var(--bg-1);
      border: 1px solid var(--border);
    }

    .feature-gradient {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100px;
      opacity: 0.15;
    }

    .feature-gradient.blue { background: linear-gradient(180deg, var(--blue) 0%, transparent 100%); }
    .feature-gradient.purple { background: linear-gradient(180deg, var(--purple) 0%, transparent 100%); }
    .feature-gradient.green { background: linear-gradient(180deg, var(--green) 0%, transparent 100%); }

    .feature-label {
      position: relative;
      font-size: 18px;
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
    }

    .feature-card p {
      position: relative;
      color: var(--text-1);
      font-size: 14px;
      margin: 0;
    }

    @media (max-width: 700px) {
      .feature-cards { grid-template-columns: 1fr; }
    }

    /* =================================================================
       QUICKSTART PREVIEW
       ================================================================= */
    .quickstart-preview {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      margin: 48px 0;
    }

    .quickstart-preview h2 { margin: 0 0 8px; font-size: 18px; }
    .quickstart-preview .section-desc { margin-bottom: 20px; }

    /* =================================================================
       START BUILDING
       ================================================================= */
    .start-building h2 { margin: 0 0 20px; font-size: 18px; }

    .start-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .start-item {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 10px;
      text-align: left;
      cursor: pointer;
      transition: all var(--transition);
      color: var(--text-0);
      font-family: inherit;
    }

    .start-item:hover { background: var(--bg-2); border-color: var(--text-2); }

    .start-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-2);
      border-radius: 8px;
      font-size: 16px;
      flex-shrink: 0;
      color: var(--text-0);
    }

    .start-item strong { display: block; font-size: 14px; margin-bottom: 2px; color: var(--text-0); }
    .start-item span { display: block; font-size: 13px; color: var(--text-1); }

    @media (max-width: 600px) {
      .start-grid { grid-template-columns: 1fr; }
    }

    /* =================================================================
       TABS
       ================================================================= */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .tab {
      padding: 8px 16px;
      border-radius: 6px;
      background: none;
      border: none;
      color: var(--text-1);
      font-size: 14px;
      cursor: pointer;
      transition: all var(--transition);
    }

    .tab:hover { color: var(--text-0); }
    .tab.active { background: var(--bg-2); color: var(--text-0); }

    .tab-content { display: none; animation: fadeIn 0.2s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* =================================================================
       CODE BLOCKS
       ================================================================= */
    .code-block {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin: 16px 0;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-2);
      border-bottom: 1px solid var(--border);
    }

    .code-lang {
      font-size: 11px;
      color: var(--text-2);
      text-transform: uppercase;
      font-family: var(--font-mono);
    }

    .copy-btn {
      padding: 4px 10px;
      border-radius: 4px;
      background: var(--bg-3);
      border: none;
      color: var(--text-1);
      font-size: 12px;
      cursor: pointer;
    }

    .copy-btn:hover { color: var(--text-0); }
    .copy-btn.copied { background: var(--green); color: white; }

    .code-block pre {
      padding: 16px;
      overflow-x: auto;
      margin: 0;
      background: var(--bg-0) !important;
    }

    .code-block code {
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.6;
      background: transparent !important;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Prism token colors */
    .token.comment { color: #6a737d !important; font-style: italic; }
    .token.keyword { color: #c678dd !important; }
    .token.string { color: #98c379 !important; }
    .token.function { color: #61afef !important; }
    .token.class-name { color: #e5c07b !important; }
    .token.number { color: #d19a66 !important; }
    .token.operator { color: #56b6c2 !important; }
    .token.punctuation { color: #abb2bf !important; }
    .token.builtin { color: #e5c07b !important; }
    .token.boolean { color: #d19a66 !important; }
    .token.decorator { color: #c678dd !important; }

    /* =================================================================
       INFO BOX
       ================================================================= */
    .info-box {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 20px;
      margin: 24px 0;
    }

    .info-box strong { display: block; margin-bottom: 8px; }
    .info-box ul { margin: 0; padding-left: 20px; color: var(--text-1); }
    .info-box li { margin: 4px 0; }
    .info-box code { background: var(--bg-2); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 13px; }
    .info-box a { color: var(--blue); }

    .mini-table { width: 100%; margin-top: 8px; }
    .mini-table td { padding: 4px 0; font-size: 13px; }
    .mini-table td:first-child { color: var(--text-0); }
    .mini-table td:last-child { color: var(--text-2); }
    .mini-table code { background: var(--bg-2); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); }

    /* =================================================================
       ARCHITECTURE VISUALIZER
       ================================================================= */
    .arch-viz {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      margin: 24px 0;
    }

    .arch-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg-2);
    }

    .arch-tab {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-1);
      border: none;
      border-bottom: 2px solid transparent;
      background: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .arch-tab:hover { color: var(--text-0); }
    .arch-tab.active {
      color: var(--text-0);
      border-bottom-color: var(--blue);
      background: var(--bg-1);
    }

    .arch-content {
      padding: 40px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .arch-view { display: none; width: 100%; }
    .arch-view.active { display: flex; flex-direction: column; align-items: center; }

    /* Stack View */
    .stack-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      max-width: 500px;
    }

    .stack-layer {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
      transition: var(--transition);
    }

    .stack-layer:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .stack-layer::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 4px;
      border-radius: var(--radius) 0 0 var(--radius);
      opacity: 0.5;
    }

    .stack-layer.blue::before { background: var(--blue); }
    .stack-layer.purple::before { background: var(--purple); }
    .stack-layer.green::before { background: var(--green); }

    .stack-layer:hover::before { opacity: 1; }

    .stack-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .stack-title { font-weight: 600; color: var(--text-0); }
    .stack-pkg { font-family: var(--font-mono); font-size: 12px; color: var(--text-2); }
    .stack-desc { font-size: 14px; color: var(--text-1); }

    .stack-arrow {
      text-align: center;
      color: var(--text-2);
      font-size: 20px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(4px); }
    }

    /* Events View */
    .events-container {
      max-width: 600px;
      width: 100%;
    }

    .events-flow {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .event-step {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .event-step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .event-step-icon.start { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
    .event-step-icon.provider { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
    .event-step-icon.tool { background: rgba(249, 115, 22, 0.2); color: var(--orange); }
    .event-step-icon.end { background: rgba(16, 185, 129, 0.2); color: var(--green); }

    .event-step-content { flex: 1; }
    .event-step-content strong { color: var(--text-0); font-size: 14px; }
    .event-step-content span { display: block; color: var(--text-2); font-size: 13px; }

    .event-step-hook {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--green);
      background: rgba(16, 185, 129, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .event-connector {
      text-align: center;
      color: var(--text-2);
      font-size: 16px;
    }

    /* Litmus View */
    .litmus-container {
      text-align: center;
      max-width: 600px;
    }

    .litmus-question {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 40px;
      background: linear-gradient(to right, var(--blue), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .litmus-choices {
      display: flex;
      gap: 40px;
      justify-content: center;
    }

    .litmus-choice {
      padding: 20px 40px;
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-0);
    }

    .litmus-choice:hover {
      transform: scale(1.05);
    }

    .litmus-choice.no:hover { border-color: var(--green); }
    .litmus-choice.yes:hover { border-color: var(--purple); }

    .litmus-choice strong { font-size: 24px; display: block; margin-bottom: 8px; }
    .litmus-choice span { color: var(--text-2); }

    .litmus-result {
      margin-top: 40px;
      padding: 20px;
      background: var(--bg-3);
      border-radius: var(--radius);
      animation: fadeUp 0.5s ease;
      display: none;
    }

    .litmus-result.show { display: block; }
    .litmus-result h3 { margin-bottom: 8px; }
    .litmus-result p { margin: 0; color: var(--text-1); }
    .litmus-result.kernel { border-left: 4px solid var(--green); }
    .litmus-result.kernel h3 { color: var(--green); }
    .litmus-result.module { border-left: 4px solid var(--purple); }
    .litmus-result.module h3 { color: var(--purple); }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Concepts Grid */
    .concepts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin: 24px 0;
    }

    .concept {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      transition: border-color 0.2s ease;
    }

    .concept:hover { border-color: var(--blue); }

    .concept h3 {
      margin: 0 0 8px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .concept h3::before {
      content: 'â—†';
      font-size: 10px;
      color: var(--blue);
    }

    .concept p { color: var(--text-1); font-size: 14px; margin-bottom: 12px; }
    .concept ul, .concept ol { padding-left: 18px; color: var(--text-1); font-size: 14px; }
    .concept li { margin: 4px 0; }
    .concept code { background: var(--bg-2); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 12px; color: var(--blue); }

    .event-tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .event-tags span { background: var(--bg-2); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-family: var(--font-mono); color: var(--green); }

    @media (max-width: 600px) {
      .concepts { grid-template-columns: 1fr; }
    }

    /* =================================================================
       REFERENCE
       ================================================================= */
    .contracts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin: 24px 0;
    }

    .contract {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }

    .contract h4 {
      font-size: 14px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contract h4 span { font-weight: 400; font-size: 12px; color: var(--text-2); }

    .contract code {
      display: block;
      background: var(--bg-2);
      padding: 6px 10px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-1);
      margin: 4px 0;
    }

    @media (max-width: 600px) {
      .contracts { grid-template-columns: 1fr; }
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 20px 0;
    }

    .action {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }

    .action code { font-family: var(--font-mono); font-size: 14px; color: var(--blue); }
    .action span { display: block; font-size: 13px; color: var(--text-2); margin-top: 4px; }

    .event-groups {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 24px 0;
    }

    .event-group {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .event-group h4 { font-size: 13px; margin-bottom: 10px; color: var(--text-0); }

    .event-group code {
      display: block;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--green);
      margin: 4px 0;
    }

    @media (max-width: 700px) {
      .event-groups { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 500px) {
      .event-groups { grid-template-columns: 1fr; }
    }

    /* =================================================================
       CLI
       ================================================================= */
    .cli-groups {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin: 24px 0;
    }

    .cli-group {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
    }

    .cli-group h3 { font-size: 14px; margin-bottom: 14px; }

    .cli-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .cli-item:last-child { border-bottom: none; }

    .cli-item code { font-family: var(--font-mono); font-size: 13px; color: var(--green); }
    .cli-item span { font-size: 13px; color: var(--text-2); }

    @media (max-width: 600px) {
      .cli-groups { grid-template-columns: 1fr; }
    }

    /* =================================================================
       EXAMPLES
       ================================================================= */
    .examples-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .examples-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-1);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
    }

    .examples-tab:hover {
      background: var(--bg-2);
      border-color: var(--text-2);
      color: var(--text-0);
    }

    .examples-tab.active {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      border-color: transparent;
      color: white;
    }

    .examples-content { display: none; }
    .examples-content.active { display: block; }

    .examples-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .example-card {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: all var(--transition);
    }

    .example-card:hover {
      border-color: var(--text-2);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .example-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: var(--bg-2);
      border-bottom: 1px solid var(--border);
    }

    .example-card-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-0);
    }

    .example-card-desc {
      padding: 14px 18px;
      margin: 0;
      font-size: 13px;
      color: var(--text-1);
      line-height: 1.5;
      border-bottom: 1px solid var(--border);
    }

    .example-card pre {
      margin: 0;
      padding: 16px 18px;
      background: var(--bg-0);
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-x: auto;
    }

    .example-card code {
      font-family: var(--font-mono);
    }

    .example-card-output {
      padding: 14px 18px;
      background: var(--bg-2);
      border-top: 1px solid var(--border);
    }

    .output-label {
      display: inline-block;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--green);
      background: rgba(16, 185, 129, 0.1);
      padding: 3px 8px;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .example-card-output pre {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-1);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .examples-footer {
      margin-top: 24px;
      padding: 16px 20px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .install-hint {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .install-hint strong {
      font-size: 13px;
      color: var(--text-0);
    }

    .install-hint code {
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--green);
      background: var(--bg-0);
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    /* =================================================================
       CONTRIBUTE
       ================================================================= */
    .callout {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05));
      border: 1px solid var(--blue);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .callout p { margin: 0; color: var(--text-1); }
    .callout strong { color: var(--text-0); }
    .callout em { color: var(--blue); font-style: normal; }

    .callout-danger {
      background: #dc2626 !important;
      border: 1px solid #991b1b !important;
      border-left: 4px solid #7f1d1d !important;
    }
    .callout-danger p { color: #ffffff !important; }
    .callout-danger strong { color: #ffffff !important; }

    .contrib-table { width: 100%; border-collapse: collapse; margin: 16px 0; }

    .contrib-table th, .contrib-table td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .contrib-table th {
      background: var(--bg-2);
      color: var(--text-2);
      font-size: 12px;
      text-transform: uppercase;
    }

    .contrib-table .done { color: var(--green); }
    .contrib-table .needed { color: var(--orange); }
    .contrib-table code { background: var(--bg-2); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 12px; }

    /* Reference tables */
    .ref-table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    .ref-table th, .ref-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }
    .ref-table th {
      background: var(--bg-2);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .ref-table code { background: var(--bg-2); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 12px; }

    /* Inheritance chain */
    .inheritance-chain {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin: 12px 0;
      font-family: var(--font-mono);
      font-size: 13px;
      flex-wrap: wrap;
    }
    .inheritance-chain code {
      background: var(--bg-2);
      padding: 4px 10px;
      border-radius: 4px;
    }

    /* Session lifecycle */
    .lifecycle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin: 12px 0;
      flex-wrap: wrap;
    }
    .lifecycle-step {
      background: var(--bg-2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
    }

    /* Context info */
    .context-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
    }
    .context-preserved, .context-reloaded, .context-not {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 13px;
    }
    .context-preserved { background: rgba(16, 185, 129, 0.1); border-left: 3px solid var(--green); }
    .context-reloaded { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--blue); }
    .context-not { background: rgba(249, 115, 22, 0.1); border-left: 3px solid var(--orange); }

    /* Agent flow */
    .agent-flow {
      padding-left: 20px;
      margin: 12px 0;
    }
    .agent-flow li {
      padding: 8px 0;
      font-size: 14px;
      color: var(--text-1);
    }

    /* Ecosystem */
    .ecosystem-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .ecosystem-category {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .ecosystem-category h3 {
      margin: 0 0 8px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ecosystem-category h3 .count {
      background: var(--bg-2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-2);
    }

    .ecosystem-category > p {
      margin: 0 0 12px;
      font-size: 13px;
      color: var(--text-2);
    }

    .ecosystem-category ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .ecosystem-category li {
      padding: 4px 0;
      font-size: 13px;
      color: var(--text-1);
    }

    .ecosystem-category code {
      background: var(--bg-2);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 12px;
    }

    .collections-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }

    .collection-item {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
    }

    .collection-item strong {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .collection-item span {
      font-size: 12px;
      color: var(--text-2);
    }

    a.collection-link {
      text-decoration: none;
      transition: all var(--transition);
    }
    a.collection-link:hover {
      border-color: var(--blue);
      text-decoration: none;
    }
    a.collection-link strong {
      color: var(--blue);
    }

    .personas {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 20px 0;
    }

    .persona {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .persona strong { display: block; margin-bottom: 6px; }
    .persona p { margin: 0; font-size: 13px; color: var(--text-2); }

    @media (max-width: 700px) {
      .personas { grid-template-columns: 1fr; }
    }

    .task {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      margin: 16px 0;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .task-title { font-weight: 600; }

    .task-layer {
      font-size: 12px;
      padding: 4px 10px;
      background: var(--bg-2);
      border-radius: 4px;
      color: var(--text-2);
      font-family: var(--font-mono);
    }

    .task > p { color: var(--text-1); font-size: 14px; margin-bottom: 12px; }

    /* =================================================================
       FOOTER
       ================================================================= */
    .footer {
      border-top: 1px solid var(--border);
      padding: 32px 24px;
      text-align: center;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 12px;
    }

    .footer-links a { color: var(--text-2); font-size: 14px; }
    .footer-links a:hover { color: var(--text-0); }

    .footer-copy { color: var(--text-2); font-size: 13px; }

    /* =================================================================
       SPECIFICATION SECTIONS (Auto-generated from external specs)
       ================================================================= */
    .spec-section {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin: 12px 0;
      overflow: hidden;
    }

    .spec-header {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      transition: background var(--transition);
    }

    .spec-header:hover { background: var(--bg-2); }

    .spec-title {
      flex: 1;
      font-weight: 500;
      font-size: 14px;
    }

    .spec-category {
      font-size: 11px;
      padding: 3px 8px;
      background: var(--bg-2);
      border-radius: 4px;
      color: var(--text-2);
      text-transform: uppercase;
      margin-right: 12px;
    }

    .spec-arrow {
      width: 16px;
      height: 16px;
      color: var(--text-2);
      transition: transform var(--transition);
    }

    .spec-section.open .spec-arrow { transform: rotate(180deg); }

    .spec-content {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid var(--border);
    }

    .spec-section.open .spec-content { display: block; }

    .spec-filter-btn {
      padding: 6px 12px;
      border-radius: 4px;
      background: var(--bg-2);
      border: 1px solid var(--border);
      color: var(--text-1);
      font-size: 12px;
      cursor: pointer;
      margin-right: 4px;
      transition: all var(--transition);
    }

    .spec-filter-btn:hover { background: var(--bg-3); }

    .spec-filter-btn.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }

    @media (max-width: 900px) {
      .nav-links { display: none; }
    }

    /* =================================================================
       MERMAID DIAGRAMS
       ================================================================= */
    .mermaid-container {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin: 24px 0;
      overflow-x: auto;
    }

    .mermaid-container .mermaid {
      display: flex;
      justify-content: center;
    }

    .mermaid-container svg {
      max-width: 100%;
      height: auto;
    }

    /* Dark theme adjustments for mermaid */
    .mermaid .node rect,
    .mermaid .node circle,
    .mermaid .node polygon {
      fill: var(--bg-3) !important;
      stroke: var(--border) !important;
    }

    .mermaid .edgePath .path {
      stroke: var(--text-2) !important;
    }

    .mermaid .edgeLabel {
      background-color: var(--bg-2) !important;
      color: var(--text-1) !important;
    }

    .mermaid .cluster rect {
      fill: var(--bg-1) !important;
      stroke: var(--border) !important;
    }

    .mermaid .cluster text {
      fill: var(--text-0) !important;
    }

    .mermaid text {
      fill: var(--text-0) !important;
    }

    /* Diagram caption */
    .diagram-caption {
      text-align: center;
      color: var(--text-2);
      font-size: 13px;
      margin-top: 12px;
      font-style: italic;
    }

    /* =================================================================
       ARCHITECTURE BOUNDARIES SECTION STYLES
       ================================================================= */
    .layer-diagram {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0;
      margin: 24px 0;
      font-family: var(--font-mono);
      font-size: 13px;
      overflow: hidden;
    }

    .layer-box {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .layer-box:last-child {
      border-bottom: none;
    }

    .layer-box.app-layer {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--blue);
    }

    .layer-box.kernel-layer {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--green);
    }

    .layer-box.module-layer {
      background: rgba(168, 85, 247, 0.1);
      border-left: 4px solid var(--purple);
    }

    .layer-title {
      font-weight: 600;
      color: var(--text-0);
      margin-bottom: 4px;
    }

    .layer-subtitle {
      color: var(--text-2);
      font-size: 12px;
      margin-bottom: 8px;
    }

    .layer-desc {
      color: var(--text-1);
      font-family: var(--font-sans);
      font-size: 14px;
    }

    /* Pattern/Anti-pattern cards */
    .pattern-card {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin: 12px 0;
    }

    .pattern-card.correct {
      border-left: 4px solid var(--green);
    }

    .pattern-card.incorrect {
      border-left: 4px solid var(--red);
    }

    .pattern-label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .pattern-card.correct .pattern-label {
      color: var(--green);
    }

    .pattern-card.incorrect .pattern-label {
      color: var(--red);
    }

    /* Boundary test questions */
    .boundary-test {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin: 16px 0;
    }

    .boundary-question {
      font-weight: 500;
      color: var(--text-0);
      margin-bottom: 12px;
    }

    .boundary-answers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .boundary-answer {
      padding: 12px;
      background: var(--bg-3);
      border-radius: 6px;
    }

    .boundary-answer strong {
      display: block;
      margin-bottom: 4px;
    }

    .boundary-answer.yes {
      border-left: 3px solid var(--blue);
    }

    .boundary-answer.no {
      border-left: 3px solid var(--green);
    }

    /* =================================================================
       NOTIFICATION BELL - GitHub Changes
       ================================================================= */
    .notification-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .notification-bell {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-1);
      transition: all 0.15s ease;
      position: relative;
    }

    .notification-bell:hover {
      background: var(--bg-2);
      color: var(--text-0);
    }

    .notification-bell svg {
      width: 18px;
      height: 18px;
    }

    .notification-badge {
      position: absolute;
      top: 4px;
      right: 6px;
      background: var(--accent);
      color: white;
      font-size: 10px;
      font-weight: 600;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .notification-badge.hidden {
      display: none;
    }

    .notification-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 400px;
      max-height: 500px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      z-index: 1001;
      overflow: hidden;
    }

    .notification-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .notification-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-2);
    }

    .notification-title {
      font-weight: 600;
      color: var(--text-0);
      font-size: 14px;
    }

    .notification-subtitle {
      font-size: 12px;
      color: var(--text-2);
    }

    .notification-refresh {
      background: transparent;
      border: none;
      color: var(--text-2);
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-refresh:hover {
      background: var(--bg-3);
      color: var(--text-0);
    }

    .notification-refresh.loading svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .notification-tabs {
      display: flex;
      padding: 8px 12px;
      gap: 6px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-1);
      overflow-x: auto;
    }

    .notification-tab {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-2);
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .notification-tab:hover {
      background: var(--bg-2);
      color: var(--text-1);
    }

    .notification-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .notification-list {
      max-height: 380px;
      overflow-y: auto;
    }

    .notification-item {
      display: block;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      text-decoration: none;
      color: inherit;
      transition: background 0.15s ease;
    }

    .notification-item:hover {
      background: var(--bg-2);
      text-decoration: none;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .notification-repo {
      font-size: 10px;
      font-weight: 600;
      color: var(--accent);
      background: rgba(16, 163, 127, 0.15);
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .notification-date {
      font-size: 11px;
      color: var(--text-2);
      margin-left: auto;
    }

    .notification-message {
      font-size: 13px;
      color: var(--text-0);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .notification-author {
      font-size: 11px;
      color: var(--text-2);
      margin-top: 4px;
    }

    .notification-empty {
      padding: 40px 16px;
      text-align: center;
      color: var(--text-2);
    }

    .notification-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .notification-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-2);
      text-align: center;
    }

    .notification-footer a {
      font-size: 12px;
      color: var(--accent);
      text-decoration: none;
    }

    .notification-footer a:hover {
      text-decoration: underline;
    }

    /* =================================================================
       NOTIFICATION BELL - GitHub Changes
       ================================================================= */
    .notification-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .notification-bell {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-1);
      transition: all 0.15s ease;
      position: relative;
    }

    .notification-bell:hover {
      background: var(--bg-2);
      color: var(--text-0);
    }

    .notification-bell svg { width: 18px; height: 18px; }

    .notification-badge {
      position: absolute;
      top: 4px;
      right: 6px;
      background: var(--accent);
      color: white;
      font-size: 10px;
      font-weight: 600;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .notification-badge.hidden { display: none; }

    .notification-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 400px;
      max-height: 500px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      z-index: 1001;
      overflow: hidden;
    }

    .notification-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .notification-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-2);
    }

    .notification-title { font-weight: 600; color: var(--text-0); font-size: 14px; }
    .notification-subtitle { font-size: 12px; color: var(--text-2); }

    .notification-refresh {
      background: transparent;
      border: none;
      color: var(--text-2);
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-refresh:hover { background: var(--bg-3); color: var(--text-0); }
    .notification-refresh.loading svg { animation: notif-spin 1s linear infinite; }

    @keyframes notif-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .notification-tabs {
      display: flex;
      padding: 8px 12px;
      gap: 6px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-1);
      overflow-x: auto;
    }

    .notification-tab {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-2);
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .notification-tab:hover { background: var(--bg-2); color: var(--text-1); }
    .notification-tab.active { background: var(--accent); border-color: var(--accent); color: white; }

    .notification-list { max-height: 380px; overflow-y: auto; }

    .notification-item {
      display: block;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      text-decoration: none;
      color: inherit;
      transition: background 0.15s ease;
    }

    .notification-item:hover { background: var(--bg-2); text-decoration: none; }
    .notification-item:last-child { border-bottom: none; }

    .notification-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .notification-repo {
      font-size: 10px;
      font-weight: 600;
      color: var(--accent);
      background: rgba(16, 163, 127, 0.15);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .notification-date { font-size: 11px; color: var(--text-2); margin-left: auto; }

    .notification-message {
      font-size: 13px;
      color: var(--text-0);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .notification-author { font-size: 11px; color: var(--text-2); margin-top: 4px; }
    .notification-empty { padding: 40px 16px; text-align: center; color: var(--text-2); }
    .notification-empty svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }

    .notification-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-2);
      text-align: center;
    }

    .notification-footer a { font-size: 12px; color: var(--accent); text-decoration: none; }
    .notification-footer a:hover { text-decoration: underline; }

    /* Updates section - full width cards */
    .updates-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .update-card {
      display: block;
      padding: 16px 20px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: 8px;
      text-decoration: none;
      color: inherit;
      transition: all 0.15s ease;
    }

    .update-card:hover {
      background: var(--bg-2);
      border-color: var(--text-2);
      text-decoration: none;
    }

    .update-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .update-card-repo {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .update-card-repo.amplifier { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
    .update-card-repo.amplifier-core { background: rgba(16, 185, 129, 0.15); color: var(--green); }
    .update-card-repo.amplifier-foundation { background: rgba(168, 85, 247, 0.15); color: var(--purple); }

    .update-card-date {
      font-size: 12px;
      color: var(--text-2);
      margin-left: auto;
    }

    .update-card-message {
      font-size: 14px;
      color: var(--text-0);
      line-height: 1.5;
      margin-bottom: 6px;
    }

    .update-card-meta {
      font-size: 12px;
      color: var(--text-2);
    }

    .update-card-sha {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--accent);
    }

  </style>
  <link rel="stylesheet" href="css/chat-widget.css">
</head>
<body class="layout-sidebar">

  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <a class="nav-logo" onclick="showSection('home')">
          <img src="amplifierlogo.png" alt="Amplifier">
          Amplifier
        </a>
        <div class="nav-links" id="main-nav">
          <button class="nav-link active" data-section="home">Overview</button>
          <button class="nav-link" data-section="quickstart">Quickstart</button>
          <button class="nav-link" data-section="architecture">Architecture</button>
          <button class="nav-link" data-section="guides">Guides</button>
          <button class="nav-link" data-section="reference">Reference</button>
          <button class="nav-link" data-section="cli">CLI</button>
          <button class="nav-link" data-section="ecosystem">Ecosystem</button>
          <button class="nav-link" data-section="showcase">Showcase</button>
          <button class="nav-link" data-section="examples">Examples</button>
          <button class="nav-link" data-section="contribute">Contribute</button>
          <button class="nav-link" data-section="updates">Updates</button>
        </div>
      </div>
      <div class="nav-right">
        <!-- Layout Toggle -->
        <div class="layout-toggle">
          <button class="toggle-btn" onclick="setLayout('sidebar')" title="Sidebar Layout">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
          </button>
          <button class="toggle-btn active" onclick="setLayout('top')" title="Top Nav Layout">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
            </svg>
          </button>
        </div>
        <div class="export-wrap">
          <button class="export-btn" onclick="toggleExportMenu()">
            Export <span class="export-caret" id="export-caret">â–¼</span>
          </button>
          <div class="export-menu" id="export-menu">
            <button class="export-item" onclick="copyMarkdown()">
              Copy as Markdown
              <span>For agents.md / claude.md</span>
            </button>
            <button class="export-item" onclick="downloadMarkdown()">
              Download amplifier.md
              <span>Agent reference file</span>
            </button>
            <button class="export-item" onclick="downloadFullGuide()">
              Download amplifier-completeguide.md
              <span>Full documentation export</span>
            </button>
          </div>
        </div>
        <button id="chat-nav-btn" class="nav-github" title="Ask Document Assistant" style="cursor: pointer;">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px; vertical-align: -2px;">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
          </svg>
          Ask AI
        </button>
        <a href="https://microsoft.github.io/amplifier-docs" class="nav-github" target="_blank">Official Docs</a>
        <!-- Notification Bell -->
        <div class="notification-wrapper">
          <button class="notification-bell" id="notification-bell" title="Recent GitHub Updates">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span class="notification-badge" id="notification-badge">0</span>
          </button>
          <div class="notification-dropdown" id="notification-dropdown">
            <div class="notification-header">
              <div>
                <div class="notification-title">Ecosystem Updates</div>
                <div class="notification-subtitle">Recent commits across Amplifier repos</div>
              </div>
              <button class="notification-refresh" id="notification-refresh" title="Refresh">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6"></path>
                  <path d="M1 20v-6h6"></path>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                  <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
                </svg>
              </button>
            </div>
            <div class="notification-tabs" id="notification-tabs">
              <button class="notification-tab active" data-repo="all">All</button>
              <button class="notification-tab" data-repo="amplifier">amplifier</button>
              <button class="notification-tab" data-repo="amplifier-core">core</button>
              <button class="notification-tab" data-repo="amplifier-foundation">foundation</button>
            </div>
            <div class="notification-list" id="notification-list">
              <div class="notification-empty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 6v6l4 2"></path>
                </svg>
                <div>Loading updates...</div>
              </div>
            </div>
            <div class="notification-footer">
              <a href="#" onclick="showSection('updates'); document.getElementById('notification-dropdown').classList.remove('show'); return false;">View all updates â†’</a>
            </div>
          </div>
        </div>
        <a href="https://github.com/microsoft/amplifier" class="nav-github" target="_blank">GitHub</a>
      </div>
    </div>
  </nav>

  <!-- Sub Navigation (for top-nav layout mode) -->
  <nav class="sub-nav" id="sub-nav">
    <span class="sub-nav-item active" data-section="home">Overview</span>
    <span class="sub-nav-item" data-section="quickstart">Quickstart</span>
    <span class="sub-nav-item" data-section="architecture">Architecture</span>
    <span class="sub-nav-item" data-section="reference">Reference</span>
    <span class="sub-nav-item" data-section="cli">CLI</span>
    <span class="sub-nav-item" data-section="ecosystem">Ecosystem</span>
    <span class="sub-nav-item" data-section="showcase">Showcase</span>
    <span class="sub-nav-item" data-section="examples">Examples</span>
    <span class="sub-nav-item" data-section="contribute">Contribute</span>
    <span class="sub-nav-item" data-section="updates">Updates</span>
  </nav>

  <!-- Sidebar (for sidebar layout mode) -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-toggle-all" onclick="toggleAllSidebar()">
      <span id="toggle-all-text">Collapse All</span>
      <svg id="toggle-all-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-header open" onclick="toggleSidebarGroup(this)">
        <svg class="sidebar-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        Getting Started
      </div>
      <div class="sidebar-items show">
        <span class="sidebar-item active" data-section="home">Overview</span>
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" data-section="quickstart" onclick="toggleSidebarItem(this)">
            Quickstart
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="quickstart" data-tab="consumer">Use a Profile</span>
            <span class="sidebar-subitem" data-section="quickstart" data-tab="extender">Write a Tool</span>
            <span class="sidebar-subitem" data-section="quickstart" data-tab="architect">Embed in App</span>
          </div>
        </div>
      </div>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-header open" onclick="toggleSidebarGroup(this)">
        <svg class="sidebar-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        Architecture
      </div>
      <div class="sidebar-items show">
        <!-- Fundamentals -->
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" data-section="architecture" onclick="toggleSidebarItem(this)">
            Fundamentals
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="architecture">Overview</span>
            <span class="sidebar-subitem" data-section="architecture" data-scroll="four-tenets">The Four Tenets</span>
          </div>
        </div>
        <!-- Core -->
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" onclick="toggleSidebarItem(this)">
            Core
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="architecture" data-scroll="linux-kernel-analogy">Linux Kernel Analogy</span>
            <span class="sidebar-subitem" data-section="architecture" data-scroll="core-concepts">Core Concepts</span>
          </div>
        </div>
        <!-- Operations -->
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" onclick="toggleSidebarItem(this)">
            Operations
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="architecture" data-scroll="module-distribution">Module Distribution</span>
            <span class="sidebar-subitem" data-section="architecture" data-scroll="external-integration">External Integration</span>
            <span class="sidebar-subitem" data-section="architecture" data-scroll="production-config">Production Config</span>
            <span class="sidebar-subitem" data-section="architecture" data-scroll="troubleshooting">Troubleshooting</span>
          </div>
        </div>
      </div>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-header open" onclick="toggleSidebarGroup(this)">
        <svg class="sidebar-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        Guides
      </div>
      <div class="sidebar-items show">
        <!-- Architecture Boundaries -->
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" data-section="guides" onclick="toggleSidebarItem(this)">
            Architecture Boundaries
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="guides" data-scroll="boundaries-overview">Overview</span>
            <span class="sidebar-subitem" data-section="guides" data-scroll="boundary-test">The Boundary Test</span>
            <span class="sidebar-subitem" data-section="guides" data-scroll="correct-patterns">Correct Patterns</span>
            <span class="sidebar-subitem" data-section="guides" data-scroll="anti-patterns">Anti-Patterns</span>
          </div>
        </div>
        <!-- Resources -->
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" onclick="toggleSidebarItem(this)">
            Resources
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="guides" data-scroll="module-builder">Module Builder Guide</span>
            <span class="sidebar-subitem" data-section="guides" data-scroll="dx-review">DX Review & Diagrams</span>
          </div>
        </div>
      </div>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-header open" onclick="toggleSidebarGroup(this)">
        <svg class="sidebar-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        Reference
      </div>
      <div class="sidebar-items show">
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" data-section="reference" onclick="toggleSidebarItem(this)">
            Module Reference
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="reference" data-tab="contracts">Contracts</span>
            <span class="sidebar-subitem" data-section="reference" data-tab="hooks-api">Hooks API</span>
            <span class="sidebar-subitem" data-section="reference" data-tab="events">Events</span>
            <span class="sidebar-subitem" data-section="reference" data-tab="profiles">Profiles</span>
            <span class="sidebar-subitem" data-section="reference" data-tab="sessions">Sessions</span>
            <span class="sidebar-subitem" data-section="reference" data-tab="agents">Agents</span>
          </div>
        </div>
        <span class="sidebar-item" data-section="cli">CLI Commands</span>
      </div>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-header open" onclick="toggleSidebarGroup(this)">
        <svg class="sidebar-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        Ecosystem
      </div>
      <div class="sidebar-items show">
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" data-section="ecosystem" onclick="toggleSidebarItem(this)">
            Ecosystem
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="ecosystem" data-scroll="runtime-modules">Runtime Modules</span>
            <span class="sidebar-subitem" data-section="ecosystem" data-scroll="libraries">Libraries</span>
            <span class="sidebar-subitem" data-section="ecosystem" data-scroll="collections">Collections</span>
          </div>
        </div>
        <span class="sidebar-item" data-section="showcase">Showcase</span>
        <span class="sidebar-item" data-section="examples">Examples</span>
      </div>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-header open" onclick="toggleSidebarGroup(this)">
        <svg class="sidebar-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        Community
      </div>
      <div class="sidebar-items show">
        <div class="sidebar-item-wrap">
          <span class="sidebar-item has-children open" data-section="contribute" onclick="toggleSidebarItem(this)">
            Contribute
            <svg class="item-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </span>
          <div class="sidebar-subitems show">
            <span class="sidebar-subitem" data-section="contribute" data-tab="overview">Overview</span>
            <span class="sidebar-subitem" data-section="contribute" data-tab="tasks">Priority Tasks</span>
            <span class="sidebar-subitem" data-section="contribute" data-tab="specs">Specifications</span>
            <span class="sidebar-subitem" data-section="contribute" data-tab="roadmap">Roadmap</span>
            <span class="sidebar-subitem" data-section="contribute" data-tab="rules">Repository Rules</span>
          </div>
        </div>
        <span class="sidebar-item" data-section="updates">Updates</span>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main>
    <!-- HOME SECTION -->
    <section id="section-home" class="section active">
      <div class="hero">
        <div class="hero-eyebrow">Open Source Â· Microsoft Â· MIT License</div>
        <h1 class="hero-title">Amplifier</h1>
        <p class="hero-subtitle">The ultra-thin kernel for modular AI agents</p>
        <p class="hero-description">
          Build AI agent systems with Linux-kernel philosophy: a tiny, stable center (~2,600 lines)
          that provides mechanisms, while policies live as swappable modules at the edges.
        </p>
        <div class="hero-actions">
          <button class="btn-primary" onclick="showSection('quickstart')">Get started</button>
          <a href="https://microsoft.github.io/amplifier-docs" class="btn-secondary" target="_blank">Official Docs</a>
          <a href="https://github.com/microsoft/amplifier" class="btn-secondary" target="_blank">GitHub</a>
        </div>
      </div>

      <div class="feature-cards">
        <div class="feature-card">
          <div class="feature-gradient blue"></div>
          <span class="feature-label">Use it</span>
          <p>Run AI agents with pre-built providers and tools. Configure via profiles.</p>
        </div>
        <div class="feature-card">
          <div class="feature-gradient purple"></div>
          <span class="feature-label">Extend it</span>
          <p>Write custom tools in 2 minutes. Duck typing, no inheritance.</p>
        </div>
        <div class="feature-card">
          <div class="feature-gradient green"></div>
          <span class="feature-label">Embed it</span>
          <p>Drop the kernel into your app. Full programmatic control.</p>
        </div>
      </div>

      <div class="quickstart-preview">
        <h2>Developer quickstart</h2>
        <p class="section-desc">Make your first agent request in minutes.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Install
uv tool install git+https://github.com/microsoft/amplifier@main

# Update and initialize
amplifier update
amplifier init

# Run
amplifier run "List all Python files in this directory"</code></pre>
        </div>
      </div>

      <div class="start-building">
        <h2>Start building</h2>
        <div class="start-grid">
          <button class="start-item" onclick="showSection('quickstart'); setQuickstartTab('consumer');">
            <div class="start-icon">â–¶</div>
            <div>
              <strong>Use existing modules</strong>
              <span>Configure profiles and run agents</span>
            </div>
          </button>
          <button class="start-item" onclick="showSection('quickstart'); setQuickstartTab('extender');">
            <div class="start-icon">+</div>
            <div>
              <strong>Write a custom tool</strong>
              <span>Extend agent capabilities</span>
            </div>
          </button>
          <button class="start-item" onclick="showSection('quickstart'); setQuickstartTab('architect');">
            <div class="start-icon">{ }</div>
            <div>
              <strong>Embed in your app</strong>
              <span>Programmatic session control</span>
            </div>
          </button>
          <button class="start-item" onclick="showSection('reference')">
            <div class="start-icon">â—ˆ</div>
            <div>
              <strong>Hooks &amp; events</strong>
              <span>Observe and control execution</span>
            </div>
          </button>
        </div>
      </div>
    </section>

    <!-- QUICKSTART SECTION -->
    <section id="section-quickstart" class="section">
      <h1>Quickstart</h1>
      <p class="section-desc">Choose your path. Each guide gets you productive in minutes.</p>

      <div class="info-box" style="border-left: 4px solid var(--accent); margin-bottom: 24px;">
        <strong>ðŸ“š Getting Started Guide</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">For the complete getting started experience including provider setup, see the <a href="https://microsoft.github.io/amplifier-docs/getting-started/installation/" target="_blank">official installation guide</a>.</p>
      </div>

      <div class="tabs" id="quickstart-tabs">
        <button class="tab active" data-tab="consumer">Use a profile</button>
        <button class="tab" data-tab="extender">Write a tool</button>
        <button class="tab" data-tab="architect">Embed in app</button>
      </div>

      <!-- Consumer Tab -->
      <div id="qs-consumer" class="tab-content active">
        <p>Run AI agents using pre-built modules and profiles.</p>

        <h3>1. Install</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">uv tool install git+https://github.com/microsoft/amplifier@main</code></pre>
        </div>

        <h3>2. Update and Initialize</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier update
amplifier init</code></pre>
        </div>

        <h3>3. Run</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Interactive
amplifier

# Single command
amplifier run "Explain this codebase"

# With profile
amplifier run --profile dev "Review for security issues"</code></pre>
        </div>

        <h3>4. Customize your profile</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># ~/.amplifier/profiles/my-profile.yaml
name: my-profile
session:
  orchestrator: loop-streaming
  context: context-persistent
providers:
  - module: provider-anthropic
    config:
      model: claude-sonnet-4-20250514
tools:
  - module: tool-filesystem
  - module: tool-bash</code></pre>
        </div>

        <h3>Troubleshooting</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Reset profile to defaults
amplifier profile reset

# Clear module cache (fixes stale module issues)
rm -rf ~/.amplifier/module-cache

# Reinstall from scratch
uv tool install git+https://github.com/microsoft/amplifier@main
amplifier update</code></pre>
        </div>
      </div>

      <!-- Extender Tab -->
      <div id="qs-extender" class="tab-content">
        <p>Write a custom tool in under 2 minutes using duck typing.</p>

        <h3>1. Implement the Tool protocol</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">from amplifier_core.models import ToolResult

class WeatherTool:
    @property
    def name(self) -> str:
        return "weather"

    @property
    def description(self) -> str:
        return "Get current weather for a city"

    @property
    def input_schema(self) -> dict:
        """JSON Schema for input validation (RECOMMENDED)."""
        return {
            "type": "object",
            "properties": {
                "city": {"type": "string", "description": "City name"}
            },
            "required": ["city"]
        }

    async def execute(self, input: dict) -> ToolResult:
        # input["city"] is GUARANTEED to exist if we get here
        city = input["city"]
        return ToolResult(output=f"Weather in {city}: 72Â°F, Sunny")</code></pre>
        </div>

        <div class="info-box" style="border-left: 4px solid var(--orange); margin: 16px 0;">
          <strong>Why input_schema matters</strong>
          <p style="margin: 8px 0 0 0; color: var(--text-1);">The Kernel validates inputs against <code>input_schema</code> <strong>before</strong> calling <code>execute()</code>. Without it, truncated LLM output may pass through. With it, missing required arguments are caught early with clear errors.</p>
        </div>

        <h3>2. Add mount function</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def mount(coordinator, config):
    await coordinator.mount("tools", WeatherTool(), name="weather")
    return lambda: None  # cleanup</code></pre>
        </div>

        <h3>3. Register entry point</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">toml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-toml"># pyproject.toml
[project.entry-points."amplifier.modules"]
weather-tool = "my_package.weather:mount"</code></pre>
        </div>

        <h3>4. Install and use</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">pip install -e .
amplifier run "What's the weather in Seattle?"</code></pre>
        </div>

        <div class="info-box">
          <strong>Tool Protocol</strong>
          <table class="mini-table">
            <tbody>
              <tr><td><code>name</code></td><td>property â†’ str</td></tr>
              <tr><td><code>description</code></td><td>property â†’ str</td></tr>
              <tr><td><code>execute(input)</code></td><td>async â†’ ToolResult</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Architect Tab -->
      <div id="qs-architect" class="tab-content">
        <p>Embed Amplifier in your application with full programmatic control.</p>

        <h3>1. Define mount plan</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">from amplifier_core import AmplifierSession

async def run_agent(prompt: str) -> str:
    config = {
        "session": {
            "orchestrator": "loop-basic",
            "context": "context-simple"
        },
        "providers": [{"module": "provider-anthropic"}],
        "tools": [{"module": "tool-filesystem"}, {"module": "tool-bash"}],
        "hooks": [{"module": "hooks-logging"}]
    }

    async with AmplifierSession(config) as session:
        return await session.execute(prompt)</code></pre>
        </div>

        <h3>2. Add custom hooks</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">from amplifier_core.models import HookResult

async def audit_hook(event: str, data: dict) -> HookResult:
    if event == "tool:pre":
        print(f"Executing: {data['tool_name']}")
    return HookResult(action="continue")

config["hooks"].append({"handler": audit_hook, "events": ["tool:*"]})</code></pre>
        </div>

        <h3>3. Session persistence with ID</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Create session with explicit ID for persistence
session = AmplifierSession(config, session_id="user-123-session")
await session.initialize()

# Load conversation history
context = session.coordinator.get("context")
for msg in historical_messages:
    await context.add_message(msg)

# Continue conversation
response = await session.execute(prompt)</code></pre>
        </div>

        <h3>4. Fork sessions for parallel work</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async with AmplifierSession(config) as parent:
    child1 = await parent.fork()
    child2 = await parent.fork()

    results = await asyncio.gather(
        child1.execute("Analyze backend"),
        child2.execute("Review frontend")
    )</code></pre>
        </div>

        <div class="info-box">
          <strong>Reference Implementation</strong>
          <p>See <a href="https://github.com/payneio/amplifierd" target="_blank">amplifierd</a> for a complete HTTP/SSE API built on amplifier-core.</p>
        </div>
      </div>
    </section>

    <!-- ARCHITECTURE SECTION -->
    <section id="section-architecture" class="section">
      <h1>Architecture</h1>
      <p class="section-desc">Design philosophy: kernel, not framework. Mechanism over policy.</p>

      <div class="info-box" style="border-left: 4px solid var(--blue); margin-bottom: 24px;">
        <strong>ðŸ“š Complete Architecture Documentation</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">For in-depth architectural guides, see the <a href="https://microsoft.github.io/amplifier-docs/architecture/overview/" target="_blank">official architecture documentation</a>.</p>
      </div>

      <h2 id="four-tenets">The Four Tenets</h2>
      <div class="concepts" style="margin-bottom: 40px;">
        <div class="concept">
          <h3>1. Mechanism, Not Policy</h3>
          <p>The kernel provides capabilities and stable contracts. Behavioral decisions live outside the kernel. If teams could want different behavior, it belongs in modules.</p>
        </div>
        <div class="concept">
          <h3>2. Small, Stable, Boring</h3>
          <p>~2,600 lines of intentionally minimal code. Fewer changes = fewer breaking changes. Prioritizes auditability and predictability over clever implementations.</p>
        </div>
        <div class="concept">
          <h3>3. Don't Break Modules</h3>
          <p>Kernel interfaces follow sacred backward compatibility. Additive evolution only, with clear deprecation paths and extended sunset periods.</p>
        </div>
        <div class="concept">
          <h3>4. Extensibility via Composition</h3>
          <p>New capabilities come from combining modules, not accumulating kernel configuration flags. Avoids "configuration explosion" by pushing policy to the edges.</p>
        </div>
      </div>

      <h2 id="linux-kernel-analogy">The Linux Kernel Analogy</h2>
      <p>Amplifier mirrors Linux kernel concepts:</p>
      <table class="ref-table">
        <thead>
          <tr><th>Linux Concept</th><th>Amplifier Analog</th><th>Purpose</th></tr>
        </thead>
        <tbody>
          <tr><td>Ring 0 kernel</td><td><code>amplifier-core</code></td><td>Mechanisms only, never policy</td></tr>
          <tr><td>Syscalls</td><td>Session operations</td><td>Few, sharp APIs</td></tr>
          <tr><td>Loadable drivers</td><td>Modules</td><td>Compete at edges</td></tr>
          <tr><td>Signals/Netlink</td><td>Event bus / hooks</td><td>Observe and control</td></tr>
          <tr><td>/proc &amp; dmesg</td><td>JSONL logs</td><td>Single canonical stream</td></tr>
          <tr><td>Capabilities</td><td>Approval system</td><td>Deny-by-default</td></tr>
          <tr><td>Scheduler</td><td>Orchestrator modules</td><td>Swap execution strategies</td></tr>
          <tr><td>VM/Memory</td><td>Context manager</td><td>Conversation memory</td></tr>
        </tbody>
      </table>

      <div class="arch-viz">
        <div class="arch-tabs" id="arch-tabs">
          <button class="arch-tab active" data-view="stack">System Stack</button>
          <button class="arch-tab" data-view="events">Event Flow</button>
          <button class="arch-tab" data-view="litmus">The Litmus Test</button>
        </div>

        <div class="arch-content">
          <!-- Stack View -->
          <div id="arch-stack" class="arch-view active">
            <div class="stack-container">
              <div class="stack-layer blue">
                <div class="stack-header">
                  <span class="stack-title">DX Layer</span>
                  <span class="stack-pkg">amplifier-app-cli</span>
                </div>
                <div class="stack-desc">CLI, scaffolding, dev mode, inspector</div>
              </div>
              <div class="stack-arrow">â†“</div>
              <div class="stack-layer purple">
                <div class="stack-header">
                  <span class="stack-title">Helpers</span>
                  <span class="stack-pkg">amplifier-helpers</span>
                </div>
                <div class="stack-desc">@tool decorator, testing utilities</div>
              </div>
              <div class="stack-arrow">â†“</div>
              <div class="stack-layer green">
                <div class="stack-header">
                  <span class="stack-title">Kernel</span>
                  <span class="stack-pkg">amplifier-core</span>
                </div>
                <div class="stack-desc">Session, Coordinator, Protocols, Events</div>
              </div>
            </div>
          </div>

          <!-- Events View -->
          <div id="arch-events" class="arch-view">
            <div class="events-container">
              <div class="events-flow">
                <div class="event-step">
                  <div class="event-step-icon start">ðŸ“¥</div>
                  <div class="event-step-content">
                    <strong>Prompt Submitted</strong>
                    <span>User sends a prompt to the session</span>
                  </div>
                  <span class="event-step-hook">session:start</span>
                </div>
                <div class="event-connector">â†“</div>
                <div class="event-step">
                  <div class="event-step-icon provider">ðŸ¤–</div>
                  <div class="event-step-content">
                    <strong>Provider Request</strong>
                    <span>LLM generates response with tool calls</span>
                  </div>
                  <span class="event-step-hook">provider:request</span>
                </div>
                <div class="event-connector">â†“</div>
                <div class="event-step">
                  <div class="event-step-icon tool">ðŸ”§</div>
                  <div class="event-step-content">
                    <strong>Tool Execution</strong>
                    <span>Tools run with hook observation</span>
                  </div>
                  <span class="event-step-hook">tool:pre â†’ tool:post</span>
                </div>
                <div class="event-connector">â†“</div>
                <div class="event-step">
                  <div class="event-step-icon end">âœ…</div>
                  <div class="event-step-content">
                    <strong>Response Complete</strong>
                    <span>Final answer returned to user</span>
                  </div>
                  <span class="event-step-hook">session:end</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Litmus View -->
          <div id="arch-litmus" class="arch-view">
            <div class="litmus-container">
              <div class="litmus-question">"Could two teams want different behavior?"</div>
              <div class="litmus-choices">
                <button class="litmus-choice no" onclick="showLitmusResult('no')">
                  <strong>No</strong>
                  <span>Universal requirement</span>
                </button>
                <button class="litmus-choice yes" onclick="showLitmusResult('yes')">
                  <strong>Yes</strong>
                  <span>Team preference</span>
                </button>
              </div>
              <div id="litmus-result-no" class="litmus-result kernel">
                <h3>It belongs in the Kernel</h3>
                <p>Mechanisms that everyone needs (e.g., Session management, Event emission).</p>
              </div>
              <div id="litmus-result-yes" class="litmus-result module">
                <h3>It belongs in a Module</h3>
                <p>Policies that vary by team (e.g., "Allow sudo?", "Which LLM to use?").</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <h2 id="core-concepts">Core concepts</h2>
      <div class="concepts">
        <div class="concept">
          <h3>Coordinator</h3>
          <p>Infrastructure context injected into all modules.</p>
          <ul>
            <li><code>session_id</code> â€” Unique identifier</li>
            <li><code>config</code> â€” Session configuration</li>
            <li><code>mount()</code> â€” Register module</li>
            <li><code>emit()</code> â€” Fire events</li>
          </ul>
        </div>
        <div class="concept">
          <h3>Mount Plan</h3>
          <p>Configuration specifying which modules to load.</p>
          <div class="code-block" style="margin-top: 8px;">
            <pre style="padding: 12px;"><code class="language-json">{
  "session": {"orchestrator": "loop-basic"},
  "providers": [{"module": "provider-anthropic"}],
  "tools": [{"module": "tool-filesystem"}]
}</code></pre>
          </div>
        </div>
        <div class="concept">
          <h3>Session Lifecycle</h3>
          <ol>
            <li>Load modules from mount plan</li>
            <li>Call <code>mount()</code> on each</li>
            <li>Execute prompts via orchestrator</li>
            <li>Cleanup on session end</li>
          </ol>
        </div>
        <div class="concept">
          <h3>Event System</h3>
          <p>30+ hookable events covering the agent lifecycle.</p>
          <div class="event-tags">
            <span>session:*</span>
            <span>provider:*</span>
            <span>tool:*</span>
            <span>context:*</span>
          </div>
        </div>
      </div>

      <h2 id="module-distribution">Module Distribution Architecture</h2>
      <p>Understanding how modules are distributed and resolved is critical for building applications with amplifier-core.</p>

      <div class="info-box" style="border-left: 4px solid var(--orange); margin: 20px 0;">
        <strong>Key Insight</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">Only <strong>providers</strong> are distributed via Python entry points. Orchestrators and contexts use local implementations or the module cache.</p>
      </div>

      <h3>Two-Tier Module System</h3>
      <table class="ref-table">
        <thead>
          <tr><th>Distribution Method</th><th>Module Types</th><th>Location</th><th>Resolution</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Entry Points</strong></td>
            <td>Providers (<code>provider-*</code>)</td>
            <td>Python package metadata</td>
            <td><code>importlib.metadata</code></td>
          </tr>
          <tr>
            <td><strong>Module Cache</strong></td>
            <td>Orchestrators, Contexts, Tools, Hooks</td>
            <td><code>~/.amplifier/module-cache/</code></td>
            <td><code>amplifier_module_resolution</code></td>
          </tr>
          <tr>
            <td><strong>Local Implementations</strong></td>
            <td>Any module type</td>
            <td>Application code</td>
            <td>Custom <code>ModuleLoader</code></td>
          </tr>
        </tbody>
      </table>

      <h3>Entry Points (<code>amplifier.modules</code>)</h3>
      <p>Provider modules bundled with the amplifier package are registered via Python entry points:</p>
      <div class="code-block">
        <pre style="padding: 12px;"><code class="language-bash"># List available entry point modules
amplifier module list

# Output shows only providers:
# provider-anthropic, provider-openai, provider-google, provider-xai...</code></pre>
      </div>

      <h3>Module Cache</h3>
      <p>Git-based modules (orchestrators, tools, hooks) are cloned to the module cache:</p>
      <div class="code-block">
        <pre style="padding: 12px;"><code class="language-bash"># Cache location
~/.amplifier/module-cache/

# Structure (hashed directories)
module-cache/
  â”œâ”€â”€ abc123.../  # loop-streaming
  â”œâ”€â”€ def456.../  # context-persistent
  â””â”€â”€ ghi789.../  # tool-filesystem</code></pre>
      </div>
      <p>Accessing cached modules requires the <code>amplifier_module_resolution</code> package, which handles path resolution and version management.</p>

      <h3>Module Loading Priority</h3>
      <p>When loading a module, the system checks sources in this order:</p>
      <ol>
        <li><strong>Local implementations</strong> â€” Custom loader's local module map</li>
        <li><strong>Entry points</strong> â€” Python package metadata (<code>amplifier.modules</code>)</li>
        <li><strong>Module cache</strong> â€” If <code>amplifier_module_resolution</code> is available</li>
      </ol>

      <h2 id="external-integration">External App Integration Guide</h2>
      <p>Building applications with amplifier-core follows the kernel design principle: your app provides policy, amplifier provides mechanism.</p>

      <div class="info-box" style="border-left: 4px solid var(--green); margin: 20px 0;">
        <strong>Reference Implementation</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">The <code>amp</code> CLI (<code>amplifier-app-cli</code>) demonstrates the canonical integration pattern.</p>
      </div>

      <h3>Architecture Overview</h3>
      <p>The following diagram shows how external applications integrate with amplifier-core:</p>
      <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0; overflow-x: auto;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 780" style="width: 100%; max-width: 1000px; display: block; margin: 0 auto;">
          <defs>
            <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="coreGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="moduleGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#f8fafc;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#e2e8f0;stop-opacity:1" />
            </linearGradient>
            <linearGradient id="orchestratorGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#4338ca;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
            </linearGradient>
            <filter id="shadow" x="-10%" y="-10%" width="120%" height="130%">
              <feDropShadow dx="0" dy="4" stdDeviation="6" flood-opacity="0.15"/>
            </filter>
            <filter id="softShadow" x="-5%" y="-5%" width="110%" height="115%">
              <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.1"/>
            </filter>
            <filter id="glowPurple" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="0" stdDeviation="4" flood-color="#6366f1" flood-opacity="0.4"/>
            </filter>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
            </marker>
            <marker id="arrowheadBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#0284c7"/>
            </marker>
            <marker id="arrowheadPurpleUp" markerWidth="8" markerHeight="6" refX="4" refY="6" orient="auto">
              <polygon points="0 6, 4 0, 8 6" fill="#6366f1"/>
            </marker>
            <marker id="arrowheadGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#059669"/>
            </marker>
          </defs>
          <rect width="1100" height="780" fill="#f8fafc"/>
          <text x="550" y="35" font-family="system-ui, -apple-system, sans-serif" font-size="24" font-weight="600" fill="#1e293b" text-anchor="middle">Amplifier External App Architecture</text>
          <g filter="url(#shadow)">
            <rect x="400" y="55" width="300" height="60" rx="12" fill="url(#headerGrad)"/>
            <text x="550" y="82" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="white" text-anchor="middle">Your App UI</text>
            <text x="550" y="100" font-family="system-ui, sans-serif" font-size="11" fill="rgba(255,255,255,0.8)" text-anchor="middle">web - desktop - service</text>
          </g>
          <line x1="550" y1="115" x2="550" y2="145" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>
          <text x="620" y="135" font-family="system-ui, sans-serif" font-size="10" fill="#64748b">session.execute("prompt")</text>
          <g filter="url(#shadow)">
            <rect x="375" y="150" width="350" height="55" rx="12" fill="url(#coreGrad)"/>
            <text x="550" y="177" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="white" text-anchor="middle">AmplifierSession</text>
            <text x="550" y="193" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">amplifier-core kernel - config (mount plan)</text>
          </g>
          <text x="550" y="225" font-family="system-ui, sans-serif" font-size="9" fill="#64748b" text-anchor="middle">creates</text>
          <g filter="url(#softShadow)">
            <rect x="180" y="235" width="740" height="100" rx="12" fill="white" stroke="#cbd5e1" stroke-width="1"/>
          </g>
          <g>
            <rect x="200" y="250" width="380" height="70" rx="10" fill="white" stroke="#94a3b8" stroke-width="1.5"/>
            <text x="390" y="273" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="#1e293b" text-anchor="middle">Coordinator</text>
            <text x="390" y="291" font-family="system-ui, sans-serif" font-size="10" fill="#64748b" text-anchor="middle">session_id - mount_points - get() - emit()</text>
            <text x="390" y="308" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">infrastructure for module access and events</text>
          </g>
          <g>
            <rect x="620" y="250" width="280" height="70" rx="10" fill="white" stroke="#0ea5e9" stroke-width="2"/>
            <rect x="620" y="250" width="280" height="24" rx="10" fill="#e0f2fe"/>
            <rect x="620" y="266" width="280" height="8" fill="#e0f2fe"/>
            <text x="760" y="268" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#0369a1" text-anchor="middle">ModuleLoader</text>
            <text x="760" y="293" font-family="system-ui, sans-serif" font-size="9" fill="#64748b" text-anchor="middle">entry points - filesystem - source resolver</text>
            <text x="760" y="308" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">loader.load(id) - mount_fn(coordinator)</text>
          </g>
          <path d="M 580 285 L 620 285" fill="none" stroke="#0ea5e9" stroke-width="2" marker-end="url(#arrowheadBlue)"/>
          <text x="600" y="278" font-family="system-ui, sans-serif" font-size="8" fill="#0284c7" text-anchor="middle">uses</text>
          <text x="550" y="355" font-family="system-ui, sans-serif" font-size="10" font-weight="500" fill="#6366f1" text-anchor="middle">Mount Plan defines all modules</text>
          <path d="M 760 320 L 760 365 L 140 365 L 140 400" fill="none" stroke="#0ea5e9" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowheadBlue)"/>
          <path d="M 760 320 L 760 365 L 360 365 L 360 400" fill="none" stroke="#0ea5e9" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowheadBlue)"/>
          <path d="M 760 320 L 760 365 L 580 365 L 580 400" fill="none" stroke="#0ea5e9" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowheadBlue)"/>
          <path d="M 760 320 L 760 365 L 800 365 L 800 400" fill="none" stroke="#0ea5e9" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowheadBlue)"/>
          <path d="M 760 320 L 760 365 L 1000 365 L 1000 400" fill="none" stroke="#0ea5e9" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowheadBlue)"/>
          <text x="550" y="378" font-family="system-ui, sans-serif" font-size="8" fill="#0284c7" text-anchor="middle">loads all modules at init time</text>
          <g filter="url(#glowPurple)">
            <rect x="55" y="405" width="170" height="140" rx="10" fill="url(#orchestratorGrad)"/>
            <text x="140" y="430" font-family="system-ui, sans-serif" font-size="12" font-weight="700" fill="white" text-anchor="middle">Orchestrator</text>
            <text x="140" y="448" font-family="system-ui, sans-serif" font-size="9" fill="rgba(255,255,255,0.9)" text-anchor="middle">loop-*</text>
            <line x1="75" y1="458" x2="205" y2="458" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
            <text x="140" y="475" font-family="system-ui, sans-serif" font-size="9" fill="rgba(255,255,255,0.85)" text-anchor="middle">DRIVES EXECUTION</text>
            <text x="140" y="492" font-family="system-ui, sans-serif" font-size="8" fill="rgba(255,255,255,0.7)" text-anchor="middle">- plan - act - refine loop</text>
            <text x="140" y="506" font-family="system-ui, sans-serif" font-size="8" fill="rgba(255,255,255,0.7)" text-anchor="middle">- calls providers</text>
            <text x="140" y="520" font-family="system-ui, sans-serif" font-size="8" fill="rgba(255,255,255,0.7)" text-anchor="middle">- executes tools</text>
            <text x="140" y="534" font-family="system-ui, sans-serif" font-size="8" fill="rgba(255,255,255,0.7)" text-anchor="middle">- returns to user</text>
          </g>
          <g filter="url(#softShadow)">
            <rect x="275" y="405" width="170" height="105" rx="8" fill="url(#moduleGrad)" stroke="#cbd5e1" stroke-width="1"/>
            <rect x="275" y="405" width="170" height="26" rx="8" fill="#dbeafe"/>
            <rect x="275" y="423" width="170" height="8" fill="#dbeafe"/>
            <text x="360" y="425" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#1d4ed8" text-anchor="middle">Context</text>
            <text x="360" y="448" font-family="system-ui, sans-serif" font-size="9" fill="#64748b" text-anchor="middle">context-*</text>
            <text x="360" y="465" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">conversation</text>
            <text x="360" y="480" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">memory / history</text>
            <text x="360" y="495" font-family="system-ui, sans-serif" font-size="8" fill="#94a3b8" text-anchor="middle">add - get - compact</text>
          </g>
          <g filter="url(#softShadow)">
            <rect x="495" y="405" width="170" height="105" rx="8" fill="url(#moduleGrad)" stroke="#cbd5e1" stroke-width="1"/>
            <rect x="495" y="405" width="170" height="26" rx="8" fill="#d1fae5"/>
            <rect x="495" y="423" width="170" height="8" fill="#d1fae5"/>
            <text x="580" y="425" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#047857" text-anchor="middle">Providers</text>
            <text x="580" y="448" font-family="system-ui, sans-serif" font-size="9" fill="#64748b" text-anchor="middle">provider-*</text>
            <text x="580" y="465" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">Anthropic - OpenAI</text>
            <text x="580" y="480" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">Gemini - Local</text>
            <text x="580" y="495" font-family="system-ui, sans-serif" font-size="8" fill="#94a3b8" text-anchor="middle">complete() - list_models()</text>
          </g>
          <g filter="url(#softShadow)">
            <rect x="715" y="405" width="170" height="105" rx="8" fill="url(#moduleGrad)" stroke="#cbd5e1" stroke-width="1"/>
            <rect x="715" y="405" width="170" height="26" rx="8" fill="#fef3c7"/>
            <rect x="715" y="423" width="170" height="8" fill="#fef3c7"/>
            <text x="800" y="425" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#b45309" text-anchor="middle">Tools</text>
            <text x="800" y="448" font-family="system-ui, sans-serif" font-size="9" fill="#64748b" text-anchor="middle">tool-*</text>
            <text x="800" y="465" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">filesystem - bash</text>
            <text x="800" y="480" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">web - task - custom</text>
            <text x="800" y="495" font-family="system-ui, sans-serif" font-size="8" fill="#94a3b8" text-anchor="middle">execute(input)</text>
          </g>
          <g filter="url(#softShadow)">
            <rect x="915" y="405" width="170" height="105" rx="8" fill="url(#moduleGrad)" stroke="#cbd5e1" stroke-width="1"/>
            <rect x="915" y="405" width="170" height="26" rx="8" fill="#fce7f3"/>
            <rect x="915" y="423" width="170" height="8" fill="#fce7f3"/>
            <text x="1000" y="425" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#be185d" text-anchor="middle">Hooks</text>
            <text x="1000" y="448" font-family="system-ui, sans-serif" font-size="9" fill="#64748b" text-anchor="middle">hooks-*</text>
            <text x="1000" y="465" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">logging - approval</text>
            <text x="1000" y="480" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">redaction - tracking</text>
            <text x="1000" y="495" font-family="system-ui, sans-serif" font-size="8" fill="#94a3b8" text-anchor="middle">observe - modify</text>
          </g>
          <line x1="225" y1="530" x2="1000" y2="530" stroke="#6366f1" stroke-width="2"/>
          <line x1="225" y1="475" x2="250" y2="475" stroke="#6366f1" stroke-width="2"/>
          <line x1="250" y1="475" x2="250" y2="530" stroke="#6366f1" stroke-width="2"/>
          <circle cx="225" cy="475" r="4" fill="#6366f1"/>
          <line x1="360" y1="530" x2="360" y2="515" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowheadPurpleUp)"/>
          <line x1="580" y1="530" x2="580" y2="515" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowheadPurpleUp)"/>
          <line x1="800" y1="530" x2="800" y2="515" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowheadPurpleUp)"/>
          <line x1="1000" y1="530" x2="1000" y2="515" stroke="#6366f1" stroke-width="2" marker-end="url(#arrowheadPurpleUp)"/>
          <circle cx="360" cy="530" r="3" fill="#6366f1"/>
          <circle cx="580" cy="530" r="3" fill="#6366f1"/>
          <circle cx="800" cy="530" r="3" fill="#6366f1"/>
          <circle cx="1000" cy="530" r="3" fill="#6366f1"/>
          <text x="620" y="550" font-family="system-ui, sans-serif" font-size="9" font-weight="500" fill="#6366f1" text-anchor="middle">Orchestrator drives execution via coordinator.get()</text>
          <path d="M 55 475 L 35 475 L 35 177 L 375 177" fill="none" stroke="#059669" stroke-width="2" marker-end="url(#arrowheadGreen)"/>
          <text x="35" y="330" font-family="system-ui, sans-serif" font-size="8" fill="#059669" writing-mode="tb" text-anchor="middle">returns result</text>
          <g filter="url(#softShadow)">
            <rect x="940" y="150" width="140" height="165" rx="10" fill="white" stroke="#f59e0b" stroke-width="2" stroke-dasharray="4,2"/>
            <text x="1010" y="173" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#b45309" text-anchor="middle">Policy Layer</text>
            <text x="1010" y="190" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8" text-anchor="middle">(You own these)</text>
            <rect x="955" y="203" width="110" height="24" rx="5" fill="#fef3c7"/>
            <text x="1010" y="219" font-family="system-ui, sans-serif" font-size="10" fill="#92400e" text-anchor="middle">ModuleLoader</text>
            <rect x="955" y="233" width="110" height="24" rx="5" fill="#fef3c7"/>
            <text x="1010" y="249" font-family="system-ui, sans-serif" font-size="10" fill="#92400e" text-anchor="middle">ApprovalSystem</text>
            <rect x="955" y="263" width="110" height="24" rx="5" fill="#fef3c7"/>
            <text x="1010" y="279" font-family="system-ui, sans-serif" font-size="10" fill="#92400e" text-anchor="middle">DisplaySystem</text>
            <rect x="955" y="293" width="110" height="15" rx="3" fill="#fef9c3"/>
            <text x="1010" y="304" font-family="system-ui, sans-serif" font-size="8" fill="#a16207" text-anchor="middle">SourceResolver</text>
          </g>
          <path d="M 940 200 L 725 177" fill="none" stroke="#f59e0b" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#arrowhead)"/>
          <g transform="translate(30, 55)">
            <rect x="0" y="0" width="240" height="115" rx="8" fill="#eff6ff" stroke="#3b82f6" stroke-width="1"/>
            <text x="120" y="20" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="#1d4ed8" text-anchor="middle">Execution Flow</text>
            <text x="120" y="40" font-family="system-ui, sans-serif" font-size="9" fill="#3b82f6" text-anchor="middle">1. App calls session.execute(prompt)</text>
            <text x="120" y="55" font-family="system-ui, sans-serif" font-size="9" fill="#3b82f6" text-anchor="middle">2. Session calls orchestrator.execute()</text>
            <text x="120" y="70" font-family="system-ui, sans-serif" font-size="9" fill="#6366f1" font-weight="600" text-anchor="middle">3. Orchestrator takes control:</text>
            <text x="120" y="85" font-family="system-ui, sans-serif" font-size="8" fill="#64748b" text-anchor="middle">- builds messages from context</text>
            <text x="120" y="97" font-family="system-ui, sans-serif" font-size="8" fill="#64748b" text-anchor="middle">- calls provider.complete()</text>
            <text x="120" y="109" font-family="system-ui, sans-serif" font-size="8" fill="#64748b" text-anchor="middle">- executes tools - emits hooks</text>
          </g>
          <g transform="translate(30, 620)">
            <rect x="0" y="0" width="350" height="90" rx="8" fill="white" stroke="#e2e8f0" stroke-width="1" filter="url(#softShadow)"/>
            <text x="175" y="18" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="#64748b" text-anchor="middle">Legend</text>
            <circle cx="20" cy="38" r="6" fill="url(#coreGrad)"/>
            <text x="35" y="42" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Core / Session</text>
            <rect x="14" y="50" width="12" height="12" rx="2" fill="#e0f2fe" stroke="#0ea5e9" stroke-width="1"/>
            <text x="35" y="60" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Loader</text>
            <rect x="14" y="68" width="12" height="12" rx="2" fill="url(#orchestratorGrad)"/>
            <text x="35" y="78" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Orchestrator (driver)</text>
            <line x1="130" y1="38" x2="160" y2="38" stroke="#0ea5e9" stroke-width="2" stroke-dasharray="4,2"/>
            <text x="170" y="42" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Load path (init)</text>
            <line x1="130" y1="55" x2="160" y2="55" stroke="#6366f1" stroke-width="2"/>
            <text x="170" y="59" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Execution (orchestrator drives)</text>
            <line x1="130" y1="72" x2="160" y2="72" stroke="#059669" stroke-width="2"/>
            <text x="170" y="76" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Return to app</text>
          </g>
          <g transform="translate(400, 620)">
            <rect x="0" y="0" width="300" height="90" rx="8" fill="#f5f3ff" stroke="#6366f1" stroke-width="1" filter="url(#softShadow)"/>
            <text x="150" y="20" font-family="system-ui, sans-serif" font-size="10" font-weight="600" fill="#4338ca" text-anchor="middle">Orchestrator Owns the Transaction</text>
            <text x="150" y="40" font-family="system-ui, sans-serif" font-size="9" fill="#64748b" text-anchor="middle">- Loaded as a module (like others)</text>
            <text x="150" y="55" font-family="system-ui, sans-serif" font-size="9" fill="#64748b" text-anchor="middle">- But once execute() is called...</text>
            <text x="150" y="70" font-family="system-ui, sans-serif" font-size="9" fill="#6366f1" font-weight="500" text-anchor="middle">- It decides: loops, exits, displays</text>
            <text x="150" y="85" font-family="system-ui, sans-serif" font-size="9" fill="#6366f1" font-weight="500" text-anchor="middle">- Other modules serve the orchestrator</text>
          </g>
        </svg>
      </div>

      <h3>Required Components</h3>
      <p>External applications must provide three policy components:</p>

      <div class="concepts" style="margin-bottom: 30px;">
        <div class="concept">
          <h3>1. ModuleLoader</h3>
          <p>Custom loader to resolve modules from your preferred sources.</p>
          <div class="code-block" style="margin-top: 8px;">
            <pre style="padding: 12px;"><code class="language-python">from amplifier_core import ModuleLoader

class LocalLoader(ModuleLoader):
    # Always use local for orchestrators/contexts
    ALWAYS_LOCAL = ("loop-", "context-")

    async def load(self, module_id, config=None, profile_source=None):
        if any(module_id.startswith(p) for p in self.ALWAYS_LOCAL):
            return self.local_modules[module_id]
        # Fall back to entry points for providers
        return await super().load(module_id, config, profile_source)</code></pre>
          </div>
        </div>

        <div class="concept">
          <h3>2. ApprovalSystem</h3>
          <p>UI/UX for user consent on tool execution.</p>
          <div class="code-block" style="margin-top: 8px;">
            <pre style="padding: 12px;"><code class="language-python">from amplifier_core import ApprovalCallback

class MyApprovalSystem:
    async def request(self, tool_name: str, input: dict) -> bool:
        # Show UI dialog, return True to approve
        return await show_approval_dialog(tool_name, input)</code></pre>
          </div>
        </div>

        <div class="concept">
          <h3>3. DisplaySystem</h3>
          <p>Rendering for messages, tool calls, and streaming.</p>
          <div class="code-block" style="margin-top: 8px;">
            <pre style="padding: 12px;"><code class="language-python">class MyDisplaySystem:
    async def show_message(self, role: str, content: list):
        # Render message to your UI
        pass

    async def show_tool_call(self, name: str, input: dict, result: str):
        # Render tool execution
        pass</code></pre>
          </div>
        </div>
      </div>

      <h3>Creating an AmplifierSession</h3>
      <div class="code-block">
        <pre style="padding: 12px;"><code class="language-python">from amplifier_core import AmplifierSession, SessionConfig

# Create session with your policy components
config = SessionConfig(
    orchestrator="loop-streaming",
    providers=[{"module": "provider-anthropic", "model": "claude-sonnet-4-20250514"}],
    tools=[{"module": "tool-filesystem"}, {"module": "tool-bash"}],
    context="context-simple",
)

session = AmplifierSession(
    config,
    loader=LocalLoader(),           # Your custom module loader
    approval_system=MyApprovalSystem(),  # Your approval UI
    display_system=MyDisplaySystem(),    # Your message renderer
)

# Run a prompt
result = await session.run("What files are in this directory?")</code></pre>
      </div>

      <h3 id="production-config">Production Configuration</h3>
      <p>When deploying agents for code generation or complex tasks, configure providers defensively:</p>

      <div class="info-box" style="border-left: 4px solid var(--red); margin: 20px 0;">
        <strong>Critical: Token Limits</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">The default <code>max_tokens</code> (4096) is insufficient for code generation. When the model hits this limit mid-stream, it truncates output producing incomplete JSON tool calls.</p>
      </div>

      <table class="ref-table">
        <thead>
          <tr><th>Setting</th><th>Default</th><th>Recommended</th><th>Why</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><code>max_tokens</code></td>
            <td>4096</td>
            <td><strong>8192+</strong></td>
            <td>Prevents truncated tool calls during code generation</td>
          </tr>
          <tr>
            <td><code>temperature</code></td>
            <td>1.0</td>
            <td>0.5-0.7</td>
            <td>More consistent tool use and JSON structure</td>
          </tr>
          <tr>
            <td><code>timeout</code></td>
            <td>60s</td>
            <td>120s</td>
            <td>Long operations need time to complete</td>
          </tr>
        </tbody>
      </table>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">python</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre style="padding: 12px;"><code class="language-python"># Production configuration for coding agents
config = {
    "session": {
        "orchestrator": "loop-streaming",
        "context": "context-persistent"
    },
    "providers": [{
        "module": "provider-anthropic",
        "config": {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 8192,   # CRITICAL for code generation
            "temperature": 0.7,   # More consistent tool calls
        }
    }],
    "tools": [
        {"module": "tool-filesystem"},
        {"module": "tool-bash"}
    ]
}</code></pre>
      </div>

      <h3>Hook Events for Streaming UI</h3>
      <p>Subscribe to hook events for real-time UI updates:</p>
      <table class="ref-table">
        <thead>
          <tr><th>Event</th><th>Description</th><th>Payload</th></tr>
        </thead>
        <tbody>
          <tr><td><code>content_block:start</code></td><td>Text block begins</td><td><code>{index, type}</code></td></tr>
          <tr><td><code>content_block:delta</code></td><td>Streaming text chunk</td><td><code>{index, delta}</code></td></tr>
          <tr><td><code>content_block:end</code></td><td>Text block complete</td><td><code>{index}</code></td></tr>
          <tr><td><code>thinking:delta</code></td><td>Extended thinking chunk</td><td><code>{delta}</code></td></tr>
          <tr><td><code>thinking:final</code></td><td>Thinking complete</td><td><code>{content}</code></td></tr>
          <tr><td><code>tool:pre</code></td><td>Before tool execution</td><td><code>{tool, input, call_id}</code></td></tr>
          <tr><td><code>tool:post</code></td><td>After tool execution</td><td><code>{tool, input, result, call_id}</code></td></tr>
          <tr><td><code>provider:request</code></td><td>LLM API call starts</td><td><code>{messages}</code></td></tr>
          <tr><td><code>provider:response</code></td><td>LLM API call ends</td><td><code>{response}</code></td></tr>
        </tbody>
      </table>

      <h3>Desktop vs Core Mode Pattern</h3>
      <p>Applications can offer dual modes for provider loading:</p>
      <div class="concepts">
        <div class="concept">
          <h3>Desktop Mode (Default)</h3>
          <p>All modules use local implementations bundled with your app.</p>
          <ul>
            <li>Faster startup (no entry point resolution)</li>
            <li>Consistent behavior across environments</li>
            <li>Self-contained distribution</li>
          </ul>
        </div>
        <div class="concept">
          <h3>Core Mode</h3>
          <p>Providers load from amplifier-core entry points.</p>
          <ul>
            <li>Use latest provider implementations</li>
            <li>Benefit from upstream bug fixes</li>
            <li>Only affects providers (orchestrators/contexts stay local)</li>
          </ul>
        </div>
      </div>

      <div class="info-box" style="border-left: 4px solid var(--purple); margin: 20px 0;">
        <strong>Important</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">In Core mode, orchestrators (<code>loop-*</code>) and contexts (<code>context-*</code>) should always use local implementations. Only providers benefit from entry point loading.</p>
      </div>

      <h2 id="troubleshooting">Troubleshooting Common Errors</h2>
      <p>Common issues when integrating with amplifier-core and their solutions:</p>

      <div class="concepts">
        <div class="concept" style="border-left: 3px solid var(--red);">
          <h3><code>Missing required arguments: ['content']</code></h3>
          <p><strong>Cause:</strong> Token limit hit mid-generation, truncating JSON output.</p>
          <p><strong>Fix:</strong> Increase <code>max_tokens</code> in provider config to 8192+.</p>
          <div class="code-block" style="margin-top: 10px;">
            <pre style="padding: 10px; font-size: 12px;"><code>"providers": [{
    "module": "provider-anthropic",
    "config": {"max_tokens": 8192}
}]</code></pre>
          </div>
        </div>

        <div class="concept" style="border-left: 3px solid var(--orange);">
          <h3><code>tool_use.name: String should have at least 1 character</code></h3>
          <p><strong>Cause:</strong> LLM generated empty tool name (hallucination).</p>
          <p><strong>Fix:</strong> Add sanitization layer in your provider integration:</p>
          <div class="code-block" style="margin-top: 10px;">
            <pre style="padding: 10px; font-size: 12px;"><code># Sanitize empty tool names before API call
if not tool_call.get("name") or not tool_call["name"].strip():
    tool_call["name"] = "unknown_tool"
    logger.warning(f"Fixed empty tool name")</code></pre>
          </div>
        </div>

        <div class="concept" style="border-left: 3px solid var(--yellow);">
          <h3><code>ToolCallBlock has invalid name</code></h3>
          <p><strong>Cause:</strong> Same as above - LLM returned malformed tool call.</p>
          <p><strong>Fix:</strong> Validate tool calls before execution and add a sanitization hook.</p>
        </div>

        <div class="concept" style="border-left: 3px solid var(--blue);">
          <h3><code>'tuple' object has no attribute 'get'</code></h3>
          <p><strong>Cause:</strong> Patch/modification applied to incompatible module type (cached vs local).</p>
          <p><strong>Fix:</strong> Check module implementation matches expected interface. Clear module cache:</p>
          <div class="code-block" style="margin-top: 10px;">
            <pre style="padding: 10px; font-size: 12px;"><code>rm -rf ~/.amplifier/module-cache</code></pre>
          </div>
        </div>
      </div>

      <h3>Reset Commands</h3>
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">bash</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre style="padding: 12px;"><code class="language-bash"># Reset profile to defaults
amplifier profile reset

# Clear module cache (fixes stale module issues)
rm -rf ~/.amplifier/module-cache

# Reinstall from scratch
uv tool install git+https://github.com/microsoft/amplifier@main
amplifier update</code></pre>
      </div>

      <h3>LLM Edge Case Handling</h3>
      <p>LLMs can generate invalid tool calls. Your integration should sanitize these defensively:</p>
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">python</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre style="padding: 12px;"><code class="language-python">def sanitize_tool_calls(tool_calls: list) -> list:
    """Clean up malformed LLM tool calls before execution."""
    sanitized = []
    for tc in tool_calls:
        # Fix empty names
        name = tc.get("name", "").strip()
        if not name:
            name = "unknown_tool"
            logger.warning(f"Fixed empty tool name for id={tc.get('id')}")

        # Ensure arguments is a dict
        args = tc.get("arguments") or tc.get("input") or {}
        if isinstance(args, str):
            try:
                args = json.loads(args)
            except json.JSONDecodeError:
                args = {"raw": args}

        sanitized.append({
            "id": tc.get("id"),
            "name": name,
            "arguments": args
        })
    return sanitized</code></pre>
      </div>

    </section>

    <!-- REFERENCE SECTION -->
    <section id="section-reference" class="section">
      <h1>API Reference</h1>
      <p class="section-desc">Complete documentation for module developers.</p>

      <div class="info-box" style="border-left: 4px solid var(--purple); margin-bottom: 24px;">
        <strong>ðŸ“š Complete API Reference</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">For the full API documentation including all contracts and interfaces, see the <a href="https://microsoft.github.io/amplifier-docs/developer-guide/" target="_blank">official Developer Guide</a>.</p>
      </div>

      <div class="tabs" id="reference-tabs">
        <button class="tab active" data-tab="contracts">Contracts</button>
        <button class="tab" data-tab="hooks-api">Hooks API</button>
        <button class="tab" data-tab="events">Events</button>
        <button class="tab" data-tab="profiles">Profiles</button>
        <button class="tab" data-tab="sessions">Sessions</button>
        <button class="tab" data-tab="agents">Agents</button>
      </div>

      <!-- Contracts Tab -->
      <div id="ref-contracts" class="tab-content active">
        <p>All modules use Python Protocols (structural typing). No inheritance required.</p>

        <div class="contracts">
          <div class="contract">
            <h4>Provider <span>LLM Backend</span></h4>
            <code>name: str</code>
            <code>get_info() â†’ ProviderInfo</code>
            <code>list_models() â†’ list[ModelInfo]</code>
            <code>complete(ChatRequest) â†’ ChatResponse</code>
            <code>parse_tool_calls(ChatResponse) â†’ list</code>
          </div>
          <div class="contract">
            <h4>Tool <span>Agent Capability</span></h4>
            <code>name: str</code>
            <code>description: str</code>
            <code>input_schema: dict</code> <span style="color: var(--orange); font-size: 11px;">(recommended)</span>
            <code>execute(input: dict) â†’ ToolResult</code>
          </div>
          <div class="contract">
            <h4>Orchestrator <span>Execution Loop</span></h4>
            <code>execute(prompt, context, providers, tools, hooks) â†’ str</code>
          </div>
          <div class="contract">
            <h4>ContextManager <span>Memory</span></h4>
            <code>add_message(message)</code>
            <code>get_messages() â†’ list</code>
            <code>should_compact() â†’ bool</code>
            <code>compact()</code>
            <code>clear()</code>
          </div>
          <div class="contract">
            <h4>Hook <span>Observability</span></h4>
            <code>async handler(event: str, data: dict) â†’ HookResult</code>
          </div>
        </div>
      </div>

      <!-- Hooks API Tab -->
      <div id="ref-hooks-api" class="tab-content">
        <p>Hooks observe events and optionally modify behavior via HookResult.</p>

        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def my_hook(event: str, data: dict) -> HookResult:
    if event == "tool:pre" and "rm -rf" in str(data.get("tool_input")):
        return HookResult(action="deny", reason="Blocked")
    return HookResult(action="continue")</code></pre>
        </div>

        <h3>HookResult Actions</h3>
        <div class="actions">
          <div class="action">
            <code>continue</code>
            <span>Proceed normally (default)</span>
          </div>
          <div class="action">
            <code>deny</code>
            <span>Block with reason</span>
          </div>
          <div class="action">
            <code>modify</code>
            <span>Alter event data</span>
          </div>
          <div class="action">
            <code>inject_context</code>
            <span>Add message to context</span>
          </div>
          <div class="action">
            <code>ask_user</code>
            <span>Pause for approval</span>
          </div>
        </div>
      </div>

      <!-- Events Tab -->
      <div id="ref-events" class="tab-content">
        <p>30+ hookable events covering the entire agent lifecycle. Events are logged as JSONL for debugging and observability.</p>

        <h3>Session Lifecycle</h3>
        <table class="ref-table">
          <thead><tr><th>Event</th><th>When</th><th>Data</th></tr></thead>
          <tbody>
            <tr><td><code>session:start</code></td><td>Session initialized</td><td>session_id, mount_plan</td></tr>
            <tr><td><code>session:end</code></td><td>Session cleanup</td><td>session_id, duration</td></tr>
            <tr><td><code>session:fork</code></td><td>Sub-session created</td><td>parent_id, child_id</td></tr>
            <tr><td><code>session:resume</code></td><td>Session resumed</td><td>session_id</td></tr>
          </tbody>
        </table>

        <h3>Prompt Lifecycle</h3>
        <table class="ref-table">
          <thead><tr><th>Event</th><th>When</th><th>Data</th></tr></thead>
          <tbody>
            <tr><td><code>prompt:submit</code></td><td>User prompt received</td><td>prompt, session_id</td></tr>
            <tr><td><code>prompt:complete</code></td><td>Response generated</td><td>response, duration</td></tr>
          </tbody>
        </table>

        <h3>Provider Events</h3>
        <table class="ref-table">
          <thead><tr><th>Event</th><th>When</th><th>Data</th></tr></thead>
          <tbody>
            <tr><td><code>provider:request</code></td><td>Before LLM call</td><td>messages, model</td></tr>
            <tr><td><code>provider:response</code></td><td>After LLM response</td><td>response, usage</td></tr>
            <tr><td><code>provider:error</code></td><td>LLM call failed</td><td>error, model</td></tr>
          </tbody>
        </table>

        <h3>Tool Events</h3>
        <table class="ref-table">
          <thead><tr><th>Event</th><th>When</th><th>Data</th></tr></thead>
          <tbody>
            <tr><td><code>tool:pre</code></td><td>Before tool execution</td><td>tool_name, input</td></tr>
            <tr><td><code>tool:post</code></td><td>After tool execution</td><td>tool_name, result</td></tr>
            <tr><td><code>tool:error</code></td><td>Tool execution failed</td><td>tool_name, error</td></tr>
          </tbody>
        </table>

        <h3>Context Events</h3>
        <table class="ref-table">
          <thead><tr><th>Event</th><th>When</th><th>Data</th></tr></thead>
          <tbody>
            <tr><td><code>context:pre_compact</code></td><td>Before compaction</td><td>message_count, tokens</td></tr>
            <tr><td><code>context:post_compact</code></td><td>After compaction</td><td>message_count, tokens</td></tr>
            <tr><td><code>context:include</code></td><td>Context injected</td><td>source, content</td></tr>
          </tbody>
        </table>

        <h3>Approval &amp; Streaming Events</h3>
        <table class="ref-table">
          <thead><tr><th>Event</th><th>When</th><th>Data</th></tr></thead>
          <tbody>
            <tr><td><code>approval:required</code></td><td>Approval requested</td><td>operation, prompt</td></tr>
            <tr><td><code>approval:granted</code></td><td>User approved</td><td>operation</td></tr>
            <tr><td><code>approval:denied</code></td><td>User denied</td><td>operation, reason</td></tr>
            <tr><td><code>content_block:start</code></td><td>Streaming starts</td><td>block_type</td></tr>
            <tr><td><code>content_block:delta</code></td><td>Content chunk</td><td>delta</td></tr>
            <tr><td><code>content_block:end</code></td><td>Streaming ends</td><td>block_type</td></tr>
          </tbody>
        </table>

        <h3>Event Log Format (JSONL)</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">{
  "ts": "2024-01-15T10:30:00.123Z",
  "session_id": "abc123",
  "event": "tool:pre",
  "component": "orchestrator",
  "module": "tool-bash",
  "data": {"tool_name": "bash", "input": {"command": "ls"}}
}</code></pre>
        </div>

        <h3>Finding Logs</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Session logs location
ls ~/.amplifier/projects/&lt;project&gt;/sessions/&lt;session-id&gt;/events.jsonl

# Search for tool errors
grep '"event":"tool:error"' events.jsonl

# Pretty print with jq
cat events.jsonl | jq 'select(.event == "provider:request")'</code></pre>
        </div>
      </div>

      <!-- Profiles Tab -->
      <div id="ref-profiles" class="tab-content">
        <p>Profiles are pre-configured capability sets defining which modules are accessible during a session.</p>

        <h3>Built-in Profiles</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Profile</th><th>Purpose</th><th>Best For</th></tr>
          </thead>
          <tbody>
            <tr><td><code>foundation</code></td><td>Minimal LLM access only</td><td>Basic chat interactions</td></tr>
            <tr><td><code>base</code></td><td>Filesystem and bash capabilities</td><td>Light development tasks</td></tr>
            <tr><td><code>dev</code></td><td>Complete development tools</td><td>Daily development work</td></tr>
            <tr><td><code>test</code></td><td>Testing-focused configuration</td><td>Running tests, debugging</td></tr>
            <tr><td><code>full</code></td><td>All available features enabled</td><td>Exploring system capabilities</td></tr>
          </tbody>
        </table>

        <h3>Profile Commands</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier profile list          # View all profiles
amplifier profile use dev       # Set as default
amplifier profile show dev      # Display configuration
amplifier profile current       # Check active profile
amplifier run --profile dev "..." # Single command usage</code></pre>
        </div>

        <h3>Custom Profile Structure</h3>
        <p>Profiles use markdown with YAML frontmatter. Store in <code>.amplifier/profiles/</code> (project) or <code>~/.amplifier/profiles/</code> (user).</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">---
name: my-profile
extends: base
description: Custom development profile
session:
  orchestrator: loop-streaming
  context: context-persistent
providers:
  - module: provider-anthropic
    config:
      default_model: claude-opus-4-1
tools:
  - module: tool-filesystem
  - module: tool-bash
    config:
      timeout: 60
hooks:
  - module: hooks-logging
agents:
  code-reviewer:
    description: Expert code reviewer
    tools:
      - tool-filesystem
---

# System Instructions

You are an expert assistant...</code></pre>
        </div>

        <h3>Profile Inheritance</h3>
        <p>Profiles inherit in a linear chain. Each level accumulates capabilities:</p>
        <div class="inheritance-chain">
          <code>foundation</code> â†’ <code>base</code> â†’ <code>dev</code> â†’ <code>custom</code>
        </div>
      </div>

      <!-- Sessions Tab -->
      <div id="ref-sessions" class="tab-content">
        <p>Sessions track conversations, preserving history, tool results, and metadata for resumption.</p>

        <h3>Session Commands</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Starting & Listing
amplifier run "prompt"           # Create new session
amplifier session list           # Display all sessions
amplifier session show [id]      # View session details

# Resuming
amplifier continue "follow-up"   # Resume most recent
amplifier session resume [id]    # Resume specific session
amplifier run --resume [id] "prompt"

# Management
amplifier session delete [id]    # Remove a session
amplifier session cleanup --days 7  # Delete old sessions</code></pre>
        </div>

        <h3>Storage Structure</h3>
        <p>Sessions persist at <code>~/.amplifier/projects/&lt;project-slug&gt;/sessions/&lt;session-id&gt;/</code></p>
        <table class="ref-table">
          <thead>
            <tr><th>File</th><th>Contents</th></tr>
          </thead>
          <tbody>
            <tr><td><code>transcript.jsonl</code></td><td>Conversation history</td></tr>
            <tr><td><code>events.jsonl</code></td><td>Complete event log</td></tr>
            <tr><td><code>metadata.json</code></td><td>Session metadata</td></tr>
          </tbody>
        </table>

        <h3>Session Lifecycle</h3>
        <div class="lifecycle">
          <span class="lifecycle-step">Creation</span> â†’
          <span class="lifecycle-step">Active</span> â†’
          <span class="lifecycle-step">Ended</span> â†’
          <span class="lifecycle-step">Resumption</span>
        </div>

        <h3>Context Preservation</h3>
        <div class="context-info">
          <div class="context-preserved">
            <strong>Preserved:</strong> Conversation history, session ID, project context
          </div>
          <div class="context-reloaded">
            <strong>Reloaded:</strong> Current profile and provider configurations
          </div>
          <div class="context-not">
            <strong>Not preserved:</strong> Tool execution state, in-memory context beyond token limits
          </div>
        </div>
      </div>

      <!-- Agents Tab -->
      <div id="ref-agents" class="tab-content">
        <p>Agents are specialized configurations functioning as sub-sessions for focused tasks.</p>

        <h3>Built-in Agents</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Agent</th><th>Purpose</th></tr>
          </thead>
          <tbody>
            <tr><td><code>explorer</code></td><td>Breadth-first codebase exploration</td></tr>
            <tr><td><code>bug-hunter</code></td><td>Systematic debugging and issue identification</td></tr>
            <tr><td><code>zen-architect</code></td><td>System design emphasizing simplicity</td></tr>
            <tr><td><code>researcher</code></td><td>Research and information synthesis</td></tr>
            <tr><td><code>modular-builder</code></td><td>Code implementation and creation</td></tr>
          </tbody>
        </table>

        <h3>Using Agents</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Interactive mode - use @ prefix
amplifier> @explorer What is the architecture of this project?
amplifier> @bug-hunter Find issues in the authentication module

# List and show agents
amplifier agents list
amplifier agents show explorer</code></pre>
        </div>

        <h3>How Agents Work</h3>
        <ol class="agent-flow">
          <li>Create sub-session inheriting base settings</li>
          <li>Apply agent-specific tools and instructions</li>
          <li>Execute the request</li>
          <li>Return results to main session</li>
        </ol>

        <h3>Custom Agents</h3>
        <p>Define in profile's <code>agents</code> section or create standalone files in <code>.amplifier/agents/</code></p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">agents:
  my-agent:
    description: Custom agent for specific task
    tools:
      - tool-filesystem
      - tool-bash
    system: |
      You are an expert at...</code></pre>
        </div>

        <h3>Agent Search Path</h3>
        <p>Agents load from: current profile â†’ <code>.amplifier/agents/</code> (project) â†’ <code>~/.amplifier/agents/</code> (user) â†’ installed collections â†’ bundled agents</p>
      </div>
    </section>

    <!-- CLI SECTION -->
    <section id="section-cli" class="section">
      <h1>CLI Reference</h1>
      <p class="section-desc">Complete reference for all Amplifier command-line commands.</p>

      <div class="info-box" style="border-left: 4px solid var(--green); margin-bottom: 24px;">
        <strong>ðŸ“š Full CLI Documentation</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">For comprehensive CLI usage including profiles, agents, and sessions, see the <a href="https://microsoft.github.io/amplifier-docs/user-guide/" target="_blank">official User Guide</a>.</p>
      </div>

      <h3>Global Options</h3>
      <table class="ref-table">
        <thead><tr><th>Option</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td><code>--version</code></td><td>Show version and exit</td></tr>
          <tr><td><code>--help</code></td><td>Show help and exit</td></tr>
          <tr><td><code>--install-completion</code></td><td>Install shell completion</td></tr>
          <tr><td><code>--show-completion</code></td><td>Show shell completion script</td></tr>
        </tbody>
      </table>

      <div class="cli-groups">
        <div class="cli-group">
          <h3>Running</h3>
          <div class="cli-item"><code>amplifier</code><span>Interactive chat mode</span></div>
          <div class="cli-item"><code>amplifier run "prompt"</code><span>Single command execution</span></div>
          <div class="cli-item"><code>amplifier run --profile name</code><span>Run with specific profile</span></div>
          <div class="cli-item"><code>amplifier run -m model</code><span>Override model</span></div>
          <div class="cli-item"><code>amplifier run --max-tokens N</code><span>Max response tokens</span></div>
          <div class="cli-item"><code>amplifier run --output-format json</code><span>Output format (text/json/json-trace)</span></div>
          <div class="cli-item"><code>amplifier run --no-tools</code><span>Disable tool use</span></div>
          <div class="cli-item"><code>amplifier run --resume [id]</code><span>Resume session by ID</span></div>
          <div class="cli-item"><code>amplifier continue</code><span>Resume last session</span></div>
          <div class="cli-item"><code>amplifier continue "follow-up"</code><span>Resume with new prompt</span></div>
        </div>
        <div class="cli-group">
          <h3>Sessions</h3>
          <div class="cli-item"><code>amplifier session list</code><span>Display all sessions</span></div>
          <div class="cli-item"><code>amplifier session list --all</code><span>Show all sessions</span></div>
          <div class="cli-item"><code>amplifier session show [id]</code><span>View session details</span></div>
          <div class="cli-item"><code>amplifier session resume [id]</code><span>Resume specific session</span></div>
          <div class="cli-item"><code>amplifier session delete [id]</code><span>Remove a session</span></div>
          <div class="cli-item"><code>amplifier session cleanup --days 7</code><span>Delete old sessions</span></div>
        </div>
        <div class="cli-group">
          <h3>Profiles</h3>
          <div class="cli-item"><code>amplifier profile list</code><span>View all profiles</span></div>
          <div class="cli-item"><code>amplifier profile use dev</code><span>Set as default</span></div>
          <div class="cli-item"><code>amplifier profile show name</code><span>Display configuration</span></div>
          <div class="cli-item"><code>amplifier profile show --resolved</code><span>Show full resolved profile</span></div>
          <div class="cli-item"><code>amplifier profile current</code><span>Check active profile</span></div>
          <div class="cli-item"><code>amplifier profile default [name]</code><span>Show/set default profile</span></div>
          <div class="cli-item"><code>amplifier profile reset</code><span>Reset to defaults</span></div>
        </div>
        <div class="cli-group">
          <h3>Providers</h3>
          <div class="cli-item"><code>amplifier provider list</code><span>List available providers</span></div>
          <div class="cli-item"><code>amplifier provider use anthropic</code><span>Set default provider</span></div>
          <div class="cli-item"><code>amplifier provider current</code><span>Show current provider</span></div>
          <div class="cli-item"><code>amplifier provider reset</code><span>Reset to default provider</span></div>
        </div>
        <div class="cli-group">
          <h3>Modules</h3>
          <div class="cli-item"><code>amplifier module list</code><span>Display installed modules</span></div>
          <div class="cli-item"><code>amplifier module list --type tool</code><span>Filter by type</span></div>
          <div class="cli-item"><code>amplifier module show [name]</code><span>View module details</span></div>
          <div class="cli-item"><code>amplifier module add tool-web</code><span>Add a module</span></div>
          <div class="cli-item"><code>amplifier module add --source [url]</code><span>Add from source</span></div>
          <div class="cli-item"><code>amplifier module remove [name]</code><span>Remove a module</span></div>
          <div class="cli-item"><code>amplifier module check-updates</code><span>Check for updates</span></div>
          <div class="cli-item"><code>amplifier module refresh</code><span>Refresh cache</span></div>
        </div>
        <div class="cli-group">
          <h3>Tools</h3>
          <div class="cli-item"><code>amplifier tool list</code><span>List available tools</span></div>
          <div class="cli-item"><code>amplifier tool info [name]</code><span>Show tool details</span></div>
          <div class="cli-item"><code>amplifier tool invoke [name]</code><span>Test tool directly</span></div>
        </div>
        <div class="cli-group">
          <h3>Agents</h3>
          <div class="cli-item"><code>amplifier agents list</code><span>List available agents</span></div>
          <div class="cli-item"><code>amplifier agents show [name]</code><span>View agent details</span></div>
        </div>
        <div class="cli-group">
          <h3>Collections</h3>
          <div class="cli-item"><code>amplifier collection list</code><span>List installed collections</span></div>
          <div class="cli-item"><code>amplifier collection add [url]</code><span>Add from Git</span></div>
          <div class="cli-item"><code>amplifier collection show [name]</code><span>Show collection details</span></div>
          <div class="cli-item"><code>amplifier collection remove [name]</code><span>Remove collection</span></div>
          <div class="cli-item"><code>amplifier collection refresh</code><span>Refresh cache</span></div>
        </div>
        <div class="cli-group">
          <h3>Sources (Dev)</h3>
          <div class="cli-item"><code>amplifier source list</code><span>List source overrides</span></div>
          <div class="cli-item"><code>amplifier source add [name] [path]</code><span>Add local override</span></div>
          <div class="cli-item"><code>amplifier source remove [name]</code><span>Remove override</span></div>
          <div class="cli-item"><code>amplifier source show [name]</code><span>Show source details</span></div>
        </div>
        <div class="cli-group">
          <h3>System</h3>
          <div class="cli-item"><code>amplifier update</code><span>Update Amplifier</span></div>
          <div class="cli-item"><code>amplifier update --cli</code><span>Update CLI only</span></div>
          <div class="cli-item"><code>amplifier update --modules</code><span>Update modules only</span></div>
          <div class="cli-item"><code>amplifier init</code><span>Initialize configuration</span></div>
          <div class="cli-item"><code>amplifier --help</code><span>General help</span></div>
        </div>
      </div>

      <h3>Interactive Commands</h3>
      <p>While in interactive mode, use these slash commands:</p>
      <div class="cli-groups">
        <div class="cli-group">
          <div class="cli-item"><code>/help</code><span>Display available commands</span></div>
          <div class="cli-item"><code>/tools</code><span>List accessible tools</span></div>
          <div class="cli-item"><code>/agents</code><span>List available agents</span></div>
          <div class="cli-item"><code>/status</code><span>Show session information</span></div>
          <div class="cli-item"><code>/think</code><span>Enable planning mode</span></div>
          <div class="cli-item"><code>/clear</code><span>Clear conversation history</span></div>
          <div class="cli-item"><code>/quit</code>, <code>/exit</code><span>Exit the application</span></div>
        </div>
      </div>

      <h3>Using Agents &amp; Mentions</h3>
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">bash</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code class="language-bash"># Use agents with @ prefix
amplifier> @explorer Analyze this codebase
amplifier> @bug-hunter Find issues in main.py

# Reference files with @mentions
amplifier> Review @src/main.py for issues
amplifier> @project:context/standards.md Apply these standards
amplifier> @collection:foundation/context/philosophy.md</code></pre>
      </div>

      <h3>Output Formats</h3>
      <p>Use <code>--output-format</code> for automation:</p>
      <table class="ref-table">
        <thead><tr><th>Format</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td><code>text</code></td><td>Human-readable markdown (default)</td></tr>
          <tr><td><code>json</code></td><td>Structured JSON for scripting</td></tr>
          <tr><td><code>json-trace</code></td><td>Complete execution trace with tool calls</td></tr>
        </tbody>
      </table>

      <h3>Environment Variables</h3>
      <table class="ref-table">
        <thead><tr><th>Variable</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td><code>ANTHROPIC_API_KEY</code></td><td>Anthropic API key</td></tr>
          <tr><td><code>OPENAI_API_KEY</code></td><td>OpenAI API key</td></tr>
          <tr><td><code>AZURE_OPENAI_API_KEY</code></td><td>Azure OpenAI API key</td></tr>
          <tr><td><code>AZURE_OPENAI_ENDPOINT</code></td><td>Azure OpenAI endpoint</td></tr>
          <tr><td><code>AMPLIFIER_PROFILE</code></td><td>Default profile</td></tr>
          <tr><td><code>AMPLIFIER_PROVIDER</code></td><td>Default provider</td></tr>
          <tr><td><code>AMPLIFIER_DEBUG</code></td><td>Enable debug logging</td></tr>
        </tbody>
      </table>

      <h3>Configuration Files</h3>
      <table class="ref-table">
        <thead><tr><th>File</th><th>Scope</th><th>Purpose</th></tr></thead>
        <tbody>
          <tr><td><code>~/.amplifier/settings.yaml</code></td><td>User</td><td>Global user settings</td></tr>
          <tr><td><code>.amplifier/settings.yaml</code></td><td>Project</td><td>Project settings (committed)</td></tr>
          <tr><td><code>.amplifier/settings.local.yaml</code></td><td>Local</td><td>Machine-local (gitignored)</td></tr>
        </tbody>
      </table>

      <div class="info-box">
        <strong>Tips</strong>
        <ul>
          <li>Pipe input: <code>cat file.py | amplifier run "Explain"</code></li>
          <li>JSON output for scripting: <code>amplifier run -o json "What is 2+2?"</code></li>
          <li>Verbose output: <code>-v</code> or <code>--verbose</code></li>
          <li>Use agents with @ prefix: <code>@explorer What is the architecture?</code></li>
        </ul>
      </div>
    </section>

    <!-- ECOSYSTEM SECTION -->
    <section id="section-ecosystem" class="section">
      <h1>Ecosystem</h1>
      <p class="section-desc">Available modules, libraries, and collections for extending Amplifier.</p>

      <div class="info-box" style="border-left: 4px solid var(--blue); margin-bottom: 24px;">
        <strong>ðŸ“š Complete Ecosystem Reference</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">For detailed information on all available modules including Providers, Tools, Orchestrators, Contexts, and Hooks, see the <a href="https://microsoft.github.io/amplifier-docs/ecosystem/modules/" target="_blank">official Ecosystem documentation</a>.</p>
      </div>

      <h2 id="runtime-modules">Runtime Modules</h2>
      <p>Swappable components that implement Amplifier's core contracts.</p>

      <div class="ecosystem-grid">
        <div class="ecosystem-category">
          <h3>ðŸ¤– Providers <span class="count">7</span></h3>
          <p>Connect to AI model providers</p>
          <ul>
            <li><a href="https://github.com/microsoft/amplifier-module-provider-anthropic" target="_blank"><code>provider-anthropic</code></a> - Claude models</li>
            <li><a href="https://github.com/microsoft/amplifier-module-provider-openai" target="_blank"><code>provider-openai</code></a> - GPT models</li>
            <li><a href="https://github.com/microsoft/amplifier-module-provider-gemini" target="_blank"><code>provider-gemini</code></a> - Gemini (1M context)</li>
            <li><a href="https://github.com/microsoft/amplifier-module-provider-azure" target="_blank"><code>provider-azure</code></a> - Azure OpenAI</li>
            <li><a href="https://github.com/microsoft/amplifier-module-provider-ollama" target="_blank"><code>provider-ollama</code></a> - Local models</li>
            <li><a href="https://github.com/microsoft/amplifier-module-provider-vllm" target="_blank"><code>provider-vllm</code></a> - vLLM server</li>
            <li><a href="https://github.com/microsoft/amplifier-module-provider-mock" target="_blank"><code>provider-mock</code></a> - Testing</li>
          </ul>
        </div>

        <div class="ecosystem-category">
          <h3>ðŸ”§ Tools <span class="count">6</span></h3>
          <p>Extend agent capabilities</p>
          <ul>
            <li><a href="https://github.com/microsoft/amplifier-module-tool-filesystem" target="_blank"><code>tool-filesystem</code></a> - Read/write files</li>
            <li><a href="https://github.com/microsoft/amplifier-module-tool-bash" target="_blank"><code>tool-bash</code></a> - Shell commands</li>
            <li><a href="https://github.com/microsoft/amplifier-module-tool-web" target="_blank"><code>tool-web</code></a> - Web browsing</li>
            <li><a href="https://github.com/microsoft/amplifier-module-tool-search" target="_blank"><code>tool-search</code></a> - Code search</li>
            <li><a href="https://github.com/microsoft/amplifier-module-tool-task" target="_blank"><code>tool-task</code></a> - Task delegation</li>
            <li><a href="https://github.com/microsoft/amplifier-module-tool-todo" target="_blank"><code>tool-todo</code></a> - Todo management</li>
          </ul>
        </div>

        <div class="ecosystem-category">
          <h3>ðŸ”„ Orchestrators <span class="count">3</span></h3>
          <p>Control execution loops</p>
          <ul>
            <li><a href="https://github.com/microsoft/amplifier-module-orchestrator-loop-basic" target="_blank"><code>loop-basic</code></a> - Simple request/response</li>
            <li><a href="https://github.com/microsoft/amplifier-module-orchestrator-loop-streaming" target="_blank"><code>loop-streaming</code></a> - Streaming responses</li>
            <li><a href="https://github.com/microsoft/amplifier-module-orchestrator-loop-events" target="_blank"><code>loop-event</code></a> - Event-driven execution</li>
          </ul>
        </div>

        <div class="ecosystem-category">
          <h3>ðŸ’¾ Contexts <span class="count">2</span></h3>
          <p>Manage conversation state</p>
          <ul>
            <li><a href="https://github.com/microsoft/amplifier-module-context-simple" target="_blank"><code>context-simple</code></a> - In-memory storage</li>
            <li><a href="https://github.com/microsoft/amplifier-module-context-persistent" target="_blank"><code>context-persistent</code></a> - Disk persistence</li>
          </ul>
        </div>

        <div class="ecosystem-category">
          <h3>âš¡ Hooks <span class="count">9</span></h3>
          <p>Observe and control behavior</p>
          <ul>
            <li><a href="https://github.com/microsoft/amplifier-module-hook-logging" target="_blank"><code>hooks-logging</code></a> - Event logging</li>
            <li><a href="https://github.com/microsoft/amplifier-module-hook-approval" target="_blank"><code>hooks-approval</code></a> - User approval gates</li>
            <li><a href="https://github.com/microsoft/amplifier-module-hook-redaction" target="_blank"><code>hooks-redaction</code></a> - Sensitive data filtering</li>
            <li><code>hooks-backup</code> - Session backup</li>
            <li><code>hooks-streaming-ui</code> - Streaming display</li>
            <li><code>hooks-scheduler</code> - Rate limiting</li>
            <li>+ 3 more...</li>
          </ul>
        </div>
      </div>

      <h2 id="libraries">Libraries</h2>
      <p>Consumed by applications (not runtime modules).</p>

      <table class="ref-table">
        <thead>
          <tr><th>Library</th><th>Purpose</th><th>Repository</th></tr>
        </thead>
        <tbody>
          <tr><td><code>amplifier-profiles</code></td><td>Profile and agent loading with inheritance</td><td><a href="https://github.com/microsoft/amplifier-profiles" target="_blank">GitHub</a></td></tr>
          <tr><td><code>amplifier-collections</code></td><td>Collection discovery and management</td><td><a href="https://github.com/microsoft/amplifier-collections" target="_blank">GitHub</a></td></tr>
          <tr><td><code>amplifier-config</code></td><td>Three-scope configuration management</td><td><a href="https://github.com/microsoft/amplifier-config" target="_blank">GitHub</a></td></tr>
          <tr><td><code>amplifier-module-resolution</code></td><td>Module source resolution</td><td><a href="https://github.com/microsoft/amplifier-module-resolution" target="_blank">GitHub</a></td></tr>
        </tbody>
      </table>

      <h2 id="collections">Collections</h2>
      <p>Shareable bundles of profiles, agents, and modules.</p>

      <div class="collections-grid">
        <a href="https://github.com/microsoft/amplifier-collection-toolkit" target="_blank" class="collection-item collection-link">
          <strong>Toolkit</strong>
          <span>Essential development tools</span>
        </a>
        <a href="https://github.com/microsoft/amplifier-collection-design-intelligence" target="_blank" class="collection-item collection-link">
          <strong>Design Intelligence</strong>
          <span>Architecture and design agents</span>
        </a>
        <a href="https://github.com/microsoft/amplifier-collection-recipes" target="_blank" class="collection-item collection-link">
          <strong>Recipes</strong>
          <span>Common patterns and workflows</span>
        </a>
        <a href="https://github.com/microsoft/amplifier-collection-issues" target="_blank" class="collection-item collection-link">
          <strong>Issues</strong>
          <span>Issue tracking integration</span>
        </a>
        <a href="https://github.com/momuno/amplifier-collection-convergent-dev" target="_blank" class="collection-item collection-link">
          <strong>Convergent Dev</strong>
          <span>Ideation â†’ sprints â†’ TDD workflow</span>
        </a>
      </div>

      <h3>Community Collections</h3>
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">bash</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code class="language-bash"># Install convergent-dev collection
amplifier collection add git+https://github.com/momuno/amplifier-collection-convergent-dev@main

# Activate the profile
amplifier profile use convergent-dev:convergent-dev</code></pre>
      </div>

      <div class="info-box">
        <strong>Module Architecture</strong>
        <ul>
          <li>Runtime modules only depend on <code>amplifier-core</code></li>
          <li>Libraries are consumed by applications, never by modules</li>
          <li>Use <code>amplifier module list</code> to see installed modules</li>
          <li>Use <code>amplifier module show [name]</code> for details</li>
        </ul>
      </div>
    </section>

    <!-- SHOWCASE SECTION -->
    <section id="section-showcase" class="section">
      <h1>Showcase</h1>
      <p class="section-desc">Applications and modules built with Amplifier by the community.</p>

      <div class="callout callout-danger">
        <p><strong>âš ï¸ Security Notice:</strong> Community applications and modules execute arbitrary code with full system access. <strong>Only use from sources you trust.</strong> Review code before installation.</p>
      </div>

      <h2>Community Applications</h2>
      <table class="ref-table">
        <thead>
          <tr><th>Application</th><th>Description</th><th>Author</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-app-transcribe" target="_blank"><code>app-transcribe</code></a></td>
            <td>Transform YouTube videos and audio files into searchable transcripts with AI-powered insights</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-app-blog-creator" target="_blank"><code>app-blog-creator</code></a></td>
            <td>AI-powered blog creation with style-aware generation and rich markdown editor</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-app-voice" target="_blank"><code>app-voice</code></a></td>
            <td>Desktop voice assistant with native speech-to-speech via OpenAI Realtime API</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/samueljklee/amplifier-app-tool-generator" target="_blank"><code>app-tool-generator</code></a></td>
            <td>AI-powered tool generator for creating custom Amplifier tools</td>
            <td>@samueljklee</td>
          </tr>
          <tr>
            <td><a href="https://github.com/DavidKoleczek/amplifier-app-benchmarks" target="_blank"><code>app-benchmarks</code></a></td>
            <td>Benchmarking and evaluation suite for Amplifier</td>
            <td>@DavidKoleczek</td>
          </tr>
          <tr>
            <td><a href="https://github.com/microsoft/amplifier-app-log-viewer" target="_blank"><code>app-log-viewer</code></a></td>
            <td>Web-based debugging interface with real-time LLM interaction visualization</td>
            <td>@microsoft</td>
          </tr>
          <tr>
            <td><a href="https://github.com/microsoft/amplifier-lakehouse" target="_blank"><code>amplifier-lakehouse</code></a></td>
            <td>Data integration daemon and web application for Amplifier</td>
            <td>@microsoft</td>
          </tr>
          <tr>
            <td><a href="https://github.com/microsoft/amplifier-playground" target="_blank"><code>amplifier-playground</code></a></td>
            <td>Interactive environment for building, configuring, and testing Amplifier sessions</td>
            <td>@microsoft</td>
          </tr>
        </tbody>
      </table>

      <h2>Community Modules</h2>

      <h3>Providers</h3>
      <table class="ref-table">
        <thead>
          <tr><th>Module</th><th>Description</th><th>Author</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><a href="https://github.com/brycecutt-msft/amplifier-module-provider-bedrock" target="_blank"><code>provider-bedrock</code></a></td>
            <td>AWS Bedrock integration with cross-region inference support for Claude models</td>
            <td>@brycecutt-msft</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-module-provider-openai-realtime" target="_blank"><code>provider-openai-realtime</code></a></td>
            <td>OpenAI Realtime API for native speech-to-speech with ultra-low latency</td>
            <td>@robotdad</td>
          </tr>
        </tbody>
      </table>

      <h3>Tools</h3>
      <table class="ref-table">
        <thead>
          <tr><th>Module</th><th>Description</th><th>Author</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-module-tool-mcp" target="_blank"><code>tool-mcp</code></a></td>
            <td>Model Context Protocol integration for MCP servers</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-module-tool-skills" target="_blank"><code>tool-skills</code></a></td>
            <td>Load domain knowledge with progressive disclosure</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-module-tool-youtube-dl" target="_blank"><code>tool-youtube-dl</code></a></td>
            <td>Download audio/video from YouTube with metadata extraction</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-module-tool-whisper" target="_blank"><code>tool-whisper</code></a></td>
            <td>Speech-to-text transcription using OpenAI Whisper</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-module-image-generation" target="_blank"><code>module-image-generation</code></a></td>
            <td>Multi-provider AI image generation (DALL-E, Imagen, GPT-Image-1)</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-module-style-extraction" target="_blank"><code>module-style-extraction</code></a></td>
            <td>Extract and apply writing styles from text samples</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-module-markdown-utils" target="_blank"><code>module-markdown-utils</code></a></td>
            <td>Markdown parsing, injection, and metadata utilities</td>
            <td>@robotdad</td>
          </tr>
        </tbody>
      </table>

      <h3>Collections</h3>
      <table class="ref-table">
        <thead>
          <tr><th>Collection</th><th>Description</th><th>Author</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-collection-ddd" target="_blank"><code>collection-ddd</code></a></td>
            <td>Document-Driven Development with 5 specialized workflow agents</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/robotdad/amplifier-collection-spec-kit" target="_blank"><code>collection-spec-kit</code></a></td>
            <td>Specification-Driven Development with 8 agents and constitutional governance</td>
            <td>@robotdad</td>
          </tr>
          <tr>
            <td><a href="https://github.com/momuno/amplifier-collection-convergent-dev" target="_blank"><code>collection-convergent-dev</code></a></td>
            <td>Ideation â†’ sprints â†’ TDD workflow</td>
            <td>@momuno</td>
          </tr>
        </tbody>
      </table>

      <h2>Official Collections</h2>
      <table class="ref-table">
        <thead>
          <tr><th>Collection</th><th>Description</th><th>Repository</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><code>toolkit</code></td>
            <td>Building sophisticated CLI tools using metacognitive recipes</td>
            <td><a href="https://github.com/microsoft/amplifier-collection-toolkit" target="_blank">GitHub</a></td>
          </tr>
          <tr>
            <td><code>design-intelligence</code></td>
            <td>Comprehensive design intelligence with specialized agents</td>
            <td><a href="https://github.com/microsoft/amplifier-collection-design-intelligence" target="_blank">GitHub</a></td>
          </tr>
          <tr>
            <td><code>recipes</code></td>
            <td>Multi-step AI agent orchestration for repeatable workflows</td>
            <td><a href="https://github.com/microsoft/amplifier-collection-recipes" target="_blank">GitHub</a></td>
          </tr>
          <tr>
            <td><code>issues</code></td>
            <td>Issue management workflows</td>
            <td><a href="https://github.com/microsoft/amplifier-collection-issues" target="_blank">GitHub</a></td>
          </tr>
        </tbody>
      </table>

      <h2>Submit Your Project</h2>
      <p>Built something with Amplifier? Share it with the community!</p>
      <ol>
        <li><strong>Build your project</strong> - Follow Amplifier conventions</li>
        <li><strong>Publish to GitHub</strong> - Make code publicly reviewable</li>
        <li><strong>Test thoroughly</strong> - Ensure compatibility with current Amplifier versions</li>
        <li><strong>Submit a PR</strong> - Add to the <a href="https://github.com/microsoft/amplifier/blob/next/docs/MODULES.md" target="_blank">MODULES.md catalog</a></li>
      </ol>
    </section>

    <!-- EXAMPLES SECTION -->
    <section id="section-examples" class="section">
      <h1>Examples</h1>
      <p class="section-desc">Copy-paste patterns for common Amplifier use cases.</p>

      <div class="examples-tabs" id="examples-tabs">
        <button class="examples-tab active" data-tab="hooks">âš¡ Hooks</button>
        <button class="examples-tab" data-tab="tools">ðŸ”§ Tools</button>
        <button class="examples-tab" data-tab="config">âš™ï¸ Configuration</button>
        <button class="examples-tab" data-tab="recipes">ðŸ“– Recipes</button>
      </div>

      <!-- Hooks Examples -->
      <div id="ex-hooks" class="examples-content active">
        <div class="examples-grid">
          <div class="example-card">
            <div class="example-card-header">
              <h3>Approval Gate</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Require user approval before executing sensitive operations like shell commands.</p>
            <pre><code class="language-python">async def approval_gate(event, data) -> HookResult:
    """Pause for user approval on bash commands."""
    if event == "tool:pre" and data["tool_name"] == "bash":
        return HookResult(
            action="ask_user",
            approval_prompt=f"Allow bash: {data['tool_input']}?",
            approval_options=["Allow", "Deny"]
        )
    return HookResult(action="continue")</code></pre>
            <div class="example-card-output">
              <span class="output-label">Usage</span>
              <pre>hooks:
  - handler: approval_gate
    events: ["tool:pre"]</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>Security Guard</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Block dangerous shell commands before they execute. Returns deny action with reason.</p>
            <pre><code class="language-python">from amplifier_core.models import HookResult

async def security_hook(event: str, data: dict) -> HookResult:
    """Block dangerous bash commands."""
    if event == "tool:pre" and data.get("tool_name") == "bash":
        cmd = str(data.get("tool_input", {}))
        dangerous = ["rm -rf", "mkfs", "dd if=", "> /dev/"]

        for pattern in dangerous:
            if pattern in cmd:
                return HookResult(
                    action="deny",
                    reason=f"Blocked dangerous pattern: {pattern}"
                )

    return HookResult(action="continue")</code></pre>
            <div class="example-card-output">
              <span class="output-label">Output</span>
              <pre>Action: deny
Reason: Blocked dangerous pattern: rm -rf</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>Token Tracker</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Monitor and log token usage across all provider calls for cost tracking.</p>
            <pre><code class="language-python">async def track_tokens(event, data) -> HookResult:
    """Log token usage from provider responses."""
    if event == "provider:response":
        usage = data.get("usage", {})
        tokens = usage.get("total_tokens", 0)
        cost = tokens * 0.00001  # Example pricing
        print(f"Used {tokens} tokens (~\${cost:.4f})")
    return HookResult(action="continue")</code></pre>
            <div class="example-card-output">
              <span class="output-label">Output</span>
              <pre>Used 1523 tokens (~$0.0152)</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>PII Redaction</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Automatically detect and redact sensitive information from streamed responses.</p>
            <pre><code class="language-python">import re
from amplifier_core.models import HookResult

PATTERNS = {
    "email": r'[\w.-]+@[\w.-]+\.[a-z]{2,}',
    "ssn": r'\d{3}-\d{2}-\d{4}',
    "phone": r'\d{3}[-.\s]?\d{3}[-.\s]?\d{4}'
}

async def redact_pii(event, data) -> HookResult:
    """Redact PII from streaming content."""
    if event == "content_block:delta":
        content = data.get("delta", "")
        for name, pattern in PATTERNS.items():
            content = re.sub(pattern, f"[{name.upper()}_REDACTED]", content)
        return HookResult(action="modify", data={"delta": content})
    return HookResult(action="continue")</code></pre>
            <div class="example-card-output">
              <span class="output-label">Output</span>
              <pre>Input:  "Contact john@email.com or 555-123-4567"
Output: "Contact [EMAIL_REDACTED] or [PHONE_REDACTED]"</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Tools Examples -->
      <div id="ex-tools" class="examples-content">
        <div class="examples-grid">
          <div class="example-card">
            <div class="example-card-header">
              <h3>Custom Tool</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Implement a tool using the Protocol pattern - duck typing, no inheritance required.</p>
            <pre><code class="language-python">from amplifier_core.models import ToolResult

class WeatherTool:
    """A simple weather lookup tool."""

    @property
    def name(self) -> str:
        return "weather"

    @property
    def description(self) -> str:
        return "Get current weather for a city"

    async def execute(self, input: dict) -> ToolResult:
        city = input.get("city", "Unknown")
        # Your API call here
        return ToolResult(
            output=f"Weather in {city}: 72Â°F, Sunny"
        )

# Mount function for module discovery
async def mount(coordinator, config):
    await coordinator.mount("tools", WeatherTool(), name="weather")
    return lambda: None  # cleanup function</code></pre>
            <div class="example-card-output">
              <span class="output-label">pyproject.toml</span>
              <pre>[project.entry-points."amplifier.modules"]
weather-tool = "my_package.weather:mount"</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>ToolResult: Success</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Return successful execution results. The LLM sees this output and can act on it.</p>
            <pre><code class="language-python">from amplifier_core.models import ToolResult

# Simple success
result = ToolResult(output="File created: /tmp/example.txt")

# Structured success with details
result = ToolResult(
    output="""Created: /tmp/report.csv
Rows: 1,523
Size: 45.2 KB
Columns: id, name, email, created_at"""
)</code></pre>
            <div class="example-card-output">
              <span class="output-label">Output</span>
              <pre>Created: /tmp/report.csv
Rows: 1,523
Size: 45.2 KB</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>ToolResult: Error</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Communicate failures so the LLM can try a different approach or ask for help.</p>
            <pre><code class="language-python">from amplifier_core.models import ToolResult

# Error with clear message
result = ToolResult(
    output="",
    error="Permission denied: /etc/passwd is read-only"
)

# Error with partial output
result = ToolResult(
    output="Processed 50 of 100 files",
    error="Disk full - operation incomplete"
)</code></pre>
            <div class="example-card-output">
              <span class="output-label">Output</span>
              <pre>Error: Permission denied: /etc/passwd is read-only</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Config Examples -->
      <div id="ex-config" class="examples-content">
        <div class="examples-grid">
          <div class="example-card">
            <div class="example-card-header">
              <h3>Session Configuration</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">The mount plan structure that configures an Amplifier session with all components.</p>
            <pre><code class="language-python">from amplifier_core import AmplifierSession

config = {
    "session": {
        "orchestrator": "loop-basic",
        "context": "context-simple"
    },
    "providers": [
        {"module": "provider-anthropic"}
    ],
    "tools": [
        {"module": "tool-filesystem"},
        {"module": "tool-bash"}
    ],
    "hooks": [
        {"module": "hooks-logging"},
        {"handler": "my_security_hook"}
    ]
}

async with AmplifierSession(config) as session:
    response = await session.execute("Your prompt here")</code></pre>
            <div class="example-card-output">
              <span class="output-label">CLI Usage</span>
              <pre>amplifier run --profile my_config "Hello!"</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>Multi-Provider Fallback</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Configure provider priority for automatic failover between LLM backends.</p>
            <pre><code class="language-yaml"># profile.yaml - Provider failover chain
providers:
  - module: provider-anthropic
    priority: 1      # Primary - Claude
    config:
      model: claude-sonnet-4-20250514

  - module: provider-openai
    priority: 2      # First fallback - GPT-4
    config:
      model: gpt-4o

  - module: provider-ollama
    priority: 3      # Local fallback
    config:
      model: llama3.1</code></pre>
            <div class="example-card-output">
              <span class="output-label">Behavior</span>
              <pre>1. Try Anthropic (primary)
2. On error â†’ Try OpenAI
3. On error â†’ Try Ollama (local)</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Recipes Examples -->
      <div id="ex-recipes" class="examples-content">
        <div class="examples-grid">
          <div class="example-card">
            <div class="example-card-header">
              <h3>Chat Agent with Memory</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Build a conversational agent that maintains context across multiple turns.</p>
            <pre><code class="language-python">from amplifier_core import AmplifierSession

async def chat_loop():
    config = {
        "session": {
            "orchestrator": "loop-basic",
            "context": "context-simple"
        },
        "providers": [{"module": "provider-anthropic"}],
        "tools": [{"module": "tool-bash"}, {"module": "tool-filesystem"}]
    }

    async with AmplifierSession(config) as session:
        print("Chat started. Type 'quit' to exit.")
        while True:
            user_input = input("You: ")
            if user_input.lower() == 'quit':
                break

            # Context is automatically maintained
            response = await session.execute(user_input)
            print(f"Agent: {response}")</code></pre>
            <div class="example-card-output">
              <span class="output-label">Output</span>
              <pre>You: What files are in the current directory?
Agent: I'll check that for you...
[Lists files]
You: Create a summary of the largest one
Agent: Looking at the largest file...</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>Real-time Cost Tracking</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Monitor API costs in real-time with budget alerts and automatic cutoffs.</p>
            <pre><code class="language-python">from amplifier_core.models import HookResult

class CostTracker:
    PRICING = {
        "claude-sonnet-4-20250514": {"input": 0.003, "output": 0.015},
        "gpt-4o": {"input": 0.005, "output": 0.015},
    }

    def __init__(self, budget: float = 10.0):
        self.budget = budget
        self.spent = 0.0

    def track(self, model: str, input_tokens: int, output_tokens: int):
        rates = self.PRICING.get(model, {"input": 0.01, "output": 0.03})
        cost = (input_tokens * rates["input"] +
                output_tokens * rates["output"]) / 1000
        self.spent += cost
        return cost

tracker = CostTracker(budget=5.0)

async def cost_hook(event, data) -> HookResult:
    if event == "provider:response":
        usage = data.get("usage", {})
        cost = tracker.track(
            data.get("model", "unknown"),
            usage.get("input_tokens", 0),
            usage.get("output_tokens", 0)
        )
        print(f"Cost: \${cost:.4f} | Total: \${tracker.spent:.2f}")

        if tracker.spent >= tracker.budget:
            return HookResult(action="deny", reason="Budget exhausted")

    return HookResult(action="continue")</code></pre>
            <div class="example-card-output">
              <span class="output-label">Output</span>
              <pre>Cost: $0.0234 | Total: $4.89/$5.00
Cost: $0.0156 | Total: $5.05/$5.00
Action: deny - Budget exhausted</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>Complete Audit Trail</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Log every agent action to file for compliance and debugging.</p>
            <pre><code class="language-python">import json
from datetime import datetime
from pathlib import Path
from amplifier_core.models import HookResult

class AuditLogger:
    def __init__(self, log_dir: str = "./logs"):
        self.log_dir = Path(log_dir)
        self.log_dir.mkdir(exist_ok=True)
        self.session_id = datetime.now().strftime("%Y%m%d_%H%M%S")
        self.log_file = self.log_dir / f"session_{self.session_id}.jsonl"

    def log(self, event: str, data: dict):
        entry = {
            "timestamp": datetime.now().isoformat(),
            "event": event,
            "data": {k: str(v)[:500] for k, v in data.items()}
        }
        with open(self.log_file, "a") as f:
            f.write(json.dumps(entry) + "\n")

audit = AuditLogger()

async def audit_hook(event, data) -> HookResult:
    if not event.startswith("content_block:"):
        audit.log(event, data)
    return HookResult(action="continue")</code></pre>
            <div class="example-card-output">
              <span class="output-label">Output</span>
              <pre># Creates: logs/session_20250115_143052.jsonl
{"timestamp": "2025-01-15T14:30:52", "event": "tool:pre", ...}</pre>
            </div>
          </div>

          <div class="example-card">
            <div class="example-card-header">
              <h3>Collection Migration Pattern</h3>
              <button class="copy-btn" onclick="copyExampleCode(this)">Copy</button>
            </div>
            <p class="example-card-desc">Use Amplifier to analyze existing tools/agents and migrate them to a collection structure.</p>
            <pre><code class="language-bash"># Point Amplifier at your project and the official docs
amplifier run "Analyze my project structure in ./my-tools
and compare it to the collection format in
github.com/microsoft/amplifier/docs/MODULES.md

Help me understand:
1. Which of my tools map to Amplifier modules?
2. How should my agents be structured?
3. What goes in profiles vs context?
4. Create a migration plan to collection format."</code></pre>
            <div class="example-card-output">
              <span class="output-label">Result</span>
              <pre>my-collection/
â”œâ”€â”€ agents/           # Agent definitions
â”‚   â”œâ”€â”€ my-agent.md
â”‚   â””â”€â”€ helper-agent.md
â”œâ”€â”€ context/          # Workflow docs
â”‚   â””â”€â”€ commands/
â”œâ”€â”€ profiles/         # Configuration
â”‚   â””â”€â”€ my-profile.md
â””â”€â”€ collection.toml   # Manifest</pre>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- GUIDES SECTION -->
    <section id="section-guides" class="section">
      <h1>Architecture & Developer Guides</h1>
      <p class="section-desc">Deep-dive documentation on Amplifier's architecture boundaries, module building, and system design.</p>

      <!-- ARCHITECTURE BOUNDARIES -->
      <h2 id="boundaries-overview">Architecture Boundaries</h2>
      <p>The single most important concept for Amplifier developers: <strong>what belongs where</strong>.</p>

      <div class="info-box" style="border-left: 4px solid var(--accent); margin: 24px 0;">
        <strong>Core Insight</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">Amplifier separates <strong>mechanism</strong> (how things work) from <strong>policy</strong> (what to do). This separation is what makes modules portable across applications.</p>
      </div>

      <div class="layer-diagram">
        <div class="layer-box app-layer">
          <div class="layer-title">APPLICATION LAYER</div>
          <div class="layer-subtitle">amplifier-app-cli, amplifier-desktop, your-custom-app</div>
          <div class="layer-desc">"Policy" - What to do, how to present, where to find things</div>
        </div>
        <div class="layer-box kernel-layer">
          <div class="layer-title">KERNEL LAYER</div>
          <div class="layer-subtitle">amplifier-core (one implementation, many consumers)</div>
          <div class="layer-desc">"Mechanism" - How to coordinate, dispatch, validate</div>
        </div>
        <div class="layer-box module-layer">
          <div class="layer-title">MODULE LAYER</div>
          <div class="layer-subtitle">amplifier-module-* (many implementations, shared by apps)</div>
          <div class="layer-desc">"Capabilities" - What can be done (tools, providers, hooks)</div>
        </div>
      </div>

      <h3>Why This Matters</h3>
      <div class="concepts">
        <div class="concept">
          <h3>When boundaries are respected</h3>
          <ul>
            <li>Apps can share modules without conflict</li>
            <li>Kernel updates benefit all apps</li>
            <li>Modules work in any compliant app</li>
            <li>Testing is isolated and predictable</li>
          </ul>
        </div>
        <div class="concept">
          <h3>When boundaries are violated</h3>
          <ul>
            <li>Apps become fragile and hard to maintain</li>
            <li>Kernel bypasses create inconsistent behavior</li>
            <li>Modules only work in specific apps</li>
            <li>Bugs are hard to trace</li>
          </ul>
        </div>
      </div>

      <h3>What Belongs Where</h3>

      <h4>Application Layer Responsibilities</h4>
      <table class="ref-table">
        <thead>
          <tr><th>Responsibility</th><th>Example</th><th>Why App Layer</th></tr>
        </thead>
        <tbody>
          <tr><td>UX Systems</td><td><code>CLIApprovalSystem</code>, <code>WebSocketDisplay</code></td><td>Apps decide how to show things</td></tr>
          <tr><td>Module Resolution Policy</td><td><code>CompositeModuleResolver</code></td><td>Apps decide where to find modules</td></tr>
          <tr><td>Settings Persistence</td><td><code>~/.amplifier/settings.yaml</code></td><td>Apps decide where to store config</td></tr>
          <tr><td>Profile/Bundle Loading</td><td><code>ProfileLoader</code>, <code>load_bundle()</code></td><td>Apps decide what configurations exist</td></tr>
          <tr><td>@Mention Processing</td><td><code>MentionResolver</code></td><td>Apps decide what @mentions mean</td></tr>
          <tr><td>Capability Registration</td><td><code>session.spawn</code>, <code>broadcast</code></td><td>Apps inject their behaviors</td></tr>
        </tbody>
      </table>
      <p><strong>Key principle:</strong> If it touches the user or filesystem, it's app-layer.</p>

      <h4>Kernel Layer Responsibilities</h4>
      <table class="ref-table">
        <thead>
          <tr><th>Responsibility</th><th>Example</th><th>Why Kernel Layer</th></tr>
        </thead>
        <tbody>
          <tr><td>Session Lifecycle</td><td>create, initialize, execute, cleanup</td><td>Standard lifecycle for all apps</td></tr>
          <tr><td>Module Coordination</td><td><code>ModuleCoordinator.mount()</code></td><td>Standard way to compose modules</td></tr>
          <tr><td>Hook Dispatch</td><td><code>HookRegistry.emit()</code></td><td>Standard event ordering</td></tr>
          <tr><td>Capability Registry</td><td><code>coordinator.register_capability()</code></td><td>Standard extension point</td></tr>
          <tr><td>Config Validation</td><td>Validate mount plan structure</td><td>Standard contract enforcement</td></tr>
        </tbody>
      </table>
      <p><strong>Key principle:</strong> If it's about coordinating modules, it's kernel-layer.</p>

      <h4>Module Layer Responsibilities</h4>
      <table class="ref-table">
        <thead>
          <tr><th>Responsibility</th><th>Example</th><th>Why Module Layer</th></tr>
        </thead>
        <tbody>
          <tr><td>Tool Execution</td><td><code>tool-filesystem</code>, <code>tool-memory</code></td><td>Reusable actions</td></tr>
          <tr><td>Provider Communication</td><td><code>provider-anthropic</code></td><td>LLM API abstraction</td></tr>
          <tr><td>Hook Behavior</td><td><code>hooks-logging</code>, <code>hooks-event-broadcast</code></td><td>Reusable event handling</td></tr>
          <tr><td>Orchestration Logic</td><td><code>loop-streaming</code></td><td>Execution patterns</td></tr>
          <tr><td>Context Management</td><td><code>context-simple</code></td><td>Message storage strategies</td></tr>
        </tbody>
      </table>
      <p><strong>Key principle:</strong> If it's a reusable capability, it's module-layer.</p>

      <!-- BOUNDARY TEST -->
      <h2 id="boundary-test">The Boundary Test</h2>
      <p>Ask these questions to determine where code belongs:</p>

      <div class="boundary-test">
        <div class="boundary-question">"Does this need to know about the user interface?"</div>
        <div class="boundary-answers">
          <div class="boundary-answer yes">
            <strong>Yes â†’ Application Layer</strong>
            <span style="color: var(--text-2); font-size: 13px;">Code that knows about console, WebSocket, etc.</span>
          </div>
          <div class="boundary-answer no">
            <strong>No â†’ Kernel or Module Layer</strong>
            <span style="color: var(--text-2); font-size: 13px;">Code that just coordinates or provides capability</span>
          </div>
        </div>
      </div>

      <div class="boundary-test">
        <div class="boundary-question">"Does this define HOW to do something vs WHAT to do?"</div>
        <div class="boundary-answers">
          <div class="boundary-answer no">
            <strong>HOW (mechanism) â†’ Kernel Layer</strong>
            <span style="color: var(--text-2); font-size: 13px;">How hooks dispatch, how modules coordinate</span>
          </div>
          <div class="boundary-answer yes">
            <strong>WHAT (policy) â†’ Application Layer</strong>
            <span style="color: var(--text-2); font-size: 13px;">What hooks to load, what modules to use</span>
          </div>
        </div>
      </div>

      <div class="boundary-test">
        <div class="boundary-question">"Could another app use this unchanged?"</div>
        <div class="boundary-answers">
          <div class="boundary-answer no">
            <strong>Yes â†’ Module Layer</strong>
            <span style="color: var(--text-2); font-size: 13px;">Reusable tool, hook, or provider</span>
          </div>
          <div class="boundary-answer yes">
            <strong>No â†’ Application Layer</strong>
            <span style="color: var(--text-2); font-size: 13px;">App-specific code (e.g., WebSocket transport)</span>
          </div>
        </div>
      </div>

      <!-- CORRECT PATTERNS -->
      <h2 id="correct-patterns">Correct Patterns</h2>

      <h3>Pattern 1: Capability Injection</h3>
      <p>Apps provide transport; modules use it without knowing the details.</p>

      <div class="pattern-card correct">
        <div class="pattern-label">âœ“ CORRECT</div>
        <div class="code-block">
          <pre><code class="language-python"># APP LAYER - registers capability
async def desktop_broadcast(event: str, data: dict):
    await websocket.send_json({"type": event, **data})

session.coordinator.register_capability("broadcast", desktop_broadcast)

# MODULE LAYER - uses capability abstractly
async def on_event(event: str, data: dict):
    broadcast = coordinator.get_capability("broadcast")
    if broadcast:
        await broadcast(event, data)  # Works for any transport!</code></pre>
        </div>
      </div>

      <h3>Pattern 2: Bundle Loading</h3>
      <p>Apps load bundles; foundation resolves modules.</p>

      <div class="pattern-card correct">
        <div class="pattern-label">âœ“ CORRECT</div>
        <div class="code-block">
          <pre><code class="language-python"># APP LAYER - decides what bundle to load
bundle = await load_bundle("foundation:bundles/desktop")

# KERNEL LAYER - mounts modules to coordinator
session = await bundle.prepare().create_session()</code></pre>
        </div>
      </div>

      <h3>Pattern 3: Event Handling</h3>
      <p>Kernel dispatches; modules react; apps display.</p>

      <div class="pattern-card correct">
        <div class="pattern-label">âœ“ CORRECT</div>
        <div class="code-block">
          <pre><code class="language-python"># KERNEL LAYER - dispatches events
await hooks.emit("tool:post", {"tool": "bash", "result": output})

# MODULE LAYER - logs the event
async def on_tool_post(event, data):
    logger.info(f"Tool {data['tool']} completed")

# APP LAYER - displays to user
async def on_tool_post(event, data):
    console.print(f"âœ“ {data['tool']}")  # CLI-specific display</code></pre>
        </div>
      </div>

      <!-- ANTI-PATTERNS -->
      <h2 id="anti-patterns">Anti-Patterns to Avoid</h2>

      <h3>âŒ Kernel Bypass</h3>
      <div class="pattern-card incorrect">
        <div class="pattern-label">âœ— WRONG</div>
        <div class="code-block">
          <pre><code class="language-python"># App calling provider directly, bypassing kernel
response = await anthropic_client.messages.create(...)</code></pre>
        </div>
      </div>
      <div class="pattern-card correct">
        <div class="pattern-label">âœ“ CORRECT</div>
        <div class="code-block">
          <pre><code class="language-python"># App goes through session
result = await session.execute(prompt)</code></pre>
        </div>
      </div>

      <h3>âŒ Module with Transport Knowledge</h3>
      <div class="pattern-card incorrect">
        <div class="pattern-label">âœ— WRONG</div>
        <div class="code-block">
          <pre><code class="language-python">class MyHook:
    async def on_event(self, event, data):
        await websocket.send_json(data)  # Module shouldn't know this!</code></pre>
        </div>
      </div>
      <div class="pattern-card correct">
        <div class="pattern-label">âœ“ CORRECT</div>
        <div class="code-block">
          <pre><code class="language-python">class MyHook:
    async def on_event(self, event, data):
        broadcast = self.coordinator.get_capability("broadcast")
        if broadcast:
            await broadcast(event, data)</code></pre>
        </div>
      </div>

      <h3>âŒ App Reimplementing Kernel Logic</h3>
      <div class="pattern-card incorrect">
        <div class="pattern-label">âœ— WRONG</div>
        <div class="code-block">
          <pre><code class="language-python"># App has its own orchestrator loop
while True:
    response = await provider.complete(messages)
    if response.tool_calls:
        for call in response.tool_calls:
            result = await tools[call.name].execute(call.input)
            messages.append(...)</code></pre>
        </div>
      </div>
      <div class="pattern-card correct">
        <div class="pattern-label">âœ“ CORRECT</div>
        <div class="code-block">
          <pre><code class="language-python"># App uses session.execute()
result = await session.execute(prompt)</code></pre>
        </div>
      </div>

      <!-- MODULE BUILDER GUIDE -->
      <h2 id="module-builder">Module Builder Guide</h2>
      <p>Authoritative guide for creating Amplifier modules.</p>

      <div class="info-box" style="border-left: 4px solid var(--purple); margin: 24px 0;">
        <strong>Quick Reference</strong>
        <ul style="margin: 8px 0 0 0; color: var(--text-1);">
          <li>Git is the registry</li>
          <li>Entry-point key = Module ID (non-negotiable)</li>
          <li>Bundles compose on top of foundation</li>
          <li>CLI is optional</li>
        </ul>
      </div>

      <h3>Module Types</h3>
      <table class="ref-table">
        <thead>
          <tr><th>Type</th><th>Protocol</th><th>Mount Point</th><th>Examples</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Tool</strong></td><td><code>Tool</code></td><td>tools</td><td>filesystem, bash, web, memory</td></tr>
          <tr><td><strong>Hook</strong></td><td><code>Hook</code></td><td>hooks</td><td>logging, approval, redaction</td></tr>
          <tr><td><strong>Provider</strong></td><td><code>Provider</code></td><td>providers</td><td>anthropic, openai, azure</td></tr>
          <tr><td><strong>Orchestrator</strong></td><td><code>Orchestrator</code></td><td>orchestrator</td><td>loop-basic, loop-streaming</td></tr>
          <tr><td><strong>Context</strong></td><td><code>Context</code></td><td>context</td><td>context-simple</td></tr>
        </tbody>
      </table>

      <h3>pyproject.toml (CRITICAL)</h3>
      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code class="language-toml">[project]
name = "amplifier-module-tool-myfeature"
version = "0.1.0"
description = "My feature tool for Amplifier"
requires-python = ">=3.11"
dependencies = ["amplifier-core"]

[project.entry-points."amplifier.modules"]
# CRITICAL: Entry-point key IS the module ID
# This MUST match how users reference it in profiles/bundles
tool-myfeature = "amplifier_module_tool_myfeature:mount"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"</code></pre>
      </div>

      <div class="info-box" style="border-left: 4px solid var(--red); margin: 24px 0;">
        <strong>Non-negotiable Rules</strong>
        <ol style="margin: 8px 0 0 0; color: var(--text-1);">
          <li>Entry-point key (<code>tool-myfeature</code>) = Module ID used everywhere</li>
          <li>Value points to <code>mount</code> function, not a class</li>
          <li>Naming convention: <code>tool-*</code>, <code>hooks-*</code>, <code>provider-*</code>, <code>context-*</code></li>
        </ol>
      </div>

      <h3>The mount() Function</h3>
      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code class="language-python"># amplifier_module_tool_myfeature/__init__.py

from amplifier_core.coordinator import ModuleCoordinator
from .tools import MyFeatureTool

def mount(coordinator: ModuleCoordinator, config: dict | None = None) -> None:
    """Mount this module's tools to the coordinator.

    Args:
        coordinator: The kernel's module coordinator
        config: Optional configuration from bundle/profile
    """
    config = config or {}

    # Create tool instance with config
    tool = MyFeatureTool(
        storage_path=config.get("storage_path", "~/.amplifier/myfeature.db"),
        max_items=config.get("max_items", 1000),
    )

    # Register all tools provided by this module
    for t in tool.get_tools():
        coordinator.register_tool(t)</code></pre>
      </div>

      <h3>Common Mistakes</h3>

      <div class="pattern-card incorrect">
        <div class="pattern-label">âœ— Wrong Entry Point</div>
        <div class="code-block">
          <pre><code class="language-toml"># WRONG - points to class, not mount function
tool-myfeature = "amplifier_module_tool_myfeature:MyFeatureTool"

# CORRECT - points to mount function
tool-myfeature = "amplifier_module_tool_myfeature:mount"</code></pre>
        </div>
      </div>

      <div class="pattern-card incorrect">
        <div class="pattern-label">âœ— Missing mount() Return</div>
        <div class="code-block">
          <pre><code class="language-python"># WRONG - returns something
def mount(coordinator, config):
    return MyTool()  # Don't return!

# CORRECT - returns None, registers with coordinator
def mount(coordinator, config):
    tool = MyTool(config)
    for t in tool.get_tools():
        coordinator.register_tool(t)
    # No return statement</code></pre>
        </div>
      </div>


      <h3>Capability Injection Pattern</h3>
      <p>Modules must be <strong>transport-agnostic</strong>. They request capabilities abstractly; the app provides implementations.</p>

      <div class="pattern-card correct">
        <div class="pattern-label">âœ“ CORRECT: Request capability, app provides it</div>
        <div class="code-block">
          <pre><code class="language-python"># In module mount()
def mount(coordinator, config):
    # Request a capability by NAME, not by importing app code
    broadcast = coordinator.get_capability("broadcast")
    
    hook = MyStreamingHook(broadcast_fn=broadcast)
    coordinator.register_hook(hook)

# In app startup
def setup_session():
    # App registers the capability with its transport
    session.register_capability("broadcast", websocket_broadcast)
    # Module gets websocket_broadcast when it asks for "broadcast"</code></pre>
        </div>
      </div>

      <div class="pattern-card incorrect">
        <div class="pattern-label">âœ— WRONG: Module imports app/transport code</div>
        <div class="code-block">
          <pre><code class="language-python"># WRONG - module knows about WebSocket
from my_app.websocket import broadcast_to_clients

def mount(coordinator, config):
    hook = MyHook(broadcast_fn=broadcast_to_clients)  # Tight coupling!</code></pre>
        </div>
      </div>

      <div class="info-box" style="border-left: 4px solid var(--green); margin: 16px 0;">
        <strong>Why This Matters</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">The same module works unchanged in CLI apps (console output), web apps (WebSocket), desktop apps (IPC), or test harnesses (mock). The module never knows or cares which transport is used.</p>
      </div>

      <h3>Publishing Your Module</h3>
      <div class="info-box">
        <strong>To share with the ecosystem:</strong>
        <ol style="margin: 8px 0 0 0; color: var(--text-1);">
          <li>Create repo: <code>amplifier-module-{type}-{name}</code></li>
          <li>Add comprehensive README with usage examples</li>
          <li>Include tests</li>
          <li>Tag releases (e.g., <code>v0.1.0</code>)</li>
          <li>Submit PR to <a href="https://github.com/microsoft/amplifier/blob/main/docs/MODULES.md" target="_blank">amplifier/docs/MODULES.md</a></li>
        </ol>
        <p style="margin-top: 12px; color: var(--text-2);"><strong>Note:</strong> MODULES.md lives in the <code>amplifier</code> repo (entry point), NOT in <code>amplifier-core</code>.</p>
      </div>

      <h3>Event Names Reference</h3>
      <table class="ref-table">
        <thead>
          <tr><th>Event</th><th>When</th><th>Hook Can Block?</th></tr>
        </thead>
        <tbody>
          <tr><td><code>session:start</code></td><td>Session begins</td><td>No</td></tr>
          <tr><td><code>session:end</code></td><td>Session ends</td><td>No</td></tr>
          <tr><td><code>prompt:submit</code></td><td>User message received</td><td>No</td></tr>
          <tr><td><code>provider:request</code></td><td>Before LLM API call</td><td>No</td></tr>
          <tr><td><code>provider:response</code></td><td>After LLM response</td><td>No</td></tr>
          <tr><td><code>content_block:start</code></td><td>Streaming block begins</td><td>No</td></tr>
          <tr><td><code>content_block:delta</code></td><td>Streaming content chunk</td><td>No</td></tr>
          <tr><td><code>content_block:end</code></td><td>Streaming block ends</td><td>No</td></tr>
          <tr><td><code>tool:pre</code></td><td>Before tool execution</td><td><strong>Yes</strong></td></tr>
          <tr><td><code>tool:post</code></td><td>After tool execution</td><td>No</td></tr>
          <tr><td><code>tool:error</code></td><td>Tool execution failed</td><td>No</td></tr>
          <tr><td><code>orchestrator:complete</code></td><td>Orchestration done</td><td>No</td></tr>
        </tbody>
      </table>

      <!-- DX REVIEW & DIAGRAMS -->
      <h2 id="dx-review">DX Review & Architecture Diagrams</h2>
      <p>Visual diagrams showing Amplifier's architecture and execution flows.</p>

      <h3>Architecture Overview</h3>
      <p>The three-layer architecture showing kernel, app, and module boundaries:</p>

      <div class="mermaid-container">
        <div class="mermaid">
flowchart TB
    subgraph USER["User"]
        U1["CLI Command"]
        U2["Interactive REPL"]
    end

    subgraph CLI["amplifier-app-cli (Application Layer)"]
        direction TB

        subgraph CLI_COMMANDS["Commands"]
            CMD1["run"]
            CMD2["init"]
            CMD3["update"]
        end

        subgraph CLI_CONFIG["Configuration Resolution"]
            CFG1["ConfigManager"]
            CFG2["ProfileLoader"]
            CFG3["BundleRegistry"]
        end

        subgraph CLI_UX["UX Systems"]
            UX1["CLIApprovalSystem"]
            UX2["CLIDisplaySystem"]
        end

        subgraph CLI_POLICY["App-Layer Policies"]
            POL1["MentionResolver"]
            POL2["ContentDeduplicator"]
            POL3["CompositeModuleResolver"]
        end
    end

    subgraph CORE["amplifier-core (Kernel Layer)"]
        direction TB

        subgraph CORE_SESSION["AmplifierSession"]
            S1["session_id"]
            S2["config validation"]
            S3["lifecycle methods"]
        end

        subgraph CORE_COORD["ModuleCoordinator"]
            C1["Mount points registry"]
            C2["Capability registry"]
        end

        subgraph CORE_HOOKS["HookRegistry"]
            H1["Priority-based dispatch"]
            H2["Event emission"]
        end
    end

    subgraph MODULES["Pluggable Modules"]
        MOD1["orchestrator-*"]
        MOD2["provider-*"]
        MOD3["tool-*"]
        MOD4["hooks-*"]
    end

    U1 --> CMD1
    CMD1 --> CFG1
    CFG1 --> S1
    UX1 --> S1
    POL3 --> C1
    S1 --> C1
    MODULES --> C1
        </div>
        <div class="diagram-caption">Figure 1: Architecture Overview - Kernel/App/Module Layers</div>
      </div>

      <h3>Execute Flow</h3>
      <p>What happens when <code>session.execute(prompt)</code> is called:</p>

      <div class="mermaid-container">
        <div class="mermaid">
flowchart TD
    subgraph KERNEL_EXEC["KERNEL: session.execute(prompt)"]
        E1["Get orchestrator from coordinator"]
        E2["Get context manager"]
        E3["Get providers dict"]
        E4["Get tools dict"]
        E5["orchestrator.execute()"]
    end

    subgraph ORCH_LOOP["KERNEL: Orchestrator Loop"]
        O1["Build messages from context"]
        O2["Call provider.create_message()"]
        O3{"Tool calls in response?"}
        O4["Emit tool:pre hooks"]
        O5["Execute tool via tools dict"]
        O6["Emit tool:post hooks"]
        O7["Add tool result to context"]
        O8["Extract final response text"]
    end

    E1 --> E2 --> E3 --> E4 --> E5
    E5 --> O1
    O1 --> O2
    O2 --> O3
    O3 -->|Yes| O4
    O4 --> O5
    O5 --> O6
    O6 --> O7
    O7 --> O2
    O3 -->|No| O8
        </div>
        <div class="diagram-caption">Figure 2: Execute Flow - Orchestrator Loop with Hooks</div>
      </div>

      <h3>Improvement Roadmap</h3>
      <p>Based on the DX review analysis:</p>

      <div class="concepts">
        <div class="concept">
          <h3>Phase 1 (P0) - Critical</h3>
          <ul>
            <li>Architecture boundary documentation</li>
            <li>Module lifecycle guide</li>
            <li>Fix asset model confusion (Profile/Bundle/Recipe)</li>
          </ul>
        </div>
        <div class="concept">
          <h3>Phase 2 (P1) - Updates</h3>
          <ul>
            <li>Revise desktop case study</li>
            <li>Integrate mermaid diagrams</li>
            <li>Link to ecosystem resources</li>
          </ul>
        </div>
        <div class="concept">
          <h3>Phase 3 (P2) - Enhancements</h3>
          <ul>
            <li>Interactive documentation</li>
            <li>Downloadable agent guide</li>
            <li>Complete ecosystem map</li>
          </ul>
        </div>
      </div>

      <h3>Architecture Checklist</h3>
      <div class="info-box" style="border-left: 4px solid var(--green); margin: 24px 0;">
        <strong>Is My Architecture Correct?</strong>
        <ul style="margin: 8px 0 0 0; color: var(--text-1);">
          <li>â˜ App layer handles all UX (display, approval, user input)</li>
          <li>â˜ App layer loads bundles/profiles (kernel doesn't know where they come from)</li>
          <li>â˜ App layer registers capabilities (modules request them abstractly)</li>
          <li>â˜ Kernel layer validates config structure (not content policy)</li>
          <li>â˜ Kernel layer dispatches hooks (doesn't know what they do)</li>
          <li>â˜ Kernel layer coordinates modules (doesn't implement capabilities)</li>
          <li>â˜ Modules implement protocols (Tool, Hook, Provider, etc.)</li>
          <li>â˜ Modules use capabilities, not imports from apps</li>
          <li>â˜ Modules are transport-agnostic (no WebSocket/console/HTTP knowledge)</li>
        </ul>
      </div>

      <p style="text-align: center; color: var(--text-2); margin-top: 40px;"><strong>When in doubt:</strong> Can another app use this unchanged? If not, it belongs in the app layer.</p>

    </section>

    <!-- CONTRIBUTE SECTION -->
    <section id="section-contribute" class="section">
      <h1>Contributors Guide</h1>
      <p class="section-desc">Help us build a world-class developer experience for Amplifier.</p>

      <div class="info-box" style="border-left: 4px solid var(--orange); margin-bottom: 24px;">
        <strong>ðŸ“š Community & Contributing</strong>
        <p style="margin: 8px 0 0 0; color: var(--text-1);">Join the community and see the roadmap at the <a href="https://microsoft.github.io/amplifier-docs/" target="_blank">official Amplifier documentation site</a>.</p>
      </div>

      <div class="tabs" id="contribute-tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="tasks">Priority Tasks</button>
        <button class="tab" data-tab="specs">Specifications</button>
        <button class="tab" data-tab="roadmap">Roadmap</button>
        <button class="tab" data-tab="rules">Repository Rules</button>
      </div>

      <!-- Overview Tab -->
      <div id="contrib-overview" class="tab-content active">
        <div class="callout">
          <p><strong>North Star:</strong> Amplifier makes advanced AI agent systems <em>feel like scripting</em>. Developers should go from an idea to a working extension in under 2 minutes.</p>
        </div>

        <h3>Understanding the Ecosystem</h3>
        <p>Contributing to Amplifier typically means <strong>creating your own repositories</strong> rather than submitting PRs to a monolithic codebase:</p>
        <ul>
          <li><strong>Core kernel</strong> (<code>amplifier-core</code>) - Small, stable, boring. High bar for changes.</li>
          <li><strong>CLI application</strong> (<code>amplifier-app-cli</code>) - Reference CLI, not user-focused.</li>
          <li><strong>Reference implementations</strong> - Canonical examples for each module type.</li>
          <li><strong>Community ecosystem</strong> - Your own modules, tools, apps, and collections.</li>
        </ul>

        <div class="info-box" style="margin: 16px 0;">
          <strong>Reference Implementations</strong>
          <ul style="margin-top: 8px;">
            <li><a href="https://github.com/microsoft/amplifier-module-provider-anthropic" target="_blank">provider-anthropic</a> - Claude integration</li>
            <li><a href="https://github.com/microsoft/amplifier-module-tool-filesystem" target="_blank">tool-filesystem</a> - File operations</li>
            <li><a href="https://github.com/microsoft/amplifier-module-tool-bash" target="_blank">tool-bash</a> - Shell commands</li>
            <li><a href="https://github.com/payneio/amplifierd" target="_blank">amplifierd</a> - HTTP/SSE API server</li>
          </ul>
        </div>

        <h3>The Gap</h3>
        <p>The kernel is already built. It's stable, minimal, and powerful. What's missing is the <strong>developer experience layer</strong>â€”the tooling that makes the kernel approachable.</p>

        <h3>What Belongs Where</h3>
        <table class="contrib-table">
          <thead>
            <tr><th>Feature</th><th>Layer</th><th>Status</th></tr>
          </thead>
          <tbody>
            <tr><td>Protocol contracts</td><td>Kernel (core)</td><td class="done">âœ“ Done</td></tr>
            <tr><td>AmplifierSession</td><td>Kernel (core)</td><td class="done">âœ“ Done</td></tr>
            <tr><td>Event system (30+ events)</td><td>Kernel (core)</td><td class="done">âœ“ Done</td></tr>
            <tr><td>Testing utilities (TestCoordinator, etc.)</td><td>Kernel (core)</td><td class="done">âœ“ Done</td></tr>
            <tr><td>Protocol validation utility</td><td>Kernel (core)</td><td class="needed">Needed</td></tr>
            <tr><td>@tool / @hook decorators</td><td>Helpers</td><td class="needed">Needed</td></tr>
            <tr><td>Test harness utilities</td><td>Helpers</td><td class="needed">Needed</td></tr>
            <tr><td><code>amplifier dev</code> (hot reload)</td><td>CLI</td><td class="needed">Needed</td></tr>
            <tr><td><code>amplifier inspect --events</code></td><td>CLI</td><td class="needed">Needed</td></tr>
            <tr><td><code>amplifier scaffold</code></td><td>CLI</td><td class="needed">Needed</td></tr>
            <tr><td><code>amplifier check</code> (validation)</td><td>CLI</td><td class="needed">Needed</td></tr>
            <tr><td><code>amplifier plan show</code></td><td>CLI</td><td class="needed">Needed</td></tr>
          </tbody>
        </table>

        <h3>Developer Personas</h3>
        <div class="personas">
          <div class="persona">
            <strong>Consumer</strong>
            <p>Uses existing modules. Cares about profiles, CLI, and configuration.</p>
          </div>
          <div class="persona">
            <strong>Extender</strong>
            <p>Adds custom tools/hooks. Needs minimal boilerplate and fast feedback.</p>
          </div>
          <div class="persona">
            <strong>Architect</strong>
            <p>Embeds Amplifier in products. Needs integration patterns and observability.</p>
          </div>
        </div>
      </div>

      <!-- Tasks Tab -->
      <div id="contrib-tasks" class="tab-content">
        <h3>ðŸ”´ High Priority</h3>

        <div class="task">
          <div class="task-header">
            <span class="task-title">Testing Utilities âœ“</span>
            <span class="task-layer">amplifier-core</span>
          </div>
          <p>Built-in utilities for unit testing modules (AVAILABLE):</p>
          <div class="code-block">
            <div class="code-header">
              <span class="code-lang">python</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <pre><code class="language-python">from amplifier_core.testing import (
    TestCoordinator, MockTool, MockContextManager,
    EventRecorder, create_test_coordinator
)

# Usage in tests
async def test_my_tool():
    coord = create_test_coordinator()
    await mount(coord, {})

    tool = coord.mounted["tools"]["my_tool"]
    result = await tool.execute({"input": "test"})
    assert result.error is None</code></pre>
          </div>
        </div>

        <div class="task">
          <div class="task-header">
            <span class="task-title">@tool Decorator</span>
            <span class="task-layer">amplifier-helpers</span>
          </div>
          <p>2-minute time-to-first-tool. Reduces boilerplate dramatically.</p>
          <div class="code-block">
            <div class="code-header">
              <span class="code-lang">python</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <pre><code class="language-python"># amplifier_helpers/decorators.py
def tool(name: str, description: str):
    def decorator(func):
        class GeneratedTool:
            @property
            def name(self): return name
            @property
            def description(self): return description
            async def execute(self, input: dict):
                return await func(**input)
        return GeneratedTool()
    return decorator

# Usage
from amplifier_helpers import tool

@tool(name="greet", description="Says hello")
async def greet(name: str) -> str:
    return f"Hello, {name}!"</code></pre>
          </div>
        </div>

        <h3>ðŸŸ¡ Medium Priority</h3>

        <div class="task">
          <div class="task-header">
            <span class="task-title">Event Inspector</span>
            <span class="task-layer">amplifier-app-cli</span>
          </div>
          <p>Real-time visualization of the event stream.</p>
          <div class="code-block">
            <div class="code-header">
              <span class="code-lang">bash</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <pre><code class="language-bash">$ amplifier inspect --events

# Output:
# 14:32:01.234 session:start     {session_id: "abc123"}
# 14:32:01.567 prompt:submit     {content: "Hello"}
# 14:32:02.123 provider:request  {provider: "anthropic", messages: 1}
# 14:32:03.456 provider:response {tokens: 42}</code></pre>
          </div>
        </div>

        <div class="task">
          <div class="task-header">
            <span class="task-title">Scaffold Templates</span>
            <span class="task-layer">amplifier-app-cli</span>
          </div>
          <p>Generate module templates with correct structure.</p>
          <div class="code-block">
            <div class="code-header">
              <span class="code-lang">bash</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <pre><code class="language-bash">$ amplifier scaffold tool my_tool
# Creates:
# my_tool/
#   __init__.py
#   my_tool.py      # Tool class + mount()
#   pyproject.toml  # Entry point configured
#   tests/
#     test_my_tool.py

$ amplifier scaffold hook --pattern approval
# Generates approval gate hook template</code></pre>
          </div>
        </div>
      </div>

      <!-- Specs Tab -->
      <div id="contrib-specs" class="tab-content">
        <h3>@hook Decorator Specification</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># amplifier_helpers/decorators.py
from functools import wraps
from amplifier_core.models import HookResult

def hook(events: list[str], priority: int = 100):
    """
    Decorator to create a hook handler.

    Args:
        events: List of event patterns (supports globs like "tool:*")
        priority: Lower runs first (default 100)
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(event: str, data: dict) -> HookResult:
            result = await func(event, data)
            if result is None:
                return HookResult(action="continue")
            return result

        wrapper._hook_events = events
        wrapper._hook_priority = priority
        return wrapper
    return decorator

# Usage
@hook(events=["tool:pre", "tool:post"], priority=10)
async def my_hook(event: str, data: dict):
    print(f"{event}: {data}")
    # Returning None = continue</code></pre>
        </div>

        <h3>Directory Structure</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
          </div>
          <pre><code>amplifier-ecosystem/
â”œâ”€â”€ amplifier-core/           # Kernel (this repo)
â”‚   â”œâ”€â”€ amplifier_core/
â”‚   â”‚   â”œâ”€â”€ session.py        # AmplifierSession
â”‚   â”‚   â”œâ”€â”€ coordinator.py    # Coordinator
â”‚   â”‚   â”œâ”€â”€ hooks.py          # HookRegistry
â”‚   â”‚   â”œâ”€â”€ protocols.py      # Protocol definitions
â”‚   â”‚   â”œâ”€â”€ models.py         # ToolResult, HookResult, etc.
â”‚   â”‚   â”œâ”€â”€ testing.py        # TestCoordinator, MockTool, etc.
â”‚   â”‚   â””â”€â”€ validation.py     # check_protocol() (NEW)
â”‚   â””â”€â”€ pyproject.toml
â”‚
â”œâ”€â”€ amplifier-helpers/        # Convenience utilities (NEW)
â”‚   â”œâ”€â”€ amplifier_helpers/
â”‚   â”‚   â”œâ”€â”€ decorators.py     # @tool, @hook
â”‚   â”‚   â””â”€â”€ testing.py        # ToolTestHarness
â”‚   â””â”€â”€ pyproject.toml
â”‚
â”œâ”€â”€ amplifier-app-cli/        # CLI application
â”‚   â”œâ”€â”€ amplifier_cli/
â”‚   â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”‚   â”œâ”€â”€ run.py
â”‚   â”‚   â”‚   â”œâ”€â”€ dev.py        # Hot reload (NEW)
â”‚   â”‚   â”‚   â”œâ”€â”€ inspect.py    # Event inspector (NEW)
â”‚   â”‚   â”‚   â”œâ”€â”€ scaffold.py   # Templates (NEW)
â”‚   â”‚   â”‚   â”œâ”€â”€ check.py      # Validation (NEW)
â”‚   â”‚   â”‚   â””â”€â”€ plan.py       # Visualizer (NEW)
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â””â”€â”€ pyproject.toml
â”‚
â””â”€â”€ amplifier-profiles/       # Profile management
    â””â”€â”€ ...</code></pre>
        </div>
      

<!-- AUTO-GENERATED: External Specifications from amplifier-next-specs -->
        <!-- Last synced: 2025-12-10T22:16:05.979Z -->

        <hr style="border: none; border-top: 1px solid var(--border); margin: 32px 0;">

        <div class="info-box" style="border-left: 4px solid var(--purple); margin-bottom: 24px;">
          <strong>External Specifications</strong>
          <p style="margin: 8px 0 0 0; color: var(--text-1);">
            These specifications are automatically synced from
            <a href="https://github.com/samueljklee/amplifier-next-specs" target="_blank">amplifier-next-specs</a>.
            They define enterprise productivity extensions for the Amplifier framework.
          </p>
        </div>

        <div class="spec-filter" style="margin-bottom: 20px;">
          <span style="font-size: 13px; color: var(--text-2); margin-right: 12px;">Filter:</span>
          <button class="spec-filter-btn active" data-filter="all">All</button>
          <button class="spec-filter-btn" data-filter="design">Design</button>
          <button class="spec-filter-btn" data-filter="tools">Tools</button>
          <button class="spec-filter-btn" data-filter="hooks">Hooks</button>
          <button class="spec-filter-btn" data-filter="recipes">Recipes</button>
          <button class="spec-filter-btn" data-filter="collections">Collections</button>
          <button class="spec-filter-btn" data-filter="integrations">Integrations</button>
        </div>

        <div id="specs-container">
        <div class="spec-section" id="spec-enterprise-productivity-extensions-index" data-category="overview">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Enterprise Productivity Extensions Index</span>
            <span class="spec-category">overview</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft specifications for review</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Purpose</strong>: Comprehensive specs for tools, hooks, scenario tools, collections, and integrations targeting enterprise product teams working in large codebases.</p>
        </div>
        <p>---</p>
        <h3>Overview</h3>
        <p>This specification set defines extensions to the Amplifier framework optimized for:</p>
        <li><strong>Product building</strong> - Feature development, planning, release management</li>
        <li><strong>Team collaboration</strong> - Code review, knowledge sharing, onboarding</li>
        <li><strong>Large codebase management</strong> - Navigation, understanding, tech debt</li>
        <li><strong>Enterprise context</strong> - Compliance, security, audit trails</li>
        <p>---</p>
        <h3>Architectural Note</h3>
        <p><strong>Why no custom orchestrators?</strong></p>
        <p>After analysis, we determined that multi-step workflows and multi-agent collaboration belong at the <strong>tool layer</strong>, not the orchestrator layer. This follows Amplifier's "mechanism vs policy" philosophy:</p>
        <li><strong>Orchestrators</strong> (kernel-adjacent): Simple execution mechanisms (loop-basic, loop-streaming)</li>
        <li><strong>Tools</strong> (app layer): Workflow policies (recipes, collaborative, swarm)</li>
        <p>The existing <code>amplifier-collection-recipes</code> already provides declarative multi-step workflows. New coordination patterns (<code>tool-collaborative</code>, <code>tool-swarm</code>) are specified as tools that spawn sub-agents.</p>
        <p>---</p>
        <h3>Specification Index</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tools (Atomic Capabilities)</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Spec</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="tools/tool-codebase-search.md" target="_blank">tool-codebase-search</a></td><td>Semantic search across code, docs, tickets</td><td>P0</td></tr>
            <tr><td><a href="tools/tool-dependency-graph.md" target="_blank">tool-dependency-graph</a></td><td>Trace imports, call chains, impact analysis</td><td>P1</td></tr>
            <tr><td><a href="tools/tool-architecture-map.md" target="_blank">tool-architecture-map</a></td><td>Generate/update architecture diagrams</td><td>P2</td></tr>
            <tr><td><a href="tools/tool-tech-debt-scanner.md" target="_blank">tool-tech-debt-scanner</a></td><td>Identify anti-patterns, dead code, outdated deps</td><td>P1</td></tr>
            <tr><td><a href="tools/tool-pr-context.md" target="_blank">tool-pr-context</a></td><td>Fetch PR, comments, linked issues, related PRs</td><td>P0</td></tr>
            <tr><td><a href="tools/tool-slack-search.md" target="_blank">tool-slack-search</a></td><td>Search team discussions, decisions</td><td>P1</td></tr>
            <tr><td><a href="tools/tool-jira-ops.md" target="_blank">tool-jira-ops</a></td><td>Create, update, link tickets</td><td>P0</td></tr>
            <tr><td><a href="tools/tool-git-advanced.md" target="_blank">tool-git-advanced</a></td><td>Branch ops, history analysis, contextual blame</td><td>P1</td></tr>
            <tr><td><a href="tools/tool-test-runner.md" target="_blank">tool-test-runner</a></td><td>Run specific tests, analyze failures</td><td>P1</td></tr>
            <tr><td><a href="tools/tool-migration-helper.md" target="_blank">tool-migration-helper</a></td><td>Schema changes, migrations, rollback plans</td><td>P2</td></tr>
            <tr><td><a href="tools/tool-feature-flag.md" target="_blank">tool-feature-flag</a></td><td>Check/toggle flags, analyze flag debt</td><td>P2</td></tr>
            <tr><td><a href="tools/tool-metrics-query.md" target="_blank">tool-metrics-query</a></td><td>Query Prometheus/DataDog/etc.</td><td>P1</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tools (Coordination Patterns)</h4>
        <p>These tools enable sophisticated multi-agent patterns while keeping orchestrators simple:</p>
        <table class="ref-table">
          <thead>
            <tr><th>Spec</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="tools/tool-collaborative.md" target="_blank">tool-collaborative</a></td><td>Multi-agent collaboration (parallel specialists)</td><td>P1</td></tr>
            <tr><td><a href="tools/tool-swarm.md" target="_blank">tool-swarm</a></td><td>Parallel exploration with convergence</td><td>P2</td></tr>
          </tbody>
        </table>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Note</strong>: For sequential multi-step workflows, use the existing <code>amplifier-collection-recipes</code>.</p>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hooks (Guardrails &amp; Intelligence)</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Spec</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="hooks/hooks-style-enforcer.md" target="_blank">hooks-style-enforcer</a></td><td>Auto-lint, inject feedback on violations</td><td>P1</td></tr>
            <tr><td><a href="hooks/hooks-security-scan.md" target="_blank">hooks-security-scan</a></td><td>SAST scan, block critical vulnerabilities</td><td>P0</td></tr>
            <tr><td><a href="hooks/hooks-secret-detector.md" target="_blank">hooks-secret-detector</a></td><td>Prevent committing secrets/keys</td><td>P0</td></tr>
            <tr><td><a href="hooks/hooks-breaking-change.md" target="_blank">hooks-breaking-change</a></td><td>Detect API breaking changes</td><td>P1</td></tr>
            <tr><td><a href="hooks/hooks-ticket-linker.md" target="_blank">hooks-ticket-linker</a></td><td>Auto-load JIRA context for current branch</td><td>P0</td></tr>
            <tr><td><a href="hooks/hooks-reviewer-suggester.md" target="_blank">hooks-reviewer-suggester</a></td><td>Suggest reviewers based on code ownership</td><td>P2</td></tr>
            <tr><td><a href="hooks/hooks-standup-logger.md" target="_blank">hooks-standup-logger</a></td><td>Summarize work for async standups</td><td>P2</td></tr>
            <tr><td><a href="hooks/hooks-knowledge-capture.md" target="_blank">hooks-knowledge-capture</a></td><td>Extract learnings to team knowledge base</td><td>P1</td></tr>
            <tr><td><a href="hooks/hooks-audit-trail.md" target="_blank">hooks-audit-trail</a></td><td>Immutable log for compliance</td><td>P0</td></tr>
            <tr><td><a href="hooks/hooks-pii-guardian.md" target="_blank">hooks-pii-guardian</a></td><td>Redact PII before sending to LLM</td><td>P0</td></tr>
            <tr><td><a href="hooks/hooks-license-checker.md" target="_blank">hooks-license-checker</a></td><td>Flag incompatible licenses</td><td>P2</td></tr>
            <tr><td><a href="hooks/hooks-approval-workflow.md" target="_blank">hooks-approval-workflow</a></td><td>Require human approval for sensitive changes</td><td>P1</td></tr>
            <tr><td><a href="hooks/hooks-token-budget.md" target="_blank">hooks-token-budget</a></td><td>Enforce per-session/user token limits</td><td>P1</td></tr>
            <tr><td><a href="hooks/hooks-model-router.md" target="_blank">hooks-model-router</a></td><td>Route tasks to appropriate models</td><td>P1</td></tr>
            <tr><td><a href="hooks/hooks-usage-analytics.md" target="_blank">hooks-usage-analytics</a></td><td>Track usage patterns for optimization</td><td>P1</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Recipes (Declarative Multi-Step Workflows)</h4>
        <p>Recipes are declarative YAML specifications that define multi-step AI agent workflows. They leverage <code>amplifier-collection-recipes</code> for:</p>
        <li>Sequential/conditional execution with <code>foreach</code> and <code>parallel: true</code></li>
        <li>Recipe composition (sub-recipes for reusable audits)</li>
        <li>Context isolation and checkpointing</li>
        <li>Agent mode switching (ANALYZE, ARCHITECT, REVIEW)</li>
        <p>#### Main Recipes</p>
        <table class="ref-table">
          <thead>
            <tr><th>Recipe</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="recipes/pr-reviewer.yaml" target="_blank">pr-reviewer</a></td><td>Comprehensive PR review with parallel analysis</td><td>P0</td></tr>
            <tr><td><a href="recipes/incident-responder.yaml" target="_blank">incident-responder</a></td><td>Incident analysis with multi-hypothesis diagnosis</td><td>P0</td></tr>
            <tr><td><a href="recipes/feature-planner.yaml" target="_blank">feature-planner</a></td><td>Transform PRD to implementation plan</td><td>P1</td></tr>
            <tr><td><a href="recipes/codebase-onboarder.yaml" target="_blank">codebase-onboarder</a></td><td>New developer onboarding guide generation</td><td>P1</td></tr>
            <tr><td><a href="recipes/tech-debt-prioritizer.yaml" target="_blank">tech-debt-prioritizer</a></td><td>Tech debt triage with JIRA integration</td><td>P1</td></tr>
          </tbody>
        </table>
        <p>#### Reusable Sub-Recipes (audits/)</p>
        <p>Composable audit recipes that can be used standalone or within larger workflows:</p>
        <table class="ref-table">
          <thead>
            <tr><th>Recipe</th><th>Purpose</th><th>Used By</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="recipes/audits/security-audit.yaml" target="_blank">security-audit</a></td><td>Security vulnerability analysis</td><td>pr-reviewer</td></tr>
            <tr><td><a href="recipes/audits/quality-audit.yaml" target="_blank">quality-audit</a></td><td>Code quality and maintainability</td><td>pr-reviewer</td></tr>
            <tr><td><a href="recipes/audits/breaking-change-audit.yaml" target="_blank">breaking-change-audit</a></td><td>API/schema compatibility analysis</td><td>pr-reviewer</td></tr>
            <tr><td><a href="recipes/audits/architecture-audit.yaml" target="_blank">architecture-audit</a></td><td>Architectural impact assessment</td><td>pr-reviewer (thorough mode)</td></tr>
          </tbody>
        </table>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Migration Note</strong>: The previous scenario-tools (Python implementations) have been converted to declarative YAML recipes. This follows Amplifier's "mechanism vs policy" philosophy - complex workflows are now declarative specifications that the recipe engine executes.</p>
        </div>
        <p>#### Extended Recipes (Showcasing Advanced Features)</p>
        <p>Additional recipes demonstrating advanced Amplifier@next capabilities:</p>
        <table class="ref-table">
          <thead>
            <tr><th>Recipe</th><th>Purpose</th><th>Key Features</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="recipes/release-manager.yaml" target="_blank">release-manager</a></td><td>Coordinate release process (changelog, notes, tagging)</td><td><code>foreach</code> over commits, parallel notifications</td><td>P1</td></tr>
            <tr><td><a href="recipes/migration-orchestrator.yaml" target="_blank">migration-orchestrator</a></td><td>Complex migrations with validation at each step</td><td>Checkpointing, rollback support, validation gates</td><td>P1</td></tr>
            <tr><td><a href="recipes/dependency-upgrader.yaml" target="_blank">dependency-upgrader</a></td><td>Automated dep updates with compatibility checks</td><td><code>foreach</code> + <code>parallel</code>, test integration, rollback</td><td>P1</td></tr>
            <tr><td><a href="recipes/root-cause-analyzer.yaml" target="_blank">root-cause-analyzer</a></td><td>Deep dive into production issues</td><td>Multi-hypothesis diagnosis, evidence weighting</td><td>P1</td></tr>
            <tr><td><a href="recipes/test-suite-analyzer.yaml" target="_blank">test-suite-analyzer</a></td><td>Coverage gaps, flaky tests, test prioritization</td><td>Parallel analysis, metrics aggregation</td><td>P1</td></tr>
            <tr><td><a href="recipes/api-evolution-tracker.yaml" target="_blank">api-evolution-tracker</a></td><td>Track API changes, suggest versioning, generate migrations</td><td>Temporal analysis, doc generation</td><td>P2</td></tr>
            <tr><td><a href="recipes/documentation-auditor.yaml" target="_blank">documentation-auditor</a></td><td>Find outdated docs, doc-code consistency</td><td>Multi-source correlation, quality scoring</td><td>P2</td></tr>
            <tr><td><a href="recipes/knowledge-harvester.yaml" target="_blank">knowledge-harvester</a></td><td>Extract knowledge from Slack/PRs/meetings</td><td>Multi-source ingestion, entity extraction</td><td>P2</td></tr>
            <tr><td><a href="recipes/compliance-checker.yaml" target="_blank">compliance-checker</a></td><td>SOC2/GDPR/HIPAA compliance scanning</td><td>Policy-based rules, parallel audits</td><td>P2</td></tr>
            <tr><td><a href="recipes/performance-profiler.yaml" target="_blank">performance-profiler</a></td><td>Profile app, identify bottlenecks, track over time</td><td>Metrics integration, trend analysis</td><td>P2</td></tr>
          </tbody>
        </table>
        <p><strong>Feature Showcase:</strong></p>
        <table class="ref-table">
          <thead>
            <tr><th>Feature</th><th>Demonstrated By</th></tr>
          </thead>
          <tbody>
            <tr><td><code>foreach</code> + <code>parallel</code></td><td>dependency-upgrader, release-manager</td></tr>
            <tr><td>Checkpointing/Resumability</td><td>migration-orchestrator</td></tr>
            <tr><td>Multi-hypothesis Reasoning</td><td>root-cause-analyzer, incident-responder</td></tr>
            <tr><td>Recipe Composition</td><td>pr-reviewer (uses audit sub-recipes)</td></tr>
            <tr><td>Conditional Steps</td><td>all recipes with <code>condition:</code></td></tr>
            <tr><td>Mode Switching</td><td>feature-planner (ANALYZE â†’ ARCHITECT â†’ REVIEW)</td></tr>
            <tr><td>Multi-source Ingestion</td><td>knowledge-harvester, root-cause-analyzer</td></tr>
            <tr><td>Evidence Collection</td><td>compliance-checker, root-cause-analyzer</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Collections (Packaged Expertise)</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Spec</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="collections/collection-enterprise-dev.md" target="_blank">collection-enterprise-dev</a></td><td>Core enterprise development</td><td>P0</td></tr>
            <tr><td><a href="collections/collection-platform-team.md" target="_blank">collection-platform-team</a></td><td>Platform/infrastructure teams</td><td>P1</td></tr>
            <tr><td><a href="collections/collection-product-team.md" target="_blank">collection-product-team</a></td><td>Product management integration</td><td>P2</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integrations (Enterprise Ecosystem)</h4>
        <p>#### Core Infrastructure</p>
        <table class="ref-table">
          <thead>
            <tr><th>Spec</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="integrations/integration-api-server.md" target="_blank">integration-api-server</a></td><td>HTTP REST/GraphQL API server (enables all other integrations)</td><td>P0</td></tr>
            <tr><td><a href="integrations/integration-github-actions.md" target="_blank">integration-github-actions</a></td><td>CI/CD integration</td><td>P0</td></tr>
            <tr><td><a href="integrations/integration-git-hooks.md" target="_blank">integration-git-hooks</a></td><td>Pre-commit, commit-msg, pre-push automation</td><td>P1</td></tr>
          </tbody>
        </table>
        <p>#### Developer Tools</p>
        <table class="ref-table">
          <thead>
            <tr><th>Spec</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="integrations/integration-tauri-desktop.md" target="_blank">integration-tauri-desktop</a></td><td><strong>Amplifier Desktop</strong> - Native Tauri app with streaming UI</td><td>P0</td></tr>
            <tr><td><a href="integrations/integration-vscode.md" target="_blank">integration-vscode</a></td><td>VS Code IDE integration</td><td>P1</td></tr>
            <tr><td><a href="integrations/integration-browser-extension.md" target="_blank">integration-browser-extension</a></td><td>GitHub/GitLab PR review, code explanation in browser</td><td>P1</td></tr>
            <tr><td><a href="integrations/integration-electron-app.md" target="_blank">integration-electron-app</a></td><td>Standalone desktop app with offline support</td><td>P2</td></tr>
            <tr><td><a href="integrations/integration-obsidian-plugin.md" target="_blank">integration-obsidian-plugin</a></td><td>Knowledge management, code-to-docs</td><td>P2</td></tr>
          </tbody>
        </table>
        <p>#### Team Communication</p>
        <table class="ref-table">
          <thead>
            <tr><th>Spec</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="integrations/integration-slack.md" target="_blank">integration-slack</a></td><td>Slack bot integration</td><td>P1</td></tr>
            <tr><td><a href="integrations/integration-teams-bot.md" target="_blank">integration-teams-bot</a></td><td>Microsoft Teams bot with Azure DevOps</td><td>P2</td></tr>
          </tbody>
        </table>
        <p>#### Dashboards & Monitoring</p>
        <table class="ref-table">
          <thead>
            <tr><th>Spec</th><th>Purpose</th><th>Priority</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="integrations/integration-web-dashboard.md" target="_blank">integration-web-dashboard</a></td><td>Web-based management UI</td><td>P1</td></tr>
            <tr><td><a href="integrations/integration-observability.md" target="_blank">integration-observability</a></td><td>Grafana/DataDog dashboards</td><td>P2</td></tr>
            <tr><td><a href="integrations/integration-mobile-companion.md" target="_blank">integration-mobile-companion</a></td><td>iOS/Android mobile app</td><td>P2</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Priority Legend</h3>
        <li><strong>P0</strong>: Foundation - Build first, enables other work</li>
        <li><strong>P1</strong>: High value - Significant productivity gain</li>
        <li><strong>P2</strong>: Enhancement - Nice to have, can defer</li>
        <p>---</p>
        <h3>Specification Template</h3>
        <p>Each spec follows this structure:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"># [Component Name]

## Overview
Brief description and value proposition

## Contract
Interface definition (inputs, outputs, events)

## Architecture
Internal design, dependencies, data flow

## Configuration
Available options and defaults

## Examples
Usage examples and common patterns

## Security Considerations
Permissions, data handling, risks

## Testing Strategy
How to verify correctness

## Open Questions
Decisions needing input</code></pre>
        </div>
        <p>---</p>
        <h3>Review Process</h3>
        <li>Review specs in priority order (P0 â†’ P1 â†’ P2)</li>
        <li>Mark decisions in "Open Questions" sections</li>
        <li>Iterate until spec is approved</li>
        <li>Implementation follows approved spec</li>
          </div>
        </div>
        <div class="spec-section" id="spec-cold-start-analysis" data-category="analysis">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Cold Start Analysis</span>
            <span class="spec-category">analysis</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <h3>Problem Statement</h3>
        <p>Amplifier@next is a runtime platform for AI-powered workflows, but users don't know how to start using it to see value. Unlike visual builders (Zapier) or IDE extensions (Copilot), there's no obvious entry point.</p>
        <p>---</p>
        <h3>Market Research Findings</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Developer Platform Onboarding Patterns</h4>
        <p><strong>Key Insight</strong>: Speed to first value is critical.</p>
        <table class="ref-table">
          <thead>
            <tr><th>Platform</th><th>Approach</th><th>Key Metric</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="https://docs.railway.com/maturity/compare-to-vercel" target="_blank">Railway</a></td><td>"Deploy in 4 clicks"</td><td>Minimal friction</td></tr>
            <tr><td><a href="https://medium.com/@takafumi.endo/how-vercel-simplifies-deployment-for-developers-beaabe0ada32" target="_blank">Vercel</a></td><td>"In mere seconds, your code is live"</td><td>Frictionless onboarding</td></tr>
            <tr><td><a href="https://render.com/docs/render-vs-vercel-comparison" target="_blank">Render</a></td><td>Templates + simple defaults</td><td>Transparent pricing</td></tr>
          </tbody>
        </table>
        <p><strong>Pattern</strong>: Offer templates/pre-configured starting points alongside blank canvas.</p>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. AI Coding Assistant Onboarding</h4>
        <p><strong>Key Insight</strong>: Make the tool feel like a teaching partner, not just a feature.</p>
        <table class="ref-table">
          <thead>
            <tr><th>Tool</th><th>First Value Experience</th><th>Differentiator</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="https://github.com/features/copilot" target="_blank">GitHub Copilot</a></td><td>Real-time suggestions</td><td>"Senior engineer whispering syntax"</td></tr>
            <tr><td><a href="https://www.builder.io/blog/cursor-vs-github-copilot" target="_blank">Cursor</a></td><td>Codebase-aware suggestions</td><td>"Explain my code" feature</td></tr>
          </tbody>
        </table>
        <p><strong>Pattern</strong>: Junior developers using Cursor fix bugs 30-50% faster with inline explanations. The "explain my code" feature shortens learning curves dramatically.</p>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Workflow Automation Onboarding</h4>
        <p><strong>Key Insight</strong>: Guide beginners, but don't block experts.</p>
        <table class="ref-table">
          <thead>
            <tr><th>Platform</th><th>Approach</th><th>Target Audience</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="https://zapier.com/blog/n8n-vs-zapier/" target="_blank">Zapier</a></td><td>Linear guided flow + templates</td><td>Non-technical users</td></tr>
            <tr><td><a href="https://n8n.io" target="_blank">n8n</a></td><td>Freedom to experiment immediately</td><td>Developers</td></tr>
          </tbody>
        </table>
        <p><strong>Zapier's Secret</strong>: Doesn't just say "here's a builder, figure it out." Instead offers:</p>
        <li>Build from scratch</li>
        <li>Pre-made templates</li>
        <li>3-minute tutorial</li>
        <li>Suggested workflows based on role</li>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Interactive Demo &amp; Sandbox Patterns</h4>
        <p><strong>Key Insight</strong>: <a href="https://goconsensus.com/blog/the-product-led-growth-hybrid-interactive-product-demos" target="_blank">43% of B2B buyers want seller-free experience</a> (Gartner).</p>
        <table class="ref-table">
          <thead>
            <tr><th>Tool</th><th>Type</th><th>Best For</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="https://instruqt.com/" target="_blank">Instruqt</a></td><td>Browser-based sandbox</td><td>Software companies selling to developers</td></tr>
            <tr><td><a href="https://codesandbox.io/" target="_blank">CodeSandbox</a></td><td>Live code environment</td><td>Documentation & learning</td></tr>
            <tr><td><a href="https://www.joshwcomeau.com/react/next-level-playground/" target="_blank">Sandpack</a></td><td>Embeddable code playground</td><td>In-context demonstrations</td></tr>
          </tbody>
        </table>
        <p><strong>Pattern</strong>: Playgrounds allow learners to tinker, experiment, and commit lessons to memory. Active participation > passive demos.</p>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. AI Agent Platform Experiences</h4>
        <p><strong>Key Insight</strong>: 2024 was the year "narrowly scoped, highly controllable agents" started working in production.</p>
        <table class="ref-table">
          <thead>
            <tr><th>Framework</th><th>Strength</th><th>Demo Suitability</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="https://blog.langchain.com/top-5-langgraph-agents-in-production-2024/" target="_blank">LangChain</a></td><td>Modular pipelines</td><td>Production-ready</td></tr>
            <tr><td><a href="https://www.instinctools.com/blog/autogen-vs-langchain-vs-crewai/" target="_blank">CrewAI</a></td><td>Multi-agent collaboration</td><td>"Best suited for demos and prototypes"</td></tr>
            <tr><td><a href="https://medium.com/@datascientist.lakshmi/agentic-ai-frameworks-building-autonomous-ai-agents-with-langchain-crewai-autogen-and-more-8a697bee8bf8" target="_blank">AutoGPT</a></td><td>Full autonomy</td><td>"Exciting experiment" but unreliable</td></tr>
          </tbody>
        </table>
        <p><strong>Pattern</strong>: Vertical, focused use cases work better than general-purpose agents.</p>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">6. Time to Value Research</h4>
        <p><strong>Critical Stats</strong>:</p>
        <li><a href="https://www.guidecx.com/blog/customer-onboarding-accelerate-time-to-first-value/" target="_blank">70% of users abandon</a> if onboarding takes >20 minutes (Visa)</li>
        <li><a href="https://www.guidecx.com/blog/customer-onboarding-accelerate-time-to-first-value/" target="_blank">90% of customers believe onboarding experiences are lacking</a></li>
        <li><a href="https://www.appcues.com/blog/aha-moment-guide" target="_blank">3-step tours have 72% completion vs 16% for 7-step</a> (Chameleon.io)</li>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">7. Developer &quot;Aha Moments&quot;</h4>
        <p><strong>Key Insight</strong>: The aha moment is when developers first experience core value viscerally.</p>
        <table class="ref-table">
          <thead>
            <tr><th>Company</th><th>Aha Moment</th></tr>
          </thead>
          <tbody>
            <tr><td><a href="https://www.signalfire.com/blog/devrel-for-startups" target="_blank">Twilio</a></td><td>"When developers sent their first text or made a phone ring with code"</td></tr>
            <tr><td>Docker</td><td>"When developers realized they could containerize an entire application"</td></tr>
            <tr><td><a href="https://www.signalfire.com/blog/devrel-for-startups" target="_blank">Stripe/Plaid</a></td><td>Well-designed APIs + comprehensive documentation</td></tr>
          </tbody>
        </table>
        <p><strong>Pattern</strong>: Transform casual users into passionate advocates through tangible, visceral experiences.</p>
        <p>---</p>
        <h3>Amplifier@next Value Proposition Analysis</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">What Amplifier@next Does</h4>
        <li>Multi-step AI workflows (recipes)</li>
        <li>Specialized agents (zen-architect, security-guardian, bug-hunter, etc.)</li>
        <li>Enterprise focus (PR review, incident response, tech debt, compliance)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Why Cold Start is Hard</h4>
        <li><strong>Runtime platform</strong> - No visual builder interface</li>
        <li><strong>Requires codebase</strong> - Can't demo without real code</li>
        <li><strong>Multi-step value</strong> - Benefits compound over workflow, not single action</li>
        <li><strong>Enterprise context</strong> - Full value requires team/org setup</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">What the Aha Moment Should Be</h4>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);">"I pointed amplifier at my PR/incident/codebase, and in 60 seconds it gave me a comprehensive analysis I would have spent hours creating manually."</p>
        </div>
        <p>---</p>
        <h3>Proposed Showcase Experiences</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Option 1: &quot;Recipe Playground&quot; (Web-Based)</h4>
        <p><strong>Concept</strong>: Interactive web sandbox where users run recipes against sample repos.</p>
        <p><strong>Experience Flow</strong>:</p>
        <li>Land on playground.amplifier.dev</li>
        <li>Choose a scenario: "PR Review" | "Incident Response" | "Tech Debt Scan"</li>
        <li>See pre-loaded sample repo with realistic code</li>
        <li>Click "Run Recipe" - watch agents work in real-time</li>
        <li>Get comprehensive output (security findings, review comments, etc.)</li>
        <li>Option to "Try on your repo" â†’ CLI installation</li>
        <p><strong>Why It Works</strong>:</p>
        <li>No setup required (like Zapier templates)</li>
        <li>Tangible output in <60 seconds (like Twilio's first SMS)</li>
        <li>Demonstrates multi-agent collaboration visually</li>
        <li>Educational - shows what each agent does</li>
        <p><strong>Implementation</strong>:</p>
        <li>Web app with embedded terminal/output viewer</li>
        <li>Pre-baked scenarios with sample repos</li>
        <li>Real recipe execution (not simulated)</li>
        <li>Output comparison: "Manual effort: ~2 hours. Amplifier: 45 seconds."</li>
        <p><strong>Effort</strong>: Medium-High (requires web infrastructure)</p>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Option 2: &quot;Demo Mode&quot; CLI Experience</h4>
        <p><strong>Concept</strong>: Built-in demo command that runs against sample repos.</p>
        <p><strong>Experience Flow</strong>:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Install
pip install amplifier-cli

# Run demo (no config needed)
amplifier demo pr-review

# Output: Downloads sample PR, runs full review, shows results
# &quot;Want to try on your own repo? Run: amplifier init&quot;</code></pre>
        </div>
        <p><strong>Demo Scenarios</strong>:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier demo pr-review        # Full PR review with security/quality/breaking changes
amplifier demo incident         # Incident response with log analysis, RCA
amplifier demo tech-debt        # Tech debt scan with JIRA ticket creation
amplifier demo onboard          # Codebase onboarding guide generation</code></pre>
        </div>
        <p><strong>Why It Works</strong>:</p>
        <li>Zero config (like Railway's 4-click deploy)</li>
        <li>Developers stay in terminal (familiar environment)</li>
        <li>Real execution, not simulated</li>
        <li>Natural progression to "try on your code"</li>
        <p><strong>Implementation</strong>:</p>
        <li>Bundle sample repos or fetch from GitHub</li>
        <li>Pre-configured recipe contexts</li>
        <li>Output formatter showing agent steps + results</li>
        <li>Call-to-action for real usage</li>
        <p><strong>Effort</strong>: Low-Medium (CLI extension)</p>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Option 3: &quot;One-Click GitHub App&quot;</h4>
        <p><strong>Concept</strong>: GitHub App that installs in 1 click and immediately provides value.</p>
        <p><strong>Experience Flow</strong>:</p>
        <li>Visit amplifier.dev/github-app</li>
        <li>Click "Install on Repository"</li>
        <li>Select a repo</li>
        <li>Immediately:</li>
        <p>   - Opens latest PR with AI review comments</p>
        <p>   - Creates "Amplifier Analysis" issue with codebase health report</p>
        <p>   - Shows tech debt summary in README badge</p>
        <p><strong>Triggered Workflows</strong>:</p>
        <li><strong>On PR Open</strong>: Automatic security + quality review</li>
        <li><strong>On Issue "incident"</strong>: Automatic incident analysis</li>
        <li><strong>Weekly</strong>: Tech debt report</li>
        <p><strong>Why It Works</strong>:</p>
        <li>One click to value (like Vercel's GitHub integration)</li>
        <li>Works where developers already are</li>
        <li>Demonstrates continuous value, not one-time</li>
        <li>Social proof via visible activity</li>
        <p><strong>Implementation</strong>:</p>
        <li>GitHub App with webhooks</li>
        <li>Recipe execution on PR/issue events</li>
        <li>Comment generation matching GitHub's format</li>
        <li>Dashboard for configuration</li>
        <p><strong>Effort</strong>: High (requires GitHub App infrastructure)</p>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Option 4: &quot;Vertical Showcases&quot; (Persona-Based)</h4>
        <p><strong>Concept</strong>: Tailored demo experiences for specific roles/use cases.</p>
        <p><strong>Personas & Experiences</strong>:</p>
        <table class="ref-table">
          <thead>
            <tr><th>Persona</th><th>Showcase</th><th>Key Recipe</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Platform Engineer</strong></td><td>"Incident War Room"</td><td>incident-responder, root-cause-analyzer</td></tr>
            <tr><td><strong>Engineering Manager</strong></td><td>"Tech Debt Dashboard"</td><td>tech-debt-prioritizer, compliance-checker</td></tr>
            <tr><td><strong>New Team Member</strong></td><td>"Codebase Explorer"</td><td>codebase-onboarder</td></tr>
            <tr><td><strong>Security Engineer</strong></td><td>"Security Audit"</td><td>security-audit, compliance-checker</td></tr>
            <tr><td><strong>Release Manager</strong></td><td>"Release Coordinator"</td><td>release-manager, api-evolution-tracker</td></tr>
          </tbody>
        </table>
        <p><strong>Experience (Platform Engineer Example)</strong>:</p>
        <li>"Simulate" an incident alert</li>
        <li>Watch amplifier gather logs, metrics, recent deploys</li>
        <li>See hypothesis generation and testing</li>
        <li>Get actionable RCA with timeline</li>
        <li>"This normally takes your team 2 hours. Amplifier: 3 minutes."</li>
        <p><strong>Why It Works</strong>:</p>
        <li>Speaks to specific pain points (like Zapier's role-based onboarding)</li>
        <li>Demonstrates depth, not just breadth</li>
        <li>Creates multiple entry points to platform</li>
        <li>Content marketing opportunity (blog posts, videos per persona)</li>
        <p><strong>Implementation</strong>:</p>
        <li>Landing pages per persona</li>
        <li>Curated demo scenarios</li>
        <li>ROI calculators</li>
        <li>Case study format</li>
        <p><strong>Effort</strong>: Medium (content + web)</p>
        <p>---</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Option 5: &quot;Recipe Gallery&quot; with Live Execution</h4>
        <p><strong>Concept</strong>: Browse, preview, and run recipes like an app store.</p>
        <p><strong>Experience Flow</strong>:</p>
        <li>Browse recipes by category (Code Review, Incident, Planning, etc.)</li>
        <li>Each recipe shows:</li>
        <p>   - Description</p>
        <p>   - Required inputs</p>
        <p>   - Sample output preview</p>
        <p>   - "Run Demo" button</p>
        <li>Click "Run Demo" â†’ executes against sample repo</li>
        <li>See step-by-step agent execution</li>
        <li>Download recipe to run locally</li>
        <p><strong>Why It Works</strong>:</p>
        <li>Discovery mechanism (like Zapier's app directory)</li>
        <li>Shows breadth of capabilities</li>
        <li>Each recipe is a mini-demo</li>
        <li>Community contribution model (submit recipes)</li>
        <p><strong>Implementation</strong>:</p>
        <li>Web gallery with recipe metadata</li>
        <li>Demo execution backend</li>
        <li>Output preview/streaming</li>
        <li>Recipe export/import</li>
        <p><strong>Effort</strong>: Medium-High</p>
        <p>---</p>
        <h3>Recommendation: Phased Approach</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Phase 1: Demo Mode CLI (Weeks 1-2)</h4>
        <p><strong>Why First</strong>:</p>
        <li>Lowest effort, highest developer authenticity</li>
        <li>Works with existing CLI infrastructure</li>
        <li>Proves value proposition before building web UI</li>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier demo pr-review
amplifier demo incident
amplifier demo tech-debt</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Phase 2: Vertical Landing Pages (Weeks 3-4)</h4>
        <p><strong>Why Second</strong>:</p>
        <li>Marketing and content leverage</li>
        <li>Multiple entry points</li>
        <li>SEO + content marketing synergy</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Phase 3: Recipe Playground (Weeks 5-8)</h4>
        <p><strong>Why Third</strong>:</p>
        <li>Building on validated messaging from Phase 1-2</li>
        <li>Requires more infrastructure</li>
        <li>Higher conversion potential</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Phase 4: GitHub App (Months 2-3)</h4>
        <p><strong>Why Last</strong>:</p>
        <li>Highest effort</li>
        <li>Requires ongoing maintenance</li>
        <li>Best ROI once user base exists</li>
        <p>---</p>
        <h3>Success Metrics</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Metric</th><th>Target</th><th>Measurement</th></tr>
          </thead>
          <tbody>
            <tr><td>Time to First Value</td><td><3 minutes</td><td>From first command to seeing output</td></tr>
            <tr><td>Demo Completion Rate</td><td>>60%</td><td>Users who complete a demo scenario</td></tr>
            <tr><td>CLI â†’ Real Usage</td><td>>20%</td><td>Users who run on own repos after demo</td></tr>
            <tr><td>GitHub App Installs</td><td>N/A (Phase 4)</td><td>Weekly active installations</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Sample Repos</strong>: Should we use famous open-source repos (kubernetes, react) or create synthetic ones?</li>
        <p>   - Pro of famous: Recognition, realistic complexity</p>
        <p>   - Pro of synthetic: Controlled, consistent, no licensing issues</p>
        <li><strong>Real vs Simulated</strong>: Should demos execute real recipes or show pre-baked results?</li>
        <p>   - Pro of real: Authenticity, shows actual capabilities</p>
        <p>   - Pro of pre-baked: Fast, consistent, no API costs</p>
        <li><strong>Self-Hosted Option</strong>: Enterprise users may want to run demos on their infrastructure. Support this?</li>
        <li><strong>Pricing Preview</strong>: Should demo experience show pricing/limits to set expectations?</li>
        <p>---</p>
        <h3>Next Steps</h3>
        <li>[ ] Decide on Phase 1 scope (which demo scenarios)</li>
        <li>[ ] Select/create sample repositories</li>
        <li>[ ] Design demo output format</li>
        <li>[ ] Implement <code>amplifier demo</code> command</li>
        <li>[ ] Create landing page content for vertical showcases</li>
          </div>
        </div>
        <div class="spec-section" id="spec-skills-agents-plugins" data-category="design">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Skills Agents Plugins</span>
            <span class="spec-category">design</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <p><strong>Status:</strong> Design Complete</p>
        <p><strong>Scope:</strong> Desktop implementation (extensible to CLI)</p>
        <p>---</p>
        <h3>Overview</h3>
        <p>This document defines the architecture for Skills, Agents, and Plugins systems that extend amplifier capabilities while maintaining kernel stability.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Design Principles</h4>
        <li><strong>Kernel Stability</strong> - amplifier-core remains unchanged</li>
        <li><strong>Modular Loading</strong> - Skills/Agents/Plugins loaded as modules</li>
        <li><strong>User Control</strong> - All features togglable</li>
        <li><strong>Claude Compatibility</strong> - Same formats as Claude Code</li>
        <li><strong>Local First</strong> - All data stored locally</li>
        <p>---</p>
        <h3>Skills System</h3>
        <p>A skill is a reusable capability that extends AI functionality through natural language instructions. Skills are <strong>model-invoked</strong> (Claude decides when to use them).</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Directory Structure</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">~/.amplifier/skills/              # User-level (all projects)
  â””â”€â”€ my-skill/
      â”œâ”€â”€ SKILL.md                # Required: Skill definition
      â”œâ”€â”€ scripts/                # Optional: Executable scripts
      â”œâ”€â”€ references/             # Optional: Documentation
      â””â”€â”€ assets/                 # Optional: Templates, files

.amplifier/skills/                # Project-level (this project only)
  â””â”€â”€ project-skill/
      â””â”€â”€ SKILL.md</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">SKILL.md Format</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown">---
name: skill-name
description: Brief description of what this skill does
allowed-tools: &quot;Read, Write, Bash&quot;  # Optional: Tool restrictions
version: 1.0.0
---

# Skill Name

## Instructions
Provide clear, step-by-step guidance for Claude.

## Examples
Show concrete examples of using this skill.</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Implementation</h4>
        <p><strong>Backend:</strong> <code>sidecar/skills_manager.py</code></p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class Skill:
    name: str
    description: str
    skill_md: str
    allowed_tools: list[str]
    scripts: list[str]
    references: list[str]
    location: &#039;user&#039; | &#039;project&#039;
    enabled: bool

class SkillsManager:
    async def load_skills(project_path: str | None) -&gt; list[Skill]
    async def enable_skill(name: str) -&gt; None
    async def disable_skill(name: str) -&gt; None</code></pre>
        </div>
        <p><strong>Frontend:</strong> Skills loaded and injected into system prompt when enabled.</p>
        <p>---</p>
        <h3>Agents System</h3>
        <p>An agent is a specialized AI persona with focused capabilities. Agents use <strong>user-invoked</strong> activation via <code>/agent</code> command.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Directory Structure</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">~/.amplifier/agents/              # User-level
  â””â”€â”€ my-agent.md

.amplifier/agents/                # Project-level
  â””â”€â”€ project-agent.md</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Agent Format</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown">---
name: agent-name
description: What this agent specializes in
model: claude-opus-4-5-20251101  # Optional: Override model
tools: [read_file, write_file]   # Optional: Tool allowlist
temperature: 0.7                 # Optional: Override temp
---

# Agent Name

## Role
Define the agent&#039;s specialized role and expertise.

## Approach
Describe how the agent should approach problems.

## Constraints
List any limitations or boundaries.</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Activation</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">/agent code-reviewer    # Switch to code reviewer agent
/agent                  # Return to default assistant</code></pre>
        </div>
        <p>---</p>
        <h3>Plugins System</h3>
        <p>Plugins extend functionality with external integrations (MCP servers, API connections, etc.).</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Plugin Types</h4>
        <li><strong>MCP Plugins</strong> - Model Context Protocol servers</li>
        <li><strong>API Plugins</strong> - External API integrations</li>
        <li><strong>Tool Plugins</strong> - Custom tool implementations</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># ~/.amplifier/settings.yaml
plugins:
  mcp:
    filesystem:
      command: &quot;npx&quot;
      args: [&quot;-y&quot;, &quot;@modelcontextprotocol/server-filesystem&quot;, &quot;~&quot;]
    github:
      command: &quot;npx&quot;
      args: [&quot;-y&quot;, &quot;@modelcontextprotocol/server-github&quot;]
      env:
        GITHUB_TOKEN: ${GITHUB_TOKEN}</code></pre>
        </div>
        <p>---</p>
        <h3>Integration with amplifier-core</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Points</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Skills injected via system prompt hook
hooks.register(&quot;prompt:pre&quot;, inject_skills_prompt)

# Agent switching via command hook
hooks.register(&quot;command:pre&quot;, handle_agent_command)

# Plugin tools registered via mount
coordinator.mount(&quot;tools&quot;, mcp_tool, name=f&quot;mcp_{server}_{tool}&quot;)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Module Loading</h4>
        <p>Skills/Agents use the existing <code>LocalLoader</code> infrastructure:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Skills treated as loadable modules
loader.register(&quot;skill-*&quot;, SkillModule)
loader.register(&quot;agent-*&quot;, AgentModule)</code></pre>
        </div>
        <p>---</p>
        <h3>Feature Matrix</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Feature</th><th>Skills</th><th>Agents</th><th>Plugins</th></tr>
          </thead>
          <tbody>
            <tr><td>Activation</td><td>Model-invoked</td><td>User-invoked</td><td>Always active</td></tr>
            <tr><td>Scope</td><td>User/Project</td><td>User/Project</td><td>Global</td></tr>
            <tr><td>Tool Restrictions</td><td>Yes</td><td>Yes</td><td>No</td></tr>
            <tr><td>Model Override</td><td>No</td><td>Yes</td><td>No</td></tr>
            <tr><td>Custom Scripts</td><td>Yes</td><td>No</td><td>Yes</td></tr>
            <tr><td>Reference Docs</td><td>Yes</td><td>No</td><td>No</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Implementation Status</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Desktop</h4>
        <li>[x] Skills manager basic implementation</li>
        <li>[x] Skills UI (enable/disable)</li>
        <li>[x] MCP plugins integration</li>
        <li>[ ] Agents system</li>
        <li>[ ] Agent switching UI</li>
        <li>[ ] Skills auto-discovery</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">CLI</h4>
        <li>[ ] Skills support</li>
        <li>[ ] Agents support</li>
        <li>[ ] Plugin system</li>
        <p>---</p>
        <h3>References</h3>
        <li>Claude Code skills format: https://docs.anthropic.com/claude/docs/skills</li>
        <li>MCP specification: https://modelcontextprotocol.io/</li>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-architecture-map" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Architecture Map</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Enhancement)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-architecture-map</code></p>
        </div>
        <h3>Overview</h3>
        <p>Generate and maintain architecture diagrams from code analysis. Creates visual representations of system structure, data flows, and component relationships that stay synchronized with the actual codebase.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Architecture docs always outdated</td><td>Diagrams generated from live code</td></tr>
            <tr><td>Manual diagram maintenance</td><td>Auto-update on codebase changes</td></tr>
            <tr><td>Inconsistent diagram styles</td><td>Consistent, templated output</td></tr>
            <tr><td>Hours in diagramming tools</td><td>Instant generation from code analysis</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>System overview</strong>: Generate high-level architecture diagram</li>
        <li><strong>Component deep-dive</strong>: Detailed view of specific service/module</li>
        <li><strong>Data flow visualization</strong>: How data moves through the system</li>
        <li><strong>Onboarding</strong>: Quick visual understanding for new developers</li>
        <li><strong>Documentation sync</strong>: Keep architecture docs current</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;architecture_map&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Generate architecture diagrams from code analysis.

    Diagram types:
    - system: High-level system/service architecture
    - component: Internal component structure
    - data_flow: Data movement through system
    - deployment: Infrastructure/deployment view
    - sequence: Interaction sequences

    Output formats: mermaid, plantuml, dot, svg, png
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;diagram_type&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;system&quot;, &quot;component&quot;, &quot;data_flow&quot;, &quot;deployment&quot;, &quot;sequence&quot;],
                &quot;description&quot;: &quot;Type of diagram to generate&quot;
            },
            &quot;scope&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Path or pattern to analyze (e.g., &#039;src/services/&#039;, &#039;PaymentService&#039;)&quot;
            },
            &quot;depth&quot;: {
                &quot;type&quot;: &quot;integer&quot;,
                &quot;default&quot;: 2,
                &quot;description&quot;: &quot;Level of detail (1=high-level, 3=detailed)&quot;
            },
            &quot;output_format&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;mermaid&quot;, &quot;plantuml&quot;, &quot;dot&quot;, &quot;svg&quot;, &quot;png&quot;],
                &quot;default&quot;: &quot;mermaid&quot;,
                &quot;description&quot;: &quot;Output format&quot;
            },
            &quot;include_external&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: true,
                &quot;description&quot;: &quot;Include external services/dependencies&quot;
            },
            &quot;group_by&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;module&quot;, &quot;layer&quot;, &quot;domain&quot;, &quot;none&quot;],
                &quot;default&quot;: &quot;module&quot;,
                &quot;description&quot;: &quot;How to group components&quot;
            }
        },
        &quot;required&quot;: [&quot;diagram_type&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class ArchitectureMapOutput:
    diagram_type: str
    scope: str

    # Diagram content
    diagram: str                        # In requested format
    format: str

    # Metadata
    components: list[Component]
    relationships: list[Relationship]
    external_services: list[ExternalService]

    # Analysis summary
    summary: ArchitectureSummary

@dataclass
class Component:
    id: str
    name: str
    type: str                           # service | module | class | database | queue
    description: str | None
    source_path: str | None
    layer: str | None                   # api | service | data | infrastructure
    metrics: ComponentMetrics | None

@dataclass
class Relationship:
    source_id: str
    target_id: str
    type: str                           # calls | uses | stores | publishes | subscribes
    description: str | None
    async_: bool
    protocol: str | None                # http | grpc | amqp | sql

@dataclass
class ExternalService:
    name: str
    type: str                           # database | cache | queue | api | storage
    provider: str | None                # aws | gcp | azure | self-hosted

@dataclass
class ArchitectureSummary:
    total_components: int
    total_relationships: int
    layers_detected: list[str]
    patterns_detected: list[str]        # &quot;microservices&quot;, &quot;monolith&quot;, &quot;event-driven&quot;
    suggestions: list[str]              # Architecture improvement suggestions</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Diagram Generation Pipeline</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ArchitectureMapper:
    &quot;&quot;&quot;Generate architecture diagrams from code analysis.&quot;&quot;&quot;

    async def generate(self, input: ArchitectureMapInput) -&gt; ArchitectureMapOutput:
        # 1. Analyze codebase structure
        components = await self._discover_components(input.scope, input.depth)

        # 2. Analyze relationships
        relationships = await self._analyze_relationships(components)

        # 3. Detect external services
        external = await self._detect_external_services(components)

        # 4. Apply grouping/layout
        layout = self._compute_layout(components, relationships, input.group_by)

        # 5. Generate diagram
        diagram = self._render_diagram(
            components, relationships, external, layout,
            input.diagram_type, input.output_format
        )

        # 6. Analyze architecture patterns
        summary = self._analyze_architecture(components, relationships)

        return ArchitectureMapOutput(
            diagram_type=input.diagram_type,
            scope=input.scope,
            diagram=diagram,
            format=input.output_format,
            components=components,
            relationships=relationships,
            external_services=external,
            summary=summary
        )

    async def _discover_components(self, scope: str, depth: int) -&gt; list[Component]:
        &quot;&quot;&quot;Discover components from code structure.&quot;&quot;&quot;
        components = []

        # Depth 1: Services/top-level modules
        if depth &gt;= 1:
            services = await self._find_services(scope)
            components.extend(services)

        # Depth 2: Major classes/modules within services
        if depth &gt;= 2:
            for service in services:
                modules = await self._find_modules(service.source_path)
                components.extend(modules)

        # Depth 3: Individual classes and functions
        if depth &gt;= 3:
            for module in components:
                classes = await self._find_classes(module.source_path)
                components.extend(classes)

        return components

    def _render_diagram(
        self,
        components: list[Component],
        relationships: list[Relationship],
        external: list[ExternalService],
        layout: Layout,
        diagram_type: str,
        format: str
    ) -&gt; str:
        &quot;&quot;&quot;Render diagram in requested format.&quot;&quot;&quot;
        renderers = {
            &quot;mermaid&quot;: MermaidRenderer(),
            &quot;plantuml&quot;: PlantUMLRenderer(),
            &quot;dot&quot;: GraphvizRenderer(),
        }

        renderer = renderers[format]
        return renderer.render(components, relationships, external, layout, diagram_type)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Mermaid Renderer</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class MermaidRenderer:
    &quot;&quot;&quot;Render diagrams in Mermaid format.&quot;&quot;&quot;

    def render_system(
        self,
        components: list[Component],
        relationships: list[Relationship],
        external: list[ExternalService]
    ) -&gt; str:
        lines = [&quot;graph TB&quot;]

        # Add subgraphs for groupings
        groups = self._group_components(components)
        for group_name, group_components in groups.items():
            lines.append(f&quot;    subgraph {group_name}&quot;)
            for comp in group_components:
                shape = self._get_shape(comp.type)
                lines.append(f&quot;        {comp.id}{shape}&quot;)
            lines.append(&quot;    end&quot;)

        # Add external services
        if external:
            lines.append(&quot;    subgraph External&quot;)
            for ext in external:
                lines.append(f&quot;        {ext.name}[({ext.name})]&quot;)
            lines.append(&quot;    end&quot;)

        # Add relationships
        for rel in relationships:
            arrow = self._get_arrow(rel.type, rel.async_)
            label = f&quot;|{rel.type}|&quot; if rel.type else &quot;&quot;
            lines.append(f&quot;    {rel.source_id} {arrow}{label} {rel.target_id}&quot;)

        return &quot;\n&quot;.join(lines)

    def _get_shape(self, component_type: str) -&gt; str:
        shapes = {
            &quot;service&quot;: &quot;[{}]&quot;,          # Rectangle
            &quot;database&quot;: &quot;[({})]&quot;,       # Cylinder
            &quot;queue&quot;: &quot;{{{}}}&quot;,          # Hexagon
            &quot;api&quot;: &quot;([{}])&quot;,            # Stadium
            &quot;module&quot;: &quot;({})&quot;,           # Rounded
        }
        return shapes.get(component_type, &quot;[{}]&quot;)</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: System Architecture Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;diagram_type&quot;: &quot;system&quot;,
    &quot;scope&quot;: &quot;src/services/&quot;,
    &quot;depth&quot;: 1,
    &quot;output_format&quot;: &quot;mermaid&quot;
}

# Output
{
    &quot;diagram_type&quot;: &quot;system&quot;,
    &quot;diagram&quot;: &quot;&quot;&quot;graph TB
    subgraph Services
        api-gateway[API Gateway]
        user-service[User Service]
        payment-service[Payment Service]
        order-service[Order Service]
    end
    subgraph Data
        postgres[(PostgreSQL)]
        redis[(Redis)]
    end
    subgraph External
        stripe([Stripe API])
        sendgrid([SendGrid])
    end

    api-gateway --&gt;|REST| user-service
    api-gateway --&gt;|REST| order-service
    order-service --&gt;|gRPC| payment-service
    payment-service --&gt;|HTTPS| stripe
    user-service --&gt; postgres
    payment-service --&gt; postgres
    user-service --&gt; redis
    order-service --&gt;|email| sendgrid&quot;&quot;&quot;,
    &quot;format&quot;: &quot;mermaid&quot;,
    &quot;summary&quot;: {
        &quot;total_components&quot;: 4,
        &quot;layers_detected&quot;: [&quot;api&quot;, &quot;service&quot;, &quot;data&quot;],
        &quot;patterns_detected&quot;: [&quot;microservices&quot;, &quot;api-gateway&quot;],
        &quot;suggestions&quot;: [
            &quot;Consider adding circuit breakers for external service calls&quot;,
            &quot;payment-service has high coupling with order-service&quot;
        ]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;diagram_type&quot;: &quot;component&quot;,
    &quot;scope&quot;: &quot;src/services/payment/&quot;,
    &quot;depth&quot;: 2
}

# Output
{
    &quot;diagram&quot;: &quot;&quot;&quot;graph TB
    subgraph payment-service
        subgraph API Layer
            PaymentController
            WebhookController
        end
        subgraph Service Layer
            PaymentService
            RefundService
            WebhookProcessor
        end
        subgraph Data Layer
            PaymentRepository
            TransactionRepository
        end
    end

    PaymentController --&gt; PaymentService
    WebhookController --&gt; WebhookProcessor
    PaymentService --&gt; PaymentRepository
    PaymentService --&gt; RefundService
    RefundService --&gt; TransactionRepository&quot;&quot;&quot;
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-architecture-map:
  # Analysis settings
  analysis:
    # Patterns to identify services
    service_patterns:
      - &quot;**/services/*/&quot;
      - &quot;**/apps/*/&quot;
      - &quot;**/microservices/*/&quot;

    # Patterns to identify modules
    module_patterns:
      - &quot;**/*_service.py&quot;
      - &quot;**/*_controller.py&quot;
      - &quot;**/*_repository.py&quot;

    # Layer detection
    layers:
      api: [&quot;controller&quot;, &quot;handler&quot;, &quot;endpoint&quot;, &quot;router&quot;]
      service: [&quot;service&quot;, &quot;usecase&quot;, &quot;interactor&quot;]
      data: [&quot;repository&quot;, &quot;dao&quot;, &quot;model&quot;, &quot;entity&quot;]
      infrastructure: [&quot;client&quot;, &quot;adapter&quot;, &quot;gateway&quot;]

  # External service detection
  external_services:
    # Detect from import patterns
    patterns:
      stripe: [&quot;stripe&quot;]
      aws: [&quot;boto3&quot;, &quot;aws_sdk&quot;]
      redis: [&quot;redis&quot;, &quot;aioredis&quot;]
      postgres: [&quot;psycopg&quot;, &quot;asyncpg&quot;, &quot;sqlalchemy&quot;]

  # Output settings
  output:
    default_format: &quot;mermaid&quot;
    include_metrics: false              # Include LOC, complexity, etc.</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Read-only analysis of codebase</li>
        <li>May reveal system architecture in outputs</li>
        <li>No external network access required</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>tree-sitter</code> - Code parsing</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>graphviz</code> - For DOT/SVG/PNG output</li>
        <li><code>plantuml</code> - For PlantUML rendering</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Real-time updates</strong>: Should diagrams update as files change?</li>
        <li><strong>Diagram storage</strong>: Where to persist generated diagrams?</li>
        <li><strong>Interactive diagrams</strong>: Support for clickable/zoomable output?</li>
        <li><strong>Custom styling</strong>: Allow custom themes/colors?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-codebase-search" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Codebase Search</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-codebase-search</code></p>
        </div>
        <h3>Overview</h3>
        <p>Semantic and structural search across codebases, documentation, and linked systems. Goes beyond grep/ripgrep by understanding code structure, natural language queries, and cross-referencing multiple data sources.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td><code>grep -r "auth timeout"</code> â†’ 500 results, mostly noise</td><td>"Where do we handle authentication timeouts?" â†’ 3 relevant files with context</td></tr>
            <tr><td>Manual cross-referencing between code, docs, tickets</td><td>Single query spans code + docs + tickets + Slack</td></tr>
            <tr><td>Lost tribal knowledge</td><td>"Why was this implemented this way?" â†’ Links to original PR, discussion, decision</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Code discovery</strong>: "Find all API endpoints that require admin permissions"</li>
        <li><strong>Impact analysis</strong>: "What code paths touch the user's email address?"</li>
        <li><strong>Historical context</strong>: "Why does this function have this weird edge case?"</li>
        <li><strong>Onboarding</strong>: "How does the payment flow work?"</li>
        <li><strong>Debugging</strong>: "Where is this error message defined and when is it thrown?"</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;codebase_search&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Search across the codebase, documentation, and linked systems using natural language
    or structured queries. Returns relevant code snippets, files, and cross-references.

    Use for:
    - Finding code by description (&quot;authentication handling&quot;)
    - Understanding code relationships (&quot;what calls this function&quot;)
    - Historical context (&quot;why was this changed&quot;)
    - Cross-system search (code + docs + tickets)
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;query&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Natural language query or structured search&quot;
            },
            &quot;scope&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;code&quot;, &quot;docs&quot;, &quot;tickets&quot;, &quot;discussions&quot;, &quot;all&quot;],
                &quot;default&quot;: &quot;all&quot;,
                &quot;description&quot;: &quot;Limit search to specific sources&quot;
            },
            &quot;file_patterns&quot;: {
                &quot;type&quot;: &quot;array&quot;,
                &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;},
                &quot;description&quot;: &quot;Glob patterns to filter files (e.g., [&#039;*.py&#039;, &#039;src/**&#039;])&quot;
            },
            &quot;search_type&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;semantic&quot;, &quot;structural&quot;, &quot;literal&quot;, &quot;hybrid&quot;],
                &quot;default&quot;: &quot;hybrid&quot;,
                &quot;description&quot;: &quot;Search strategy&quot;
            },
            &quot;include_context&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: true,
                &quot;description&quot;: &quot;Include surrounding code context and cross-references&quot;
            },
            &quot;max_results&quot;: {
                &quot;type&quot;: &quot;integer&quot;,
                &quot;default&quot;: 10,
                &quot;description&quot;: &quot;Maximum results to return&quot;
            }
        },
        &quot;required&quot;: [&quot;query&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Input Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class CodebaseSearchInput:
    query: str                          # Natural language or structured query
    scope: Scope = Scope.ALL            # code | docs | tickets | discussions | all
    file_patterns: list[str] | None     # Glob patterns to filter
    search_type: SearchType = HYBRID    # semantic | structural | literal | hybrid
    include_context: bool = True        # Include surrounding context
    max_results: int = 10               # Max results</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class SearchResult:
    source_type: str                    # &quot;code&quot; | &quot;doc&quot; | &quot;ticket&quot; | &quot;discussion&quot;
    location: str                       # File path or URL
    snippet: str                        # Matched content
    relevance_score: float              # 0.0 - 1.0
    context: ResultContext | None       # Surrounding context if requested
    cross_references: list[CrossRef]    # Related items

@dataclass
class ResultContext:
    before: str                         # Lines before match
    after: str                          # Lines after match
    file_summary: str                   # What this file does
    related_symbols: list[str]          # Functions/classes in same file

@dataclass
class CrossRef:
    ref_type: str                       # &quot;calls&quot; | &quot;called_by&quot; | &quot;imports&quot; | &quot;ticket&quot; | &quot;pr&quot; | &quot;doc&quot;
    target: str                         # Target location
    description: str                    # Human-readable description

@dataclass
class CodebaseSearchOutput:
    results: list[SearchResult]
    query_interpretation: str           # How the query was understood
    search_stats: SearchStats           # Performance metrics
    suggestions: list[str]              # Related queries to try</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>tool:codebase_search:start</code></td><td>Search begins</td><td>query, scope, search_type</td></tr>
            <tr><td><code>tool:codebase_search:index_hit</code></td><td>Index lookup</td><td>index_type, hit_count</td></tr>
            <tr><td><code>tool:codebase_search:complete</code></td><td>Search done</td><td>result_count, duration_ms</td></tr>
            <tr><td><code>tool:codebase_search:error</code></td><td>Search failed</td><td>error_type, message</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     tool-codebase-search                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Query     â”‚â”€â”€â”€â–¶â”‚   Search    â”‚â”€â”€â”€â–¶â”‚   Result    â”‚         â”‚
â”‚  â”‚  Analyzer   â”‚    â”‚  Executor   â”‚    â”‚  Ranker     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                            â”‚                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â–¼                  â–¼                  â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Code      â”‚    â”‚    Doc      â”‚    â”‚  External   â”‚         â”‚
â”‚  â”‚   Index     â”‚    â”‚   Index     â”‚    â”‚  Connectors â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                  â”‚                  â”‚                 â”‚
â”‚         â–¼                  â–¼                  â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  TreeSitter â”‚    â”‚  Markdown   â”‚    â”‚ JIRA/Slack  â”‚         â”‚
â”‚  â”‚  + Embeddingsâ”‚   â”‚  + Embeddingsâ”‚   â”‚    APIs     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Query Analyzer</p>
        <p>Interprets natural language queries into structured search operations:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class QueryAnalyzer:
    &quot;&quot;&quot;
    Transforms natural language into search operations.

    Examples:
    - &quot;authentication timeout&quot; â†’ semantic search for concept
    - &quot;function handle_auth&quot; â†’ structural search for symbol
    - &quot;JIRA-123&quot; â†’ literal search + external lookup
    - &quot;where do we validate emails&quot; â†’ hybrid (semantic + structural)
    &quot;&quot;&quot;

    def analyze(self, query: str) -&gt; AnalyzedQuery:
        # Detect query intent
        intent = self._classify_intent(query)  # discovery | impact | history | debug

        # Extract search terms
        terms = self._extract_terms(query)

        # Determine optimal search strategy
        strategy = self._select_strategy(intent, terms)

        return AnalyzedQuery(intent, terms, strategy)</code></pre>
        </div>
        <p>#### 2. Code Index</p>
        <p>Maintains searchable index of codebase:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class CodeIndex:
    &quot;&quot;&quot;
    Multi-layer code index:
    - Symbol index (TreeSitter): functions, classes, variables
    - Semantic index (embeddings): conceptual similarity
    - Literal index (trigram): exact text matching
    - Graph index: call relationships, imports
    &quot;&quot;&quot;

    def __init__(self, root_path: Path, config: IndexConfig):
        self.symbol_index = SymbolIndex(root_path)      # TreeSitter-based
        self.semantic_index = SemanticIndex(root_path)  # Embedding-based
        self.literal_index = LiteralIndex(root_path)    # Trigram-based
        self.graph_index = GraphIndex(root_path)        # Relationship-based

    async def search(self, query: AnalyzedQuery) -&gt; list[CodeMatch]:
        # Execute appropriate indexes based on query strategy
        results = []

        if query.strategy.use_semantic:
            results.extend(await self.semantic_index.search(query.terms))

        if query.strategy.use_structural:
            results.extend(await self.symbol_index.search(query.terms))

        if query.strategy.use_literal:
            results.extend(await self.literal_index.search(query.terms))

        # Enrich with relationships
        for result in results:
            result.relationships = await self.graph_index.get_relationships(result.symbol)

        return results</code></pre>
        </div>
        <p>#### 3. External Connectors</p>
        <p>Integrates with external systems:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ExternalConnectors:
    &quot;&quot;&quot;
    Connectors for external data sources.
    Each connector implements SearchableSource interface.
    &quot;&quot;&quot;

    def __init__(self, config: ConnectorsConfig):
        self.connectors = {}

        if config.jira:
            self.connectors[&#039;jira&#039;] = JiraConnector(config.jira)
        if config.slack:
            self.connectors[&#039;slack&#039;] = SlackConnector(config.slack)
        if config.confluence:
            self.connectors[&#039;confluence&#039;] = ConfluenceConnector(config.confluence)
        if config.github:
            self.connectors[&#039;github&#039;] = GitHubConnector(config.github)

    async def search(self, query: AnalyzedQuery, sources: list[str]) -&gt; list[ExternalMatch]:
        tasks = [
            self.connectors[source].search(query)
            for source in sources
            if source in self.connectors
        ]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        return flatten_valid(results)</code></pre>
        </div>
        <p>#### 4. Result Ranker</p>
        <p>Combines and ranks results from all sources:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ResultRanker:
    &quot;&quot;&quot;
    Ranks and deduplicates results across all sources.
    Uses multiple signals for relevance scoring.
    &quot;&quot;&quot;

    def rank(self, results: list[SearchResult], query: AnalyzedQuery) -&gt; list[SearchResult]:
        for result in results:
            result.relevance_score = self._compute_score(result, query)

        # Sort by relevance
        ranked = sorted(results, key=lambda r: r.relevance_score, reverse=True)

        # Deduplicate (same content from different indexes)
        deduped = self._deduplicate(ranked)

        # Add cross-references between results
        enriched = self._add_cross_references(deduped)

        return enriched

    def _compute_score(self, result: SearchResult, query: AnalyzedQuery) -&gt; float:
        &quot;&quot;&quot;
        Scoring factors:
        - Text similarity (semantic or literal match quality)
        - Recency (recently modified files ranked higher)
        - Centrality (highly connected code ranked higher)
        - Query-type match (structural query + function match = boost)
        &quot;&quot;&quot;
        score = result.base_score
        score *= self._recency_factor(result)
        score *= self._centrality_factor(result)
        score *= self._query_type_factor(result, query)
        return score</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">User Query
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Analyzer  â”‚ â”€â”€ Classify intent, extract terms, select strategy
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Search Executor â”‚ â”€â”€ Fan out to appropriate indexes/connectors
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼         â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Code  â”‚ â”‚ Doc   â”‚ â”‚ JIRA    â”‚ â”‚ Slack  â”‚
â”‚ Index â”‚ â”‚ Index â”‚ â”‚Connectorâ”‚ â”‚Connectorâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚         â”‚          â”‚          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Result Ranker  â”‚ â”€â”€ Combine, rank, dedupe, enrich
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    Final Results</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Module configuration
tool-codebase-search:
  # Indexing configuration
  index:
    root_paths:
      - &quot;.&quot;                           # Current repo
      - &quot;../shared-libs&quot;              # Shared libraries
    exclude_patterns:
      - &quot;node_modules/**&quot;
      - &quot;.git/**&quot;
      - &quot;**/*.min.js&quot;

    # Index types to build
    indexes:
      symbol: true                    # TreeSitter symbol index
      semantic: true                  # Embedding-based semantic index
      literal: true                   # Trigram literal index
      graph: true                     # Call graph index

    # Embedding configuration (for semantic search)
    embeddings:
      model: &quot;text-embedding-3-small&quot; # OpenAI embedding model
      chunk_size: 500                 # Tokens per chunk
      chunk_overlap: 50               # Overlap between chunks

    # Incremental update settings
    update:
      watch: true                     # Watch for file changes
      debounce_ms: 1000               # Debounce rapid changes

  # External connectors
  connectors:
    jira:
      enabled: true
      base_url: &quot;${JIRA_URL}&quot;
      auth_token: &quot;${JIRA_TOKEN}&quot;
      project_keys: [&quot;PROJ&quot;, &quot;PLATFORM&quot;]

    slack:
      enabled: true
      auth_token: &quot;${SLACK_TOKEN}&quot;
      channels: [&quot;#engineering&quot;, &quot;#incidents&quot;]

    github:
      enabled: true
      auth_token: &quot;${GITHUB_TOKEN}&quot;
      include_prs: true
      include_issues: true
      include_discussions: true

  # Search behavior
  search:
    default_scope: &quot;all&quot;
    default_max_results: 10
    context_lines_before: 5
    context_lines_after: 5

    # Ranking weights
    ranking:
      recency_weight: 0.2
      centrality_weight: 0.3
      match_quality_weight: 0.5

    # Performance limits
    timeout_ms: 10000
    max_files_to_scan: 10000

  # Caching
  cache:
    enabled: true
    ttl_seconds: 300                  # Cache results for 5 minutes
    max_entries: 1000</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Natural Language Code Discovery</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;query&quot;: &quot;Where do we validate user email addresses?&quot;,
    &quot;scope&quot;: &quot;code&quot;
}

# Output
{
    &quot;results&quot;: [
        {
            &quot;source_type&quot;: &quot;code&quot;,
            &quot;location&quot;: &quot;src/validators/email.py:42&quot;,
            &quot;snippet&quot;: &quot;def validate_email(email: str) -&gt; ValidationResult:\n    \&quot;\&quot;\&quot;Validates email format and domain.\&quot;\&quot;\&quot;\n    ...&quot;,
            &quot;relevance_score&quot;: 0.95,
            &quot;context&quot;: {
                &quot;file_summary&quot;: &quot;Email validation utilities&quot;,
                &quot;related_symbols&quot;: [&quot;validate_email&quot;, &quot;EmailValidator&quot;, &quot;VALID_DOMAINS&quot;]
            },
            &quot;cross_references&quot;: [
                {&quot;ref_type&quot;: &quot;called_by&quot;, &quot;target&quot;: &quot;src/api/users.py:create_user&quot;, &quot;description&quot;: &quot;Called during user registration&quot;},
                {&quot;ref_type&quot;: &quot;called_by&quot;, &quot;target&quot;: &quot;src/api/settings.py:update_email&quot;, &quot;description&quot;: &quot;Called when updating email&quot;}
            ]
        },
        {
            &quot;source_type&quot;: &quot;code&quot;,
            &quot;location&quot;: &quot;src/models/user.py:78&quot;,
            &quot;snippet&quot;: &quot;@validator(&#039;email&#039;)\ndef email_must_be_valid(cls, v):\n    ...&quot;,
            &quot;relevance_score&quot;: 0.88,
            &quot;context&quot;: {...},
            &quot;cross_references&quot;: [...]
        }
    ],
    &quot;query_interpretation&quot;: &quot;Searching for email validation logic in code&quot;,
    &quot;suggestions&quot;: [&quot;Where do we send verification emails?&quot;, &quot;Email validation rules&quot;]
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Historical Context Search</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;query&quot;: &quot;Why was retry logic added to payment processing?&quot;,
    &quot;scope&quot;: &quot;all&quot;,
    &quot;search_type&quot;: &quot;semantic&quot;
}

# Output
{
    &quot;results&quot;: [
        {
            &quot;source_type&quot;: &quot;ticket&quot;,
            &quot;location&quot;: &quot;JIRA-4523&quot;,
            &quot;snippet&quot;: &quot;Payment failures during peak hours due to gateway timeouts. Adding retry with exponential backoff.&quot;,
            &quot;relevance_score&quot;: 0.92,
            &quot;cross_references&quot;: [
                {&quot;ref_type&quot;: &quot;pr&quot;, &quot;target&quot;: &quot;PR #892&quot;, &quot;description&quot;: &quot;Implementation PR&quot;},
                {&quot;ref_type&quot;: &quot;doc&quot;, &quot;target&quot;: &quot;docs/payments/reliability.md&quot;, &quot;description&quot;: &quot;Documentation&quot;}
            ]
        },
        {
            &quot;source_type&quot;: &quot;discussion&quot;,
            &quot;location&quot;: &quot;slack://engineering/p1699234567&quot;,
            &quot;snippet&quot;: &quot;We&#039;re seeing 5% payment failures during sales events. Gateway is timing out under load...&quot;,
            &quot;relevance_score&quot;: 0.85
        },
        {
            &quot;source_type&quot;: &quot;code&quot;,
            &quot;location&quot;: &quot;src/payments/gateway.py:156&quot;,
            &quot;snippet&quot;: &quot;# Added retry logic per JIRA-4523\n@retry(max_attempts=3, backoff=exponential)\nasync def process_payment(...):&quot;,
            &quot;relevance_score&quot;: 0.78
        }
    ],
    &quot;query_interpretation&quot;: &quot;Searching for historical context about payment retry implementation&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Impact Analysis</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;query&quot;: &quot;What code uses the User.email field?&quot;,
    &quot;search_type&quot;: &quot;structural&quot;
}

# Output
{
    &quot;results&quot;: [
        {
            &quot;source_type&quot;: &quot;code&quot;,
            &quot;location&quot;: &quot;src/models/user.py:23&quot;,
            &quot;snippet&quot;: &quot;email: EmailStr = Field(...)&quot;,
            &quot;relevance_score&quot;: 1.0,
            &quot;cross_references&quot;: [
                {&quot;ref_type&quot;: &quot;read_by&quot;, &quot;target&quot;: &quot;src/api/users.py:45&quot;, &quot;description&quot;: &quot;User profile endpoint&quot;},
                {&quot;ref_type&quot;: &quot;read_by&quot;, &quot;target&quot;: &quot;src/notifications/email.py:12&quot;, &quot;description&quot;: &quot;Email sender&quot;},
                {&quot;ref_type&quot;: &quot;written_by&quot;, &quot;target&quot;: &quot;src/api/users.py:89&quot;, &quot;description&quot;: &quot;Update email endpoint&quot;},
                {&quot;ref_type&quot;: &quot;validated_by&quot;, &quot;target&quot;: &quot;src/validators/email.py:42&quot;, &quot;description&quot;: &quot;Email validator&quot;}
            ]
        }
    ],
    &quot;query_interpretation&quot;: &quot;Structural analysis of User.email field usage&quot;,
    &quot;search_stats&quot;: {
        &quot;files_analyzed&quot;: 234,
        &quot;references_found&quot;: 47,
        &quot;duration_ms&quot;: 156
    }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Access</h4>
        <li><strong>Code access</strong>: Reads files within configured root paths only</li>
        <li><strong>External systems</strong>: Uses configured credentials, respects API permissions</li>
        <li><strong>Cached data</strong>: Cached in memory/disk per configuration, cleared on session end</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Sensitive Data</h4>
        <li><strong>Query logging</strong>: Queries logged to session events (may contain sensitive terms)</li>
        <li><strong>Results</strong>: May contain sensitive code snippets</li>
        <li><strong>Credentials</strong>: External connector credentials stored securely, never logged</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissions Model</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;filesystem:read&quot;,      # Read codebase files
    &quot;network:external&quot;,     # Connect to external APIs (if connectors enabled)
]

# Optional capabilities based on connectors
OPTIONAL_CAPABILITIES = {
    &quot;jira&quot;: &quot;network:jira&quot;,
    &quot;slack&quot;: &quot;network:slack&quot;,
    &quot;github&quot;: &quot;network:github&quot;,
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Risk Mitigations</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Risk</th><th>Mitigation</th></tr>
          </thead>
          <tbody>
            <tr><td>Exposing sensitive code in results</td><td>Results filtered by session's file access permissions</td></tr>
            <tr><td>Credential leakage</td><td>Credentials never included in results or logs</td></tr>
            <tr><td>Excessive resource use</td><td>Configurable timeouts and file limits</td></tr>
            <tr><td>Stale cache serving wrong data</td><td>Cache keyed by query + file hashes, invalidated on changes</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Query analyzer tests
def test_query_analyzer_detects_semantic_intent():
    analyzer = QueryAnalyzer()
    result = analyzer.analyze(&quot;where do we handle authentication&quot;)
    assert result.intent == QueryIntent.DISCOVERY
    assert result.strategy.use_semantic == True

def test_query_analyzer_detects_structural_intent():
    analyzer = QueryAnalyzer()
    result = analyzer.analyze(&quot;function validate_email&quot;)
    assert result.intent == QueryIntent.SYMBOL_LOOKUP
    assert result.strategy.use_structural == True

# Result ranking tests
def test_ranker_prioritizes_recent_files():
    ...

def test_ranker_deduplicates_same_content():
    ...</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Full search flow tests
async def test_semantic_search_finds_relevant_code():
    tool = CodebaseSearchTool(test_config)
    await tool.build_index(TEST_REPO_PATH)

    result = await tool.execute({
        &quot;query&quot;: &quot;email validation&quot;,
        &quot;scope&quot;: &quot;code&quot;
    })

    assert len(result.results) &gt; 0
    assert &quot;validate&quot; in result.results[0].snippet.lower()
    assert &quot;email&quot; in result.results[0].snippet.lower()

async def test_external_connector_integration():
    # Requires mock JIRA/Slack servers
    ...</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Performance Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_search_performance_under_load():
    &quot;&quot;&quot;Search should complete within timeout on large codebase.&quot;&quot;&quot;
    # 100k file synthetic codebase
    result = tool.execute({&quot;query&quot;: &quot;authentication&quot;})
    assert result.search_stats.duration_ms &lt; 10000

def test_index_incremental_update_performance():
    &quot;&quot;&quot;Index update should be fast for single file changes.&quot;&quot;&quot;
    ...</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation Notes</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Index Storage</h4>
        <li>Symbol index: SQLite database with FTS5 for text search</li>
        <li>Semantic index: Vector database (could use Chroma, FAISS, or SQLite with vector extension)</li>
        <li>Graph index: SQLite with adjacency list tables</li>
        <li>All indexes stored in <code>.amplifier/indexes/</code> directory</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Incremental Updates</h4>
        <li>File watcher monitors for changes</li>
        <li>On change: re-index only affected files</li>
        <li>Graph updates propagate to dependent files</li>
        <li>Embedding regeneration batched for efficiency</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Embedding Strategy</h4>
        <li>Code chunked by logical units (functions, classes) when possible</li>
        <li>Fall back to token-based chunking for long files</li>
        <li>Metadata (file path, language, symbols) included in embedding context</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>tree-sitter</code> + language grammars - Code parsing</li>
        <li><code>tiktoken</code> - Token counting for chunking</li>
        <li><code>aiosqlite</code> - Async SQLite for indexes</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional (based on configuration)</h4>
        <li><code>openai</code> - For embeddings (or alternative embedding provider)</li>
        <li><code>chromadb</code> or <code>faiss</code> - For vector search (alternative to SQLite vectors)</li>
        <li><code>jira</code> - JIRA connector</li>
        <li><code>slack-sdk</code> - Slack connector</li>
        <li><code>PyGithub</code> - GitHub connector</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Embedding provider</strong>: Should we support multiple embedding providers or standardize on one?</li>
        <p>   - Option A: OpenAI embeddings only (simpler, consistent quality)</p>
        <p>   - Option B: Pluggable providers (flexibility, cost control)</p>
        <li><strong>Index persistence</strong>: Where should indexes live?</li>
        <p>   - Option A: Project-local (<code>.amplifier/indexes/</code>) - isolated but duplicated</p>
        <p>   - Option B: User-level cache (<code>~/.amplifier/indexes/</code>) - shared but complex invalidation</p>
        <li><strong>Real-time vs batch indexing</strong>: Should we support real-time indexing for very large codebases?</li>
        <p>   - Option A: Always real-time (simpler UX, may be slow)</p>
        <p>   - Option B: Background batch with staleness indicator</p>
        <li><strong>Cross-repo search</strong>: Should a single search span multiple repositories?</li>
        <p>   - Option A: Single repo per search (simpler)</p>
        <p>   - Option B: Multi-repo with repo prefixes (more powerful)</p>
        <li><strong>Result format</strong>: How much context to include by default?</li>
        <p>   - Trade-off: More context = more useful but more tokens consumed</p>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-collaborative" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Collaborative</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-collaborative</code></p>
        </div>
        <h3>Overview</h3>
        <p>A tool for coordinating multiple specialized agents on complex tasks. Enables parallel specialist analysis, hierarchical delegation, and synthesis of multiple perspectives - all invoked as a tool call from the main session.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Why a Tool, Not an Orchestrator?</h4>
        <p>Multi-agent collaboration is <strong>policy</strong> (when to collaborate, which agents, how to synthesize) not <strong>mechanism</strong>. The kernel orchestrator should stay simple (loop-basic/streaming). Sophisticated coordination patterns belong at the tool layer where:</p>
        <li>The agent decides <strong>when</strong> collaboration is valuable</li>
        <li>Collaboration can be <strong>mixed</strong> with normal conversation</li>
        <li>Patterns can <strong>evolve</strong> without touching the kernel</li>
        <li>It <strong>composes</strong> naturally with other tools</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Single generalist perspective</td><td>Multiple specialist perspectives</td></tr>
            <tr><td>Sequential analysis</td><td>Parallel execution</td></tr>
            <tr><td>Manual coordination</td><td>Automated synthesis</td></tr>
            <tr><td>Context overload</td><td>Focused context per specialist</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Main Session (loop-basic)                                      â”‚
â”‚                                                                 â”‚
â”‚  Agent: &quot;This needs multiple perspectives...&quot;                   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â””â”€â–º tool-collaborative.execute(...)                         â”‚
â”‚          â”‚                                                      â”‚
â”‚          â”œâ”€â–º spawn: security-specialist â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚          â”œâ”€â–º spawn: performance-specialist â”€â”€â”€â”¼â”€â–º parallel     â”‚
â”‚          â”œâ”€â–º spawn: maintainability-specialistâ”˜                â”‚
â”‚          â”‚                                                      â”‚
â”‚          â””â”€â–º coordinator synthesizes â”€â”€â–º return result         â”‚
â”‚                                                                 â”‚
â”‚  Agent: &quot;Here&#039;s the comprehensive analysis...&quot;                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Tool Contract</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">name: tool-collaborative
description: Coordinate multiple specialized agents on a task

parameters:
  task:
    type: string
    description: The task for agents to collaborate on
    required: true

  agents:
    type: array
    description: Agent configurations to involve
    required: true
    items:
      type: object
      properties:
        name:
          type: string
          description: Identifier for this agent
        role:
          type: string
          description: The specialist role (e.g., &quot;security&quot;, &quot;performance&quot;)
        config:
          type: object
          description: Agent config (providers, tools, system prompt)
        focus:
          type: string
          description: Specific focus area for this agent

  mode:
    type: string
    enum: [parallel, sequential, hierarchical]
    default: parallel
    description: How agents execute

  synthesis:
    type: string
    enum: [coordinator, vote, merge, best_of]
    default: coordinator
    description: How to combine agent outputs

  coordinator_config:
    type: object
    description: Config for synthesis coordinator (if synthesis=coordinator)

  context:
    type: object
    description: Shared context passed to all agents

returns:
  type: object
  properties:
    result:
      type: string
      description: Synthesized output
    contributions:
      type: array
      description: Individual agent contributions
    consensus:
      type: object
      description: Agreement/disagreement analysis
    metadata:
      type: object
      description: Execution stats (agents, timing, tokens)</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># tool.py

from amplifier_core import AmplifierSession
import asyncio
from dataclasses import dataclass

@dataclass
class Contribution:
    agent: str
    role: str
    response: str
    confidence: float | None = None
    tokens_used: int = 0


class CollaborativeTool:
    &quot;&quot;&quot;Tool for multi-agent collaboration.&quot;&quot;&quot;

    name = &quot;tool-collaborative&quot;

    async def execute(
        self,
        task: str,
        agents: list[dict],
        mode: str = &quot;parallel&quot;,
        synthesis: str = &quot;coordinator&quot;,
        coordinator_config: dict | None = None,
        context: dict | None = None
    ) -&gt; dict:
        &quot;&quot;&quot;Execute collaborative task.&quot;&quot;&quot;

        # Phase 1: Execute agents
        if mode == &quot;parallel&quot;:
            contributions = await self._parallel_execution(task, agents, context)
        elif mode == &quot;sequential&quot;:
            contributions = await self._sequential_execution(task, agents, context)
        else:
            contributions = await self._hierarchical_execution(task, agents, context)

        # Phase 2: Synthesize
        if synthesis == &quot;coordinator&quot;:
            result = await self._coordinator_synthesis(
                task, contributions, coordinator_config
            )
        elif synthesis == &quot;vote&quot;:
            result = await self._voting_synthesis(contributions)
        elif synthesis == &quot;merge&quot;:
            result = await self._merge_synthesis(contributions)
        else:  # best_of
            result = await self._best_of_synthesis(contributions)

        return {
            &quot;result&quot;: result,
            &quot;contributions&quot;: [c.__dict__ for c in contributions],
            &quot;consensus&quot;: self._analyze_consensus(contributions),
            &quot;metadata&quot;: {
                &quot;agents_count&quot;: len(agents),
                &quot;mode&quot;: mode,
                &quot;synthesis&quot;: synthesis,
                &quot;total_tokens&quot;: sum(c.tokens_used for c in contributions)
            }
        }

    async def _parallel_execution(
        self,
        task: str,
        agents: list[dict],
        context: dict | None
    ) -&gt; list[Contribution]:
        &quot;&quot;&quot;Execute all agents in parallel.&quot;&quot;&quot;

        async def run_agent(agent_def: dict) -&gt; Contribution:
            config = self._build_agent_config(agent_def)

            prompt = self._build_agent_prompt(
                task=task,
                role=agent_def.get(&quot;role&quot;, &quot;specialist&quot;),
                focus=agent_def.get(&quot;focus&quot;),
                context=context
            )

            async with AmplifierSession(config=config) as session:
                response = await session.execute(prompt)

                return Contribution(
                    agent=agent_def[&quot;name&quot;],
                    role=agent_def.get(&quot;role&quot;, &quot;specialist&quot;),
                    response=response.text,
                    tokens_used=response.usage.total_tokens
                )

        contributions = await asyncio.gather(*[
            run_agent(agent) for agent in agents
        ])

        return list(contributions)

    async def _sequential_execution(
        self,
        task: str,
        agents: list[dict],
        context: dict | None
    ) -&gt; list[Contribution]:
        &quot;&quot;&quot;Execute agents sequentially, each seeing previous results.&quot;&quot;&quot;

        contributions = []
        accumulated_context = context or {}

        for agent_def in agents:
            config = self._build_agent_config(agent_def)

            # Include previous contributions in context
            prompt = self._build_agent_prompt(
                task=task,
                role=agent_def.get(&quot;role&quot;, &quot;specialist&quot;),
                focus=agent_def.get(&quot;focus&quot;),
                context=accumulated_context,
                previous_contributions=contributions
            )

            async with AmplifierSession(config=config) as session:
                response = await session.execute(prompt)

                contribution = Contribution(
                    agent=agent_def[&quot;name&quot;],
                    role=agent_def.get(&quot;role&quot;, &quot;specialist&quot;),
                    response=response.text,
                    tokens_used=response.usage.total_tokens
                )
                contributions.append(contribution)

                # Add to accumulated context
                accumulated_context[f&quot;{agent_def[&#039;name&#039;]}_analysis&quot;] = response.text

        return contributions

    async def _hierarchical_execution(
        self,
        task: str,
        agents: list[dict],
        context: dict | None
    ) -&gt; list[Contribution]:
        &quot;&quot;&quot;Coordinator delegates subtasks to specialists.&quot;&quot;&quot;

        # First agent is coordinator
        coordinator = agents[0]
        specialists = agents[1:]

        # Coordinator decomposes task
        decomposition = await self._decompose_task(
            task, coordinator, specialists, context
        )

        # Specialists execute their subtasks in parallel
        specialist_tasks = []
        for assignment in decomposition[&quot;assignments&quot;]:
            specialist = next(
                (s for s in specialists if s[&quot;name&quot;] == assignment[&quot;agent&quot;]),
                None
            )
            if specialist:
                specialist_tasks.append(
                    self._run_specialist(assignment[&quot;subtask&quot;], specialist, context)
                )

        specialist_contributions = await asyncio.gather(*specialist_tasks)

        # Coordinator contribution includes orchestration
        coordinator_contribution = Contribution(
            agent=coordinator[&quot;name&quot;],
            role=&quot;coordinator&quot;,
            response=decomposition[&quot;plan&quot;],
            tokens_used=decomposition[&quot;tokens_used&quot;]
        )

        return [coordinator_contribution] + list(specialist_contributions)

    async def _coordinator_synthesis(
        self,
        task: str,
        contributions: list[Contribution],
        coordinator_config: dict | None
    ) -&gt; str:
        &quot;&quot;&quot;Use coordinator agent to synthesize contributions.&quot;&quot;&quot;

        config = coordinator_config or self._default_coordinator_config()

        prompt = f&quot;&quot;&quot;
You are synthesizing contributions from multiple specialist agents.

## Original Task
{task}

## Specialist Contributions

{self._format_contributions(contributions)}

## Your Task
Synthesize these perspectives into a unified, coherent response:
1. Identify key agreements across specialists
2. Highlight important disagreements or tensions
3. Resolve conflicts with reasoned judgment
4. Provide actionable conclusions
5. Note any gaps or areas needing further analysis

Provide a comprehensive synthesis that leverages the strengths of each perspective.
&quot;&quot;&quot;

        async with AmplifierSession(config=config) as session:
            response = await session.execute(prompt)
            return response.text

    async def _voting_synthesis(
        self,
        contributions: list[Contribution]
    ) -&gt; str:
        &quot;&quot;&quot;Synthesize by identifying consensus and majority views.&quot;&quot;&quot;

        # Extract key points from each contribution
        # Identify overlapping conclusions
        # Weight by confidence if available

        consensus_points = self._extract_consensus(contributions)
        disagreements = self._extract_disagreements(contributions)

        return f&quot;&quot;&quot;
## Consensus ({len(consensus_points)} points)
{self._format_points(consensus_points)}

## Divergent Views
{self._format_disagreements(disagreements)}

## Majority Conclusion
{self._determine_majority(contributions)}
&quot;&quot;&quot;

    async def _merge_synthesis(
        self,
        contributions: list[Contribution]
    ) -&gt; str:
        &quot;&quot;&quot;Simple merge of all contributions.&quot;&quot;&quot;

        sections = []
        for c in contributions:
            sections.append(f&quot;### {c.agent} ({c.role})\n\n{c.response}&quot;)

        return &quot;\n\n---\n\n&quot;.join(sections)

    def _build_agent_prompt(
        self,
        task: str,
        role: str,
        focus: str | None,
        context: dict | None,
        previous_contributions: list[Contribution] | None = None
    ) -&gt; str:
        &quot;&quot;&quot;Build prompt for specialist agent.&quot;&quot;&quot;

        prompt_parts = [f&quot;## Task\n{task}&quot;]

        if focus:
            prompt_parts.append(f&quot;## Your Focus\n{focus}&quot;)

        if context:
            prompt_parts.append(f&quot;## Context\n{self._format_context(context)}&quot;)

        if previous_contributions:
            prompt_parts.append(
                f&quot;## Previous Analysis\n{self._format_contributions(previous_contributions)}&quot;
            )

        prompt_parts.append(f&quot;&quot;&quot;
## Instructions
You are a {role} specialist. Analyze the task from your expert perspective.
Provide specific, actionable insights based on your expertise.
Be thorough but focused on your domain.
&quot;&quot;&quot;)

        return &quot;\n\n&quot;.join(prompt_parts)

    def _format_contributions(self, contributions: list[Contribution]) -&gt; str:
        &quot;&quot;&quot;Format contributions for synthesis prompt.&quot;&quot;&quot;

        formatted = []
        for c in contributions:
            formatted.append(f&quot;### {c.agent} ({c.role})\n{c.response}&quot;)
        return &quot;\n\n&quot;.join(formatted)

    def _analyze_consensus(self, contributions: list[Contribution]) -&gt; dict:
        &quot;&quot;&quot;Analyze agreement/disagreement across contributions.&quot;&quot;&quot;

        # Simple heuristic - could be enhanced with AI analysis
        return {
            &quot;agents_count&quot;: len(contributions),
            &quot;has_consensus&quot;: len(contributions) &lt;= 1,  # Placeholder
            &quot;agreement_score&quot;: None,  # Could compute similarity
            &quot;key_agreements&quot;: [],
            &quot;key_disagreements&quot;: []
        }

    def _default_coordinator_config(self) -&gt; dict:
        &quot;&quot;&quot;Default config for synthesis coordinator.&quot;&quot;&quot;

        return {
            &quot;session&quot;: {
                &quot;orchestrator&quot;: &quot;loop-basic&quot;,
                &quot;context&quot;: &quot;context-simple&quot;
            },
            &quot;providers&quot;: [{
                &quot;module&quot;: &quot;provider-anthropic&quot;,
                &quot;source&quot;: &quot;git+https://github.com/microsoft/amplifier-module-provider-anthropic@main&quot;,
                &quot;config&quot;: {
                    &quot;model&quot;: &quot;claude-sonnet-4-5&quot;,
                    &quot;temperature&quot;: 0.3  # Balanced for synthesis
                }
            }]
        }</code></pre>
        </div>
        <p>---</p>
        <h3>Collaboration Modes</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Parallel Mode</h4>
        <p>All agents execute simultaneously, then results synthesized.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Best for: Independent specialist perspectives
mode: parallel

agents:
  - name: security-reviewer
    role: security
    focus: &quot;vulnerabilities, auth, injection&quot;

  - name: performance-reviewer
    role: performance
    focus: &quot;complexity, caching, queries&quot;

  - name: maintainability-reviewer
    role: maintainability
    focus: &quot;patterns, coupling, readability&quot;

synthesis: coordinator</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Sequential Mode</h4>
        <p>Agents execute in order, each seeing previous contributions.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Best for: Building analysis, refinement chains
mode: sequential

agents:
  - name: analyzer
    role: analysis
    focus: &quot;understand the problem&quot;

  - name: designer
    role: design
    focus: &quot;propose solution based on analysis&quot;

  - name: critic
    role: critique
    focus: &quot;evaluate design, find gaps&quot;

  - name: refiner
    role: refinement
    focus: &quot;improve design based on critique&quot;

synthesis: merge  # Keep the chain visible</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hierarchical Mode</h4>
        <p>First agent coordinates, delegates to specialists.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Best for: Complex tasks needing decomposition
mode: hierarchical

agents:
  - name: coordinator
    role: coordinator
    focus: &quot;decompose task, assign to specialists, synthesize&quot;

  - name: backend-specialist
    role: backend
    focus: &quot;API, database, services&quot;

  - name: frontend-specialist
    role: frontend
    focus: &quot;UI, state, components&quot;

  - name: infra-specialist
    role: infrastructure
    focus: &quot;deployment, scaling, monitoring&quot;

synthesis: coordinator  # Coordinator synthesizes at end</code></pre>
        </div>
        <p>---</p>
        <h3>Synthesis Strategies</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Strategy</th><th>Description</th><th>Best For</th></tr>
          </thead>
          <tbody>
            <tr><td><code>coordinator</code></td><td>Dedicated agent synthesizes</td><td>Complex integration, nuanced judgment</td></tr>
            <tr><td><code>vote</code></td><td>Identify consensus/majority</td><td>Clear yes/no decisions</td></tr>
            <tr><td><code>merge</code></td><td>Concatenate all contributions</td><td>Preserving all perspectives</td></tr>
            <tr><td><code>best_of</code></td><td>Select highest quality/confidence</td><td>When one answer needed</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Usage Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">PR Review with Multiple Perspectives</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">result = await tool_collaborative.execute(
    task=f&quot;Review PR #{pr_number}: {pr_description}\n\nDiff:\n{diff}&quot;,
    agents=[
        {
            &quot;name&quot;: &quot;security-reviewer&quot;,
            &quot;role&quot;: &quot;security&quot;,
            &quot;config&quot;: {
                &quot;providers&quot;: [{
                    &quot;module&quot;: &quot;provider-anthropic&quot;,
                    &quot;config&quot;: {&quot;temperature&quot;: 0.1}
                }]
            },
            &quot;focus&quot;: &quot;Security vulnerabilities, auth issues, injection risks&quot;
        },
        {
            &quot;name&quot;: &quot;quality-reviewer&quot;,
            &quot;role&quot;: &quot;code-quality&quot;,
            &quot;config&quot;: {
                &quot;providers&quot;: [{
                    &quot;module&quot;: &quot;provider-anthropic&quot;,
                    &quot;config&quot;: {&quot;temperature&quot;: 0.2}
                }]
            },
            &quot;focus&quot;: &quot;Code patterns, maintainability, SOLID principles&quot;
        },
        {
            &quot;name&quot;: &quot;test-reviewer&quot;,
            &quot;role&quot;: &quot;testing&quot;,
            &quot;focus&quot;: &quot;Test coverage, edge cases, test quality&quot;
        }
    ],
    mode=&quot;parallel&quot;,
    synthesis=&quot;coordinator&quot;
)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Architecture Decision with Debate</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">result = await tool_collaborative.execute(
    task=&quot;Should we use microservices or monolith for the new payment system?&quot;,
    agents=[
        {
            &quot;name&quot;: &quot;microservices-advocate&quot;,
            &quot;role&quot;: &quot;advocate&quot;,
            &quot;focus&quot;: &quot;Argue FOR microservices architecture&quot;
        },
        {
            &quot;name&quot;: &quot;monolith-advocate&quot;,
            &quot;role&quot;: &quot;advocate&quot;,
            &quot;focus&quot;: &quot;Argue FOR monolith architecture&quot;
        },
        {
            &quot;name&quot;: &quot;pragmatist&quot;,
            &quot;role&quot;: &quot;evaluator&quot;,
            &quot;focus&quot;: &quot;Evaluate both arguments, consider team context&quot;
        }
    ],
    mode=&quot;sequential&quot;,  # Each sees previous arguments
    synthesis=&quot;coordinator&quot;,
    coordinator_config={
        &quot;providers&quot;: [{
            &quot;module&quot;: &quot;provider-anthropic&quot;,
            &quot;config&quot;: {
                &quot;model&quot;: &quot;claude-opus-4&quot;,  # Strong reasoning for decision
                &quot;temperature&quot;: 0.3
            }
        }]
    },
    context={
        &quot;team_size&quot;: 8,
        &quot;timeline&quot;: &quot;6 months&quot;,
        &quot;scale_requirements&quot;: &quot;10k requests/day initially&quot;
    }
)</code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>tool:collaborative:start</code></td><td>Collaboration started</td><td>task, agents, mode</td></tr>
            <tr><td><code>tool:collaborative:agent:start</code></td><td>Agent execution started</td><td>agent, role</td></tr>
            <tr><td><code>tool:collaborative:agent:complete</code></td><td>Agent finished</td><td>agent, tokens</td></tr>
            <tr><td><code>tool:collaborative:synthesis:start</code></td><td>Synthesis started</td><td>strategy</td></tr>
            <tr><td><code>tool:collaborative:complete</code></td><td>Collaboration complete</td><td>agents_count, total_tokens</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tools:
  - module: tool-collaborative
    source: git+https://github.com/microsoft/amplifier-module-tool-collaborative@main
    config:
      # Defaults
      default_mode: parallel
      default_synthesis: coordinator

      # Limits
      max_agents: 5
      max_parallel: 3
      agent_timeout: 300s

      # Coordinator defaults
      coordinator:
        model: claude-sonnet-4-5
        temperature: 0.3</code></pre>
        </div>
        <p>---</p>
        <h3>Comparison with Recipes</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Aspect</th><th>tool-collaborative</th><th>recipes</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Pattern</strong></td><td>Parallel specialists</td><td>Sequential steps</td></tr>
            <tr><td><strong>Agents</strong></td><td>Multiple simultaneous</td><td>One per step</td></tr>
            <tr><td><strong>Context flow</strong></td><td>Shared to all</td><td>Accumulated step-by-step</td></tr>
            <tr><td><strong>Best for</strong></td><td>Multiple perspectives</td><td>Linear workflows</td></tr>
            <tr><td><strong>Synthesis</strong></td><td>Built-in coordinator</td><td>Final step handles it</td></tr>
          </tbody>
        </table>
        <p>Both are tools that spawn sub-agents. Use recipes for workflows, collaborative for multi-perspective analysis.</p>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li>amplifier-core (AmplifierSession for sub-agents)</li>
        <li>asyncio (parallel execution)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>None</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Confidence scoring</strong>: Should agents report confidence levels?</li>
        <li><strong>Disagreement resolution</strong>: Automated resolution or surface to user?</li>
        <li><strong>Cost optimization</strong>: Route simpler subtasks to cheaper models?</li>
        <li><strong>Caching</strong>: Cache specialist results for similar tasks?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification (converted from orchestrator to tool)</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-dependency-graph" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Dependency Graph</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-dependency-graph</code></p>
        </div>
        <h3>Overview</h3>
        <p>Analyzes and visualizes code dependencies at multiple levels: imports, function calls, class inheritance, and module relationships. Essential for impact analysis, refactoring planning, and understanding complex codebases.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual tracing through files to find callers</td><td><code>get_callers("PaymentGateway.process")</code> â†’ instant list</td></tr>
            <tr><td>Risky refactoring without knowing impact</td><td>"What breaks if I change this?" â†’ complete dependency tree</td></tr>
            <tr><td>Circular dependency surprises at runtime</td><td>Static analysis catches cycles before they cause problems</td></tr>
            <tr><td>Architecture documentation always stale</td><td>Live dependency graphs always current</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Impact analysis</strong>: "What code is affected if I change this function?"</li>
        <li><strong>Refactoring safety</strong>: "Can I safely rename/move this class?"</li>
        <li><strong>Dead code detection</strong>: "What code has no callers?"</li>
        <li><strong>Architecture visualization</strong>: "Show me the dependency structure of this module"</li>
        <li><strong>Circular dependency detection</strong>: "Are there any circular imports?"</li>
        <li><strong>Coupling analysis</strong>: "Which modules are most tightly coupled?"</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;dependency_graph&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Analyze code dependencies: imports, calls, inheritance, and module relationships.

    Operations:
    - get_dependents: What depends on this symbol/file? (callers, importers)
    - get_dependencies: What does this symbol/file depend on? (callees, imports)
    - get_graph: Full dependency graph for a scope
    - find_cycles: Detect circular dependencies
    - find_dead_code: Find code with no dependents
    - coupling_analysis: Measure coupling between modules

    Use for impact analysis, refactoring, and architecture understanding.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;operation&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;get_dependents&quot;, &quot;get_dependencies&quot;, &quot;get_graph&quot;, &quot;find_cycles&quot;, &quot;find_dead_code&quot;, &quot;coupling_analysis&quot;],
                &quot;description&quot;: &quot;Analysis operation to perform&quot;
            },
            &quot;target&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Symbol (function, class) or file path to analyze&quot;
            },
            &quot;scope&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Limit analysis to path pattern (e.g., &#039;src/&#039;, &#039;**/*.py&#039;)&quot;
            },
            &quot;depth&quot;: {
                &quot;type&quot;: &quot;integer&quot;,
                &quot;default&quot;: 3,
                &quot;description&quot;: &quot;Maximum depth for recursive analysis&quot;
            },
            &quot;include_external&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: false,
                &quot;description&quot;: &quot;Include external library dependencies&quot;
            },
            &quot;dependency_types&quot;: {
                &quot;type&quot;: &quot;array&quot;,
                &quot;items&quot;: {
                    &quot;type&quot;: &quot;string&quot;,
                    &quot;enum&quot;: [&quot;import&quot;, &quot;call&quot;, &quot;inheritance&quot;, &quot;type_reference&quot;, &quot;all&quot;]
                },
                &quot;default&quot;: [&quot;all&quot;],
                &quot;description&quot;: &quot;Types of dependencies to include&quot;
            },
            &quot;output_format&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;tree&quot;, &quot;list&quot;, &quot;graph&quot;, &quot;mermaid&quot;],
                &quot;default&quot;: &quot;tree&quot;,
                &quot;description&quot;: &quot;Output format for results&quot;
            }
        },
        &quot;required&quot;: [&quot;operation&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Input Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class DependencyGraphInput:
    operation: Operation                # get_dependents | get_dependencies | get_graph | find_cycles | find_dead_code | coupling_analysis
    target: str | None = None           # Symbol or file path
    scope: str | None = None            # Path pattern to limit analysis
    depth: int = 3                       # Max recursion depth
    include_external: bool = False       # Include third-party dependencies
    dependency_types: list[str] = field(default_factory=lambda: [&quot;all&quot;])
    output_format: str = &quot;tree&quot;          # tree | list | graph | mermaid</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class DependencyGraphOutput:
    operation: str
    target: str | None

    # For get_dependents/get_dependencies
    dependencies: list[Dependency] | None = None

    # For get_graph
    graph: DependencyGraph | None = None

    # For find_cycles
    cycles: list[Cycle] | None = None

    # For find_dead_code
    dead_code: list[DeadCode] | None = None

    # For coupling_analysis
    coupling: CouplingAnalysis | None = None

    # Formatted output
    formatted: str | None = None         # Formatted per output_format

    # Stats
    stats: AnalysisStats

@dataclass
class Dependency:
    source: Symbol                       # Where the dependency originates
    target: Symbol                       # What it depends on
    type: str                            # import | call | inheritance | type_reference
    location: Location                   # File and line
    context: str | None                  # Code snippet showing the dependency

@dataclass
class Symbol:
    name: str                            # Function/class/module name
    qualified_name: str                  # Full path (module.Class.method)
    kind: str                            # function | class | module | variable
    file_path: str
    line_number: int

@dataclass
class Location:
    file_path: str
    line_number: int
    column: int | None = None

@dataclass
class DependencyGraph:
    nodes: list[GraphNode]
    edges: list[GraphEdge]
    root: str | None                     # Root node if tree structure

@dataclass
class GraphNode:
    id: str                              # Unique identifier
    symbol: Symbol
    metadata: dict                       # Additional info (size, complexity, etc.)

@dataclass
class GraphEdge:
    source_id: str
    target_id: str
    type: str
    weight: int = 1                      # Number of dependencies of this type

@dataclass
class Cycle:
    path: list[str]                      # Symbols in the cycle
    type: str                            # import | call
    severity: str                        # error | warning (import cycles more severe)

@dataclass
class DeadCode:
    symbol: Symbol
    kind: str                            # function | class | module | variable
    reason: str                          # &quot;No callers found&quot;, &quot;Only test references&quot;, etc.
    confidence: float                    # 0-1 confidence this is truly dead

@dataclass
class CouplingAnalysis:
    module_pairs: list[ModuleCoupling]
    metrics: CouplingMetrics

@dataclass
class ModuleCoupling:
    module_a: str
    module_b: str
    coupling_score: float                # 0-1, higher = more coupled
    dependency_count: int
    bidirectional: bool                  # Both depend on each other

@dataclass
class CouplingMetrics:
    average_coupling: float
    max_coupling: float
    highly_coupled_pairs: int            # Pairs above threshold
    suggested_refactors: list[str]       # Suggestions to reduce coupling

@dataclass
class AnalysisStats:
    files_analyzed: int
    symbols_found: int
    dependencies_found: int
    analysis_time_ms: int</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>tool:dependency_graph:start</code></td><td>Analysis begins</td><td>operation, target, scope</td></tr>
            <tr><td><code>tool:dependency_graph:parsing</code></td><td>File parsing</td><td>file_path, symbols_found</td></tr>
            <tr><td><code>tool:dependency_graph:complete</code></td><td>Analysis done</td><td>stats</td></tr>
            <tr><td><code>tool:dependency_graph:error</code></td><td>Analysis failed</td><td>error_type, message</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    tool-dependency-graph                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Symbol    â”‚â”€â”€â”€â–¶â”‚   Graph     â”‚â”€â”€â”€â–¶â”‚   Output    â”‚         â”‚
â”‚  â”‚  Resolver   â”‚    â”‚   Builder   â”‚    â”‚  Formatter  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                            â”‚                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â–¼                  â–¼                  â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Python    â”‚    â”‚ TypeScript  â”‚    â”‚    Other    â”‚         â”‚
â”‚  â”‚   Analyzer  â”‚    â”‚  Analyzer   â”‚    â”‚  Analyzers  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                  â”‚                  â”‚                 â”‚
â”‚         â–¼                  â–¼                  â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚              TreeSitter Parsers                 â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Language-Specific Analyzers</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class PythonAnalyzer:
    &quot;&quot;&quot;
    Python-specific dependency analysis using TreeSitter and AST.
    &quot;&quot;&quot;

    def __init__(self):
        self.parser = TreeSitterParser(&quot;python&quot;)

    async def analyze_file(self, file_path: Path) -&gt; FileAnalysis:
        content = file_path.read_text()
        tree = self.parser.parse(content)

        analysis = FileAnalysis(file_path=str(file_path))

        # Extract symbols (functions, classes, variables)
        analysis.symbols = self._extract_symbols(tree, file_path)

        # Extract imports
        analysis.imports = self._extract_imports(tree)

        # Extract function calls
        analysis.calls = self._extract_calls(tree)

        # Extract inheritance
        analysis.inheritance = self._extract_inheritance(tree)

        # Extract type hints
        analysis.type_refs = self._extract_type_references(tree)

        return analysis

    def _extract_imports(self, tree: Tree) -&gt; list[ImportDep]:
        &quot;&quot;&quot;Extract all import statements.&quot;&quot;&quot;
        imports = []

        # import x, import x.y
        for node in self._find_nodes(tree, &quot;import_statement&quot;):
            module = self._get_module_name(node)
            imports.append(ImportDep(
                module=module,
                names=None,  # Imports whole module
                location=self._get_location(node)
            ))

        # from x import y, z
        for node in self._find_nodes(tree, &quot;import_from_statement&quot;):
            module = self._get_from_module(node)
            names = self._get_imported_names(node)
            imports.append(ImportDep(
                module=module,
                names=names,
                location=self._get_location(node)
            ))

        return imports

    def _extract_calls(self, tree: Tree) -&gt; list[CallDep]:
        &quot;&quot;&quot;Extract all function/method calls.&quot;&quot;&quot;
        calls = []

        for node in self._find_nodes(tree, &quot;call&quot;):
            callee = self._resolve_callee(node)
            if callee:
                calls.append(CallDep(
                    caller=self._get_enclosing_function(node),
                    callee=callee,
                    location=self._get_location(node)
                ))

        return calls</code></pre>
        </div>
        <p>#### 2. Graph Builder</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class GraphBuilder:
    &quot;&quot;&quot;
    Builds dependency graph from file analyses.
    Handles cross-file resolution and graph algorithms.
    &quot;&quot;&quot;

    def __init__(self, analyses: list[FileAnalysis]):
        self.analyses = {a.file_path: a for a in analyses}
        self.symbol_index = self._build_symbol_index()

    def get_dependents(self, target: str, depth: int, types: list[str]) -&gt; list[Dependency]:
        &quot;&quot;&quot;Find all symbols that depend on target.&quot;&quot;&quot;
        target_symbol = self._resolve_symbol(target)
        if not target_symbol:
            raise ValueError(f&quot;Symbol not found: {target}&quot;)

        dependents = []
        visited = set()

        self._find_dependents_recursive(
            target_symbol, depth, types, dependents, visited
        )

        return dependents

    def get_dependencies(self, target: str, depth: int, types: list[str]) -&gt; list[Dependency]:
        &quot;&quot;&quot;Find all symbols that target depends on.&quot;&quot;&quot;
        target_symbol = self._resolve_symbol(target)
        if not target_symbol:
            raise ValueError(f&quot;Symbol not found: {target}&quot;)

        dependencies = []
        visited = set()

        self._find_dependencies_recursive(
            target_symbol, depth, types, dependencies, visited
        )

        return dependencies

    def find_cycles(self, scope: str | None = None) -&gt; list[Cycle]:
        &quot;&quot;&quot;Detect circular dependencies.&quot;&quot;&quot;
        # Build directed graph
        graph = self._build_adjacency_graph(scope)

        # Find strongly connected components (Tarjan&#039;s algorithm)
        sccs = self._find_sccs(graph)

        # SCCs with more than one node are cycles
        cycles = []
        for scc in sccs:
            if len(scc) &gt; 1:
                cycles.append(Cycle(
                    path=scc,
                    type=self._determine_cycle_type(scc),
                    severity=&quot;error&quot; if self._is_import_cycle(scc) else &quot;warning&quot;
                ))

        return cycles

    def find_dead_code(self, scope: str | None = None) -&gt; list[DeadCode]:
        &quot;&quot;&quot;Find symbols with no dependents.&quot;&quot;&quot;
        dead = []

        for symbol in self._get_symbols_in_scope(scope):
            # Skip entry points and special methods
            if self._is_entry_point(symbol):
                continue

            dependents = self.get_dependents(symbol.qualified_name, depth=1, types=[&quot;all&quot;])

            # Filter out test-only references
            non_test_dependents = [d for d in dependents if not self._is_test_file(d.source.file_path)]

            if not non_test_dependents:
                confidence = 1.0
                reason = &quot;No callers found&quot;

                # Lower confidence if there are test references
                if dependents:
                    confidence = 0.7
                    reason = &quot;Only test references&quot;

                # Lower confidence for certain patterns (callbacks, plugins)
                if self._might_be_dynamic(symbol):
                    confidence = 0.5
                    reason += &quot; (may be used dynamically)&quot;

                dead.append(DeadCode(
                    symbol=symbol,
                    kind=symbol.kind,
                    reason=reason,
                    confidence=confidence
                ))

        return dead

    def coupling_analysis(self, scope: str | None = None) -&gt; CouplingAnalysis:
        &quot;&quot;&quot;Analyze module coupling.&quot;&quot;&quot;
        modules = self._get_modules_in_scope(scope)
        pairs = []

        for i, mod_a in enumerate(modules):
            for mod_b in modules[i+1:]:
                # Count dependencies between modules
                a_to_b = self._count_dependencies(mod_a, mod_b)
                b_to_a = self._count_dependencies(mod_b, mod_a)

                if a_to_b &gt; 0 or b_to_a &gt; 0:
                    total = a_to_b + b_to_a
                    # Normalize by module sizes
                    coupling_score = self._calculate_coupling_score(mod_a, mod_b, total)

                    pairs.append(ModuleCoupling(
                        module_a=mod_a,
                        module_b=mod_b,
                        coupling_score=coupling_score,
                        dependency_count=total,
                        bidirectional=a_to_b &gt; 0 and b_to_a &gt; 0
                    ))

        # Sort by coupling score
        pairs.sort(key=lambda p: p.coupling_score, reverse=True)

        return CouplingAnalysis(
            module_pairs=pairs,
            metrics=self._calculate_metrics(pairs)
        )</code></pre>
        </div>
        <p>#### 3. Output Formatter</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class OutputFormatter:
    &quot;&quot;&quot;Format analysis results for different output formats.&quot;&quot;&quot;

    def format(self, result: Any, format: str) -&gt; str:
        formatters = {
            &quot;tree&quot;: self._format_tree,
            &quot;list&quot;: self._format_list,
            &quot;graph&quot;: self._format_graph_json,
            &quot;mermaid&quot;: self._format_mermaid,
        }
        return formatters[format](result)

    def _format_tree(self, dependencies: list[Dependency]) -&gt; str:
        &quot;&quot;&quot;Format as indented tree.&quot;&quot;&quot;
        lines = []

        def add_node(dep: Dependency, depth: int):
            indent = &quot;  &quot; * depth
            prefix = &quot;â”œâ”€â”€ &quot; if depth &gt; 0 else &quot;&quot;
            lines.append(f&quot;{indent}{prefix}{dep.target.name} ({dep.type})&quot;)
            lines.append(f&quot;{indent}    â””â”€â”€ {dep.location.file_path}:{dep.location.line_number}&quot;)

        for dep in dependencies:
            add_node(dep, 0)

        return &quot;\n&quot;.join(lines)

    def _format_mermaid(self, graph: DependencyGraph) -&gt; str:
        &quot;&quot;&quot;Format as Mermaid diagram.&quot;&quot;&quot;
        lines = [&quot;graph TD&quot;]

        # Add nodes
        for node in graph.nodes:
            label = f&quot;{node.symbol.name}&quot;
            lines.append(f&quot;    {node.id}[{label}]&quot;)

        # Add edges
        for edge in graph.edges:
            arrow = &quot;--&gt;&quot; if edge.type == &quot;call&quot; else &quot;-.-&gt;|{edge.type}|&quot;
            lines.append(f&quot;    {edge.source_id} {arrow} {edge.target_id}&quot;)

        return &quot;\n&quot;.join(lines)</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-dependency-graph:
  # Analysis settings
  analysis:
    # Languages to analyze (auto-detected if not specified)
    languages:
      - python
      - typescript
      - javascript

    # File patterns to include
    include_patterns:
      - &quot;**/*.py&quot;
      - &quot;**/*.ts&quot;
      - &quot;**/*.tsx&quot;
      - &quot;**/*.js&quot;
      - &quot;**/*.jsx&quot;

    # Patterns to exclude
    exclude_patterns:
      - &quot;node_modules/**&quot;
      - &quot;.venv/**&quot;
      - &quot;**/__pycache__/**&quot;
      - &quot;**/dist/**&quot;
      - &quot;**/*.test.*&quot;
      - &quot;**/*.spec.*&quot;

    # External dependencies
    include_external: false
    external_packages:
      # Packages to always exclude from analysis
      exclude:
        - &quot;typing&quot;
        - &quot;typing_extensions&quot;
        - &quot;builtins&quot;

  # Graph building
  graph:
    # Maximum depth for recursive analysis
    default_depth: 3
    max_depth: 10

    # Entry points (roots for dead code detection)
    entry_points:
      patterns:
        - &quot;**/main.py&quot;
        - &quot;**/cli.py&quot;
        - &quot;**/__main__.py&quot;
        - &quot;**/index.ts&quot;
      functions:
        - &quot;main&quot;
        - &quot;cli&quot;
        - &quot;app&quot;

    # Symbols to exclude from dead code detection
    exclude_from_dead_code:
      patterns:
        - &quot;__*__&quot;           # Dunder methods
        - &quot;test_*&quot;          # Test functions
        - &quot;*_test&quot;
      decorators:
        - &quot;@app.route&quot;      # Flask routes
        - &quot;@pytest.fixture&quot; # Pytest fixtures
        - &quot;@click.command&quot;  # CLI commands

  # Output
  output:
    default_format: &quot;tree&quot;

    # Mermaid diagram settings
    mermaid:
      direction: &quot;TD&quot;       # TB, TD, LR, RL
      max_nodes: 50         # Limit for readability

  # Caching
  cache:
    enabled: true
    ttl_seconds: 300
    invalidate_on_file_change: true</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Impact Analysis</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;get_dependents&quot;,
    &quot;target&quot;: &quot;PaymentGateway.process&quot;,
    &quot;depth&quot;: 2,
    &quot;output_format&quot;: &quot;tree&quot;
}

# Output
{
    &quot;operation&quot;: &quot;get_dependents&quot;,
    &quot;target&quot;: &quot;PaymentGateway.process&quot;,
    &quot;dependencies&quot;: [
        {
            &quot;source&quot;: {&quot;name&quot;: &quot;OrderService.checkout&quot;, &quot;file_path&quot;: &quot;src/orders/service.py&quot;},
            &quot;target&quot;: {&quot;name&quot;: &quot;PaymentGateway.process&quot;, &quot;file_path&quot;: &quot;src/payments/gateway.py&quot;},
            &quot;type&quot;: &quot;call&quot;,
            &quot;location&quot;: {&quot;file_path&quot;: &quot;src/orders/service.py&quot;, &quot;line_number&quot;: 89}
        },
        {
            &quot;source&quot;: {&quot;name&quot;: &quot;SubscriptionRenewer.renew&quot;, &quot;file_path&quot;: &quot;src/subscriptions/renewer.py&quot;},
            &quot;target&quot;: {&quot;name&quot;: &quot;PaymentGateway.process&quot;, &quot;file_path&quot;: &quot;src/payments/gateway.py&quot;},
            &quot;type&quot;: &quot;call&quot;,
            &quot;location&quot;: {&quot;file_path&quot;: &quot;src/subscriptions/renewer.py&quot;, &quot;line_number&quot;: 45}
        }
    ],
    &quot;formatted&quot;: &quot;PaymentGateway.process\nâ”œâ”€â”€ OrderService.checkout (call)\nâ”‚   â””â”€â”€ src/orders/service.py:89\nâ”œâ”€â”€ SubscriptionRenewer.renew (call)\nâ”‚   â””â”€â”€ src/subscriptions/renewer.py:45&quot;,
    &quot;stats&quot;: {
        &quot;files_analyzed&quot;: 45,
        &quot;symbols_found&quot;: 234,
        &quot;dependencies_found&quot;: 2,
        &quot;analysis_time_ms&quot;: 156
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Circular Dependency Detection</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;find_cycles&quot;,
    &quot;scope&quot;: &quot;src/&quot;,
    &quot;dependency_types&quot;: [&quot;import&quot;]
}

# Output
{
    &quot;operation&quot;: &quot;find_cycles&quot;,
    &quot;cycles&quot;: [
        {
            &quot;path&quot;: [&quot;src/models/user.py&quot;, &quot;src/services/auth.py&quot;, &quot;src/models/session.py&quot;, &quot;src/models/user.py&quot;],
            &quot;type&quot;: &quot;import&quot;,
            &quot;severity&quot;: &quot;error&quot;
        }
    ],
    &quot;formatted&quot;: &quot;Circular import detected:\n  src/models/user.py\n  â†’ src/services/auth.py\n  â†’ src/models/session.py\n  â†’ src/models/user.py (cycle)&quot;,
    &quot;stats&quot;: {...}
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Coupling Analysis</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;coupling_analysis&quot;,
    &quot;scope&quot;: &quot;src/&quot;
}

# Output
{
    &quot;operation&quot;: &quot;coupling_analysis&quot;,
    &quot;coupling&quot;: {
        &quot;module_pairs&quot;: [
            {
                &quot;module_a&quot;: &quot;src/orders&quot;,
                &quot;module_b&quot;: &quot;src/payments&quot;,
                &quot;coupling_score&quot;: 0.85,
                &quot;dependency_count&quot;: 23,
                &quot;bidirectional&quot;: true
            },
            {
                &quot;module_a&quot;: &quot;src/users&quot;,
                &quot;module_b&quot;: &quot;src/auth&quot;,
                &quot;coupling_score&quot;: 0.72,
                &quot;dependency_count&quot;: 18,
                &quot;bidirectional&quot;: false
            }
        ],
        &quot;metrics&quot;: {
            &quot;average_coupling&quot;: 0.34,
            &quot;max_coupling&quot;: 0.85,
            &quot;highly_coupled_pairs&quot;: 2,
            &quot;suggested_refactors&quot;: [
                &quot;Consider extracting shared types between src/orders and src/payments&quot;,
                &quot;src/payments depends heavily on src/orders internals - consider interface extraction&quot;
            ]
        }
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 4: Mermaid Architecture Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;get_graph&quot;,
    &quot;scope&quot;: &quot;src/api/&quot;,
    &quot;depth&quot;: 1,
    &quot;output_format&quot;: &quot;mermaid&quot;
}

# Output
{
    &quot;operation&quot;: &quot;get_graph&quot;,
    &quot;graph&quot;: {...},
    &quot;formatted&quot;: &quot;graph TD\n    api_users[users.py]\n    api_orders[orders.py]\n    api_payments[payments.py]\n    svc_user[UserService]\n    svc_order[OrderService]\n    api_users --&gt; svc_user\n    api_orders --&gt; svc_order\n    api_orders --&gt; svc_user\n    api_payments --&gt; svc_order&quot;
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Access</h4>
        <li>Reads source files within configured scope</li>
        <li>Does not execute code, only static analysis</li>
        <li>No network access required</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Risks</h4>
        <li>Large codebases may consume significant memory</li>
        <li>Analysis results may reveal code structure</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;filesystem:read&quot;,      # Read source files
]</code></pre>
        </div>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_python_analyzer_extracts_imports():
    analyzer = PythonAnalyzer()
    code = &quot;from foo.bar import baz, qux&quot;
    analysis = analyzer.analyze_string(code)

    assert len(analysis.imports) == 1
    assert analysis.imports[0].module == &quot;foo.bar&quot;
    assert analysis.imports[0].names == [&quot;baz&quot;, &quot;qux&quot;]

def test_cycle_detection_finds_cycles():
    builder = GraphBuilder([
        FileAnalysis(&quot;a.py&quot;, imports=[ImportDep(&quot;b&quot;)]),
        FileAnalysis(&quot;b.py&quot;, imports=[ImportDep(&quot;c&quot;)]),
        FileAnalysis(&quot;c.py&quot;, imports=[ImportDep(&quot;a&quot;)]),
    ])

    cycles = builder.find_cycles()
    assert len(cycles) == 1
    assert set(cycles[0].path) == {&quot;a.py&quot;, &quot;b.py&quot;, &quot;c.py&quot;}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_real_codebase_analysis():
    tool = DependencyGraphTool(config)
    result = await tool.execute({
        &quot;operation&quot;: &quot;get_dependents&quot;,
        &quot;target&quot;: &quot;test_function&quot;,
        &quot;scope&quot;: &quot;tests/fixtures/&quot;
    })

    assert result.stats.files_analyzed &gt; 0
    # Known fixture has specific dependencies
    assert len(result.dependencies) == 3</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>tree-sitter</code> - Language parsing</li>
        <li><code>tree-sitter-python</code> - Python grammar</li>
        <li><code>tree-sitter-typescript</code> - TypeScript grammar</li>
        <li><code>tree-sitter-javascript</code> - JavaScript grammar</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>Additional language grammars as needed</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Language support priority</strong>: Which languages beyond Python/TypeScript?</li>
        <p>   - Go, Rust, Java are common enterprise languages</p>
        <p>   - Each requires grammar and analyzer implementation</p>
        <li><strong>Dynamic dependencies</strong>: How to handle dynamic imports/calls?</li>
        <p>   - <code>importlib.import_module()</code>, <code>getattr()</code>, etc.</p>
        <p>   - Could warn about detected dynamic patterns</p>
        <li><strong>Cross-repository analysis</strong>: Should we support analyzing dependencies across repos?</li>
        <p>   - Useful for microservices</p>
        <p>   - Significantly increases complexity</p>
        <li><strong>Incremental updates</strong>: How to efficiently update graph on file changes?</li>
        <p>   - Full rebuild vs incremental</p>
        <p>   - Trade-off: complexity vs performance</p>
        <li><strong>Visual output</strong>: Should we generate SVG/PNG diagrams?</li>
        <p>   - Mermaid can be rendered by many tools</p>
        <p>   - Direct image generation adds dependencies</p>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-feature-flag" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Feature Flag</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Enhancement)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-feature-flag</code></p>
        </div>
        <h3>Overview</h3>
        <p>Manage feature flags across the codebase. Check flag status, toggle flags, analyze flag usage and debt, and manage flag lifecycle from creation to cleanup.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Check multiple dashboards for flag status</td><td>"Is dark-mode enabled for 10% of users?" â†’ instant answer</td></tr>
            <tr><td>Old flags accumulate forever</td><td>Automated flag debt detection and cleanup reminders</td></tr>
            <tr><td>Flag changes require dashboard access</td><td>Toggle flags from your workflow</td></tr>
            <tr><td>Unknown flag coverage</td><td>See exactly which code paths are flagged</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Flag status</strong>: Check if a flag is enabled and for whom</li>
        <li><strong>Flag management</strong>: Create, toggle, archive flags</li>
        <li><strong>Debt detection</strong>: Find stale flags ready for cleanup</li>
        <li><strong>Code analysis</strong>: Find all code paths controlled by a flag</li>
        <li><strong>Impact assessment</strong>: What happens if we toggle this flag?</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;feature_flag&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Manage feature flags and analyze flag usage.

    Operations:
    - status: Check flag status and targeting
    - toggle: Enable/disable flag or change targeting
    - list: List all flags with status
    - analyze: Find flag usage in code
    - debt: Identify stale flags for cleanup
    - create: Create new flag
    - archive: Archive/delete flag

    Supports: LaunchDarkly, Split, Unleash, ConfigCat, custom systems.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;operation&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;status&quot;, &quot;toggle&quot;, &quot;list&quot;, &quot;analyze&quot;, &quot;debt&quot;, &quot;create&quot;, &quot;archive&quot;],
                &quot;description&quot;: &quot;Operation to perform&quot;
            },
            &quot;flag_key&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Flag key/name&quot;
            },
            &quot;environment&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;default&quot;: &quot;production&quot;,
                &quot;description&quot;: &quot;Environment (production, staging, development)&quot;
            },
            &quot;targeting&quot;: {
                &quot;type&quot;: &quot;object&quot;,
                &quot;description&quot;: &quot;Targeting rules for toggle operation&quot;
            },
            &quot;include_code_references&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: false,
                &quot;description&quot;: &quot;Include code locations using this flag&quot;
            }
        },
        &quot;required&quot;: [&quot;operation&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class FeatureFlagOutput:
    operation: str

    # For status
    flag_status: FlagStatus | None = None

    # For list
    flags: list[FlagSummary] | None = None

    # For analyze
    code_references: list[CodeReference] | None = None

    # For debt
    stale_flags: list[StaleFlag] | None = None

@dataclass
class FlagStatus:
    key: str
    name: str
    description: str | None
    kind: str                           # boolean | multivariate | string | number

    # Status per environment
    environments: dict[str, EnvironmentStatus]

    # Metadata
    created_at: datetime
    updated_at: datetime
    created_by: str
    tags: list[str]

    # Usage stats
    evaluation_count_24h: int | None
    unique_users_24h: int | None

    # Code references (if requested)
    code_references: list[CodeReference] | None

@dataclass
class EnvironmentStatus:
    enabled: bool
    targeting: TargetingRules | None
    percentage_rollout: float | None    # 0-100 for percentage rollouts
    default_value: Any

@dataclass
class TargetingRules:
    rules: list[TargetingRule]
    fallthrough: Any                    # Default when no rules match

@dataclass
class TargetingRule:
    description: str
    clauses: list[TargetClause]         # AND conditions
    variation: Any                      # Value when rule matches

@dataclass
class TargetClause:
    attribute: str                      # user attribute to check
    operator: str                       # equals | contains | startsWith | in | etc.
    values: list[Any]

@dataclass
class CodeReference:
    file_path: str
    line_number: int
    code_snippet: str
    context: str                        # function/class containing the reference
    type: str                           # check | variation | default

@dataclass
class FlagSummary:
    key: str
    name: str
    enabled_environments: list[str]
    age_days: int
    evaluation_count_7d: int
    stale_score: float                  # 0-1, higher = more stale

@dataclass
class StaleFlag:
    key: str
    name: str
    age_days: int
    last_modified: datetime
    reasons: list[str]                  # Why it&#039;s considered stale
    code_references: list[CodeReference]
    recommendation: str                 # &quot;remove&quot;, &quot;review&quot;, &quot;keep&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Platform Adapters</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class LaunchDarklyAdapter:
    &quot;&quot;&quot;Adapter for LaunchDarkly.&quot;&quot;&quot;

    async def get_flag(self, key: str) -&gt; FlagStatus:
        flag = await self.client.get_flag(self.project_key, key)

        environments = {}
        for env_key, env_config in flag.environments.items():
            environments[env_key] = EnvironmentStatus(
                enabled=env_config.on,
                targeting=self._parse_targeting(env_config.rules),
                percentage_rollout=self._extract_percentage(env_config.fallthrough),
                default_value=env_config.off_variation
            )

        return FlagStatus(
            key=flag.key,
            name=flag.name,
            description=flag.description,
            kind=flag.kind,
            environments=environments,
            created_at=flag.creation_date,
            updated_at=flag.last_modified,
            tags=flag.tags
        )

    async def toggle(self, key: str, environment: str, enabled: bool) -&gt; None:
        patch = [{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: f&quot;/environments/{environment}/on&quot;, &quot;value&quot;: enabled}]
        await self.client.patch_flag(self.project_key, key, patch)


class CodeAnalyzer:
    &quot;&quot;&quot;Find flag usage in code.&quot;&quot;&quot;

    async def find_references(self, flag_key: str) -&gt; list[CodeReference]:
        references = []

        # Search patterns for common flag SDKs
        patterns = [
            f&#039;variation\\([&quot;\\&#039;]{flag_key}[&quot;\\&#039;&#039;,      # variation(&quot;flag&quot;)
            f&#039;is_enabled\\([&quot;\\&#039;]{flag_key}[&quot;\\&#039;&#039;,     # is_enabled(&quot;flag&quot;)
            f&#039;get_flag\\([&quot;\\&#039;]{flag_key}[&quot;\\&#039;&#039;,       # get_flag(&quot;flag&quot;)
            f&#039;flag\\([&quot;\\&#039;]{flag_key}[&quot;\\&#039;&#039;,           # flag(&quot;flag&quot;)
            f&#039;[&quot;\\&#039;]{flag_key}[&quot;\\&#039;\\s*\\]&#039;,           # flags[&quot;flag&quot;]
        ]

        for pattern in patterns:
            matches = await self._grep(pattern)
            for match in matches:
                references.append(CodeReference(
                    file_path=match.file_path,
                    line_number=match.line_number,
                    code_snippet=match.line,
                    context=await self._get_context(match),
                    type=self._classify_reference(match.line)
                ))

        return references


class FlagDebtAnalyzer:
    &quot;&quot;&quot;Identify stale flags for cleanup.&quot;&quot;&quot;

    async def analyze(self) -&gt; list[StaleFlag]:
        flags = await self.adapter.list_flags()
        stale = []

        for flag in flags:
            reasons = []
            stale_score = 0.0

            # Age-based staleness
            if flag.age_days &gt; 180:
                reasons.append(f&quot;Flag is {flag.age_days} days old&quot;)
                stale_score += 0.3

            # No recent evaluations
            if flag.evaluation_count_7d == 0:
                reasons.append(&quot;No evaluations in last 7 days&quot;)
                stale_score += 0.3

            # Fully rolled out (100% on)
            if self._is_fully_rolled_out(flag):
                reasons.append(&quot;Flag is 100% enabled everywhere&quot;)
                stale_score += 0.2

            # Fully rolled back (100% off)
            if self._is_fully_rolled_back(flag):
                reasons.append(&quot;Flag is disabled everywhere&quot;)
                stale_score += 0.2

            # No code references
            refs = await self.code_analyzer.find_references(flag.key)
            if not refs:
                reasons.append(&quot;No code references found&quot;)
                stale_score += 0.2

            if stale_score &gt; 0.4:
                stale.append(StaleFlag(
                    key=flag.key,
                    name=flag.name,
                    age_days=flag.age_days,
                    last_modified=flag.updated_at,
                    reasons=reasons,
                    code_references=refs,
                    recommendation=self._recommend_action(stale_score, refs)
                ))

        return sorted(stale, key=lambda f: -f.age_days)</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Check Flag Status</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;status&quot;,
    &quot;flag_key&quot;: &quot;new-checkout-flow&quot;,
    &quot;include_code_references&quot;: true
}

# Output
{
    &quot;flag_status&quot;: {
        &quot;key&quot;: &quot;new-checkout-flow&quot;,
        &quot;name&quot;: &quot;New Checkout Flow&quot;,
        &quot;description&quot;: &quot;Redesigned checkout experience with fewer steps&quot;,
        &quot;kind&quot;: &quot;boolean&quot;,
        &quot;environments&quot;: {
            &quot;production&quot;: {
                &quot;enabled&quot;: true,
                &quot;percentage_rollout&quot;: 25.0,
                &quot;targeting&quot;: {
                    &quot;rules&quot;: [
                        {
                            &quot;description&quot;: &quot;Beta users&quot;,
                            &quot;clauses&quot;: [{&quot;attribute&quot;: &quot;beta&quot;, &quot;operator&quot;: &quot;equals&quot;, &quot;values&quot;: [true]}],
                            &quot;variation&quot;: true
                        }
                    ],
                    &quot;fallthrough&quot;: &quot;percentage&quot;
                }
            },
            &quot;staging&quot;: {
                &quot;enabled&quot;: true,
                &quot;percentage_rollout&quot;: 100.0
            }
        },
        &quot;evaluation_count_24h&quot;: 45230,
        &quot;unique_users_24h&quot;: 12500,
        &quot;code_references&quot;: [
            {
                &quot;file_path&quot;: &quot;src/checkout/flow.py&quot;,
                &quot;line_number&quot;: 42,
                &quot;code_snippet&quot;: &quot;if flag_client.variation(&#039;new-checkout-flow&#039;, user):&quot;,
                &quot;context&quot;: &quot;CheckoutController.process&quot;
            }
        ]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Find Stale Flags</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;debt&quot;
}

# Output
{
    &quot;stale_flags&quot;: [
        {
            &quot;key&quot;: &quot;holiday-banner-2023&quot;,
            &quot;name&quot;: &quot;Holiday Banner 2023&quot;,
            &quot;age_days&quot;: 412,
            &quot;last_modified&quot;: &quot;2023-01-15T10:00:00Z&quot;,
            &quot;reasons&quot;: [
                &quot;Flag is 412 days old&quot;,
                &quot;No evaluations in last 7 days&quot;,
                &quot;Flag is disabled everywhere&quot;
            ],
            &quot;code_references&quot;: [
                {
                    &quot;file_path&quot;: &quot;src/components/Banner.tsx&quot;,
                    &quot;line_number&quot;: 15,
                    &quot;code_snippet&quot;: &quot;const showHoliday = useFlag(&#039;holiday-banner-2023&#039;)&quot;
                }
            ],
            &quot;recommendation&quot;: &quot;remove&quot;
        },
        {
            &quot;key&quot;: &quot;payment-v2&quot;,
            &quot;name&quot;: &quot;Payment V2&quot;,
            &quot;age_days&quot;: 245,
            &quot;reasons&quot;: [
                &quot;Flag is 245 days old&quot;,
                &quot;Flag is 100% enabled everywhere&quot;
            ],
            &quot;recommendation&quot;: &quot;remove (clean up code references first)&quot;
        }
    ]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-feature-flag:
  # Platform configuration
  platform: launchdarkly              # launchdarkly | split | unleash | configcat

  launchdarkly:
    api_key: &quot;${LD_API_KEY}&quot;
    project_key: &quot;default&quot;

  # Code analysis
  code_analysis:
    include_patterns:
      - &quot;**/*.py&quot;
      - &quot;**/*.ts&quot;
      - &quot;**/*.tsx&quot;
      - &quot;**/*.js&quot;
    exclude_patterns:
      - &quot;**/node_modules/**&quot;
      - &quot;**/*.test.*&quot;

  # Staleness thresholds
  staleness:
    age_warning_days: 90
    age_error_days: 180
    no_evaluation_days: 7</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Requires API access to feature flag platform</li>
        <li>Can toggle flags (affects production behavior)</li>
        <li>Should require approval for production toggles</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li>Platform-specific SDK (launchdarkly-api, etc.)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>None</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Toggle approval</strong>: Require approval for production toggles?</li>
        <li><strong>Audit logging</strong>: Log all flag operations?</li>
        <li><strong>Automated cleanup</strong>: Auto-archive stale flags?</li>
        <li><strong>Cross-environment sync</strong>: Help sync targeting across environments?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-git-advanced" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Git Advanced</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-git-advanced</code></p>
        </div>
        <h3>Overview</h3>
        <p>Advanced git operations beyond basic add/commit/push. Provides contextual blame, history analysis, branch management, and intelligent merge conflict assistance. Designed for complex codebase navigation and workflow automation.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td><code>git blame</code> shows who, not why</td><td>Contextual blame links to PR, ticket, and discussion</td></tr>
            <tr><td>Manual branch cleanup</td><td>Intelligent stale branch detection and cleanup</td></tr>
            <tr><td>Merge conflicts are painful</td><td>AI-assisted conflict resolution with context</td></tr>
            <tr><td>History is hard to navigate</td><td>Semantic search through commit history</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Contextual blame</strong>: "Who changed this and why?" with full context</li>
        <li><strong>History search</strong>: "When did we change the auth timeout?"</li>
        <li><strong>Branch management</strong>: Clean up stale branches, find related branches</li>
        <li><strong>Conflict resolution</strong>: Understand both sides of a conflict with context</li>
        <li><strong>Bisect assistance</strong>: Help find which commit introduced a bug</li>
        <li><strong>Cherry-pick planning</strong>: Identify commits to backport</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;git_advanced&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Advanced git operations with contextual information.

    Operations:
    - blame: Contextual blame with PR/ticket links
    - history: Search commit history semantically
    - branches: List, analyze, and manage branches
    - conflicts: Analyze merge conflicts with context
    - bisect: Assisted bisection to find bug introduction
    - cherry_pick_plan: Plan cherry-picks for backporting
    - diff_analysis: Analyze changes between refs

    Use for understanding code history and managing complex git workflows.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;operation&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;blame&quot;, &quot;history&quot;, &quot;branches&quot;, &quot;conflicts&quot;, &quot;bisect&quot;, &quot;cherry_pick_plan&quot;, &quot;diff_analysis&quot;],
                &quot;description&quot;: &quot;Git operation to perform&quot;
            },
            &quot;file_path&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;File path for blame/history operations&quot;
            },
            &quot;line_range&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Line range for blame (e.g., &#039;10-20&#039;, &#039;42&#039;)&quot;
            },
            &quot;query&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Search query for history operation&quot;
            },
            &quot;ref&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Git ref (branch, tag, commit) for operations&quot;
            },
            &quot;base_ref&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Base ref for diff/comparison operations&quot;
            },
            &quot;include_context&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: true,
                &quot;description&quot;: &quot;Include PR/ticket context in results&quot;
            },
            &quot;max_results&quot;: {
                &quot;type&quot;: &quot;integer&quot;,
                &quot;default&quot;: 20,
                &quot;description&quot;: &quot;Maximum results for search operations&quot;
            }
        },
        &quot;required&quot;: [&quot;operation&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class GitAdvancedOutput:
    operation: str

    # For blame
    blame_results: list[BlameEntry] | None = None

    # For history
    commits: list[EnrichedCommit] | None = None

    # For branches
    branches: BranchAnalysis | None = None

    # For conflicts
    conflicts: list[ConflictAnalysis] | None = None

    # For diff_analysis
    diff: DiffAnalysis | None = None

@dataclass
class BlameEntry:
    line_start: int
    line_end: int
    content: str                        # The actual code lines

    # Git info
    commit_sha: str
    author: str
    author_date: datetime
    commit_message: str

    # Context (if include_context=True)
    pr_number: int | None
    pr_title: str | None
    ticket_key: str | None
    ticket_title: str | None
    discussion_summary: str | None      # AI-summarized context

@dataclass
class EnrichedCommit:
    sha: str
    short_sha: str
    author: str
    author_email: str
    date: datetime
    message: str
    body: str | None

    # Stats
    files_changed: int
    insertions: int
    deletions: int

    # Context
    pr_number: int | None
    ticket_keys: list[str]
    tags: list[str]                     # Tags pointing to this commit

    # Relevance (for search)
    relevance_score: float | None

@dataclass
class BranchAnalysis:
    current: str
    local_branches: list[BranchInfo]
    remote_branches: list[BranchInfo]
    stale_branches: list[BranchInfo]    # No commits in X days
    merged_branches: list[BranchInfo]   # Already merged to main

@dataclass
class BranchInfo:
    name: str
    last_commit_date: datetime
    last_commit_sha: str
    last_commit_message: str
    ahead_of_main: int
    behind_main: int
    author: str                         # Most recent committer
    pr_status: str | None               # open | merged | closed | none

@dataclass
class ConflictAnalysis:
    file_path: str
    conflict_type: str                  # content | rename | delete
    ours_summary: str                   # What our side changed
    theirs_summary: str                 # What their side changed
    suggested_resolution: str | None    # AI suggestion if clear
    context: ConflictContext

@dataclass
class ConflictContext:
    ours_commits: list[str]             # Commits on our side
    theirs_commits: list[str]           # Commits on their side
    common_ancestor: str
    ours_pr: int | None
    theirs_pr: int | None</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      tool-git-advanced                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Operation  â”‚â”€â”€â”€â–¶â”‚    Git      â”‚â”€â”€â”€â–¶â”‚  Context    â”‚         â”‚
â”‚  â”‚  Dispatcher â”‚    â”‚   Engine    â”‚    â”‚  Enricher   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                            â”‚                  â”‚                 â”‚
â”‚                            â–¼                  â–¼                 â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                     â”‚   GitPython â”‚    â”‚   GitHub    â”‚         â”‚
â”‚                     â”‚   / libgit2 â”‚    â”‚   Client    â”‚         â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Blame with Context</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ContextualBlame:
    &quot;&quot;&quot;Blame with PR and ticket context.&quot;&quot;&quot;

    async def blame(
        self,
        file_path: str,
        line_range: tuple[int, int] | None = None,
        include_context: bool = True
    ) -&gt; list[BlameEntry]:
        # Get raw blame
        raw_blame = await self.git.blame(file_path, line_range)

        # Group consecutive lines with same commit
        entries = self._group_blame_entries(raw_blame)

        if include_context:
            # Enrich with PR/ticket context
            for entry in entries:
                entry.pr_number, entry.pr_title = await self._find_pr_for_commit(entry.commit_sha)
                entry.ticket_key, entry.ticket_title = await self._find_ticket_for_commit(entry.commit_sha)

                # Generate discussion summary if we have context
                if entry.pr_number or entry.ticket_key:
                    entry.discussion_summary = await self._summarize_context(entry)

        return entries

    async def _find_pr_for_commit(self, sha: str) -&gt; tuple[int | None, str | None]:
        &quot;&quot;&quot;Find PR that introduced this commit.&quot;&quot;&quot;
        # Check if commit message references PR
        commit = await self.git.get_commit(sha)
        pr_match = re.search(r&#039;#(\d+)&#039;, commit.message)
        if pr_match:
            pr_num = int(pr_match.group(1))
            pr = await self.github.get_pr(pr_num)
            return pr_num, pr.title

        # Search GitHub for PR containing this commit
        prs = await self.github.search_prs_for_commit(sha)
        if prs:
            return prs[0].number, prs[0].title

        return None, None</code></pre>
        </div>
        <p>#### 2. History Search</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class HistorySearch:
    &quot;&quot;&quot;Semantic search through commit history.&quot;&quot;&quot;

    async def search(
        self,
        query: str,
        file_path: str | None = None,
        max_results: int = 20
    ) -&gt; list[EnrichedCommit]:
        # Get commit log
        commits = await self.git.log(
            path=file_path,
            max_count=1000  # Search through recent history
        )

        # Score commits by relevance
        scored = []
        for commit in commits:
            score = self._score_commit(commit, query)
            if score &gt; 0.3:  # Minimum relevance threshold
                scored.append((commit, score))

        # Sort by relevance
        scored.sort(key=lambda x: x[1], reverse=True)

        # Enrich top results
        results = []
        for commit, score in scored[:max_results]:
            enriched = await self._enrich_commit(commit)
            enriched.relevance_score = score
            results.append(enriched)

        return results

    def _score_commit(self, commit: Commit, query: str) -&gt; float:
        &quot;&quot;&quot;Score commit relevance to query.&quot;&quot;&quot;
        query_lower = query.lower()
        score = 0.0

        # Message match
        if query_lower in commit.message.lower():
            score += 0.5
        elif any(word in commit.message.lower() for word in query_lower.split()):
            score += 0.3

        # File path match (if commit touches relevant files)
        for file in commit.files:
            if query_lower in file.lower():
                score += 0.2
                break

        # Ticket reference match
        ticket_match = re.search(r&#039;([A-Z]+-\d+)&#039;, commit.message)
        if ticket_match and query_lower in ticket_match.group(1).lower():
            score += 0.4

        return min(score, 1.0)</code></pre>
        </div>
        <p>#### 3. Conflict Analysis</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ConflictAnalyzer:
    &quot;&quot;&quot;Analyze and assist with merge conflicts.&quot;&quot;&quot;

    async def analyze_conflicts(self) -&gt; list[ConflictAnalysis]:
        # Get list of conflicted files
        conflicted = await self.git.get_conflicted_files()

        analyses = []
        for file_path in conflicted:
            analysis = await self._analyze_file_conflict(file_path)
            analyses.append(analysis)

        return analyses

    async def _analyze_file_conflict(self, file_path: str) -&gt; ConflictAnalysis:
        # Get conflict markers and content
        content = await self.git.get_file_with_conflicts(file_path)
        ours, theirs, base = self._parse_conflict_regions(content)

        # Get commits involved
        ours_commits = await self.git.log(f&quot;MERGE_HEAD..HEAD&quot;, path=file_path)
        theirs_commits = await self.git.log(f&quot;HEAD..MERGE_HEAD&quot;, path=file_path)

        # Summarize changes
        ours_summary = self._summarize_changes(base, ours)
        theirs_summary = self._summarize_changes(base, theirs)

        # Try to suggest resolution
        suggestion = await self._suggest_resolution(ours, theirs, base, ours_summary, theirs_summary)

        return ConflictAnalysis(
            file_path=file_path,
            conflict_type=self._detect_conflict_type(content),
            ours_summary=ours_summary,
            theirs_summary=theirs_summary,
            suggested_resolution=suggestion,
            context=ConflictContext(
                ours_commits=[c.sha for c in ours_commits],
                theirs_commits=[c.sha for c in theirs_commits],
                common_ancestor=await self.git.merge_base(&quot;HEAD&quot;, &quot;MERGE_HEAD&quot;),
                ours_pr=await self._find_pr_for_branch(&quot;HEAD&quot;),
                theirs_pr=await self._find_pr_for_branch(&quot;MERGE_HEAD&quot;)
            )
        )

    async def _suggest_resolution(
        self,
        ours: str,
        theirs: str,
        base: str,
        ours_summary: str,
        theirs_summary: str
    ) -&gt; str | None:
        &quot;&quot;&quot;Suggest resolution if changes don&#039;t truly conflict.&quot;&quot;&quot;

        # Case 1: One side is superset of other
        if theirs in ours:
            return f&quot;Keep ours - already includes their changes&quot;
        if ours in theirs:
            return f&quot;Keep theirs - already includes our changes&quot;

        # Case 2: Changes to different parts (textual conflict but logical merge possible)
        if self._changes_are_independent(ours, theirs, base):
            return f&quot;Both changes are independent - combine both&quot;

        # Case 3: Need manual resolution
        return None</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-git-advanced:
  # Git settings
  git:
    repo_path: &quot;.&quot;                      # Repository root

  # Context enrichment
  context:
    enabled: true
    github_token: &quot;${GITHUB_TOKEN}&quot;     # For PR lookups
    jira_token: &quot;${JIRA_TOKEN}&quot;         # For ticket lookups

    # Ticket patterns to recognize in commit messages
    ticket_patterns:
      - &quot;[A-Z]{2,10}-\\d+&quot;              # JIRA-style

  # History search
  history:
    max_commits_to_search: 1000
    relevance_threshold: 0.3

  # Branch management
  branches:
    stale_days: 30                      # Days without commits = stale
    protected_branches:
      - main
      - master
      - develop
      - release/*

  # Conflict resolution
  conflicts:
    enable_suggestions: true
    ai_assisted: true                   # Use AI for complex conflicts</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Contextual Blame</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;blame&quot;,
    &quot;file_path&quot;: &quot;src/payments/gateway.py&quot;,
    &quot;line_range&quot;: &quot;42-50&quot;,
    &quot;include_context&quot;: true
}

# Output
{
    &quot;operation&quot;: &quot;blame&quot;,
    &quot;blame_results&quot;: [
        {
            &quot;line_start&quot;: 42,
            &quot;line_end&quot;: 48,
            &quot;content&quot;: &quot;@retry(max_attempts=3)\nasync def process_payment(...):\n    ...&quot;,
            &quot;commit_sha&quot;: &quot;abc123&quot;,
            &quot;author&quot;: &quot;alice&quot;,
            &quot;author_date&quot;: &quot;2024-01-15T10:30:00Z&quot;,
            &quot;commit_message&quot;: &quot;Add retry logic to payment gateway\n\nCloses JIRA-4523&quot;,
            &quot;pr_number&quot;: 892,
            &quot;pr_title&quot;: &quot;Add retry logic to payment gateway&quot;,
            &quot;ticket_key&quot;: &quot;JIRA-4523&quot;,
            &quot;ticket_title&quot;: &quot;Payment failures during peak hours&quot;,
            &quot;discussion_summary&quot;: &quot;Added retry with exponential backoff after 5% payment failures during Black Friday. Team decided on 3 retries max to avoid customer confusion.&quot;
        }
    ]
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: History Search</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;history&quot;,
    &quot;query&quot;: &quot;authentication timeout&quot;,
    &quot;max_results&quot;: 5
}

# Output
{
    &quot;operation&quot;: &quot;history&quot;,
    &quot;commits&quot;: [
        {
            &quot;sha&quot;: &quot;def456&quot;,
            &quot;short_sha&quot;: &quot;def456&quot;,
            &quot;author&quot;: &quot;bob&quot;,
            &quot;date&quot;: &quot;2024-01-10T14:20:00Z&quot;,
            &quot;message&quot;: &quot;Increase auth session timeout to 30 minutes\n\nPer JIRA-4400&quot;,
            &quot;files_changed&quot;: 2,
            &quot;insertions&quot;: 5,
            &quot;deletions&quot;: 2,
            &quot;pr_number&quot;: 845,
            &quot;ticket_keys&quot;: [&quot;JIRA-4400&quot;],
            &quot;relevance_score&quot;: 0.92
        },
        {
            &quot;sha&quot;: &quot;ghi789&quot;,
            &quot;author&quot;: &quot;carol&quot;,
            &quot;date&quot;: &quot;2023-12-15T09:00:00Z&quot;,
            &quot;message&quot;: &quot;Fix authentication timeout race condition&quot;,
            &quot;relevance_score&quot;: 0.78
        }
    ]
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Conflict Analysis</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;conflicts&quot;
}

# Output
{
    &quot;operation&quot;: &quot;conflicts&quot;,
    &quot;conflicts&quot;: [
        {
            &quot;file_path&quot;: &quot;src/config/settings.py&quot;,
            &quot;conflict_type&quot;: &quot;content&quot;,
            &quot;ours_summary&quot;: &quot;Added PAYMENT_TIMEOUT setting&quot;,
            &quot;theirs_summary&quot;: &quot;Added AUTH_TIMEOUT setting&quot;,
            &quot;suggested_resolution&quot;: &quot;Both changes are independent - combine both&quot;,
            &quot;context&quot;: {
                &quot;ours_commits&quot;: [&quot;abc123&quot;],
                &quot;theirs_commits&quot;: [&quot;def456&quot;],
                &quot;common_ancestor&quot;: &quot;base00&quot;,
                &quot;ours_pr&quot;: 900,
                &quot;theirs_pr&quot;: 901
            }
        }
    ]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Reads git history (may contain sensitive commit messages)</li>
        <li>Connects to GitHub API (uses provided token)</li>
        <li>Does not modify repository (read-only operations)</li>
        <li>Credentials never logged or returned</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>gitpython</code> - Git operations</li>
        <li><code>httpx</code> - HTTP client for GitHub API</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>libgit2</code> / <code>pygit2</code> - Alternative git backend (faster for large repos)</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Git provider support</strong>: GitHub-specific or support GitLab/Bitbucket?</li>
        <li><strong>Large repo performance</strong>: How to handle repos with millions of commits?</li>
        <li><strong>Conflict resolution</strong>: How much AI assistance for complex conflicts?</li>
        <li><strong>Branch operations</strong>: Should we support branch deletion/creation?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-jira-ops" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Jira Ops</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-jira-ops</code></p>
        </div>
        <h3>Overview</h3>
        <p>Comprehensive JIRA operations including creating, updating, querying, and linking issues. Enables workflow automation and tight integration between code work and ticket management.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Switch to browser, find project, create ticket, copy ID back</td><td><code>create_issue("Bug in auth", type="bug")</code> returns PROJ-456</td></tr>
            <tr><td>Manual status updates forgotten during coding flow</td><td>Automatic status transitions as work progresses</td></tr>
            <tr><td>Lost context between code and tickets</td><td>Bidirectional linking between commits/PRs and tickets</td></tr>
            <tr><td>Searching JIRA's clunky UI</td><td>JQL queries from your workflow</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Issue creation</strong>: Create tickets from code context (bugs found, tasks identified)</li>
        <li><strong>Status management</strong>: Transition tickets as work progresses</li>
        <li><strong>Query & search</strong>: Find relevant tickets by JQL, assignee, sprint, etc.</li>
        <li><strong>Linking</strong>: Link issues to PRs, commits, other issues</li>
        <li><strong>Bulk operations</strong>: Update multiple tickets (sprint planning, grooming)</li>
        <li><strong>Time tracking</strong>: Log work against tickets</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;jira_ops&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    JIRA operations: create, update, query, and link issues.

    Operations:
    - create: Create new issue (bug, story, task, etc.)
    - update: Update issue fields (status, assignee, description, etc.)
    - transition: Move issue through workflow (To Do â†’ In Progress â†’ Done)
    - query: Search issues using JQL
    - get: Get single issue details
    - link: Link issues together or to external resources
    - comment: Add comment to issue
    - log_work: Log time against issue

    Use for ticket management without leaving your workflow.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;operation&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;create&quot;, &quot;update&quot;, &quot;transition&quot;, &quot;query&quot;, &quot;get&quot;, &quot;link&quot;, &quot;comment&quot;, &quot;log_work&quot;],
                &quot;description&quot;: &quot;Operation to perform&quot;
            },
            &quot;issue_key&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Issue key (e.g., PROJ-123). Required for update/transition/get/link/comment/log_work.&quot;
            },
            &quot;project&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Project key for create operation&quot;
            },
            &quot;issue_type&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;bug&quot;, &quot;story&quot;, &quot;task&quot;, &quot;epic&quot;, &quot;subtask&quot;],
                &quot;description&quot;: &quot;Issue type for create operation&quot;
            },
            &quot;summary&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Issue summary/title&quot;
            },
            &quot;description&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Issue description (supports JIRA markdown)&quot;
            },
            &quot;fields&quot;: {
                &quot;type&quot;: &quot;object&quot;,
                &quot;description&quot;: &quot;Additional fields to set (assignee, priority, labels, custom fields, etc.)&quot;
            },
            &quot;transition&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Transition name for transition operation (e.g., &#039;Start Progress&#039;, &#039;Done&#039;)&quot;
            },
            &quot;jql&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;JQL query for query operation&quot;
            },
            &quot;link_type&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Link type (blocks, is blocked by, relates to, etc.)&quot;
            },
            &quot;link_target&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Target issue key or URL for linking&quot;
            },
            &quot;comment&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Comment text for comment operation&quot;
            },
            &quot;time_spent&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Time spent for log_work (e.g., &#039;2h&#039;, &#039;30m&#039;, &#039;1d&#039;)&quot;
            },
            &quot;max_results&quot;: {
                &quot;type&quot;: &quot;integer&quot;,
                &quot;default&quot;: 20,
                &quot;description&quot;: &quot;Maximum results for query operation&quot;
            }
        },
        &quot;required&quot;: [&quot;operation&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Input Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class JiraOpsInput:
    operation: Operation                # create | update | transition | query | get | link | comment | log_work

    # Issue identification
    issue_key: str | None = None        # Required for most ops except create/query
    project: str | None = None          # Required for create

    # Issue content
    issue_type: IssueType | None = None
    summary: str | None = None
    description: str | None = None
    fields: dict | None = None          # Additional/custom fields

    # Operation-specific
    transition: str | None = None       # For transition op
    jql: str | None = None              # For query op
    link_type: str | None = None        # For link op
    link_target: str | None = None      # For link op
    comment: str | None = None          # For comment op
    time_spent: str | None = None       # For log_work op

    # Query options
    max_results: int = 20</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class JiraOpsOutput:
    success: bool
    operation: str

    # For create/update/get operations
    issue: JiraIssue | None = None

    # For query operation
    issues: list[JiraIssue] | None = None
    total_count: int | None = None

    # For transition operation
    available_transitions: list[Transition] | None = None

    # Operation metadata
    message: str | None = None

@dataclass
class JiraIssue:
    key: str                            # PROJ-123
    id: str                             # Internal ID
    self_url: str                       # API URL

    # Core fields
    summary: str
    description: str | None
    issue_type: str
    status: str
    priority: str | None

    # People
    assignee: str | None
    reporter: str

    # Dates
    created: datetime
    updated: datetime
    resolved: datetime | None
    due_date: date | None

    # Organization
    project: str
    labels: list[str]
    components: list[str]
    sprint: str | None
    epic: str | None                    # Epic key if linked

    # Links
    links: list[IssueLink]
    subtasks: list[str]                 # Subtask keys
    parent: str | None                  # Parent key if subtask

    # Custom fields (project-specific)
    custom_fields: dict[str, Any]

    # Computed
    url: str                            # Browser URL

@dataclass
class IssueLink:
    type: str                           # &quot;blocks&quot;, &quot;is blocked by&quot;, etc.
    direction: str                      # &quot;inward&quot; | &quot;outward&quot;
    target_key: str
    target_summary: str
    target_status: str

@dataclass
class Transition:
    id: str
    name: str                           # &quot;Start Progress&quot;, &quot;Done&quot;, etc.
    to_status: str                      # Target status name</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>tool:jira:start</code></td><td>Operation begins</td><td>operation, issue_key, project</td></tr>
            <tr><td><code>tool:jira:api_call</code></td><td>JIRA API call</td><td>endpoint, method, duration_ms</td></tr>
            <tr><td><code>tool:jira:created</code></td><td>Issue created</td><td>issue_key, project, issue_type</td></tr>
            <tr><td><code>tool:jira:updated</code></td><td>Issue updated</td><td>issue_key, fields_changed</td></tr>
            <tr><td><code>tool:jira:transitioned</code></td><td>Status changed</td><td>issue_key, from_status, to_status</td></tr>
            <tr><td><code>tool:jira:complete</code></td><td>Operation done</td><td>operation, success</td></tr>
            <tr><td><code>tool:jira:error</code></td><td>Operation failed</td><td>error_type, message</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        tool-jira-ops                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Operation  â”‚â”€â”€â”€â–¶â”‚    JIRA     â”‚â”€â”€â”€â–¶â”‚   Result    â”‚         â”‚
â”‚  â”‚  Dispatcher â”‚    â”‚   Client    â”‚    â”‚   Mapper    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                            â”‚                                    â”‚
â”‚                            â–¼                                    â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                     â”‚   Field     â”‚                             â”‚
â”‚                     â”‚  Resolver   â”‚                             â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Operation Dispatcher</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class OperationDispatcher:
    &quot;&quot;&quot;Routes operations to appropriate handlers.&quot;&quot;&quot;

    async def dispatch(self, input: JiraOpsInput) -&gt; JiraOpsOutput:
        handlers = {
            &quot;create&quot;: self._handle_create,
            &quot;update&quot;: self._handle_update,
            &quot;transition&quot;: self._handle_transition,
            &quot;query&quot;: self._handle_query,
            &quot;get&quot;: self._handle_get,
            &quot;link&quot;: self._handle_link,
            &quot;comment&quot;: self._handle_comment,
            &quot;log_work&quot;: self._handle_log_work,
        }

        handler = handlers.get(input.operation)
        if not handler:
            raise ValueError(f&quot;Unknown operation: {input.operation}&quot;)

        return await handler(input)

    async def _handle_create(self, input: JiraOpsInput) -&gt; JiraOpsOutput:
        # Validate required fields
        if not input.project:
            raise ValueError(&quot;project required for create&quot;)
        if not input.summary:
            raise ValueError(&quot;summary required for create&quot;)

        # Resolve field IDs (custom fields, etc.)
        fields = await self.field_resolver.resolve(input.project, {
            &quot;project&quot;: {&quot;key&quot;: input.project},
            &quot;issuetype&quot;: {&quot;name&quot;: input.issue_type or &quot;Task&quot;},
            &quot;summary&quot;: input.summary,
            &quot;description&quot;: input.description,
            **(input.fields or {})
        })

        # Create issue
        result = await self.client.create_issue(fields)

        return JiraOpsOutput(
            success=True,
            operation=&quot;create&quot;,
            issue=self.result_mapper.map_issue(result),
            message=f&quot;Created {result[&#039;key&#039;]}&quot;
        )

    async def _handle_transition(self, input: JiraOpsInput) -&gt; JiraOpsOutput:
        if not input.issue_key:
            raise ValueError(&quot;issue_key required for transition&quot;)

        # Get available transitions
        transitions = await self.client.get_transitions(input.issue_key)

        if not input.transition:
            # Just return available transitions
            return JiraOpsOutput(
                success=True,
                operation=&quot;transition&quot;,
                available_transitions=[
                    Transition(id=t[&quot;id&quot;], name=t[&quot;name&quot;], to_status=t[&quot;to&quot;][&quot;name&quot;])
                    for t in transitions
                ]
            )

        # Find matching transition
        transition_id = None
        for t in transitions:
            if t[&quot;name&quot;].lower() == input.transition.lower():
                transition_id = t[&quot;id&quot;]
                break

        if not transition_id:
            available = [t[&quot;name&quot;] for t in transitions]
            raise ValueError(f&quot;Transition &#039;{input.transition}&#039; not available. Available: {available}&quot;)

        # Execute transition
        await self.client.transition_issue(input.issue_key, transition_id)

        # Get updated issue
        issue = await self.client.get_issue(input.issue_key)

        return JiraOpsOutput(
            success=True,
            operation=&quot;transition&quot;,
            issue=self.result_mapper.map_issue(issue),
            message=f&quot;Transitioned {input.issue_key} to {input.transition}&quot;
        )</code></pre>
        </div>
        <p>#### 2. Field Resolver</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class FieldResolver:
    &quot;&quot;&quot;
    Resolves human-friendly field names to JIRA field IDs.
    Handles custom fields and project-specific configurations.
    &quot;&quot;&quot;

    def __init__(self, client: JiraClient):
        self.client = client
        self._field_cache: dict[str, dict] = {}

    async def resolve(self, project: str, fields: dict) -&gt; dict:
        &quot;&quot;&quot;Convert user-provided fields to JIRA API format.&quot;&quot;&quot;

        # Get field definitions for project
        if project not in self._field_cache:
            self._field_cache[project] = await self._load_fields(project)

        field_defs = self._field_cache[project]
        resolved = {}

        for key, value in fields.items():
            # Standard field
            if key in STANDARD_FIELDS:
                resolved[key] = self._resolve_standard(key, value)

            # Custom field by name
            elif key in field_defs:
                field_id = field_defs[key][&quot;id&quot;]
                resolved[field_id] = self._resolve_custom(field_defs[key], value)

            # Custom field by ID
            elif key.startswith(&quot;customfield_&quot;):
                resolved[key] = value

            else:
                raise ValueError(f&quot;Unknown field: {key}&quot;)

        return resolved

    def _resolve_standard(self, key: str, value: Any) -&gt; Any:
        &quot;&quot;&quot;Handle standard field formatting.&quot;&quot;&quot;

        # Assignee/reporter: accept username string
        if key in (&quot;assignee&quot;, &quot;reporter&quot;):
            if isinstance(value, str):
                return {&quot;name&quot;: value}
            return value

        # Priority: accept name string
        if key == &quot;priority&quot;:
            if isinstance(value, str):
                return {&quot;name&quot;: value}
            return value

        # Labels: ensure list
        if key == &quot;labels&quot;:
            if isinstance(value, str):
                return [value]
            return value

        return value</code></pre>
        </div>
        <p>#### 3. JIRA Client</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class JiraClient:
    &quot;&quot;&quot;
    Low-level JIRA REST API client.
    Handles authentication, rate limiting, and error handling.
    &quot;&quot;&quot;

    def __init__(self, config: JiraConfig):
        self.base_url = config.base_url.rstrip(&quot;/&quot;)
        self.auth = (config.username, config.api_token) if config.username else None
        self.headers = {
            &quot;Content-Type&quot;: &quot;application/json&quot;,
            &quot;Accept&quot;: &quot;application/json&quot;
        }
        if config.api_token and not config.username:
            self.headers[&quot;Authorization&quot;] = f&quot;Bearer {config.api_token}&quot;

    async def create_issue(self, fields: dict) -&gt; dict:
        return await self._request(&quot;POST&quot;, &quot;/rest/api/2/issue&quot;, json={&quot;fields&quot;: fields})

    async def update_issue(self, key: str, fields: dict) -&gt; None:
        await self._request(&quot;PUT&quot;, f&quot;/rest/api/2/issue/{key}&quot;, json={&quot;fields&quot;: fields})

    async def get_issue(self, key: str, expand: list[str] | None = None) -&gt; dict:
        params = {}
        if expand:
            params[&quot;expand&quot;] = &quot;,&quot;.join(expand)
        return await self._request(&quot;GET&quot;, f&quot;/rest/api/2/issue/{key}&quot;, params=params)

    async def search(self, jql: str, max_results: int = 50, fields: list[str] | None = None) -&gt; dict:
        body = {
            &quot;jql&quot;: jql,
            &quot;maxResults&quot;: max_results,
            &quot;fields&quot;: fields or [&quot;*all&quot;]
        }
        return await self._request(&quot;POST&quot;, &quot;/rest/api/2/search&quot;, json=body)

    async def get_transitions(self, key: str) -&gt; list[dict]:
        result = await self._request(&quot;GET&quot;, f&quot;/rest/api/2/issue/{key}/transitions&quot;)
        return result[&quot;transitions&quot;]

    async def transition_issue(self, key: str, transition_id: str, fields: dict | None = None) -&gt; None:
        body = {&quot;transition&quot;: {&quot;id&quot;: transition_id}}
        if fields:
            body[&quot;fields&quot;] = fields
        await self._request(&quot;POST&quot;, f&quot;/rest/api/2/issue/{key}/transitions&quot;, json=body)

    async def add_comment(self, key: str, body: str) -&gt; dict:
        return await self._request(&quot;POST&quot;, f&quot;/rest/api/2/issue/{key}/comment&quot;, json={&quot;body&quot;: body})

    async def add_worklog(self, key: str, time_spent: str, comment: str | None = None) -&gt; dict:
        body = {&quot;timeSpent&quot;: time_spent}
        if comment:
            body[&quot;comment&quot;] = comment
        return await self._request(&quot;POST&quot;, f&quot;/rest/api/2/issue/{key}/worklog&quot;, json=body)

    async def create_link(self, link_type: str, inward_key: str, outward_key: str) -&gt; None:
        body = {
            &quot;type&quot;: {&quot;name&quot;: link_type},
            &quot;inwardIssue&quot;: {&quot;key&quot;: inward_key},
            &quot;outwardIssue&quot;: {&quot;key&quot;: outward_key}
        }
        await self._request(&quot;POST&quot;, &quot;/rest/api/2/issueLink&quot;, json=body)

    async def _request(self, method: str, path: str, **kwargs) -&gt; Any:
        url = f&quot;{self.base_url}{path}&quot;
        async with httpx.AsyncClient() as client:
            response = await client.request(
                method, url,
                auth=self.auth,
                headers=self.headers,
                **kwargs
            )

            if response.status_code &gt;= 400:
                error_body = response.json() if response.content else {}
                raise JiraAPIError(
                    status_code=response.status_code,
                    messages=error_body.get(&quot;errorMessages&quot;, []),
                    errors=error_body.get(&quot;errors&quot;, {})
                )

            if response.content:
                return response.json()
            return None</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-jira-ops:
  # Connection
  base_url: &quot;${JIRA_URL}&quot;               # https://company.atlassian.net

  # Authentication (choose one)
  # Option 1: API token (Atlassian Cloud)
  username: &quot;${JIRA_USERNAME}&quot;          # email for cloud
  api_token: &quot;${JIRA_API_TOKEN}&quot;

  # Option 2: Personal Access Token (Server/Data Center)
  # api_token: &quot;${JIRA_PAT}&quot;            # PAT without username

  # Option 3: OAuth (advanced)
  # oauth:
  #   consumer_key: &quot;...&quot;
  #   access_token: &quot;...&quot;
  #   ...

  # Default project
  default_project: &quot;PROJ&quot;               # Used when project not specified

  # Field mappings (project-specific custom field names)
  field_aliases:
    story_points: &quot;customfield_10001&quot;
    sprint: &quot;customfield_10002&quot;
    team: &quot;customfield_10003&quot;

  # Workflow shortcuts
  workflow_aliases:
    start: &quot;Start Progress&quot;
    done: &quot;Done&quot;
    review: &quot;Ready for Review&quot;
    block: &quot;Blocked&quot;

  # Query defaults
  query:
    default_fields:
      - summary
      - status
      - assignee
      - priority
      - created
      - updated
    max_results: 50

  # Behavior
  behavior:
    # Auto-assign to current user on transition to &quot;In Progress&quot;
    auto_assign_on_start: true

    # Add comment with PR link when linking
    comment_on_link: true

    # Validate transitions before attempting
    validate_transitions: true</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Create Bug from Code Context</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;create&quot;,
    &quot;project&quot;: &quot;PROJ&quot;,
    &quot;issue_type&quot;: &quot;bug&quot;,
    &quot;summary&quot;: &quot;NullPointerException in PaymentGateway.process()&quot;,
    &quot;description&quot;: &quot;Found while reviewing PR #456.\n\n{code:java}\n// Line 142 in PaymentGateway.java\nuser.getEmail().toLowerCase()  // user can be null\n{code}\n\nReproduction: Call process() with null user.&quot;,
    &quot;fields&quot;: {
        &quot;priority&quot;: &quot;High&quot;,
        &quot;labels&quot;: [&quot;backend&quot;, &quot;payments&quot;],
        &quot;components&quot;: [&quot;payment-service&quot;]
    }
}

# Output
{
    &quot;success&quot;: true,
    &quot;operation&quot;: &quot;create&quot;,
    &quot;issue&quot;: {
        &quot;key&quot;: &quot;PROJ-789&quot;,
        &quot;summary&quot;: &quot;NullPointerException in PaymentGateway.process()&quot;,
        &quot;status&quot;: &quot;To Do&quot;,
        &quot;priority&quot;: &quot;High&quot;,
        &quot;url&quot;: &quot;https://company.atlassian.net/browse/PROJ-789&quot;
    },
    &quot;message&quot;: &quot;Created PROJ-789&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Transition with Auto-Assign</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;transition&quot;,
    &quot;issue_key&quot;: &quot;PROJ-789&quot;,
    &quot;transition&quot;: &quot;Start Progress&quot;
}

# Output
{
    &quot;success&quot;: true,
    &quot;operation&quot;: &quot;transition&quot;,
    &quot;issue&quot;: {
        &quot;key&quot;: &quot;PROJ-789&quot;,
        &quot;status&quot;: &quot;In Progress&quot;,
        &quot;assignee&quot;: &quot;current-user&quot;  // Auto-assigned
    },
    &quot;message&quot;: &quot;Transitioned PROJ-789 to Start Progress&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Query My Sprint Work</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;query&quot;,
    &quot;jql&quot;: &quot;assignee = currentUser() AND sprint in openSprints() ORDER BY priority DESC&quot;,
    &quot;max_results&quot;: 10
}

# Output
{
    &quot;success&quot;: true,
    &quot;operation&quot;: &quot;query&quot;,
    &quot;issues&quot;: [
        {
            &quot;key&quot;: &quot;PROJ-456&quot;,
            &quot;summary&quot;: &quot;Implement retry logic&quot;,
            &quot;status&quot;: &quot;In Progress&quot;,
            &quot;priority&quot;: &quot;High&quot;
        },
        {
            &quot;key&quot;: &quot;PROJ-457&quot;,
            &quot;summary&quot;: &quot;Add unit tests for auth&quot;,
            &quot;status&quot;: &quot;To Do&quot;,
            &quot;priority&quot;: &quot;Medium&quot;
        }
    ],
    &quot;total_count&quot;: 2
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 4: Link PR to Issue</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;link&quot;,
    &quot;issue_key&quot;: &quot;PROJ-456&quot;,
    &quot;link_type&quot;: &quot;is implemented by&quot;,
    &quot;link_target&quot;: &quot;https://github.com/company/repo/pull/123&quot;
}

# Output
{
    &quot;success&quot;: true,
    &quot;operation&quot;: &quot;link&quot;,
    &quot;message&quot;: &quot;Linked PROJ-456 to PR #123&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 5: Get Available Transitions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;transition&quot;,
    &quot;issue_key&quot;: &quot;PROJ-456&quot;
    // No transition specified - returns available options
}

# Output
{
    &quot;success&quot;: true,
    &quot;operation&quot;: &quot;transition&quot;,
    &quot;available_transitions&quot;: [
        {&quot;id&quot;: &quot;21&quot;, &quot;name&quot;: &quot;Done&quot;, &quot;to_status&quot;: &quot;Done&quot;},
        {&quot;id&quot;: &quot;31&quot;, &quot;name&quot;: &quot;Blocked&quot;, &quot;to_status&quot;: &quot;Blocked&quot;},
        {&quot;id&quot;: &quot;41&quot;, &quot;name&quot;: &quot;Ready for Review&quot;, &quot;to_status&quot;: &quot;In Review&quot;}
    ]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Authentication</h4>
        <li>API tokens stored securely (environment variables or secret manager)</li>
        <li>Tokens never logged or returned in output</li>
        <li>Support for multiple auth methods (basic, PAT, OAuth)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissions</h4>
        <li>Tool respects JIRA project permissions</li>
        <li>Operations fail gracefully if user lacks permission</li>
        <li>No privilege escalation possible</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Audit</h4>
        <li>All operations logged with user context</li>
        <li>JIRA maintains its own audit log</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Risk Mitigations</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Risk</th><th>Mitigation</th></tr>
          </thead>
          <tbody>
            <tr><td>Credential exposure</td><td>Tokens from env vars, never in config files</td></tr>
            <tr><td>Unauthorized modifications</td><td>API enforces JIRA permissions</td></tr>
            <tr><td>Data leakage</td><td>Issue content may contain sensitive data - same as viewing in JIRA</td></tr>
            <tr><td>Rate limiting</td><td>Built-in rate limit handling, exponential backoff</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_field_resolver_handles_standard_fields():
    resolver = FieldResolver(mock_client)
    result = await resolver.resolve(&quot;PROJ&quot;, {
        &quot;assignee&quot;: &quot;alice&quot;,
        &quot;priority&quot;: &quot;High&quot;
    })
    assert result[&quot;assignee&quot;] == {&quot;name&quot;: &quot;alice&quot;}
    assert result[&quot;priority&quot;] == {&quot;name&quot;: &quot;High&quot;}

def test_operation_dispatcher_validates_required_fields():
    dispatcher = OperationDispatcher(...)
    with pytest.raises(ValueError, match=&quot;project required&quot;):
        await dispatcher.dispatch(JiraOpsInput(operation=&quot;create&quot;, summary=&quot;Test&quot;))</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_create_and_transition_flow(mock_jira_server):
    tool = JiraOpsTool(config)

    # Create
    create_result = await tool.execute({
        &quot;operation&quot;: &quot;create&quot;,
        &quot;project&quot;: &quot;TEST&quot;,
        &quot;summary&quot;: &quot;Integration test issue&quot;
    })
    assert create_result.success
    issue_key = create_result.issue.key

    # Transition
    transition_result = await tool.execute({
        &quot;operation&quot;: &quot;transition&quot;,
        &quot;issue_key&quot;: issue_key,
        &quot;transition&quot;: &quot;Start Progress&quot;
    })
    assert transition_result.success
    assert transition_result.issue.status == &quot;In Progress&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>httpx</code> - Async HTTP client</li>
        <li><code>jira</code> (optional) - Can use official JIRA library or direct REST</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>None</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Bulk operations</strong>: Should we support bulk create/update?</li>
        <p>   - Useful for sprint planning automation</p>
        <p>   - API supports it but adds complexity</p>
        <li><strong>Webhook integration</strong>: Should this tool support receiving JIRA webhooks?</li>
        <p>   - Would enable reactive workflows</p>
        <p>   - Significantly increases scope</p>
        <li><strong>Custom workflow support</strong>: How to handle project-specific workflows?</li>
        <p>   - Currently: Discover transitions dynamically</p>
        <p>   - Could: Pre-configure workflow mappings</p>
        <li><strong>Attachment support</strong>: Should we support uploading attachments?</li>
        <p>   - Useful for screenshots, logs</p>
        <p>   - Requires file handling</p>
        <li><strong>Board/Sprint operations</strong>: Should we include board-level operations?</li>
        <p>   - Sprint management, backlog ordering</p>
        <p>   - Different API (Agile API vs Issue API)</p>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-metrics-query" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Metrics Query</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-metrics-query</code></p>
        </div>
        <h3>Overview</h3>
        <p>Query observability platforms (Prometheus, DataDog, Grafana, CloudWatch) to get metrics, logs, and traces. Enables data-driven analysis during debugging, incident response, and performance optimization.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Switch to Grafana, build query, interpret graphs</td><td>"What's the p99 latency for payment API?" â†’ instant answer</td></tr>
            <tr><td>Manually correlate metrics across dashboards</td><td>Single query spans metrics, logs, traces</td></tr>
            <tr><td>Learn each platform's query language</td><td>Natural language queries translated automatically</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Performance analysis</strong>: "What's the latency trend for /api/orders?"</li>
        <li><strong>Incident investigation</strong>: "Show error rates for the last hour"</li>
        <li><strong>Capacity planning</strong>: "What's the CPU utilization trend this week?"</li>
        <li><strong>Debugging</strong>: "Correlate this error with metrics and traces"</li>
        <li><strong>Alerting context</strong>: "What triggered the PagerDuty alert?"</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;metrics_query&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Query observability platforms for metrics, logs, and traces.

    Supports:
    - Prometheus/VictoriaMetrics (PromQL)
    - DataDog (metrics, logs, APM)
    - Grafana (as unified query layer)
    - CloudWatch (AWS metrics and logs)

    Operations:
    - query: Execute a metrics query
    - logs: Search logs
    - traces: Find distributed traces
    - alerts: Get active alerts

    Use for performance analysis, debugging, and incident investigation.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;operation&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;query&quot;, &quot;logs&quot;, &quot;traces&quot;, &quot;alerts&quot;],
                &quot;description&quot;: &quot;Type of observability query&quot;
            },
            &quot;query&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Query in natural language or native syntax (PromQL, etc.)&quot;
            },
            &quot;service&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Service/application to query&quot;
            },
            &quot;time_range&quot;: {
                &quot;type&quot;: &quot;object&quot;,
                &quot;properties&quot;: {
                    &quot;start&quot;: {&quot;type&quot;: &quot;string&quot;},
                    &quot;end&quot;: {&quot;type&quot;: &quot;string&quot;},
                    &quot;relative&quot;: {&quot;type&quot;: &quot;string&quot;}
                },
                &quot;description&quot;: &quot;Time range (e.g., {relative: &#039;1h&#039;} or {start: &#039;...&#039;, end: &#039;...&#039;})&quot;
            },
            &quot;platform&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;auto&quot;, &quot;prometheus&quot;, &quot;datadog&quot;, &quot;grafana&quot;, &quot;cloudwatch&quot;],
                &quot;default&quot;: &quot;auto&quot;,
                &quot;description&quot;: &quot;Observability platform&quot;
            },
            &quot;aggregation&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;avg&quot;, &quot;sum&quot;, &quot;min&quot;, &quot;max&quot;, &quot;p50&quot;, &quot;p90&quot;, &quot;p95&quot;, &quot;p99&quot;],
                &quot;description&quot;: &quot;Aggregation for metrics&quot;
            }
        },
        &quot;required&quot;: [&quot;operation&quot;, &quot;query&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class MetricsQueryOutput:
    operation: str
    platform: str
    native_query: str                   # Translated query in native syntax

    # For query operation
    metrics: MetricsResult | None = None

    # For logs operation
    logs: LogsResult | None = None

    # For traces operation
    traces: TracesResult | None = None

    # For alerts operation
    alerts: list[Alert] | None = None

@dataclass
class MetricsResult:
    series: list[TimeSeries]
    summary: MetricsSummary

@dataclass
class TimeSeries:
    labels: dict[str, str]              # {service: &quot;api&quot;, endpoint: &quot;/orders&quot;}
    values: list[DataPoint]

@dataclass
class DataPoint:
    timestamp: datetime
    value: float

@dataclass
class MetricsSummary:
    min: float
    max: float
    avg: float
    current: float
    trend: str                          # increasing | decreasing | stable
    anomalies: list[Anomaly]

@dataclass
class LogsResult:
    entries: list[LogEntry]
    total_count: int
    patterns: list[LogPattern]          # Detected patterns/clusters

@dataclass
class LogEntry:
    timestamp: datetime
    level: str
    message: str
    service: str
    trace_id: str | None
    attributes: dict

@dataclass
class TracesResult:
    traces: list[Trace]
    service_map: ServiceMap | None

@dataclass
class Trace:
    trace_id: str
    root_span: Span
    duration_ms: float
    service_count: int
    error: bool

@dataclass
class Span:
    span_id: str
    service: str
    operation: str
    duration_ms: float
    status: str
    children: list[Span]

@dataclass
class Alert:
    id: str
    name: str
    status: str                         # firing | resolved
    severity: str
    message: str
    triggered_at: datetime
    labels: dict</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Query Translation</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class QueryTranslator:
    &quot;&quot;&quot;Translate natural language to native query syntax.&quot;&quot;&quot;

    async def translate(
        self,
        query: str,
        platform: str,
        context: QueryContext
    ) -&gt; str:
        &quot;&quot;&quot;
        Examples:
        - &quot;p99 latency for payment-service&quot;
          â†’ histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{service=&quot;payment-service&quot;}[5m]))

        - &quot;error rate for /api/orders&quot;
          â†’ sum(rate(http_requests_total{endpoint=&quot;/api/orders&quot;,status=~&quot;5..&quot;}[5m]))
            / sum(rate(http_requests_total{endpoint=&quot;/api/orders&quot;}[5m]))

        - &quot;CPU usage trending&quot;
          â†’ avg(rate(container_cpu_usage_seconds_total{...}[5m])) by (pod)
        &quot;&quot;&quot;

        # Detect if already native query
        if self._is_native_query(query, platform):
            return query

        # Use platform-specific translation
        return await self._translate_natural_language(query, platform, context)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Platform Adapters</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class PrometheusAdapter:
    &quot;&quot;&quot;Adapter for Prometheus/VictoriaMetrics.&quot;&quot;&quot;

    async def query(self, promql: str, time_range: TimeRange) -&gt; MetricsResult:
        # Query range for time series
        result = await self.client.query_range(
            query=promql,
            start=time_range.start,
            end=time_range.end,
            step=self._calculate_step(time_range)
        )

        series = self._parse_matrix(result)
        summary = self._compute_summary(series)

        return MetricsResult(series=series, summary=summary)


class DataDogAdapter:
    &quot;&quot;&quot;Adapter for DataDog.&quot;&quot;&quot;

    async def query_metrics(self, query: str, time_range: TimeRange) -&gt; MetricsResult:
        result = await self.client.query_timeseries(
            query=query,
            start=int(time_range.start.timestamp()),
            end=int(time_range.end.timestamp())
        )
        return self._parse_result(result)

    async def search_logs(self, query: str, time_range: TimeRange) -&gt; LogsResult:
        result = await self.client.logs_list(
            filter_query=query,
            filter_from=time_range.start.isoformat(),
            filter_to=time_range.end.isoformat()
        )
        return self._parse_logs(result)</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-metrics-query:
  # Platform configurations
  platforms:
    prometheus:
      enabled: true
      url: &quot;${PROMETHEUS_URL}&quot;
      auth:
        type: basic                     # basic | bearer | none
        username: &quot;${PROMETHEUS_USER}&quot;
        password: &quot;${PROMETHEUS_PASS}&quot;

    datadog:
      enabled: true
      api_key: &quot;${DD_API_KEY}&quot;
      app_key: &quot;${DD_APP_KEY}&quot;
      site: &quot;datadoghq.com&quot;             # or datadoghq.eu, etc.

    grafana:
      enabled: true
      url: &quot;${GRAFANA_URL}&quot;
      api_key: &quot;${GRAFANA_API_KEY}&quot;

    cloudwatch:
      enabled: true
      region: &quot;us-east-1&quot;
      # Uses AWS credentials from environment

  # Query settings
  query:
    default_time_range: &quot;1h&quot;
    max_data_points: 1000
    timeout_seconds: 30

  # Service discovery
  services:
    # Map friendly names to label selectors
    payment-service:
      prometheus: {service: &quot;payment-api&quot;}
      datadog: {service: &quot;payment-api&quot;}
    auth-service:
      prometheus: {service: &quot;auth-api&quot;}

  # Translation hints
  translation:
    # Common metric name mappings
    latency: &quot;http_request_duration_seconds&quot;
    errors: &quot;http_requests_total{status=~&#039;5..&#039;}&quot;
    requests: &quot;http_requests_total&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Latency Query</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;query&quot;,
    &quot;query&quot;: &quot;p99 latency for payment-service&quot;,
    &quot;time_range&quot;: {&quot;relative&quot;: &quot;1h&quot;}
}

# Output
{
    &quot;operation&quot;: &quot;query&quot;,
    &quot;platform&quot;: &quot;prometheus&quot;,
    &quot;native_query&quot;: &quot;histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{service=\&quot;payment-api\&quot;}[5m])) by (le))&quot;,
    &quot;metrics&quot;: {
        &quot;series&quot;: [
            {
                &quot;labels&quot;: {&quot;service&quot;: &quot;payment-api&quot;},
                &quot;values&quot;: [
                    {&quot;timestamp&quot;: &quot;2024-01-15T10:00:00Z&quot;, &quot;value&quot;: 0.245},
                    {&quot;timestamp&quot;: &quot;2024-01-15T10:05:00Z&quot;, &quot;value&quot;: 0.251},
                    ...
                ]
            }
        ],
        &quot;summary&quot;: {
            &quot;min&quot;: 0.198,
            &quot;max&quot;: 0.312,
            &quot;avg&quot;: 0.247,
            &quot;current&quot;: 0.251,
            &quot;trend&quot;: &quot;stable&quot;,
            &quot;anomalies&quot;: []
        }
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Log Search with Correlation</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;logs&quot;,
    &quot;query&quot;: &quot;error payment timeout&quot;,
    &quot;service&quot;: &quot;payment-service&quot;,
    &quot;time_range&quot;: {&quot;relative&quot;: &quot;30m&quot;}
}

# Output
{
    &quot;operation&quot;: &quot;logs&quot;,
    &quot;platform&quot;: &quot;datadog&quot;,
    &quot;logs&quot;: {
        &quot;entries&quot;: [
            {
                &quot;timestamp&quot;: &quot;2024-01-15T10:42:15Z&quot;,
                &quot;level&quot;: &quot;error&quot;,
                &quot;message&quot;: &quot;Payment gateway timeout after 30s&quot;,
                &quot;service&quot;: &quot;payment-api&quot;,
                &quot;trace_id&quot;: &quot;abc123&quot;,
                &quot;attributes&quot;: {
                    &quot;user_id&quot;: &quot;u_456&quot;,
                    &quot;payment_id&quot;: &quot;pay_789&quot;,
                    &quot;gateway&quot;: &quot;stripe&quot;
                }
            }
        ],
        &quot;total_count&quot;: 23,
        &quot;patterns&quot;: [
            {
                &quot;pattern&quot;: &quot;Payment gateway timeout after *&quot;,
                &quot;count&quot;: 20,
                &quot;first_seen&quot;: &quot;2024-01-15T10:30:00Z&quot;
            }
        ]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Active Alerts</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;alerts&quot;,
    &quot;service&quot;: &quot;payment-service&quot;
}

# Output
{
    &quot;operation&quot;: &quot;alerts&quot;,
    &quot;alerts&quot;: [
        {
            &quot;id&quot;: &quot;alert_123&quot;,
            &quot;name&quot;: &quot;PaymentServiceHighLatency&quot;,
            &quot;status&quot;: &quot;firing&quot;,
            &quot;severity&quot;: &quot;warning&quot;,
            &quot;message&quot;: &quot;p99 latency &gt; 500ms for 5 minutes&quot;,
            &quot;triggered_at&quot;: &quot;2024-01-15T10:35:00Z&quot;,
            &quot;labels&quot;: {&quot;service&quot;: &quot;payment-api&quot;, &quot;endpoint&quot;: &quot;/process&quot;}
        }
    ]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Accesses sensitive operational data</li>
        <li>API keys stored securely</li>
        <li>Query results may reveal infrastructure details</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;network:prometheus&quot;,     # If Prometheus enabled
    &quot;network:datadog&quot;,        # If DataDog enabled
    &quot;network:grafana&quot;,        # If Grafana enabled
    &quot;network:aws&quot;,            # If CloudWatch enabled
]</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>httpx</code> - HTTP client</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional (per platform)</h4>
        <li><code>prometheus-api-client</code> - Prometheus</li>
        <li><code>datadog-api-client</code> - DataDog</li>
        <li><code>boto3</code> - CloudWatch</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Query validation</strong>: Should we validate queries before execution?</li>
        <li><strong>Result caching</strong>: Cache recent query results?</li>
        <li><strong>Alerting integration</strong>: Support creating/modifying alerts?</li>
        <li><strong>Dashboard linking</strong>: Link to relevant dashboards in results?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-migration-helper" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Migration Helper</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Enhancement)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-migration-helper</code></p>
        </div>
        <h3>Overview</h3>
        <p>Assists with database schema migrations, data migrations, and API version migrations. Generates migration scripts, validates safety, plans rollback strategies, and monitors migration execution.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manually write migration scripts</td><td>Auto-generate from schema diff</td></tr>
            <tr><td>Hope rollback works</td><td>Validated rollback scripts before deployment</td></tr>
            <tr><td>Migration issues discovered in prod</td><td>Pre-flight safety checks</td></tr>
            <tr><td>Complex data migrations are scary</td><td>Step-by-step execution with checkpoints</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Schema migration</strong>: Generate migration from model changes</li>
        <li><strong>Safety validation</strong>: Check migration for data loss risks</li>
        <li><strong>Rollback planning</strong>: Generate and test rollback scripts</li>
        <li><strong>Data migration</strong>: Transform data during schema changes</li>
        <li><strong>Migration monitoring</strong>: Track progress of long-running migrations</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;migration_helper&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Database and API migration assistance.

    Operations:
    - generate: Generate migration from schema changes
    - validate: Check migration safety
    - plan_rollback: Generate rollback strategy
    - execute: Run migration with monitoring
    - status: Check migration status

    Supports: PostgreSQL, MySQL, SQLite, MongoDB, and framework ORMs.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;operation&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;generate&quot;, &quot;validate&quot;, &quot;plan_rollback&quot;, &quot;execute&quot;, &quot;status&quot;],
                &quot;description&quot;: &quot;Operation to perform&quot;
            },
            &quot;migration_type&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;schema&quot;, &quot;data&quot;, &quot;api&quot;],
                &quot;default&quot;: &quot;schema&quot;,
                &quot;description&quot;: &quot;Type of migration&quot;
            },
            &quot;source&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Source schema/version (for generate)&quot;
            },
            &quot;target&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Target schema/version (for generate)&quot;
            },
            &quot;migration_file&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Migration file path (for validate/execute)&quot;
            },
            &quot;dry_run&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: true,
                &quot;description&quot;: &quot;Simulate without applying changes&quot;
            }
        },
        &quot;required&quot;: [&quot;operation&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class MigrationHelperOutput:
    operation: str

    # For generate
    migration: GeneratedMigration | None = None

    # For validate
    validation: MigrationValidation | None = None

    # For plan_rollback
    rollback: RollbackPlan | None = None

    # For execute
    execution: ExecutionResult | None = None

    # For status
    status: MigrationStatus | None = None

@dataclass
class GeneratedMigration:
    name: str
    up_script: str                      # Forward migration SQL
    down_script: str                    # Rollback SQL
    changes: list[SchemaChange]
    estimated_duration: str
    data_at_risk: bool

@dataclass
class SchemaChange:
    type: str                           # add_column | drop_column | rename | alter_type | add_index | etc.
    table: str
    column: str | None
    details: dict
    reversible: bool
    data_loss_risk: str                 # none | low | high

@dataclass
class MigrationValidation:
    safe: bool
    warnings: list[ValidationWarning]
    errors: list[ValidationError]
    recommendations: list[str]

@dataclass
class ValidationWarning:
    type: str
    message: str
    location: str
    suggestion: str

@dataclass
class ValidationError:
    type: str
    message: str
    location: str
    blocking: bool

@dataclass
class RollbackPlan:
    script: str
    steps: list[RollbackStep]
    data_recovery: DataRecoveryPlan | None
    estimated_duration: str
    tested: bool

@dataclass
class RollbackStep:
    order: int
    description: str
    sql: str
    verification: str                   # Query to verify step succeeded

@dataclass
class ExecutionResult:
    success: bool
    duration_seconds: float
    rows_affected: int
    steps_completed: list[str]
    errors: list[str]
    rollback_triggered: bool</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Migration Generator</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class MigrationGenerator:
    &quot;&quot;&quot;Generate migrations from schema differences.&quot;&quot;&quot;

    async def generate(
        self,
        source: str,
        target: str,
        migration_type: str
    ) -&gt; GeneratedMigration:
        # Parse schemas
        source_schema = await self._parse_schema(source)
        target_schema = await self._parse_schema(target)

        # Compute differences
        changes = self._diff_schemas(source_schema, target_schema)

        # Generate SQL
        up_script = self._generate_up_script(changes)
        down_script = self._generate_down_script(changes)

        # Analyze risks
        data_at_risk = any(c.data_loss_risk != &quot;none&quot; for c in changes)

        return GeneratedMigration(
            name=self._generate_name(changes),
            up_script=up_script,
            down_script=down_script,
            changes=changes,
            estimated_duration=self._estimate_duration(changes),
            data_at_risk=data_at_risk
        )

    def _diff_schemas(
        self,
        source: Schema,
        target: Schema
    ) -&gt; list[SchemaChange]:
        changes = []

        # Compare tables
        for table in target.tables:
            if table.name not in source.table_names:
                changes.append(SchemaChange(
                    type=&quot;create_table&quot;,
                    table=table.name,
                    details={&quot;columns&quot;: table.columns},
                    reversible=True,
                    data_loss_risk=&quot;none&quot;
                ))
            else:
                # Compare columns
                source_table = source.get_table(table.name)
                changes.extend(self._diff_columns(source_table, table))

        # Detect dropped tables
        for table_name in source.table_names:
            if table_name not in target.table_names:
                changes.append(SchemaChange(
                    type=&quot;drop_table&quot;,
                    table=table_name,
                    details={},
                    reversible=False,
                    data_loss_risk=&quot;high&quot;
                ))

        return changes</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Safety Validator</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class MigrationValidator:
    &quot;&quot;&quot;Validate migration safety.&quot;&quot;&quot;

    def validate(self, migration: GeneratedMigration) -&gt; MigrationValidation:
        warnings = []
        errors = []

        for change in migration.changes:
            # Check for data loss
            if change.data_loss_risk == &quot;high&quot;:
                errors.append(ValidationError(
                    type=&quot;data_loss&quot;,
                    message=f&quot;Dropping {change.table}.{change.column} will cause data loss&quot;,
                    location=f&quot;{change.table}.{change.column}&quot;,
                    blocking=True
                ))

            # Check for irreversible changes
            if not change.reversible:
                warnings.append(ValidationWarning(
                    type=&quot;irreversible&quot;,
                    message=f&quot;Change to {change.table} cannot be automatically rolled back&quot;,
                    location=change.table,
                    suggestion=&quot;Create manual rollback script and backup data first&quot;
                ))

            # Check for locking issues
            if change.type in [&quot;add_index&quot;, &quot;alter_type&quot;] and self._is_large_table(change.table):
                warnings.append(ValidationWarning(
                    type=&quot;lock_risk&quot;,
                    message=f&quot;This operation may lock {change.table} for extended time&quot;,
                    location=change.table,
                    suggestion=&quot;Consider using CONCURRENTLY option or off-peak deployment&quot;
                ))

        recommendations = self._generate_recommendations(migration, warnings, errors)

        return MigrationValidation(
            safe=len(errors) == 0,
            warnings=warnings,
            errors=errors,
            recommendations=recommendations
        )</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Generate Migration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;generate&quot;,
    &quot;source&quot;: &quot;HEAD~1&quot;,                 # Previous commit&#039;s schema
    &quot;target&quot;: &quot;HEAD&quot;                    # Current schema
}

# Output
{
    &quot;migration&quot;: {
        &quot;name&quot;: &quot;20240115_add_payment_retry_columns&quot;,
        &quot;up_script&quot;: &quot;&quot;&quot;
-- Add retry tracking columns to payments table
ALTER TABLE payments ADD COLUMN retry_count INTEGER DEFAULT 0;
ALTER TABLE payments ADD COLUMN last_retry_at TIMESTAMP;
ALTER TABLE payments ADD COLUMN retry_reason TEXT;

-- Add index for retry queries
CREATE INDEX idx_payments_retry ON payments (retry_count, last_retry_at);
&quot;&quot;&quot;,
        &quot;down_script&quot;: &quot;&quot;&quot;
-- Remove retry tracking
DROP INDEX IF EXISTS idx_payments_retry;
ALTER TABLE payments DROP COLUMN retry_reason;
ALTER TABLE payments DROP COLUMN last_retry_at;
ALTER TABLE payments DROP COLUMN retry_count;
&quot;&quot;&quot;,
        &quot;changes&quot;: [
            {
                &quot;type&quot;: &quot;add_column&quot;,
                &quot;table&quot;: &quot;payments&quot;,
                &quot;column&quot;: &quot;retry_count&quot;,
                &quot;reversible&quot;: true,
                &quot;data_loss_risk&quot;: &quot;none&quot;
            },
            {
                &quot;type&quot;: &quot;add_index&quot;,
                &quot;table&quot;: &quot;payments&quot;,
                &quot;details&quot;: {&quot;columns&quot;: [&quot;retry_count&quot;, &quot;last_retry_at&quot;]},
                &quot;reversible&quot;: true,
                &quot;data_loss_risk&quot;: &quot;none&quot;
            }
        ],
        &quot;estimated_duration&quot;: &quot;&lt; 1 minute&quot;,
        &quot;data_at_risk&quot;: false
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Validate Migration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;validate&quot;,
    &quot;migration_file&quot;: &quot;migrations/20240115_remove_legacy_auth.sql&quot;
}

# Output
{
    &quot;validation&quot;: {
        &quot;safe&quot;: false,
        &quot;errors&quot;: [
            {
                &quot;type&quot;: &quot;data_loss&quot;,
                &quot;message&quot;: &quot;Dropping column users.legacy_token will delete 45,000 rows of data&quot;,
                &quot;location&quot;: &quot;users.legacy_token&quot;,
                &quot;blocking&quot;: true
            }
        ],
        &quot;warnings&quot;: [
            {
                &quot;type&quot;: &quot;irreversible&quot;,
                &quot;message&quot;: &quot;DROP COLUMN cannot be automatically rolled back&quot;,
                &quot;suggestion&quot;: &quot;Backup users.legacy_token before migration&quot;
            },
            {
                &quot;type&quot;: &quot;foreign_key&quot;,
                &quot;message&quot;: &quot;sessions.user_token references users.legacy_token&quot;,
                &quot;suggestion&quot;: &quot;Drop foreign key constraint first&quot;
            }
        ],
        &quot;recommendations&quot;: [
            &quot;1. Create backup: SELECT id, legacy_token INTO users_legacy_backup FROM users&quot;,
            &quot;2. Update sessions to use new auth: UPDATE sessions SET auth_type = &#039;new&#039;&quot;,
            &quot;3. Drop foreign key: ALTER TABLE sessions DROP CONSTRAINT fk_user_token&quot;,
            &quot;4. Then proceed with migration&quot;
        ]
    }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-migration-helper:
  # Database connections
  databases:
    primary:
      type: postgresql
      connection_string: &quot;${DATABASE_URL}&quot;

  # ORM integration
  orm:
    framework: sqlalchemy              # sqlalchemy | django | alembic
    models_path: &quot;src/models/&quot;

  # Safety thresholds
  safety:
    large_table_rows: 100000           # Tables larger than this get warnings
    max_lock_seconds: 60               # Warn if operation might lock longer
    require_backup_for_drops: true

  # Migration settings
  migration:
    directory: &quot;migrations/&quot;
    naming: &quot;timestamp_description&quot;     # timestamp_description | sequential</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Executes SQL against databases</li>
        <li>Requires database credentials</li>
        <li>Dry-run mode recommended before production</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>sqlparse</code> - SQL parsing</li>
        <li>Database drivers (psycopg2, mysql-connector, etc.)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>alembic</code> - SQLAlchemy migrations</li>
        <li><code>django</code> - Django migrations</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Multi-database migrations</strong>: Support coordinated migrations across databases?</li>
        <li><strong>Zero-downtime patterns</strong>: Generate online schema change scripts?</li>
        <li><strong>Data transformation</strong>: Support complex data migrations with Python?</li>
        <li><strong>Approval workflow</strong>: Require approval for risky migrations?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-pr-context" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Pr Context</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-pr-context</code></p>
        </div>
        <h3>Overview</h3>
        <p>Fetches comprehensive context about pull requests including the PR itself, all comments, linked issues, CI status, related PRs, and relevant code context. Provides everything needed to understand, review, or continue work on a PR.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Open GitHub, read PR, click through to issues, check CI, find related PRs</td><td>Single call returns complete PR context</td></tr>
            <tr><td>Context switching between browser and terminal</td><td>Full context in your workflow</td></tr>
            <tr><td>Missing context from linked issues and prior discussions</td><td>Complete picture with cross-references</td></tr>
            <tr><td>Manual correlation of PR with tickets</td><td>Automatic JIRA/GitHub issue linkage</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>PR review</strong>: Get full context before reviewing code</li>
        <li><strong>Continue work</strong>: Understand where a PR left off, what feedback exists</li>
        <li><strong>Impact analysis</strong>: See what other PRs touch related code</li>
        <li><strong>Status check</strong>: Quick summary of PR state, blockers, approvals</li>
        <li><strong>Historical lookup</strong>: "What was in PR #123 and why?"</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;pr_context&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Fetches comprehensive context about a pull request including:
    - PR details (title, description, author, status, branch info)
    - All comments and review threads
    - Linked issues (JIRA, GitHub Issues)
    - CI/CD status and logs
    - Related PRs (same files, same branch, dependencies)
    - Code diff with surrounding context

    Use when you need to understand, review, or work on a PR.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;pr_identifier&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;PR number, URL, or branch name&quot;
            },
            &quot;repo&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Repository (owner/repo). Defaults to current repo.&quot;
            },
            &quot;include&quot;: {
                &quot;type&quot;: &quot;array&quot;,
                &quot;items&quot;: {
                    &quot;type&quot;: &quot;string&quot;,
                    &quot;enum&quot;: [&quot;comments&quot;, &quot;reviews&quot;, &quot;ci&quot;, &quot;linked_issues&quot;, &quot;related_prs&quot;, &quot;diff&quot;, &quot;files&quot;]
                },
                &quot;default&quot;: [&quot;comments&quot;, &quot;reviews&quot;, &quot;ci&quot;, &quot;linked_issues&quot;, &quot;diff&quot;],
                &quot;description&quot;: &quot;What context to include&quot;
            },
            &quot;diff_context_lines&quot;: {
                &quot;type&quot;: &quot;integer&quot;,
                &quot;default&quot;: 5,
                &quot;description&quot;: &quot;Lines of context around diff hunks&quot;
            }
        },
        &quot;required&quot;: [&quot;pr_identifier&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Input Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class PRContextInput:
    pr_identifier: str                  # PR number, URL, or branch name
    repo: str | None = None             # owner/repo, defaults to current
    include: list[str] = field(default_factory=lambda: [
        &quot;comments&quot;, &quot;reviews&quot;, &quot;ci&quot;, &quot;linked_issues&quot;, &quot;diff&quot;
    ])
    diff_context_lines: int = 5</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class PRContext:
    # Core PR info
    pr: PRDetails

    # Included based on &#039;include&#039; parameter
    comments: list[Comment] | None
    reviews: list[Review] | None
    ci_status: CIStatus | None
    linked_issues: list[LinkedIssue] | None
    related_prs: list[RelatedPR] | None
    diff: Diff | None
    files: list[FileChange] | None

    # Computed summaries
    summary: PRSummary

@dataclass
class PRDetails:
    number: int
    title: str
    description: str
    author: str
    state: str                          # open | closed | merged
    draft: bool
    base_branch: str
    head_branch: str
    created_at: datetime
    updated_at: datetime
    merged_at: datetime | None
    url: str

    # Approval status
    approvals: int
    changes_requested: int
    pending_reviewers: list[str]

@dataclass
class Comment:
    id: str
    author: str
    body: str
    created_at: datetime
    updated_at: datetime | None
    reply_to: str | None                # Parent comment ID if reply
    reactions: dict[str, int]           # emoji -&gt; count

    # For line comments
    file_path: str | None
    line_number: int | None
    diff_hunk: str | None

@dataclass
class Review:
    id: str
    author: str
    state: str                          # approved | changes_requested | commented
    body: str | None
    submitted_at: datetime
    comments: list[Comment]             # Review-specific comments

@dataclass
class CIStatus:
    overall: str                        # success | failure | pending | neutral
    checks: list[CICheck]

@dataclass
class CICheck:
    name: str
    status: str                         # success | failure | pending | skipped
    conclusion: str | None
    url: str | None
    started_at: datetime | None
    completed_at: datetime | None
    summary: str | None                 # Brief failure reason if failed

@dataclass
class LinkedIssue:
    source: str                         # &quot;github&quot; | &quot;jira&quot;
    key: str                            # Issue number or JIRA key
    title: str
    status: str
    url: str
    relationship: str                   # &quot;closes&quot; | &quot;references&quot; | &quot;related&quot;

@dataclass
class RelatedPR:
    number: int
    title: str
    author: str
    state: str
    relationship: str                   # &quot;same_files&quot; | &quot;same_branch&quot; | &quot;dependency&quot; | &quot;dependent&quot;
    overlap_files: list[str] | None     # Files touched by both PRs

@dataclass
class Diff:
    stats: DiffStats
    files: list[FileDiff]

@dataclass
class FileDiff:
    path: str
    status: str                         # added | modified | deleted | renamed
    additions: int
    deletions: int
    hunks: list[DiffHunk]

@dataclass
class PRSummary:
    &quot;&quot;&quot;Computed summary for quick understanding.&quot;&quot;&quot;
    one_liner: str                      # &quot;Add retry logic to payment gateway&quot;
    change_type: str                    # feature | bugfix | refactor | docs | test
    risk_level: str                     # low | medium | high
    blockers: list[str]                 # What&#039;s blocking merge
    ready_to_merge: bool
    key_changes: list[str]              # Bullet points of main changes
    outstanding_threads: int            # Unresolved comment threads</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>tool:pr_context:start</code></td><td>Fetch begins</td><td>pr_identifier, repo, include</td></tr>
            <tr><td><code>tool:pr_context:github_fetch</code></td><td>GitHub API call</td><td>endpoint, duration_ms</td></tr>
            <tr><td><code>tool:pr_context:jira_fetch</code></td><td>JIRA API call</td><td>issue_key, duration_ms</td></tr>
            <tr><td><code>tool:pr_context:complete</code></td><td>Fetch done</td><td>pr_number, sections_fetched</td></tr>
            <tr><td><code>tool:pr_context:error</code></td><td>Fetch failed</td><td>error_type, message</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       tool-pr-context                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Identifier â”‚â”€â”€â”€â–¶â”‚   Context   â”‚â”€â”€â”€â–¶â”‚   Summary   â”‚         â”‚
â”‚  â”‚   Resolver  â”‚    â”‚   Fetcher   â”‚    â”‚  Generator  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                            â”‚                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â–¼                  â–¼                  â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   GitHub    â”‚    â”‚    JIRA     â”‚    â”‚   Local     â”‚         â”‚
â”‚  â”‚   Client    â”‚    â”‚   Client    â”‚    â”‚    Git      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Identifier Resolver</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class IdentifierResolver:
    &quot;&quot;&quot;
    Resolves various PR identifier formats to canonical form.

    Supports:
    - PR number: &quot;123&quot; or &quot;#123&quot;
    - URL: &quot;https://github.com/owner/repo/pull/123&quot;
    - Branch: &quot;feature/add-retry&quot; (finds PR for branch)
    - Current: &quot;current&quot; or &quot;.&quot; (PR for current branch)
    &quot;&quot;&quot;

    async def resolve(self, identifier: str, repo: str | None) -&gt; ResolvedPR:
        # Detect format
        if identifier in (&quot;current&quot;, &quot;.&quot;):
            branch = await self._get_current_branch()
            return await self._find_pr_for_branch(branch, repo)

        if identifier.startswith(&quot;http&quot;):
            return self._parse_url(identifier)

        if identifier.replace(&quot;#&quot;, &quot;&quot;).isdigit():
            pr_number = int(identifier.replace(&quot;#&quot;, &quot;&quot;))
            return ResolvedPR(number=pr_number, repo=repo or await self._detect_repo())

        # Assume branch name
        return await self._find_pr_for_branch(identifier, repo)</code></pre>
        </div>
        <p>#### 2. Context Fetcher</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ContextFetcher:
    &quot;&quot;&quot;
    Orchestrates fetching from multiple sources based on &#039;include&#039; param.
    &quot;&quot;&quot;

    async def fetch(self, pr: ResolvedPR, include: list[str]) -&gt; PRContext:
        # Always fetch core PR details
        pr_details = await self.github.get_pr(pr.repo, pr.number)

        # Parallel fetch of included sections
        tasks = {}

        if &quot;comments&quot; in include:
            tasks[&quot;comments&quot;] = self._fetch_comments(pr)
        if &quot;reviews&quot; in include:
            tasks[&quot;reviews&quot;] = self._fetch_reviews(pr)
        if &quot;ci&quot; in include:
            tasks[&quot;ci&quot;] = self._fetch_ci_status(pr)
        if &quot;linked_issues&quot; in include:
            tasks[&quot;linked_issues&quot;] = self._fetch_linked_issues(pr, pr_details)
        if &quot;related_prs&quot; in include:
            tasks[&quot;related_prs&quot;] = self._fetch_related_prs(pr)
        if &quot;diff&quot; in include:
            tasks[&quot;diff&quot;] = self._fetch_diff(pr)
        if &quot;files&quot; in include:
            tasks[&quot;files&quot;] = self._fetch_files(pr)

        results = await asyncio.gather(*tasks.values(), return_exceptions=True)

        return PRContext(
            pr=pr_details,
            **dict(zip(tasks.keys(), results))
        )

    async def _fetch_linked_issues(self, pr: ResolvedPR, details: PRDetails) -&gt; list[LinkedIssue]:
        &quot;&quot;&quot;Extract and fetch linked issues from PR description and commits.&quot;&quot;&quot;
        # Parse PR description for issue references
        github_refs = self._parse_github_refs(details.description)
        jira_refs = self._parse_jira_refs(details.description)

        # Also check commit messages
        commits = await self.github.get_pr_commits(pr.repo, pr.number)
        for commit in commits:
            github_refs.extend(self._parse_github_refs(commit.message))
            jira_refs.extend(self._parse_jira_refs(commit.message))

        # Fetch issue details
        issues = []

        for ref in set(github_refs):
            issue = await self.github.get_issue(pr.repo, ref.number)
            issues.append(LinkedIssue(
                source=&quot;github&quot;,
                key=f&quot;#{ref.number}&quot;,
                title=issue.title,
                status=issue.state,
                url=issue.url,
                relationship=ref.relationship
            ))

        for ref in set(jira_refs):
            if self.jira:
                issue = await self.jira.get_issue(ref.key)
                issues.append(LinkedIssue(
                    source=&quot;jira&quot;,
                    key=ref.key,
                    title=issue.summary,
                    status=issue.status,
                    url=issue.url,
                    relationship=ref.relationship
                ))

        return issues</code></pre>
        </div>
        <p>#### 3. Summary Generator</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SummaryGenerator:
    &quot;&quot;&quot;
    Generates human-readable summaries from raw PR context.
    &quot;&quot;&quot;

    def generate(self, context: PRContext) -&gt; PRSummary:
        return PRSummary(
            one_liner=self._generate_one_liner(context),
            change_type=self._classify_change_type(context),
            risk_level=self._assess_risk(context),
            blockers=self._identify_blockers(context),
            ready_to_merge=self._check_merge_readiness(context),
            key_changes=self._extract_key_changes(context),
            outstanding_threads=self._count_unresolved_threads(context)
        )

    def _identify_blockers(self, context: PRContext) -&gt; list[str]:
        blockers = []

        # CI failures
        if context.ci_status and context.ci_status.overall == &quot;failure&quot;:
            failed = [c.name for c in context.ci_status.checks if c.status == &quot;failure&quot;]
            blockers.append(f&quot;CI failing: {&#039;, &#039;.join(failed)}&quot;)

        # Changes requested
        if context.pr.changes_requested &gt; 0:
            blockers.append(f&quot;{context.pr.changes_requested} reviewer(s) requested changes&quot;)

        # Unresolved threads
        unresolved = self._count_unresolved_threads(context)
        if unresolved &gt; 0:
            blockers.append(f&quot;{unresolved} unresolved comment thread(s)&quot;)

        # Missing approvals
        if context.pr.approvals &lt; 1:
            blockers.append(&quot;No approvals yet&quot;)

        # Draft status
        if context.pr.draft:
            blockers.append(&quot;PR is still in draft&quot;)

        return blockers

    def _assess_risk(self, context: PRContext) -&gt; str:
        &quot;&quot;&quot;Assess risk level based on changes.&quot;&quot;&quot;
        risk_score = 0

        if context.diff:
            # Large changes
            if context.diff.stats.total_changes &gt; 500:
                risk_score += 2
            elif context.diff.stats.total_changes &gt; 200:
                risk_score += 1

            # Many files
            if len(context.diff.files) &gt; 20:
                risk_score += 1

            # Critical file patterns
            critical_patterns = [&quot;migration&quot;, &quot;auth&quot;, &quot;payment&quot;, &quot;security&quot;, &quot;config&quot;]
            for file in context.diff.files:
                if any(p in file.path.lower() for p in critical_patterns):
                    risk_score += 1
                    break

        if risk_score &gt;= 3:
            return &quot;high&quot;
        elif risk_score &gt;= 1:
            return &quot;medium&quot;
        return &quot;low&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-pr-context:
  # GitHub configuration
  github:
    auth_token: &quot;${GITHUB_TOKEN}&quot;
    api_url: &quot;https://api.github.com&quot;      # or GitHub Enterprise URL

    # Rate limiting
    rate_limit_buffer: 100                  # Keep this many requests in reserve

    # Caching
    cache_ttl_seconds: 60                   # Cache PR data briefly

  # JIRA configuration (optional)
  jira:
    enabled: true
    base_url: &quot;${JIRA_URL}&quot;
    auth_token: &quot;${JIRA_TOKEN}&quot;

    # Issue key patterns to recognize
    key_patterns:
      - &quot;[A-Z]{2,10}-\\d+&quot;                  # Standard JIRA key format

  # Default behavior
  defaults:
    include:
      - comments
      - reviews
      - ci
      - linked_issues
      - diff
    diff_context_lines: 5

  # Related PR detection
  related_prs:
    # How to find related PRs
    strategies:
      - same_files                          # PRs touching same files
      - same_branch_prefix                  # feature/X-* branches
      - linked_issues                       # PRs linked to same issues

    # Limits
    max_related: 5
    lookback_days: 30                       # Only PRs from last 30 days

  # Summary generation
  summary:
    # Risk assessment thresholds
    high_risk_lines: 500
    medium_risk_lines: 200
    critical_paths:
      - &quot;migrations/&quot;
      - &quot;auth/&quot;
      - &quot;security/&quot;
      - &quot;payments/&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Current Branch PR Context</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;pr_identifier&quot;: &quot;current&quot;
}

# Output
{
    &quot;pr&quot;: {
        &quot;number&quot;: 456,
        &quot;title&quot;: &quot;Add retry logic to payment gateway&quot;,
        &quot;description&quot;: &quot;Implements exponential backoff retry for payment API calls.\n\nCloses JIRA-4523\nRelated to #451&quot;,
        &quot;author&quot;: &quot;alice&quot;,
        &quot;state&quot;: &quot;open&quot;,
        &quot;draft&quot;: false,
        &quot;base_branch&quot;: &quot;main&quot;,
        &quot;head_branch&quot;: &quot;feature/payment-retry&quot;,
        &quot;approvals&quot;: 1,
        &quot;changes_requested&quot;: 0,
        &quot;pending_reviewers&quot;: [&quot;bob&quot;, &quot;carol&quot;]
    },
    &quot;comments&quot;: [
        {
            &quot;id&quot;: &quot;c1&quot;,
            &quot;author&quot;: &quot;bob&quot;,
            &quot;body&quot;: &quot;Should we add a circuit breaker too?&quot;,
            &quot;created_at&quot;: &quot;2024-01-15T10:30:00Z&quot;,
            &quot;file_path&quot;: &quot;src/payments/gateway.py&quot;,
            &quot;line_number&quot;: 42
        }
    ],
    &quot;reviews&quot;: [
        {
            &quot;id&quot;: &quot;r1&quot;,
            &quot;author&quot;: &quot;carol&quot;,
            &quot;state&quot;: &quot;approved&quot;,
            &quot;body&quot;: &quot;LGTM! Nice use of tenacity.&quot;,
            &quot;submitted_at&quot;: &quot;2024-01-15T11:00:00Z&quot;
        }
    ],
    &quot;ci_status&quot;: {
        &quot;overall&quot;: &quot;success&quot;,
        &quot;checks&quot;: [
            {&quot;name&quot;: &quot;tests&quot;, &quot;status&quot;: &quot;success&quot;},
            {&quot;name&quot;: &quot;lint&quot;, &quot;status&quot;: &quot;success&quot;},
            {&quot;name&quot;: &quot;security-scan&quot;, &quot;status&quot;: &quot;success&quot;}
        ]
    },
    &quot;linked_issues&quot;: [
        {
            &quot;source&quot;: &quot;jira&quot;,
            &quot;key&quot;: &quot;JIRA-4523&quot;,
            &quot;title&quot;: &quot;Payment failures during peak hours&quot;,
            &quot;status&quot;: &quot;In Progress&quot;,
            &quot;relationship&quot;: &quot;closes&quot;
        },
        {
            &quot;source&quot;: &quot;github&quot;,
            &quot;key&quot;: &quot;#451&quot;,
            &quot;title&quot;: &quot;Improve payment reliability&quot;,
            &quot;status&quot;: &quot;open&quot;,
            &quot;relationship&quot;: &quot;related&quot;
        }
    ],
    &quot;summary&quot;: {
        &quot;one_liner&quot;: &quot;Adds retry logic with exponential backoff to payment gateway&quot;,
        &quot;change_type&quot;: &quot;feature&quot;,
        &quot;risk_level&quot;: &quot;medium&quot;,
        &quot;blockers&quot;: [&quot;1 unresolved comment thread(s)&quot;],
        &quot;ready_to_merge&quot;: false,
        &quot;key_changes&quot;: [
            &quot;New retry decorator in payments/retry.py&quot;,
            &quot;Applied to PaymentGateway.process_payment()&quot;,
            &quot;Config for max retries and backoff&quot;
        ],
        &quot;outstanding_threads&quot;: 1
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: PR Status Quick Check</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;pr_identifier&quot;: &quot;789&quot;,
    &quot;include&quot;: [&quot;ci&quot;, &quot;reviews&quot;]
}

# Output (minimal, fast)
{
    &quot;pr&quot;: {
        &quot;number&quot;: 789,
        &quot;title&quot;: &quot;Update dependencies&quot;,
        &quot;state&quot;: &quot;open&quot;,
        &quot;approvals&quot;: 0,
        &quot;changes_requested&quot;: 1,
        &quot;pending_reviewers&quot;: [&quot;security-team&quot;]
    },
    &quot;reviews&quot;: [
        {
            &quot;author&quot;: &quot;security-bot&quot;,
            &quot;state&quot;: &quot;changes_requested&quot;,
            &quot;body&quot;: &quot;Found 2 vulnerabilities in updated packages&quot;
        }
    ],
    &quot;ci_status&quot;: {
        &quot;overall&quot;: &quot;failure&quot;,
        &quot;checks&quot;: [
            {&quot;name&quot;: &quot;security-scan&quot;, &quot;status&quot;: &quot;failure&quot;, &quot;summary&quot;: &quot;CVE-2024-1234 in lodash&quot;}
        ]
    },
    &quot;summary&quot;: {
        &quot;blockers&quot;: [
            &quot;CI failing: security-scan&quot;,
            &quot;1 reviewer(s) requested changes&quot;
        ],
        &quot;ready_to_merge&quot;: false
    }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Access</h4>
        <li><strong>GitHub API</strong>: Uses provided token, respects repository permissions</li>
        <li><strong>JIRA API</strong>: Uses provided token, respects project permissions</li>
        <li><strong>Local git</strong>: Reads from current repository only</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Sensitive Data</h4>
        <li><strong>PR descriptions</strong>: May contain sensitive information</li>
        <li><strong>Comments</strong>: May contain sensitive discussions</li>
        <li><strong>Diff content</strong>: May contain sensitive code</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissions Model</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;network:github&quot;,       # GitHub API access
]

OPTIONAL_CAPABILITIES = [
    &quot;network:jira&quot;,         # JIRA API access (if configured)
    &quot;filesystem:read&quot;,      # Local git operations
]</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Risk Mitigations</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Risk</th><th>Mitigation</th></tr>
          </thead>
          <tbody>
            <tr><td>Token exposure</td><td>Tokens never logged or returned in output</td></tr>
            <tr><td>Unauthorized repo access</td><td>API calls fail if token lacks permissions</td></tr>
            <tr><td>Rate limiting</td><td>Built-in rate limit awareness, graceful degradation</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_identifier_resolver_handles_pr_number():
    resolver = IdentifierResolver()
    result = await resolver.resolve(&quot;123&quot;, &quot;owner/repo&quot;)
    assert result.number == 123
    assert result.repo == &quot;owner/repo&quot;

def test_identifier_resolver_handles_url():
    resolver = IdentifierResolver()
    result = await resolver.resolve(
        &quot;https://github.com/owner/repo/pull/456&quot;,
        None
    )
    assert result.number == 456
    assert result.repo == &quot;owner/repo&quot;

def test_summary_identifies_blockers():
    context = PRContext(
        pr=PRDetails(approvals=0, changes_requested=1, ...),
        ci_status=CIStatus(overall=&quot;failure&quot;, ...),
        ...
    )
    summary = SummaryGenerator().generate(context)
    assert len(summary.blockers) &gt;= 2
    assert not summary.ready_to_merge</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_fetches_real_pr_context(mock_github):
    &quot;&quot;&quot;Test against mock GitHub API.&quot;&quot;&quot;
    mock_github.setup_pr(number=123, title=&quot;Test PR&quot;, ...)

    tool = PRContextTool(config)
    result = await tool.execute({&quot;pr_identifier&quot;: &quot;123&quot;})

    assert result.pr.number == 123
    assert result.pr.title == &quot;Test PR&quot;

async def test_handles_linked_jira_issues(mock_github, mock_jira):
    &quot;&quot;&quot;Test JIRA integration.&quot;&quot;&quot;
    mock_github.setup_pr(description=&quot;Fixes PROJ-123&quot;)
    mock_jira.setup_issue(key=&quot;PROJ-123&quot;, summary=&quot;Bug&quot;)

    result = await tool.execute({&quot;pr_identifier&quot;: &quot;1&quot;, &quot;include&quot;: [&quot;linked_issues&quot;]})

    assert len(result.linked_issues) == 1
    assert result.linked_issues[0].key == &quot;PROJ-123&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>httpx</code> - Async HTTP client for API calls</li>
        <li><code>PyGithub</code> or direct API - GitHub operations</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>jira</code> - JIRA API client (if JIRA enabled)</li>
        <li><code>gitpython</code> - Local git operations</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Diff size limits</strong>: Should we truncate large diffs?</li>
        <p>   - Option A: Always return full diff (complete but potentially huge)</p>
        <p>   - Option B: Truncate with indication (smaller but lossy)</p>
        <p>   - Option C: Return stats only for large diffs, full for small</p>
        <li><strong>Comment threading</strong>: How to represent nested comment threads?</li>
        <p>   - Option A: Flat list with reply_to references</p>
        <p>   - Option B: Nested structure</p>
        <p>   - Option C: Both (flat + thread groupings)</p>
        <li><strong>CI log access</strong>: Should we fetch full CI logs or just status?</li>
        <p>   - Full logs useful for debugging but can be very large</p>
        <p>   - Could offer as separate follow-up query</p>
        <li><strong>Webhook vs polling</strong>: For real-time updates, should we support webhooks?</li>
        <p>   - Currently: Point-in-time fetch</p>
        <p>   - Future: Could add streaming updates</p>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-slack-search" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Slack Search</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-slack-search</code></p>
        </div>
        <h3>Overview</h3>
        <p>Search team Slack conversations to find decisions, context, and tribal knowledge. Surfaces relevant discussions that explain why code was written a certain way or captures historical context not found in documentation.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>"Why did we do it this way?" â†’ Ask around, hope someone remembers</td><td>Search Slack, find the original discussion</td></tr>
            <tr><td>Context lost when people leave</td><td>Institutional knowledge preserved and searchable</td></tr>
            <tr><td>Decisions made in DMs never documented</td><td>Surface relevant conversations (with permissions)</td></tr>
            <tr><td>Hours searching Slack's clunky UI</td><td>Semantic search finds relevant threads instantly</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Decision archaeology</strong>: "Why did we choose Redis over Memcached?"</li>
        <li><strong>Context recovery</strong>: "What was discussed about the auth refactor?"</li>
        <li><strong>Incident history</strong>: "What happened during the outage on Jan 15?"</li>
        <li><strong>Expert finding</strong>: "Who knows about the payment gateway?"</li>
        <li><strong>Meeting follow-up</strong>: "What did we decide in the sprint planning?"</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;slack_search&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Search Slack conversations for context and decisions.

    Search across:
    - Public channels you have access to
    - Private channels you&#039;re a member of
    - Direct messages (your own only)
    - Threads and replies

    Use for finding decisions, context, and institutional knowledge.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;query&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Search query (natural language or keywords)&quot;
            },
            &quot;channels&quot;: {
                &quot;type&quot;: &quot;array&quot;,
                &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;},
                &quot;description&quot;: &quot;Limit search to specific channels&quot;
            },
            &quot;from_user&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Filter by sender&quot;
            },
            &quot;date_range&quot;: {
                &quot;type&quot;: &quot;object&quot;,
                &quot;properties&quot;: {
                    &quot;after&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;format&quot;: &quot;date&quot;},
                    &quot;before&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;format&quot;: &quot;date&quot;}
                },
                &quot;description&quot;: &quot;Filter by date range&quot;
            },
            &quot;has&quot;: {
                &quot;type&quot;: &quot;array&quot;,
                &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;enum&quot;: [&quot;link&quot;, &quot;file&quot;, &quot;reaction&quot;, &quot;thread&quot;]},
                &quot;description&quot;: &quot;Filter by content type&quot;
            },
            &quot;include_threads&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: true,
                &quot;description&quot;: &quot;Include thread replies in search&quot;
            },
            &quot;max_results&quot;: {
                &quot;type&quot;: &quot;integer&quot;,
                &quot;default&quot;: 20,
                &quot;description&quot;: &quot;Maximum results to return&quot;
            }
        },
        &quot;required&quot;: [&quot;query&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class SlackSearchOutput:
    results: list[SlackMessage]
    total_count: int
    query_interpretation: str
    channels_searched: list[str]

@dataclass
class SlackMessage:
    # Message identity
    id: str                             # Slack message ID
    permalink: str                      # Direct link to message

    # Content
    text: str                           # Message text (markdown)
    user: SlackUser
    channel: SlackChannel
    timestamp: datetime

    # Thread context
    thread_ts: str | None               # Thread parent timestamp
    is_thread_parent: bool
    reply_count: int
    thread_participants: list[str]      # Users in thread

    # Rich content
    attachments: list[Attachment]
    files: list[SlackFile]
    reactions: list[Reaction]
    links: list[str]

    # Context
    thread_messages: list[SlackMessage] | None  # If is_thread_parent
    relevance_score: float

@dataclass
class SlackUser:
    id: str
    name: str
    display_name: str
    avatar_url: str | None

@dataclass
class SlackChannel:
    id: str
    name: str
    is_private: bool

@dataclass
class Attachment:
    title: str | None
    text: str | None
    type: str                           # message, file, etc.

@dataclass
class Reaction:
    name: str                           # emoji name
    count: int
    users: list[str]                    # User IDs who reacted</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      tool-slack-search                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Query     â”‚â”€â”€â”€â–¶â”‚   Slack     â”‚â”€â”€â”€â–¶â”‚   Result    â”‚         â”‚
â”‚  â”‚  Builder    â”‚    â”‚    API      â”‚    â”‚  Enricher   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Query Builder</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SlackQueryBuilder:
    &quot;&quot;&quot;Build Slack search queries from natural language.&quot;&quot;&quot;

    def build(self, input: SlackSearchInput) -&gt; str:
        &quot;&quot;&quot;Convert input to Slack search query syntax.&quot;&quot;&quot;
        parts = [input.query]

        if input.channels:
            channel_part = &quot; &quot;.join(f&quot;in:{c}&quot; for c in input.channels)
            parts.append(channel_part)

        if input.from_user:
            parts.append(f&quot;from:{input.from_user}&quot;)

        if input.date_range:
            if input.date_range.after:
                parts.append(f&quot;after:{input.date_range.after}&quot;)
            if input.date_range.before:
                parts.append(f&quot;before:{input.date_range.before}&quot;)

        if input.has:
            for h in input.has:
                parts.append(f&quot;has:{h}&quot;)

        return &quot; &quot;.join(parts)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Result Enricher</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ResultEnricher:
    &quot;&quot;&quot;Enrich search results with thread context.&quot;&quot;&quot;

    async def enrich(
        self,
        messages: list[dict],
        include_threads: bool
    ) -&gt; list[SlackMessage]:
        enriched = []

        for msg in messages:
            slack_msg = self._parse_message(msg)

            # Fetch thread if parent and include_threads
            if include_threads and slack_msg.is_thread_parent and slack_msg.reply_count &gt; 0:
                slack_msg.thread_messages = await self._fetch_thread(
                    slack_msg.channel.id,
                    slack_msg.thread_ts
                )

            enriched.append(slack_msg)

        return enriched

    async def _fetch_thread(
        self,
        channel_id: str,
        thread_ts: str
    ) -&gt; list[SlackMessage]:
        &quot;&quot;&quot;Fetch all replies in a thread.&quot;&quot;&quot;
        replies = await self.slack.conversations_replies(
            channel=channel_id,
            ts=thread_ts
        )
        return [self._parse_message(r) for r in replies[&quot;messages&quot;][1:]]  # Skip parent</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-slack-search:
  # Authentication
  auth:
    # User token with search:read scope
    user_token: &quot;${SLACK_USER_TOKEN}&quot;

    # Or bot token (more limited)
    # bot_token: &quot;${SLACK_BOT_TOKEN}&quot;

  # Search settings
  search:
    # Default channels to search (if none specified)
    default_channels:
      - general
      - engineering
      - incidents

    # Channels to never search
    excluded_channels:
      - random
      - social

    # Include archived channels
    include_archived: false

  # Results
  results:
    max_results: 50
    include_threads: true
    max_thread_messages: 20

  # Rate limiting
  rate_limit:
    requests_per_minute: 20</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Decision Search</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;query&quot;: &quot;Redis vs Memcached decision&quot;,
    &quot;channels&quot;: [&quot;engineering&quot;, &quot;architecture&quot;],
    &quot;has&quot;: [&quot;thread&quot;],
    &quot;max_results&quot;: 5
}

# Output
{
    &quot;results&quot;: [
        {
            &quot;id&quot;: &quot;msg123&quot;,
            &quot;permalink&quot;: &quot;https://workspace.slack.com/archives/C123/p1234567890&quot;,
            &quot;text&quot;: &quot;We need to decide on caching. Options are Redis and Memcached. Let&#039;s discuss pros/cons.&quot;,
            &quot;user&quot;: {&quot;name&quot;: &quot;alice&quot;, &quot;display_name&quot;: &quot;Alice Chen&quot;},
            &quot;channel&quot;: {&quot;name&quot;: &quot;architecture&quot;, &quot;is_private&quot;: false},
            &quot;timestamp&quot;: &quot;2023-11-15T10:30:00Z&quot;,
            &quot;is_thread_parent&quot;: true,
            &quot;reply_count&quot;: 12,
            &quot;thread_messages&quot;: [
                {
                    &quot;text&quot;: &quot;Redis gives us persistence and pub/sub which we&#039;ll need for the notification system&quot;,
                    &quot;user&quot;: {&quot;name&quot;: &quot;bob&quot;}
                },
                {
                    &quot;text&quot;: &quot;Agreed. Let&#039;s go with Redis. I&#039;ll document this in the ADR.&quot;,
                    &quot;user&quot;: {&quot;name&quot;: &quot;alice&quot;}
                }
            ],
            &quot;relevance_score&quot;: 0.95
        }
    ],
    &quot;total_count&quot;: 3,
    &quot;query_interpretation&quot;: &quot;Searching for &#039;Redis vs Memcached decision&#039; in #architecture, #engineering&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Incident Context</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;query&quot;: &quot;outage payment gateway&quot;,
    &quot;channels&quot;: [&quot;incidents&quot;],
    &quot;date_range&quot;: {&quot;after&quot;: &quot;2024-01-01&quot;, &quot;before&quot;: &quot;2024-01-31&quot;}
}

# Output
{
    &quot;results&quot;: [
        {
            &quot;text&quot;: &quot;:rotating_light: INCIDENT: Payment gateway timeout errors spiking&quot;,
            &quot;channel&quot;: {&quot;name&quot;: &quot;incidents&quot;},
            &quot;timestamp&quot;: &quot;2024-01-15T03:45:00Z&quot;,
            &quot;reply_count&quot;: 45,
            &quot;thread_messages&quot;: [
                {&quot;text&quot;: &quot;Root cause: Database connection pool exhaustion&quot;},
                {&quot;text&quot;: &quot;Fix deployed. Monitoring.&quot;},
                {&quot;text&quot;: &quot;Resolved. Postmortem scheduled for tomorrow.&quot;}
            ],
            &quot;reactions&quot;: [
                {&quot;name&quot;: &quot;eyes&quot;, &quot;count&quot;: 8},
                {&quot;name&quot;: &quot;white_check_mark&quot;, &quot;count&quot;: 5}
            ]
        }
    ]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Access</h4>
        <li>Only searches channels user has access to</li>
        <li>User token required (more access than bot token)</li>
        <li>DMs only searchable by the user themselves</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Sensitive Data</h4>
        <li>Messages may contain sensitive information</li>
        <li>Results should be treated with same confidentiality as Slack itself</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;network:slack&quot;,        # Slack API access
]

# Required Slack scopes
SLACK_SCOPES = [
    &quot;search:read&quot;,          # Search messages
    &quot;channels:read&quot;,        # List channels
    &quot;groups:read&quot;,          # Private channels
    &quot;im:read&quot;,              # Direct messages
    &quot;users:read&quot;,           # User info
]</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>slack-sdk</code> - Official Slack Python SDK</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>None</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Bot vs User token</strong>: User tokens have more access but require OAuth flow</li>
        <li><strong>Caching</strong>: Should we cache search results? For how long?</li>
        <li><strong>Summarization</strong>: Should we AI-summarize long threads?</li>
        <li><strong>Privacy</strong>: How to handle searches that might surface sensitive DMs?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-swarm" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Swarm</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Medium Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-swarm</code></p>
        </div>
        <h3>Overview</h3>
        <p>A tool for parallel exploration with convergence - spawn multiple variations of the same agent with different parameters, let them explore independently, then converge on the best result. Useful for creative tasks, optimization, and exploring solution spaces.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Why a Tool, Not an Orchestrator?</h4>
        <p>Like <code>tool-collaborative</code>, swarm exploration is <strong>policy</strong> (when to explore, how many variations, how to converge) not <strong>mechanism</strong>. The agent decides when parallel exploration adds value.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Single attempt</td><td>Multiple parallel explorations</td></tr>
            <tr><td>Local optima</td><td>Broader solution space coverage</td></tr>
            <tr><td>One temperature setting</td><td>Temperature sweep</td></tr>
            <tr><td>Manual iteration</td><td>Automated best-of-n</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Main Session                                                   â”‚
â”‚                                                                 â”‚
â”‚  Agent: &quot;Let me explore multiple approaches...&quot;                 â”‚
â”‚    â”‚                                                            â”‚
â”‚    â””â”€â–º tool-swarm.execute(...)                                 â”‚
â”‚          â”‚                                                      â”‚
â”‚          â”œâ”€â–º variation 1 (temp=0.3) â”€â”€â”                        â”‚
â”‚          â”œâ”€â–º variation 2 (temp=0.5) â”€â”€â”¼â”€â–º parallel             â”‚
â”‚          â”œâ”€â–º variation 3 (temp=0.7) â”€â”€â”¤                        â”‚
â”‚          â”œâ”€â–º variation 4 (temp=0.9) â”€â”€â”˜                        â”‚
â”‚          â”‚                                                      â”‚
â”‚          â””â”€â–º converge (vote/best/synthesis) â”€â”€â–º return         â”‚
â”‚                                                                 â”‚
â”‚  Agent: &quot;After exploring 4 variations, the best approach...&quot;   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Tool Contract</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">name: tool-swarm
description: Parallel exploration with multiple agent variations

parameters:
  task:
    type: string
    description: The task to explore
    required: true

  variations:
    type: integer
    default: 3
    description: Number of parallel variations to spawn

  vary_by:
    type: string
    enum: [temperature, prompt, model, custom]
    default: temperature
    description: What to vary across agents

  temperature_range:
    type: array
    default: [0.3, 0.5, 0.7, 0.9]
    description: Temperatures to use (if vary_by=temperature)

  prompt_variations:
    type: array
    description: Different prompts to try (if vary_by=prompt)

  convergence:
    type: string
    enum: [best_of, vote, synthesis, all]
    default: best_of
    description: How to select/combine results

  evaluation_criteria:
    type: string
    description: Criteria for judging &quot;best&quot; result

  base_config:
    type: object
    description: Base agent configuration (variations modify this)

returns:
  type: object
  properties:
    result:
      type: string
      description: Converged result
    all_results:
      type: array
      description: All variation results
    selection:
      type: object
      description: Why this result was selected
    metadata:
      type: object
      description: Execution stats</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># tool.py

from amplifier_core import AmplifierSession
import asyncio
from dataclasses import dataclass

@dataclass
class ExplorationResult:
    variation_id: int
    parameters: dict
    response: str
    score: float | None = None
    tokens_used: int = 0


class SwarmTool:
    &quot;&quot;&quot;Tool for parallel exploration with convergence.&quot;&quot;&quot;

    name = &quot;tool-swarm&quot;

    async def execute(
        self,
        task: str,
        variations: int = 3,
        vary_by: str = &quot;temperature&quot;,
        temperature_range: list[float] | None = None,
        prompt_variations: list[str] | None = None,
        convergence: str = &quot;best_of&quot;,
        evaluation_criteria: str | None = None,
        base_config: dict | None = None
    ) -&gt; dict:
        &quot;&quot;&quot;Execute parallel exploration.&quot;&quot;&quot;

        # Generate variation configs
        variation_configs = self._generate_variations(
            base_config=base_config or self._default_config(),
            vary_by=vary_by,
            count=variations,
            temperature_range=temperature_range or [0.3, 0.5, 0.7, 0.9],
            prompt_variations=prompt_variations
        )

        # Execute all variations in parallel
        results = await self._parallel_explore(task, variation_configs)

        # Converge on result
        if convergence == &quot;best_of&quot;:
            final = await self._best_of_convergence(
                results, evaluation_criteria or &quot;quality and correctness&quot;
            )
        elif convergence == &quot;vote&quot;:
            final = await self._voting_convergence(results)
        elif convergence == &quot;synthesis&quot;:
            final = await self._synthesis_convergence(task, results)
        else:  # all
            final = self._all_results(results)

        return {
            &quot;result&quot;: final[&quot;result&quot;],
            &quot;all_results&quot;: [r.__dict__ for r in results],
            &quot;selection&quot;: final.get(&quot;selection&quot;, {}),
            &quot;metadata&quot;: {
                &quot;variations_count&quot;: len(results),
                &quot;vary_by&quot;: vary_by,
                &quot;convergence&quot;: convergence,
                &quot;total_tokens&quot;: sum(r.tokens_used for r in results)
            }
        }

    def _generate_variations(
        self,
        base_config: dict,
        vary_by: str,
        count: int,
        temperature_range: list[float],
        prompt_variations: list[str] | None
    ) -&gt; list[dict]:
        &quot;&quot;&quot;Generate variation configurations.&quot;&quot;&quot;

        variations = []

        if vary_by == &quot;temperature&quot;:
            # Use specified temperatures or generate range
            temps = temperature_range[:count]
            for i, temp in enumerate(temps):
                config = self._deep_copy(base_config)
                config[&quot;providers&quot;][0][&quot;config&quot;][&quot;temperature&quot;] = temp
                config[&quot;_variation&quot;] = {&quot;id&quot;: i, &quot;temperature&quot;: temp}
                variations.append(config)

        elif vary_by == &quot;prompt&quot;:
            # Use different prompt framings
            for i, prompt_mod in enumerate(prompt_variations[:count]):
                config = self._deep_copy(base_config)
                config[&quot;_variation&quot;] = {&quot;id&quot;: i, &quot;prompt_modifier&quot;: prompt_mod}
                config[&quot;_prompt_modifier&quot;] = prompt_mod
                variations.append(config)

        elif vary_by == &quot;model&quot;:
            # Use different models
            models = [&quot;claude-sonnet-4-5&quot;, &quot;claude-opus-4&quot;]
            for i, model in enumerate(models[:count]):
                config = self._deep_copy(base_config)
                config[&quot;providers&quot;][0][&quot;config&quot;][&quot;model&quot;] = model
                config[&quot;_variation&quot;] = {&quot;id&quot;: i, &quot;model&quot;: model}
                variations.append(config)

        return variations

    async def _parallel_explore(
        self,
        task: str,
        variation_configs: list[dict]
    ) -&gt; list[ExplorationResult]:
        &quot;&quot;&quot;Execute all variations in parallel.&quot;&quot;&quot;

        async def run_variation(config: dict) -&gt; ExplorationResult:
            variation_info = config.pop(&quot;_variation&quot;, {&quot;id&quot;: 0})
            prompt_modifier = config.pop(&quot;_prompt_modifier&quot;, None)

            # Modify prompt if needed
            actual_task = task
            if prompt_modifier:
                actual_task = f&quot;{prompt_modifier}\n\n{task}&quot;

            async with AmplifierSession(config=config) as session:
                response = await session.execute(actual_task)

                return ExplorationResult(
                    variation_id=variation_info[&quot;id&quot;],
                    parameters=variation_info,
                    response=response.text,
                    tokens_used=response.usage.total_tokens
                )

        results = await asyncio.gather(*[
            run_variation(config) for config in variation_configs
        ])

        return list(results)

    async def _best_of_convergence(
        self,
        results: list[ExplorationResult],
        criteria: str
    ) -&gt; dict:
        &quot;&quot;&quot;Select best result using evaluator.&quot;&quot;&quot;

        # Use AI to evaluate and select best
        evaluation_prompt = f&quot;&quot;&quot;
Evaluate these {len(results)} responses and select the best one.

Evaluation Criteria: {criteria}

## Responses

{self._format_results_for_eval(results)}

## Your Task
1. Score each response 1-10 based on the criteria
2. Explain your reasoning for each score
3. Select the best response
4. Explain why it&#039;s the best

Respond with:
- scores: [list of scores]
- best_index: (0-indexed)
- reasoning: explanation
&quot;&quot;&quot;

        async with AmplifierSession(config=self._evaluator_config()) as session:
            eval_response = await session.execute(evaluation_prompt)

        # Parse evaluation (simplified - would use structured output)
        best_idx = self._parse_best_index(eval_response.text, len(results))
        best_result = results[best_idx]

        # Update scores
        scores = self._parse_scores(eval_response.text, len(results))
        for i, result in enumerate(results):
            result.score = scores[i] if i &lt; len(scores) else None

        return {
            &quot;result&quot;: best_result.response,
            &quot;selection&quot;: {
                &quot;method&quot;: &quot;best_of&quot;,
                &quot;selected_variation&quot;: best_result.variation_id,
                &quot;parameters&quot;: best_result.parameters,
                &quot;score&quot;: best_result.score,
                &quot;reasoning&quot;: eval_response.text
            }
        }

    async def _voting_convergence(
        self,
        results: list[ExplorationResult]
    ) -&gt; dict:
        &quot;&quot;&quot;Identify consensus across variations.&quot;&quot;&quot;

        # Extract key points from each result
        # Find overlapping conclusions
        # Return majority view

        voting_prompt = f&quot;&quot;&quot;
Analyze these {len(results)} responses for consensus.

{self._format_results_for_eval(results)}

Identify:
1. Points all/most responses agree on
2. Points with disagreement
3. The majority conclusion

Synthesize a response that represents the consensus view.
&quot;&quot;&quot;

        async with AmplifierSession(config=self._evaluator_config()) as session:
            consensus = await session.execute(voting_prompt)

        return {
            &quot;result&quot;: consensus.text,
            &quot;selection&quot;: {
                &quot;method&quot;: &quot;vote&quot;,
                &quot;variations_analyzed&quot;: len(results)
            }
        }

    async def _synthesis_convergence(
        self,
        task: str,
        results: list[ExplorationResult]
    ) -&gt; dict:
        &quot;&quot;&quot;Synthesize best elements from all variations.&quot;&quot;&quot;

        synthesis_prompt = f&quot;&quot;&quot;
Original task: {task}

You have {len(results)} different approaches to this task:

{self._format_results_for_eval(results)}

Create an improved response that:
1. Takes the best elements from each approach
2. Addresses weaknesses found in individual responses
3. Synthesizes into a coherent, superior result

Provide the synthesized response.
&quot;&quot;&quot;

        async with AmplifierSession(config=self._evaluator_config()) as session:
            synthesis = await session.execute(synthesis_prompt)

        return {
            &quot;result&quot;: synthesis.text,
            &quot;selection&quot;: {
                &quot;method&quot;: &quot;synthesis&quot;,
                &quot;variations_synthesized&quot;: len(results)
            }
        }

    def _format_results_for_eval(self, results: list[ExplorationResult]) -&gt; str:
        &quot;&quot;&quot;Format results for evaluation prompt.&quot;&quot;&quot;

        formatted = []
        for r in results:
            formatted.append(
                f&quot;### Variation {r.variation_id} ({r.parameters})\n{r.response}&quot;
            )
        return &quot;\n\n---\n\n&quot;.join(formatted)

    def _evaluator_config(self) -&gt; dict:
        &quot;&quot;&quot;Config for evaluation/synthesis agent.&quot;&quot;&quot;

        return {
            &quot;session&quot;: {
                &quot;orchestrator&quot;: &quot;loop-basic&quot;,
                &quot;context&quot;: &quot;context-simple&quot;
            },
            &quot;providers&quot;: [{
                &quot;module&quot;: &quot;provider-anthropic&quot;,
                &quot;source&quot;: &quot;git+https://github.com/microsoft/amplifier-module-provider-anthropic@main&quot;,
                &quot;config&quot;: {
                    &quot;model&quot;: &quot;claude-sonnet-4-5&quot;,
                    &quot;temperature&quot;: 0.2  # Low temp for evaluation
                }
            }]
        }

    def _default_config(self) -&gt; dict:
        &quot;&quot;&quot;Default base config for variations.&quot;&quot;&quot;

        return {
            &quot;session&quot;: {
                &quot;orchestrator&quot;: &quot;loop-basic&quot;,
                &quot;context&quot;: &quot;context-simple&quot;
            },
            &quot;providers&quot;: [{
                &quot;module&quot;: &quot;provider-anthropic&quot;,
                &quot;source&quot;: &quot;git+https://github.com/microsoft/amplifier-module-provider-anthropic@main&quot;,
                &quot;config&quot;: {
                    &quot;model&quot;: &quot;claude-sonnet-4-5&quot;,
                    &quot;temperature&quot;: 0.5
                }
            }]
        }</code></pre>
        </div>
        <p>---</p>
        <h3>Variation Strategies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Temperature Sweep</h4>
        <p>Explore creativity spectrum:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">result = await tool_swarm.execute(
    task=&quot;Write a tagline for our new AI product&quot;,
    vary_by=&quot;temperature&quot;,
    temperature_range=[0.2, 0.5, 0.8, 1.0],
    convergence=&quot;best_of&quot;,
    evaluation_criteria=&quot;creativity, memorability, brand fit&quot;
)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Prompt Variations</h4>
        <p>Explore different framings:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">result = await tool_swarm.execute(
    task=&quot;Explain quantum computing&quot;,
    vary_by=&quot;prompt&quot;,
    prompt_variations=[
        &quot;Explain like I&#039;m a 5-year-old:&quot;,
        &quot;Explain for a software engineer:&quot;,
        &quot;Explain for a physics PhD:&quot;,
        &quot;Explain using only analogies:&quot;
    ],
    convergence=&quot;all&quot;  # Keep all for different audiences
)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Model Comparison</h4>
        <p>Compare model capabilities:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">result = await tool_swarm.execute(
    task=&quot;Solve this complex reasoning problem...&quot;,
    vary_by=&quot;model&quot;,
    convergence=&quot;best_of&quot;,
    evaluation_criteria=&quot;correctness and reasoning clarity&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Convergence Strategies</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Strategy</th><th>Description</th><th>Best For</th></tr>
          </thead>
          <tbody>
            <tr><td><code>best_of</code></td><td>Evaluate and select best</td><td>Clear quality criteria</td></tr>
            <tr><td><code>vote</code></td><td>Find consensus view</td><td>Factual tasks</td></tr>
            <tr><td><code>synthesis</code></td><td>Combine best elements</td><td>Creative tasks</td></tr>
            <tr><td><code>all</code></td><td>Return all results</td><td>Need multiple versions</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Usage Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Creative Exploration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Generate multiple creative options
result = await tool_swarm.execute(
    task=&quot;Design a logo concept for an eco-friendly tech startup&quot;,
    variations=5,
    vary_by=&quot;temperature&quot;,
    temperature_range=[0.5, 0.7, 0.9, 1.0, 1.2],
    convergence=&quot;all&quot;,  # Present all options to user
)

# User picks their favorite from result[&quot;all_results&quot;]</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Solution Optimization</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Find best solution approach
result = await tool_swarm.execute(
    task=f&quot;Optimize this function for performance:\n\n{code}&quot;,
    variations=4,
    vary_by=&quot;prompt&quot;,
    prompt_variations=[
        &quot;Focus on algorithmic complexity:&quot;,
        &quot;Focus on memory efficiency:&quot;,
        &quot;Focus on parallelization:&quot;,
        &quot;Focus on caching strategies:&quot;
    ],
    convergence=&quot;synthesis&quot;,  # Combine best optimizations
    evaluation_criteria=&quot;performance improvement, code clarity, correctness&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>tool:swarm:start</code></td><td>Swarm started</td><td>task, variations, vary_by</td></tr>
            <tr><td><code>tool:swarm:variation:start</code></td><td>Variation started</td><td>variation_id, parameters</td></tr>
            <tr><td><code>tool:swarm:variation:complete</code></td><td>Variation finished</td><td>variation_id, tokens</td></tr>
            <tr><td><code>tool:swarm:convergence:start</code></td><td>Convergence started</td><td>method</td></tr>
            <tr><td><code>tool:swarm:complete</code></td><td>Swarm complete</td><td>selected, total_tokens</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tools:
  - module: tool-swarm
    source: git+https://github.com/microsoft/amplifier-module-tool-swarm@main
    config:
      # Defaults
      default_variations: 3
      default_convergence: best_of

      # Limits
      max_variations: 10
      max_parallel: 5
      variation_timeout: 120s

      # Default temperature range
      temperature_range: [0.3, 0.5, 0.7, 0.9]</code></pre>
        </div>
        <p>---</p>
        <h3>Comparison with tool-collaborative</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Aspect</th><th>tool-swarm</th><th>tool-collaborative</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Agents</strong></td><td>Same agent, different params</td><td>Different specialist agents</td></tr>
            <tr><td><strong>Goal</strong></td><td>Explore solution space</td><td>Multiple perspectives</td></tr>
            <tr><td><strong>Variation</strong></td><td>Parameters (temp, prompt)</td><td>Roles and expertise</td></tr>
            <tr><td><strong>Best for</strong></td><td>Creative, optimization</td><td>Analysis, review</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Adaptive stopping</strong>: Stop early if consensus emerges?</li>
        <li><strong>Cost vs exploration</strong>: Auto-tune variation count by task complexity?</li>
        <li><strong>Learning</strong>: Track which temperatures/prompts work best for task types?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification (converted from orchestrator to tool)</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-tech-debt-scanner" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Tech Debt Scanner</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-tech-debt-scanner</code></p>
        </div>
        <h3>Overview</h3>
        <p>Identify and categorize technical debt across the codebase. Detects anti-patterns, outdated dependencies, dead code, code duplication, complexity hotspots, and TODO/FIXME comments. Provides prioritized recommendations for debt reduction.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Tech debt accumulates invisibly</td><td>Quantified, visible debt inventory</td></tr>
            <tr><td>"We'll fix it later" â†’ never fixed</td><td>Prioritized backlog with impact estimates</td></tr>
            <tr><td>Outdated deps discovered in incidents</td><td>Proactive vulnerability and freshness scanning</td></tr>
            <tr><td>Gut feeling about code quality</td><td>Data-driven quality metrics</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Debt inventory</strong>: "What tech debt exists in our codebase?"</li>
        <li><strong>Sprint planning</strong>: "What debt should we tackle this sprint?"</li>
        <li><strong>Risk assessment</strong>: "What's our exposure from outdated dependencies?"</li>
        <li><strong>Refactoring targets</strong>: "Where are the complexity hotspots?"</li>
        <li><strong>Quality gates</strong>: "Does this PR increase tech debt?"</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;tech_debt_scanner&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Scan codebase for technical debt and quality issues.

    Categories:
    - dependencies: Outdated, vulnerable, or deprecated deps
    - dead_code: Unused functions, classes, imports
    - complexity: High cyclomatic complexity, long functions
    - duplication: Duplicated code blocks
    - todos: TODO, FIXME, HACK comments
    - patterns: Anti-patterns, code smells
    - tests: Missing or inadequate test coverage

    Use for debt prioritization, sprint planning, and quality monitoring.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;scope&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Path pattern to scan (default: entire repo)&quot;
            },
            &quot;categories&quot;: {
                &quot;type&quot;: &quot;array&quot;,
                &quot;items&quot;: {
                    &quot;type&quot;: &quot;string&quot;,
                    &quot;enum&quot;: [&quot;dependencies&quot;, &quot;dead_code&quot;, &quot;complexity&quot;, &quot;duplication&quot;, &quot;todos&quot;, &quot;patterns&quot;, &quot;tests&quot;, &quot;all&quot;]
                },
                &quot;default&quot;: [&quot;all&quot;],
                &quot;description&quot;: &quot;Debt categories to scan&quot;
            },
            &quot;severity_threshold&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;low&quot;, &quot;medium&quot;, &quot;high&quot;, &quot;critical&quot;],
                &quot;default&quot;: &quot;low&quot;,
                &quot;description&quot;: &quot;Minimum severity to report&quot;
            },
            &quot;include_metrics&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: true,
                &quot;description&quot;: &quot;Include code metrics in output&quot;
            },
            &quot;compare_to&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Git ref to compare against (for delta analysis)&quot;
            }
        }
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class TechDebtScanOutput:
    scope: str
    scan_time: datetime
    categories_scanned: list[str]

    # Findings by category
    dependencies: DependencyDebt | None
    dead_code: DeadCodeDebt | None
    complexity: ComplexityDebt | None
    duplication: DuplicationDebt | None
    todos: TodoDebt | None
    patterns: PatternDebt | None
    tests: TestDebt | None

    # Summary
    summary: DebtSummary
    recommendations: list[Recommendation]

    # Delta (if compare_to specified)
    delta: DebtDelta | None

@dataclass
class DependencyDebt:
    outdated: list[OutdatedDep]
    vulnerable: list[VulnerableDep]
    deprecated: list[DeprecatedDep]
    unused: list[UnusedDep]

@dataclass
class OutdatedDep:
    name: str
    current_version: str
    latest_version: str
    age_days: int
    breaking_changes: bool
    update_effort: str                  # low | medium | high

@dataclass
class VulnerableDep:
    name: str
    version: str
    cve_ids: list[str]
    severity: str                       # low | medium | high | critical
    fixed_in: str | None
    description: str

@dataclass
class DeadCodeDebt:
    unused_functions: list[UnusedSymbol]
    unused_classes: list[UnusedSymbol]
    unused_imports: list[UnusedImport]
    unused_files: list[str]
    total_dead_lines: int

@dataclass
class UnusedSymbol:
    name: str
    file_path: str
    line_number: int
    lines_of_code: int
    confidence: float                   # 0-1, lower if might be used dynamically

@dataclass
class ComplexityDebt:
    hotspots: list[ComplexityHotspot]
    long_functions: list[LongFunction]
    deep_nesting: list[DeepNesting]
    average_complexity: float

@dataclass
class ComplexityHotspot:
    file_path: str
    function_name: str
    cyclomatic_complexity: int
    cognitive_complexity: int
    lines: int
    recommendation: str

@dataclass
class DuplicationDebt:
    duplicates: list[CodeDuplicate]
    total_duplicated_lines: int
    duplication_percentage: float

@dataclass
class CodeDuplicate:
    locations: list[DuplicateLocation]
    lines: int
    similarity: float                   # 0-1
    suggested_extraction: str | None

@dataclass
class TodoDebt:
    todos: list[TodoItem]
    by_age: dict[str, int]              # &quot;&lt; 1 month&quot;: 5, &quot;1-6 months&quot;: 10, ...
    by_author: dict[str, int]

@dataclass
class TodoItem:
    type: str                           # TODO | FIXME | HACK | XXX
    text: str
    file_path: str
    line_number: int
    author: str | None                  # From git blame
    age_days: int | None
    linked_issue: str | None            # If references ticket

@dataclass
class PatternDebt:
    anti_patterns: list[AntiPattern]
    code_smells: list[CodeSmell]

@dataclass
class AntiPattern:
    name: str                           # &quot;God Class&quot;, &quot;Spaghetti Code&quot;, etc.
    file_path: str
    description: str
    severity: str
    fix_suggestion: str

@dataclass
class TestDebt:
    untested_functions: list[str]
    low_coverage_files: list[FileCoverage]
    missing_test_files: list[str]
    flaky_tests: list[str]

@dataclass
class DebtSummary:
    total_items: int
    by_severity: dict[str, int]
    by_category: dict[str, int]
    estimated_effort_hours: float
    debt_score: float                   # 0-100, lower is better
    trend: str                          # improving | stable | degrading

@dataclass
class Recommendation:
    priority: int                       # 1 = highest
    category: str
    title: str
    description: str
    effort: str
    impact: str
    affected_items: list[str]</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    tool-tech-debt-scanner                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              Scanner Orchestrator                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚           â”‚           â”‚           â”‚                   â”‚
â”‚         â–¼           â–¼           â–¼           â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Dep   â”‚ â”‚  Dead   â”‚ â”‚  Dup    â”‚ â”‚ Pattern â”‚ ...          â”‚
â”‚  â”‚ Scanner â”‚ â”‚  Code   â”‚ â”‚ Finder  â”‚ â”‚ Checker â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚           Prioritization Engine                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Scanner Components</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class DependencyScanner:
    &quot;&quot;&quot;Scan for dependency-related tech debt.&quot;&quot;&quot;

    async def scan(self, scope: str) -&gt; DependencyDebt:
        # Find package manifests
        manifests = await self._find_manifests(scope)

        results = DependencyDebt(
            outdated=[], vulnerable=[], deprecated=[], unused=[]
        )

        for manifest in manifests:
            if manifest.type == &quot;python&quot;:
                deps = await self._scan_python_deps(manifest)
            elif manifest.type == &quot;npm&quot;:
                deps = await self._scan_npm_deps(manifest)
            # ... other package managers

            results.outdated.extend(deps.outdated)
            results.vulnerable.extend(deps.vulnerable)

        return results

    async def _scan_python_deps(self, manifest: Manifest) -&gt; DependencyScanResult:
        # Check for outdated
        outdated = []
        for dep, version in manifest.dependencies.items():
            latest = await self._get_latest_version(dep, &quot;pypi&quot;)
            if latest and version &lt; latest:
                outdated.append(OutdatedDep(
                    name=dep,
                    current_version=str(version),
                    latest_version=str(latest),
                    age_days=self._calculate_age(version, latest),
                    breaking_changes=self._has_breaking_changes(version, latest),
                    update_effort=self._estimate_effort(dep, version, latest)
                ))

        # Check for vulnerabilities (via safety, pip-audit, etc.)
        vulnerable = await self._check_vulnerabilities(manifest)

        return DependencyScanResult(outdated=outdated, vulnerable=vulnerable)


class DeadCodeScanner:
    &quot;&quot;&quot;Detect unused code.&quot;&quot;&quot;

    async def scan(self, scope: str) -&gt; DeadCodeDebt:
        # Build dependency graph
        graph = await self._build_dependency_graph(scope)

        # Find unreachable nodes
        entry_points = await self._find_entry_points(scope)
        reachable = self._compute_reachable(graph, entry_points)

        unused_functions = []
        unused_classes = []

        for symbol in graph.symbols:
            if symbol.id not in reachable:
                confidence = self._compute_confidence(symbol)

                item = UnusedSymbol(
                    name=symbol.name,
                    file_path=symbol.file_path,
                    line_number=symbol.line_number,
                    lines_of_code=symbol.lines,
                    confidence=confidence
                )

                if symbol.kind == &quot;function&quot;:
                    unused_functions.append(item)
                elif symbol.kind == &quot;class&quot;:
                    unused_classes.append(item)

        # Find unused imports
        unused_imports = await self._find_unused_imports(scope)

        return DeadCodeDebt(
            unused_functions=unused_functions,
            unused_classes=unused_classes,
            unused_imports=unused_imports,
            unused_files=self._find_unused_files(reachable),
            total_dead_lines=sum(s.lines_of_code for s in unused_functions + unused_classes)
        )


class PrioritizationEngine:
    &quot;&quot;&quot;Prioritize debt items for remediation.&quot;&quot;&quot;

    def prioritize(self, debt: TechDebtScanOutput) -&gt; list[Recommendation]:
        recommendations = []

        # Critical vulnerabilities first
        for vuln in debt.dependencies.vulnerable:
            if vuln.severity == &quot;critical&quot;:
                recommendations.append(Recommendation(
                    priority=1,
                    category=&quot;dependencies&quot;,
                    title=f&quot;Critical vulnerability in {vuln.name}&quot;,
                    description=f&quot;{vuln.description}. CVE: {&#039;, &#039;.join(vuln.cve_ids)}&quot;,
                    effort=&quot;low&quot; if vuln.fixed_in else &quot;high&quot;,
                    impact=&quot;critical&quot;,
                    affected_items=[vuln.name]
                ))

        # High-impact complexity hotspots
        for hotspot in sorted(debt.complexity.hotspots,
                             key=lambda h: h.cyclomatic_complexity,
                             reverse=True)[:5]:
            recommendations.append(Recommendation(
                priority=2,
                category=&quot;complexity&quot;,
                title=f&quot;Refactor {hotspot.function_name}&quot;,
                description=f&quot;Cyclomatic complexity: {hotspot.cyclomatic_complexity}&quot;,
                effort=&quot;medium&quot;,
                impact=&quot;high&quot;,
                affected_items=[f&quot;{hotspot.file_path}:{hotspot.function_name}&quot;]
            ))

        # Large dead code blocks
        significant_dead = [d for d in debt.dead_code.unused_functions
                          if d.lines_of_code &gt; 50 and d.confidence &gt; 0.8]
        if significant_dead:
            recommendations.append(Recommendation(
                priority=3,
                category=&quot;dead_code&quot;,
                title=f&quot;Remove {len(significant_dead)} unused functions&quot;,
                description=f&quot;~{sum(d.lines_of_code for d in significant_dead)} lines of dead code&quot;,
                effort=&quot;low&quot;,
                impact=&quot;medium&quot;,
                affected_items=[d.name for d in significant_dead]
            ))

        return sorted(recommendations, key=lambda r: r.priority)</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-tech-debt-scanner:
  # Scanning settings
  scan:
    # File patterns
    include:
      - &quot;**/*.py&quot;
      - &quot;**/*.ts&quot;
      - &quot;**/*.js&quot;
    exclude:
      - &quot;**/node_modules/**&quot;
      - &quot;**/.venv/**&quot;
      - &quot;**/dist/**&quot;

  # Dependency scanning
  dependencies:
    # Vulnerability databases
    vuln_sources:
      - safety           # Python
      - npm-audit        # npm
      - snyk             # Multi-language

    # Freshness thresholds
    outdated_thresholds:
      minor_days: 90     # Consider outdated after 90 days
      major_days: 180

  # Complexity thresholds
  complexity:
    cyclomatic_warn: 10
    cyclomatic_error: 20
    cognitive_warn: 15
    cognitive_error: 25
    function_length_warn: 50
    function_length_error: 100

  # Dead code detection
  dead_code:
    # Entry points to consider as roots
    entry_points:
      - &quot;main&quot;
      - &quot;cli&quot;
      - &quot;**/test_*.py&quot;
      - &quot;**/*_test.py&quot;

    # Patterns that might indicate dynamic usage
    dynamic_patterns:
      - &quot;@app.route&quot;
      - &quot;@pytest.fixture&quot;
      - &quot;__getattr__&quot;

  # Duplication detection
  duplication:
    min_lines: 6           # Minimum lines to consider duplicate
    min_tokens: 50         # Minimum tokens
    similarity_threshold: 0.9

  # TODO scanning
  todos:
    patterns:
      - &quot;TODO&quot;
      - &quot;FIXME&quot;
      - &quot;HACK&quot;
      - &quot;XXX&quot;
      - &quot;TECHNICAL_DEBT&quot;
    # Extract ticket references
    ticket_patterns:
      - &quot;[A-Z]+-\\d+&quot;      # JIRA-style</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Full Scan</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;scope&quot;: &quot;src/&quot;,
    &quot;categories&quot;: [&quot;all&quot;],
    &quot;severity_threshold&quot;: &quot;medium&quot;
}

# Output
{
    &quot;dependencies&quot;: {
        &quot;outdated&quot;: [
            {
                &quot;name&quot;: &quot;requests&quot;,
                &quot;current_version&quot;: &quot;2.25.0&quot;,
                &quot;latest_version&quot;: &quot;2.31.0&quot;,
                &quot;age_days&quot;: 450,
                &quot;breaking_changes&quot;: false,
                &quot;update_effort&quot;: &quot;low&quot;
            }
        ],
        &quot;vulnerable&quot;: [
            {
                &quot;name&quot;: &quot;pyyaml&quot;,
                &quot;version&quot;: &quot;5.3&quot;,
                &quot;cve_ids&quot;: [&quot;CVE-2020-14343&quot;],
                &quot;severity&quot;: &quot;critical&quot;,
                &quot;fixed_in&quot;: &quot;5.4&quot;,
                &quot;description&quot;: &quot;Arbitrary code execution via yaml.load()&quot;
            }
        ]
    },
    &quot;dead_code&quot;: {
        &quot;unused_functions&quot;: [
            {
                &quot;name&quot;: &quot;legacy_auth_handler&quot;,
                &quot;file_path&quot;: &quot;src/auth/legacy.py&quot;,
                &quot;line_number&quot;: 45,
                &quot;lines_of_code&quot;: 78,
                &quot;confidence&quot;: 0.95
            }
        ],
        &quot;total_dead_lines&quot;: 234
    },
    &quot;complexity&quot;: {
        &quot;hotspots&quot;: [
            {
                &quot;file_path&quot;: &quot;src/payments/processor.py&quot;,
                &quot;function_name&quot;: &quot;process_payment&quot;,
                &quot;cyclomatic_complexity&quot;: 32,
                &quot;cognitive_complexity&quot;: 45,
                &quot;lines&quot;: 156,
                &quot;recommendation&quot;: &quot;Split into smaller functions by payment type&quot;
            }
        ]
    },
    &quot;todos&quot;: {
        &quot;todos&quot;: [
            {
                &quot;type&quot;: &quot;FIXME&quot;,
                &quot;text&quot;: &quot;This is a race condition waiting to happen&quot;,
                &quot;file_path&quot;: &quot;src/cache/manager.py&quot;,
                &quot;line_number&quot;: 89,
                &quot;author&quot;: &quot;alice&quot;,
                &quot;age_days&quot;: 342
            }
        ],
        &quot;by_age&quot;: {&quot;&lt; 1 month&quot;: 3, &quot;1-6 months&quot;: 12, &quot;&gt; 6 months&quot;: 8}
    },
    &quot;summary&quot;: {
        &quot;total_items&quot;: 47,
        &quot;by_severity&quot;: {&quot;critical&quot;: 1, &quot;high&quot;: 5, &quot;medium&quot;: 18, &quot;low&quot;: 23},
        &quot;by_category&quot;: {&quot;dependencies&quot;: 8, &quot;dead_code&quot;: 12, &quot;complexity&quot;: 5, &quot;todos&quot;: 22},
        &quot;estimated_effort_hours&quot;: 40,
        &quot;debt_score&quot;: 67,
        &quot;trend&quot;: &quot;stable&quot;
    },
    &quot;recommendations&quot;: [
        {
            &quot;priority&quot;: 1,
            &quot;category&quot;: &quot;dependencies&quot;,
            &quot;title&quot;: &quot;Critical vulnerability in pyyaml&quot;,
            &quot;description&quot;: &quot;CVE-2020-14343: Arbitrary code execution&quot;,
            &quot;effort&quot;: &quot;low&quot;,
            &quot;impact&quot;: &quot;critical&quot;
        },
        {
            &quot;priority&quot;: 2,
            &quot;category&quot;: &quot;complexity&quot;,
            &quot;title&quot;: &quot;Refactor process_payment&quot;,
            &quot;description&quot;: &quot;Cyclomatic complexity: 32 (threshold: 20)&quot;,
            &quot;effort&quot;: &quot;medium&quot;,
            &quot;impact&quot;: &quot;high&quot;
        }
    ]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Reads source code and dependencies</li>
        <li>Vulnerability data fetched from external sources</li>
        <li>Scan results may reveal security weaknesses</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>tree-sitter</code> - Code analysis</li>
        <li><code>radon</code> - Python complexity (or language-specific tools)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>safety</code> - Python vulnerability scanning</li>
        <li><code>npm-audit</code> - npm vulnerability scanning</li>
        <li><code>jscpd</code> - Cross-language duplication detection</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Historical tracking</strong>: Should we store scan history for trend analysis?</li>
        <li><strong>CI integration</strong>: Block PRs that increase debt beyond threshold?</li>
        <li><strong>Custom rules</strong>: Allow project-specific anti-pattern definitions?</li>
        <li><strong>Effort estimation</strong>: How to improve effort estimates?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tool-test-runner" data-category="tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tool Test Runner</span>
            <span class="spec-category">tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-tool-test-runner</code></p>
        </div>
        <h3>Overview</h3>
        <p>Intelligent test execution with failure analysis, coverage tracking, and test selection optimization. Runs specific tests, analyzes failures, and suggests fixes based on error context.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Run all tests hoping to catch the right one</td><td>Smart test selection based on changed files</td></tr>
            <tr><td>Parse test output manually</td><td>Structured failure analysis with context</td></tr>
            <tr><td>Hunt for relevant test files</td><td>"Run tests for PaymentGateway" finds them</td></tr>
            <tr><td>Rerun flaky tests manually</td><td>Automatic flaky test detection and retry</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Targeted testing</strong>: Run tests for specific functions/classes</li>
        <li><strong>Failure analysis</strong>: Understand why tests failed with context</li>
        <li><strong>Change-based testing</strong>: Run tests affected by recent changes</li>
        <li><strong>Coverage analysis</strong>: Track what's tested and what's not</li>
        <li><strong>Flaky test management</strong>: Detect and handle flaky tests</li>
        <li><strong>Performance tracking</strong>: Monitor test execution times</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Tool Definition</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">TOOL_DEFINITION = {
    &quot;name&quot;: &quot;test_runner&quot;,
    &quot;description&quot;: &quot;&quot;&quot;
    Intelligent test execution and analysis.

    Operations:
    - run: Execute tests (all, specific, or affected by changes)
    - analyze: Analyze test failures with context
    - coverage: Get coverage information
    - list: List available tests
    - history: Test execution history and trends

    Supports pytest, jest, go test, and other common frameworks.
    &quot;&quot;&quot;,
    &quot;parameters&quot;: {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
            &quot;operation&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;run&quot;, &quot;analyze&quot;, &quot;coverage&quot;, &quot;list&quot;, &quot;history&quot;],
                &quot;description&quot;: &quot;Operation to perform&quot;
            },
            &quot;target&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;description&quot;: &quot;Test target: file path, test name, or symbol name&quot;
            },
            &quot;selection&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;all&quot;, &quot;failed&quot;, &quot;affected&quot;, &quot;target&quot;],
                &quot;default&quot;: &quot;target&quot;,
                &quot;description&quot;: &quot;Test selection strategy&quot;
            },
            &quot;framework&quot;: {
                &quot;type&quot;: &quot;string&quot;,
                &quot;enum&quot;: [&quot;auto&quot;, &quot;pytest&quot;, &quot;jest&quot;, &quot;go&quot;, &quot;cargo&quot;],
                &quot;default&quot;: &quot;auto&quot;,
                &quot;description&quot;: &quot;Test framework (auto-detected if not specified)&quot;
            },
            &quot;options&quot;: {
                &quot;type&quot;: &quot;object&quot;,
                &quot;description&quot;: &quot;Framework-specific options (verbose, parallel, etc.)&quot;
            },
            &quot;analyze_failures&quot;: {
                &quot;type&quot;: &quot;boolean&quot;,
                &quot;default&quot;: true,
                &quot;description&quot;: &quot;Include failure analysis in results&quot;
            }
        },
        &quot;required&quot;: [&quot;operation&quot;]
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Output Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class TestRunnerOutput:
    operation: str

    # For run operation
    run_result: TestRunResult | None = None

    # For analyze operation
    failure_analysis: list[FailureAnalysis] | None = None

    # For coverage operation
    coverage: CoverageReport | None = None

    # For list operation
    tests: list[TestInfo] | None = None

    # For history operation
    history: TestHistory | None = None

@dataclass
class TestRunResult:
    success: bool
    total: int
    passed: int
    failed: int
    skipped: int
    duration_seconds: float

    # Detailed results
    test_results: list[TestResult]

    # Failure analysis (if analyze_failures=True)
    failure_analyses: list[FailureAnalysis] | None

    # Framework info
    framework: str
    command: str

@dataclass
class TestResult:
    name: str
    file_path: str
    status: str                         # passed | failed | skipped | error
    duration_seconds: float
    output: str | None                  # Captured output
    error: TestError | None             # If failed

@dataclass
class TestError:
    type: str                           # AssertionError, TypeError, etc.
    message: str
    traceback: str
    location: Location                  # File and line where error occurred

@dataclass
class FailureAnalysis:
    test_name: str
    error: TestError

    # Analysis
    failure_type: str                   # assertion | exception | timeout | fixture
    root_cause: str                     # AI-analyzed root cause
    relevant_code: list[CodeSnippet]    # Related code snippets
    suggested_fix: str | None           # If determinable
    similar_failures: list[str]         # Other tests with similar failures

@dataclass
class CoverageReport:
    total_lines: int
    covered_lines: int
    coverage_percent: float
    files: list[FileCoverage]
    uncovered_functions: list[str]      # Functions with 0% coverage

@dataclass
class FileCoverage:
    path: str
    lines: int
    covered: int
    percent: float
    uncovered_lines: list[int]          # Line numbers not covered

@dataclass
class TestInfo:
    name: str
    file_path: str
    line_number: int
    markers: list[str]                  # pytest markers, jest tags, etc.
    parameters: list[str] | None        # Parameterized test variants</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       tool-test-runner                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚    Test     â”‚â”€â”€â”€â–¶â”‚  Framework  â”‚â”€â”€â”€â–¶â”‚  Result     â”‚         â”‚
â”‚  â”‚  Selector   â”‚    â”‚   Runner    â”‚    â”‚  Analyzer   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                            â”‚                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â–¼                  â–¼                  â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   pytest    â”‚    â”‚    jest     â”‚    â”‚   go test   â”‚         â”‚
â”‚  â”‚   adapter   â”‚    â”‚   adapter   â”‚    â”‚   adapter   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Test Selector</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class TestSelector:
    &quot;&quot;&quot;Select tests to run based on strategy.&quot;&quot;&quot;

    async def select(
        self,
        strategy: str,
        target: str | None,
        framework: str
    ) -&gt; list[str]:
        if strategy == &quot;all&quot;:
            return []  # Empty = run all

        if strategy == &quot;target&quot;:
            return await self._select_for_target(target, framework)

        if strategy == &quot;affected&quot;:
            return await self._select_affected()

        if strategy == &quot;failed&quot;:
            return await self._select_previously_failed()

    async def _select_for_target(self, target: str, framework: str) -&gt; list[str]:
        &quot;&quot;&quot;Find tests for a target symbol or file.&quot;&quot;&quot;

        # If target is a test file, return it
        if self._is_test_file(target):
            return [target]

        # If target is a symbol (class/function), find related tests
        symbol_tests = await self._find_tests_for_symbol(target)
        if symbol_tests:
            return symbol_tests

        # If target is a source file, find tests that import it
        if Path(target).exists():
            return await self._find_tests_importing(target)

        # Search by name pattern
        return await self._find_tests_by_pattern(target)

    async def _select_affected(self) -&gt; list[str]:
        &quot;&quot;&quot;Select tests affected by recent changes.&quot;&quot;&quot;
        # Get changed files
        changed = await self.git.get_changed_files()

        affected_tests = set()
        for file_path in changed:
            # Direct test file changes
            if self._is_test_file(file_path):
                affected_tests.add(file_path)
            else:
                # Find tests that depend on this file
                tests = await self._find_tests_importing(file_path)
                affected_tests.update(tests)

        return list(affected_tests)</code></pre>
        </div>
        <p>#### 2. Framework Adapters</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class PytestAdapter:
    &quot;&quot;&quot;Adapter for pytest.&quot;&quot;&quot;

    async def run(
        self,
        tests: list[str],
        options: dict
    ) -&gt; TestRunResult:
        # Build command
        cmd = [&quot;pytest&quot;, &quot;--tb=short&quot;, &quot;-v&quot;]

        if options.get(&quot;parallel&quot;):
            cmd.extend([&quot;-n&quot;, &quot;auto&quot;])
        if options.get(&quot;coverage&quot;):
            cmd.extend([&quot;--cov&quot;, &quot;--cov-report=json&quot;])
        if options.get(&quot;markers&quot;):
            cmd.extend([&quot;-m&quot;, options[&quot;markers&quot;]])

        cmd.extend(tests)

        # Run pytest
        result = await self._run_command(cmd)

        # Parse output
        return self._parse_result(result)

    def _parse_result(self, result: ProcessResult) -&gt; TestRunResult:
        &quot;&quot;&quot;Parse pytest output into structured result.&quot;&quot;&quot;
        # Parse pytest&#039;s output format
        # Also look for pytest-json-report output if available
        ...

class JestAdapter:
    &quot;&quot;&quot;Adapter for Jest.&quot;&quot;&quot;

    async def run(self, tests: list[str], options: dict) -&gt; TestRunResult:
        cmd = [&quot;npx&quot;, &quot;jest&quot;, &quot;--json&quot;]

        if tests:
            cmd.extend([&quot;--testPathPattern&quot;, &quot;|&quot;.join(tests)])
        if options.get(&quot;coverage&quot;):
            cmd.append(&quot;--coverage&quot;)
        if options.get(&quot;watch&quot;) is False:
            cmd.append(&quot;--watchAll=false&quot;)

        result = await self._run_command(cmd)
        return self._parse_json_result(result)</code></pre>
        </div>
        <p>#### 3. Result Analyzer</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ResultAnalyzer:
    &quot;&quot;&quot;Analyze test failures.&quot;&quot;&quot;

    async def analyze_failures(
        self,
        results: list[TestResult]
    ) -&gt; list[FailureAnalysis]:
        failures = [r for r in results if r.status == &quot;failed&quot;]
        analyses = []

        for failure in failures:
            analysis = await self._analyze_failure(failure)
            analyses.append(analysis)

        return analyses

    async def _analyze_failure(self, failure: TestResult) -&gt; FailureAnalysis:
        error = failure.error

        # Classify failure type
        failure_type = self._classify_failure(error)

        # Get relevant code context
        relevant_code = await self._get_relevant_code(error)

        # Analyze root cause
        root_cause = await self._analyze_root_cause(
            failure, error, relevant_code
        )

        # Generate fix suggestion if possible
        suggested_fix = await self._suggest_fix(
            failure_type, error, relevant_code
        )

        # Find similar failures
        similar = await self._find_similar_failures(error)

        return FailureAnalysis(
            test_name=failure.name,
            error=error,
            failure_type=failure_type,
            root_cause=root_cause,
            relevant_code=relevant_code,
            suggested_fix=suggested_fix,
            similar_failures=similar
        )

    def _classify_failure(self, error: TestError) -&gt; str:
        &quot;&quot;&quot;Classify the type of test failure.&quot;&quot;&quot;
        if &quot;AssertionError&quot; in error.type:
            return &quot;assertion&quot;
        if &quot;Timeout&quot; in error.type or &quot;timeout&quot; in error.message.lower():
            return &quot;timeout&quot;
        if &quot;fixture&quot; in error.message.lower():
            return &quot;fixture&quot;
        return &quot;exception&quot;

    async def _suggest_fix(
        self,
        failure_type: str,
        error: TestError,
        relevant_code: list[CodeSnippet]
    ) -&gt; str | None:
        &quot;&quot;&quot;Suggest a fix based on failure analysis.&quot;&quot;&quot;

        # Common assertion fixes
        if failure_type == &quot;assertion&quot;:
            if &quot;assertEqual&quot; in error.message or &quot;==&quot; in error.message:
                # Extract expected vs actual
                return self._suggest_assertion_fix(error)

        # Fixture issues
        if failure_type == &quot;fixture&quot;:
            if &quot;not found&quot; in error.message.lower():
                return f&quot;Fixture not defined. Add @pytest.fixture or import from conftest.py&quot;

        # Type errors often have clear fixes
        if &quot;TypeError&quot; in error.type:
            return self._suggest_type_error_fix(error)

        return None</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-test-runner:
  # Framework detection
  frameworks:
    # Auto-detection patterns
    detect:
      pytest:
        - &quot;pytest.ini&quot;
        - &quot;pyproject.toml:pytest&quot;
        - &quot;conftest.py&quot;
      jest:
        - &quot;jest.config.js&quot;
        - &quot;package.json:jest&quot;
      go:
        - &quot;go.mod&quot;
        - &quot;*_test.go&quot;

  # Default options per framework
  defaults:
    pytest:
      verbose: true
      tb: &quot;short&quot;
      parallel: false
    jest:
      verbose: true
      coverage: false

  # Test selection
  selection:
    # Patterns for test files
    test_file_patterns:
      - &quot;**/test_*.py&quot;
      - &quot;**/*_test.py&quot;
      - &quot;**/*.test.ts&quot;
      - &quot;**/*.spec.ts&quot;
      - &quot;**/*_test.go&quot;

    # Exclude patterns
    exclude_patterns:
      - &quot;**/node_modules/**&quot;
      - &quot;**/.venv/**&quot;

  # Failure analysis
  analysis:
    enabled: true
    max_relevant_files: 5
    include_similar_failures: true

  # History tracking
  history:
    enabled: true
    retention_days: 30
    track_flaky: true</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Run Tests for Symbol</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;run&quot;,
    &quot;target&quot;: &quot;PaymentGateway&quot;,
    &quot;selection&quot;: &quot;target&quot;,
    &quot;analyze_failures&quot;: true
}

# Output
{
    &quot;operation&quot;: &quot;run&quot;,
    &quot;run_result&quot;: {
        &quot;success&quot;: false,
        &quot;total&quot;: 8,
        &quot;passed&quot;: 7,
        &quot;failed&quot;: 1,
        &quot;skipped&quot;: 0,
        &quot;duration_seconds&quot;: 2.34,
        &quot;test_results&quot;: [...],
        &quot;failure_analyses&quot;: [
            {
                &quot;test_name&quot;: &quot;test_payment_gateway_timeout&quot;,
                &quot;error&quot;: {
                    &quot;type&quot;: &quot;AssertionError&quot;,
                    &quot;message&quot;: &quot;Expected retry count 3, got 2&quot;,
                    &quot;location&quot;: {&quot;file_path&quot;: &quot;tests/test_payments.py&quot;, &quot;line_number&quot;: 45}
                },
                &quot;failure_type&quot;: &quot;assertion&quot;,
                &quot;root_cause&quot;: &quot;PaymentGateway.process() only retries twice. The retry decorator has max_attempts=2 but test expects 3.&quot;,
                &quot;relevant_code&quot;: [
                    {
                        &quot;file&quot;: &quot;src/payments/gateway.py&quot;,
                        &quot;line&quot;: 42,
                        &quot;code&quot;: &quot;@retry(max_attempts=2)  # Should be 3?&quot;
                    }
                ],
                &quot;suggested_fix&quot;: &quot;Update max_attempts to 3 in gateway.py:42 or update test expectation to 2&quot;
            }
        ],
        &quot;framework&quot;: &quot;pytest&quot;,
        &quot;command&quot;: &quot;pytest tests/test_payments.py -k PaymentGateway -v&quot;
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Run Affected Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;run&quot;,
    &quot;selection&quot;: &quot;affected&quot;
}

# Output
{
    &quot;operation&quot;: &quot;run&quot;,
    &quot;run_result&quot;: {
        &quot;success&quot;: true,
        &quot;total&quot;: 12,
        &quot;passed&quot;: 12,
        &quot;failed&quot;: 0,
        &quot;duration_seconds&quot;: 4.56,
        &quot;framework&quot;: &quot;pytest&quot;,
        &quot;command&quot;: &quot;pytest tests/test_auth.py tests/test_users.py -v&quot;
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Coverage Report</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input
{
    &quot;operation&quot;: &quot;coverage&quot;,
    &quot;target&quot;: &quot;src/payments/&quot;
}

# Output
{
    &quot;operation&quot;: &quot;coverage&quot;,
    &quot;coverage&quot;: {
        &quot;total_lines&quot;: 450,
        &quot;covered_lines&quot;: 387,
        &quot;coverage_percent&quot;: 86.0,
        &quot;files&quot;: [
            {
                &quot;path&quot;: &quot;src/payments/gateway.py&quot;,
                &quot;lines&quot;: 120,
                &quot;covered&quot;: 115,
                &quot;percent&quot;: 95.8,
                &quot;uncovered_lines&quot;: [45, 67, 89, 90, 91]
            }
        ],
        &quot;uncovered_functions&quot;: [
            &quot;PaymentGateway._handle_timeout&quot;,
            &quot;PaymentGateway._legacy_fallback&quot;
        ]
    }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Executes test commands (potential code execution)</li>
        <li>Reads test files and source code</li>
        <li>May expose test data in output</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;filesystem:read&quot;,      # Read test files
    &quot;process:execute&quot;,      # Run test commands
]</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>pytest</code> (for Python projects)</li>
        <li><code>jest</code> (for JavaScript/TypeScript projects)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>pytest-cov</code> - Coverage reporting</li>
        <li><code>pytest-xdist</code> - Parallel execution</li>
        <li><code>pytest-json-report</code> - Structured output</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Framework support</strong>: Which frameworks beyond pytest/jest/go?</li>
        <li><strong>Parallel execution</strong>: Default parallel or sequential?</li>
        <li><strong>Coverage thresholds</strong>: Should we enforce minimum coverage?</li>
        <li><strong>Test generation</strong>: Should this tool suggest missing tests?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-approval-workflow" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Approval Workflow</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-approval-workflow</code></p>
        </div>
        <h3>Overview</h3>
        <p>Dynamic approval gates for sensitive operations beyond the kernel's built-in approval system. Enables sophisticated approval logic based on operation context, time of day, affected resources, and organizational policies.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Binary allow/deny decisions</td><td>Context-aware approval logic</td></tr>
            <tr><td>Same rules for all operations</td><td>Different rules for dev/staging/prod</td></tr>
            <tr><td>Manual approval tracking</td><td>Automated approval workflows</td></tr>
            <tr><td>No escalation paths</td><td>Multi-level approval for high-risk operations</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-approval-workflow
    config:
      # Approval rules (evaluated in order)
      rules:
        # Production file protection
        - name: production_files
          match:
            tool: filesystem
            operation: write
            path_patterns:
              - &quot;production/**&quot;
              - &quot;prod/**&quot;
              - &quot;**/config/production.*&quot;
          action: require_approval
          approval:
            prompt: &quot;Write to production file: {file_path}?&quot;
            timeout: 300
            default: deny

        # Database migrations
        - name: database_migrations
          match:
            tool: migration_helper
            operation: execute
          action: require_approval
          approval:
            prompt: &quot;Execute database migration: {migration_name}?&quot;
            options: [&quot;Run&quot;, &quot;Dry-run first&quot;, &quot;Cancel&quot;]
            require_reason: true

        # Destructive operations
        - name: destructive_ops
          match:
            tool: &quot;*&quot;
            operation: delete
          action: require_approval
          approval:
            prompt: &quot;Delete {resource_type}: {resource_id}?&quot;
            default: deny

        # After-hours changes
        - name: after_hours
          match:
            time:
              outside: &quot;09:00-18:00&quot;
              timezone: &quot;America/New_York&quot;
          action: require_approval
          approval:
            prompt: &quot;After-hours change. Proceed?&quot;

        # High-cost operations
        - name: expensive_llm_calls
          match:
            event: provider:request
            conditions:
              estimated_tokens: &quot;&gt; 50000&quot;
          action: require_approval
          approval:
            prompt: &quot;Large LLM request (~{estimated_tokens} tokens, ~${estimated_cost}). Continue?&quot;

      # Default behavior for non-matched operations
      default_action: continue

      # Approval caching
      caching:
        enabled: true
        ttl_seconds: 300                # Cache approvals for 5 minutes
        scope: session                  # session | operation</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult Actions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Request approval from user
HookResult(
    action=&quot;ask_user&quot;,
    approval_prompt=&quot;Write to production/config.yaml?\n\nChanges:\n- Updated API endpoint\n- Changed timeout from 30s to 60s&quot;,
    approval_options=[&quot;Allow&quot;, &quot;Deny&quot;, &quot;Show diff&quot;],
    approval_timeout=300.0,
    approval_default=&quot;deny&quot;
)

# After approval received, continue or deny
HookResult(action=&quot;continue&quot;)  # If approved
HookResult(action=&quot;deny&quot;, reason=&quot;User denied production file write&quot;)  # If denied</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ApprovalWorkflowHook:
    &quot;&quot;&quot;Dynamic approval gates based on configurable rules.&quot;&quot;&quot;

    def __init__(self, config: ApprovalWorkflowConfig):
        self.config = config
        self.rules = [ApprovalRule(r) for r in config.rules]
        self.cache = ApprovalCache(config.caching) if config.caching.enabled else None
        self.pending_approvals: dict[str, PendingApproval] = {}

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        # Check if any rule matches
        for rule in self.rules:
            if rule.matches(event, data):
                return await self._handle_rule(rule, event, data)

        return HookResult(action=&quot;continue&quot;)

    async def _handle_rule(
        self,
        rule: ApprovalRule,
        event: str,
        data: dict
    ) -&gt; HookResult:
        # Check cache first
        cache_key = self._compute_cache_key(rule, data)
        if self.cache:
            cached = self.cache.get(cache_key)
            if cached:
                if cached.approved:
                    return HookResult(action=&quot;continue&quot;)
                else:
                    return HookResult(action=&quot;deny&quot;, reason=cached.reason)

        # Build approval prompt
        prompt = rule.format_prompt(data)
        options = rule.options or [&quot;Allow&quot;, &quot;Deny&quot;]

        # Request approval
        return HookResult(
            action=&quot;ask_user&quot;,
            approval_prompt=prompt,
            approval_options=options,
            approval_timeout=rule.timeout,
            approval_default=rule.default
        )

    def _compute_cache_key(self, rule: ApprovalRule, data: dict) -&gt; str:
        &quot;&quot;&quot;Compute cache key based on rule scope.&quot;&quot;&quot;
        if self.config.caching.scope == &quot;session&quot;:
            return f&quot;{rule.name}&quot;
        else:  # operation scope
            return f&quot;{rule.name}:{hash(frozenset(data.items()))}&quot;


class ApprovalRule:
    &quot;&quot;&quot;Single approval rule with matching and formatting.&quot;&quot;&quot;

    def __init__(self, config: dict):
        self.name = config[&quot;name&quot;]
        self.match_config = config[&quot;match&quot;]
        self.action = config[&quot;action&quot;]
        self.approval_config = config.get(&quot;approval&quot;, {})

        # Compile matchers
        self.matchers = self._compile_matchers()

    def matches(self, event: str, data: dict) -&gt; bool:
        &quot;&quot;&quot;Check if rule matches current event/data.&quot;&quot;&quot;
        for matcher in self.matchers:
            if not matcher.matches(event, data):
                return False
        return True

    def _compile_matchers(self) -&gt; list[Matcher]:
        matchers = []

        if &quot;tool&quot; in self.match_config:
            matchers.append(ToolMatcher(self.match_config[&quot;tool&quot;]))

        if &quot;operation&quot; in self.match_config:
            matchers.append(OperationMatcher(self.match_config[&quot;operation&quot;]))

        if &quot;path_patterns&quot; in self.match_config:
            matchers.append(PathMatcher(self.match_config[&quot;path_patterns&quot;]))

        if &quot;event&quot; in self.match_config:
            matchers.append(EventMatcher(self.match_config[&quot;event&quot;]))

        if &quot;time&quot; in self.match_config:
            matchers.append(TimeMatcher(self.match_config[&quot;time&quot;]))

        if &quot;conditions&quot; in self.match_config:
            matchers.append(ConditionMatcher(self.match_config[&quot;conditions&quot;]))

        return matchers

    def format_prompt(self, data: dict) -&gt; str:
        &quot;&quot;&quot;Format approval prompt with data.&quot;&quot;&quot;
        template = self.approval_config.get(&quot;prompt&quot;, &quot;Approve this operation?&quot;)
        return template.format(**data)


class PathMatcher:
    &quot;&quot;&quot;Match file paths against patterns.&quot;&quot;&quot;

    def __init__(self, patterns: list[str]):
        self.patterns = [re.compile(fnmatch.translate(p)) for p in patterns]

    def matches(self, event: str, data: dict) -&gt; bool:
        file_path = data.get(&quot;file_path&quot;, &quot;&quot;)
        return any(p.match(file_path) for p in self.patterns)


class TimeMatcher:
    &quot;&quot;&quot;Match based on time of day.&quot;&quot;&quot;

    def __init__(self, config: dict):
        self.outside = config.get(&quot;outside&quot;)  # &quot;09:00-18:00&quot;
        self.timezone = pytz.timezone(config.get(&quot;timezone&quot;, &quot;UTC&quot;))

    def matches(self, event: str, data: dict) -&gt; bool:
        now = datetime.now(self.timezone)
        current_time = now.time()

        if self.outside:
            start, end = self._parse_time_range(self.outside)
            # Match if OUTSIDE the range
            return not (start &lt;= current_time &lt;= end)

        return True</code></pre>
        </div>
        <p>---</p>
        <h3>Rule Matching</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Match Criteria</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Criterion</th><th>Description</th><th>Example</th></tr>
          </thead>
          <tbody>
            <tr><td><code>tool</code></td><td>Tool name (glob)</td><td><code>"filesystem"</code>, <code>"*"</code></td></tr>
            <tr><td><code>operation</code></td><td>Operation type</td><td><code>"write"</code>, <code>"delete"</code>, <code>"execute"</code></td></tr>
            <tr><td><code>path_patterns</code></td><td>File path patterns</td><td><code>["production/**", "*.prod.*"]</code></td></tr>
            <tr><td><code>event</code></td><td>Event type</td><td><code>"provider:request"</code>, <code>"tool:pre"</code></td></tr>
            <tr><td><code>time.outside</code></td><td>Time range</td><td><code>"09:00-18:00"</code></td></tr>
            <tr><td><code>time.timezone</code></td><td>Timezone</td><td><code>"America/New_York"</code></td></tr>
            <tr><td><code>conditions</code></td><td>Custom conditions</td><td><code>{"estimated_tokens": "> 50000"}</code></td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Condition Operators</h4>
        <li><code>"="</code> - Equals</li>
        <li><code>"!="</code> - Not equals</li>
        <li><code>">"</code> - Greater than</li>
        <li><code>"<"</code> - Less than</li>
        <li><code>">="</code> - Greater or equal</li>
        <li><code>"<="</code> - Less or equal</li>
        <li><code>"contains"</code> - String contains</li>
        <li><code>"matches"</code> - Regex match</li>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Production File Protection</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">rules:
  - name: production_files
    match:
      tool: filesystem
      operation: write
      path_patterns:
        - &quot;production/**&quot;
        - &quot;**/config/prod.*&quot;
    action: require_approval
    approval:
      prompt: |
        âš ï¸ Production file change detected

        File: {file_path}

        Are you sure you want to modify this production file?
      options: [&quot;Allow&quot;, &quot;Deny&quot;]
      default: deny</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Multi-Option Approval</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">rules:
  - name: database_migration
    match:
      tool: migration_helper
    action: require_approval
    approval:
      prompt: |
        Database migration: {migration_name}

        Changes:
        {changes_summary}

        What would you like to do?
      options:
        - &quot;Run migration&quot;
        - &quot;Dry-run first&quot;
        - &quot;Show full SQL&quot;
        - &quot;Cancel&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Cost-Based Approval</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">rules:
  - name: expensive_operations
    match:
      event: provider:request
      conditions:
        estimated_cost: &quot;&gt; 1.00&quot;
    action: require_approval
    approval:
      prompt: |
        ðŸ’° Expensive LLM operation

        Estimated cost: ${estimated_cost}
        Estimated tokens: {estimated_tokens}

        Continue?
      default: deny</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 4: After-Hours Warning</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">rules:
  - name: after_hours
    match:
      tool: &quot;*&quot;
      operation: write
      time:
        outside: &quot;09:00-18:00&quot;
        timezone: &quot;America/Los_Angeles&quot;
    action: require_approval
    approval:
      prompt: |
        ðŸŒ™ After-hours change

        It&#039;s currently outside business hours.
        This change may not receive timely review.

        Proceed anyway?</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>rules</code></td><td>list</td><td>[]</td><td>Approval rules</td></tr>
            <tr><td><code>default_action</code></td><td>string</td><td>"continue"</td><td>Action when no rule matches</td></tr>
            <tr><td><code>caching.enabled</code></td><td>bool</td><td>false</td><td>Cache approvals</td></tr>
            <tr><td><code>caching.ttl_seconds</code></td><td>int</td><td>300</td><td>Cache TTL</td></tr>
            <tr><td><code>caching.scope</code></td><td>string</td><td>"session"</td><td>Cache scope</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Rules evaluated server-side, can't be bypassed</li>
        <li>Approval cache prevents prompt fatigue attacks</li>
        <li>Default-deny recommended for sensitive operations</li>
        <li>Audit log should capture all approval decisions</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>fnmatch</code> - Pattern matching (stdlib)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>pytz</code> - Timezone handling</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Escalation</strong>: Support multi-level approval (manager approval)?</li>
        <li><strong>Delegation</strong>: Allow pre-approved operations for specific users?</li>
        <li><strong>Time limits</strong>: Approval valid for specific time window?</li>
        <li><strong>Notifications</strong>: Notify team on certain approvals?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-audit-trail" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Audit Trail</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-audit-trail</code></p>
        </div>
        <h3>Overview</h3>
        <p>Comprehensive audit logging for compliance and security. Creates immutable records of all agent operations, decisions, and changes. Designed for enterprise environments with regulatory requirements.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>No record of AI actions</td><td>Complete audit trail</td></tr>
            <tr><td>Compliance gaps</td><td>SOC2/HIPAA/GDPR ready</td></tr>
            <tr><td>Incident investigation difficult</td><td>Full replay capability</td></tr>
            <tr><td>"What did the AI do?"</td><td>Detailed operation log</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-audit-trail
    config:
      # Storage configuration
      storage:
        type: file                      # file | s3 | elasticsearch | splunk
        path: &quot;${AUDIT_LOG_PATH}&quot;       # For file storage
        # s3:
        #   bucket: &quot;audit-logs&quot;
        #   prefix: &quot;amplifier/&quot;

      # What to log
      capture:
        session_lifecycle: true         # start, end
        prompts: true                   # User inputs
        responses: true                 # Agent outputs
        tool_operations: true           # All tool calls
        file_changes: true              # File content changes
        approvals: true                 # User approvals
        errors: true                    # Errors and failures

      # Data handling
      retention:
        days: 365                       # Keep logs for 1 year
        archive_after_days: 90          # Move to cold storage

      # Privacy
      privacy:
        redact_secrets: true            # Redact detected secrets
        hash_user_ids: false            # Hash user identifiers
        exclude_patterns:               # Don&#039;t log matching content
          - &quot;password&quot;
          - &quot;credit_card&quot;

      # Integrity
      integrity:
        sign_entries: true              # Cryptographically sign entries
        chain_hashes: true              # Hash chain for tamper detection

      # Format
      format:
        type: jsonl                     # jsonl | json | parquet
        include_timestamp: true
        include_session_id: true
        include_user_id: true</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Audit Entry Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class AuditEntry:
    # Identity
    entry_id: str                       # Unique entry ID
    timestamp: datetime                 # ISO 8601
    session_id: str
    user_id: str | None

    # Event classification
    event_type: str                     # session:start, tool:execute, etc.
    event_category: str                 # lifecycle | operation | data | error

    # Event details
    action: str                         # create, read, update, delete, execute
    resource_type: str                  # file, tool, prompt, response
    resource_id: str | None             # File path, tool name, etc.

    # Operation details
    input: dict | None                  # Sanitized input
    output: dict | None                 # Sanitized output
    outcome: str                        # success | failure | denied

    # Context
    metadata: dict                      # Additional context
    previous_hash: str | None           # For hash chain
    signature: str | None               # For signed entries

@dataclass
class AuditQuery:
    &quot;&quot;&quot;Query parameters for audit search.&quot;&quot;&quot;
    session_id: str | None
    user_id: str | None
    event_type: str | None
    resource_type: str | None
    start_time: datetime | None
    end_time: datetime | None
    outcome: str | None</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class AuditTrailHook:
    &quot;&quot;&quot;Comprehensive audit logging hook.&quot;&quot;&quot;

    # Events to capture
    CAPTURED_EVENTS = [
        &quot;session:start&quot;,
        &quot;session:end&quot;,
        &quot;prompt:submit&quot;,
        &quot;prompt:complete&quot;,
        &quot;tool:pre&quot;,
        &quot;tool:post&quot;,
        &quot;tool:error&quot;,
        &quot;approval:required&quot;,
        &quot;approval:granted&quot;,
        &quot;approval:denied&quot;,
        &quot;policy:violation&quot;,
        &quot;error:*&quot;,
    ]

    def __init__(self, config: AuditTrailConfig):
        self.config = config
        self.storage = self._create_storage(config.storage)
        self.sanitizer = AuditSanitizer(config.privacy)
        self.signer = AuditSigner(config.integrity) if config.integrity.sign_entries else None
        self.previous_hash: str | None = None

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        # Check if we should capture this event
        if not self._should_capture(event):
            return HookResult(action=&quot;continue&quot;)

        # Create audit entry
        entry = self._create_entry(event, data)

        # Sanitize sensitive data
        entry = self.sanitizer.sanitize(entry)

        # Add integrity features
        if self.config.integrity.chain_hashes:
            entry.previous_hash = self.previous_hash
            self.previous_hash = self._compute_hash(entry)

        if self.signer:
            entry.signature = self.signer.sign(entry)

        # Store entry
        await self.storage.store(entry)

        # Always continue - audit is observational only
        return HookResult(action=&quot;continue&quot;)

    def _create_entry(self, event: str, data: dict) -&gt; AuditEntry:
        &quot;&quot;&quot;Create audit entry from event.&quot;&quot;&quot;
        return AuditEntry(
            entry_id=str(uuid.uuid4()),
            timestamp=datetime.utcnow(),
            session_id=data.get(&quot;session_id&quot;, &quot;unknown&quot;),
            user_id=data.get(&quot;user_id&quot;),
            event_type=event,
            event_category=self._categorize_event(event),
            action=self._extract_action(event, data),
            resource_type=self._extract_resource_type(event, data),
            resource_id=self._extract_resource_id(event, data),
            input=self._extract_input(event, data),
            output=self._extract_output(event, data),
            outcome=self._determine_outcome(event, data),
            metadata=self._extract_metadata(event, data),
        )


class AuditSanitizer:
    &quot;&quot;&quot;Sanitize audit entries to remove sensitive data.&quot;&quot;&quot;

    def __init__(self, config: PrivacyConfig):
        self.config = config
        self.secret_patterns = self._compile_patterns()

    def sanitize(self, entry: AuditEntry) -&gt; AuditEntry:
        &quot;&quot;&quot;Remove or redact sensitive information.&quot;&quot;&quot;
        if self.config.redact_secrets:
            if entry.input:
                entry.input = self._redact_secrets(entry.input)
            if entry.output:
                entry.output = self._redact_secrets(entry.output)

        if self.config.hash_user_ids and entry.user_id:
            entry.user_id = hashlib.sha256(entry.user_id.encode()).hexdigest()[:16]

        return entry

    def _redact_secrets(self, data: dict) -&gt; dict:
        &quot;&quot;&quot;Recursively redact secrets from data.&quot;&quot;&quot;
        if isinstance(data, dict):
            return {k: self._redact_secrets(v) for k, v in data.items()}
        if isinstance(data, str):
            for pattern in self.secret_patterns:
                data = pattern.sub(&quot;[REDACTED]&quot;, data)
            return data
        return data


class AuditSigner:
    &quot;&quot;&quot;Sign audit entries for integrity verification.&quot;&quot;&quot;

    def __init__(self, config: IntegrityConfig):
        self.private_key = self._load_private_key(config.key_path)

    def sign(self, entry: AuditEntry) -&gt; str:
        &quot;&quot;&quot;Create signature for audit entry.&quot;&quot;&quot;
        payload = self._serialize_for_signing(entry)
        signature = self.private_key.sign(payload.encode())
        return base64.b64encode(signature).decode()

    def verify(self, entry: AuditEntry) -&gt; bool:
        &quot;&quot;&quot;Verify audit entry signature.&quot;&quot;&quot;
        payload = self._serialize_for_signing(entry)
        signature = base64.b64decode(entry.signature)
        try:
            self.public_key.verify(signature, payload.encode())
            return True
        except Exception:
            return False</code></pre>
        </div>
        <p>---</p>
        <h3>Storage Backends</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">File Storage</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class FileAuditStorage:
    &quot;&quot;&quot;Store audit logs as local files.&quot;&quot;&quot;

    async def store(self, entry: AuditEntry) -&gt; None:
        # Rotate files by date
        file_path = self._get_file_path(entry.timestamp)

        async with aiofiles.open(file_path, &quot;a&quot;) as f:
            await f.write(json.dumps(asdict(entry)) + &quot;\n&quot;)

    def _get_file_path(self, timestamp: datetime) -&gt; Path:
        date_str = timestamp.strftime(&quot;%Y-%m-%d&quot;)
        return self.base_path / f&quot;audit-{date_str}.jsonl&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">S3 Storage</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class S3AuditStorage:
    &quot;&quot;&quot;Store audit logs in S3.&quot;&quot;&quot;

    async def store(self, entry: AuditEntry) -&gt; None:
        # Buffer entries and flush periodically
        self.buffer.append(entry)

        if len(self.buffer) &gt;= self.batch_size:
            await self._flush()

    async def _flush(self) -&gt; None:
        # Write buffered entries to S3
        key = f&quot;{self.prefix}{datetime.utcnow().isoformat()}.jsonl&quot;
        body = &quot;\n&quot;.join(json.dumps(asdict(e)) for e in self.buffer)
        await self.s3.put_object(Bucket=self.bucket, Key=key, Body=body)
        self.buffer.clear()</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Tool Execution Audit Entry</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">{
    &quot;entry_id&quot;: &quot;audit-001-abc123&quot;,
    &quot;timestamp&quot;: &quot;2024-01-15T10:30:45.123Z&quot;,
    &quot;session_id&quot;: &quot;sess-456&quot;,
    &quot;user_id&quot;: &quot;alice&quot;,
    &quot;event_type&quot;: &quot;tool:post&quot;,
    &quot;event_category&quot;: &quot;operation&quot;,
    &quot;action&quot;: &quot;execute&quot;,
    &quot;resource_type&quot;: &quot;tool&quot;,
    &quot;resource_id&quot;: &quot;filesystem:write&quot;,
    &quot;input&quot;: {
        &quot;tool&quot;: &quot;filesystem&quot;,
        &quot;operation&quot;: &quot;write&quot;,
        &quot;file_path&quot;: &quot;src/payments/gateway.py&quot;,
        &quot;content_length&quot;: 1234
    },
    &quot;output&quot;: {
        &quot;success&quot;: true,
        &quot;bytes_written&quot;: 1234
    },
    &quot;outcome&quot;: &quot;success&quot;,
    &quot;metadata&quot;: {
        &quot;duration_ms&quot;: 45,
        &quot;provider&quot;: &quot;anthropic&quot;,
        &quot;model&quot;: &quot;claude-3&quot;
    },
    &quot;previous_hash&quot;: &quot;sha256:abc123...&quot;,
    &quot;signature&quot;: &quot;base64:xyz789...&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Approval Audit Entry</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">{
    &quot;entry_id&quot;: &quot;audit-002-def456&quot;,
    &quot;timestamp&quot;: &quot;2024-01-15T10:31:00.000Z&quot;,
    &quot;session_id&quot;: &quot;sess-456&quot;,
    &quot;user_id&quot;: &quot;alice&quot;,
    &quot;event_type&quot;: &quot;approval:granted&quot;,
    &quot;event_category&quot;: &quot;lifecycle&quot;,
    &quot;action&quot;: &quot;approve&quot;,
    &quot;resource_type&quot;: &quot;operation&quot;,
    &quot;resource_id&quot;: &quot;delete:production/config.yaml&quot;,
    &quot;input&quot;: {
        &quot;prompt&quot;: &quot;Delete production config file?&quot;,
        &quot;options&quot;: [&quot;Allow&quot;, &quot;Deny&quot;]
    },
    &quot;output&quot;: {
        &quot;decision&quot;: &quot;Allow&quot;,
        &quot;reason&quot;: &quot;User approved&quot;
    },
    &quot;outcome&quot;: &quot;success&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Session Summary</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Query audit log for session summary
entries = await audit_storage.query(AuditQuery(session_id=&quot;sess-456&quot;))

# Produces report:
&quot;&quot;&quot;
Session Audit Report: sess-456
User: alice
Duration: 15 minutes
Start: 2024-01-15T10:30:00Z
End: 2024-01-15T10:45:00Z

Operations:
- Files written: 5
- Files read: 12
- Tools executed: 23
- Approvals requested: 2
- Approvals granted: 2
- Errors: 0

File Changes:
1. src/payments/gateway.py (created)
2. src/payments/retry.py (created)
3. tests/test_gateway.py (modified)
4. pyproject.toml (modified)
5. README.md (modified)
&quot;&quot;&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>storage.type</code></td><td>string</td><td>"file"</td><td>Storage backend</td></tr>
            <tr><td><code>storage.path</code></td><td>string</td><td>"./audit"</td><td>Path for file storage</td></tr>
            <tr><td><code>capture.*</code></td><td>bool</td><td>true</td><td>What events to capture</td></tr>
            <tr><td><code>retention.days</code></td><td>int</td><td>365</td><td>Log retention period</td></tr>
            <tr><td><code>privacy.redact_secrets</code></td><td>bool</td><td>true</td><td>Redact detected secrets</td></tr>
            <tr><td><code>privacy.hash_user_ids</code></td><td>bool</td><td>false</td><td>Hash user identifiers</td></tr>
            <tr><td><code>integrity.sign_entries</code></td><td>bool</td><td>false</td><td>Sign entries</td></tr>
            <tr><td><code>integrity.chain_hashes</code></td><td>bool</td><td>false</td><td>Create hash chain</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Compliance Notes</h3>
        <li><strong>SOC 2</strong>: Immutable logs with integrity verification</li>
        <li><strong>HIPAA</strong>: Redaction of PHI, access logging</li>
        <li><strong>GDPR</strong>: User identification controls, retention limits</li>
        <li><strong>PCI-DSS</strong>: Cardholder data redaction</li>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Audit logs themselves contain sensitive data</li>
        <li>Signing keys must be protected</li>
        <li>Storage must be access-controlled</li>
        <li>Log tampering detection via hash chains</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>aiofiles</code> - Async file operations</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>boto3</code> - S3 storage</li>
        <li><code>cryptography</code> - Entry signing</li>
        <li><code>elasticsearch</code> - ES storage</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Real-time streaming</strong>: Stream audit logs to SIEM?</li>
        <li><strong>Query interface</strong>: Provide search API within hook?</li>
        <li><strong>Log rotation</strong>: Built-in rotation vs external tools?</li>
        <li><strong>Alert integration</strong>: Trigger alerts on suspicious patterns?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-breaking-change" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Breaking Change</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-breaking-change</code></p>
        </div>
        <h3>Overview</h3>
        <p>Detects potential breaking changes in API contracts, database schemas, and public interfaces. Warns developers before they accidentally break downstream consumers.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Breaking changes discovered by consumers</td><td>Detected before merge</td></tr>
            <tr><td>"We didn't know that was public API"</td><td>Clear visibility into contracts</td></tr>
            <tr><td>Versioning afterthought</td><td>Version bump reminders</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-breaking-change
    config:
      # What to analyze
      analyze:
        api_endpoints: true             # REST/GraphQL endpoints
        function_signatures: true       # Public function changes
        database_schemas: true          # Schema migrations
        config_files: true              # Configuration formats
        proto_files: true               # Protocol buffers

      # Detection rules
      rules:
        api:
          # Breaking: removing endpoint, changing required params
          - type: endpoint_removed
            severity: error
          - type: required_param_added
            severity: error
          - type: response_field_removed
            severity: error
          # Non-breaking: adding optional param, new endpoint
          - type: optional_param_added
            severity: info
          - type: endpoint_added
            severity: info

        functions:
          # Public functions (exported)
          - type: signature_changed
            scope: public
            severity: error
          - type: function_removed
            scope: public
            severity: error
          # Private functions (not exported)
          - type: signature_changed
            scope: private
            severity: info

        database:
          - type: column_removed
            severity: error
          - type: column_type_changed
            severity: error
          - type: not_null_added
            severity: warning

      # Action on detection
      on_breaking_change:
        action: inject_context          # inject_context | deny | warn
        require_acknowledgment: true</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Detected breaking change
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;&quot;&quot;
âš ï¸ **Breaking Change Detected**

File: src/api/users.py

**Changes:**
1. **BREAKING**: Removed endpoint `DELETE /api/users/{id}`
   - This endpoint may have consumers depending on it
   - Consider deprecation period before removal

2. **BREAKING**: Added required parameter `email` to `POST /api/users`
   - Existing clients will fail without this parameter
   - Consider making optional with default, or versioning API

**Recommendations:**
- Add `@deprecated` decorator with removal date
- Create v2 endpoint with new signature
- Update API changelog

Do you want to proceed with these breaking changes?
&quot;&quot;&quot;,
    user_message=&quot;Breaking changes detected in users.py API&quot;,
    user_message_level=&quot;warning&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class BreakingChangeHook:
    &quot;&quot;&quot;Detect breaking changes in code.&quot;&quot;&quot;

    def __init__(self, config: BreakingChangeConfig):
        self.config = config
        self.analyzers = self._initialize_analyzers()

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        if event != &quot;tool:post&quot; or not self._is_code_write(data):
            return HookResult(action=&quot;continue&quot;)

        file_path = data.get(&quot;file_path&quot;, &quot;&quot;)
        new_content = data.get(&quot;content&quot;, &quot;&quot;)

        # Get previous content from git
        old_content = await self._get_previous_content(file_path)
        if old_content is None:
            return HookResult(action=&quot;continue&quot;)  # New file

        # Analyze for breaking changes
        changes = await self._analyze_changes(file_path, old_content, new_content)

        if not changes:
            return HookResult(action=&quot;continue&quot;)

        # Filter by severity
        breaking = [c for c in changes if c.severity in (&quot;error&quot;, &quot;warning&quot;)]

        if not breaking:
            return HookResult(action=&quot;continue&quot;)

        return self._generate_feedback(file_path, breaking)

    async def _analyze_changes(
        self,
        file_path: str,
        old_content: str,
        new_content: str
    ) -&gt; list[ChangeDetection]:
        &quot;&quot;&quot;Analyze changes using appropriate analyzer.&quot;&quot;&quot;
        changes = []

        for analyzer in self.analyzers:
            if analyzer.can_analyze(file_path):
                analyzer_changes = await analyzer.analyze(
                    file_path, old_content, new_content
                )
                changes.extend(analyzer_changes)

        return changes


class APIAnalyzer:
    &quot;&quot;&quot;Analyze REST API changes.&quot;&quot;&quot;

    async def analyze(
        self,
        file_path: str,
        old_content: str,
        new_content: str
    ) -&gt; list[ChangeDetection]:
        changes = []

        # Extract endpoints from both versions
        old_endpoints = self._extract_endpoints(old_content)
        new_endpoints = self._extract_endpoints(new_content)

        # Check for removed endpoints
        for endpoint in old_endpoints:
            if endpoint not in new_endpoints:
                changes.append(ChangeDetection(
                    type=&quot;endpoint_removed&quot;,
                    severity=&quot;error&quot;,
                    location=file_path,
                    description=f&quot;Endpoint removed: {endpoint.method} {endpoint.path}&quot;,
                    old_value=str(endpoint),
                    new_value=None
                ))

        # Check for signature changes
        for old_ep in old_endpoints:
            new_ep = self._find_endpoint(new_endpoints, old_ep.method, old_ep.path)
            if new_ep:
                param_changes = self._compare_parameters(old_ep, new_ep)
                changes.extend(param_changes)

        return changes

    def _extract_endpoints(self, content: str) -&gt; list[Endpoint]:
        &quot;&quot;&quot;Extract API endpoints from code.&quot;&quot;&quot;
        endpoints = []

        # Flask/FastAPI style decorators
        patterns = [
            r&#039;@app\.(?:get|post|put|delete|patch)\([&quot;\&#039;]([^&quot;\&#039;]+)[&quot;\&#039;]&#039;,
            r&#039;@router\.(?:get|post|put|delete|patch)\([&quot;\&#039;]([^&quot;\&#039;]+)[&quot;\&#039;]&#039;,
        ]

        for pattern in patterns:
            for match in re.finditer(pattern, content):
                # Extract method and path
                # Parse function signature for parameters
                endpoints.append(self._parse_endpoint(match, content))

        return endpoints


class FunctionSignatureAnalyzer:
    &quot;&quot;&quot;Analyze public function signature changes.&quot;&quot;&quot;

    async def analyze(
        self,
        file_path: str,
        old_content: str,
        new_content: str
    ) -&gt; list[ChangeDetection]:
        changes = []

        # Parse both versions
        old_functions = self._extract_functions(old_content)
        new_functions = self._extract_functions(new_content)

        # Check public functions only
        for name, old_func in old_functions.items():
            if not self._is_public(name, old_func):
                continue

            if name not in new_functions:
                changes.append(ChangeDetection(
                    type=&quot;function_removed&quot;,
                    severity=&quot;error&quot;,
                    location=f&quot;{file_path}:{old_func.line}&quot;,
                    description=f&quot;Public function removed: {name}&quot;,
                ))
            else:
                new_func = new_functions[name]
                sig_changes = self._compare_signatures(old_func, new_func)
                if sig_changes:
                    changes.append(ChangeDetection(
                        type=&quot;signature_changed&quot;,
                        severity=&quot;error&quot;,
                        location=f&quot;{file_path}:{new_func.line}&quot;,
                        description=f&quot;Signature changed for {name}: {sig_changes}&quot;,
                    ))

        return changes

    def _is_public(self, name: str, func: FunctionInfo) -&gt; bool:
        &quot;&quot;&quot;Determine if function is public.&quot;&quot;&quot;
        # Python: doesn&#039;t start with _
        if name.startswith(&quot;_&quot;):
            return False
        # Check for @public decorator or __all__ export
        return True</code></pre>
        </div>
        <p>---</p>
        <h3>Change Detection Types</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">API Changes</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Type</th><th>Severity</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>endpoint_removed</code></td><td>error</td><td>Endpoint deleted</td></tr>
            <tr><td><code>required_param_added</code></td><td>error</td><td>New required parameter</td></tr>
            <tr><td><code>response_field_removed</code></td><td>error</td><td>Field removed from response</td></tr>
            <tr><td><code>return_type_changed</code></td><td>error</td><td>Return type changed</td></tr>
            <tr><td><code>optional_param_added</code></td><td>info</td><td>New optional parameter</td></tr>
            <tr><td><code>endpoint_added</code></td><td>info</td><td>New endpoint</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Function Signature Changes</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Type</th><th>Severity</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>function_removed</code></td><td>error</td><td>Public function removed</td></tr>
            <tr><td><code>param_removed</code></td><td>error</td><td>Parameter removed</td></tr>
            <tr><td><code>param_type_changed</code></td><td>error</td><td>Parameter type changed</td></tr>
            <tr><td><code>return_type_changed</code></td><td>error</td><td>Return type changed</td></tr>
            <tr><td><code>param_added_required</code></td><td>error</td><td>Required param added</td></tr>
            <tr><td><code>param_added_optional</code></td><td>info</td><td>Optional param added</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Database Schema Changes</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Type</th><th>Severity</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>column_removed</code></td><td>error</td><td>Column dropped</td></tr>
            <tr><td><code>column_type_changed</code></td><td>error</td><td>Column type changed</td></tr>
            <tr><td><code>not_null_added</code></td><td>warning</td><td>NOT NULL constraint added</td></tr>
            <tr><td><code>table_removed</code></td><td>error</td><td>Table dropped</td></tr>
            <tr><td><code>column_added_nullable</code></td><td>info</td><td>Nullable column added</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: API Endpoint Removed</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Old code:
@app.delete(&quot;/api/users/{id}&quot;)
def delete_user(id: int):
    ...

# New code: (endpoint removed)

# Hook detects and warns:
&quot;&quot;&quot;
âš ï¸ **Breaking Change Detected**

**BREAKING**: Endpoint removed: DELETE /api/users/{id}
- Consumers using this endpoint will receive 404

**Recommendation:**
- Add deprecation notice before removal
- Provide migration path in documentation
&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Function Signature Change</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Old:
def process_payment(amount: float, currency: str) -&gt; bool:
    ...

# New:
def process_payment(amount: float, currency: str, idempotency_key: str) -&gt; PaymentResult:
    ...

# Hook detects:
&quot;&quot;&quot;
âš ï¸ **Breaking Change Detected**

1. **BREAKING**: New required parameter `idempotency_key`
   - Existing callers will fail with TypeError

2. **BREAKING**: Return type changed from `bool` to `PaymentResult`
   - Callers expecting boolean will break

**Recommendations:**
- Make `idempotency_key` optional with default
- Keep backward-compatible return for transition period
&quot;&quot;&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>analyze.*</code></td><td>bool</td><td>true</td><td>What to analyze</td></tr>
            <tr><td><code>rules.<category></code></td><td>list</td><td>(defaults)</td><td>Detection rules</td></tr>
            <tr><td><code>on_breaking_change.action</code></td><td>string</td><td>"inject_context"</td><td>Action on detection</td></tr>
            <tr><td><code>on_breaking_change.require_acknowledgment</code></td><td>bool</td><td>true</td><td>Require user ack</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Reads file content and git history</li>
        <li>No external network access</li>
        <li>Analysis is local and fast</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>tree-sitter</code> - Code parsing</li>
        <li><code>gitpython</code> - Git history access</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>Language-specific parsers</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Semantic versioning</strong>: Auto-suggest version bump?</li>
        <li><strong>Changelog</strong>: Auto-generate changelog entries?</li>
        <li><strong>Consumer notification</strong>: Integrate with deprecation notices?</li>
        <li><strong>Custom contracts</strong>: Support custom API contract formats?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-knowledge-capture" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Knowledge Capture</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-knowledge-capture</code></p>
        </div>
        <h3>Overview</h3>
        <p>Automatically captures learnings, decisions, and insights from AI sessions and stores them in a team knowledge base. Transforms ephemeral conversations into persistent organizational knowledge.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Knowledge lost after session ends</td><td>Insights captured automatically</td></tr>
            <tr><td>"We figured this out before..."</td><td>Searchable knowledge base</td></tr>
            <tr><td>Tribal knowledge in people's heads</td><td>Documented and shared</td></tr>
            <tr><td>Repeated problem-solving</td><td>Learn from past sessions</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-knowledge-capture
    config:
      # What to capture
      capture:
        decisions: true                 # &quot;Let&#039;s use X approach&quot;
        learnings: true                 # &quot;TIL...&quot;, &quot;I learned...&quot;
        solutions: true                 # Problem-solution pairs
        code_patterns: true             # Reusable code patterns
        gotchas: true                   # &quot;Watch out for...&quot;, &quot;Don&#039;t forget...&quot;

      # Knowledge base storage
      storage:
        type: markdown                  # markdown | notion | confluence | custom
        path: &quot;docs/knowledge-base/&quot;
        organize_by: topic              # topic | date | project

      # Extraction settings
      extraction:
        min_significance: 0.7           # Confidence threshold
        require_confirmation: false     # Ask before saving
        deduplicate: true               # Skip if similar exists

      # Categories/tags
      categories:
        - architecture
        - debugging
        - performance
        - security
        - testing
        - deployment</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Capture knowledge at session end
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;&quot;,  # No injection needed
    suppress_output=True,
    user_message=&quot;Captured 3 learnings to knowledge base&quot;
)

# Or ask for confirmation
HookResult(
    action=&quot;ask_user&quot;,
    approval_prompt=&quot;&quot;&quot;
Knowledge capture found these insights:

1. **Decision**: Use exponential backoff for payment retries (max 3 attempts)
2. **Gotcha**: Payment gateway returns 200 even on soft failures - check response body
3. **Pattern**: Retry decorator pattern for idempotent operations

Save to knowledge base?
&quot;&quot;&quot;,
    approval_options=[&quot;Save all&quot;, &quot;Save selected&quot;, &quot;Skip&quot;]
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class KnowledgeCaptureHook:
    &quot;&quot;&quot;Capture and store knowledge from sessions.&quot;&quot;&quot;

    def __init__(self, config: KnowledgeCaptureConfig):
        self.config = config
        self.storage = self._create_storage(config.storage)
        self.extractor = KnowledgeExtractor(config.extraction)
        self.session_messages: list[dict] = []

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        # Collect messages during session
        if event in (&quot;prompt:submit&quot;, &quot;prompt:complete&quot;):
            self._collect_message(event, data)
            return HookResult(action=&quot;continue&quot;)

        # Extract knowledge at session end
        if event == &quot;session:end&quot;:
            return await self._extract_and_save()

        return HookResult(action=&quot;continue&quot;)

    def _collect_message(self, event: str, data: dict) -&gt; None:
        &quot;&quot;&quot;Collect messages for later analysis.&quot;&quot;&quot;
        if event == &quot;prompt:submit&quot;:
            self.session_messages.append({
                &quot;role&quot;: &quot;user&quot;,
                &quot;content&quot;: data.get(&quot;prompt&quot;, &quot;&quot;)
            })
        elif event == &quot;prompt:complete&quot;:
            self.session_messages.append({
                &quot;role&quot;: &quot;assistant&quot;,
                &quot;content&quot;: data.get(&quot;response&quot;, &quot;&quot;)
            })

    async def _extract_and_save(self) -&gt; HookResult:
        &quot;&quot;&quot;Extract knowledge and save to storage.&quot;&quot;&quot;
        if not self.session_messages:
            return HookResult(action=&quot;continue&quot;)

        # Extract knowledge items
        items = await self.extractor.extract(self.session_messages)

        if not items:
            return HookResult(action=&quot;continue&quot;)

        # Deduplicate if configured
        if self.config.extraction.deduplicate:
            items = await self._deduplicate(items)

        if not items:
            return HookResult(action=&quot;continue&quot;)

        # Save or request confirmation
        if self.config.extraction.require_confirmation:
            return self._request_confirmation(items)
        else:
            await self._save_items(items)
            return HookResult(
                action=&quot;continue&quot;,
                user_message=f&quot;Captured {len(items)} knowledge items&quot;
            )


class KnowledgeExtractor:
    &quot;&quot;&quot;Extract knowledge items from conversation.&quot;&quot;&quot;

    # Patterns indicating knowledge
    DECISION_PATTERNS = [
        r&quot;let&#039;s use&quot;,
        r&quot;we(&#039;ll| will) go with&quot;,
        r&quot;decided to&quot;,
        r&quot;the approach (is|will be)&quot;,
        r&quot;choosing .* because&quot;,
    ]

    LEARNING_PATTERNS = [
        r&quot;(TIL|I learned|we learned)&quot;,
        r&quot;turns out&quot;,
        r&quot;discovered that&quot;,
        r&quot;found out&quot;,
        r&quot;realized&quot;,
    ]

    GOTCHA_PATTERNS = [
        r&quot;watch out for&quot;,
        r&quot;don&#039;t forget&quot;,
        r&quot;gotcha&quot;,
        r&quot;caveat&quot;,
        r&quot;be careful&quot;,
        r&quot;important to note&quot;,
        r&quot;heads up&quot;,
    ]

    SOLUTION_PATTERNS = [
        r&quot;(the |this )?(fix|solution) (is|was)&quot;,
        r&quot;solved (it |this )by&quot;,
        r&quot;fixed (it |this )by&quot;,
        r&quot;the answer (is|was)&quot;,
    ]

    async def extract(self, messages: list[dict]) -&gt; list[KnowledgeItem]:
        &quot;&quot;&quot;Extract knowledge items from messages.&quot;&quot;&quot;
        items = []

        # Concatenate conversation
        full_text = &quot;\n&quot;.join(m[&quot;content&quot;] for m in messages)

        # Pattern-based extraction
        items.extend(self._extract_by_patterns(messages))

        # LLM-based extraction for deeper insights
        items.extend(await self._extract_with_llm(messages))

        # Filter by significance
        items = [i for i in items if i.significance &gt;= self.config.min_significance]

        return items

    def _extract_by_patterns(self, messages: list[dict]) -&gt; list[KnowledgeItem]:
        &quot;&quot;&quot;Extract using pattern matching.&quot;&quot;&quot;
        items = []

        for message in messages:
            content = message[&quot;content&quot;]

            # Check each category
            for pattern in self.DECISION_PATTERNS:
                matches = re.finditer(pattern, content, re.IGNORECASE)
                for match in matches:
                    context = self._get_context(content, match)
                    items.append(KnowledgeItem(
                        type=&quot;decision&quot;,
                        content=context,
                        significance=0.8
                    ))

            for pattern in self.GOTCHA_PATTERNS:
                matches = re.finditer(pattern, content, re.IGNORECASE)
                for match in matches:
                    context = self._get_context(content, match)
                    items.append(KnowledgeItem(
                        type=&quot;gotcha&quot;,
                        content=context,
                        significance=0.85
                    ))

        return items

    async def _extract_with_llm(self, messages: list[dict]) -&gt; list[KnowledgeItem]:
        &quot;&quot;&quot;Use LLM to extract deeper insights.&quot;&quot;&quot;
        # Use a small, fast model for extraction
        prompt = f&quot;&quot;&quot;
Analyze this conversation and extract key knowledge items:

{self._format_conversation(messages)}

Extract:
1. Decisions made and their rationale
2. Learnings or discoveries
3. Solutions to problems encountered
4. Gotchas or caveats mentioned
5. Reusable patterns or approaches

Format as JSON array with: type, content, category, significance (0-1)
&quot;&quot;&quot;
        # Call LLM and parse response
        # ...</code></pre>
        </div>
        <p>---</p>
        <h3>Knowledge Item Schema</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class KnowledgeItem:
    type: str                           # decision | learning | gotcha | solution | pattern
    content: str                        # The knowledge content
    category: str | None                # architecture | debugging | etc.
    significance: float                 # 0-1 confidence score

    # Metadata
    source_session: str | None
    timestamp: datetime
    related_files: list[str]
    tags: list[str]

    # For solutions
    problem: str | None                 # What problem this solves
    solution: str | None                # How it solves it</code></pre>
        </div>
        <p>---</p>
        <h3>Storage Formats</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Markdown (Default)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"># Knowledge Base

## Decisions

### Use exponential backoff for payment retries
**Date**: 2024-01-15
**Category**: Architecture
**Context**: Payment gateway integration

Decided to implement exponential backoff with max 3 retries for payment processing.
Rationale: Gateway has intermittent timeouts during peak load.

**Related files**: src/payments/gateway.py

---

## Gotchas

### Payment gateway returns 200 on soft failures
**Date**: 2024-01-15
**Category**: Debugging

Watch out: The payment gateway returns HTTP 200 even when payment fails.
Must check `response.body.success` field, not just HTTP status.

---</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Notion Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class NotionStorage:
    &quot;&quot;&quot;Store knowledge in Notion database.&quot;&quot;&quot;

    async def save(self, item: KnowledgeItem) -&gt; None:
        await self.notion.pages.create(
            parent={&quot;database_id&quot;: self.database_id},
            properties={
                &quot;Title&quot;: {&quot;title&quot;: [{&quot;text&quot;: {&quot;content&quot;: item.content[:100]}}]},
                &quot;Type&quot;: {&quot;select&quot;: {&quot;name&quot;: item.type}},
                &quot;Category&quot;: {&quot;select&quot;: {&quot;name&quot;: item.category}},
                &quot;Date&quot;: {&quot;date&quot;: {&quot;start&quot;: item.timestamp.isoformat()}},
                &quot;Tags&quot;: {&quot;multi_select&quot;: [{&quot;name&quot;: t} for t in item.tags]},
            },
            children=self._format_content_blocks(item)
        )</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Decision Capture</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># From session conversation:
# User: &quot;Should we use Redis or Memcached for caching?&quot;
# Assistant: &quot;Given your need for persistence and pub/sub, let&#039;s use Redis...&quot;

# Extracted:
{
    &quot;type&quot;: &quot;decision&quot;,
    &quot;content&quot;: &quot;Use Redis over Memcached for caching&quot;,
    &quot;category&quot;: &quot;architecture&quot;,
    &quot;problem&quot;: &quot;Choosing caching solution&quot;,
    &quot;solution&quot;: &quot;Redis - provides persistence and pub/sub needed for notifications&quot;,
    &quot;significance&quot;: 0.9
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Gotcha Capture</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># From session:
# Assistant: &quot;...watch out for timezone handling. The API returns UTC but
# the database stores local time, so you need to convert...&quot;

# Extracted:
{
    &quot;type&quot;: &quot;gotcha&quot;,
    &quot;content&quot;: &quot;API returns UTC, database stores local time - convert at boundary&quot;,
    &quot;category&quot;: &quot;debugging&quot;,
    &quot;tags&quot;: [&quot;timezone&quot;, &quot;api&quot;, &quot;database&quot;],
    &quot;significance&quot;: 0.85
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>capture.*</code></td><td>bool</td><td>true</td><td>What to capture</td></tr>
            <tr><td><code>storage.type</code></td><td>string</td><td>"markdown"</td><td>Storage backend</td></tr>
            <tr><td><code>storage.path</code></td><td>string</td><td>"docs/kb/"</td><td>Path for markdown</td></tr>
            <tr><td><code>extraction.min_significance</code></td><td>float</td><td>0.7</td><td>Confidence threshold</td></tr>
            <tr><td><code>extraction.require_confirmation</code></td><td>bool</td><td>false</td><td>Ask before saving</td></tr>
            <tr><td><code>extraction.deduplicate</code></td><td>bool</td><td>true</td><td>Skip duplicates</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>May capture sensitive information from sessions</li>
        <li>Storage should be access-controlled</li>
        <li>Consider PII filtering before storage</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>aiofiles</code> - File operations</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>notion-client</code> - Notion integration</li>
        <li><code>atlassian-python-api</code> - Confluence integration</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Confirmation flow</strong>: Always ask, never ask, or smart selection?</li>
        <li><strong>Cross-session</strong>: Link related knowledge across sessions?</li>
        <li><strong>Retrieval</strong>: Should this hook also inject relevant knowledge?</li>
        <li><strong>Quality</strong>: How to ensure captured knowledge is accurate?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-license-checker" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks License Checker</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-license-checker</code></p>
        </div>
        <h3>Overview</h3>
        <p>Scans dependencies for license compatibility issues in real-time. Flags problematic licenses (GPL in proprietary code, unknown licenses) before they're committed, preventing legal compliance issues.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>License issues found late in legal review</td><td>Caught at addition time</td></tr>
            <tr><td>Accidental GPL contamination</td><td>Blocked proactively</td></tr>
            <tr><td>Unknown license risks</td><td>Clear visibility</td></tr>
            <tr><td>Manual license audits</td><td>Automated checking</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-license-checker
    config:
      # License policy
      policy:
        allowed:                        # Explicitly allowed licenses
          - MIT
          - Apache-2.0
          - BSD-2-Clause
          - BSD-3-Clause
          - ISC
          - 0BSD
          - Unlicense
          - CC0-1.0

        restricted:                     # Require approval
          - LGPL-2.1
          - LGPL-3.0
          - MPL-2.0
          - EPL-1.0
          - EPL-2.0

        prohibited:                     # Always block
          - GPL-2.0
          - GPL-3.0
          - AGPL-3.0
          - SSPL-1.0
          - CC-BY-NC-*                  # Non-commercial
          - BUSL-*                      # Business source

        unknown_action: warn            # allow | warn | deny

      # Scanning scope
      scope:
        package_managers:
          - npm
          - pip
          - cargo
          - go
          - maven
          - nuget
        scan_transitive: true           # Check transitive deps
        scan_dev_deps: false            # Skip devDependencies

      # Actions
      actions:
        on_prohibited: deny             # deny | warn
        on_restricted: ask_user         # ask_user | warn
        on_unknown: warn                # warn | deny

      # Exceptions
      exceptions:
        packages:                       # Known OK packages
          - package: &quot;some-gpl-tool&quot;
            reason: &quot;CLI tool, not linked&quot;
        paths:                          # Paths to skip
          - &quot;test/**&quot;
          - &quot;scripts/**&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Prohibited license detected
HookResult(
    action=&quot;deny&quot;,
    reason=&quot;License compliance violation&quot;,
    context_injection=&quot;&quot;&quot;
â›” **License Violation Detected**

Adding dependency `copyleft-lib@2.0.0` would introduce **GPL-3.0** license.

**Why this is blocked:**
GPL-3.0 is a copyleft license that requires derivative works to also be GPL-licensed.
Your project uses MIT license, which is incompatible.

**Options:**
1. Find an alternative package with permissive license
2. Request legal exception (requires approval)
3. Change project license to GPL-compatible

**Alternatives with similar functionality:**
- `permissive-lib` (MIT) - https://github.com/example/permissive-lib
- `free-lib` (Apache-2.0) - https://github.com/example/free-lib
&quot;&quot;&quot;,
    user_message=&quot;â›” Blocked: GPL-3.0 license not allowed&quot;,
    user_message_level=&quot;error&quot;
)

# Restricted license - ask user
HookResult(
    action=&quot;ask_user&quot;,
    approval_prompt=&quot;&quot;&quot;
âš ï¸ **License Requires Approval**

Dependency `lgpl-lib@1.0.0` uses **LGPL-3.0** license.

LGPL is allowed for dynamic linking but requires:
- Providing license notice
- Allowing users to replace the library
- Not modifying the library source

Is this dependency used appropriately?
&quot;&quot;&quot;,
    approval_options=[&quot;Approve (dynamic linking)&quot;, &quot;Reject&quot;, &quot;Need more info&quot;],
    approval_default=&quot;reject&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class LicenseCheckerHook:
    &quot;&quot;&quot;Check dependencies for license compliance.&quot;&quot;&quot;

    def __init__(self, config: LicenseCheckerConfig):
        self.config = config
        self.policy = LicensePolicy(config.policy)
        self.scanners = self._initialize_scanners()
        self.license_db = LicenseDatabase()

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        # Check on dependency file changes
        if event != &quot;tool:post&quot; or not self._is_dep_file_change(data):
            return HookResult(action=&quot;continue&quot;)

        file_path = data.get(&quot;file_path&quot;, &quot;&quot;)
        content = data.get(&quot;content&quot;, &quot;&quot;)

        # Detect package manager
        pkg_manager = self._detect_package_manager(file_path)
        if not pkg_manager:
            return HookResult(action=&quot;continue&quot;)

        # Parse dependencies
        deps = await self._parse_dependencies(pkg_manager, content)

        # Check each dependency
        violations = []
        warnings = []
        approvals_needed = []

        for dep in deps:
            result = await self._check_dependency(dep, pkg_manager)

            if result.status == &quot;prohibited&quot;:
                violations.append(result)
            elif result.status == &quot;restricted&quot;:
                approvals_needed.append(result)
            elif result.status == &quot;unknown&quot;:
                if self.config.policy.unknown_action == &quot;deny&quot;:
                    violations.append(result)
                else:
                    warnings.append(result)

        # Handle results
        if violations:
            return self._deny_violations(violations)
        elif approvals_needed:
            return self._request_approval(approvals_needed)
        elif warnings:
            return self._warn_user(warnings)

        return HookResult(action=&quot;continue&quot;)

    def _is_dep_file_change(self, data: dict) -&gt; bool:
        &quot;&quot;&quot;Check if this is a dependency file change.&quot;&quot;&quot;
        file_path = data.get(&quot;file_path&quot;, &quot;&quot;)
        dep_files = [
            &quot;package.json&quot;, &quot;package-lock.json&quot;,
            &quot;requirements.txt&quot;, &quot;Pipfile&quot;, &quot;pyproject.toml&quot;,
            &quot;Cargo.toml&quot;, &quot;Cargo.lock&quot;,
            &quot;go.mod&quot;, &quot;go.sum&quot;,
            &quot;pom.xml&quot;, &quot;build.gradle&quot;,
            &quot;*.csproj&quot;, &quot;packages.config&quot;
        ]
        return any(
            file_path.endswith(f) or fnmatch.fnmatch(file_path, f)
            for f in dep_files
        )

    async def _check_dependency(
        self,
        dep: Dependency,
        pkg_manager: str
    ) -&gt; LicenseCheckResult:
        &quot;&quot;&quot;Check a single dependency&#039;s license.&quot;&quot;&quot;

        # Check exceptions first
        if self._is_excepted(dep):
            return LicenseCheckResult(
                dependency=dep,
                status=&quot;allowed&quot;,
                reason=&quot;Exception configured&quot;
            )

        # Get license info
        license_info = await self._get_license(dep, pkg_manager)

        if not license_info or license_info.license == &quot;UNKNOWN&quot;:
            return LicenseCheckResult(
                dependency=dep,
                status=&quot;unknown&quot;,
                license=None,
                reason=&quot;Could not determine license&quot;
            )

        # Check against policy
        license_id = self._normalize_license(license_info.license)

        if self.policy.is_prohibited(license_id):
            return LicenseCheckResult(
                dependency=dep,
                status=&quot;prohibited&quot;,
                license=license_id,
                reason=f&quot;{license_id} is prohibited by policy&quot;
            )

        if self.policy.is_restricted(license_id):
            return LicenseCheckResult(
                dependency=dep,
                status=&quot;restricted&quot;,
                license=license_id,
                reason=f&quot;{license_id} requires approval&quot;
            )

        if self.policy.is_allowed(license_id):
            return LicenseCheckResult(
                dependency=dep,
                status=&quot;allowed&quot;,
                license=license_id
            )

        # Not explicitly listed
        return LicenseCheckResult(
            dependency=dep,
            status=&quot;unknown&quot;,
            license=license_id,
            reason=f&quot;License {license_id} not in policy&quot;
        )

    async def _get_license(
        self,
        dep: Dependency,
        pkg_manager: str
    ) -&gt; LicenseInfo | None:
        &quot;&quot;&quot;Get license information for dependency.&quot;&quot;&quot;
        scanner = self.scanners.get(pkg_manager)
        if not scanner:
            return None

        # Check cache first
        cache_key = f&quot;{pkg_manager}:{dep.name}:{dep.version}&quot;
        cached = self.license_db.get(cache_key)
        if cached:
            return cached

        # Fetch from registry
        license_info = await scanner.get_license(dep)

        # Cache result
        if license_info:
            self.license_db.set(cache_key, license_info)

        return license_info


class LicensePolicy:
    &quot;&quot;&quot;Evaluate licenses against policy.&quot;&quot;&quot;

    def __init__(self, config: dict):
        self.allowed = set(config.get(&quot;allowed&quot;, []))
        self.restricted = set(config.get(&quot;restricted&quot;, []))
        self.prohibited = set(config.get(&quot;prohibited&quot;, []))

    def is_allowed(self, license_id: str) -&gt; bool:
        &quot;&quot;&quot;Check if license is explicitly allowed.&quot;&quot;&quot;
        return self._matches(license_id, self.allowed)

    def is_restricted(self, license_id: str) -&gt; bool:
        &quot;&quot;&quot;Check if license requires approval.&quot;&quot;&quot;
        return self._matches(license_id, self.restricted)

    def is_prohibited(self, license_id: str) -&gt; bool:
        &quot;&quot;&quot;Check if license is prohibited.&quot;&quot;&quot;
        return self._matches(license_id, self.prohibited)

    def _matches(self, license_id: str, patterns: set) -&gt; bool:
        &quot;&quot;&quot;Check if license matches any pattern.&quot;&quot;&quot;
        for pattern in patterns:
            if pattern.endswith(&quot;*&quot;):
                if license_id.startswith(pattern[:-1]):
                    return True
            elif license_id == pattern:
                return True
        return False


class NpmLicenseScanner:
    &quot;&quot;&quot;Scan npm packages for licenses.&quot;&quot;&quot;

    async def get_license(self, dep: Dependency) -&gt; LicenseInfo | None:
        &quot;&quot;&quot;Get license from npm registry.&quot;&quot;&quot;
        url = f&quot;https://registry.npmjs.org/{dep.name}/{dep.version}&quot;

        async with aiohttp.ClientSession() as session:
            async with session.get(url) as resp:
                if resp.status != 200:
                    return None
                data = await resp.json()

        license_field = data.get(&quot;license&quot;)
        if isinstance(license_field, dict):
            license_field = license_field.get(&quot;type&quot;)

        return LicenseInfo(
            package=dep.name,
            version=dep.version,
            license=license_field or &quot;UNKNOWN&quot;,
            source=&quot;npm-registry&quot;
        )

    async def parse_dependencies(self, content: str) -&gt; list[Dependency]:
        &quot;&quot;&quot;Parse package.json for dependencies.&quot;&quot;&quot;
        data = json.loads(content)
        deps = []

        for dep_type in [&quot;dependencies&quot;, &quot;devDependencies&quot;, &quot;peerDependencies&quot;]:
            if dep_type in data:
                for name, version in data[dep_type].items():
                    deps.append(Dependency(
                        name=name,
                        version=self._resolve_version(version),
                        dep_type=dep_type
                    ))

        return deps


class PipLicenseScanner:
    &quot;&quot;&quot;Scan Python packages for licenses.&quot;&quot;&quot;

    async def get_license(self, dep: Dependency) -&gt; LicenseInfo | None:
        &quot;&quot;&quot;Get license from PyPI.&quot;&quot;&quot;
        url = f&quot;https://pypi.org/pypi/{dep.name}/{dep.version}/json&quot;

        async with aiohttp.ClientSession() as session:
            async with session.get(url) as resp:
                if resp.status != 200:
                    return None
                data = await resp.json()

        info = data.get(&quot;info&quot;, {})
        license_field = info.get(&quot;license&quot;) or self._extract_from_classifiers(
            info.get(&quot;classifiers&quot;, [])
        )

        return LicenseInfo(
            package=dep.name,
            version=dep.version,
            license=license_field or &quot;UNKNOWN&quot;,
            source=&quot;pypi&quot;
        )

    def _extract_from_classifiers(self, classifiers: list[str]) -&gt; str | None:
        &quot;&quot;&quot;Extract license from classifiers.&quot;&quot;&quot;
        for classifier in classifiers:
            if classifier.startswith(&quot;License :: OSI Approved :: &quot;):
                return classifier.split(&quot;::&quot;)[-1].strip()
        return None</code></pre>
        </div>
        <p>---</p>
        <h3>License Categories</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissive (Usually Safe)</h4>
        <table class="ref-table">
          <thead>
            <tr><th>License</th><th>SPDX ID</th><th>Notes</th></tr>
          </thead>
          <tbody>
            <tr><td>MIT</td><td>MIT</td><td>Most permissive</td></tr>
            <tr><td>Apache 2.0</td><td>Apache-2.0</td><td>Patent grant</td></tr>
            <tr><td>BSD 2-Clause</td><td>BSD-2-Clause</td><td>Minimal restrictions</td></tr>
            <tr><td>BSD 3-Clause</td><td>BSD-3-Clause</td><td>No endorsement clause</td></tr>
            <tr><td>ISC</td><td>ISC</td><td>Simplified MIT</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Weak Copyleft (Caution)</h4>
        <table class="ref-table">
          <thead>
            <tr><th>License</th><th>SPDX ID</th><th>Notes</th></tr>
          </thead>
          <tbody>
            <tr><td>LGPL 2.1</td><td>LGPL-2.1</td><td>OK if dynamically linked</td></tr>
            <tr><td>LGPL 3.0</td><td>LGPL-3.0</td><td>OK if dynamically linked</td></tr>
            <tr><td>MPL 2.0</td><td>MPL-2.0</td><td>File-level copyleft</td></tr>
            <tr><td>EPL 2.0</td><td>EPL-2.0</td><td>Module-level copyleft</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Strong Copyleft (Usually Blocked)</h4>
        <table class="ref-table">
          <thead>
            <tr><th>License</th><th>SPDX ID</th><th>Notes</th></tr>
          </thead>
          <tbody>
            <tr><td>GPL 2.0</td><td>GPL-2.0</td><td>Viral copyleft</td></tr>
            <tr><td>GPL 3.0</td><td>GPL-3.0</td><td>Viral copyleft</td></tr>
            <tr><td>AGPL 3.0</td><td>AGPL-3.0</td><td>Network copyleft</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Problematic</h4>
        <table class="ref-table">
          <thead>
            <tr><th>License</th><th>SPDX ID</th><th>Notes</th></tr>
          </thead>
          <tbody>
            <tr><td>SSPL</td><td>SSPL-1.0</td><td>MongoDB license</td></tr>
            <tr><td>BSL</td><td>BUSL-*</td><td>Time-delayed open source</td></tr>
            <tr><td>CC BY-NC</td><td>CC-BY-NC-*</td><td>Non-commercial only</td></tr>
            <tr><td>Proprietary</td><td>-</td><td>Requires explicit grant</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: GPL Dependency Blocked</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># User adds axios-gpl (fictional) to package.json

# Hook response:
HookResult(
    action=&quot;deny&quot;,
    reason=&quot;GPL-3.0 license prohibited&quot;,
    context_injection=&quot;&quot;&quot;
â›” **License Violation: GPL-3.0**

Package: `axios-gpl@1.0.0`
License: GPL-3.0

**Why blocked:**
GPL-3.0 requires any derivative work to also be licensed under GPL.
Your project (MIT) cannot include GPL dependencies.

**Alternatives:**
- `axios` (MIT) - Same functionality, permissive license
- `node-fetch` (MIT) - Lighter alternative
&quot;&quot;&quot;
)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: LGPL Requires Approval</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># User adds chart.js which uses LGPL dependency

# Hook asks:
HookResult(
    action=&quot;ask_user&quot;,
    approval_prompt=&quot;&quot;&quot;
âš ï¸ **LGPL Dependency Detected**

`chart.js@4.0.0` â†’ `color@4.0.0` (LGPL-2.1)

LGPL is conditionally acceptable if:
âœ“ Used as dynamic library (not modified)
âœ“ License notice included
âœ“ Users can replace the library

Is this usage compliant?
&quot;&quot;&quot;,
    approval_options=[&quot;Approve&quot;, &quot;Reject&quot;, &quot;Need legal review&quot;]
)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Unknown License Warning</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Package has no license field

# Hook warns:
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;&quot;&quot;
âš ï¸ **Unknown License Warning**

Package: `mystery-lib@0.5.0`
License: UNKNOWN

Could not determine license from:
- package.json
- LICENSE file
- npm registry

**Risk:** Without explicit license, code is &quot;all rights reserved&quot; by default.

**Recommendations:**
1. Check package repository for LICENSE file
2. Contact maintainer to add license
3. Find alternative with clear license
&quot;&quot;&quot;,
    user_message=&quot;âš ï¸ Warning: mystery-lib has no license&quot;,
    user_message_level=&quot;warning&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Transitive Dependency Scanning</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def scan_transitive(
    self,
    direct_deps: list[Dependency],
    pkg_manager: str
) -&gt; list[TransitiveDep]:
    &quot;&quot;&quot;Scan transitive dependencies.&quot;&quot;&quot;

    if pkg_manager == &quot;npm&quot;:
        # Use npm ls --json for full tree
        result = await asyncio.create_subprocess_exec(
            &quot;npm&quot;, &quot;ls&quot;, &quot;--json&quot;, &quot;--all&quot;,
            stdout=asyncio.subprocess.PIPE
        )
        stdout, _ = await result.communicate()
        tree = json.loads(stdout.decode())
        return self._parse_npm_tree(tree)

    elif pkg_manager == &quot;pip&quot;:
        # Use pipdeptree
        result = await asyncio.create_subprocess_exec(
            &quot;pipdeptree&quot;, &quot;--json&quot;,
            stdout=asyncio.subprocess.PIPE
        )
        stdout, _ = await result.communicate()
        return self._parse_pip_tree(json.loads(stdout.decode()))

    # ... other package managers</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>policy.allowed</code></td><td>list</td><td>[]</td><td>Allowed licenses</td></tr>
            <tr><td><code>policy.restricted</code></td><td>list</td><td>[]</td><td>Licenses needing approval</td></tr>
            <tr><td><code>policy.prohibited</code></td><td>list</td><td>[]</td><td>Blocked licenses</td></tr>
            <tr><td><code>policy.unknown_action</code></td><td>string</td><td>"warn"</td><td>Action for unknown</td></tr>
            <tr><td><code>scope.scan_transitive</code></td><td>bool</td><td>true</td><td>Check transitive deps</td></tr>
            <tr><td><code>scope.scan_dev_deps</code></td><td>bool</td><td>false</td><td>Include devDependencies</td></tr>
            <tr><td><code>actions.on_prohibited</code></td><td>string</td><td>"deny"</td><td>Action on prohibited</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Makes network calls to package registries</li>
        <li>Caches license data locally</li>
        <li>No sensitive data exposed</li>
        <li>Offline mode available with pre-populated cache</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>aiohttp</code> - HTTP client</li>
        <li><code>spdx-tools</code> - License parsing (optional)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>Package manager CLIs for transitive scanning</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>SBOM generation</strong>: Should we generate Software Bill of Materials?</li>
        <li><strong>License changes</strong>: Alert when dependency changes license?</li>
        <li><strong>Legal integration</strong>: Connect to legal approval workflow?</li>
        <li><strong>Dual licensing</strong>: How to handle dual-licensed packages?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-model-router" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Model Router</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-model-router</code></p>
        </div>
        <h3>Overview</h3>
        <p>Intelligent routing of LLM requests to appropriate models based on task complexity, cost optimization, latency requirements, and capabilities. Routes simple tasks to cheaper models while preserving quality for complex work.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>All tasks use same expensive model</td><td>Smart routing saves 50-70% on costs</td></tr>
            <tr><td>Simple tasks wait for slow models</td><td>Fast models for simple tasks</td></tr>
            <tr><td>One-size-fits-all</td><td>Task-appropriate model selection</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-model-router
    config:
      # Available models with capabilities
      models:
        high_capability:
          provider: anthropic
          model: claude-3-opus
          capabilities: [reasoning, coding, analysis, creative]
          cost_per_1k: 0.015
          latency_ms: 2000

        balanced:
          provider: anthropic
          model: claude-3-sonnet
          capabilities: [reasoning, coding, analysis, creative]
          cost_per_1k: 0.003
          latency_ms: 1000

        fast:
          provider: anthropic
          model: claude-3-haiku
          capabilities: [simple, formatting, extraction]
          cost_per_1k: 0.00025
          latency_ms: 500

        code_specialized:
          provider: openai
          model: gpt-4-turbo
          capabilities: [coding, debugging]
          cost_per_1k: 0.01
          latency_ms: 1500

      # Routing rules
      routing:
        # Task-based routing
        tasks:
          simple_questions:
            patterns: [&quot;what is&quot;, &quot;define&quot;, &quot;list&quot;, &quot;when was&quot;]
            route_to: fast

          code_generation:
            patterns: [&quot;write.*function&quot;, &quot;implement&quot;, &quot;create.*class&quot;]
            route_to: balanced

          complex_reasoning:
            patterns: [&quot;analyze&quot;, &quot;compare.*and.*contrast&quot;, &quot;evaluate&quot;]
            route_to: high_capability

          debugging:
            patterns: [&quot;fix.*bug&quot;, &quot;debug&quot;, &quot;why.*error&quot;]
            route_to: code_specialized

        # Token-based routing
        tokens:
          - max_input: 1000
            route_to: fast
          - max_input: 10000
            route_to: balanced
          - max_input: 100000
            route_to: high_capability

        # Override: always use specific model for certain contexts
        overrides:
          - context_contains: &quot;IMPORTANT&quot;
            route_to: high_capability
          - context_contains: &quot;quick question&quot;
            route_to: fast

      # Fallback behavior
      fallback:
        model: balanced
        on_error: retry_with_fallback

      # Logging
      log_routing_decisions: true</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Route to different model
HookResult(
    action=&quot;modify&quot;,
    data={
        **original_data,
        &quot;model&quot;: &quot;claude-3-haiku&quot;,
        &quot;provider_config&quot;: {&quot;model&quot;: &quot;claude-3-haiku-20240307&quot;}
    },
    user_message=&quot;Routed to fast model (simple task)&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ModelRouterHook:
    &quot;&quot;&quot;Route requests to appropriate models.&quot;&quot;&quot;

    def __init__(self, config: ModelRouterConfig):
        self.config = config
        self.models = {name: ModelInfo(**info) for name, info in config.models.items()}
        self.classifier = TaskClassifier(config.routing.tasks)

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        if event != &quot;provider:request&quot;:
            return HookResult(action=&quot;continue&quot;)

        # Determine best model
        selected_model = await self._route_request(data)

        # If no change needed, continue
        if selected_model is None or selected_model == data.get(&quot;model&quot;):
            return HookResult(action=&quot;continue&quot;)

        # Modify request to use selected model
        model_info = self.models[selected_model]
        return HookResult(
            action=&quot;modify&quot;,
            data={
                **data,
                &quot;model&quot;: model_info.model,
                &quot;provider&quot;: model_info.provider,
            },
            user_message=f&quot;Routed to {selected_model} model&quot;
        )

    async def _route_request(self, data: dict) -&gt; str | None:
        &quot;&quot;&quot;Determine which model to use.&quot;&quot;&quot;
        messages = data.get(&quot;messages&quot;, [])

        # Check overrides first
        for override in self.config.routing.overrides:
            if self._matches_override(messages, override):
                return override[&quot;route_to&quot;]

        # Classify task
        last_message = messages[-1].get(&quot;content&quot;, &quot;&quot;) if messages else &quot;&quot;
        task_type = self.classifier.classify(last_message)

        if task_type:
            task_config = self.config.routing.tasks.get(task_type)
            if task_config:
                return task_config[&quot;route_to&quot;]

        # Token-based routing
        estimated_tokens = self._estimate_tokens(messages)
        for rule in self.config.routing.tokens:
            if estimated_tokens &lt;= rule[&quot;max_input&quot;]:
                return rule[&quot;route_to&quot;]

        # Fallback
        return self.config.fallback.model


class TaskClassifier:
    &quot;&quot;&quot;Classify tasks for routing.&quot;&quot;&quot;

    def __init__(self, task_configs: dict):
        self.patterns = {}
        for task_name, config in task_configs.items():
            self.patterns[task_name] = [
                re.compile(p, re.IGNORECASE)
                for p in config[&quot;patterns&quot;]
            ]

    def classify(self, text: str) -&gt; str | None:
        &quot;&quot;&quot;Classify text into task type.&quot;&quot;&quot;
        scores = {}

        for task_name, patterns in self.patterns.items():
            score = sum(1 for p in patterns if p.search(text))
            if score &gt; 0:
                scores[task_name] = score

        if scores:
            return max(scores, key=scores.get)
        return None</code></pre>
        </div>
        <p>---</p>
        <h3>Routing Strategies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Task-Based Routing</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Task Type</th><th>Patterns</th><th>Model</th></tr>
          </thead>
          <tbody>
            <tr><td>Simple Q&A</td><td>"what is", "define", "when"</td><td>Haiku</td></tr>
            <tr><td>Code generation</td><td>"write function", "implement"</td><td>Sonnet</td></tr>
            <tr><td>Complex analysis</td><td>"analyze", "evaluate"</td><td>Opus</td></tr>
            <tr><td>Debugging</td><td>"fix bug", "debug"</td><td>GPT-4</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Token-Based Routing</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Input Size</th><th>Model</th><th>Rationale</th></tr>
          </thead>
          <tbody>
            <tr><td>< 1K tokens</td><td>Haiku</td><td>Simple, short tasks</td></tr>
            <tr><td>1K - 10K</td><td>Sonnet</td><td>Medium complexity</td></tr>
            <tr><td>10K+</td><td>Opus</td><td>Long context needs capability</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Capability-Based Routing</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Route based on required capabilities
CAPABILITY_REQUIREMENTS = {
    &quot;mathematical_reasoning&quot;: [&quot;high_capability&quot;],
    &quot;code_review&quot;: [&quot;balanced&quot;, &quot;code_specialized&quot;],
    &quot;simple_extraction&quot;: [&quot;fast&quot;],
    &quot;creative_writing&quot;: [&quot;high_capability&quot;, &quot;balanced&quot;],
}</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Simple Question â†’ Fast Model</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input message: &quot;What is the capital of France?&quot;
# Classification: simple_questions
# Routing decision: fast (claude-3-haiku)

{
    &quot;action&quot;: &quot;modify&quot;,
    &quot;data&quot;: {
        &quot;model&quot;: &quot;claude-3-haiku-20240307&quot;,
        &quot;provider&quot;: &quot;anthropic&quot;
    },
    &quot;user_message&quot;: &quot;Routed to fast model (simple task)&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Complex Analysis â†’ High Capability</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input message: &quot;Analyze the trade-offs between microservices and monolithic architectures for our e-commerce platform&quot;
# Classification: complex_reasoning
# Routing decision: high_capability (claude-3-opus)

{
    &quot;action&quot;: &quot;modify&quot;,
    &quot;data&quot;: {
        &quot;model&quot;: &quot;claude-3-opus-20240229&quot;,
        &quot;provider&quot;: &quot;anthropic&quot;
    },
    &quot;user_message&quot;: &quot;Routed to high-capability model (complex analysis)&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Override Takes Priority</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input message: &quot;IMPORTANT: Quick question - what time is it in Tokyo?&quot;
# Override matched: &quot;IMPORTANT&quot; â†’ high_capability
# Despite being a simple question, override wins

{
    &quot;action&quot;: &quot;modify&quot;,
    &quot;data&quot;: {
        &quot;model&quot;: &quot;claude-3-opus-20240229&quot;
    },
    &quot;user_message&quot;: &quot;Routed to high-capability model (override: IMPORTANT)&quot;
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>models.*</code></td><td>dict</td><td>{}</td><td>Available models</td></tr>
            <tr><td><code>routing.tasks</code></td><td>dict</td><td>{}</td><td>Task-based routing rules</td></tr>
            <tr><td><code>routing.tokens</code></td><td>list</td><td>[]</td><td>Token-based routing rules</td></tr>
            <tr><td><code>routing.overrides</code></td><td>list</td><td>[]</td><td>Override rules</td></tr>
            <tr><td><code>fallback.model</code></td><td>string</td><td>-</td><td>Default model</td></tr>
            <tr><td><code>log_routing_decisions</code></td><td>bool</td><td>true</td><td>Log decisions</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Cost Impact</h3>
        <p>Typical cost savings with intelligent routing:</p>
        <table class="ref-table">
          <thead>
            <tr><th>Scenario</th><th>Without Routing</th><th>With Routing</th><th>Savings</th></tr>
          </thead>
          <tbody>
            <tr><td>50% simple tasks</td><td>$100</td><td>$35</td><td>65%</td></tr>
            <tr><td>30% code tasks</td><td>$100</td><td>$55</td><td>45%</td></tr>
            <tr><td>Mixed workload</td><td>$100</td><td>$45</td><td>55%</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Routing decisions may affect output quality</li>
        <li>Override rules should be carefully configured</li>
        <li>Sensitive tasks should not be routed to less capable models</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>re</code> - Pattern matching (stdlib)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>None</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Learning</strong>: Should routing learn from outcomes?</li>
        <li><strong>User override</strong>: Allow users to force specific models?</li>
        <li><strong>Quality monitoring</strong>: Track quality per routing decision?</li>
        <li><strong>A/B testing</strong>: Compare routing strategies?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-pii-guardian" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Pii Guardian</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-pii-guardian</code></p>
        </div>
        <h3>Overview</h3>
        <p>Detects and redacts personally identifiable information (PII) before it's sent to LLM providers. Protects user privacy and ensures compliance with GDPR, CCPA, and HIPAA regulations.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>PII sent to external LLMs</td><td>PII redacted before transmission</td></tr>
            <tr><td>Compliance violations</td><td>Privacy-by-design</td></tr>
            <tr><td>Data breach risks</td><td>Sensitive data never leaves</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-pii-guardian
    config:
      # Detection categories
      detect:
        names: true                     # Person names
        emails: true                    # Email addresses
        phones: true                    # Phone numbers
        ssn: true                       # Social Security Numbers
        credit_cards: true              # Credit card numbers
        addresses: true                 # Physical addresses
        dates_of_birth: true            # Birth dates
        ip_addresses: true              # IP addresses
        medical: true                   # Medical record numbers, conditions
        financial: true                 # Bank accounts, routing numbers

      # Action on detection
      action: redact                    # redact | block | warn

      # Redaction style
      redaction:
        style: placeholder              # placeholder | hash | mask
        placeholder_format: &quot;[{type}]&quot;  # e.g., &quot;[EMAIL]&quot;, &quot;[SSN]&quot;

      # Exceptions
      allow:
        patterns:
          - &quot;example@example.com&quot;
          - &quot;test@&quot;
        contexts:
          - &quot;test&quot;
          - &quot;example&quot;
          - &quot;sample&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Redact PII before sending to provider
HookResult(
    action=&quot;modify&quot;,
    data={
        &quot;messages&quot;: [
            {
                &quot;role&quot;: &quot;user&quot;,
                &quot;content&quot;: &quot;Process payment for [NAME] at [EMAIL], card ending [CREDIT_CARD_LAST4]&quot;
            }
        ]
    },
    user_message=&quot;Redacted 3 PII items before sending to LLM&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class PIIGuardianHook:
    &quot;&quot;&quot;Detect and redact PII before LLM transmission.&quot;&quot;&quot;

    def __init__(self, config: PIIGuardianConfig):
        self.config = config
        self.detectors = self._initialize_detectors()
        self.redactor = PIIRedactor(config.redaction)

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        # Only process provider requests
        if event != &quot;provider:request&quot;:
            return HookResult(action=&quot;continue&quot;)

        messages = data.get(&quot;messages&quot;, [])
        redacted_messages = []
        total_redactions = 0

        for message in messages:
            content = message.get(&quot;content&quot;, &quot;&quot;)
            if isinstance(content, str):
                redacted_content, count = self._redact_pii(content)
                redacted_messages.append({**message, &quot;content&quot;: redacted_content})
                total_redactions += count
            else:
                redacted_messages.append(message)

        if total_redactions &gt; 0:
            return HookResult(
                action=&quot;modify&quot;,
                data={**data, &quot;messages&quot;: redacted_messages},
                user_message=f&quot;Redacted {total_redactions} PII items&quot;
            )

        return HookResult(action=&quot;continue&quot;)

    def _redact_pii(self, text: str) -&gt; tuple[str, int]:
        &quot;&quot;&quot;Detect and redact PII from text.&quot;&quot;&quot;
        findings = []

        for detector in self.detectors:
            findings.extend(detector.detect(text))

        # Sort by position (reverse) to redact from end to start
        findings.sort(key=lambda f: f.start, reverse=True)

        # Remove duplicates/overlaps
        findings = self._remove_overlaps(findings)

        # Apply redactions
        redacted = text
        for finding in findings:
            redacted = (
                redacted[:finding.start] +
                self.redactor.redact(finding) +
                redacted[finding.end:]
            )

        return redacted, len(findings)


class NameDetector:
    &quot;&quot;&quot;Detect person names using NER or patterns.&quot;&quot;&quot;

    def detect(self, text: str) -&gt; list[PIIFinding]:
        findings = []

        # Use spaCy NER if available
        if self.nlp:
            doc = self.nlp(text)
            for ent in doc.ents:
                if ent.label_ == &quot;PERSON&quot;:
                    findings.append(PIIFinding(
                        type=&quot;name&quot;,
                        value=ent.text,
                        start=ent.start_char,
                        end=ent.end_char,
                        confidence=0.9
                    ))

        return findings


class EmailDetector:
    &quot;&quot;&quot;Detect email addresses.&quot;&quot;&quot;

    PATTERN = re.compile(r&#039;\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b&#039;)

    def detect(self, text: str) -&gt; list[PIIFinding]:
        findings = []
        for match in self.PATTERN.finditer(text):
            findings.append(PIIFinding(
                type=&quot;email&quot;,
                value=match.group(),
                start=match.start(),
                end=match.end(),
                confidence=1.0
            ))
        return findings


class CreditCardDetector:
    &quot;&quot;&quot;Detect credit card numbers.&quot;&quot;&quot;

    PATTERNS = [
        re.compile(r&#039;\b4[0-9]{12}(?:[0-9]{3})?\b&#039;),      # Visa
        re.compile(r&#039;\b5[1-5][0-9]{14}\b&#039;),              # Mastercard
        re.compile(r&#039;\b3[47][0-9]{13}\b&#039;),               # Amex
        re.compile(r&#039;\b6(?:011|5[0-9]{2})[0-9]{12}\b&#039;),  # Discover
    ]

    def detect(self, text: str) -&gt; list[PIIFinding]:
        findings = []
        for pattern in self.PATTERNS:
            for match in pattern.finditer(text):
                # Validate with Luhn algorithm
                if self._luhn_check(match.group()):
                    findings.append(PIIFinding(
                        type=&quot;credit_card&quot;,
                        value=match.group(),
                        start=match.start(),
                        end=match.end(),
                        confidence=1.0
                    ))
        return findings


class PIIRedactor:
    &quot;&quot;&quot;Apply redaction to PII findings.&quot;&quot;&quot;

    def redact(self, finding: PIIFinding) -&gt; str:
        if self.config.style == &quot;placeholder&quot;:
            return self.config.placeholder_format.format(type=finding.type.upper())
        elif self.config.style == &quot;hash&quot;:
            return hashlib.sha256(finding.value.encode()).hexdigest()[:8]
        elif self.config.style == &quot;mask&quot;:
            return &quot;*&quot; * len(finding.value)
        return &quot;[REDACTED]&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>PII Categories</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Category</th><th>Examples</th><th>Pattern Type</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Names</strong></td><td>"John Smith", "MarÃ­a GarcÃ­a"</td><td>NER</td></tr>
            <tr><td><strong>Emails</strong></td><td>"user@domain.com"</td><td>Regex</td></tr>
            <tr><td><strong>Phones</strong></td><td>"+1-555-123-4567", "(555) 123-4567"</td><td>Regex</td></tr>
            <tr><td><strong>SSN</strong></td><td>"123-45-6789"</td><td>Regex + validation</td></tr>
            <tr><td><strong>Credit Cards</strong></td><td>"4111111111111111"</td><td>Regex + Luhn</td></tr>
            <tr><td><strong>Addresses</strong></td><td>"123 Main St, City, ST 12345"</td><td>NER + Regex</td></tr>
            <tr><td><strong>DOB</strong></td><td>"01/15/1990", "January 15, 1990"</td><td>Regex</td></tr>
            <tr><td><strong>IP Addresses</strong></td><td>"192.168.1.1", "2001:db8::1"</td><td>Regex</td></tr>
            <tr><td><strong>Medical</strong></td><td>MRN, diagnoses</td><td>Pattern matching</td></tr>
            <tr><td><strong>Financial</strong></td><td>Bank account, routing numbers</td><td>Regex + validation</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Email and Name Redaction</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input message to LLM:
&quot;Send confirmation to John Smith at john.smith@company.com&quot;

# After redaction:
&quot;Send confirmation to [NAME] at [EMAIL]&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Credit Card Redaction</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input:
&quot;Process payment for card 4111111111111111&quot;

# After redaction:
&quot;Process payment for card [CREDIT_CARD]&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Medical Data Redaction</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Input:
&quot;Patient MRN 12345678 diagnosed with diabetes&quot;

# After redaction:
&quot;Patient [MEDICAL_ID] diagnosed with [MEDICAL_CONDITION]&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>detect.*</code></td><td>bool</td><td>true</td><td>Enable detection category</td></tr>
            <tr><td><code>action</code></td><td>string</td><td>"redact"</td><td>redact, block, or warn</td></tr>
            <tr><td><code>redaction.style</code></td><td>string</td><td>"placeholder"</td><td>How to redact</td></tr>
            <tr><td><code>redaction.placeholder_format</code></td><td>string</td><td>"[{type}]"</td><td>Placeholder template</td></tr>
            <tr><td><code>allow.patterns</code></td><td>list</td><td>[]</td><td>Patterns to skip</td></tr>
            <tr><td><code>allow.contexts</code></td><td>list</td><td>[]</td><td>Contexts that allow PII</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Compliance Mapping</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Regulation</th><th>PII Types</th><th>Hook Coverage</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>GDPR</strong></td><td>Names, emails, addresses, IDs</td><td>Full</td></tr>
            <tr><td><strong>CCPA</strong></td><td>Personal info, identifiers</td><td>Full</td></tr>
            <tr><td><strong>HIPAA</strong></td><td>PHI (medical, SSN, etc.)</td><td>Full</td></tr>
            <tr><td><strong>PCI-DSS</strong></td><td>Card numbers, CVV</td><td>Full</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Redaction happens BEFORE data leaves to LLM</li>
        <li>Original data never logged</li>
        <li>NER models run locally (no external calls)</li>
        <li>False negatives possible - defense in depth recommended</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>re</code> - Regex matching (stdlib)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>spacy</code> - Named entity recognition for names/addresses</li>
        <li><code>presidio</code> - Microsoft's PII detection library</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Accuracy vs performance</strong>: Full NER vs regex-only?</li>
        <li><strong>Reversibility</strong>: Should we support de-redaction for debugging?</li>
        <li><strong>Custom PII types</strong>: Allow project-specific PII definitions?</li>
        <li><strong>Confidence thresholds</strong>: Skip low-confidence detections?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-reviewer-suggester" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Reviewer Suggester</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-reviewer-suggester</code></p>
        </div>
        <h3>Overview</h3>
        <p>Analyzes code changes and suggests optimal reviewers based on code ownership, expertise, availability, and review load balance. Helps ensure PRs get reviewed by the right people quickly.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Guessing who should review</td><td>Data-driven suggestions</td></tr>
            <tr><td>Overloading same reviewers</td><td>Balanced review load</td></tr>
            <tr><td>Missing domain experts</td><td>Expertise matching</td></tr>
            <tr><td>Slow review assignment</td><td>Instant suggestions</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-reviewer-suggester
    config:
      # Data sources
      sources:
        git_blame: true                 # Use git blame for ownership
        codeowners: true                # Use CODEOWNERS file
        review_history: true            # Past review patterns
        org_chart: false                # Optional: org structure

      # Suggestion criteria
      criteria:
        ownership_weight: 0.4           # How much ownership matters
        expertise_weight: 0.3           # Past changes to similar code
        availability_weight: 0.2        # Current review load
        recency_weight: 0.1             # Recent activity in area

      # Constraints
      constraints:
        min_reviewers: 1
        max_reviewers: 3
        avoid_author: true              # Don&#039;t suggest PR author
        require_codeowner: true         # At least one CODEOWNER
        max_pending_reviews: 5          # Skip overloaded reviewers

      # Integration
      integration:
        platform: github                # github | gitlab | azure-devops
        auto_assign: false              # Auto-assign or just suggest
        notify: true                    # Notify suggested reviewers

      # Trigger
      trigger_on:
        - pr_created
        - pr_updated
        - files_changed</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Suggest reviewers
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;&quot;&quot;
**Suggested Reviewers for This Change**

Based on code ownership and expertise:

1. **@alice** (Score: 0.92)
   - Primary owner of `src/payments/` (CODEOWNERS)
   - 45 commits to payment module in past 6 months
   - Current review load: 2 pending PRs

2. **@bob** (Score: 0.78)
   - Frequent contributor to `src/api/`
   - Reviewed similar changes 12 times
   - Current review load: 3 pending PRs

3. **@carol** (Score: 0.65)
   - Secondary owner of `src/payments/gateway.py`
   - Domain expertise: payment gateways
   - Current review load: 1 pending PR

**Recommendation**: Assign @alice (required: CODEOWNER) + @bob (expertise)
&quot;&quot;&quot;,
    user_message=&quot;Suggested reviewers: @alice, @bob, @carol&quot;,
    user_message_level=&quot;info&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ReviewerSuggesterHook:
    &quot;&quot;&quot;Suggest optimal code reviewers.&quot;&quot;&quot;

    def __init__(self, config: ReviewerSuggesterConfig):
        self.config = config
        self.ownership_analyzer = OwnershipAnalyzer(config)
        self.load_balancer = ReviewLoadBalancer(config)
        self.scorer = ReviewerScorer(config.criteria)

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        # Trigger on relevant events
        if not self._should_trigger(event, data):
            return HookResult(action=&quot;continue&quot;)

        # Get changed files
        changed_files = await self._get_changed_files(data)
        if not changed_files:
            return HookResult(action=&quot;continue&quot;)

        # Find candidate reviewers
        candidates = await self._find_candidates(changed_files, data)

        # Score and rank candidates
        scored = await self._score_candidates(candidates, changed_files)

        # Apply constraints
        suggestions = self._apply_constraints(scored, data)

        # Generate suggestion
        return self._generate_suggestion(suggestions, changed_files)

    async def _find_candidates(
        self,
        changed_files: list[str],
        data: dict
    ) -&gt; list[ReviewerCandidate]:
        &quot;&quot;&quot;Find potential reviewers from multiple sources.&quot;&quot;&quot;
        candidates = {}

        # CODEOWNERS
        if self.config.sources.codeowners:
            codeowner_reviewers = await self.ownership_analyzer.from_codeowners(
                changed_files
            )
            for reviewer in codeowner_reviewers:
                candidates[reviewer.id] = reviewer
                candidates[reviewer.id].is_codeowner = True

        # Git blame
        if self.config.sources.git_blame:
            blame_reviewers = await self.ownership_analyzer.from_git_blame(
                changed_files
            )
            for reviewer in blame_reviewers:
                if reviewer.id in candidates:
                    candidates[reviewer.id].ownership_score += reviewer.ownership_score
                else:
                    candidates[reviewer.id] = reviewer

        # Review history
        if self.config.sources.review_history:
            history_reviewers = await self.ownership_analyzer.from_review_history(
                changed_files
            )
            for reviewer in history_reviewers:
                if reviewer.id in candidates:
                    candidates[reviewer.id].expertise_score = reviewer.expertise_score
                else:
                    candidates[reviewer.id] = reviewer

        return list(candidates.values())

    async def _score_candidates(
        self,
        candidates: list[ReviewerCandidate],
        changed_files: list[str]
    ) -&gt; list[ScoredReviewer]:
        &quot;&quot;&quot;Score candidates based on criteria.&quot;&quot;&quot;
        scored = []

        for candidate in candidates:
            # Get current review load
            pending_reviews = await self.load_balancer.get_pending_count(
                candidate.id
            )

            # Calculate availability score (inverse of load)
            max_load = self.config.constraints.max_pending_reviews
            availability = 1.0 - (pending_reviews / max_load) if pending_reviews &lt; max_load else 0

            # Calculate final score
            score = self.scorer.calculate(
                ownership=candidate.ownership_score,
                expertise=candidate.expertise_score,
                availability=availability,
                recency=candidate.recency_score
            )

            scored.append(ScoredReviewer(
                candidate=candidate,
                score=score,
                pending_reviews=pending_reviews,
                breakdown={
                    &quot;ownership&quot;: candidate.ownership_score,
                    &quot;expertise&quot;: candidate.expertise_score,
                    &quot;availability&quot;: availability,
                    &quot;recency&quot;: candidate.recency_score
                }
            ))

        # Sort by score descending
        return sorted(scored, key=lambda x: x.score, reverse=True)

    def _apply_constraints(
        self,
        scored: list[ScoredReviewer],
        data: dict
    ) -&gt; list[ScoredReviewer]:
        &quot;&quot;&quot;Apply constraints to suggestions.&quot;&quot;&quot;
        filtered = []
        author = data.get(&quot;author&quot;)

        for reviewer in scored:
            # Skip author
            if self.config.constraints.avoid_author and reviewer.candidate.id == author:
                continue

            # Skip overloaded reviewers
            if reviewer.pending_reviews &gt;= self.config.constraints.max_pending_reviews:
                continue

            filtered.append(reviewer)

        # Ensure we have required CODEOWNER
        if self.config.constraints.require_codeowner:
            has_codeowner = any(r.candidate.is_codeowner for r in filtered)
            if not has_codeowner:
                # Find first codeowner regardless of constraints
                for reviewer in scored:
                    if reviewer.candidate.is_codeowner and reviewer.candidate.id != author:
                        filtered.insert(0, reviewer)
                        break

        # Limit to max reviewers
        return filtered[:self.config.constraints.max_reviewers]


class OwnershipAnalyzer:
    &quot;&quot;&quot;Analyze code ownership from multiple sources.&quot;&quot;&quot;

    async def from_codeowners(self, files: list[str]) -&gt; list[ReviewerCandidate]:
        &quot;&quot;&quot;Get owners from CODEOWNERS file.&quot;&quot;&quot;
        codeowners_path = self._find_codeowners()
        if not codeowners_path:
            return []

        rules = self._parse_codeowners(codeowners_path)
        owners = set()

        for file in files:
            for pattern, file_owners in rules:
                if self._matches_pattern(file, pattern):
                    owners.update(file_owners)

        return [
            ReviewerCandidate(id=owner, ownership_score=1.0, is_codeowner=True)
            for owner in owners
        ]

    async def from_git_blame(self, files: list[str]) -&gt; list[ReviewerCandidate]:
        &quot;&quot;&quot;Analyze git blame for ownership.&quot;&quot;&quot;
        author_lines = defaultdict(int)
        total_lines = 0

        for file in files:
            blame = await self._run_git_blame(file)
            for line in blame:
                author_lines[line.author] += 1
                total_lines += 1

        return [
            ReviewerCandidate(
                id=author,
                ownership_score=lines / total_lines if total_lines &gt; 0 else 0
            )
            for author, lines in author_lines.items()
        ]

    async def from_review_history(self, files: list[str]) -&gt; list[ReviewerCandidate]:
        &quot;&quot;&quot;Find reviewers who have reviewed similar files.&quot;&quot;&quot;
        # Query past reviews touching these files
        past_reviews = await self._query_review_history(files)

        reviewer_counts = defaultdict(int)
        for review in past_reviews:
            reviewer_counts[review.reviewer] += 1

        max_reviews = max(reviewer_counts.values()) if reviewer_counts else 1
        return [
            ReviewerCandidate(
                id=reviewer,
                expertise_score=count / max_reviews
            )
            for reviewer, count in reviewer_counts.items()
        ]


class ReviewerScorer:
    &quot;&quot;&quot;Calculate weighted reviewer scores.&quot;&quot;&quot;

    def __init__(self, criteria: dict):
        self.ownership_weight = criteria.get(&quot;ownership_weight&quot;, 0.4)
        self.expertise_weight = criteria.get(&quot;expertise_weight&quot;, 0.3)
        self.availability_weight = criteria.get(&quot;availability_weight&quot;, 0.2)
        self.recency_weight = criteria.get(&quot;recency_weight&quot;, 0.1)

    def calculate(
        self,
        ownership: float,
        expertise: float,
        availability: float,
        recency: float
    ) -&gt; float:
        &quot;&quot;&quot;Calculate weighted score.&quot;&quot;&quot;
        return (
            ownership * self.ownership_weight +
            expertise * self.expertise_weight +
            availability * self.availability_weight +
            recency * self.recency_weight
        )</code></pre>
        </div>
        <p>---</p>
        <h3>Data Sources</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">CODEOWNERS Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Parse CODEOWNERS file
# .github/CODEOWNERS or CODEOWNERS

# Example CODEOWNERS:
# * @default-team
# /src/payments/ @alice @bob
# /src/api/ @api-team
# *.py @python-experts

def _parse_codeowners(path: str) -&gt; list[tuple[str, list[str]]]:
    &quot;&quot;&quot;Parse CODEOWNERS file into rules.&quot;&quot;&quot;
    rules = []
    with open(path) as f:
        for line in f:
            line = line.strip()
            if not line or line.startswith(&quot;#&quot;):
                continue
            parts = line.split()
            pattern = parts[0]
            owners = [p.lstrip(&quot;@&quot;) for p in parts[1:]]
            rules.append((pattern, owners))
    return rules</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Git Blame Analysis</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def _run_git_blame(file: str) -&gt; list[BlameLine]:
    &quot;&quot;&quot;Run git blame and parse output.&quot;&quot;&quot;
    proc = await asyncio.create_subprocess_exec(
        &quot;git&quot;, &quot;blame&quot;, &quot;--line-porcelain&quot;, file,
        stdout=asyncio.subprocess.PIPE
    )
    stdout, _ = await proc.communicate()

    # Parse porcelain format
    lines = []
    current = {}
    for line in stdout.decode().split(&quot;\n&quot;):
        if line.startswith(&quot;author &quot;):
            current[&quot;author&quot;] = line[7:]
        elif line.startswith(&quot;author-mail &quot;):
            current[&quot;email&quot;] = line[12:].strip(&quot;&lt;&gt;&quot;)
        elif line.startswith(&quot;\t&quot;):
            # Content line - commit current
            if current:
                lines.append(BlameLine(**current))
                current = {}
    return lines</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Review History Query</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def _query_review_history(files: list[str]) -&gt; list[PastReview]:
    &quot;&quot;&quot;Query GitHub/GitLab for past reviews.&quot;&quot;&quot;
    # GitHub GraphQL query
    query = &quot;&quot;&quot;
    query($files: [String!]!) {
        repository(owner: $owner, name: $repo) {
            pullRequests(first: 100, states: MERGED) {
                nodes {
                    files(first: 100) {
                        nodes { path }
                    }
                    reviews(first: 10) {
                        nodes {
                            author { login }
                            state
                        }
                    }
                }
            }
        }
    }
    &quot;&quot;&quot;
    # Filter for PRs touching these files
    # Return reviewers who approved</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: New PR Created</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># PR created touching src/payments/gateway.py and src/api/routes.py

# Hook analyzes:
# - CODEOWNERS: @alice owns /src/payments/, @api-team owns /src/api/
# - Git blame: @bob has 60% of lines in gateway.py, @carol has 30%
# - Review history: @alice reviewed 15 PRs in payments, @dave reviewed 8

# Scoring:
# @alice: ownership=1.0, expertise=0.9, availability=0.8, recency=0.7 â†’ 0.91
# @bob: ownership=0.6, expertise=0.5, availability=1.0, recency=0.9 â†’ 0.71
# @api-team/member: ownership=0.5, expertise=0.3, availability=0.6 â†’ 0.44

# Result:
&quot;&quot;&quot;
Suggested Reviewers:
1. @alice (CODEOWNER) - Primary owner, high expertise
2. @bob - Significant contributor to gateway.py
&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Load Balancing in Action</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Normally @alice would be top suggestion, but she has 5 pending reviews

# Hook adjusts:
# @alice: availability=0.0 (at max load)
# Final score drops significantly

# Result suggests @bob instead:
&quot;&quot;&quot;
Suggested Reviewers:
1. @bob - Top available expert (Score: 0.78)
   Note: @alice (CODEOWNER) currently overloaded (5 pending reviews)
2. @carol - Secondary expert (Score: 0.65)
&quot;&quot;&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>sources.*</code></td><td>bool</td><td>true</td><td>Data sources to use</td></tr>
            <tr><td><code>criteria.*_weight</code></td><td>float</td><td>varies</td><td>Scoring weights</td></tr>
            <tr><td><code>constraints.min_reviewers</code></td><td>int</td><td>1</td><td>Minimum suggestions</td></tr>
            <tr><td><code>constraints.max_reviewers</code></td><td>int</td><td>3</td><td>Maximum suggestions</td></tr>
            <tr><td><code>constraints.max_pending_reviews</code></td><td>int</td><td>5</td><td>Load threshold</td></tr>
            <tr><td><code>integration.auto_assign</code></td><td>bool</td><td>false</td><td>Auto-assign reviewers</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Requires read access to git history</li>
        <li>May need API tokens for review history</li>
        <li>Respects repository visibility settings</li>
        <li>No sensitive code content exposed</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>gitpython</code> - Git operations</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>PyGithub</code> - GitHub API</li>
        <li><code>python-gitlab</code> - GitLab API</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Team rotation</strong>: Should we enforce reviewer rotation for knowledge sharing?</li>
        <li><strong>Expertise decay</strong>: Should expertise scores decay over time?</li>
        <li><strong>Cross-team reviews</strong>: Encourage reviews from outside the immediate team?</li>
        <li><strong>Learning mode</strong>: Track suggestion accuracy and improve?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-secret-detector" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Secret Detector</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-secret-detector</code></p>
        </div>
        <h3>Overview</h3>
        <p>Specialized hook focused exclusively on secret detection. Lightweight, fast, and critical for preventing credential leaks. Runs on every file write with minimal overhead.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Secrets accidentally committed</td><td>Hard block before write</td></tr>
            <tr><td>Security scanning is slow</td><td>Optimized for speed, runs on every write</td></tr>
            <tr><td>Generic scanners miss secrets</td><td>Purpose-built for credential detection</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Key Difference from hooks-security-scan</h4>
        <li><strong>hooks-secret-detector</strong>: Fast, focused, always-on for secret detection</li>
        <li><strong>hooks-security-scan</strong>: Comprehensive but heavier SAST + secrets + dependencies</li>
        <p>Use both together: secret-detector as first line of defense, security-scan for deeper analysis.</p>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-secret-detector
    config:
      # Always block secrets (no severity threshold)
      action: deny                      # deny | warn

      # Built-in pattern categories
      detect:
        aws: true
        gcp: true
        azure: true
        github: true
        openai: true
        stripe: true
        slack: true
        database: true
        private_keys: true
        generic_secrets: true

      # Custom patterns
      custom_patterns:
        - pattern: &quot;COMPANY_API_[A-Z0-9]{32}&quot;
          name: &quot;Company Internal API Key&quot;

      # Exclusions
      exclude:
        files:
          - &quot;**/*.test.*&quot;
          - &quot;**/fixtures/**&quot;
          - &quot;**/mocks/**&quot;
        patterns:
          - &quot;test_api_key&quot;
          - &quot;example_&quot;
          - &quot;dummy_&quot;
          - &quot;fake_&quot;

      # Allow specific files to contain secrets (use with extreme caution)
      allowed_files:
        - &quot;.env.example&quot;                # Only example values</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Always deny on secret detection
HookResult(
    action=&quot;deny&quot;,
    reason=&quot;&quot;&quot;
ðŸš¨ SECRET DETECTED - File write blocked

**AWS Secret Access Key** found at line 15:</code></pre>
        </div>
        <p>aws_secret_access_key = "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">**How to fix:**
1. Remove the secret from your code
2. Use environment variables:
   ```python
   import os
   aws_secret = os.environ.get(&#039;AWS_SECRET_ACCESS_KEY&#039;)
   ```
3. If this was intentional test data, prefix with &#039;test_&#039; or &#039;example_&#039;

This secret pattern is commonly exploited within minutes of exposure.
&quot;&quot;&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SecretDetectorHook:
    &quot;&quot;&quot;Lightweight, fast secret detection hook.&quot;&quot;&quot;

    # Pre-compiled patterns for speed
    PATTERNS = {
        &quot;aws_access_key&quot;: re.compile(r&#039;AKIA[0-9A-Z]{16}&#039;),
        &quot;aws_secret_key&quot;: re.compile(r&#039;(?i)aws_secret_access_key\s*[=:]\s*[&quot;\&#039;]?([A-Za-z0-9/+=]{40})[&quot;\&#039;]?&#039;),
        &quot;github_token&quot;: re.compile(r&#039;ghp_[a-zA-Z0-9]{36}&#039;),
        &quot;github_oauth&quot;: re.compile(r&#039;gho_[a-zA-Z0-9]{36}&#039;),
        &quot;openai_key&quot;: re.compile(r&#039;sk-[a-zA-Z0-9]{48}&#039;),
        &quot;stripe_live&quot;: re.compile(r&#039;sk_live_[a-zA-Z0-9]{24,}&#039;),
        &quot;stripe_test&quot;: re.compile(r&#039;sk_test_[a-zA-Z0-9]{24,}&#039;),  # Still warn
        &quot;slack_token&quot;: re.compile(r&#039;xox[baprs]-[0-9a-zA-Z]{10,}&#039;),
        &quot;private_key&quot;: re.compile(r&#039;-----BEGIN\s+(?:RSA\s+|EC\s+|DSA\s+)?PRIVATE\s+KEY-----&#039;),
        &quot;generic_api_key&quot;: re.compile(r&#039;(?i)api[_-]?key\s*[=:]\s*[&quot;\&#039;]([a-zA-Z0-9]{20,})[&quot;\&#039;]&#039;),
        &quot;generic_secret&quot;: re.compile(r&#039;(?i)(?:secret|password|passwd|pwd)\s*[=:]\s*[&quot;\&#039;]([^&quot;\&#039;]{8,})[&quot;\&#039;]&#039;),
    }

    def __init__(self, config: SecretDetectorConfig):
        self.config = config
        self.patterns = self._build_patterns()
        self.exclusion_patterns = [re.compile(p) for p in config.exclude.patterns]

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        # Only process file writes
        if event != &quot;tool:pre&quot; or not self._is_file_write(data):
            return HookResult(action=&quot;continue&quot;)

        file_path = data.get(&quot;file_path&quot;, &quot;&quot;)
        content = data.get(&quot;content&quot;, &quot;&quot;)

        # Check if file is excluded
        if self._is_excluded_file(file_path):
            return HookResult(action=&quot;continue&quot;)

        # Scan for secrets
        secrets = self._detect_secrets(content, file_path)

        if not secrets:
            return HookResult(action=&quot;continue&quot;)

        # Block the write
        return HookResult(
            action=&quot;deny&quot;,
            reason=self._format_denial(secrets, file_path)
        )

    def _detect_secrets(self, content: str, file_path: str) -&gt; list[DetectedSecret]:
        secrets = []
        lines = content.split(&#039;\n&#039;)

        for line_num, line in enumerate(lines, 1):
            for pattern_name, pattern in self.patterns.items():
                match = pattern.search(line)
                if match:
                    # Check if excluded by pattern
                    if self._is_excluded_value(match.group()):
                        continue

                    secrets.append(DetectedSecret(
                        type=pattern_name,
                        line_number=line_num,
                        line_content=line.strip(),
                        match=match.group()
                    ))

        return secrets

    def _is_excluded_value(self, value: str) -&gt; bool:
        &quot;&quot;&quot;Check if the matched value is in exclusion list.&quot;&quot;&quot;
        for pattern in self.exclusion_patterns:
            if pattern.search(value):
                return True
        return False

    def _format_denial(self, secrets: list[DetectedSecret], file_path: str) -&gt; str:
        &quot;&quot;&quot;Format denial message with actionable guidance.&quot;&quot;&quot;
        lines = [&quot;ðŸš¨ SECRET DETECTED - File write blocked\n&quot;]

        for secret in secrets:
            lines.append(f&quot;**{self._friendly_name(secret.type)}** at line {secret.line_number}:&quot;)
            # Mask most of the secret
            masked = self._mask_secret(secret.match)
            lines.append(f&quot;```\n{masked}\n```\n&quot;)

        lines.append(&quot;**How to fix:**&quot;)
        lines.append(&quot;1. Remove the secret from your code&quot;)
        lines.append(&quot;2. Use environment variables instead&quot;)
        lines.append(&quot;3. If this is test data, prefix with &#039;test_&#039; or &#039;example_&#039;&quot;)

        return &quot;\n&quot;.join(lines)

    def _mask_secret(self, secret: str) -&gt; str:
        &quot;&quot;&quot;Mask secret for display, showing only first/last few chars.&quot;&quot;&quot;
        if len(secret) &lt;= 8:
            return &quot;*&quot; * len(secret)
        return secret[:4] + &quot;*&quot; * (len(secret) - 8) + secret[-4:]</code></pre>
        </div>
        <p>---</p>
        <h3>Secret Pattern Coverage</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Category</th><th>Patterns</th><th>Examples</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>AWS</strong></td><td>Access Key ID, Secret Key, Session Token</td><td><code>AKIA...</code>, <code>aws_secret_access_key=...</code></td></tr>
            <tr><td><strong>GCP</strong></td><td>Service Account Key, API Key</td><td><code>AIza...</code>, JSON key files</td></tr>
            <tr><td><strong>Azure</strong></td><td>Storage Key, Connection String</td><td><code>DefaultEndpointsProtocol=...</code></td></tr>
            <tr><td><strong>GitHub</strong></td><td>PAT, OAuth, App Token</td><td><code>ghp_...</code>, <code>gho_...</code>, <code>ghs_...</code></td></tr>
            <tr><td><strong>OpenAI</strong></td><td>API Key</td><td><code>sk-...</code></td></tr>
            <tr><td><strong>Stripe</strong></td><td>Live/Test Keys</td><td><code>sk_live_...</code>, <code>rk_live_...</code></td></tr>
            <tr><td><strong>Slack</strong></td><td>Bot, User, App Tokens</td><td><code>xoxb-...</code>, <code>xoxp-...</code></td></tr>
            <tr><td><strong>Database</strong></td><td>Connection Strings</td><td><code>postgres://user:pass@...</code></td></tr>
            <tr><td><strong>Private Keys</strong></td><td>RSA, EC, DSA</td><td><code>-----BEGIN PRIVATE KEY-----</code></td></tr>
            <tr><td><strong>Generic</strong></td><td>API keys, passwords, secrets</td><td><code>api_key=...</code>, <code>password=...</code></td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: AWS Key Detection</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Attempting to write:
# src/config.py containing:
# AWS_ACCESS_KEY = &quot;AKIAIOSFODNN7EXAMPLE&quot;

# Hook returns:
{
    &quot;action&quot;: &quot;deny&quot;,
    &quot;reason&quot;: &quot;&quot;&quot;
ðŸš¨ SECRET DETECTED - File write blocked

**AWS Access Key ID** at line 1:</code></pre>
        </div>
        <p>AKIA************MPLE</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">**How to fix:**
1. Remove the secret from your code
2. Use environment variables instead:
   ```python
   import os
   AWS_ACCESS_KEY = os.environ.get(&#039;AWS_ACCESS_KEY_ID&#039;)
   ```
3. If this is test data, use AWS&#039;s documented example keys

AWS credentials are actively scanned on GitHub and can be exploited within minutes.
&quot;&quot;&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Test Data Exclusion</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Attempting to write:
# tests/fixtures/config.py containing:
# test_api_key = &quot;test_sk_1234567890&quot;

# Hook returns:
{
    &quot;action&quot;: &quot;continue&quot;
}

# Allowed because:
# 1. File is in tests/fixtures/ (excluded path)
# 2. Value starts with &quot;test_&quot; (excluded pattern)</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>action</code></td><td>string</td><td>"deny"</td><td>deny or warn</td></tr>
            <tr><td><code>detect.*</code></td><td>bool</td><td>true</td><td>Enable specific pattern categories</td></tr>
            <tr><td><code>custom_patterns</code></td><td>list</td><td>[]</td><td>Additional patterns to detect</td></tr>
            <tr><td><code>exclude.files</code></td><td>list</td><td>[]</td><td>Glob patterns for files to skip</td></tr>
            <tr><td><code>exclude.patterns</code></td><td>list</td><td>[]</td><td>Value patterns to ignore</td></tr>
            <tr><td><code>allowed_files</code></td><td>list</td><td>[]</td><td>Files that may contain secrets</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Patterns must be kept updated as providers change formats</li>
        <li>False positives should be handled via exclusions, not disabled detection</li>
        <li>Masked output prevents exposure in logs</li>
        <li><code>allowed_files</code> should be used very sparingly</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>re</code> - Regex matching (stdlib)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>None (intentionally minimal)</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Pattern updates</strong>: How to distribute pattern updates?</li>
        <li><strong>Entropy analysis</strong>: Add entropy-based detection for unknown patterns?</li>
        <li><strong>Git integration</strong>: Also scan git history for past leaks?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-security-scan" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Security Scan</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-security-scan</code></p>
        </div>
        <h3>Overview</h3>
        <p>Real-time security scanning of code as it's written. Detects vulnerabilities, secrets, and security anti-patterns before they're committed. Can block dangerous operations or inject warnings for the agent to address.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Security issues found in PR review</td><td>Caught immediately as code is written</td></tr>
            <tr><td>Secrets committed accidentally</td><td>Blocked before file write</td></tr>
            <tr><td>Security debt accumulates</td><td>Issues fixed in the same session</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Trigger Events</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Action</th><th>Purpose</th></tr>
          </thead>
          <tbody>
            <tr><td><code>tool:pre</code> (file write)</td><td>Scan content before write</td><td>Block if critical vulnerability</td></tr>
            <tr><td><code>tool:post</code> (file write)</td><td>Scan and report</td><td>Inject feedback for agent to fix</td></tr>
            <tr><td><code>session:start</code></td><td>Scan existing codebase</td><td>Baseline security context</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-security-scan
    config:
      # Scan modes
      mode: block                       # block | warn | report
      severity_threshold: high          # Block/warn at this level and above

      # Scanners to enable
      scanners:
        secrets: true                   # API keys, passwords, tokens
        sast: true                      # Static analysis (SQL injection, XSS, etc.)
        dependencies: true              # Known vulnerable dependencies
        patterns: true                  # Custom anti-patterns

      # Secret detection
      secrets:
        patterns:
          - &quot;aws_access_key_id&quot;
          - &quot;api[_-]?key&quot;
          - &quot;password\\s*=\\s*[\&quot;&#039;][^\&quot;&#039;]+[\&quot;&#039;]&quot;
          - &quot;-----BEGIN.*PRIVATE KEY-----&quot;
        allow_patterns:
          - &quot;test_api_key&quot;
          - &quot;example_password&quot;

      # SAST rules
      sast:
        rules:
          - sql_injection
          - xss
          - path_traversal
          - command_injection
          - insecure_deserialization

      # Actions
      actions:
        critical:
          action: deny
          message: &quot;Critical security vulnerability detected&quot;
        high:
          action: inject_context
          message: &quot;Security issue found - please fix&quot;
        medium:
          action: inject_context
          suppress_output: true
        low:
          action: continue</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult Actions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Block dangerous writes
HookResult(
    action=&quot;deny&quot;,
    reason=&quot;AWS credentials detected in file. Remove before saving.&quot;
)

# Inject feedback for agent to fix
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;&quot;&quot;
Security scan found issues in your code:

1. **SQL Injection (HIGH)** at line 42:
   ```python
   query = f&quot;SELECT * FROM users WHERE id = {user_id}&quot;
   ```
   Fix: Use parameterized queries

2. **Hardcoded secret (CRITICAL)** at line 15:
   ```python
   API_KEY = &quot;sk_live_...&quot;
   ```
   Fix: Use environment variable

Please fix these issues before proceeding.
&quot;&quot;&quot;,
    user_message=&quot;Found 2 security issues&quot;,
    user_message_level=&quot;warning&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Scanner Components</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SecurityScanHook:
    &quot;&quot;&quot;Real-time security scanning hook.&quot;&quot;&quot;

    def __init__(self, config: SecurityScanConfig):
        self.config = config
        self.scanners = []

        if config.scanners.secrets:
            self.scanners.append(SecretScanner(config.secrets))
        if config.scanners.sast:
            self.scanners.append(SASTScanner(config.sast))
        if config.scanners.dependencies:
            self.scanners.append(DependencyScanner())
        if config.scanners.patterns:
            self.scanners.append(PatternScanner(config.patterns))

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        if event == &quot;tool:pre&quot; and self._is_file_write(data):
            return await self._scan_before_write(data)

        if event == &quot;tool:post&quot; and self._is_file_write(data):
            return await self._scan_after_write(data)

        return HookResult(action=&quot;continue&quot;)

    async def _scan_before_write(self, data: dict) -&gt; HookResult:
        content = data.get(&quot;content&quot;, &quot;&quot;)
        file_path = data.get(&quot;file_path&quot;, &quot;&quot;)

        findings = await self._scan(content, file_path)

        # Block critical issues
        critical = [f for f in findings if f.severity == &quot;critical&quot;]
        if critical and self.config.mode == &quot;block&quot;:
            return HookResult(
                action=&quot;deny&quot;,
                reason=self._format_critical_findings(critical)
            )

        return HookResult(action=&quot;continue&quot;)

    async def _scan_after_write(self, data: dict) -&gt; HookResult:
        content = data.get(&quot;content&quot;, &quot;&quot;)
        file_path = data.get(&quot;file_path&quot;, &quot;&quot;)

        findings = await self._scan(content, file_path)

        if not findings:
            return HookResult(action=&quot;continue&quot;)

        # Filter by threshold
        reportable = [f for f in findings
                     if self._severity_meets_threshold(f.severity)]

        if not reportable:
            return HookResult(action=&quot;continue&quot;)

        return HookResult(
            action=&quot;inject_context&quot;,
            context_injection=self._format_findings(reportable),
            user_message=f&quot;Security scan: {len(reportable)} issue(s) found&quot;,
            user_message_level=&quot;warning&quot; if any(f.severity in (&quot;high&quot;, &quot;critical&quot;) for f in reportable) else &quot;info&quot;
        )

    async def _scan(self, content: str, file_path: str) -&gt; list[Finding]:
        findings = []
        for scanner in self.scanners:
            scanner_findings = await scanner.scan(content, file_path)
            findings.extend(scanner_findings)
        return findings</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Secret Scanner</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SecretScanner:
    &quot;&quot;&quot;Detect secrets and credentials in code.&quot;&quot;&quot;

    DEFAULT_PATTERNS = [
        # AWS
        (r&#039;AKIA[0-9A-Z]{16}&#039;, &#039;AWS Access Key ID&#039;),
        (r&#039;aws_secret_access_key\s*=\s*[&quot;\&#039;][^&quot;\&#039;]+[&quot;\&#039;]&#039;, &#039;AWS Secret Key&#039;),

        # Generic
        (r&#039;api[_-]?key\s*[=:]\s*[&quot;\&#039;][^&quot;\&#039;]{10,}[&quot;\&#039;]&#039;, &#039;API Key&#039;),
        (r&#039;password\s*[=:]\s*[&quot;\&#039;][^&quot;\&#039;]+[&quot;\&#039;]&#039;, &#039;Hardcoded Password&#039;),
        (r&#039;secret\s*[=:]\s*[&quot;\&#039;][^&quot;\&#039;]{10,}[&quot;\&#039;]&#039;, &#039;Hardcoded Secret&#039;),

        # Private keys
        (r&#039;-----BEGIN\s+(?:RSA\s+)?PRIVATE\s+KEY-----&#039;, &#039;Private Key&#039;),

        # Tokens
        (r&#039;ghp_[a-zA-Z0-9]{36}&#039;, &#039;GitHub Personal Access Token&#039;),
        (r&#039;sk-[a-zA-Z0-9]{48}&#039;, &#039;OpenAI API Key&#039;),
        (r&#039;xox[baprs]-[0-9a-zA-Z]{10,}&#039;, &#039;Slack Token&#039;),
    ]

    async def scan(self, content: str, file_path: str) -&gt; list[Finding]:
        findings = []

        for pattern, name in self.patterns:
            matches = re.finditer(pattern, content, re.IGNORECASE)
            for match in matches:
                # Skip if in allow list
                if self._is_allowed(match.group(), file_path):
                    continue

                line_num = content[:match.start()].count(&#039;\n&#039;) + 1
                findings.append(Finding(
                    type=&quot;secret&quot;,
                    severity=&quot;critical&quot;,
                    title=f&quot;{name} detected&quot;,
                    location=f&quot;{file_path}:{line_num}&quot;,
                    code_snippet=self._get_snippet(content, match),
                    recommendation=&quot;Remove secret and use environment variables&quot;
                ))

        return findings</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">SAST Scanner</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SASTScanner:
    &quot;&quot;&quot;Static Application Security Testing.&quot;&quot;&quot;

    RULES = {
        &quot;sql_injection&quot;: {
            &quot;patterns&quot;: [
                r&#039;execute\s*\(\s*[&quot;\&#039;].*%s&#039;,
                r&#039;execute\s*\(\s*f[&quot;\&#039;]&#039;,
                r&#039;cursor\.execute\s*\(\s*[&quot;\&#039;].*\+&#039;,
            ],
            &quot;severity&quot;: &quot;high&quot;,
            &quot;message&quot;: &quot;Potential SQL injection&quot;,
            &quot;fix&quot;: &quot;Use parameterized queries&quot;
        },
        &quot;xss&quot;: {
            &quot;patterns&quot;: [
                r&#039;innerHTML\s*=\s*[^&quot;\&#039;`]&#039;,
                r&#039;document\.write\s*\(&#039;,
                r&#039;dangerouslySetInnerHTML&#039;,
            ],
            &quot;severity&quot;: &quot;high&quot;,
            &quot;message&quot;: &quot;Potential XSS vulnerability&quot;,
            &quot;fix&quot;: &quot;Sanitize user input before rendering&quot;
        },
        &quot;command_injection&quot;: {
            &quot;patterns&quot;: [
                r&#039;os\.system\s*\(&#039;,
                r&#039;subprocess\.\w+\s*\([^)]*shell\s*=\s*True&#039;,
                r&#039;eval\s*\(&#039;,
                r&#039;exec\s*\(&#039;,
            ],
            &quot;severity&quot;: &quot;critical&quot;,
            &quot;message&quot;: &quot;Potential command injection&quot;,
            &quot;fix&quot;: &quot;Avoid shell=True, sanitize inputs, use subprocess with list args&quot;
        },
        &quot;path_traversal&quot;: {
            &quot;patterns&quot;: [
                r&#039;open\s*\([^)]*\+&#039;,
                r&#039;Path\s*\([^)]*\+&#039;,
            ],
            &quot;severity&quot;: &quot;high&quot;,
            &quot;message&quot;: &quot;Potential path traversal&quot;,
            &quot;fix&quot;: &quot;Validate and sanitize file paths&quot;
        }
    }

    async def scan(self, content: str, file_path: str) -&gt; list[Finding]:
        findings = []

        # Determine applicable rules based on file type
        applicable_rules = self._get_applicable_rules(file_path)

        for rule_name, rule in applicable_rules.items():
            for pattern in rule[&quot;patterns&quot;]:
                matches = re.finditer(pattern, content)
                for match in matches:
                    line_num = content[:match.start()].count(&#039;\n&#039;) + 1
                    findings.append(Finding(
                        type=&quot;sast&quot;,
                        severity=rule[&quot;severity&quot;],
                        title=rule[&quot;message&quot;],
                        location=f&quot;{file_path}:{line_num}&quot;,
                        code_snippet=self._get_snippet(content, match),
                        recommendation=rule[&quot;fix&quot;]
                    ))

        return findings</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Block Secret Commit</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Event: tool:pre (Write file)
# Data: {&quot;file_path&quot;: &quot;src/config.py&quot;, &quot;content&quot;: &quot;API_KEY = &#039;sk_live_...&#039;&quot;}

# Hook returns:
{
    &quot;action&quot;: &quot;deny&quot;,
    &quot;reason&quot;: &quot;&quot;&quot;
Cannot write file: Critical security issue detected.

**OpenAI API Key detected** at line 1:</code></pre>
        </div>
        <p>API_KEY = 'sk_live_...'</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Remove the secret and use an environment variable instead:</code></pre>
        </div>
        <p>import os</p>
        <p>API_KEY = os.environ.get('OPENAI_API_KEY')</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">&quot;&quot;&quot;
}

# Result: File write is blocked, agent sees denial reason</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Inject Fix Suggestions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Event: tool:post (Write file completed)
# Data: {&quot;file_path&quot;: &quot;src/db.py&quot;, &quot;content&quot;: &quot;...SQL with string formatting...&quot;}

# Hook returns:
{
    &quot;action&quot;: &quot;inject_context&quot;,
    &quot;context_injection&quot;: &quot;&quot;&quot;
Security scan found issues in src/db.py:

**SQL Injection (HIGH)** at line 42:</code></pre>
        </div>
        <p>cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">**Fix**: Use parameterized queries:</code></pre>
        </div>
        <p>cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Please fix this issue.
&quot;&quot;&quot;,
    &quot;user_message&quot;: &quot;Security: 1 high severity issue in src/db.py&quot;,
    &quot;user_message_level&quot;: &quot;warning&quot;
}

# Result: Agent sees feedback, fixes the code in next turn</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>mode</code></td><td>string</td><td>"warn"</td><td>block, warn, or report only</td></tr>
            <tr><td><code>severity_threshold</code></td><td>string</td><td>"medium"</td><td>Minimum severity to act on</td></tr>
            <tr><td><code>scanners.secrets</code></td><td>bool</td><td>true</td><td>Enable secret detection</td></tr>
            <tr><td><code>scanners.sast</code></td><td>bool</td><td>true</td><td>Enable SAST scanning</td></tr>
            <tr><td><code>scanners.dependencies</code></td><td>bool</td><td>false</td><td>Enable dependency scanning</td></tr>
            <tr><td><code>secrets.patterns</code></td><td>list</td><td>(defaults)</td><td>Additional regex patterns</td></tr>
            <tr><td><code>secrets.allow_patterns</code></td><td>list</td><td>[]</td><td>Patterns to ignore (e.g., test data)</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Scans may reveal sensitive patterns (handled carefully)</li>
        <li>Allow patterns should be restricted to test/example data</li>
        <li>SAST rules have false positive potential - tune per project</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>re</code> - Regex matching (stdlib)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>semgrep</code> - Advanced SAST rules</li>
        <li><code>bandit</code> - Python-specific security scanning</li>
        <li><code>safety</code> - Dependency vulnerability scanning</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>SAST depth</strong>: Include tree-sitter parsing for more accurate analysis?</li>
        <li><strong>Custom rules</strong>: Allow project-specific security rules?</li>
        <li><strong>Remediation automation</strong>: Auto-fix simple issues?</li>
        <li><strong>Integration</strong>: Connect to enterprise security tools?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-standup-logger" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Standup Logger</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Nice to Have)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-standup-logger</code></p>
        </div>
        <h3>Overview</h3>
        <p>Automatically captures work activity from AI sessions and generates concise standup summaries. Enables async standups by providing clear, structured updates of what was accomplished, in progress, and blocked.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual standup note-taking</td><td>Auto-generated summaries</td></tr>
            <tr><td>Forgetting what you worked on</td><td>Complete activity capture</td></tr>
            <tr><td>Inconsistent update formats</td><td>Structured, readable updates</td></tr>
            <tr><td>Time spent writing updates</td><td>Focus on actual work</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-standup-logger
    config:
      # What to capture
      capture:
        file_changes: true              # Files created/modified
        tool_usage: true                # Tools invoked and results
        decisions: true                 # Key decisions made
        blockers: true                  # Issues encountered
        completions: true               # Tasks completed

      # Summarization
      summary:
        format: structured              # structured | narrative | bullet
        max_length: 500                 # Max chars per summary
        include_metrics: true           # Include time/token stats
        group_by: task                  # task | time | file

      # Storage
      storage:
        type: file                      # file | notion | slack | jira
        path: &quot;~/.amplifier/standups/&quot;
        daily_rollup: true              # Combine sessions into daily log

      # Integration
      integration:
        auto_post: false                # Auto-post to channel
        slack_channel: &quot;#team-standups&quot;
        schedule: &quot;09:00&quot;               # When to post daily rollup

      # Privacy
      privacy:
        exclude_patterns:               # Don&#039;t mention these files
          - &quot;*.env&quot;
          - &quot;*secret*&quot;
        anonymize_paths: false          # Hash sensitive paths</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># At session end, generate summary
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;&quot;,  # No injection needed
    user_message=&quot;&quot;&quot;
ðŸ“‹ Session Summary (45 min)

**Completed:**
- Fixed payment timeout bug in gateway.py
- Added retry logic with exponential backoff
- Updated tests (3 new test cases)

**In Progress:**
- Refactoring error handling in api/routes.py

**Files Changed:** 4 files, +127/-34 lines

Logged to: ~/.amplifier/standups/2024-01-15.md
&quot;&quot;&quot;,
    user_message_level=&quot;info&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class StandupLoggerHook:
    &quot;&quot;&quot;Capture and summarize work for standups.&quot;&quot;&quot;

    CAPTURED_EVENTS = [
        &quot;session:start&quot;,
        &quot;session:end&quot;,
        &quot;tool:post&quot;,
        &quot;prompt:submit&quot;,
        &quot;prompt:complete&quot;,
    ]

    def __init__(self, config: StandupLoggerConfig):
        self.config = config
        self.storage = StandupStorage(config.storage)
        self.summarizer = WorkSummarizer(config.summary)

        # Session activity tracking
        self.current_session: SessionActivity | None = None

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        if event == &quot;session:start&quot;:
            self._start_tracking(data)
            return HookResult(action=&quot;continue&quot;)

        if event == &quot;session:end&quot;:
            return await self._finalize_session(data)

        if event in self.CAPTURED_EVENTS:
            self._track_activity(event, data)

        return HookResult(action=&quot;continue&quot;)

    def _start_tracking(self, data: dict) -&gt; None:
        &quot;&quot;&quot;Initialize session tracking.&quot;&quot;&quot;
        self.current_session = SessionActivity(
            session_id=data.get(&quot;session_id&quot;),
            start_time=datetime.utcnow(),
            activities=[],
            files_changed=set(),
            tools_used={},
            decisions=[],
            blockers=[]
        )

    def _track_activity(self, event: str, data: dict) -&gt; None:
        &quot;&quot;&quot;Track activity during session.&quot;&quot;&quot;
        if not self.current_session:
            return

        if event == &quot;tool:post&quot;:
            self._track_tool_usage(data)
        elif event == &quot;prompt:submit&quot;:
            self._extract_intent(data)
        elif event == &quot;prompt:complete&quot;:
            self._extract_outcomes(data)

    def _track_tool_usage(self, data: dict) -&gt; None:
        &quot;&quot;&quot;Track tool invocations.&quot;&quot;&quot;
        tool = data.get(&quot;tool&quot;, &quot;&quot;)

        # Track file changes
        if tool in (&quot;filesystem:write&quot;, &quot;filesystem:edit&quot;):
            file_path = data.get(&quot;file_path&quot;, &quot;&quot;)
            if not self._should_exclude(file_path):
                self.current_session.files_changed.add(file_path)
                self.current_session.activities.append(Activity(
                    type=&quot;file_change&quot;,
                    description=f&quot;Modified {Path(file_path).name}&quot;,
                    timestamp=datetime.utcnow(),
                    metadata={&quot;path&quot;: file_path, &quot;operation&quot;: &quot;write&quot;}
                ))

        # Track tool usage counts
        tool_name = tool.split(&quot;:&quot;)[0] if &quot;:&quot; in tool else tool
        self.current_session.tools_used[tool_name] = (
            self.current_session.tools_used.get(tool_name, 0) + 1
        )

    def _extract_intent(self, data: dict) -&gt; None:
        &quot;&quot;&quot;Extract user intent from prompts.&quot;&quot;&quot;
        prompt = data.get(&quot;prompt&quot;, &quot;&quot;)

        # Look for task markers
        if any(marker in prompt.lower() for marker in [&quot;fix&quot;, &quot;bug&quot;, &quot;error&quot;]):
            self.current_session.activities.append(Activity(
                type=&quot;task_start&quot;,
                description=f&quot;Working on: {self._summarize_prompt(prompt)}&quot;,
                timestamp=datetime.utcnow()
            ))

    def _extract_outcomes(self, data: dict) -&gt; None:
        &quot;&quot;&quot;Extract outcomes from responses.&quot;&quot;&quot;
        response = data.get(&quot;response&quot;, &quot;&quot;)

        # Look for completion indicators
        completion_patterns = [
            r&quot;(fixed|resolved|completed|done|finished)&quot;,
            r&quot;(implemented|added|created|updated)&quot;,
        ]

        for pattern in completion_patterns:
            if re.search(pattern, response.lower()):
                self.current_session.activities.append(Activity(
                    type=&quot;completion&quot;,
                    description=self._extract_completion(response),
                    timestamp=datetime.utcnow()
                ))
                break

        # Look for blockers
        blocker_patterns = [
            r&quot;(blocked|can&#039;t|unable to|need access|waiting for)&quot;,
            r&quot;(error|failed|issue|problem)&quot;,
        ]

        for pattern in blocker_patterns:
            if re.search(pattern, response.lower()):
                self.current_session.blockers.append(
                    self._extract_blocker(response)
                )
                break

    async def _finalize_session(self, data: dict) -&gt; HookResult:
        &quot;&quot;&quot;Generate and store session summary.&quot;&quot;&quot;
        if not self.current_session:
            return HookResult(action=&quot;continue&quot;)

        self.current_session.end_time = datetime.utcnow()
        self.current_session.duration = (
            self.current_session.end_time - self.current_session.start_time
        )

        # Generate summary
        summary = await self.summarizer.summarize(self.current_session)

        # Store summary
        await self.storage.store(summary)

        # Reset tracking
        session = self.current_session
        self.current_session = None

        return HookResult(
            action=&quot;continue&quot;,
            user_message=self._format_user_message(summary),
            user_message_level=&quot;info&quot;
        )

    def _format_user_message(self, summary: SessionSummary) -&gt; str:
        &quot;&quot;&quot;Format summary for user display.&quot;&quot;&quot;
        duration = summary.duration.total_seconds() / 60

        msg = [f&quot;ðŸ“‹ Session Summary ({duration:.0f} min)&quot;, &quot;&quot;]

        if summary.completed:
            msg.append(&quot;**Completed:**&quot;)
            for item in summary.completed[:5]:
                msg.append(f&quot;- {item}&quot;)
            msg.append(&quot;&quot;)

        if summary.in_progress:
            msg.append(&quot;**In Progress:**&quot;)
            for item in summary.in_progress[:3]:
                msg.append(f&quot;- {item}&quot;)
            msg.append(&quot;&quot;)

        if summary.blockers:
            msg.append(&quot;**Blockers:**&quot;)
            for item in summary.blockers[:3]:
                msg.append(f&quot;- âš ï¸ {item}&quot;)
            msg.append(&quot;&quot;)

        if summary.files_changed:
            msg.append(f&quot;**Files Changed:** {len(summary.files_changed)} files&quot;)

        return &quot;\n&quot;.join(msg)


class WorkSummarizer:
    &quot;&quot;&quot;Summarize session activity into standup format.&quot;&quot;&quot;

    async def summarize(self, session: SessionActivity) -&gt; SessionSummary:
        &quot;&quot;&quot;Generate structured summary from activities.&quot;&quot;&quot;

        # Group activities by type
        completions = [a for a in session.activities if a.type == &quot;completion&quot;]
        in_progress = [a for a in session.activities if a.type == &quot;task_start&quot;]

        # Deduplicate and clean
        completed_items = list(set(c.description for c in completions))
        in_progress_items = list(set(
            p.description for p in in_progress
            if p.description not in completed_items
        ))

        return SessionSummary(
            session_id=session.session_id,
            date=session.start_time.date(),
            duration=session.duration,
            completed=completed_items,
            in_progress=in_progress_items,
            blockers=session.blockers,
            files_changed=list(session.files_changed),
            tools_used=session.tools_used,
            metrics=SessionMetrics(
                duration_minutes=session.duration.total_seconds() / 60,
                files_changed=len(session.files_changed),
                tool_calls=sum(session.tools_used.values())
            )
        )


class StandupStorage:
    &quot;&quot;&quot;Store standup summaries.&quot;&quot;&quot;

    async def store(self, summary: SessionSummary) -&gt; None:
        &quot;&quot;&quot;Store summary to configured backend.&quot;&quot;&quot;
        if self.config.type == &quot;file&quot;:
            await self._store_file(summary)
        elif self.config.type == &quot;notion&quot;:
            await self._store_notion(summary)
        elif self.config.type == &quot;slack&quot;:
            await self._post_slack(summary)

    async def _store_file(self, summary: SessionSummary) -&gt; None:
        &quot;&quot;&quot;Store as markdown file.&quot;&quot;&quot;
        date_str = summary.date.isoformat()
        path = Path(self.config.path).expanduser() / f&quot;{date_str}.md&quot;

        # Append to daily file
        content = self._format_markdown(summary)

        async with aiofiles.open(path, &quot;a&quot;) as f:
            await f.write(content + &quot;\n\n---\n\n&quot;)

    def _format_markdown(self, summary: SessionSummary) -&gt; str:
        &quot;&quot;&quot;Format summary as markdown.&quot;&quot;&quot;
        lines = [
            f&quot;## Session: {summary.session_id[:8]}&quot;,
            f&quot;**Time:** {summary.duration.total_seconds() / 60:.0f} minutes&quot;,
            &quot;&quot;,
        ]

        if summary.completed:
            lines.append(&quot;### Completed&quot;)
            for item in summary.completed:
                lines.append(f&quot;- {item}&quot;)
            lines.append(&quot;&quot;)

        if summary.in_progress:
            lines.append(&quot;### In Progress&quot;)
            for item in summary.in_progress:
                lines.append(f&quot;- {item}&quot;)
            lines.append(&quot;&quot;)

        if summary.blockers:
            lines.append(&quot;### Blockers&quot;)
            for item in summary.blockers:
                lines.append(f&quot;- âš ï¸ {item}&quot;)
            lines.append(&quot;&quot;)

        if summary.files_changed:
            lines.append(&quot;### Files Changed&quot;)
            for f in summary.files_changed[:10]:
                lines.append(f&quot;- `{f}`&quot;)

        return &quot;\n&quot;.join(lines)

    async def get_daily_rollup(self, date: date) -&gt; list[SessionSummary]:
        &quot;&quot;&quot;Get all summaries for a date.&quot;&quot;&quot;
        path = Path(self.config.path).expanduser() / f&quot;{date.isoformat()}.md&quot;
        if not path.exists():
            return []
        # Parse and return summaries
        ...</code></pre>
        </div>
        <p>---</p>
        <h3>Summary Formats</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Structured Format (Default)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown">## Session: abc123
**Time:** 45 minutes

### Completed
- Fixed payment timeout bug in gateway.py
- Added retry logic with exponential backoff
- Updated tests (3 new test cases)

### In Progress
- Refactoring error handling

### Files Changed
- `src/payments/gateway.py`
- `src/payments/retry.py`
- `tests/test_gateway.py`</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Narrative Format</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown">## Session Summary

Spent 45 minutes working on the payment timeout bug. Fixed the issue
by adding exponential backoff retry logic to the gateway. Added 3 new
test cases to cover the retry scenarios. Started refactoring the error
handling in the API routes but didn&#039;t complete it.

Changed 3 files in the payments module.</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Bullet Format</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown">- [45 min] Payment timeout bug
  - âœ… Fixed gateway.py timeout
  - âœ… Added retry logic
  - âœ… Added tests
  - ðŸ”„ Error handling refactor (in progress)</code></pre>
        </div>
        <p>---</p>
        <h3>Daily Rollup</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class DailyRollupGenerator:
    &quot;&quot;&quot;Generate daily standup from session summaries.&quot;&quot;&quot;

    async def generate(self, date: date) -&gt; DailyRollup:
        &quot;&quot;&quot;Combine session summaries into daily rollup.&quot;&quot;&quot;
        summaries = await self.storage.get_daily_rollup(date)

        all_completed = []
        all_in_progress = []
        all_blockers = []
        all_files = set()
        total_duration = timedelta()

        for summary in summaries:
            all_completed.extend(summary.completed)
            all_in_progress.extend(summary.in_progress)
            all_blockers.extend(summary.blockers)
            all_files.update(summary.files_changed)
            total_duration += summary.duration

        # Remove duplicates, prioritize completions
        in_progress_final = [
            item for item in set(all_in_progress)
            if item not in all_completed
        ]

        return DailyRollup(
            date=date,
            sessions=len(summaries),
            total_duration=total_duration,
            completed=list(set(all_completed)),
            in_progress=in_progress_final,
            blockers=list(set(all_blockers)),
            files_changed=list(all_files)
        )</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Bug Fix Session</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Session activities:
# 1. User: &quot;Fix the payment timeout bug&quot;
# 2. Read files, found issue
# 3. Modified gateway.py
# 4. Added retry logic
# 5. Ran tests, fixed failures
# 6. Session end

# Generated summary:
&quot;&quot;&quot;
ðŸ“‹ Session Summary (32 min)

**Completed:**
- Fixed payment timeout bug in gateway.py
- Implemented exponential backoff retry
- Added 3 test cases for retry scenarios

**Files Changed:** 3 files
- src/payments/gateway.py
- src/payments/retry.py
- tests/test_gateway.py

Logged to: ~/.amplifier/standups/2024-01-15.md
&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Session with Blockers</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Session had issues:

# Generated summary:
&quot;&quot;&quot;
ðŸ“‹ Session Summary (25 min)

**In Progress:**
- Updating database schema for user profiles

**Blockers:**
- âš ï¸ Need DBA approval for migration
- âš ï¸ Missing access to production database

**Files Changed:** 1 file
- migrations/0042_user_profile.py

Logged to: ~/.amplifier/standups/2024-01-15.md
&quot;&quot;&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>capture.*</code></td><td>bool</td><td>true</td><td>What to capture</td></tr>
            <tr><td><code>summary.format</code></td><td>string</td><td>"structured"</td><td>Summary format</td></tr>
            <tr><td><code>summary.max_length</code></td><td>int</td><td>500</td><td>Max summary length</td></tr>
            <tr><td><code>storage.type</code></td><td>string</td><td>"file"</td><td>Storage backend</td></tr>
            <tr><td><code>storage.daily_rollup</code></td><td>bool</td><td>true</td><td>Combine into daily</td></tr>
            <tr><td><code>integration.auto_post</code></td><td>bool</td><td>false</td><td>Auto-post to Slack</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Excludes sensitive file patterns by default</li>
        <li>Can anonymize paths if needed</li>
        <li>No code content stored, only summaries</li>
        <li>Local storage by default</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>aiofiles</code> - File operations</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>slack_sdk</code> - Slack integration</li>
        <li><code>notion-client</code> - Notion integration</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>AI summarization</strong>: Use LLM to generate better summaries?</li>
        <li><strong>Team aggregation</strong>: Combine team standups into digest?</li>
        <li><strong>Metrics tracking</strong>: Track productivity trends over time?</li>
        <li><strong>Smart grouping</strong>: Better task grouping algorithms?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-style-enforcer" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Style Enforcer</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-style-enforcer</code></p>
        </div>
        <h3>Overview</h3>
        <p>Automatically runs linters and formatters on code as it's written, injecting feedback for the agent to fix issues immediately. Ensures all generated code meets team style standards without manual intervention.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Linting issues found in CI</td><td>Fixed during generation</td></tr>
            <tr><td>Style debates in PR reviews</td><td>Automated enforcement</td></tr>
            <tr><td>Inconsistent code style</td><td>Consistent from creation</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-style-enforcer
    config:
      # Linters by language
      linters:
        python:
          enabled: true
          tools:
            - name: ruff
              command: &quot;ruff check --fix {file}&quot;
              auto_fix: true
            - name: black
              command: &quot;black --check {file}&quot;
              auto_fix_command: &quot;black {file}&quot;
            - name: mypy
              command: &quot;mypy {file}&quot;
              auto_fix: false

        typescript:
          enabled: true
          tools:
            - name: eslint
              command: &quot;eslint {file}&quot;
              auto_fix_command: &quot;eslint --fix {file}&quot;
            - name: prettier
              command: &quot;prettier --check {file}&quot;
              auto_fix_command: &quot;prettier --write {file}&quot;

        go:
          enabled: true
          tools:
            - name: gofmt
              command: &quot;gofmt -l {file}&quot;
              auto_fix_command: &quot;gofmt -w {file}&quot;
            - name: golint
              command: &quot;golint {file}&quot;

      # Behavior
      behavior:
        run_on: post                    # pre | post (after file write)
        auto_fix: true                  # Auto-apply fixes when possible
        inject_feedback: true           # Tell agent about remaining issues
        fail_on_error: false            # Don&#039;t block writes on lint errors

      # Feedback settings
      feedback:
        max_issues: 10                  # Limit issues in feedback
        include_suggestions: true       # Include fix suggestions
        severity_threshold: warning     # error | warning | info</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult Actions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># After auto-fixing, inject remaining issues
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;&quot;&quot;
Style check results for src/payments/gateway.py:

**Auto-fixed:**
- Formatted with black
- Fixed 3 ruff issues (unused imports, line length)

**Remaining issues (please fix):**
1. Line 42: mypy error: Argument 1 to &quot;process&quot; has incompatible type &quot;str&quot;; expected &quot;int&quot;
2. Line 67: mypy error: Missing return statement

Please address the type errors above.
&quot;&quot;&quot;,
    user_message=&quot;Style: auto-fixed 4 issues, 2 type errors need attention&quot;,
    user_message_level=&quot;warning&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class StyleEnforcerHook:
    &quot;&quot;&quot;Enforce code style with linters and formatters.&quot;&quot;&quot;

    def __init__(self, config: StyleEnforcerConfig):
        self.config = config
        self.linters = self._initialize_linters()

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        # Only process file writes
        if event != &quot;tool:post&quot; or not self._is_code_write(data):
            return HookResult(action=&quot;continue&quot;)

        file_path = data.get(&quot;file_path&quot;, &quot;&quot;)
        language = self._detect_language(file_path)

        if not language or language not in self.config.linters:
            return HookResult(action=&quot;continue&quot;)

        # Run linters
        results = await self._run_linters(file_path, language)

        # Auto-fix if configured
        auto_fixed = []
        if self.config.behavior.auto_fix:
            auto_fixed = await self._apply_auto_fixes(file_path, language)

        # Collect remaining issues
        remaining = [r for r in results if not r.auto_fixed]

        # Filter by severity
        remaining = self._filter_by_severity(remaining)

        # Generate feedback
        if auto_fixed or remaining:
            return self._generate_feedback(file_path, auto_fixed, remaining)

        return HookResult(action=&quot;continue&quot;)

    async def _run_linters(self, file_path: str, language: str) -&gt; list[LintResult]:
        &quot;&quot;&quot;Run all configured linters for language.&quot;&quot;&quot;
        results = []
        linter_config = self.config.linters[language]

        for tool in linter_config.tools:
            command = tool.command.format(file=file_path)
            try:
                proc = await asyncio.create_subprocess_shell(
                    command,
                    stdout=asyncio.subprocess.PIPE,
                    stderr=asyncio.subprocess.PIPE
                )
                stdout, stderr = await proc.communicate()

                if proc.returncode != 0:
                    issues = self._parse_output(tool.name, stdout.decode(), stderr.decode())
                    results.extend(issues)
            except Exception as e:
                # Log but don&#039;t fail on linter errors
                pass

        return results

    async def _apply_auto_fixes(self, file_path: str, language: str) -&gt; list[str]:
        &quot;&quot;&quot;Apply auto-fixes from formatters.&quot;&quot;&quot;
        fixed = []
        linter_config = self.config.linters[language]

        for tool in linter_config.tools:
            if tool.auto_fix and tool.auto_fix_command:
                command = tool.auto_fix_command.format(file=file_path)
                try:
                    proc = await asyncio.create_subprocess_shell(command)
                    await proc.wait()
                    if proc.returncode == 0:
                        fixed.append(tool.name)
                except Exception:
                    pass

        return fixed

    def _generate_feedback(
        self,
        file_path: str,
        auto_fixed: list[str],
        remaining: list[LintResult]
    ) -&gt; HookResult:
        &quot;&quot;&quot;Generate feedback for agent.&quot;&quot;&quot;
        lines = [f&quot;Style check results for {file_path}:&quot;, &quot;&quot;]

        if auto_fixed:
            lines.append(&quot;**Auto-fixed:**&quot;)
            for tool in auto_fixed:
                lines.append(f&quot;- Applied {tool}&quot;)
            lines.append(&quot;&quot;)

        if remaining:
            lines.append(f&quot;**Remaining issues ({len(remaining)}):**&quot;)
            for i, issue in enumerate(remaining[:self.config.feedback.max_issues], 1):
                lines.append(f&quot;{i}. Line {issue.line}: {issue.tool}: {issue.message}&quot;)
                if self.config.feedback.include_suggestions and issue.suggestion:
                    lines.append(f&quot;   Suggestion: {issue.suggestion}&quot;)
            lines.append(&quot;&quot;)
            lines.append(&quot;Please fix these issues.&quot;)

        severity = &quot;warning&quot; if any(r.severity == &quot;error&quot; for r in remaining) else &quot;info&quot;

        return HookResult(
            action=&quot;inject_context&quot;,
            context_injection=&quot;\n&quot;.join(lines),
            user_message=f&quot;Style: {len(auto_fixed)} auto-fixed, {len(remaining)} need attention&quot;,
            user_message_level=severity
        )

    def _parse_output(self, tool: str, stdout: str, stderr: str) -&gt; list[LintResult]:
        &quot;&quot;&quot;Parse linter output into structured results.&quot;&quot;&quot;
        # Each linter has different output format
        parsers = {
            &quot;ruff&quot;: self._parse_ruff,
            &quot;black&quot;: self._parse_black,
            &quot;mypy&quot;: self._parse_mypy,
            &quot;eslint&quot;: self._parse_eslint,
            &quot;prettier&quot;: self._parse_prettier,
        }

        parser = parsers.get(tool, self._parse_generic)
        return parser(stdout, stderr)

    def _parse_ruff(self, stdout: str, stderr: str) -&gt; list[LintResult]:
        &quot;&quot;&quot;Parse ruff output.&quot;&quot;&quot;
        results = []
        for line in stdout.split(&quot;\n&quot;):
            # Format: file.py:10:5: E501 Line too long
            match = re.match(r&quot;.*:(\d+):\d+: (\w+) (.+)&quot;, line)
            if match:
                results.append(LintResult(
                    tool=&quot;ruff&quot;,
                    line=int(match.group(1)),
                    code=match.group(2),
                    message=match.group(3),
                    severity=&quot;warning&quot;,
                    auto_fixable=match.group(2) not in [&quot;E999&quot;]  # Syntax errors not auto-fixable
                ))
        return results</code></pre>
        </div>
        <p>---</p>
        <h3>Supported Linters</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Language</th><th>Tool</th><th>Auto-fix</th><th>Purpose</th></tr>
          </thead>
          <tbody>
            <tr><td>Python</td><td>ruff</td><td>Yes</td><td>Fast linter (replaces flake8, isort)</td></tr>
            <tr><td>Python</td><td>black</td><td>Yes</td><td>Code formatter</td></tr>
            <tr><td>Python</td><td>mypy</td><td>No</td><td>Type checker</td></tr>
            <tr><td>TypeScript</td><td>eslint</td><td>Yes</td><td>Linter</td></tr>
            <tr><td>TypeScript</td><td>prettier</td><td>Yes</td><td>Formatter</td></tr>
            <tr><td>Go</td><td>gofmt</td><td>Yes</td><td>Formatter</td></tr>
            <tr><td>Go</td><td>golint</td><td>No</td><td>Linter</td></tr>
            <tr><td>Rust</td><td>rustfmt</td><td>Yes</td><td>Formatter</td></tr>
            <tr><td>Rust</td><td>clippy</td><td>Partial</td><td>Linter</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Python Auto-Fix + Type Errors</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Agent writes file with style issues and type errors
# Hook runs ruff, black, mypy

# After auto-fix:
&quot;&quot;&quot;
Style check results for src/calculator.py:

**Auto-fixed:**
- Applied black (formatting)
- Applied ruff (removed unused import, fixed line length)

**Remaining issues (2):**
1. Line 15: mypy: Argument &quot;x&quot; to &quot;add&quot; has incompatible type &quot;str&quot;; expected &quot;int&quot;
2. Line 23: mypy: Missing return type annotation for function &quot;calculate&quot;

Please fix these type errors.
&quot;&quot;&quot;

# Agent addresses type errors in next turn</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: All Issues Auto-Fixed</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Only formatting issues, all auto-fixable

{
    &quot;action&quot;: &quot;inject_context&quot;,
    &quot;context_injection&quot;: &quot;&quot;&quot;
Style check results for src/utils.py:

**Auto-fixed:**
- Applied prettier (formatting)
- Applied eslint (3 issues fixed)

All issues resolved automatically.
&quot;&quot;&quot;,
    &quot;user_message&quot;: &quot;Style: auto-fixed 4 issues&quot;,
    &quot;user_message_level&quot;: &quot;info&quot;
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>linters.<lang>.enabled</code></td><td>bool</td><td>true</td><td>Enable for language</td></tr>
            <tr><td><code>linters.<lang>.tools</code></td><td>list</td><td>[]</td><td>Tools to run</td></tr>
            <tr><td><code>behavior.run_on</code></td><td>string</td><td>"post"</td><td>When to run</td></tr>
            <tr><td><code>behavior.auto_fix</code></td><td>bool</td><td>true</td><td>Auto-apply fixes</td></tr>
            <tr><td><code>behavior.inject_feedback</code></td><td>bool</td><td>true</td><td>Inject remaining issues</td></tr>
            <tr><td><code>feedback.max_issues</code></td><td>int</td><td>10</td><td>Max issues to show</td></tr>
            <tr><td><code>feedback.severity_threshold</code></td><td>string</td><td>"warning"</td><td>Min severity</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Linters execute on written files (code execution risk minimal)</li>
        <li>Auto-fix modifies files (intended behavior)</li>
        <li>Tool commands should be hardcoded, not user-configurable</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li>Language-specific linters installed in environment</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>None (linters are external tools)</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Linter conflicts</strong>: What if black and ruff disagree?</li>
        <li><strong>Performance</strong>: Skip linting for large files?</li>
        <li><strong>Custom rules</strong>: Support project-specific lint configs?</li>
        <li><strong>Pre vs post</strong>: Should we lint before write to prevent bad code?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-ticket-linker" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Ticket Linker</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-ticket-linker</code></p>
        </div>
        <h3>Overview</h3>
        <p>Automatically loads JIRA/GitHub issue context based on the current git branch. Injects ticket information into the agent's context at session start, ensuring work is always connected to its tracking ticket.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manually look up ticket for context</td><td>Automatic context from branch name</td></tr>
            <tr><td>Forget to link work to tickets</td><td>Always-on ticket awareness</td></tr>
            <tr><td>Context switching to find requirements</td><td>Requirements injected at session start</td></tr>
            <tr><td>"What was I working on?"</td><td>Full ticket context on resume</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-ticket-linker
    config:
      # Ticket systems
      jira:
        enabled: true
        base_url: &quot;${JIRA_URL}&quot;
        auth_token: &quot;${JIRA_TOKEN}&quot;
        project_keys: [&quot;PROJ&quot;, &quot;PLATFORM&quot;, &quot;SEC&quot;]

      github:
        enabled: true
        auth_token: &quot;${GITHUB_TOKEN}&quot;

      # Branch patterns to extract ticket
      branch_patterns:
        - &quot;^(?P&lt;key&gt;[A-Z]+-\\d+)&quot;           # PROJ-123-description
        - &quot;^feature/(?P&lt;key&gt;[A-Z]+-\\d+)&quot;   # feature/PROJ-123-description
        - &quot;^fix/(?P&lt;key&gt;[A-Z]+-\\d+)&quot;       # fix/PROJ-123-description
        - &quot;^(?P&lt;key&gt;\\d+)-&quot;                 # 123-description (GitHub issue)

      # What to include in context
      include:
        summary: true
        description: true
        acceptance_criteria: true
        comments: false                     # Can be verbose
        linked_issues: true
        status: true
        assignee: true

      # Context injection
      context:
        role: system                        # system | user
        max_length: 2000                    # Truncate if too long</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># At session:start, inject ticket context
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;&quot;&quot;
## Current Work Context

**Ticket**: PROJ-456 - Add retry logic to payment gateway
**Status**: In Progress
**Assignee**: alice

### Description
Implement exponential backoff retry for payment API calls to handle gateway timeouts during peak load.

### Acceptance Criteria
- [ ] Retry up to 3 times with exponential backoff
- [ ] Log each retry attempt
- [ ] Add circuit breaker for repeated failures
- [ ] Update metrics dashboard

### Related Issues
- PROJ-400: Payment gateway timeout errors (parent)
- PROJ-455: Add payment metrics dashboard
&quot;&quot;&quot;,
    context_injection_role=&quot;system&quot;,
    suppress_output=True,
    user_message=&quot;Loaded context for PROJ-456&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class TicketLinkerHook:
    &quot;&quot;&quot;Auto-load ticket context at session start.&quot;&quot;&quot;

    def __init__(self, config: TicketLinkerConfig):
        self.config = config
        self.jira = JiraClient(config.jira) if config.jira.enabled else None
        self.github = GitHubClient(config.github) if config.github.enabled else None
        self.patterns = [re.compile(p) for p in config.branch_patterns]

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        if event != &quot;session:start&quot;:
            return HookResult(action=&quot;continue&quot;)

        # Get current branch
        branch = await self._get_current_branch()
        if not branch:
            return HookResult(action=&quot;continue&quot;)

        # Extract ticket key from branch name
        ticket_key = self._extract_ticket_key(branch)
        if not ticket_key:
            return HookResult(action=&quot;continue&quot;)

        # Fetch ticket details
        ticket = await self._fetch_ticket(ticket_key)
        if not ticket:
            return HookResult(
                action=&quot;continue&quot;,
                user_message=f&quot;Could not load ticket {ticket_key}&quot;
            )

        # Format context
        context = self._format_context(ticket)

        return HookResult(
            action=&quot;inject_context&quot;,
            context_injection=context,
            context_injection_role=self.config.context.role,
            suppress_output=True,
            user_message=f&quot;Loaded context for {ticket_key}: {ticket.summary[:50]}...&quot;
        )

    def _extract_ticket_key(self, branch: str) -&gt; str | None:
        &quot;&quot;&quot;Extract ticket key from branch name using patterns.&quot;&quot;&quot;
        for pattern in self.patterns:
            match = pattern.search(branch)
            if match:
                return match.group(&quot;key&quot;)
        return None

    async def _fetch_ticket(self, key: str) -&gt; Ticket | None:
        &quot;&quot;&quot;Fetch ticket from appropriate system.&quot;&quot;&quot;
        # Try JIRA first (if key looks like JIRA format)
        if self.jira and re.match(r&#039;[A-Z]+-\d+&#039;, key):
            try:
                return await self.jira.get_issue(key)
            except Exception:
                pass

        # Try GitHub (if numeric)
        if self.github and key.isdigit():
            try:
                return await self.github.get_issue(int(key))
            except Exception:
                pass

        return None

    def _format_context(self, ticket: Ticket) -&gt; str:
        &quot;&quot;&quot;Format ticket as context string.&quot;&quot;&quot;
        lines = [
            &quot;## Current Work Context&quot;,
            &quot;&quot;,
            f&quot;**Ticket**: {ticket.key} - {ticket.summary}&quot;,
            f&quot;**Status**: {ticket.status}&quot;,
        ]

        if self.config.include.assignee and ticket.assignee:
            lines.append(f&quot;**Assignee**: {ticket.assignee}&quot;)

        if self.config.include.description and ticket.description:
            lines.extend([&quot;&quot;, &quot;### Description&quot;, ticket.description])

        if self.config.include.acceptance_criteria and ticket.acceptance_criteria:
            lines.extend([&quot;&quot;, &quot;### Acceptance Criteria&quot;])
            for criterion in ticket.acceptance_criteria:
                status = &quot;x&quot; if criterion.done else &quot; &quot;
                lines.append(f&quot;- [{status}] {criterion.text}&quot;)

        if self.config.include.linked_issues and ticket.linked_issues:
            lines.extend([&quot;&quot;, &quot;### Related Issues&quot;])
            for linked in ticket.linked_issues:
                lines.append(f&quot;- {linked.key}: {linked.summary} ({linked.relationship})&quot;)

        # Truncate if too long
        context = &quot;\n&quot;.join(lines)
        if len(context) &gt; self.config.context.max_length:
            context = context[:self.config.context.max_length] + &quot;\n\n[Truncated]&quot;

        return context</code></pre>
        </div>
        <p>---</p>
        <h3>Branch Pattern Examples</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Branch Name</th><th>Pattern</th><th>Extracted Key</th></tr>
          </thead>
          <tbody>
            <tr><td><code>PROJ-123-add-retry</code></td><td><code>^(?P<key>[A-Z]+-\\d+)</code></td><td>PROJ-123</td></tr>
            <tr><td><code>feature/PROJ-456-new-ui</code></td><td><code>^feature/(?P<key>[A-Z]+-\\d+)</code></td><td>PROJ-456</td></tr>
            <tr><td><code>fix/SEC-789-xss-patch</code></td><td><code>^fix/(?P<key>[A-Z]+-\\d+)</code></td><td>SEC-789</td></tr>
            <tr><td><code>123-github-issue</code></td><td><code>^(?P<key>\\d+)-</code></td><td>123</td></tr>
            <tr><td><code>bugfix/PLATFORM-100</code></td><td><code>^bugfix/(?P<key>[A-Z]+-\\d+)</code></td><td>PLATFORM-100</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: JIRA Ticket Context</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Session starts on branch: feature/PROJ-456-payment-retry

# Hook fetches JIRA ticket and returns:
{
    &quot;action&quot;: &quot;inject_context&quot;,
    &quot;context_injection&quot;: &quot;&quot;&quot;
## Current Work Context

**Ticket**: PROJ-456 - Add retry logic to payment gateway
**Status**: In Progress
**Assignee**: alice

### Description
Implement exponential backoff retry for payment API calls to handle gateway timeouts during peak load. This addresses the 5% payment failure rate observed during Black Friday.

### Acceptance Criteria
- [ ] Retry up to 3 times with exponential backoff
- [ ] Log each retry attempt with correlation ID
- [ ] Add circuit breaker for repeated failures
- [ ] Update Grafana dashboard with retry metrics
- [ ] Add unit tests for retry logic

### Related Issues
- PROJ-400: Payment gateway timeout errors (parent epic)
- PROJ-455: Add payment metrics dashboard (blocks)
&quot;&quot;&quot;,
    &quot;context_injection_role&quot;: &quot;system&quot;,
    &quot;suppress_output&quot;: true,
    &quot;user_message&quot;: &quot;Loaded context for PROJ-456: Add retry logic to payment gateway&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: GitHub Issue Context</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Session starts on branch: 789-fix-auth-bug

# Hook fetches GitHub issue #789 and returns:
{
    &quot;action&quot;: &quot;inject_context&quot;,
    &quot;context_injection&quot;: &quot;&quot;&quot;
## Current Work Context

**Issue**: #789 - Session timeout not respecting remember-me setting
**Status**: Open
**Assignee**: bob
**Labels**: bug, priority:high, auth

### Description
Users with &quot;remember me&quot; checked are still being logged out after 30 minutes. Expected behavior is 30 day session.

### Linked PRs
- #785: Initial remember-me implementation (merged)
&quot;&quot;&quot;,
    &quot;user_message&quot;: &quot;Loaded context for #789&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: No Ticket Found</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Session starts on branch: main

# Hook returns (no injection, just continue):
{
    &quot;action&quot;: &quot;continue&quot;
}

# No ticket pattern matched in branch name</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>jira.enabled</code></td><td>bool</td><td>false</td><td>Enable JIRA integration</td></tr>
            <tr><td><code>jira.base_url</code></td><td>string</td><td>-</td><td>JIRA instance URL</td></tr>
            <tr><td><code>jira.auth_token</code></td><td>string</td><td>-</td><td>JIRA API token</td></tr>
            <tr><td><code>jira.project_keys</code></td><td>list</td><td>[]</td><td>Valid project keys</td></tr>
            <tr><td><code>github.enabled</code></td><td>bool</td><td>false</td><td>Enable GitHub integration</td></tr>
            <tr><td><code>branch_patterns</code></td><td>list</td><td>(defaults)</td><td>Regex patterns for extraction</td></tr>
            <tr><td><code>include.*</code></td><td>bool</td><td>varies</td><td>What ticket fields to include</td></tr>
            <tr><td><code>context.role</code></td><td>string</td><td>"system"</td><td>Injection role</td></tr>
            <tr><td><code>context.max_length</code></td><td>int</td><td>2000</td><td>Max context length</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>API tokens stored securely in environment</li>
        <li>Ticket content may contain sensitive information</li>
        <li>Context injection respects session permissions</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>httpx</code> - HTTP client for API calls</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>jira</code> - Official JIRA client</li>
        <li><code>PyGithub</code> - GitHub API client</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Multiple tickets</strong>: What if branch references multiple tickets?</li>
        <li><strong>Caching</strong>: Cache ticket data to avoid repeated API calls?</li>
        <li><strong>Updates</strong>: Re-fetch if ticket was updated during session?</li>
        <li><strong>Custom fields</strong>: Support JIRA custom fields?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-token-budget" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Token Budget</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-token-budget</code></p>
        </div>
        <h3>Overview</h3>
        <p>Enforce token usage limits at session, user, and project levels. Prevents runaway costs from expensive LLM operations and enables usage-based quotas.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Unlimited token consumption</td><td>Controlled spending</td></tr>
            <tr><td>Surprise LLM bills</td><td>Predictable costs</td></tr>
            <tr><td>No per-user limits</td><td>Fair usage allocation</td></tr>
            <tr><td>Single runaway session can be costly</td><td>Session-level caps</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-token-budget
    config:
      # Budget levels (all optional)
      budgets:
        # Per-session limit
        session:
          max_tokens: 100000            # Total tokens per session
          max_requests: 50              # Max LLM requests per session
          warn_at_percent: 80           # Warn when 80% consumed

        # Per-user limit (daily)
        user:
          daily_tokens: 500000
          daily_requests: 200
          reset_time: &quot;00:00&quot;           # UTC
          warn_at_percent: 90

        # Per-project limit (monthly)
        project:
          monthly_tokens: 10000000
          monthly_cost_usd: 500.00
          warn_at_percent: 75

      # Actions when budget exceeded
      on_exceed:
        session: deny                   # deny | warn | continue
        user: deny
        project: warn

      # Cost tracking
      cost:
        track: true
        # Token costs per model (per 1M tokens)
        pricing:
          claude-3-opus: {input: 15.00, output: 75.00}
          claude-3-sonnet: {input: 3.00, output: 15.00}
          gpt-4-turbo: {input: 10.00, output: 30.00}
          gpt-4o: {input: 5.00, output: 15.00}

      # Storage for tracking
      storage:
        type: file                      # file | redis | database
        path: &quot;${HOME}/.amplifier/budgets/&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">HookResult Actions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Warn approaching limit
HookResult(
    action=&quot;inject_context&quot;,
    context_injection=&quot;âš ï¸ Token budget: 82% consumed (82,000 / 100,000 tokens). Consider wrapping up soon.&quot;,
    user_message=&quot;Budget warning: 82% of session tokens used&quot;,
    user_message_level=&quot;warning&quot;
)

# Deny when exceeded
HookResult(
    action=&quot;deny&quot;,
    reason=&quot;Session token budget exceeded (100,000 tokens). Start a new session to continue.&quot;
)</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class TokenBudgetHook:
    &quot;&quot;&quot;Enforce token usage budgets.&quot;&quot;&quot;

    def __init__(self, config: TokenBudgetConfig):
        self.config = config
        self.storage = BudgetStorage(config.storage)
        self.pricing = config.cost.pricing if config.cost.track else {}

        # Session-level tracking (in-memory)
        self.session_usage: dict[str, Usage] = {}

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        session_id = data.get(&quot;session_id&quot;)
        user_id = data.get(&quot;user_id&quot;)

        # Pre-request: Check budgets before allowing
        if event == &quot;provider:request&quot;:
            return await self._check_budgets(session_id, user_id, data)

        # Post-response: Track usage
        if event == &quot;provider:response&quot;:
            await self._track_usage(session_id, user_id, data)
            return await self._check_warnings(session_id, user_id)

        return HookResult(action=&quot;continue&quot;)

    async def _check_budgets(
        self,
        session_id: str,
        user_id: str | None,
        data: dict
    ) -&gt; HookResult:
        &quot;&quot;&quot;Check if request would exceed any budget.&quot;&quot;&quot;

        # Estimate tokens for this request
        estimated = self._estimate_request_tokens(data)

        # Check session budget
        if self.config.budgets.session:
            session_usage = self._get_session_usage(session_id)
            if session_usage.tokens + estimated &gt; self.config.budgets.session.max_tokens:
                if self.config.on_exceed.session == &quot;deny&quot;:
                    return HookResult(
                        action=&quot;deny&quot;,
                        reason=f&quot;Session token budget exceeded ({session_usage.tokens:,} / {self.config.budgets.session.max_tokens:,})&quot;
                    )

        # Check user budget
        if self.config.budgets.user and user_id:
            user_usage = await self.storage.get_user_usage(user_id)
            if user_usage.daily_tokens + estimated &gt; self.config.budgets.user.daily_tokens:
                if self.config.on_exceed.user == &quot;deny&quot;:
                    return HookResult(
                        action=&quot;deny&quot;,
                        reason=f&quot;Daily user token budget exceeded. Resets at {self.config.budgets.user.reset_time} UTC.&quot;
                    )

        # Check project budget
        if self.config.budgets.project:
            project_usage = await self.storage.get_project_usage()
            if project_usage.monthly_tokens + estimated &gt; self.config.budgets.project.monthly_tokens:
                if self.config.on_exceed.project == &quot;deny&quot;:
                    return HookResult(
                        action=&quot;deny&quot;,
                        reason=&quot;Monthly project token budget exceeded.&quot;
                    )

        return HookResult(action=&quot;continue&quot;)

    async def _track_usage(
        self,
        session_id: str,
        user_id: str | None,
        data: dict
    ) -&gt; None:
        &quot;&quot;&quot;Track token usage from response.&quot;&quot;&quot;
        usage = data.get(&quot;usage&quot;, {})
        input_tokens = usage.get(&quot;input_tokens&quot;, 0)
        output_tokens = usage.get(&quot;output_tokens&quot;, 0)
        total_tokens = input_tokens + output_tokens

        model = data.get(&quot;model&quot;, &quot;unknown&quot;)
        cost = self._calculate_cost(model, input_tokens, output_tokens)

        # Update session usage
        session_usage = self._get_session_usage(session_id)
        session_usage.tokens += total_tokens
        session_usage.requests += 1
        session_usage.cost += cost

        # Update persistent storage
        if user_id:
            await self.storage.add_user_usage(user_id, total_tokens, cost)
        await self.storage.add_project_usage(total_tokens, cost)

    async def _check_warnings(
        self,
        session_id: str,
        user_id: str | None
    ) -&gt; HookResult:
        &quot;&quot;&quot;Check if any budget is approaching limit.&quot;&quot;&quot;
        warnings = []

        # Session warning
        if self.config.budgets.session:
            session_usage = self._get_session_usage(session_id)
            percent = (session_usage.tokens / self.config.budgets.session.max_tokens) * 100
            if percent &gt;= self.config.budgets.session.warn_at_percent:
                warnings.append(f&quot;Session: {percent:.0f}% ({session_usage.tokens:,} / {self.config.budgets.session.max_tokens:,} tokens)&quot;)

        # User warning
        if self.config.budgets.user and user_id:
            user_usage = await self.storage.get_user_usage(user_id)
            percent = (user_usage.daily_tokens / self.config.budgets.user.daily_tokens) * 100
            if percent &gt;= self.config.budgets.user.warn_at_percent:
                warnings.append(f&quot;Daily: {percent:.0f}% of daily limit&quot;)

        if warnings:
            return HookResult(
                action=&quot;inject_context&quot;,
                context_injection=f&quot;âš ï¸ Token budget warnings:\n&quot; + &quot;\n&quot;.join(f&quot;- {w}&quot; for w in warnings),
                suppress_output=True,
                user_message=f&quot;Budget: {&#039;; &#039;.join(warnings)}&quot;,
                user_message_level=&quot;warning&quot;
            )

        return HookResult(action=&quot;continue&quot;)

    def _calculate_cost(self, model: str, input_tokens: int, output_tokens: int) -&gt; float:
        &quot;&quot;&quot;Calculate cost for token usage.&quot;&quot;&quot;
        if model not in self.pricing:
            return 0.0

        pricing = self.pricing[model]
        input_cost = (input_tokens / 1_000_000) * pricing[&quot;input&quot;]
        output_cost = (output_tokens / 1_000_000) * pricing[&quot;output&quot;]
        return input_cost + output_cost


class BudgetStorage:
    &quot;&quot;&quot;Persistent storage for budget tracking.&quot;&quot;&quot;

    async def get_user_usage(self, user_id: str) -&gt; UserUsage:
        &quot;&quot;&quot;Get user&#039;s current usage, resetting if new day.&quot;&quot;&quot;
        data = await self._read_user_file(user_id)

        # Check if we need to reset (new day)
        if data and data[&quot;date&quot;] != self._today():
            data = None

        if not data:
            return UserUsage(daily_tokens=0, daily_cost=0.0)

        return UserUsage(**data)

    async def add_user_usage(self, user_id: str, tokens: int, cost: float) -&gt; None:
        &quot;&quot;&quot;Add usage to user&#039;s daily total.&quot;&quot;&quot;
        usage = await self.get_user_usage(user_id)
        usage.daily_tokens += tokens
        usage.daily_cost += cost
        await self._write_user_file(user_id, {
            &quot;date&quot;: self._today(),
            &quot;daily_tokens&quot;: usage.daily_tokens,
            &quot;daily_cost&quot;: usage.daily_cost
        })</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Session Limit Warning</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># After 82,000 tokens in session with 100,000 limit:
{
    &quot;action&quot;: &quot;inject_context&quot;,
    &quot;context_injection&quot;: &quot;âš ï¸ Token budget warnings:\n- Session: 82% (82,000 / 100,000 tokens)&quot;,
    &quot;user_message&quot;: &quot;Budget: Session: 82% (82,000 / 100,000 tokens)&quot;,
    &quot;user_message_level&quot;: &quot;warning&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Session Limit Exceeded</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Request would exceed session limit:
{
    &quot;action&quot;: &quot;deny&quot;,
    &quot;reason&quot;: &quot;Session token budget exceeded (100,000 / 100,000 tokens). Start a new session to continue.&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Cost Tracking</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># After response with usage data:
# Model: claude-3-sonnet
# Input: 5,000 tokens, Output: 2,000 tokens
# Cost: (5000/1M * $3) + (2000/1M * $15) = $0.015 + $0.030 = $0.045</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>budgets.session.max_tokens</code></td><td>int</td><td>none</td><td>Session token limit</td></tr>
            <tr><td><code>budgets.session.max_requests</code></td><td>int</td><td>none</td><td>Session request limit</td></tr>
            <tr><td><code>budgets.user.daily_tokens</code></td><td>int</td><td>none</td><td>Daily per-user limit</td></tr>
            <tr><td><code>budgets.project.monthly_tokens</code></td><td>int</td><td>none</td><td>Monthly project limit</td></tr>
            <tr><td><code>budgets.*.warn_at_percent</code></td><td>int</td><td>80</td><td>Warning threshold</td></tr>
            <tr><td><code>on_exceed.*</code></td><td>string</td><td>"deny"</td><td>Action when exceeded</td></tr>
            <tr><td><code>cost.track</code></td><td>bool</td><td>true</td><td>Track costs</td></tr>
            <tr><td><code>cost.pricing</code></td><td>dict</td><td>{}</td><td>Model pricing</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Storage Schema</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">// User usage file: ~/.amplifier/budgets/users/{user_id}.json
{
    &quot;date&quot;: &quot;2024-01-15&quot;,
    &quot;daily_tokens&quot;: 45000,
    &quot;daily_cost&quot;: 1.35,
    &quot;daily_requests&quot;: 23
}

// Project usage file: ~/.amplifier/budgets/project.json
{
    &quot;month&quot;: &quot;2024-01&quot;,
    &quot;monthly_tokens&quot;: 2500000,
    &quot;monthly_cost&quot;: 125.50,
    &quot;monthly_requests&quot;: 1250
}</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>Budget data stored securely</li>
        <li>User quotas prevent abuse</li>
        <li>Cost tracking enables chargeback</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>aiofiles</code> - Async file operations</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>redis</code> - For distributed budget tracking</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Distributed tracking</strong>: How to share budgets across instances?</li>
        <li><strong>Quota inheritance</strong>: Project limits vs team limits vs user limits?</li>
        <li><strong>Alerting</strong>: Notify admins when project budget is low?</li>
        <li><strong>Rollover</strong>: Allow unused quota to roll over?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-hooks-usage-analytics" data-category="hooks">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Hooks Usage Analytics</span>
            <span class="spec-category">hooks</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-hooks-usage-analytics</code></p>
        </div>
        <h3>Overview</h3>
        <p>Collects usage metrics for analysis, optimization, and reporting. Tracks patterns like model usage, tool frequency, session duration, and task types to inform decisions about AI tooling investments.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>No visibility into AI usage</td><td>Comprehensive analytics</td></tr>
            <tr><td>Can't justify AI investment</td><td>ROI data for stakeholders</td></tr>
            <tr><td>Unknown optimization opportunities</td><td>Data-driven improvements</td></tr>
            <tr><td>No usage patterns visible</td><td>Understand team behavior</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks:
  - module: hooks-usage-analytics
    config:
      # What to track
      metrics:
        sessions:
          enabled: true
          track: [duration, turns, outcome]

        tokens:
          enabled: true
          track: [input, output, by_model, by_task]

        tools:
          enabled: true
          track: [frequency, duration, success_rate]

        tasks:
          enabled: true
          classify: true                # Auto-classify task types

        costs:
          enabled: true
          pricing: &quot;${PRICING_CONFIG}&quot;

      # Aggregation
      aggregation:
        intervals: [hourly, daily, weekly, monthly]
        dimensions: [user, team, project, model, task_type]

      # Storage
      storage:
        type: file                      # file | database | datadog | prometheus
        path: &quot;${HOME}/.amplifier/analytics/&quot;

      # Privacy
      privacy:
        anonymize_users: false
        exclude_content: true           # Don&#039;t store prompts/responses
        aggregate_only: false           # Only store aggregates, not raw events

      # Export
      export:
        enabled: true
        format: json                    # json | csv | parquet
        schedule: daily</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Captured</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># All events are captured with standard fields:
{
    &quot;timestamp&quot;: &quot;2024-01-15T10:30:00Z&quot;,
    &quot;session_id&quot;: &quot;sess-123&quot;,
    &quot;user_id&quot;: &quot;alice&quot;,                 # Optional, anonymizable
    &quot;project&quot;: &quot;payment-service&quot;,
    &quot;event_type&quot;: &quot;...&quot;,
    &quot;data&quot;: {...}
}</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class UsageAnalyticsHook:
    &quot;&quot;&quot;Collect and aggregate usage metrics.&quot;&quot;&quot;

    CAPTURED_EVENTS = [
        &quot;session:start&quot;,
        &quot;session:end&quot;,
        &quot;provider:request&quot;,
        &quot;provider:response&quot;,
        &quot;tool:pre&quot;,
        &quot;tool:post&quot;,
        &quot;tool:error&quot;,
        &quot;prompt:submit&quot;,
        &quot;prompt:complete&quot;,
    ]

    def __init__(self, config: UsageAnalyticsConfig):
        self.config = config
        self.storage = AnalyticsStorage(config.storage)
        self.aggregator = MetricsAggregator(config.aggregation)
        self.classifier = TaskClassifier() if config.metrics.tasks.classify else None

        # In-memory session tracking
        self.sessions: dict[str, SessionMetrics] = {}

    async def __call__(self, event: str, data: dict) -&gt; HookResult:
        if event not in self.CAPTURED_EVENTS:
            return HookResult(action=&quot;continue&quot;)

        # Extract metrics
        metrics = self._extract_metrics(event, data)

        # Apply privacy settings
        metrics = self._apply_privacy(metrics)

        # Store raw event (if not aggregate_only)
        if not self.config.privacy.aggregate_only:
            await self.storage.store_event(metrics)

        # Update aggregates
        await self.aggregator.update(metrics)

        # Session-level tracking
        self._update_session(event, data, metrics)

        # Always continue - analytics is observational
        return HookResult(action=&quot;continue&quot;)

    def _extract_metrics(self, event: str, data: dict) -&gt; dict:
        &quot;&quot;&quot;Extract relevant metrics from event.&quot;&quot;&quot;
        base = {
            &quot;timestamp&quot;: datetime.utcnow().isoformat(),
            &quot;session_id&quot;: data.get(&quot;session_id&quot;),
            &quot;user_id&quot;: data.get(&quot;user_id&quot;),
            &quot;event_type&quot;: event,
        }

        # Event-specific extraction
        if event == &quot;provider:response&quot;:
            usage = data.get(&quot;usage&quot;, {})
            base.update({
                &quot;model&quot;: data.get(&quot;model&quot;),
                &quot;provider&quot;: data.get(&quot;provider&quot;),
                &quot;input_tokens&quot;: usage.get(&quot;input_tokens&quot;, 0),
                &quot;output_tokens&quot;: usage.get(&quot;output_tokens&quot;, 0),
                &quot;latency_ms&quot;: data.get(&quot;latency_ms&quot;),
            })

            # Calculate cost
            if self.config.metrics.costs.enabled:
                base[&quot;cost_usd&quot;] = self._calculate_cost(
                    data.get(&quot;model&quot;),
                    usage.get(&quot;input_tokens&quot;, 0),
                    usage.get(&quot;output_tokens&quot;, 0)
                )

        elif event == &quot;tool:post&quot;:
            base.update({
                &quot;tool&quot;: data.get(&quot;tool&quot;),
                &quot;operation&quot;: data.get(&quot;operation&quot;),
                &quot;duration_ms&quot;: data.get(&quot;duration_ms&quot;),
                &quot;success&quot;: data.get(&quot;success&quot;, True),
            })

        elif event == &quot;prompt:submit&quot;:
            if self.classifier:
                base[&quot;task_type&quot;] = self.classifier.classify(data.get(&quot;prompt&quot;, &quot;&quot;))

        return base

    def _update_session(self, event: str, data: dict, metrics: dict) -&gt; None:
        &quot;&quot;&quot;Update session-level metrics.&quot;&quot;&quot;
        session_id = data.get(&quot;session_id&quot;)
        if not session_id:
            return

        if event == &quot;session:start&quot;:
            self.sessions[session_id] = SessionMetrics(
                start_time=datetime.utcnow(),
                turns=0,
                total_tokens=0,
                total_cost=0.0,
                tools_used=set(),
                models_used=set()
            )

        elif session_id in self.sessions:
            session = self.sessions[session_id]

            if event == &quot;prompt:complete&quot;:
                session.turns += 1

            if event == &quot;provider:response&quot;:
                session.total_tokens += metrics.get(&quot;input_tokens&quot;, 0) + metrics.get(&quot;output_tokens&quot;, 0)
                session.total_cost += metrics.get(&quot;cost_usd&quot;, 0)
                if metrics.get(&quot;model&quot;):
                    session.models_used.add(metrics[&quot;model&quot;])

            if event == &quot;tool:post&quot;:
                if metrics.get(&quot;tool&quot;):
                    session.tools_used.add(metrics[&quot;tool&quot;])

            if event == &quot;session:end&quot;:
                session.end_time = datetime.utcnow()
                session.duration_seconds = (session.end_time - session.start_time).total_seconds()
                # Store session summary
                asyncio.create_task(self._store_session_summary(session_id, session))


class MetricsAggregator:
    &quot;&quot;&quot;Aggregate metrics across dimensions.&quot;&quot;&quot;

    async def update(self, metrics: dict) -&gt; None:
        &quot;&quot;&quot;Update all relevant aggregations.&quot;&quot;&quot;
        timestamp = datetime.fromisoformat(metrics[&quot;timestamp&quot;])

        for interval in self.config.intervals:
            bucket = self._get_bucket(timestamp, interval)

            for dimension in self.config.dimensions:
                key = self._get_dimension_key(metrics, dimension)
                if key:
                    await self._increment_counters(bucket, dimension, key, metrics)

    async def _increment_counters(
        self,
        bucket: str,
        dimension: str,
        key: str,
        metrics: dict
    ) -&gt; None:
        &quot;&quot;&quot;Increment counters for this bucket/dimension/key.&quot;&quot;&quot;
        counter_key = f&quot;{bucket}:{dimension}:{key}&quot;

        # Token counters
        if &quot;input_tokens&quot; in metrics:
            await self.storage.increment(f&quot;{counter_key}:input_tokens&quot;, metrics[&quot;input_tokens&quot;])
            await self.storage.increment(f&quot;{counter_key}:output_tokens&quot;, metrics[&quot;output_tokens&quot;])

        # Request counters
        if metrics[&quot;event_type&quot;] == &quot;provider:response&quot;:
            await self.storage.increment(f&quot;{counter_key}:requests&quot;, 1)

        # Cost counters
        if &quot;cost_usd&quot; in metrics:
            await self.storage.increment_float(f&quot;{counter_key}:cost_usd&quot;, metrics[&quot;cost_usd&quot;])</code></pre>
        </div>
        <p>---</p>
        <h3>Metrics Schema</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Session Metrics</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class SessionMetrics:
    session_id: str
    user_id: str | None
    project: str | None

    start_time: datetime
    end_time: datetime | None
    duration_seconds: float

    turns: int                          # User/assistant exchanges
    total_tokens: int
    total_cost: float

    models_used: set[str]
    tools_used: set[str]
    task_types: list[str]               # Classified task types

    outcome: str | None                 # success | abandoned | error</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Aggregated Metrics</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class AggregatedMetrics:
    period: str                         # &quot;2024-01-15&quot;, &quot;2024-W03&quot;, &quot;2024-01&quot;
    dimension: str                      # user | team | project | model
    dimension_value: str

    # Counts
    sessions: int
    requests: int
    tool_calls: int

    # Tokens
    input_tokens: int
    output_tokens: int
    total_tokens: int

    # Costs
    total_cost_usd: float
    avg_cost_per_session: float

    # Performance
    avg_latency_ms: float
    p95_latency_ms: float

    # Usage patterns
    top_tools: list[tuple[str, int]]    # [(tool, count), ...]
    top_models: list[tuple[str, int]]
    top_task_types: list[tuple[str, int]]</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Daily Summary</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">{
    &quot;period&quot;: &quot;2024-01-15&quot;,
    &quot;dimension&quot;: &quot;team&quot;,
    &quot;dimension_value&quot;: &quot;platform&quot;,

    &quot;sessions&quot;: 45,
    &quot;requests&quot;: 892,
    &quot;tool_calls&quot;: 234,

    &quot;input_tokens&quot;: 1250000,
    &quot;output_tokens&quot;: 450000,
    &quot;total_tokens&quot;: 1700000,

    &quot;total_cost_usd&quot;: 52.30,
    &quot;avg_cost_per_session&quot;: 1.16,

    &quot;avg_latency_ms&quot;: 1250,
    &quot;p95_latency_ms&quot;: 3200,

    &quot;top_tools&quot;: [
        [&quot;filesystem:read&quot;, 89],
        [&quot;codebase_search&quot;, 45],
        [&quot;bash&quot;, 34]
    ],
    &quot;top_models&quot;: [
        [&quot;claude-3-sonnet&quot;, 650],
        [&quot;claude-3-opus&quot;, 242]
    ],
    &quot;top_task_types&quot;: [
        [&quot;code_generation&quot;, 28],
        [&quot;debugging&quot;, 12],
        [&quot;analysis&quot;, 5]
    ]
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: User Leaderboard</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">{
    &quot;period&quot;: &quot;2024-01&quot;,
    &quot;dimension&quot;: &quot;user&quot;,
    &quot;leaderboard&quot;: [
        {&quot;user&quot;: &quot;alice&quot;, &quot;sessions&quot;: 120, &quot;cost&quot;: 245.50, &quot;tokens&quot;: 5200000},
        {&quot;user&quot;: &quot;bob&quot;, &quot;sessions&quot;: 95, &quot;cost&quot;: 189.20, &quot;tokens&quot;: 4100000},
        {&quot;user&quot;: &quot;carol&quot;, &quot;sessions&quot;: 78, &quot;cost&quot;: 156.80, &quot;tokens&quot;: 3400000}
    ]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Visualization / Export</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Dashboard Data Points</h4>
        <li><strong>Time series</strong>: Tokens, costs, sessions over time</li>
        <li><strong>Breakdowns</strong>: By model, tool, task type, user</li>
        <li><strong>Trends</strong>: Week-over-week changes</li>
        <li><strong>Alerts</strong>: Unusual spikes in usage/cost</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Export Formats</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># CSV export
async def export_csv(period: str) -&gt; str:
    &quot;&quot;&quot;Export metrics as CSV.&quot;&quot;&quot;
    data = await storage.get_period_metrics(period)
    return csv_format(data)

# JSON export for dashboards
async def export_json(period: str) -&gt; dict:
    &quot;&quot;&quot;Export metrics as JSON.&quot;&quot;&quot;
    return await storage.get_period_metrics(period)

# Prometheus metrics
async def export_prometheus() -&gt; str:
    &quot;&quot;&quot;Export as Prometheus metrics.&quot;&quot;&quot;
    metrics = await storage.get_current_metrics()
    return prometheus_format(metrics)</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>metrics.*.enabled</code></td><td>bool</td><td>true</td><td>Enable metric category</td></tr>
            <tr><td><code>aggregation.intervals</code></td><td>list</td><td>[daily]</td><td>Aggregation intervals</td></tr>
            <tr><td><code>aggregation.dimensions</code></td><td>list</td><td>[user,project]</td><td>Aggregation dimensions</td></tr>
            <tr><td><code>storage.type</code></td><td>string</td><td>"file"</td><td>Storage backend</td></tr>
            <tr><td><code>privacy.anonymize_users</code></td><td>bool</td><td>false</td><td>Hash user IDs</td></tr>
            <tr><td><code>privacy.exclude_content</code></td><td>bool</td><td>true</td><td>Don't store prompts</td></tr>
            <tr><td><code>privacy.aggregate_only</code></td><td>bool</td><td>false</td><td>Only store aggregates</td></tr>
            <tr><td><code>export.schedule</code></td><td>string</td><td>"daily"</td><td>Export schedule</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security Considerations</h3>
        <li>User IDs can be anonymized</li>
        <li>Prompt content excluded by default</li>
        <li>Aggregates can be used instead of raw events</li>
        <li>Storage should be access-controlled</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>aiofiles</code> - File operations</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>prometheus_client</code> - Prometheus export</li>
        <li><code>datadog</code> - DataDog integration</li>
        <li><code>pandas</code> - Data analysis</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Retention</strong>: How long to keep raw events vs aggregates?</li>
        <li><strong>Real-time</strong>: Stream metrics to dashboards?</li>
        <li><strong>Alerting</strong>: Integrate with alerting systems?</li>
        <li><strong>Benchmarking</strong>: Compare teams/projects?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-collection-enterprise-dev" data-category="collections">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Collection Enterprise Dev</span>
            <span class="spec-category">collections</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Critical Path)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-collection-enterprise-dev</code></p>
        </div>
        <h3>Overview</h3>
        <p>A comprehensive collection of tools, hooks, and configurations for enterprise software development teams. Provides security-first defaults, compliance features, and integrations with common enterprise tools.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual module assembly</td><td>Pre-configured enterprise stack</td></tr>
            <tr><td>Security afterthought</td><td>Security-first defaults</td></tr>
            <tr><td>Compliance gaps</td><td>Built-in audit and compliance</td></tr>
            <tr><td>Integration complexity</td><td>Ready-to-use enterprise integrations</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Collection Contents</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">collection:
  name: enterprise-dev
  version: &quot;1.0.0&quot;
  description: &quot;Enterprise-grade AI development toolkit&quot;

  # Included modules
  modules:

    # ===== PROVIDERS =====
    providers:
      - module: provider-anthropic
        config:
          default_model: claude-sonnet-4-5
          max_tokens: 8192

      - module: provider-azure-openai    # Enterprise Azure option
        config:
          api_version: &quot;2024-02-15-preview&quot;
          deployment_name: &quot;${AZURE_OPENAI_DEPLOYMENT}&quot;

    # ===== TOOLS =====
    tools:
      # Core development
      - module: tool-filesystem
        config:
          allowed_paths: [&quot;${WORKSPACE}&quot;]
          audit_all_writes: true

      - module: tool-bash
        config:
          allowed_commands: [&quot;git&quot;, &quot;npm&quot;, &quot;python&quot;, &quot;docker&quot;]
          blocked_commands: [&quot;rm -rf&quot;, &quot;curl|sh&quot;]
          timeout: 30s

      # Enterprise tools (from specs)
      - module: tool-codebase-search
        config:
          include_semantic: true
          include_docs: true
          include_tickets: true

      - module: tool-pr-context
        config:
          platform: github-enterprise
          include_reviews: true

      - module: tool-jira-ops
        config:
          server: &quot;${JIRA_SERVER}&quot;
          project_filter: [&quot;${JIRA_PROJECTS}&quot;]
          allowed_operations: [read, create, update, link]

      - module: tool-git-advanced
        config:
          enable_blame: true
          enable_bisect: false          # Potentially dangerous
          audit_commands: true

      - module: tool-test-runner
        config:
          frameworks: [pytest, jest, go-test]
          coverage_threshold: 80

      - module: tool-dependency-graph
        config:
          languages: [python, typescript, go]
          include_external: true

      - module: tool-slack-search
        config:
          channels: [&quot;${ALLOWED_SLACK_CHANNELS}&quot;]
          exclude_dm: true

      - module: tool-metrics-query
        config:
          providers: [datadog, prometheus]
          max_lookback: 7d

    # ===== HOOKS =====
    hooks:
      # Security (P0 - Always enabled)
      - module: hooks-secret-detector
        config:
          action: deny                   # Block secrets
          patterns: enterprise           # Enterprise patterns
          audit: true

      - module: hooks-security-scan
        config:
          scan_on_write: true
          severity_threshold: medium
          block_high: true

      - module: hooks-pii-guardian
        config:
          redact_patterns: [email, phone, ssn, credit_card]
          action: redact                 # Redact before sending to LLM

      - module: hooks-license-checker
        config:
          policy:
            allowed: [MIT, Apache-2.0, BSD-*]
            prohibited: [GPL-*, AGPL-*]
          action: deny

      # Compliance
      - module: hooks-audit-trail
        config:
          storage: &quot;${AUDIT_LOG_PATH}&quot;
          include_all_events: true
          retention_days: 365

      - module: hooks-approval-workflow
        config:
          require_approval_for:
            - &quot;production/*&quot;
            - &quot;*.env*&quot;
            - &quot;secrets/*&quot;
          escalation_channel: &quot;#security-approvals&quot;

      # Quality
      - module: hooks-style-enforcer
        config:
          auto_fix: true
          tools:
            python: [ruff, black, mypy]
            typescript: [eslint, prettier]

      - module: hooks-breaking-change
        config:
          check_api: true
          check_database: true
          action: warn

      # Productivity
      - module: hooks-ticket-linker
        config:
          platforms: [jira, github]
          auto_load_context: true

      - module: hooks-reviewer-suggester
        config:
          use_codeowners: true
          max_reviewers: 3

      # Observability
      - module: hooks-logging
        config:
          level: info
          format: json
          include_token_usage: true
          include_latency: true

      - module: hooks-usage-analytics
        config:
          track_costs: true
          track_tokens: true
          aggregation: [user, team, project]

    # ===== ORCHESTRATORS =====
    orchestrators:
      default: loop-streaming
      options:
        - loop-streaming
        - loop-basic

    # ===== CONTEXTS =====
    contexts:
      default: context-persistent
      config:
        storage: &quot;${STATE_PATH}&quot;
        max_history: 100

  # Collection-level configuration
  config:
    # Security defaults
    security:
      require_approval_for_production: true
      block_secrets: true
      audit_all_operations: true

    # Enterprise integrations
    integrations:
      sso:
        provider: okta
        required: true
      vault:
        enabled: true
        path: &quot;secret/amplifier&quot;

    # Defaults
    defaults:
      timeout: 120s
      max_tokens: 8192
      temperature: 0.3</code></pre>
        </div>
        <p>---</p>
        <h3>Profile Hierarchy</h3>
        <p>The collection provides layered profiles for different use cases:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">profiles:
  # Base enterprise profile (always applied)
  base:
    description: &quot;Core enterprise security and compliance&quot;
    hooks:
      - hooks-secret-detector
      - hooks-security-scan
      - hooks-audit-trail
      - hooks-pii-guardian
      - hooks-logging

  # Development profile (extends base)
  development:
    extends: base
    description: &quot;Day-to-day development work&quot;
    tools:
      - tool-filesystem
      - tool-bash
      - tool-codebase-search
      - tool-git-advanced
      - tool-test-runner
    hooks:
      - hooks-style-enforcer
      - hooks-ticket-linker

  # Review profile (extends base)
  review:
    extends: base
    description: &quot;Code review and PR work&quot;
    tools:
      - tool-pr-context
      - tool-codebase-search
      - tool-dependency-graph
    hooks:
      - hooks-breaking-change
      - hooks-reviewer-suggester
      - hooks-license-checker

  # Incident profile (extends base)
  incident:
    extends: base
    description: &quot;Incident response&quot;
    tools:
      - tool-metrics-query
      - tool-git-advanced
      - tool-slack-search
    hooks:
      - hooks-approval-workflow   # For production changes
    config:
      timeout: 300s               # Longer timeout for investigation

  # Full profile (all modules)
  full:
    extends: base
    description: &quot;All enterprise modules&quot;
    tools: all
    hooks: all</code></pre>
        </div>
        <p>---</p>
        <h3>Installation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Install collection
amplifier collection install enterprise-dev

# Use specific profile
amplifier --profile enterprise-dev:development

# Or set as default
amplifier config set default-collection enterprise-dev
amplifier config set default-profile development</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Requirements</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Environment Variables</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Required
WORKSPACE=/path/to/project
AUDIT_LOG_PATH=/var/log/amplifier/audit
STATE_PATH=~/.amplifier/state

# Enterprise integrations
JIRA_SERVER=https://company.atlassian.net
JIRA_PROJECTS=PROJ,PLAT,INFRA
ALLOWED_SLACK_CHANNELS=engineering,platform,incidents

# Optional (for specific modules)
AZURE_OPENAI_ENDPOINT=https://company.openai.azure.com
AZURE_OPENAI_DEPLOYMENT=gpt-4
DD_API_KEY=xxx
DD_APP_KEY=xxx</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Secret Management</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Vault integration for secrets
vault:
  enabled: true
  address: &quot;${VAULT_ADDR}&quot;
  auth_method: kubernetes       # or token, ldap, oidc
  secret_paths:
    anthropic: &quot;secret/ai/anthropic&quot;
    azure: &quot;secret/ai/azure-openai&quot;
    jira: &quot;secret/integrations/jira&quot;
    github: &quot;secret/integrations/github&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Security Posture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Default Security Controls</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Control</th><th>Default</th><th>Configurable</th></tr>
          </thead>
          <tbody>
            <tr><td>Secret detection</td><td>Block</td><td>Yes (warn mode)</td></tr>
            <tr><td>Security scanning</td><td>Block high severity</td><td>Yes</td></tr>
            <tr><td>PII redaction</td><td>Redact before LLM</td><td>Yes</td></tr>
            <tr><td>License checking</td><td>Block GPL</td><td>Yes</td></tr>
            <tr><td>Audit logging</td><td>All events</td><td>Log level only</td></tr>
            <tr><td>Production approval</td><td>Required</td><td>No (enterprise)</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Compliance Features</h4>
        <li><strong>SOC 2</strong>: Audit trail, access controls, encryption</li>
        <li><strong>GDPR</strong>: PII detection and redaction</li>
        <li><strong>HIPAA</strong>: PHI patterns in PII guardian</li>
        <li><strong>PCI-DSS</strong>: Credit card detection, audit logs</li>
        <p>---</p>
        <h3>Enterprise Integrations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">SSO Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">sso:
  provider: okta                # okta | azure-ad | onelogin
  client_id: &quot;${OKTA_CLIENT_ID}&quot;
  issuer: &quot;${OKTA_ISSUER}&quot;
  scopes: [openid, profile, groups]

  # Map groups to permissions
  group_mapping:
    &quot;Engineering&quot;: [&quot;development&quot;, &quot;review&quot;]
    &quot;Security&quot;: [&quot;development&quot;, &quot;review&quot;, &quot;incident&quot;]
    &quot;Platform&quot;: [&quot;development&quot;, &quot;review&quot;, &quot;incident&quot;, &quot;admin&quot;]</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">SIEM Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">siem:
  enabled: true
  provider: splunk              # splunk | elastic | datadog
  endpoint: &quot;${SPLUNK_HEC_ENDPOINT}&quot;

  # Events to forward
  events:
    - &quot;audit:*&quot;
    - &quot;security:*&quot;
    - &quot;approval:*&quot;

  # Format
  format: json
  include_context: false        # Don&#039;t send prompt content</code></pre>
        </div>
        <p>---</p>
        <h3>Usage Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Daily Development</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Start development session
amplifier --profile enterprise-dev:development

# Tools available:
# - Codebase search (semantic + docs + tickets)
# - Git operations (with audit)
# - Test runner
# - File operations (workspace only)

# Hooks active:
# - Secret detection (blocks)
# - Style enforcement (auto-fix)
# - Ticket linking (auto-context)
# - Security scanning (warns)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Code Review</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Review a PR
amplifier --profile enterprise-dev:review

&gt; Review PR #1234

# Automatically:
# - Fetches PR context
# - Checks for breaking changes
# - Scans for security issues
# - Suggests reviewers
# - Checks license compliance</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Incident Response</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Incident mode with elevated permissions
amplifier --profile enterprise-dev:incident

&gt; Investigate payment failures

# Available:
# - Metrics queries (up to 7d lookback)
# - Git history analysis
# - Slack search for context
# - Production file access (with approval)</code></pre>
        </div>
        <p>---</p>
        <h3>Customization</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Extending the Collection</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># company-config.yaml
extends: enterprise-dev

# Add company-specific modules
modules:
  tools:
    - module: tool-internal-api
      config:
        endpoint: https://api.internal.company.com

  hooks:
    - module: hooks-company-policy
      config:
        policy_file: ./company-policy.yaml

# Override defaults
config:
  security:
    additional_secret_patterns:
      - name: internal_api_key
        pattern: &quot;COMPANY_[A-Z0-9]{32}&quot;

  integrations:
    ticketing:
      platform: internal        # Use internal system instead of Jira</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Disabling Modules</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># For specific use case, disable certain hooks
profiles:
  sandbox:
    extends: development
    disabled:
      - hooks-approval-workflow   # No approvals in sandbox
      - hooks-audit-trail         # No audit in sandbox
    config:
      security:
        require_approval_for_production: false</code></pre>
        </div>
        <p>---</p>
        <h3>Metrics &amp; Reporting</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Built-in Dashboards</h4>
        <p>The collection provides data for:</p>
        <li><strong>Usage Dashboard</strong>: Tokens, costs, sessions by team/user</li>
        <li><strong>Security Dashboard</strong>: Blocked secrets, vulnerabilities found</li>
        <li><strong>Compliance Dashboard</strong>: Approval rates, audit coverage</li>
        <li><strong>Productivity Dashboard</strong>: Time saved, code generated</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Export Formats</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Export usage data
amplifier analytics export --format csv --period month

# Export audit logs
amplifier audit export --format json --days 30

# Generate compliance report
amplifier compliance report --standard soc2</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required External Services</h4>
        <li>Git repository (GitHub Enterprise / GitLab / Azure DevOps)</li>
        <li>Ticketing system (Jira / Azure Boards)</li>
        <li>Secret management (Vault / AWS Secrets Manager)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional Services</h4>
        <li>Observability (Datadog / Prometheus / New Relic)</li>
        <li>Chat (Slack / Teams)</li>
        <li>SSO (Okta / Azure AD)</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-collection-platform-team" data-category="collections">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Collection Platform Team</span>
            <span class="spec-category">collections</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-collection-platform-team</code></p>
        </div>
        <h3>Overview</h3>
        <p>Specialized collection for platform engineering and infrastructure teams. Focuses on multi-service architecture, infrastructure-as-code, reliability engineering, and cross-cutting concerns.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Service sprawl complexity</td><td>Unified multi-service tools</td></tr>
            <tr><td>Manual dependency tracking</td><td>Automated service graph</td></tr>
            <tr><td>Incident chaos</td><td>Structured response workflow</td></tr>
            <tr><td>Config drift</td><td>Infrastructure validation</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Collection Contents</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">collection:
  name: platform-team
  version: &quot;1.0.0&quot;
  description: &quot;Platform engineering and SRE toolkit&quot;

  extends: enterprise-dev          # Inherits enterprise security

  # Platform-specific modules
  modules:

    # ===== TOOLS =====
    tools:
      # Multi-service operations
      - module: tool-service-graph
        config:
          discovery:
            kubernetes: true
            terraform: true
            consul: true
          include_dependencies: true
          include_health: true

      - module: tool-multi-repo-search
        config:
          repositories: &quot;${PLATFORM_REPOS}&quot;
          include_configs: true
          include_iac: true

      # Infrastructure
      - module: tool-terraform-ops
        config:
          workspaces: [&quot;${TF_WORKSPACES}&quot;]
          allowed_operations: [plan, validate, state]
          apply_require_approval: true

      - module: tool-kubernetes-ops
        config:
          contexts: [&quot;${K8S_CONTEXTS}&quot;]
          namespaces: [&quot;${K8S_NAMESPACES}&quot;]
          allowed_operations: [get, describe, logs, exec]
          blocked_operations: [delete, edit]

      - module: tool-helm-ops
        config:
          repositories: [&quot;${HELM_REPOS}&quot;]
          operations: [list, status, template, diff]
          install_require_approval: true

      # Observability
      - module: tool-metrics-query
        config:
          providers:
            prometheus:
              url: &quot;${PROMETHEUS_URL}&quot;
              queries: platform-queries.yaml
            datadog:
              api_key: &quot;${DD_API_KEY}&quot;
            cloudwatch:
              regions: [&quot;${AWS_REGIONS}&quot;]
          max_lookback: 30d            # Longer for capacity planning

      - module: tool-log-aggregator
        config:
          providers:
            elasticsearch:
              url: &quot;${ES_URL}&quot;
              indices: [&quot;logs-*&quot;, &quot;traces-*&quot;]
            loki:
              url: &quot;${LOKI_URL}&quot;
          max_entries: 5000

      - module: tool-trace-analyzer
        config:
          provider: jaeger             # jaeger | zipkin | datadog
          url: &quot;${JAEGER_URL}&quot;
          include_dependencies: true

      # Dependencies and health
      - module: tool-dependency-graph
        config:
          scope: multi-repo
          include_infrastructure: true
          include_network: true

      - module: tool-health-checker
        config:
          services: &quot;${PLATFORM_SERVICES}&quot;
          checks: [http, tcp, grpc]
          include_dependencies: true

      # Database operations
      - module: tool-database-ops
        config:
          connections: &quot;${DB_CONNECTIONS}&quot;
          allowed_operations: [query, explain, schema]
          ddl_require_approval: true
          max_rows: 1000

    # ===== HOOKS =====
    hooks:
      # Platform-specific security
      - module: hooks-iac-validator
        config:
          validate_terraform: true
          validate_kubernetes: true
          validate_helm: true
          policies:
            - no_public_ingress
            - require_resource_limits
            - require_security_context

      - module: hooks-blast-radius
        config:
          warn_threshold: 10           # Services affected
          block_threshold: 50
          require_approval_above: 20

      # Change management
      - module: hooks-change-window
        config:
          windows:
            - name: maintenance
              cron: &quot;0 2 * * 0&quot;        # Sunday 2 AM
              duration: 4h
            - name: freeze
              dates: [&quot;2024-12-20:2025-01-05&quot;]
          production_changes: maintenance_only

      - module: hooks-rollback-ready
        config:
          require_rollback_plan: true
          verify_previous_version: true

      # Incident support
      - module: hooks-runbook-linker
        config:
          runbook_path: docs/runbooks/
          auto_suggest: true
          link_to_alerts: true

      - module: hooks-incident-auto-context
        config:
          include_recent_deploys: true
          include_related_alerts: true
          include_service_health: true
          lookback: 24h

      # Capacity and cost
      - module: hooks-resource-estimator
        config:
          estimate_cpu: true
          estimate_memory: true
          estimate_cost: true
          warn_high_cost: true

    # ===== SCENARIO TOOLS =====
    scenarios:
      - module: incident-responder
        config:
          auto_gather_context: true
          services_scope: platform

      - module: capacity-planner
        config:
          forecast_days: 90
          include_cost_projection: true

  # Platform-specific profiles
  profiles:
    # Infrastructure work
    infrastructure:
      tools:
        - tool-terraform-ops
        - tool-kubernetes-ops
        - tool-helm-ops
        - tool-service-graph
      hooks:
        - hooks-iac-validator
        - hooks-blast-radius
        - hooks-change-window
      config:
        require_approval_for:
          - &quot;*.tf&quot;
          - &quot;*.yaml&quot;           # K8s manifests
          - &quot;values*.yaml&quot;     # Helm values

    # Incident response
    incident:
      tools:
        - tool-metrics-query
        - tool-log-aggregator
        - tool-trace-analyzer
        - tool-service-graph
        - tool-health-checker
      hooks:
        - hooks-runbook-linker
        - hooks-incident-auto-context
      scenarios:
        - incident-responder
      config:
        elevated_permissions: true
        audit_level: verbose

    # Capacity planning
    capacity:
      tools:
        - tool-metrics-query
        - tool-service-graph
        - tool-dependency-graph
      hooks:
        - hooks-resource-estimator
      scenarios:
        - capacity-planner
      config:
        metrics_lookback: 90d

    # Service development
    service-dev:
      extends: ../enterprise-dev:development
      tools:
        - tool-service-graph
        - tool-multi-repo-search
        - tool-health-checker
      hooks:
        - hooks-blast-radius</code></pre>
        </div>
        <p>---</p>
        <h3>Service Graph Tool</h3>
        <p>A key differentiator for platform teams:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-service-graph:
  description: &quot;Map and analyze service dependencies&quot;

  capabilities:
    # Discovery
    discover_from:
      - kubernetes_services
      - terraform_state
      - consul_catalog
      - manual_config

    # Analysis
    analyze:
      - dependency_chains
      - blast_radius
      - single_points_of_failure
      - cyclic_dependencies

    # Visualization
    outputs:
      - ascii_diagram
      - mermaid
      - graphviz
      - interactive_html

  # Example output
  example_output: |
    Service Dependency Graph for: payment-service

    payment-service
    â”œâ”€â”€ auth-service (direct)
    â”‚   â””â”€â”€ redis-cache (direct)
    â”œâ”€â”€ database (direct)
    â”‚   â””â”€â”€ postgres-primary (RDS)
    â”œâ”€â”€ notification-service (async)
    â”‚   â”œâ”€â”€ sns-topic
    â”‚   â””â”€â”€ email-provider (external)
    â””â”€â”€ stripe-api (external)

    Blast Radius: 12 services
    Single Points of Failure: postgres-primary
    Cyclic Dependencies: None</code></pre>
        </div>
        <p>---</p>
        <h3>Infrastructure Validation Hook</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks-iac-validator:
  description: &quot;Validate infrastructure-as-code before apply&quot;

  policies:
    # Kubernetes
    kubernetes:
      - name: require_resource_limits
        description: &quot;All containers must have CPU/memory limits&quot;
        severity: error

      - name: require_security_context
        description: &quot;Pods must have security context&quot;
        severity: error

      - name: no_privileged_containers
        description: &quot;No privileged containers allowed&quot;
        severity: error

      - name: require_liveness_probe
        description: &quot;Services must have liveness probes&quot;
        severity: warning

    # Terraform
    terraform:
      - name: no_public_s3
        description: &quot;S3 buckets must not be public&quot;
        severity: error

      - name: encryption_at_rest
        description: &quot;Databases must have encryption&quot;
        severity: error

      - name: require_tags
        description: &quot;Resources must have cost allocation tags&quot;
        severity: warning

    # Helm
    helm:
      - name: no_latest_tag
        description: &quot;Image tags must be explicit versions&quot;
        severity: error

  example_output: |
    ðŸ” IaC Validation Results

    âŒ FAILED: require_resource_limits
       File: deployment.yaml
       Line: 45
       Container &#039;app&#039; missing resource limits

    âš ï¸ WARNING: require_liveness_probe
       File: deployment.yaml
       Line: 42
       Container &#039;app&#039; missing liveness probe

    âœ… PASSED: no_privileged_containers
    âœ… PASSED: require_security_context</code></pre>
        </div>
        <p>---</p>
        <h3>Blast Radius Analysis</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks-blast-radius:
  description: &quot;Analyze impact of changes on dependent services&quot;

  analysis:
    # Direct impacts
    direct:
      - services_calling_this
      - services_this_calls
      - shared_databases
      - shared_queues

    # Indirect impacts
    indirect:
      - cascading_dependencies
      - feature_flag_consumers
      - config_consumers

  thresholds:
    warning: 10                # Warn if &gt;10 services affected
    approval: 20               # Require approval if &gt;20
    block: 50                  # Block if &gt;50

  example_output: |
    ðŸŽ¯ Blast Radius Analysis: payment-service changes

    Direct Impact (5 services):
    â”œâ”€â”€ checkout-service (calls payment API)
    â”œâ”€â”€ refund-service (calls payment API)
    â”œâ”€â”€ reporting-service (reads payment DB)
    â”œâ”€â”€ notification-service (listens to events)
    â””â”€â”€ admin-dashboard (calls payment API)

    Indirect Impact (7 services):
    â”œâ”€â”€ mobile-app â†’ checkout-service
    â”œâ”€â”€ web-app â†’ checkout-service
    â”œâ”€â”€ customer-support â†’ admin-dashboard
    â””â”€â”€ ... (4 more)

    Total Blast Radius: 12 services
    Risk Level: MEDIUM

    âš ï¸ Recommend: Deploy during maintenance window</code></pre>
        </div>
        <p>---</p>
        <h3>Incident Response Workflow</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">incident-responder:
  # Platform-optimized configuration
  config:
    # Auto-gather platform context
    auto_context:
      recent_deployments:
        lookback: 24h
        all_services: true        # Not just affected service

      service_health:
        include_dependencies: true
        depth: 3                  # 3 levels of dependencies

      metrics:
        queries:
          - error_rate
          - latency_p99
          - saturation
          - traffic

      alerts:
        providers: [pagerduty, datadog]
        lookback: 4h

    # Platform-specific diagnosis
    diagnosis:
      approaches:
        - service_dependency_analysis
        - deployment_correlation
        - resource_exhaustion
        - cascading_failure

    # Remediation options
    remediation:
      actions:
        - type: rollback
          scope: single_service
          require_approval: true

        - type: scale
          scope: single_service
          limits:
            max_replicas: 10

        - type: circuit_breaker
          scope: dependency
          require_approval: false

        - type: traffic_shift
          scope: cluster
          require_approval: true</code></pre>
        </div>
        <p>---</p>
        <h3>Change Window Enforcement</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks-change-window:
  description: &quot;Enforce change windows for production&quot;

  windows:
    # Regular maintenance
    maintenance:
      schedule: &quot;0 2 * * 0&quot;       # Sunday 2 AM UTC
      duration: 4h
      allowed:
        - infrastructure
        - config
        - deployments

    # Feature releases
    release:
      schedule: &quot;0 10 * * 2,4&quot;   # Tue/Thu 10 AM UTC
      duration: 2h
      allowed:
        - deployments
      blocked:
        - database_migrations

    # Freeze periods
    freeze:
      dates:
        - start: &quot;2024-11-28&quot;
          end: &quot;2024-12-02&quot;
          reason: &quot;Black Friday&quot;
        - start: &quot;2024-12-20&quot;
          end: &quot;2025-01-05&quot;
          reason: &quot;Holiday freeze&quot;
      allowed:
        - hotfixes                # With P1 approval
      approval_required: p1_manager

  enforcement:
    production:
      outside_window: block
      message: |
        ðŸš« Change blocked: Outside maintenance window

        Next maintenance window: Sunday 2:00 AM UTC
        Or request emergency change approval from P1 manager

    staging:
      outside_window: warn</code></pre>
        </div>
        <p>---</p>
        <h3>Usage Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Infrastructure Change</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier --profile platform-team:infrastructure

&gt; Review this Terraform change for the payment-service database

# Automatically:
# 1. Validates Terraform syntax
# 2. Checks IaC policies
# 3. Analyzes blast radius
# 4. Checks change window
# 5. Requires approval if significant</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Incident Investigation</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier --profile platform-team:incident

&gt; payment-service is returning 500 errors

# Automatically:
# 1. Gathers recent deployments (all services)
# 2. Pulls error logs from affected services
# 3. Checks service dependencies
# 4. Correlates with metrics
# 5. Suggests runbooks
# 6. Analyzes blast radius of potential fixes</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Capacity Planning</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier --profile platform-team:capacity

&gt; Forecast capacity needs for Q2

# Uses:
# - 90-day metrics history
# - Service dependency graph
# - Current resource utilization
# - Growth projections
# Produces:
# - Resource forecasts
# - Cost projections
# - Scaling recommendations</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li>Kubernetes cluster access</li>
        <li>Terraform state backend</li>
        <li>Observability stack (Prometheus/Datadog)</li>
        <li>Log aggregation (ES/Loki)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>Service mesh (Istio/Linkerd)</li>
        <li>Tracing (Jaeger/Zipkin)</li>
        <li>Consul service discovery</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-collection-product-team" data-category="collections">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Collection Product Team</span>
            <span class="spec-category">collections</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-collection-product-team</code></p>
        </div>
        <h3>Overview</h3>
        <p>Optimized collection for product development teams building user-facing features. Focuses on feature development workflow, product quality, user feedback integration, and rapid iteration.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Context scattered across tools</td><td>Unified product context</td></tr>
            <tr><td>Feature specs lost in docs</td><td>Living specifications</td></tr>
            <tr><td>Manual acceptance testing</td><td>Automated validation</td></tr>
            <tr><td>Slow feedback loops</td><td>Rapid iteration support</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Collection Contents</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">collection:
  name: product-team
  version: &quot;1.0.0&quot;
  description: &quot;Product development toolkit&quot;

  extends: enterprise-dev          # Inherits enterprise security

  # Product-specific modules
  modules:

    # ===== TOOLS =====
    tools:
      # Product context
      - module: tool-product-context
        config:
          sources:
            jira:
              project: &quot;${JIRA_PROJECT}&quot;
              issue_types: [Story, Bug, Epic]
            figma:
              team_id: &quot;${FIGMA_TEAM}&quot;
              auto_fetch_designs: true
            confluence:
              space: &quot;${CONFLUENCE_SPACE}&quot;
              labels: [prd, spec, design]
            analytics:
              provider: amplitude
              project: &quot;${AMPLITUDE_PROJECT}&quot;

      - module: tool-user-feedback
        config:
          sources:
            zendesk:
              enabled: true
              views: [&quot;${ZENDESK_VIEWS}&quot;]
            intercom:
              enabled: true
            app_reviews:
              ios: &quot;${APP_STORE_ID}&quot;
              android: &quot;${PLAY_STORE_ID}&quot;
          sentiment_analysis: true
          auto_categorize: true

      - module: tool-feature-flag
        config:
          provider: launchdarkly     # launchdarkly | split | flagsmith
          project: &quot;${LD_PROJECT}&quot;
          environments: [development, staging, production]
          allowed_operations: [read, create, toggle]
          rollout_require_approval: true

      - module: tool-analytics-query
        config:
          providers:
            amplitude:
              api_key: &quot;${AMPLITUDE_API_KEY}&quot;
              project: &quot;${AMPLITUDE_PROJECT}&quot;
            mixpanel:
              token: &quot;${MIXPANEL_TOKEN}&quot;
          max_lookback: 90d

      - module: tool-a11y-checker
        config:
          standards: [WCAG2.1-AA]
          check_on_preview: true

      # Core development (from enterprise-dev)
      - module: tool-codebase-search
        config:
          include_figma: true
          include_specs: true

      - module: tool-test-runner
        config:
          frameworks: [jest, playwright, cypress]
          include_e2e: true
          visual_regression: true

      - module: tool-pr-context
        config:
          include_linked_issues: true
          include_figma_links: true
          include_analytics_impact: true

    # ===== HOOKS =====
    hooks:
      # Product quality
      - module: hooks-acceptance-validator
        config:
          source: jira                # Read AC from JIRA stories
          auto_check: true
          link_to_tests: true

      - module: hooks-design-diff
        config:
          figma_integration: true
          warn_on_deviation: true
          tolerance: 5px

      - module: hooks-i18n-checker
        config:
          check_hardcoded_strings: true
          check_missing_translations: true
          default_locale: en
          required_locales: [en, es, fr, de, ja]

      - module: hooks-a11y-validator
        config:
          check_on_component_write: true
          standards: [WCAG2.1-AA]
          severity: warning

      # Feature development
      - module: hooks-feature-context
        config:
          auto_load:
            - linked_story
            - acceptance_criteria
            - design_specs
            - related_feedback

      - module: hooks-flag-awareness
        config:
          detect_flag_usage: true
          warn_stale_flags: true
          stale_threshold: 30d

      # User impact
      - module: hooks-user-impact
        config:
          estimate_affected_users: true
          check_analytics_events: true
          warn_missing_tracking: true

      - module: hooks-rollout-guard
        config:
          require_staged_rollout: true
          stages: [1%, 10%, 50%, 100%]
          auto_rollback_threshold:
            error_rate_increase: 10%
            conversion_drop: 5%

      # Collaboration
      - module: hooks-design-handoff
        config:
          check_figma_status: true
          require_design_approval: true
          track_implementation_status: true

    # ===== SCENARIO TOOLS =====
    scenarios:
      - module: feature-planner
        config:
          include_user_impact: true
          include_analytics_plan: true
          output_format: [tech_spec, jira_tickets, test_plan]

      - module: pr-reviewer
        config:
          check_acceptance_criteria: true
          check_design_match: true
          check_analytics_events: true
          suggest_qa_steps: true

  # Product team profiles
  profiles:
    # Feature development
    feature:
      description: &quot;Building new features&quot;
      tools:
        - tool-product-context
        - tool-codebase-search
        - tool-feature-flag
        - tool-test-runner
      hooks:
        - hooks-feature-context
        - hooks-acceptance-validator
        - hooks-design-diff
        - hooks-i18n-checker
        - hooks-a11y-validator
        - hooks-user-impact

    # Bug fixing
    bugfix:
      description: &quot;Fixing user-reported issues&quot;
      tools:
        - tool-user-feedback
        - tool-analytics-query
        - tool-codebase-search
        - tool-test-runner
      hooks:
        - hooks-feature-context
        - hooks-user-impact

    # Feature launch
    launch:
      description: &quot;Rolling out features&quot;
      tools:
        - tool-feature-flag
        - tool-analytics-query
        - tool-a11y-checker
      hooks:
        - hooks-rollout-guard
        - hooks-flag-awareness
        - hooks-user-impact
      config:
        require_staged_rollout: true

    # Design implementation
    design:
      description: &quot;Implementing designs&quot;
      tools:
        - tool-product-context       # Figma access
        - tool-codebase-search
        - tool-a11y-checker
      hooks:
        - hooks-design-diff
        - hooks-design-handoff
        - hooks-a11y-validator
        - hooks-i18n-checker</code></pre>
        </div>
        <p>---</p>
        <h3>Product Context Tool</h3>
        <p>Unified view of all product information:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">tool-product-context:
  description: &quot;Unified product context from all sources&quot;

  sources:
    jira:
      # Pull story details
      fetch:
        - summary
        - description
        - acceptance_criteria
        - linked_issues
        - comments
        - attachments

    figma:
      # Pull design context
      fetch:
        - frames
        - components
        - design_tokens
        - comments
        - version_history

    confluence:
      # Pull specifications
      fetch:
        - prd_documents
        - technical_specs
        - decision_logs

    analytics:
      # Pull usage data
      fetch:
        - related_events
        - funnel_data
        - user_segments

  example_output: |
    ðŸ“‹ Product Context: PROJ-1234 &quot;Add dark mode toggle&quot;

    ðŸ“ Story Details:
    - Epic: User Preferences (PROJ-100)
    - Sprint: Sprint 23
    - Priority: High
    - Story Points: 5

    âœ… Acceptance Criteria:
    1. Toggle visible in settings menu
    2. Preference persists across sessions
    3. System preference detection
    4. Smooth transition animation

    ðŸŽ¨ Design:
    - Figma: Dark Mode Settings (v3.2)
    - Components: Toggle, ColorScheme
    - Design Tokens: colors.dark.*

    ðŸ“Š Analytics Context:
    - Related events: settings_opened, theme_changed
    - Current dark mode usage: 34% of users
    - Feature requests: 156 in past 90 days

    ðŸ”— Related:
    - PRD: confluence.com/dark-mode-spec
    - Tech Spec: confluence.com/dark-mode-tech
    - Related bugs: PROJ-890, PROJ-912</code></pre>
        </div>
        <p>---</p>
        <h3>Acceptance Criteria Validator</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks-acceptance-validator:
  description: &quot;Validate implementation against acceptance criteria&quot;

  process:
    # 1. Extract AC from story
    extract_from:
      - jira_description
      - jira_custom_field
      - linked_confluence

    # 2. Match to tests
    test_mapping:
      auto_detect: true
      patterns:
        - &quot;test.*should.*{criterion}&quot;
        - &quot;it.*{criterion}&quot;

    # 3. Check coverage
    report:
      - criteria_with_tests
      - criteria_without_tests
      - suggested_test_cases

  example_output: |
    âœ… Acceptance Criteria Validation

    Story: PROJ-1234 &quot;Add dark mode toggle&quot;

    Coverage Report:
    âœ… AC1: &quot;Toggle visible in settings menu&quot;
       â†’ test/settings.spec.ts:45 &quot;should show dark mode toggle&quot;

    âœ… AC2: &quot;Preference persists across sessions&quot;
       â†’ test/settings.spec.ts:67 &quot;should persist preference&quot;

    âš ï¸ AC3: &quot;System preference detection&quot;
       â†’ No matching test found
       ðŸ’¡ Suggested: Add test for prefers-color-scheme detection

    âœ… AC4: &quot;Smooth transition animation&quot;
       â†’ test/theme.spec.ts:23 &quot;should animate theme transition&quot;

    Coverage: 3/4 (75%)
    Action Required: Add test for AC3</code></pre>
        </div>
        <p>---</p>
        <h3>Design Diff Hook</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks-design-diff:
  description: &quot;Compare implementation to Figma designs&quot;

  process:
    # 1. Detect component changes
    trigger_on:
      - &quot;src/components/**/*.tsx&quot;
      - &quot;src/components/**/*.css&quot;

    # 2. Find linked Figma
    figma_linking:
      by_comment: true              # Look for Figma URLs in code
      by_story: true                # Check linked JIRA story
      by_name: true                 # Match component names

    # 3. Compare
    comparison:
      visual_diff: true
      spacing_check: true
      color_check: true
      typography_check: true
      responsive_check: true

    # 4. Report
    tolerance:
      spacing: 4px
      color: 5%                     # Color difference
      font_size: 2px

  example_output: |
    ðŸŽ¨ Design Comparison: Button.tsx

    Figma Frame: &quot;Primary Button&quot; (v3.2)

    Differences Found:
    âš ï¸ Padding: Expected 16px, found 14px (diff: 2px)
    âš ï¸ Border radius: Expected 8px, found 6px (diff: 2px)
    âœ… Colors: Match
    âœ… Typography: Match
    âœ… Hover state: Match

    Overall: 2 minor deviations
    Design approval: @sarah (designer) notified

    ðŸ’¡ Tip: Use design tokens for consistent spacing</code></pre>
        </div>
        <p>---</p>
        <h3>User Impact Analysis</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks-user-impact:
  description: &quot;Estimate user impact of changes&quot;

  analysis:
    # Affected users
    user_estimation:
      from_analytics: true
      events_to_check:
        - page_views
        - feature_usage
        - api_calls

    # Impact assessment
    impact_factors:
      - user_count
      - session_frequency
      - revenue_correlation
      - support_ticket_volume

  example_output: |
    ðŸ‘¥ User Impact Analysis

    Change: PaymentForm.tsx modifications

    Estimated Impact:
    â”œâ”€â”€ Daily Active Users: ~45,000 (12% of DAU)
    â”œâ”€â”€ Monthly Transactions: ~120,000
    â”œâ”€â”€ Revenue Touch: $2.3M/month flows through
    â””â”€â”€ Support Tickets: 34/month related to payments

    Risk Assessment: HIGH
    - Core revenue path
    - High user visibility

    Recommendations:
    1. âœ… Feature flag rollout (staged)
    2. âœ… A/B test conversion impact
    3. âœ… Monitor error rates closely
    4. âš ï¸ Consider QA sign-off</code></pre>
        </div>
        <p>---</p>
        <h3>Rollout Guard</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks-rollout-guard:
  description: &quot;Ensure safe feature rollouts&quot;

  stages:
    # Progressive rollout
    - name: canary
      percentage: 1%
      duration: 1h
      metrics:
        error_rate: &lt; 0.1%
        latency_p99: &lt; 500ms

    - name: early_adopters
      percentage: 10%
      duration: 24h
      metrics:
        error_rate: &lt; 0.5%
        conversion: &gt; -2%

    - name: wide_release
      percentage: 50%
      duration: 48h
      metrics:
        error_rate: &lt; 1%
        conversion: &gt; -1%

    - name: full_release
      percentage: 100%
      metrics:
        stable

  auto_rollback:
    triggers:
      - error_rate_spike: 10%
      - conversion_drop: 5%
      - latency_increase: 100%

    actions:
      - disable_flag
      - notify_team
      - create_incident

  example_output: |
    ðŸš€ Rollout Guard: dark-mode-enabled

    Current Stage: early_adopters (10%)
    Duration: 18h of 24h required

    Metrics:
    âœ… Error rate: 0.12% (threshold: &lt; 0.5%)
    âœ… Latency p99: 234ms (threshold: &lt; 500ms)
    âš ï¸ Conversion: -1.8% (threshold: &gt; -2%)

    Status: MONITORING
    Next stage: wide_release (50%) in 6h

    âš ï¸ Note: Conversion slightly down - monitor closely</code></pre>
        </div>
        <p>---</p>
        <h3>Feature Flag Awareness</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">hooks-flag-awareness:
  description: &quot;Track and manage feature flags in code&quot;

  detection:
    # Find flag usage
    patterns:
      - &quot;launchDarkly.variation&quot;
      - &quot;useFeatureFlag&quot;
      - &quot;isEnabled&quot;

    # Track flag lifecycle
    lifecycle:
      - created
      - in_development
      - testing
      - rolling_out
      - fully_enabled
      - cleanup_needed

  warnings:
    stale_flags:
      threshold: 30d
      message: &quot;Flag {name} has been at 100% for {days} days - consider cleanup&quot;

    unused_flags:
      threshold: 14d
      message: &quot;Flag {name} not referenced in code - may be obsolete&quot;

  example_output: |
    ðŸš© Feature Flag Status

    Active in this file: src/components/Header.tsx

    1. dark-mode-enabled (IN_DEVELOPMENT)
       Created: 5 days ago
       Rollout: 10%
       Owner: @alice

    2. new-navigation (STALE âš ï¸)
       Created: 45 days ago
       Rollout: 100% for 32 days
       ðŸ’¡ Consider removing flag and cleaning up code

    3. redesigned-header (FULLY_ENABLED)
       Rollout: 100%
       All environments enabled

    Cleanup candidates: 2 flags</code></pre>
        </div>
        <p>---</p>
        <h3>Usage Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Feature Development</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier --profile product-team:feature

&gt; Implement PROJ-1234 dark mode toggle

# Automatically loads:
# - Story details and AC
# - Figma designs
# - Related analytics
# - Existing theme code

# As you code:
# - Validates against AC
# - Compares to Figma
# - Checks i18n
# - Validates a11y</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Bug Investigation</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier --profile product-team:bugfix

&gt; Investigate checkout failures from user feedback

# Automatically:
# - Pulls related support tickets
# - Queries analytics for error patterns
# - Finds related code
# - Suggests root causes</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Feature Launch</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">amplifier --profile product-team:launch

&gt; Roll out dark mode feature

# Guides through:
# - Staged rollout setup
# - Metrics monitoring
# - A/B test configuration
# - Rollback planning</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li>JIRA/Linear for stories</li>
        <li>Analytics platform (Amplitude/Mixpanel)</li>
        <li>Feature flag service</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>Figma API access</li>
        <li>Support platform (Zendesk/Intercom)</li>
        <li>Visual testing (Percy/Chromatic)</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-api-server" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Api Server</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Foundation)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-api-server</code></p>
        </div>
        <h3>Overview</h3>
        <p>HTTP REST/GraphQL API server wrapping Amplifier capabilities. Enables any integration - web apps, automation platforms (Zapier, n8n), custom applications, and third-party tools. The foundation that enables all other integrations.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Why P0?</h4>
        <p>This is foundational infrastructure. Once an API server exists:</p>
        <li>Web Dashboard can call it</li>
        <li>Browser Extension can call it</li>
        <li>Mobile apps can call it</li>
        <li>Any third-party integration becomes possible</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>CLI-only access</td><td>HTTP API for any client</td></tr>
            <tr><td>Local execution only</td><td>Remote/hosted execution</td></tr>
            <tr><td>Manual integrations</td><td>Zapier/n8n/webhook automation</td></tr>
            <tr><td>Single-user</td><td>Multi-tenant capable</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API Server                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ REST API     â”‚  â”‚ GraphQL API  â”‚  â”‚ WebSocket    â”‚              â”‚
â”‚  â”‚ /v1/*        â”‚  â”‚ /graphql     â”‚  â”‚ /ws          â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                 â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                           â–¼                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚ Request Router  â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                           â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â–¼                 â–¼                 â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Auth       â”‚   â”‚ Rate       â”‚   â”‚ Usage      â”‚                  â”‚
â”‚  â”‚ Middleware â”‚   â”‚ Limiting   â”‚   â”‚ Tracking   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                           â”‚                                         â”‚
â”‚                           â–¼                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚ Amplifier Core  â”‚                                â”‚
â”‚                  â”‚ (Session Mgmt)  â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>API Design</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">REST API</h4>
        <p>#### Sessions</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Create session
POST /v1/sessions
{
  &quot;profile&quot;: &quot;enterprise-dev:development&quot;,
  &quot;context&quot;: {
    &quot;project&quot;: &quot;my-project&quot;,
    &quot;branch&quot;: &quot;feature/auth&quot;
  }
}

Response:
{
  &quot;session_id&quot;: &quot;sess_abc123&quot;,
  &quot;created_at&quot;: &quot;2025-01-15T10:30:00Z&quot;,
  &quot;profile&quot;: &quot;enterprise-dev:development&quot;,
  &quot;status&quot;: &quot;active&quot;
}

# Execute prompt
POST /v1/sessions/{session_id}/execute
{
  &quot;prompt&quot;: &quot;Explain the authentication flow&quot;,
  &quot;stream&quot;: false
}

Response:
{
  &quot;request_id&quot;: &quot;req_xyz789&quot;,
  &quot;response&quot;: &quot;The authentication flow works as follows...&quot;,
  &quot;usage&quot;: {
    &quot;prompt_tokens&quot;: 150,
    &quot;completion_tokens&quot;: 450,
    &quot;total_tokens&quot;: 600
  },
  &quot;tool_calls&quot;: [
    {&quot;tool&quot;: &quot;codebase-search&quot;, &quot;query&quot;: &quot;auth&quot;, &quot;results&quot;: 12}
  ]
}

# Stream execution
POST /v1/sessions/{session_id}/execute
{
  &quot;prompt&quot;: &quot;Generate a detailed report&quot;,
  &quot;stream&quot;: true
}

Response: Server-Sent Events
event: token
data: {&quot;content&quot;: &quot;The&quot;}

event: token
data: {&quot;content&quot;: &quot; report&quot;}

event: tool_call
data: {&quot;tool&quot;: &quot;search&quot;, &quot;status&quot;: &quot;started&quot;}

event: complete
data: {&quot;usage&quot;: {...}}

# Get session history
GET /v1/sessions/{session_id}/messages

# Close session
DELETE /v1/sessions/{session_id}</code></pre>
        </div>
        <p>#### Profiles & Collections</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># List profiles
GET /v1/profiles

Response:
{
  &quot;profiles&quot;: [
    {&quot;name&quot;: &quot;foundation:base&quot;, &quot;source&quot;: &quot;bundled&quot;},
    {&quot;name&quot;: &quot;enterprise-dev:development&quot;, &quot;source&quot;: &quot;collection&quot;}
  ]
}

# List collections
GET /v1/collections

# Install collection
POST /v1/collections
{
  &quot;source&quot;: &quot;git+https://github.com/org/amplifier-collection-custom@main&quot;
}</code></pre>
        </div>
        <p>#### Tools</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># List available tools
GET /v1/tools

# Execute tool directly (no session)
POST /v1/tools/{tool_name}/execute
{
  &quot;input&quot;: {...}
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">GraphQL API</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">graphql</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-graphql">type Query {
  sessions: [Session!]!
  session(id: ID!): Session
  profiles: [Profile!]!
  collections: [Collection!]!
  tools: [Tool!]!
}

type Mutation {
  createSession(profile: String!, context: JSON): Session!
  execute(sessionId: ID!, prompt: String!): ExecutionResult!
  closeSession(sessionId: ID!): Boolean!
  installCollection(source: String!): Collection!
}

type Subscription {
  executionStream(sessionId: ID!, requestId: ID!): StreamEvent!
}

type Session {
  id: ID!
  profile: String!
  status: SessionStatus!
  messages: [Message!]!
  createdAt: DateTime!
}

type ExecutionResult {
  requestId: ID!
  response: String!
  usage: Usage!
  toolCalls: [ToolCall!]!
}

type StreamEvent {
  type: EventType!
  content: String
  toolCall: ToolCall
  usage: Usage
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">WebSocket API</h4>
        <p>For real-time streaming and bidirectional communication:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">javascript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-javascript">// Connect
ws = new WebSocket(&#039;wss://api.example.com/ws&#039;);

// Authenticate
ws.send(JSON.stringify({
  type: &#039;auth&#039;,
  token: &#039;api_key_xxx&#039;
}));

// Create session
ws.send(JSON.stringify({
  type: &#039;session.create&#039;,
  profile: &#039;enterprise-dev:development&#039;
}));

// Execute with streaming
ws.send(JSON.stringify({
  type: &#039;execute&#039;,
  session_id: &#039;sess_abc123&#039;,
  prompt: &#039;Analyze this code...&#039;
}));

// Receive events
ws.onmessage = (event) =&gt; {
  const data = JSON.parse(event.data);
  switch(data.type) {
    case &#039;token&#039;:
      // Streaming token
      break;
    case &#039;tool_call&#039;:
      // Tool execution update
      break;
    case &#039;complete&#039;:
      // Execution complete
      break;
  }
};</code></pre>
        </div>
        <p>---</p>
        <h3>Authentication &amp; Authorization</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Authentication Methods</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">auth:
  methods:
    # API Key (simple)
    - type: api_key
      header: X-API-Key

    # Bearer Token (JWT)
    - type: bearer
      issuer: https://auth.example.com
      audience: amplifier-api

    # OAuth2
    - type: oauth2
      provider: github
      scopes: [read:user, repo]</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Authorization Model</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">authorization:
  # Role-based access
  roles:
    admin:
      - &quot;*&quot;
    developer:
      - &quot;sessions:*&quot;
      - &quot;profiles:read&quot;
      - &quot;tools:execute&quot;
    readonly:
      - &quot;sessions:read&quot;
      - &quot;profiles:read&quot;

  # Resource-level permissions
  resources:
    sessions:
      - create
      - read
      - execute
      - delete
    profiles:
      - read
      - write
    collections:
      - read
      - install
      - remove</code></pre>
        </div>
        <p>---</p>
        <h3>Rate Limiting &amp; Quotas</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">rate_limiting:
  # Per-user limits
  default:
    requests_per_minute: 60
    tokens_per_day: 100000
    concurrent_sessions: 5

  # Tier-based
  tiers:
    free:
      requests_per_minute: 10
      tokens_per_day: 10000
    pro:
      requests_per_minute: 100
      tokens_per_day: 500000
    enterprise:
      requests_per_minute: 1000
      tokens_per_day: unlimited

  # Response headers
  headers:
    X-RateLimit-Limit: &quot;60&quot;
    X-RateLimit-Remaining: &quot;45&quot;
    X-RateLimit-Reset: &quot;1705312800&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Server Setup (FastAPI)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># server.py
from fastapi import FastAPI, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from amplifier_core import AmplifierSession
from .auth import verify_api_key, get_current_user
from .sessions import SessionManager
from .rate_limit import RateLimiter

app = FastAPI(
    title=&quot;Amplifier API&quot;,
    version=&quot;1.0.0&quot;,
    description=&quot;HTTP API for Amplifier AI Agent Framework&quot;
)

# Middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=[&quot;*&quot;],
    allow_methods=[&quot;*&quot;],
    allow_headers=[&quot;*&quot;]
)

session_manager = SessionManager()
rate_limiter = RateLimiter()


@app.post(&quot;/v1/sessions&quot;)
async def create_session(
    request: CreateSessionRequest,
    user: User = Depends(get_current_user)
):
    &quot;&quot;&quot;Create a new Amplifier session.&quot;&quot;&quot;

    # Check rate limits
    await rate_limiter.check(user.id, &quot;sessions:create&quot;)

    # Create session
    session = await session_manager.create(
        user_id=user.id,
        profile=request.profile,
        context=request.context
    )

    return SessionResponse(
        session_id=session.id,
        created_at=session.created_at,
        profile=request.profile,
        status=&quot;active&quot;
    )


@app.post(&quot;/v1/sessions/{session_id}/execute&quot;)
async def execute(
    session_id: str,
    request: ExecuteRequest,
    user: User = Depends(get_current_user)
):
    &quot;&quot;&quot;Execute a prompt in a session.&quot;&quot;&quot;

    session = await session_manager.get(session_id, user.id)
    if not session:
        raise HTTPException(404, &quot;Session not found&quot;)

    # Check rate limits
    await rate_limiter.check(user.id, &quot;sessions:execute&quot;)

    if request.stream:
        return StreamingResponse(
            session.execute_stream(request.prompt),
            media_type=&quot;text/event-stream&quot;
        )
    else:
        result = await session.execute(request.prompt)
        return ExecutionResponse(
            request_id=result.request_id,
            response=result.response,
            usage=result.usage,
            tool_calls=result.tool_calls
        )


@app.get(&quot;/v1/profiles&quot;)
async def list_profiles(user: User = Depends(get_current_user)):
    &quot;&quot;&quot;List available profiles.&quot;&quot;&quot;

    from amplifier_profiles import ProfileLoader

    loader = ProfileLoader(search_paths=get_search_paths(user))
    profiles = loader.list_profiles()

    return {&quot;profiles&quot;: profiles}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Session Manager</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># sessions.py
from amplifier_core import AmplifierSession
from amplifier_profiles import ProfileLoader
import asyncio
from typing import AsyncIterator

class SessionManager:
    &quot;&quot;&quot;Manages Amplifier sessions for API users.&quot;&quot;&quot;

    def __init__(self):
        self.sessions: dict[str, ManagedSession] = {}
        self.cleanup_task = asyncio.create_task(self._cleanup_loop())

    async def create(
        self,
        user_id: str,
        profile: str,
        context: dict | None = None
    ) -&gt; ManagedSession:
        &quot;&quot;&quot;Create a new managed session.&quot;&quot;&quot;

        # Load profile
        loader = ProfileLoader(search_paths=self._get_paths(user_id))
        profile_config = loader.load_profile(profile)

        # Create Amplifier session
        amplifier_session = AmplifierSession(config=profile_config.to_mount_plan())
        await amplifier_session.__aenter__()

        # Wrap in managed session
        session = ManagedSession(
            id=generate_session_id(),
            user_id=user_id,
            amplifier_session=amplifier_session,
            created_at=datetime.utcnow()
        )

        self.sessions[session.id] = session
        return session

    async def get(self, session_id: str, user_id: str) -&gt; ManagedSession | None:
        &quot;&quot;&quot;Get session if owned by user.&quot;&quot;&quot;

        session = self.sessions.get(session_id)
        if session and session.user_id == user_id:
            session.last_accessed = datetime.utcnow()
            return session
        return None

    async def close(self, session_id: str, user_id: str) -&gt; bool:
        &quot;&quot;&quot;Close a session.&quot;&quot;&quot;

        session = await self.get(session_id, user_id)
        if session:
            await session.amplifier_session.__aexit__(None, None, None)
            del self.sessions[session_id]
            return True
        return False

    async def _cleanup_loop(self):
        &quot;&quot;&quot;Clean up idle sessions.&quot;&quot;&quot;

        while True:
            await asyncio.sleep(60)

            now = datetime.utcnow()
            idle_threshold = timedelta(minutes=30)

            for session_id, session in list(self.sessions.items()):
                if now - session.last_accessed &gt; idle_threshold:
                    await self.close(session_id, session.user_id)


class ManagedSession:
    &quot;&quot;&quot;Wrapper around AmplifierSession with metadata.&quot;&quot;&quot;

    def __init__(
        self,
        id: str,
        user_id: str,
        amplifier_session: AmplifierSession,
        created_at: datetime
    ):
        self.id = id
        self.user_id = user_id
        self.amplifier_session = amplifier_session
        self.created_at = created_at
        self.last_accessed = created_at
        self.messages: list[dict] = []

    async def execute(self, prompt: str) -&gt; ExecutionResult:
        &quot;&quot;&quot;Execute prompt and return result.&quot;&quot;&quot;

        self.messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: prompt})

        response = await self.amplifier_session.execute(prompt)

        self.messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: response.text})

        return ExecutionResult(
            request_id=generate_request_id(),
            response=response.text,
            usage=response.usage,
            tool_calls=response.tool_calls
        )

    async def execute_stream(self, prompt: str) -&gt; AsyncIterator[str]:
        &quot;&quot;&quot;Execute prompt with streaming.&quot;&quot;&quot;

        self.messages.append({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: prompt})

        full_response = &quot;&quot;

        async for event in self.amplifier_session.execute_stream(prompt):
            if event.type == &quot;token&quot;:
                full_response += event.content
                yield f&quot;event: token\ndata: {json.dumps({&#039;content&#039;: event.content})}\n\n&quot;
            elif event.type == &quot;tool_call&quot;:
                yield f&quot;event: tool_call\ndata: {json.dumps(event.data)}\n\n&quot;

        self.messages.append({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: full_response})

        yield f&quot;event: complete\ndata: {json.dumps({&#039;usage&#039;: event.usage})}\n\n&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Deployment Options</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Docker</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">dockerfile</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-dockerfile">FROM python:3.12-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 8000

CMD [&quot;uvicorn&quot;, &quot;amplifier_api_server:app&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8000&quot;]</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Kubernetes</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: amplifier-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: amplifier-api
  template:
    metadata:
      labels:
        app: amplifier-api
    spec:
      containers:
      - name: api
        image: amplifier-api-server:latest
        ports:
        - containerPort: 8000
        env:
        - name: AMPLIFIER_API_KEY
          valueFrom:
            secretKeyRef:
              name: amplifier-secrets
              key: api-key
        resources:
          requests:
            memory: &quot;256Mi&quot;
            cpu: &quot;250m&quot;
          limits:
            memory: &quot;1Gi&quot;
            cpu: &quot;1000m&quot;
---
apiVersion: v1
kind: Service
metadata:
  name: amplifier-api
spec:
  selector:
    app: amplifier-api
  ports:
  - port: 80
    targetPort: 8000
  type: LoadBalancer</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># config.yaml
server:
  host: 0.0.0.0
  port: 8000
  workers: 4

api:
  version: v1
  base_path: /v1

auth:
  type: api_key  # api_key | bearer | oauth2

rate_limiting:
  enabled: true
  backend: redis  # memory | redis
  redis_url: redis://localhost:6379

sessions:
  max_per_user: 10
  idle_timeout: 30m
  max_duration: 24h

logging:
  level: info
  format: json

metrics:
  enabled: true
  endpoint: /metrics

cors:
  allowed_origins: [&quot;*&quot;]
  allowed_methods: [&quot;GET&quot;, &quot;POST&quot;, &quot;DELETE&quot;]</code></pre>
        </div>
        <p>---</p>
        <h3>SDK Generation</h3>
        <p>The API is designed for automatic SDK generation:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Generate OpenAPI spec
amplifier-api-server openapi &gt; openapi.json

# Generate TypeScript SDK
npx openapi-typescript-codegen --input openapi.json --output ./sdk/typescript

# Generate Python SDK
openapi-python-client generate --path openapi.json --output ./sdk/python</code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>api:request</code></td><td>API request received</td><td>method, path, user_id</td></tr>
            <tr><td><code>api:response</code></td><td>API response sent</td><td>status, duration_ms</td></tr>
            <tr><td><code>api:error</code></td><td>API error occurred</td><td>error, status</td></tr>
            <tr><td><code>session:created</code></td><td>Session created via API</td><td>session_id, user_id</td></tr>
            <tr><td><code>session:executed</code></td><td>Prompt executed</td><td>session_id, tokens</td></tr>
            <tr><td><code>rate_limit:exceeded</code></td><td>Rate limit hit</td><td>user_id, limit</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Multi-tenancy</strong>: Shared infrastructure vs isolated?</li>
        <li><strong>Billing integration</strong>: How to track usage for billing?</li>
        <li><strong>Webhook support</strong>: Async notifications for long-running tasks?</li>
        <li><strong>File uploads</strong>: Support for file context (documents, images)?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-browser-extension" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Browser Extension</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-browser-extension</code></p>
        </div>
        <h3>Overview</h3>
        <p>Browser extension (Chrome, Firefox, Edge) providing Amplifier assistance where developers already work: GitHub PRs, GitLab MRs, Stack Overflow, documentation sites, and any web page with code. Context-aware AI assistance without leaving the browser.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Copy code to terminal, run Amplifier, copy back</td><td>Inline assistance on any page</td></tr>
            <tr><td>Context-switch between tools</td><td>AI where you already work</td></tr>
            <tr><td>Manual code review</td><td>PR review in GitHub UI</td></tr>
            <tr><td>Generic web AI</td><td>Codebase-aware with local context</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. GitHub PR Review Assistant</h4>
        <p>Inline PR review assistance directly in GitHub UI.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pull Request #234: Add payment processing                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Files changed (12)                  [Amplifier: Review PR â–¼]       â”‚
â”‚                                                                      â”‚
â”‚  src/payments/processor.ts  +142 -23                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”‚  45 â”‚   async processPayment(order: Order) {                    â”‚
â”‚  â”‚  46 â”‚+    const validated = await this.validate(order);         â”‚
â”‚  â”‚  47 â”‚+    if (!validated) {                                     â”‚
â”‚  â”‚  48 â”‚+      throw new Error(&quot;Invalid order&quot;);                   â”‚
â”‚  â”‚     â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     â”‚      â”‚ ðŸ¤– Amplifier                                     â”‚ â”‚
â”‚  â”‚     â”‚      â”‚                                                   â”‚ â”‚
â”‚  â”‚     â”‚      â”‚ âš ï¸ Generic error message may leak validation     â”‚ â”‚
â”‚  â”‚     â”‚      â”‚ details. Consider using a custom error type:     â”‚ â”‚
â”‚  â”‚     â”‚      â”‚                                                   â”‚ â”‚
â”‚  â”‚     â”‚      â”‚ ```ts                                            â”‚ â”‚
â”‚  â”‚     â”‚      â”‚ throw new ValidationError(validated.errors);     â”‚ â”‚
â”‚  â”‚     â”‚      â”‚ ```                                              â”‚ â”‚
â”‚  â”‚     â”‚      â”‚                                                   â”‚ â”‚
â”‚  â”‚     â”‚      â”‚ [Add Comment] [Dismiss] [Ask Follow-up]          â”‚ â”‚
â”‚  â”‚     â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚  49 â”‚+    }                                                     â”‚
â”‚  â”‚  50 â”‚+    return this.stripe.charge(order.total);               â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Code Explanation Popup</h4>
        <p>Select any code on any page for instant explanation.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stack Overflow: How to implement retry logic                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ const retry = async (fn, retries = 3) =&gt; {                      â”‚â”‚
â”‚  â”‚   for (let i = 0; i &lt; retries; i++) {                           â”‚â”‚
â”‚  â”‚     try {                                                        â”‚â”‚
â”‚  â”‚       return await fn();          â† [selected text]              â”‚â”‚
â”‚  â”‚     } catch (e) {                                                â”‚â”‚
â”‚  â”‚       if (i === retries - 1) throw e;                           â”‚â”‚
â”‚  â”‚       await new Promise(r =&gt; setTimeout(r, 1000 * 2 ** i));     â”‚â”‚
â”‚  â”‚     }                                                            â”‚â”‚
â”‚  â”‚   }                                                              â”‚â”‚
â”‚  â”‚ };                                                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ðŸ¤– Amplifier                                           [Ã—]    â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ This is an **exponential backoff retry** pattern:            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ â€¢ Attempts the function up to 3 times                        â”‚  â”‚
â”‚  â”‚ â€¢ On failure, waits exponentially: 1s â†’ 2s â†’ 4s              â”‚  â”‚
â”‚  â”‚ â€¢ The `2 ** i` creates the exponential growth                â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ **In your codebase**: Similar pattern in                     â”‚  â”‚
â”‚  â”‚ `src/utils/network.ts:45` but with jitter.                   â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ [Copy] [Explain More] [Find in Codebase]                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Documentation Helper</h4>
        <p>Contextual assistance when reading documentation.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React Docs: useEffect Hook                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  useEffect lets you synchronize a component with an external system.â”‚
â”‚                                                                      â”‚
â”‚  useEffect(setup, dependencies?)                                     â”‚
â”‚                                                                      â”‚
â”‚  Parameters:                                                         â”‚
â”‚  â€¢ setup: Function with your Effect&#039;s logic...                      â”‚
â”‚                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ðŸ¤– Amplifier Assistant                                    [Expand] â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â”‚                                                                  â”‚
â”‚  â”‚ In **your codebase**, useEffect is used in:                     â”‚
â”‚  â”‚                                                                  â”‚
â”‚  â”‚ â€¢ `UserDashboard.tsx` - fetching user data                      â”‚
â”‚  â”‚ â€¢ `PaymentForm.tsx` - Stripe integration                        â”‚
â”‚  â”‚ â€¢ `NotificationBell.tsx` - WebSocket subscription               â”‚
â”‚  â”‚                                                                  â”‚
â”‚  â”‚ [Show Examples] [Ask Question]                                   â”‚
â”‚  â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. GitLab MR Assistant</h4>
        <p>Same functionality for GitLab Merge Requests.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Sidebar Chat</h4>
        <p>Persistent sidebar for extended conversations.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”
â”‚  Any Web Page                                                    â”‚ ðŸ¤–â”‚
â”‚                                                                  â”‚   â”‚
â”‚  [Page content...]                                               â”‚ A â”‚
â”‚                                                                  â”‚ m â”‚
â”‚                                                                  â”‚ p â”‚
â”‚                                                                  â”‚ l â”‚
â”‚                                                                  â”‚ i â”‚
â”‚                                                                  â”‚ f â”‚
â”‚                                                                  â”‚ i â”‚
â”‚                                                                  â”‚ e â”‚
â”‚                                                                  â”‚ r â”‚
â”‚                                                                  â”‚   â”‚
â”‚                                                                  â”‚[â–¶]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜

[Click â–¶ to expand]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Any Web Page                                            â”‚ ðŸ¤– Chat   â”‚
â”‚                                                          â”‚           â”‚
â”‚  [Page content...]                                       â”‚ How does  â”‚
â”‚                                                          â”‚ this code â”‚
â”‚                                                          â”‚ compare   â”‚
â”‚                                                          â”‚ to our    â”‚
â”‚                                                          â”‚ impl?     â”‚
â”‚                                                          â”‚           â”‚
â”‚                                                          â”‚ [Send]    â”‚
â”‚                                                          â”‚           â”‚
â”‚                                                          â”‚ Based on  â”‚
â”‚                                                          â”‚ your code â”‚
â”‚                                                          â”‚ base...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Browser Extension                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Content      â”‚  â”‚ Background   â”‚  â”‚ Popup/       â”‚              â”‚
â”‚  â”‚ Scripts      â”‚  â”‚ Service      â”‚  â”‚ Sidebar      â”‚              â”‚
â”‚  â”‚ (per page)   â”‚  â”‚ Worker       â”‚  â”‚ UI           â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                 â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                           â”‚                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚ Message Bridge  â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                           â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â–¼                 â–¼                 â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Local CLI  â”‚   â”‚ API Server â”‚   â”‚ Local      â”‚                  â”‚
â”‚  â”‚ (Native    â”‚   â”‚ (Remote)   â”‚   â”‚ Storage    â”‚                  â”‚
â”‚  â”‚  Messaging)â”‚   â”‚            â”‚   â”‚            â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Site-Specific Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">GitHub Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Content script for github.com
const githubFeatures = {
  // PR review
  prReview: {
    selector: &#039;.js-diff-progressive-container&#039;,
    actions: [&#039;review_file&#039;, &#039;review_line&#039;, &#039;suggest_fix&#039;]
  },

  // Issue assistance
  issues: {
    selector: &#039;.js-issue-body&#039;,
    actions: [&#039;analyze_issue&#039;, &#039;suggest_solution&#039;, &#039;find_related&#039;]
  },

  // Code browsing
  codeView: {
    selector: &#039;.blob-code&#039;,
    actions: [&#039;explain&#039;, &#039;find_usages&#039;, &#039;suggest_improvements&#039;]
  },

  // Search enhancement
  search: {
    selector: &#039;.search-results&#039;,
    actions: [&#039;filter_by_context&#039;, &#039;explain_results&#039;]
  }
};</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">GitLab Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Content script for gitlab.com
const gitlabFeatures = {
  mrReview: {
    selector: &#039;.diff-content&#039;,
    actions: [&#039;review_file&#039;, &#039;review_line&#039;, &#039;suggest_fix&#039;]
  },

  issues: {
    selector: &#039;.description&#039;,
    actions: [&#039;analyze_issue&#039;, &#039;suggest_solution&#039;]
  },

  pipelines: {
    selector: &#039;.ci-job-trace&#039;,
    actions: [&#039;explain_failure&#039;, &#039;suggest_fix&#039;]
  }
};</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Stack Overflow Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Content script for stackoverflow.com
const stackOverflowFeatures = {
  questions: {
    selector: &#039;.question&#039;,
    actions: [&#039;relate_to_codebase&#039;, &#039;find_existing_solution&#039;]
  },

  answers: {
    selector: &#039;.answer&#039;,
    actions: [&#039;evaluate_for_codebase&#039;, &#039;adapt_to_style&#039;]
  },

  codeBlocks: {
    selector: &#039;pre code&#039;,
    actions: [&#039;explain&#039;, &#039;compare_to_codebase&#039;, &#039;adapt&#039;]
  }
};</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Manifest V3 Structure</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">// manifest.json
{
  &quot;manifest_version&quot;: 3,
  &quot;name&quot;: &quot;Amplifier&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;AI-powered code assistance in your browser&quot;,

  &quot;permissions&quot;: [
    &quot;storage&quot;,
    &quot;activeTab&quot;,
    &quot;contextMenus&quot;,
    &quot;sidePanel&quot;,
    &quot;nativeMessaging&quot;
  ],

  &quot;host_permissions&quot;: [
    &quot;https://github.com/*&quot;,
    &quot;https://gitlab.com/*&quot;,
    &quot;https://*.gitlab.io/*&quot;,
    &quot;https://stackoverflow.com/*&quot;,
    &quot;https://docs.microsoft.com/*&quot;
  ],

  &quot;background&quot;: {
    &quot;service_worker&quot;: &quot;background.js&quot;,
    &quot;type&quot;: &quot;module&quot;
  },

  &quot;content_scripts&quot;: [
    {
      &quot;matches&quot;: [&quot;https://github.com/*&quot;],
      &quot;js&quot;: [&quot;content/github.js&quot;],
      &quot;css&quot;: [&quot;content/github.css&quot;]
    },
    {
      &quot;matches&quot;: [&quot;https://gitlab.com/*&quot;, &quot;https://*.gitlab.io/*&quot;],
      &quot;js&quot;: [&quot;content/gitlab.js&quot;],
      &quot;css&quot;: [&quot;content/gitlab.css&quot;]
    },
    {
      &quot;matches&quot;: [&quot;https://stackoverflow.com/*&quot;],
      &quot;js&quot;: [&quot;content/stackoverflow.js&quot;],
      &quot;css&quot;: [&quot;content/stackoverflow.css&quot;]
    },
    {
      &quot;matches&quot;: [&quot;&lt;all_urls&gt;&quot;],
      &quot;js&quot;: [&quot;content/universal.js&quot;],
      &quot;css&quot;: [&quot;content/universal.css&quot;]
    }
  ],

  &quot;side_panel&quot;: {
    &quot;default_path&quot;: &quot;sidepanel.html&quot;
  },

  &quot;action&quot;: {
    &quot;default_popup&quot;: &quot;popup.html&quot;,
    &quot;default_icon&quot;: {
      &quot;16&quot;: &quot;icons/icon16.png&quot;,
      &quot;48&quot;: &quot;icons/icon48.png&quot;,
      &quot;128&quot;: &quot;icons/icon128.png&quot;
    }
  },

  &quot;icons&quot;: {
    &quot;16&quot;: &quot;icons/icon16.png&quot;,
    &quot;48&quot;: &quot;icons/icon48.png&quot;,
    &quot;128&quot;: &quot;icons/icon128.png&quot;
  },

  &quot;commands&quot;: {
    &quot;explain-selection&quot;: {
      &quot;suggested_key&quot;: {
        &quot;default&quot;: &quot;Ctrl+Shift+E&quot;,
        &quot;mac&quot;: &quot;Command+Shift+E&quot;
      },
      &quot;description&quot;: &quot;Explain selected code&quot;
    },
    &quot;open-sidebar&quot;: {
      &quot;suggested_key&quot;: {
        &quot;default&quot;: &quot;Ctrl+Shift+A&quot;,
        &quot;mac&quot;: &quot;Command+Shift+A&quot;
      },
      &quot;description&quot;: &quot;Open Amplifier sidebar&quot;
    }
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Background Service Worker</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// background.js
import { AmplifierClient } from &#039;./lib/client&#039;;

const client = new AmplifierClient();

// Handle messages from content scripts
chrome.runtime.onMessage.addListener((message, sender, sendResponse) =&gt; {
  if (message.type === &#039;execute&#039;) {
    handleExecute(message, sender).then(sendResponse);
    return true; // Will respond asynchronously
  }

  if (message.type === &#039;review_pr&#039;) {
    handlePRReview(message, sender).then(sendResponse);
    return true;
  }

  if (message.type === &#039;explain_code&#039;) {
    handleExplainCode(message, sender).then(sendResponse);
    return true;
  }
});

async function handleExecute(message, sender) {
  const { prompt, context } = message;

  // Add page context
  const fullContext = {
    ...context,
    url: sender.tab?.url,
    title: sender.tab?.title
  };

  try {
    const result = await client.execute({
      prompt,
      context: fullContext
    });
    return { success: true, response: result.response };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

async function handlePRReview(message, sender) {
  const { prUrl, diff } = message;

  const result = await client.execute({
    prompt: `Review this pull request for issues:\n\nURL: ${prUrl}\n\nDiff:\n${diff}`,
    profile: &#039;enterprise-dev:review&#039;,
    context: {
      type: &#039;pr_review&#039;,
      url: prUrl
    }
  });

  return { success: true, review: result.response };
}

async function handleExplainCode(message, sender) {
  const { code, language, pageContext } = message;

  const result = await client.execute({
    prompt: `Explain this ${language || &#039;code&#039;}:\n\n${code}`,
    context: {
      type: &#039;code_explanation&#039;,
      page: pageContext
    }
  });

  return { success: true, explanation: result.response };
}

// Context menu
chrome.contextMenus.create({
  id: &#039;amplifier-explain&#039;,
  title: &#039;Explain with Amplifier&#039;,
  contexts: [&#039;selection&#039;]
});

chrome.contextMenus.onClicked.addListener((info, tab) =&gt; {
  if (info.menuItemId === &#039;amplifier-explain&#039;) {
    chrome.tabs.sendMessage(tab.id, {
      type: &#039;explain_selection&#039;,
      selection: info.selectionText
    });
  }
});</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">GitHub Content Script</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// content/github.js
import { createPopup, createInlineWidget } from &#039;../lib/ui&#039;;

// Detect PR page
if (window.location.pathname.includes(&#039;/pull/&#039;)) {
  initPRReview();
}

function initPRReview() {
  // Add review button to PR header
  const prHeader = document.querySelector(&#039;.gh-header-actions&#039;);
  if (prHeader) {
    const reviewButton = document.createElement(&#039;button&#039;);
    reviewButton.className = &#039;btn btn-sm&#039;;
    reviewButton.innerHTML = &#039;ðŸ¤– Amplifier Review&#039;;
    reviewButton.onclick = startPRReview;
    prHeader.prepend(reviewButton);
  }

  // Add inline review on diff lines
  observeDiffLines();
}

async function startPRReview() {
  const prUrl = window.location.href;
  const diff = extractDiff();

  const response = await chrome.runtime.sendMessage({
    type: &#039;review_pr&#039;,
    prUrl,
    diff
  });

  if (response.success) {
    displayReviewResults(response.review);
  }
}

function observeDiffLines() {
  // Watch for diff content to load
  const observer = new MutationObserver((mutations) =&gt; {
    mutations.forEach((mutation) =&gt; {
      mutation.addedNodes.forEach((node) =&gt; {
        if (node.classList?.contains(&#039;blob-code-addition&#039;) ||
            node.classList?.contains(&#039;blob-code-deletion&#039;)) {
          addLineActions(node);
        }
      });
    });
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
}

function addLineActions(lineElement) {
  const actionButton = document.createElement(&#039;button&#039;);
  actionButton.className = &#039;amplifier-line-action&#039;;
  actionButton.innerHTML = &#039;ðŸ¤–&#039;;
  actionButton.title = &#039;Analyze with Amplifier&#039;;
  actionButton.onclick = (e) =&gt; {
    e.stopPropagation();
    analyzeLineContext(lineElement);
  };

  lineElement.prepend(actionButton);
}

async function analyzeLineContext(lineElement) {
  const code = extractLineContext(lineElement);

  const response = await chrome.runtime.sendMessage({
    type: &#039;explain_code&#039;,
    code,
    language: detectLanguage(),
    pageContext: {
      file: getCurrentFile(),
      line: getCurrentLine(lineElement),
      pr: getPRNumber()
    }
  });

  if (response.success) {
    createInlineWidget(lineElement, response.explanation);
  }
}

// Universal code selection handler
document.addEventListener(&#039;mouseup&#039;, async (e) =&gt; {
  const selection = window.getSelection().toString().trim();

  if (selection.length &gt; 10 &amp;&amp; looksLikeCode(selection)) {
    // Show quick action popup
    const popup = createPopup({
      x: e.pageX,
      y: e.pageY,
      actions: [
        { label: &#039;Explain&#039;, action: () =&gt; explainSelection(selection) },
        { label: &#039;Find in codebase&#039;, action: () =&gt; findInCodebase(selection) },
        { label: &#039;Improve&#039;, action: () =&gt; suggestImprovement(selection) }
      ]
    });
  }
});

function looksLikeCode(text) {
  // Heuristics to detect code
  const codeIndicators = [
    /function\s+\w+/,
    /const\s+\w+\s*=/,
    /let\s+\w+\s*=/,
    /var\s+\w+\s*=/,
    /class\s+\w+/,
    /import\s+.*from/,
    /=&gt;/,
    /\{\s*\n/,
    /\)\s*\{/
  ];

  return codeIndicators.some(pattern =&gt; pattern.test(text));
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Sidebar Panel</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">html</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-html">&lt;!-- sidepanel.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;sidepanel.css&quot;&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id=&quot;amplifier-sidebar&quot;&gt;
    &lt;header&gt;
      &lt;h1&gt;ðŸ¤– Amplifier&lt;/h1&gt;
      &lt;button id=&quot;settings-btn&quot;&gt;âš™ï¸&lt;/button&gt;
    &lt;/header&gt;

    &lt;div id=&quot;context-info&quot;&gt;
      &lt;span id=&quot;page-type&quot;&gt;GitHub PR&lt;/span&gt;
      &lt;span id=&quot;connection-status&quot;&gt;â— Connected&lt;/span&gt;
    &lt;/div&gt;

    &lt;div id=&quot;chat-messages&quot;&gt;&lt;/div&gt;

    &lt;div id=&quot;chat-input-container&quot;&gt;
      &lt;textarea id=&quot;chat-input&quot; placeholder=&quot;Ask about this page...&quot;&gt;&lt;/textarea&gt;
      &lt;button id=&quot;send-btn&quot;&gt;Send&lt;/button&gt;
    &lt;/div&gt;

    &lt;div id=&quot;quick-actions&quot;&gt;
      &lt;button data-action=&quot;explain-page&quot;&gt;Explain Page&lt;/button&gt;
      &lt;button data-action=&quot;review-code&quot;&gt;Review Code&lt;/button&gt;
      &lt;button data-action=&quot;find-related&quot;&gt;Find Related&lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;script src=&quot;sidepanel.js&quot; type=&quot;module&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
        </div>
        <p>---</p>
        <h3>Connection Modes</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Local CLI (Native Messaging)</h4>
        <p>Direct connection to local Amplifier CLI:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">// com.amplifier.native.json (Native messaging host)
{
  &quot;name&quot;: &quot;com.amplifier.native&quot;,
  &quot;description&quot;: &quot;Amplifier Native Messaging Host&quot;,
  &quot;path&quot;: &quot;/usr/local/bin/amplifier-native-host&quot;,
  &quot;type&quot;: &quot;stdio&quot;,
  &quot;allowed_origins&quot;: [
    &quot;chrome-extension://[extension-id]/&quot;
  ]
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. API Server (Remote)</h4>
        <p>Connect to hosted Amplifier API:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// lib/client.ts
class AmplifierClient {
  private mode: &#039;native&#039; | &#039;api&#039;;
  private apiUrl?: string;
  private apiKey?: string;

  async connect() {
    const settings = await chrome.storage.sync.get([&#039;mode&#039;, &#039;apiUrl&#039;, &#039;apiKey&#039;]);

    this.mode = settings.mode || &#039;api&#039;;
    this.apiUrl = settings.apiUrl;
    this.apiKey = settings.apiKey;
  }

  async execute(request: ExecuteRequest): Promise&lt;ExecuteResponse&gt; {
    if (this.mode === &#039;native&#039;) {
      return this.executeNative(request);
    } else {
      return this.executeApi(request);
    }
  }

  private async executeNative(request: ExecuteRequest) {
    return new Promise((resolve, reject) =&gt; {
      chrome.runtime.sendNativeMessage(
        &#039;com.amplifier.native&#039;,
        request,
        (response) =&gt; {
          if (chrome.runtime.lastError) {
            reject(new Error(chrome.runtime.lastError.message));
          } else {
            resolve(response);
          }
        }
      );
    });
  }

  private async executeApi(request: ExecuteRequest) {
    const response = await fetch(`${this.apiUrl}/v1/sessions/execute`, {
      method: &#039;POST&#039;,
      headers: {
        &#039;Content-Type&#039;: &#039;application/json&#039;,
        &#039;X-API-Key&#039;: this.apiKey
      },
      body: JSON.stringify(request)
    });

    return response.json();
  }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Extension settings
interface ExtensionSettings {
  // Connection
  mode: &#039;native&#039; | &#039;api&#039;;
  apiUrl?: string;
  apiKey?: string;

  // Features
  features: {
    githubPrReview: boolean;
    gitlabMrReview: boolean;
    codeExplanation: boolean;
    documentationHelper: boolean;
    sidebar: boolean;
  };

  // UI
  ui: {
    theme: &#039;light&#039; | &#039;dark&#039; | &#039;system&#039;;
    sidebarPosition: &#039;left&#039; | &#039;right&#039;;
    popupDelay: number;
  };

  // Privacy
  privacy: {
    sendPageContent: boolean;
    sendSelectionOnly: boolean;
    excludedDomains: string[];
  };

  // Keyboard shortcuts
  shortcuts: {
    explain: string;
    openSidebar: string;
    review: string;
  };
}</code></pre>
        </div>
        <p>---</p>
        <h3>Privacy &amp; Security</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Content Handling</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Only send what&#039;s necessary
function sanitizeContext(context: PageContext): SanitizedContext {
  return {
    // Never send full page HTML
    url: context.url,
    title: context.title,

    // Only selected code/text
    selection: context.selection,

    // Metadata only
    language: context.language,
    fileType: context.fileType,

    // No cookies, local storage, or sensitive data
  };
}

// Exclude sensitive sites
const EXCLUDED_DOMAINS = [
  &#039;mail.google.com&#039;,
  &#039;online.banking.*&#039;,
  &#039;*.1password.com&#039;,
  &#039;*.lastpass.com&#039;
];</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Permissions</h4>
        <p>Request only necessary permissions:</p>
        <li><code>activeTab</code>: Only access current tab when user invokes</li>
        <li><code>storage</code>: Save user settings</li>
        <li><code>contextMenus</code>: Right-click menu</li>
        <li><code>sidePanel</code>: Sidebar chat</li>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>extension:installed</code></td><td>Extension installed</td><td>version</td></tr>
            <tr><td><code>extension:activated</code></td><td>Extension activated on page</td><td>url, site_type</td></tr>
            <tr><td><code>pr:review_started</code></td><td>PR review initiated</td><td>pr_url</td></tr>
            <tr><td><code>code:explained</code></td><td>Code explanation shown</td><td>language, length</td></tr>
            <tr><td><code>sidebar:opened</code></td><td>Sidebar opened</td><td>page_type</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Codebase context</strong>: How to efficiently sync local codebase context?</li>
        <li><strong>Rate limiting</strong>: Per-site or global limits?</li>
        <li><strong>Offline mode</strong>: Cache explanations for offline viewing?</li>
        <li><strong>Team features</strong>: Shared reviews, team settings?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-electron-app" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Electron App</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Enhancement)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-desktop</code></p>
        </div>
        <h3>Overview</h3>
        <p>Standalone Electron desktop application for Amplifier. Full-featured GUI experience with offline capability, system tray integration, global hotkeys, native file access, and seamless local CLI integration. Cross-platform (macOS, Windows, Linux).</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Terminal-only interface</td><td>Rich GUI experience</td></tr>
            <tr><td>Must be online</td><td>Offline-capable with local models</td></tr>
            <tr><td>No system integration</td><td>Tray, hotkeys, notifications</td></tr>
            <tr><td>Web browser required</td><td>Native app performance</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Main Chat Interface</h4>
        <p>Full-featured chat with rich rendering.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš¡ Amplifier                                    â”€ â–¡ Ã—             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚               â”‚                                                   â”‚
â”‚ â”‚  Sessions     â”‚  Session: Code Analysis                          â”‚
â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  Profile: enterprise-dev â€¢ claude-sonnet         â”‚
â”‚ â”‚               â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ â”‚  â— Code       â”‚                                                   â”‚
â”‚ â”‚    Analysis   â”‚  ðŸ‘¤ You                              10:30 AM    â”‚
â”‚ â”‚               â”‚  How does the authentication system work?         â”‚
â”‚ â”‚  â—‹ PR Review  â”‚                                                   â”‚
â”‚ â”‚    #234       â”‚  ðŸ¤– Amplifier                        10:31 AM    â”‚
â”‚ â”‚               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  â—‹ Incident   â”‚  â”‚ The authentication system uses JWT tokens:  â”‚ â”‚
â”‚ â”‚    2025-01-15 â”‚  â”‚                                             â”‚ â”‚
â”‚ â”‚               â”‚  â”‚ **1. Login Flow**                           â”‚ â”‚
â”‚ â”‚  + New        â”‚  â”‚ ```typescript                               â”‚ â”‚
â”‚ â”‚               â”‚  â”‚ // src/auth/login.ts:23                     â”‚ â”‚
â”‚ â”‚               â”‚  â”‚ async function login(creds: Credentials) {  â”‚ â”‚
â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚   const user = await validate(creds);       â”‚ â”‚
â”‚ â”‚  Collections  â”‚  â”‚   return generateJWT(user);                 â”‚ â”‚
â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ }                                           â”‚ â”‚
â”‚ â”‚               â”‚  â”‚ ```                                         â”‚ â”‚
â”‚ â”‚  ðŸ“¦ enterpriseâ”‚  â”‚                                             â”‚ â”‚
â”‚ â”‚  ðŸ“¦ foundationâ”‚  â”‚ [Open in Editor] [Copy] [Explain More]      â”‚ â”‚
â”‚ â”‚               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚               â”‚                                                   â”‚
â”‚ â”‚               â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ â”‚               â”‚  â”‚ Ask about your code...              [ðŸ“Ž] [â†µ] â”‚ â”‚
â”‚ â”‚               â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. System Tray Integration</h4>
        <p>Quick access from system tray.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ¤– â† [System Tray Icon]             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ðŸ” Quick Query         âŒ˜+Space â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Recent Sessions                â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Code Analysis              â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ PR Review #234             â”‚  â”‚
â”‚  â”‚ â””â”€â”€ Incident 2025-01-15        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â—‹ Status: Connected            â”‚  â”‚
â”‚  â”‚ â—‹ Profile: enterprise-dev      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Open Amplifier                 â”‚  â”‚
â”‚  â”‚ Settings                       â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚ Quit                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Quick Query Spotlight</h4>
        <p>Global hotkey for instant queries.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">[Press âŒ˜+Space anywhere]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                      â”‚
â”‚                    ðŸ¤– Amplifier Quick Query                         â”‚
â”‚                                                                      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ How does the payment retry logic work?                     â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚    Recent:                                                           â”‚
â”‚    â€¢ What tests cover UserService?                                  â”‚
â”‚    â€¢ Explain the caching strategy                                   â”‚
â”‚    â€¢ Find dead code in src/utils                                    â”‚
â”‚                                                                      â”‚
â”‚    [â†µ to search] [âŽ‹ to close] [âŒ˜+â†µ open in main window]           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Project Workspace</h4>
        <p>Multi-project support with workspace management.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Workspaces                                                    [+]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸ“ payment-service                                              â”‚â”‚
â”‚  â”‚    /Users/dev/projects/payment-service                          â”‚â”‚
â”‚  â”‚    Profile: enterprise-dev:backend                              â”‚â”‚
â”‚  â”‚    Last active: 2 hours ago                                     â”‚â”‚
â”‚  â”‚    [Open] [Configure] [Remove]                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸ“ frontend-app                                                 â”‚â”‚
â”‚  â”‚    /Users/dev/projects/frontend-app                             â”‚â”‚
â”‚  â”‚    Profile: enterprise-dev:frontend                             â”‚â”‚
â”‚  â”‚    Last active: Yesterday                                       â”‚â”‚
â”‚  â”‚    [Open] [Configure] [Remove]                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸ“ infrastructure                                               â”‚â”‚
â”‚  â”‚    /Users/dev/projects/infra                                    â”‚â”‚
â”‚  â”‚    Profile: platform-team:terraform                             â”‚â”‚
â”‚  â”‚    Last active: 3 days ago                                      â”‚â”‚
â”‚  â”‚    [Open] [Configure] [Remove]                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  [+ Add Workspace]                                                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Offline Mode</h4>
        <p>Local model support for offline operation.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš¡ Amplifier                               [Offline Mode] â”€ â–¡ Ã—   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  âš ï¸ Offline Mode Active                                             â”‚
â”‚  Using local model: codellama-13b                                   â”‚
â”‚                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ You                                                10:30 AM    â”‚
â”‚  Explain this function:                                             â”‚
â”‚  ```ts                                                              â”‚
â”‚  function processPayment(order: Order) { ... }                      â”‚
â”‚  ```                                                                â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– Amplifier (Local)                                  10:31 AM    â”‚
â”‚  This function processes a payment for an order...                  â”‚
â”‚                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  [Reconnect] [Switch to Online]                                     â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">6. Collection Manager</h4>
        <p>Visual collection management.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Collections                                              [âš™ï¸] [+]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Installed                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ðŸ“¦ enterprise-dev                               v1.2.0   â”‚      â”‚
â”‚  â”‚    Enterprise development tools and profiles             â”‚      â”‚
â”‚  â”‚                                                          â”‚      â”‚
â”‚  â”‚    Profiles: base, development, review, ci               â”‚      â”‚
â”‚  â”‚    Agents: zen-architect, bug-hunter, code-reviewer      â”‚      â”‚
â”‚  â”‚    Tools: codebase-search, pr-context, jira-ops          â”‚      â”‚
â”‚  â”‚                                                          â”‚      â”‚
â”‚  â”‚    [Update Available: v1.3.0] [Configure] [Remove]       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ðŸ“¦ foundation                                   v2.0.0   â”‚      â”‚
â”‚  â”‚    Core profiles and base configurations                 â”‚      â”‚
â”‚  â”‚                                                          â”‚      â”‚
â”‚  â”‚    Profiles: base, minimal                               â”‚      â”‚
â”‚  â”‚    Agents: general-assistant                             â”‚      â”‚
â”‚  â”‚                                                          â”‚      â”‚
â”‚  â”‚    [Up to date]                                          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                      â”‚
â”‚  Browse Collections                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [Search collections...]                                            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Electron App                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Main Process                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ Window   â”‚ â”‚ Tray     â”‚ â”‚ Hotkey   â”‚ â”‚ IPC      â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ Manager  â”‚ â”‚ Manager  â”‚ â”‚ Manager  â”‚ â”‚ Handler  â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â”‚                           â”‚                                   â”‚   â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚  â”‚         â–¼                 â–¼                 â–¼                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ Amplifier  â”‚   â”‚ Local      â”‚   â”‚ File       â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ CLI        â”‚   â”‚ Models     â”‚   â”‚ System     â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â”‚ IPC                                   â”‚
â”‚                              â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Renderer Process                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ Chat     â”‚ â”‚ Workspaceâ”‚ â”‚Collectionâ”‚ â”‚ Settings â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ View     â”‚ â”‚ View     â”‚ â”‚ View     â”‚ â”‚ View     â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â”‚                    React + TypeScript                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Tech Stack</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">electron:
  version: 28.x
  builder: electron-builder

frontend:
  framework: React 18
  language: TypeScript
  styling: Tailwind CSS
  state: Zustand
  routing: React Router

backend:
  ipc: electron-ipc
  storage: electron-store
  cli: child_process spawn

local_models:
  runtime: llama.cpp / Ollama
  models:
    - codellama-13b
    - mistral-7b

auto_update:
  provider: electron-updater
  source: GitHub Releases</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Main Process</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/main/index.ts
import {
  app,
  BrowserWindow,
  Tray,
  Menu,
  globalShortcut,
  ipcMain,
  nativeTheme
} from &#039;electron&#039;;
import { spawn } from &#039;child_process&#039;;
import Store from &#039;electron-store&#039;;
import { autoUpdater } from &#039;electron-updater&#039;;

const store = new Store();
let mainWindow: BrowserWindow | null = null;
let tray: Tray | null = null;
let quickQueryWindow: BrowserWindow | null = null;

// App lifecycle
app.whenReady().then(() =&gt; {
  createMainWindow();
  createTray();
  registerGlobalShortcuts();
  checkForUpdates();
});

app.on(&#039;window-all-closed&#039;, () =&gt; {
  if (process.platform !== &#039;darwin&#039;) {
    app.quit();
  }
});

// Main window
function createMainWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    minWidth: 800,
    minHeight: 600,
    titleBarStyle: &#039;hiddenInset&#039;,
    webPreferences: {
      preload: path.join(__dirname, &#039;preload.js&#039;),
      contextIsolation: true,
      nodeIntegration: false
    }
  });

  if (isDev) {
    mainWindow.loadURL(&#039;http://localhost:3000&#039;);
  } else {
    mainWindow.loadFile(&#039;dist/index.html&#039;);
  }

  mainWindow.on(&#039;close&#039;, (event) =&gt; {
    if (store.get(&#039;minimizeToTray&#039;, true)) {
      event.preventDefault();
      mainWindow?.hide();
    }
  });
}

// System tray
function createTray() {
  tray = new Tray(path.join(__dirname, &#039;assets/tray-icon.png&#039;));

  const contextMenu = Menu.buildFromTemplate([
    {
      label: &#039;Quick Query&#039;,
      accelerator: &#039;CmdOrCtrl+Space&#039;,
      click: () =&gt; showQuickQuery()
    },
    { type: &#039;separator&#039; },
    {
      label: &#039;Recent Sessions&#039;,
      submenu: getRecentSessionsMenu()
    },
    { type: &#039;separator&#039; },
    {
      label: `Status: ${getConnectionStatus()}`,
      enabled: false
    },
    {
      label: `Profile: ${store.get(&#039;currentProfile&#039;, &#039;default&#039;)}`,
      enabled: false
    },
    { type: &#039;separator&#039; },
    {
      label: &#039;Open Amplifier&#039;,
      click: () =&gt; mainWindow?.show()
    },
    {
      label: &#039;Settings&#039;,
      click: () =&gt; {
        mainWindow?.show();
        mainWindow?.webContents.send(&#039;navigate&#039;, &#039;/settings&#039;);
      }
    },
    { type: &#039;separator&#039; },
    {
      label: &#039;Quit&#039;,
      click: () =&gt; app.quit()
    }
  ]);

  tray.setToolTip(&#039;Amplifier&#039;);
  tray.setContextMenu(contextMenu);

  tray.on(&#039;click&#039;, () =&gt; {
    mainWindow?.show();
  });
}

// Global shortcuts
function registerGlobalShortcuts() {
  // Quick query spotlight
  globalShortcut.register(&#039;CmdOrCtrl+Space&#039;, () =&gt; {
    showQuickQuery();
  });

  // Toggle main window
  globalShortcut.register(&#039;CmdOrCtrl+Shift+A&#039;, () =&gt; {
    if (mainWindow?.isVisible()) {
      mainWindow.hide();
    } else {
      mainWindow?.show();
    }
  });
}

// Quick query window
function showQuickQuery() {
  if (quickQueryWindow) {
    quickQueryWindow.show();
    quickQueryWindow.focus();
    return;
  }

  quickQueryWindow = new BrowserWindow({
    width: 600,
    height: 400,
    frame: false,
    transparent: true,
    alwaysOnTop: true,
    skipTaskbar: true,
    resizable: false,
    webPreferences: {
      preload: path.join(__dirname, &#039;preload.js&#039;),
      contextIsolation: true
    }
  });

  quickQueryWindow.loadFile(&#039;dist/quick-query.html&#039;);

  quickQueryWindow.on(&#039;blur&#039;, () =&gt; {
    quickQueryWindow?.hide();
  });
}

// IPC handlers
ipcMain.handle(&#039;amplifier:execute&#039;, async (event, { prompt, profile, context }) =&gt; {
  return executeAmplifier(prompt, profile, context);
});

ipcMain.handle(&#039;amplifier:execute-stream&#039;, async (event, { prompt, profile, context }) =&gt; {
  const process = spawn(&#039;amplifier&#039;, [&#039;run&#039;, &#039;--output-format&#039;, &#039;json&#039;, prompt], {
    env: { ...process.env, AMPLIFIER_PROFILE: profile }
  });

  process.stdout.on(&#039;data&#039;, (data) =&gt; {
    event.sender.send(&#039;amplifier:stream-data&#039;, data.toString());
  });

  process.on(&#039;close&#039;, (code) =&gt; {
    event.sender.send(&#039;amplifier:stream-end&#039;, { code });
  });
});

ipcMain.handle(&#039;collections:list&#039;, async () =&gt; {
  return executeAmplifierCommand([&#039;collection&#039;, &#039;list&#039;, &#039;--json&#039;]);
});

ipcMain.handle(&#039;collections:install&#039;, async (event, { source }) =&gt; {
  return executeAmplifierCommand([&#039;collection&#039;, &#039;add&#039;, source]);
});

ipcMain.handle(&#039;profiles:list&#039;, async () =&gt; {
  return executeAmplifierCommand([&#039;profile&#039;, &#039;list&#039;, &#039;--json&#039;]);
});

// Amplifier CLI wrapper
async function executeAmplifier(prompt: string, profile: string, context: any) {
  return new Promise((resolve, reject) =&gt; {
    const args = [&#039;run&#039;, &#039;--output-format&#039;, &#039;json&#039;];
    if (profile) args.push(&#039;--profile&#039;, profile);
    args.push(prompt);

    const process = spawn(&#039;amplifier&#039;, args, {
      env: {
        ...process.env,
        AMPLIFIER_CONTEXT: JSON.stringify(context)
      }
    });

    let stdout = &#039;&#039;;
    let stderr = &#039;&#039;;

    process.stdout.on(&#039;data&#039;, (data) =&gt; stdout += data);
    process.stderr.on(&#039;data&#039;, (data) =&gt; stderr += data);

    process.on(&#039;close&#039;, (code) =&gt; {
      if (code === 0) {
        resolve(JSON.parse(stdout));
      } else {
        reject(new Error(stderr));
      }
    });
  });
}

// Auto updater
function checkForUpdates() {
  autoUpdater.checkForUpdatesAndNotify();

  autoUpdater.on(&#039;update-available&#039;, () =&gt; {
    mainWindow?.webContents.send(&#039;update:available&#039;);
  });

  autoUpdater.on(&#039;update-downloaded&#039;, () =&gt; {
    mainWindow?.webContents.send(&#039;update:ready&#039;);
  });
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Preload Script</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/main/preload.ts
import { contextBridge, ipcRenderer } from &#039;electron&#039;;

contextBridge.exposeInMainWorld(&#039;amplifier&#039;, {
  // Execution
  execute: (prompt: string, profile?: string, context?: any) =&gt;
    ipcRenderer.invoke(&#039;amplifier:execute&#039;, { prompt, profile, context }),

  executeStream: (prompt: string, profile?: string, context?: any) =&gt; {
    ipcRenderer.invoke(&#039;amplifier:execute-stream&#039;, { prompt, profile, context });
    return {
      onData: (callback: (data: string) =&gt; void) =&gt; {
        ipcRenderer.on(&#039;amplifier:stream-data&#039;, (_, data) =&gt; callback(data));
      },
      onEnd: (callback: (result: any) =&gt; void) =&gt; {
        ipcRenderer.on(&#039;amplifier:stream-end&#039;, (_, result) =&gt; callback(result));
      }
    };
  },

  // Collections
  listCollections: () =&gt; ipcRenderer.invoke(&#039;collections:list&#039;),
  installCollection: (source: string) =&gt;
    ipcRenderer.invoke(&#039;collections:install&#039;, { source }),

  // Profiles
  listProfiles: () =&gt; ipcRenderer.invoke(&#039;profiles:list&#039;),

  // Navigation
  onNavigate: (callback: (path: string) =&gt; void) =&gt; {
    ipcRenderer.on(&#039;navigate&#039;, (_, path) =&gt; callback(path));
  },

  // Updates
  onUpdateAvailable: (callback: () =&gt; void) =&gt; {
    ipcRenderer.on(&#039;update:available&#039;, callback);
  },
  onUpdateReady: (callback: () =&gt; void) =&gt; {
    ipcRenderer.on(&#039;update:ready&#039;, callback);
  },
  installUpdate: () =&gt; ipcRenderer.invoke(&#039;update:install&#039;)
});</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Renderer - Chat Component</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/renderer/components/Chat.tsx
import React, { useState, useRef, useEffect } from &#039;react&#039;;
import { useStore } from &#039;../store&#039;;
import { MessageList } from &#039;./MessageList&#039;;
import { ChatInput } from &#039;./ChatInput&#039;;
import { SessionSidebar } from &#039;./SessionSidebar&#039;;

export function Chat() {
  const [input, setInput] = useState(&#039;&#039;);
  const [isStreaming, setIsStreaming] = useState(false);
  const messagesEndRef = useRef&lt;HTMLDivElement&gt;(null);

  const {
    currentSession,
    messages,
    addMessage,
    updateLastMessage,
    profile
  } = useStore();

  const handleSend = async () =&gt; {
    if (!input.trim()) return;

    const userMessage = { role: &#039;user&#039;, content: input };
    addMessage(userMessage);
    setInput(&#039;&#039;);
    setIsStreaming(true);

    // Add placeholder for assistant message
    addMessage({ role: &#039;assistant&#039;, content: &#039;&#039; });

    // Stream response
    const stream = window.amplifier.executeStream(input, profile, {
      session_id: currentSession?.id
    });

    let fullContent = &#039;&#039;;

    stream.onData((data: string) =&gt; {
      try {
        const parsed = JSON.parse(data);
        if (parsed.content) {
          fullContent += parsed.content;
          updateLastMessage({ role: &#039;assistant&#039;, content: fullContent });
        }
      } catch {
        // Partial JSON, ignore
      }
    });

    stream.onEnd(() =&gt; {
      setIsStreaming(false);
    });
  };

  useEffect(() =&gt; {
    messagesEndRef.current?.scrollIntoView({ behavior: &#039;smooth&#039; });
  }, [messages]);

  return (
    &lt;div className=&quot;flex h-full&quot;&gt;
      &lt;SessionSidebar /&gt;

      &lt;div className=&quot;flex-1 flex flex-col&quot;&gt;
        &lt;div className=&quot;flex-1 overflow-y-auto p-4&quot;&gt;
          &lt;MessageList messages={messages} isStreaming={isStreaming} /&gt;
          &lt;div ref={messagesEndRef} /&gt;
        &lt;/div&gt;

        &lt;ChatInput
          value={input}
          onChange={setInput}
          onSend={handleSend}
          disabled={isStreaming}
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Quick Query Window</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/renderer/QuickQuery.tsx
import React, { useState, useEffect } from &#039;react&#039;;

export function QuickQuery() {
  const [query, setQuery] = useState(&#039;&#039;);
  const [recentQueries, setRecentQueries] = useState&lt;string[]&gt;([]);

  useEffect(() =&gt; {
    // Load recent queries from store
    const recent = JSON.parse(localStorage.getItem(&#039;recentQueries&#039;) || &#039;[]&#039;);
    setRecentQueries(recent);

    // Focus input
    document.getElementById(&#039;query-input&#039;)?.focus();

    // Handle escape
    const handleKeyDown = (e: KeyboardEvent) =&gt; {
      if (e.key === &#039;Escape&#039;) {
        window.close();
      }
    };

    window.addEventListener(&#039;keydown&#039;, handleKeyDown);
    return () =&gt; window.removeEventListener(&#039;keydown&#039;, handleKeyDown);
  }, []);

  const handleSubmit = async (e: React.FormEvent) =&gt; {
    e.preventDefault();

    if (!query.trim()) return;

    // Save to recent
    const newRecent = [query, ...recentQueries.slice(0, 4)];
    localStorage.setItem(&#039;recentQueries&#039;, JSON.stringify(newRecent));

    // Execute and show in main window
    // For now, open main window with query
    window.amplifier.execute(query);
    window.close();
  };

  return (
    &lt;div className=&quot;quick-query-container&quot;&gt;
      &lt;div className=&quot;quick-query-header&quot;&gt;
        ðŸ¤– Amplifier Quick Query
      &lt;/div&gt;

      &lt;form onSubmit={handleSubmit}&gt;
        &lt;input
          id=&quot;query-input&quot;
          type=&quot;text&quot;
          value={query}
          onChange={(e) =&gt; setQuery(e.target.value)}
          placeholder=&quot;Ask about your code...&quot;
          className=&quot;quick-query-input&quot;
        /&gt;
      &lt;/form&gt;

      {recentQueries.length &gt; 0 &amp;&amp; (
        &lt;div className=&quot;recent-queries&quot;&gt;
          &lt;div className=&quot;recent-label&quot;&gt;Recent:&lt;/div&gt;
          {recentQueries.map((q, i) =&gt; (
            &lt;button
              key={i}
              className=&quot;recent-item&quot;
              onClick={() =&gt; {
                setQuery(q);
                handleSubmit(new Event(&#039;submit&#039;) as any);
              }}
            &gt;
              â€¢ {q}
            &lt;/button&gt;
          ))}
        &lt;/div&gt;
      )}

      &lt;div className=&quot;quick-query-footer&quot;&gt;
        [â†µ to search] [âŽ‹ to close] [âŒ˜+â†µ open in main window]
      &lt;/div&gt;
    &lt;/div&gt;
  );
}</code></pre>
        </div>
        <p>---</p>
        <h3>Offline Mode</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Local Model Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/main/local-models.ts
import { spawn } from &#039;child_process&#039;;
import path from &#039;path&#039;;

export class LocalModelManager {
  private ollamaProcess: ChildProcess | null = null;
  private modelsPath: string;

  constructor() {
    this.modelsPath = path.join(app.getPath(&#039;userData&#039;), &#039;models&#039;);
  }

  async startOllama(): Promise&lt;void&gt; {
    this.ollamaProcess = spawn(&#039;ollama&#039;, [&#039;serve&#039;], {
      env: { ...process.env, OLLAMA_MODELS: this.modelsPath }
    });
  }

  async executeLocal(prompt: string, model: string = &#039;codellama&#039;): Promise&lt;string&gt; {
    const response = await fetch(&#039;http://localhost:11434/api/generate&#039;, {
      method: &#039;POST&#039;,
      headers: { &#039;Content-Type&#039;: &#039;application/json&#039; },
      body: JSON.stringify({
        model,
        prompt,
        stream: false
      })
    });

    const data = await response.json();
    return data.response;
  }

  async downloadModel(model: string): Promise&lt;void&gt; {
    return new Promise((resolve, reject) =&gt; {
      const process = spawn(&#039;ollama&#039;, [&#039;pull&#039;, model]);
      process.on(&#039;close&#039;, (code) =&gt; {
        if (code === 0) resolve();
        else reject(new Error(`Failed to download ${model}`));
      });
    });
  }

  getAvailableModels(): string[] {
    // List downloaded models
    return [&#039;codellama&#039;, &#039;mistral&#039;];
  }

  async stop(): Promise&lt;void&gt; {
    this.ollamaProcess?.kill();
  }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Distribution</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Build Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># electron-builder.yml
appId: com.amplifier.desktop
productName: Amplifier
directories:
  output: dist
  buildResources: build

files:
  - dist/**/*
  - package.json

mac:
  category: public.app-category.developer-tools
  icon: build/icon.icns
  hardenedRuntime: true
  gatekeeperAssess: false
  entitlements: build/entitlements.mac.plist
  entitlementsInherit: build/entitlements.mac.plist
  target:
    - dmg
    - zip

win:
  icon: build/icon.ico
  target:
    - nsis
    - portable

linux:
  icon: build/icon.png
  category: Development
  target:
    - AppImage
    - deb
    - rpm

nsis:
  oneClick: false
  allowToChangeInstallationDirectory: true

publish:
  provider: github
  owner: microsoft
  repo: amplifier-desktop</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Auto-Update</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Auto-update configuration
import { autoUpdater } from &#039;electron-updater&#039;;

autoUpdater.autoDownload = true;
autoUpdater.autoInstallOnAppQuit = true;

// Check for updates every 4 hours
setInterval(() =&gt; {
  autoUpdater.checkForUpdates();
}, 4 * 60 * 60 * 1000);</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># App settings (electron-store)
settings:
  general:
    startOnLogin: true
    minimizeToTray: true
    theme: system  # light | dark | system

  shortcuts:
    quickQuery: CmdOrCtrl+Space
    toggleWindow: CmdOrCtrl+Shift+A
    newSession: CmdOrCtrl+N

  amplifier:
    defaultProfile: enterprise-dev
    cliPath: /usr/local/bin/amplifier

  offline:
    enabled: true
    defaultModel: codellama
    autoDownloadModels: true

  updates:
    autoCheck: true
    autoInstall: true</code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>desktop:query_sent</code></td><td>Query submitted</td><td>source (main/quick)</td></tr>
            <tr><td><code>desktop:session_created</code></td><td>New session</td><td>session_id, project</td></tr>
            <tr><td><code>desktop:offline_mode</code></td><td>Switched to offline</td><td>model</td></tr>
            <tr><td><code>desktop:update_installed</code></td><td>App updated</td><td>version</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Code indexing</strong>: Local embedding for offline semantic search?</li>
        <li><strong>Plugin system</strong>: Allow third-party plugins?</li>
        <li><strong>Cloud sync</strong>: Sync sessions across devices?</li>
        <li><strong>IDE integration</strong>: Deep links to open files in IDE?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-git-hooks" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Git Hooks</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-git-hooks</code></p>
        </div>
        <h3>Overview</h3>
        <p>Git hooks integration for automated AI assistance during git workflows: pre-commit review, commit message generation, pre-push validation, and merge request preparation. Zero-friction quality gates powered by Amplifier.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual code review before commit</td><td>Automated pre-commit analysis</td></tr>
            <tr><td>Writing commit messages manually</td><td>AI-generated contextual messages</td></tr>
            <tr><td>Forgetting to check before push</td><td>Automated pre-push validation</td></tr>
            <tr><td>Manual PR description writing</td><td>Auto-generated PR descriptions</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Hook Types</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Pre-Commit Hook</h4>
        <p>Analyze staged changes before commit.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># .git/hooks/pre-commit
#!/bin/bash

# Run Amplifier pre-commit analysis
amplifier hooks pre-commit

# Exit code determines if commit proceeds</code></pre>
        </div>
        <p><strong>Analysis includes:</strong></p>
        <li>Security vulnerabilities (secrets, injection risks)</li>
        <li>Code quality issues (complexity, duplication)</li>
        <li>Style violations (based on project config)</li>
        <li>Breaking changes detection</li>
        <li>Test coverage impact</li>
        <p><strong>Output:</strong></p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">ðŸ¤– Amplifier Pre-Commit Analysis
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Analyzing 3 staged files...

âœ… src/api/users.ts
   No issues found

âš ï¸  src/payments/processor.ts
   Line 45: Potential SQL injection risk
   Line 89: Missing error handling for network timeout

   Suggested fixes:
   1. Use parameterized queries (line 45)
   2. Add try-catch with timeout handling (line 89)

âŒ src/auth/login.ts
   Line 12: Hardcoded API key detected
   BLOCKING: Cannot commit secrets

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Summary: 1 blocked, 1 warning, 1 passed

[a]ccept warnings and commit
[f]ix issues (opens editor)
[c]ancel commit</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Commit-Msg Hook</h4>
        <p>Generate or enhance commit messages.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># .git/hooks/commit-msg
#!/bin/bash

# Generate commit message from staged changes
amplifier hooks commit-msg &quot;$1&quot;</code></pre>
        </div>
        <p><strong>Modes:</strong></p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Mode 1: Generate from scratch (empty message)
git commit
# â†’ Amplifier generates message based on diff

# Mode 2: Enhance existing (message provided)
git commit -m &quot;fix auth&quot;
# â†’ Amplifier expands: &quot;fix(auth): resolve token expiration handling...&quot;

# Mode 3: Validate only (with --no-enhance flag)
git commit -m &quot;WIP&quot;
# â†’ Amplifier warns about non-conventional message</code></pre>
        </div>
        <p><strong>Generated message format:</strong></p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">feat(payments): add retry logic for failed transactions

- Implement exponential backoff for Stripe API calls
- Add configurable max retry attempts (default: 3)
- Log retry attempts for debugging
- Update error handling to distinguish retryable errors

Closes #234</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Pre-Push Hook</h4>
        <p>Validate before pushing to remote.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># .git/hooks/pre-push
#!/bin/bash

# Run Amplifier pre-push validation
amplifier hooks pre-push &quot;$@&quot;</code></pre>
        </div>
        <p><strong>Validations:</strong></p>
        <li>All tests pass</li>
        <li>No WIP commits</li>
        <li>No force-push to protected branches</li>
        <li>Breaking changes require version bump</li>
        <li>Documentation updated for API changes</li>
        <p><strong>Output:</strong></p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">ðŸ¤– Amplifier Pre-Push Validation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Checking 5 commits to push to origin/main...

âœ… Tests: All 142 tests passing
âœ… Commits: No WIP or fixup commits
âœ… Branch: Not force-pushing to protected branch

âš ï¸  Breaking Changes Detected:
   - Removed `getUserById` from UserService API
   - Changed return type of `processPayment`

   Recommendations:
   1. Bump major version (currently 2.3.1 â†’ 3.0.0)
   2. Update CHANGELOG.md
   3. Add migration guide

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[p]ush anyway (with warnings)
[c]ancel push</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Prepare-Commit-Msg Hook</h4>
        <p>Prepare PR/MR descriptions.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># .git/hooks/prepare-commit-msg
#!/bin/bash

# When creating merge commit or PR
if [ &quot;$2&quot; = &quot;merge&quot; ]; then
  amplifier hooks prepare-merge &quot;$1&quot;
fi</code></pre>
        </div>
        <p><strong>Generated PR description:</strong></p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown">## Summary

This PR adds retry logic for failed payment transactions to improve
reliability when the Stripe API experiences intermittent issues.

## Changes

- **src/payments/processor.ts**: Added `RetryStrategy` class with
  exponential backoff
- **src/payments/errors.ts**: New `RetryableError` type for
  distinguishing recoverable failures
- **tests/payments/**: Added 12 new test cases for retry scenarios

## Testing

- [x] Unit tests for retry logic
- [x] Integration tests with mock Stripe API
- [ ] Manual testing in staging environment

## Related

- Closes #234
- Related to #198 (error handling improvements)

---
ðŸ¤– Generated by Amplifier</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Git Hooks System                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ pre-commit   â”‚  â”‚ commit-msg   â”‚  â”‚ pre-push     â”‚              â”‚
â”‚  â”‚ (shell)      â”‚  â”‚ (shell)      â”‚  â”‚ (shell)      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                 â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                           â–¼                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚ amplifier hooks â”‚                                â”‚
â”‚                  â”‚ (CLI command)   â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                           â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â–¼                 â–¼                 â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Git Diff   â”‚   â”‚ Config     â”‚   â”‚ Amplifier  â”‚                  â”‚
â”‚  â”‚ Analysis   â”‚   â”‚ Loading    â”‚   â”‚ Session    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Installation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Quick Setup</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Initialize hooks in current repository
amplifier hooks init

# This creates:
# - .git/hooks/pre-commit
# - .git/hooks/commit-msg
# - .git/hooks/pre-push
# - .git/hooks/prepare-commit-msg
# - .amplifier/hooks.yaml (configuration)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Manual Setup</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Install individual hooks
amplifier hooks install pre-commit
amplifier hooks install commit-msg
amplifier hooks install pre-push</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">With Husky</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">// package.json
{
  &quot;husky&quot;: {
    &quot;hooks&quot;: {
      &quot;pre-commit&quot;: &quot;amplifier hooks pre-commit&quot;,
      &quot;commit-msg&quot;: &quot;amplifier hooks commit-msg $HUSKY_GIT_PARAMS&quot;,
      &quot;pre-push&quot;: &quot;amplifier hooks pre-push&quot;
    }
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">With pre-commit framework</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># .pre-commit-config.yaml
repos:
  - repo: https://github.com/microsoft/amplifier-hooks
    rev: v1.0.0
    hooks:
      - id: amplifier-pre-commit
        name: Amplifier Pre-Commit Analysis
        stages: [commit]

      - id: amplifier-commit-msg
        name: Amplifier Commit Message
        stages: [commit-msg]</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># .amplifier/hooks.yaml
hooks:
  # Global settings
  enabled: true
  profile: enterprise-dev:hooks  # Or use default

  pre-commit:
    enabled: true
    # What to check
    checks:
      - security        # Secrets, vulnerabilities
      - quality         # Code smells, complexity
      - style           # Linting violations
      - breaking        # Breaking change detection

    # Behavior
    block_on:
      - security:critical
      - security:high

    warn_on:
      - security:medium
      - quality:high
      - breaking:any

    # Files to check
    include:
      - &quot;src/**/*.ts&quot;
      - &quot;src/**/*.py&quot;

    exclude:
      - &quot;**/*.test.ts&quot;
      - &quot;**/fixtures/**&quot;

    # Performance
    max_files: 50
    timeout: 30s

  commit-msg:
    enabled: true

    # Generation mode
    mode: enhance  # generate | enhance | validate

    # Format
    format: conventional  # conventional | angular | custom
    max_length: 72
    require_scope: false
    require_body: false

    # Enhancement
    enhance:
      expand_abbreviations: true
      add_issue_references: true
      suggest_scope: true

  pre-push:
    enabled: true

    checks:
      - tests           # Run test suite
      - wip_commits     # No WIP/fixup commits
      - force_push      # Warn on force push
      - breaking        # Breaking change validation

    # Protected branches
    protected_branches:
      - main
      - master
      - release/*

    # Require for protected branches
    require:
      - tests_pass
      - no_wip
      - changelog_updated

  prepare-commit-msg:
    enabled: true

    # When to generate
    triggers:
      - merge
      - squash

    # Template
    template: |
      ## Summary
      {summary}

      ## Changes
      {changes}

      ## Testing
      {testing}

      ---
      ðŸ¤– Generated by Amplifier</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">CLI Commands</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># amplifier_app_cli/commands/hooks.py
import click
from pathlib import Path

@click.group()
def hooks():
    &quot;&quot;&quot;Git hooks integration.&quot;&quot;&quot;
    pass


@hooks.command()
def init():
    &quot;&quot;&quot;Initialize Amplifier hooks in current repository.&quot;&quot;&quot;

    git_dir = find_git_dir()
    if not git_dir:
        click.echo(&quot;Error: Not a git repository&quot;)
        return 1

    hooks_dir = git_dir / &quot;hooks&quot;

    # Create hook scripts
    for hook_name in [&quot;pre-commit&quot;, &quot;commit-msg&quot;, &quot;pre-push&quot;, &quot;prepare-commit-msg&quot;]:
        hook_path = hooks_dir / hook_name
        hook_path.write_text(generate_hook_script(hook_name))
        hook_path.chmod(0o755)

    # Create config
    config_dir = Path.cwd() / &quot;.amplifier&quot;
    config_dir.mkdir(exist_ok=True)
    (config_dir / &quot;hooks.yaml&quot;).write_text(DEFAULT_HOOKS_CONFIG)

    click.echo(&quot;âœ… Amplifier hooks initialized&quot;)
    click.echo(f&quot;   Config: .amplifier/hooks.yaml&quot;)


@hooks.command(&quot;pre-commit&quot;)
def pre_commit():
    &quot;&quot;&quot;Run pre-commit analysis.&quot;&quot;&quot;

    config = load_hooks_config()
    if not config.get(&quot;pre-commit&quot;, {}).get(&quot;enabled&quot;, True):
        return 0

    # Get staged files
    staged_files = get_staged_files()
    if not staged_files:
        return 0

    # Filter files
    files_to_check = filter_files(staged_files, config[&quot;pre-commit&quot;])

    # Run analysis
    results = run_pre_commit_analysis(files_to_check, config[&quot;pre-commit&quot;])

    # Display results
    display_pre_commit_results(results)

    # Determine exit code
    if has_blocking_issues(results, config[&quot;pre-commit&quot;][&quot;block_on&quot;]):
        return 1

    if has_warnings(results, config[&quot;pre-commit&quot;][&quot;warn_on&quot;]):
        # Interactive prompt
        choice = click.prompt(
            &quot;[a]ccept warnings, [f]ix issues, [c]ancel&quot;,
            type=click.Choice([&quot;a&quot;, &quot;f&quot;, &quot;c&quot;])
        )
        if choice == &quot;c&quot;:
            return 1
        if choice == &quot;f&quot;:
            open_editor_with_fixes(results)
            return 1

    return 0


@hooks.command(&quot;commit-msg&quot;)
@click.argument(&quot;msg_file&quot;, type=click.Path(exists=True))
def commit_msg(msg_file: str):
    &quot;&quot;&quot;Generate or enhance commit message.&quot;&quot;&quot;

    config = load_hooks_config()
    if not config.get(&quot;commit-msg&quot;, {}).get(&quot;enabled&quot;, True):
        return 0

    # Read current message
    msg_path = Path(msg_file)
    current_msg = msg_path.read_text().strip()

    # Get staged diff
    diff = get_staged_diff()

    # Determine mode
    mode = config[&quot;commit-msg&quot;].get(&quot;mode&quot;, &quot;enhance&quot;)

    if not current_msg or mode == &quot;generate&quot;:
        # Generate new message
        new_msg = generate_commit_message(diff, config[&quot;commit-msg&quot;])
    elif mode == &quot;enhance&quot;:
        # Enhance existing
        new_msg = enhance_commit_message(current_msg, diff, config[&quot;commit-msg&quot;])
    else:
        # Validate only
        issues = validate_commit_message(current_msg, config[&quot;commit-msg&quot;])
        if issues:
            display_commit_message_issues(issues)
            return 1
        return 0

    # Write message
    msg_path.write_text(new_msg)

    # Show preview
    click.echo(f&quot;\nðŸ“ Commit message:\n{new_msg}\n&quot;)

    return 0


def generate_commit_message(diff: str, config: dict) -&gt; str:
    &quot;&quot;&quot;Generate commit message using Amplifier.&quot;&quot;&quot;

    from amplifier_core import AmplifierSession

    prompt = f&quot;&quot;&quot;Generate a commit message for this diff.

Format: {config.get(&#039;format&#039;, &#039;conventional&#039;)}
Max length (first line): {config.get(&#039;max_length&#039;, 72)}

Diff:
{diff}

Generate a clear, concise commit message following the format.
&quot;&quot;&quot;

    session_config = get_hooks_session_config(config)

    async def run():
        async with AmplifierSession(config=session_config) as session:
            response = await session.execute(prompt)
            return response.text

    return asyncio.run(run())


def run_pre_commit_analysis(files: list[Path], config: dict) -&gt; list[AnalysisResult]:
    &quot;&quot;&quot;Run pre-commit analysis on files.&quot;&quot;&quot;

    from amplifier_core import AmplifierSession

    results = []

    for file in files:
        content = file.read_text()
        diff = get_file_diff(file)

        prompt = f&quot;&quot;&quot;Analyze this code change for issues.

Check for:
{format_checks(config.get(&#039;checks&#039;, []))}

File: {file}
Language: {detect_language(file)}

Diff:
{diff}

Full file (for context):
{content}

Report any issues found with line numbers and severity.
&quot;&quot;&quot;

        session_config = get_hooks_session_config(config)

        async def run():
            async with AmplifierSession(config=session_config) as session:
                response = await session.execute(prompt)
                return parse_analysis_response(response.text, file)

        results.append(asyncio.run(run()))

    return results</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook Script Generator</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def generate_hook_script(hook_name: str) -&gt; str:
    &quot;&quot;&quot;Generate shell script for git hook.&quot;&quot;&quot;

    return f&quot;&quot;&quot;#!/bin/bash
# Amplifier {hook_name} hook
# Generated by: amplifier hooks init

# Skip if AMPLIFIER_SKIP_HOOKS is set
if [ -n &quot;$AMPLIFIER_SKIP_HOOKS&quot; ]; then
    exit 0
fi

# Check if amplifier is available
if ! command -v amplifier &amp;&gt; /dev/null; then
    echo &quot;Warning: amplifier not found, skipping hook&quot;
    exit 0
fi

# Run the hook
amplifier hooks {hook_name.replace(&#039;-&#039;, &#039;_&#039;)} &quot;$@&quot;
exit $?
&quot;&quot;&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Usage Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Basic Workflow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Make some changes
vim src/payments/processor.ts

# Stage changes
git add src/payments/processor.ts

# Commit (triggers hooks)
git commit
# â†’ Pre-commit analysis runs
# â†’ Commit message generated/enhanced
# â†’ Commit proceeds if checks pass

# Push (triggers hooks)
git push
# â†’ Pre-push validation runs
# â†’ Push proceeds if checks pass</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Skip Hooks Temporarily</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Skip all hooks
AMPLIFIER_SKIP_HOOKS=1 git commit -m &quot;WIP&quot;

# Skip specific hook
git commit --no-verify -m &quot;WIP&quot;

# Skip with reason (logged)
AMPLIFIER_SKIP_REASON=&quot;urgent hotfix&quot; git push --no-verify</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Interactive Mode</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Force interactive mode
amplifier hooks pre-commit --interactive

# Non-interactive (CI mode)
amplifier hooks pre-commit --no-interactive</code></pre>
        </div>
        <p>---</p>
        <h3>CI Integration</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">GitHub Actions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># .github/workflows/amplifier-hooks.yml
name: Amplifier Hooks

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Amplifier
        run: pip install amplifier

      - name: Run Pre-Commit Analysis
        run: |
          amplifier hooks pre-commit \
            --no-interactive \
            --output json &gt; analysis.json

      - name: Post Review Comments
        uses: actions/github-script@v7
        with:
          script: |
            const analysis = require(&#039;./analysis.json&#039;);
            // Post comments on PR</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">GitLab CI</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># .gitlab-ci.yml
amplifier-analysis:
  stage: test
  script:
    - pip install amplifier
    - amplifier hooks pre-commit --no-interactive --ci
  allow_failure: true
  artifacts:
    reports:
      codequality: amplifier-report.json</code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>hooks:pre_commit:start</code></td><td>Pre-commit started</td><td>files_count</td></tr>
            <tr><td><code>hooks:pre_commit:complete</code></td><td>Pre-commit finished</td><td>issues, blocked</td></tr>
            <tr><td><code>hooks:commit_msg:generated</code></td><td>Message generated</td><td>mode, format</td></tr>
            <tr><td><code>hooks:pre_push:start</code></td><td>Pre-push started</td><td>commits_count</td></tr>
            <tr><td><code>hooks:pre_push:complete</code></td><td>Pre-push finished</td><td>checks, passed</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Performance</strong>: Cache analysis results for unchanged files?</li>
        <li><strong>Team settings</strong>: Shared hooks config in repo vs local override?</li>
        <li><strong>Bypass logging</strong>: Track when/why hooks are bypassed?</li>
        <li><strong>Custom checks</strong>: Allow custom check plugins?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-github-actions" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Github Actions</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-integration-github-actions</code></p>
        </div>
        <h3>Overview</h3>
        <p>GitHub Actions integration for running Amplifier in CI/CD pipelines. Provides pre-built actions for code review, PR analysis, documentation generation, and custom AI-powered workflows.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual AI-assisted reviews</td><td>Automated PR feedback</td></tr>
            <tr><td>No CI/CD AI integration</td><td>Native Actions support</td></tr>
            <tr><td>Complex setup</td><td>Drop-in action</td></tr>
            <tr><td>Token management</td><td>Secure secrets handling</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Actions Available</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. amplifier/pr-review-action</h4>
        <p>Automated PR review with configurable depth.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">name: PR Review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: amplifier/pr-review-action@v1
        with:
          # Required
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional configuration
          depth: standard              # quick | standard | thorough
          checks:
            security: true
            code-quality: true
            breaking-changes: true
            test-coverage: true

          # Output
          post-comment: true
          request-changes: auto        # auto | manual | never
          fail-on-critical: true

          # Custom prompts (optional)
          custom-instructions: |
            Pay special attention to:
            - SQL injection vulnerabilities
            - Authentication bypasses
            - Our coding standards in CONTRIBUTING.md</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. amplifier/code-analysis-action</h4>
        <p>Deep code analysis without PR context.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">- uses: amplifier/code-analysis-action@v1
  with:
    anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

    # What to analyze
    paths:
      - src/
      - lib/

    # Analysis types
    analysis:
      - security
      - complexity
      - architecture
      - dependencies

    # Output
    output-format: sarif           # sarif | json | markdown
    output-file: analysis.sarif

    # Thresholds
    fail-on-high-severity: true
    complexity-threshold: 15</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. amplifier/doc-generator-action</h4>
        <p>Generate or update documentation.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">- uses: amplifier/doc-generator-action@v1
  with:
    anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

    # What to document
    source-paths:
      - src/
    output-path: docs/

    # Generation options
    mode: update                   # generate | update | verify
    types:
      - api-reference
      - code-comments
      - readme-sections

    # Git operations
    create-commit: true
    commit-message: &quot;docs: auto-update documentation&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. amplifier/custom-action</h4>
        <p>Run custom Amplifier scenarios.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">- uses: amplifier/custom-action@v1
  with:
    anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

    # Custom scenario
    scenario: ./scenarios/tech-debt-scan.yaml

    # Or inline prompt
    prompt: |
      Analyze the codebase for architectural improvements.
      Focus on the payment module.

    # Configuration
    profile: enterprise-dev
    collection: enterprise-dev

    # Output
    output-file: ${{ github.workspace }}/analysis.md</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Action structure
action.yml:
  name: &quot;Amplifier PR Review&quot;
  description: &quot;AI-powered code review&quot;

  inputs:
    github-token:
      required: true
    anthropic-api-key:
      required: true
    depth:
      default: &quot;standard&quot;
    # ... more inputs

  runs:
    using: &quot;docker&quot;
    image: &quot;ghcr.io/amplifier/actions:v1&quot;
    env:
      GITHUB_TOKEN: ${{ inputs.github-token }}
      ANTHROPIC_API_KEY: ${{ inputs.anthropic-api-key }}

# Docker image contents
FROM python:3.11-slim

# Install Amplifier
RUN pip install amplifier-cli amplifier-collection-enterprise

# Install action runner
COPY entrypoint.py /entrypoint.py
ENTRYPOINT [&quot;python&quot;, &quot;/entrypoint.py&quot;]</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># entrypoint.py - Action entry point

import os
import json
import asyncio
from pathlib import Path

from amplifier import AmplifierSession
from github import Github

async def main():
    &quot;&quot;&quot;Main action entry point.&quot;&quot;&quot;

    # Load inputs
    inputs = load_inputs()

    # Initialize GitHub client
    gh = Github(os.environ[&quot;GITHUB_TOKEN&quot;])
    repo = gh.get_repo(os.environ[&quot;GITHUB_REPOSITORY&quot;])

    # Get PR context
    pr = None
    if &quot;pull_request&quot; in os.environ.get(&quot;GITHUB_EVENT_NAME&quot;, &quot;&quot;):
        event = json.loads(Path(os.environ[&quot;GITHUB_EVENT_PATH&quot;]).read_text())
        pr = repo.get_pull(event[&quot;pull_request&quot;][&quot;number&quot;])

    # Initialize Amplifier
    config = build_config(inputs)

    async with AmplifierSession(config=config) as session:
        # Execute based on action type
        if inputs[&quot;action_type&quot;] == &quot;pr-review&quot;:
            result = await run_pr_review(session, pr, inputs)
        elif inputs[&quot;action_type&quot;] == &quot;code-analysis&quot;:
            result = await run_code_analysis(session, inputs)
        elif inputs[&quot;action_type&quot;] == &quot;doc-generator&quot;:
            result = await run_doc_generator(session, inputs)
        else:
            result = await run_custom(session, inputs)

    # Process output
    await process_output(result, gh, repo, pr, inputs)


async def run_pr_review(
    session: AmplifierSession,
    pr: PullRequest,
    inputs: dict
) -&gt; ReviewResult:
    &quot;&quot;&quot;Run PR review scenario.&quot;&quot;&quot;

    # Load PR context
    diff = pr.get_files()
    comments = pr.get_comments()

    # Build review prompt
    prompt = build_review_prompt(pr, diff, comments, inputs)

    # Execute review
    result = await session.execute(prompt)

    return ReviewResult(
        summary=result.response,
        issues=extract_issues(result),
        recommendation=extract_recommendation(result)
    )


async def process_output(
    result: Result,
    gh: Github,
    repo: Repository,
    pr: PullRequest | None,
    inputs: dict
) -&gt; None:
    &quot;&quot;&quot;Process action output.&quot;&quot;&quot;

    # Post PR comment
    if inputs.get(&quot;post_comment&quot;) and pr:
        comment_body = format_comment(result)
        pr.create_issue_comment(comment_body)

    # Request changes if configured
    if inputs.get(&quot;request_changes&quot;) == &quot;auto&quot; and pr:
        if result.has_blocking_issues:
            pr.create_review(
                body=result.summary,
                event=&quot;REQUEST_CHANGES&quot;
            )
        elif result.recommendation == &quot;approve&quot;:
            pr.create_review(
                body=result.summary,
                event=&quot;APPROVE&quot;
            )

    # Set outputs
    set_output(&quot;review-result&quot;, json.dumps(result.to_dict()))
    set_output(&quot;has-issues&quot;, str(result.has_issues).lower())

    # Fail action if critical issues
    if inputs.get(&quot;fail_on_critical&quot;) and result.has_critical_issues:
        print(f&quot;::error::Critical issues found in review&quot;)
        exit(1)

    # Write SARIF if code analysis
    if inputs.get(&quot;output_format&quot;) == &quot;sarif&quot;:
        sarif = convert_to_sarif(result)
        Path(inputs[&quot;output_file&quot;]).write_text(json.dumps(sarif))

        # Upload to GitHub Code Scanning
        upload_sarif(gh, repo, sarif)


def format_comment(result: ReviewResult) -&gt; str:
    &quot;&quot;&quot;Format result as GitHub comment.&quot;&quot;&quot;

    lines = [
        &quot;## ðŸ¤– Amplifier Code Review&quot;,
        &quot;&quot;,
        f&quot;**Recommendation**: {result.recommendation_emoji} {result.recommendation}&quot;,
        &quot;&quot;,
        &quot;### Summary&quot;,
        result.summary,
        &quot;&quot;,
    ]

    if result.issues:
        lines.extend([
            &quot;### Issues Found&quot;,
            &quot;&quot;,
        ])

        for issue in result.issues:
            emoji = {&quot;critical&quot;: &quot;ðŸ”´&quot;, &quot;high&quot;: &quot;ðŸŸ &quot;, &quot;medium&quot;: &quot;ðŸŸ¡&quot;, &quot;low&quot;: &quot;ðŸŸ¢&quot;}[issue.severity]
            lines.append(f&quot;- {emoji} **{issue.title}** ({issue.file}:{issue.line})&quot;)
            lines.append(f&quot;  {issue.description}&quot;)
            lines.append(&quot;&quot;)

    lines.extend([
        &quot;---&quot;,
        &quot;*Generated by [Amplifier](https://github.com/microsoft/amplifier)*&quot;
    ])

    return &quot;\n&quot;.join(lines)</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Reference</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">PR Review Action</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Input</th><th>Type</th><th>Required</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>github-token</code></td><td>string</td><td>Yes</td><td>-</td><td>GitHub token</td></tr>
            <tr><td><code>anthropic-api-key</code></td><td>string</td><td>Yes</td><td>-</td><td>Anthropic API key</td></tr>
            <tr><td><code>depth</code></td><td>string</td><td>No</td><td>"standard"</td><td>Review depth</td></tr>
            <tr><td><code>checks.security</code></td><td>bool</td><td>No</td><td>true</td><td>Security check</td></tr>
            <tr><td><code>checks.code-quality</code></td><td>bool</td><td>No</td><td>true</td><td>Quality check</td></tr>
            <tr><td><code>checks.breaking-changes</code></td><td>bool</td><td>No</td><td>true</td><td>Breaking changes</td></tr>
            <tr><td><code>checks.test-coverage</code></td><td>bool</td><td>No</td><td>true</td><td>Coverage check</td></tr>
            <tr><td><code>post-comment</code></td><td>bool</td><td>No</td><td>true</td><td>Post as comment</td></tr>
            <tr><td><code>request-changes</code></td><td>string</td><td>No</td><td>"auto"</td><td>Request changes behavior</td></tr>
            <tr><td><code>fail-on-critical</code></td><td>bool</td><td>No</td><td>true</td><td>Fail on critical</td></tr>
            <tr><td><code>custom-instructions</code></td><td>string</td><td>No</td><td>""</td><td>Custom review instructions</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Outputs</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Output</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>review-result</code></td><td>JSON result object</td></tr>
            <tr><td><code>has-issues</code></td><td>Whether issues were found</td></tr>
            <tr><td><code>recommendation</code></td><td>approve/request_changes/comment</td></tr>
            <tr><td><code>issue-count</code></td><td>Number of issues</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Secret Handling</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Required secrets (set in repo settings)
secrets:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

# Optional: Use GitHub App for enhanced permissions
secrets:
  APP_ID: ${{ secrets.AMPLIFIER_APP_ID }}
  APP_PRIVATE_KEY: ${{ secrets.AMPLIFIER_APP_PRIVATE_KEY }}

# Token permissions
permissions:
  contents: read
  pull-requests: write
  security-events: write  # For SARIF upload</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Rate Limiting</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Built-in rate limiting
rate-limiting:
  max-reviews-per-hour: 10
  max-tokens-per-review: 50000
  concurrent-reviews: 3</code></pre>
        </div>
        <p>---</p>
        <h3>Example Workflows</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Complete PR Pipeline</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">name: PR Pipeline
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    outputs:
      has-issues: ${{ steps.review.outputs.has-issues }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: review
        uses: amplifier/pr-review-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          depth: thorough
          fail-on-critical: false  # Don&#039;t fail yet

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: review-results.sarif

  security-gate:
    needs: review
    if: needs.review.outputs.has-issues == &#039;true&#039;
    runs-on: ubuntu-latest
    steps:
      - name: Security Review Required
        run: |
          echo &quot;::warning::AI review found issues - security team review required&quot;
          # Could notify security team via Slack, etc.</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Scheduled Analysis</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">name: Weekly Code Health
on:
  schedule:
    - cron: &#039;0 8 * * 1&#039;  # Monday 8 AM

jobs:
  analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: amplifier/code-analysis-action@v1
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          paths: [src/]
          analysis: [security, complexity, architecture]
          output-format: markdown
          output-file: reports/weekly-health.md

      - name: Create Issue
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require(&#039;fs&#039;);
            const report = fs.readFileSync(&#039;reports/weekly-health.md&#039;, &#039;utf8&#039;);
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Weekly Code Health Report - ${new Date().toISOString().split(&#039;T&#039;)[0]}`,
              body: report,
              labels: [&#039;code-health&#039;, &#039;automated&#039;]
            });</code></pre>
        </div>
        <p>---</p>
        <h3>Self-Hosted Runner Support</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># For enterprise with self-hosted runners
jobs:
  review:
    runs-on: self-hosted
    container:
      image: ghcr.io/amplifier/actions:v1
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: amplifier/pr-review-action@v1
        with:
          # Use Azure OpenAI instead of Anthropic
          provider: azure-openai
          azure-endpoint: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          azure-api-key: ${{ secrets.AZURE_OPENAI_KEY }}</code></pre>
        </div>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-mobile-companion" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Mobile Companion</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Enhancement)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-mobile</code></p>
        </div>
        <h3>Overview</h3>
        <p>Mobile companion app (iOS/Android) for Amplifier. Quick queries on the go, notification handling for CI/CD events, code review approvals, and session continuity between desktop and mobile.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Must be at desk for queries</td><td>Quick answers anywhere</td></tr>
            <tr><td>Miss CI alerts until back</td><td>Real-time notifications</td></tr>
            <tr><td>PR reviews wait for desktop</td><td>Approve/comment from phone</td></tr>
            <tr><td>Context lost between devices</td><td>Seamless session continuity</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Quick Query Interface</h4>
        <p>Fast, voice-enabled queries about your codebase.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Amplifier                        âš™ï¸   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸŽ¤ &quot;How does auth work?&quot;           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  Recent Queries                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ How does payment retry work?        â”‚â”‚
â”‚  â”‚ 2 hours ago â€¢ myproject            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ What tests cover UserService?       â”‚â”‚
â”‚  â”‚ Yesterday â€¢ myproject              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Explain the caching strategy        â”‚â”‚
â”‚  â”‚ 2 days ago â€¢ other-project         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚                                         â”‚
â”‚  [Projects â–¼]           [ðŸŽ¤ Ask]       â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Query Results View</h4>
        <p>Mobile-optimized response display.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Query Results                    ðŸ“‹   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  How does authentication work?          â”‚
â”‚  myproject â€¢ Just now                   â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  The auth system uses JWT tokens:       â”‚
â”‚                                         â”‚
â”‚  **1. Login Flow**                      â”‚
â”‚  User credentials validated against     â”‚
â”‚  database, JWT issued with 24h expiry.  â”‚
â”‚                                         â”‚
â”‚  ðŸ“„ src/auth/login.ts:23               â”‚
â”‚                                         â”‚
â”‚  **2. Token Validation**                â”‚
â”‚  Middleware extracts and validates      â”‚
â”‚  token on each request.                 â”‚
â”‚                                         â”‚
â”‚  ðŸ“„ src/auth/middleware.ts:45          â”‚
â”‚                                         â”‚
â”‚  **3. Refresh Logic**                   â”‚
â”‚  Tokens refreshed automatically before  â”‚
â”‚  expiration via refresh endpoint.       â”‚
â”‚                                         â”‚
â”‚  ðŸ“„ src/auth/refresh.ts:12             â”‚
â”‚                                         â”‚
â”‚  [View on Desktop] [Share] [Copy]       â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Notification Center</h4>
        <p>CI/CD alerts, PR updates, and system notifications.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Notifications                   Clear â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Today                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ âŒ Build Failed                     â”‚â”‚
â”‚  â”‚ myproject â€¢ main â€¢ 10 min ago       â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ Test suite failed: 3 failures       â”‚â”‚
â”‚  â”‚ [View Details] [Ask Amplifier]      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸ”” Review Requested                 â”‚â”‚
â”‚  â”‚ PR #234 â€¢ @alice â€¢ 30 min ago       â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ &quot;Add payment retry logic&quot;           â”‚â”‚
â”‚  â”‚ [Quick Review] [Open PR]            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ âœ… Deploy Complete                  â”‚â”‚
â”‚  â”‚ myproject â€¢ staging â€¢ 1 hour ago    â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ v2.3.1 deployed successfully        â”‚â”‚
â”‚  â”‚ [View Logs]                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  Yesterday                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ...                                    â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Quick PR Review</h4>
        <p>Mobile-optimized PR review interface.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† PR #234                         ðŸ”—    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Add payment retry logic                â”‚
â”‚  @alice â†’ main â€¢ +142 -23              â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  ðŸ¤– Amplifier Summary                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  This PR adds exponential backoff       â”‚
â”‚  retry logic for Stripe API calls.      â”‚
â”‚                                         â”‚
â”‚  **Key Changes:**                       â”‚
â”‚  â€¢ New RetryStrategy class              â”‚
â”‚  â€¢ 3 retries with 1s base delay         â”‚
â”‚  â€¢ Jitter to prevent thundering herd    â”‚
â”‚                                         â”‚
â”‚  **Concerns:**                          â”‚
â”‚  âš ï¸ Missing test for max retry case    â”‚
â”‚  âš ï¸ Consider adding circuit breaker    â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  Files (3)                              â”‚
â”‚  â”œâ”€â”€ src/payments/processor.ts  +45    â”‚
â”‚  â”œâ”€â”€ src/payments/retry.ts      +89    â”‚
â”‚  â””â”€â”€ tests/payments/retry.test.ts +8   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [âœ… Approve] [ðŸ’¬ Comment] [âŒ Deny] â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Session Continuity</h4>
        <p>Continue desktop sessions on mobile.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Active Sessions                  ðŸ”„   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Desktop Sessions                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸ’» MacBook Pro                      â”‚â”‚
â”‚  â”‚ myproject â€¢ Active now              â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ &quot;Analyzing payment module...&quot;       â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ [Continue Here] [View Only]         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸ–¥ï¸ Work Desktop                     â”‚â”‚
â”‚  â”‚ other-project â€¢ 2 hours ago         â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ Last: &quot;Generate API docs&quot;           â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ [Resume] [View History]             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  Mobile Sessions                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸ“± This Device                      â”‚â”‚
â”‚  â”‚ myproject â€¢ 10 min ago              â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ [New Session] [Continue]            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Mobile App                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    React Native / Flutter                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ Query    â”‚ â”‚ Notifi-  â”‚ â”‚ PR       â”‚ â”‚ Session  â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ Screen   â”‚ â”‚ cations  â”‚ â”‚ Review   â”‚ â”‚ Manager  â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚ Amplifier SDK     â”‚                            â”‚
â”‚                    â”‚ (TypeScript)      â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                              â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â–¼                    â–¼                    â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ API Server â”‚      â”‚ Push       â”‚      â”‚ Local      â”‚            â”‚
â”‚  â”‚            â”‚      â”‚ Service    â”‚      â”‚ Storage    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Tech Stack</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">app:
  framework: React Native  # or Flutter
  language: TypeScript
  state: Zustand
  navigation: React Navigation

api:
  client: Generated from OpenAPI
  auth: OAuth2 + Biometric

notifications:
  ios: APNs
  android: FCM

offline:
  storage: AsyncStorage / SQLite
  sync: Background sync API

voice:
  ios: Speech Framework
  android: SpeechRecognizer</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">App Structure (React Native)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">src/
â”œâ”€â”€ App.tsx
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ HomeScreen.tsx
â”‚   â”œâ”€â”€ QueryScreen.tsx
â”‚   â”œâ”€â”€ QueryResultScreen.tsx
â”‚   â”œâ”€â”€ NotificationsScreen.tsx
â”‚   â”œâ”€â”€ PRReviewScreen.tsx
â”‚   â”œâ”€â”€ SessionsScreen.tsx
â”‚   â””â”€â”€ SettingsScreen.tsx
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ QueryInput.tsx
â”‚   â”œâ”€â”€ QueryResult.tsx
â”‚   â”œâ”€â”€ NotificationCard.tsx
â”‚   â”œâ”€â”€ PRSummary.tsx
â”‚   â”œâ”€â”€ SessionCard.tsx
â”‚   â””â”€â”€ VoiceButton.tsx
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ amplifier.ts
â”‚   â”œâ”€â”€ notifications.ts
â”‚   â”œâ”€â”€ voice.ts
â”‚   â””â”€â”€ sync.ts
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ queryStore.ts
â”‚   â”œâ”€â”€ notificationStore.ts
â”‚   â””â”€â”€ sessionStore.ts
â””â”€â”€ utils/
    â”œâ”€â”€ api.ts
    â””â”€â”€ storage.ts</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Query Screen</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// screens/QueryScreen.tsx
import React, { useState } from &#039;react&#039;;
import {
  View,
  TextInput,
  FlatList,
  TouchableOpacity,
  Text,
  StyleSheet
} from &#039;react-native&#039;;
import { useNavigation } from &#039;@react-navigation/native&#039;;
import { VoiceButton } from &#039;../components/VoiceButton&#039;;
import { useQueryStore } from &#039;../stores/queryStore&#039;;
import { amplifier } from &#039;../services/amplifier&#039;;

export function QueryScreen() {
  const [query, setQuery] = useState(&#039;&#039;);
  const [isLoading, setIsLoading] = useState(false);
  const navigation = useNavigation();
  const { recentQueries, addQuery } = useQueryStore();

  const handleSubmit = async () =&gt; {
    if (!query.trim()) return;

    setIsLoading(true);
    try {
      const result = await amplifier.execute({
        prompt: query,
        context: { type: &#039;mobile_query&#039; }
      });

      addQuery({
        query,
        result: result.response,
        timestamp: new Date(),
        project: amplifier.currentProject
      });

      navigation.navigate(&#039;QueryResult&#039;, { result });
    } finally {
      setIsLoading(false);
    }
  };

  const handleVoiceResult = (transcript: string) =&gt; {
    setQuery(transcript);
    // Auto-submit voice queries
    handleSubmit();
  };

  return (
    &lt;View style={styles.container}&gt;
      &lt;View style={styles.inputContainer}&gt;
        &lt;TextInput
          style={styles.input}
          value={query}
          onChangeText={setQuery}
          placeholder=&quot;Ask about your codebase...&quot;
          multiline
          returnKeyType=&quot;send&quot;
          onSubmitEditing={handleSubmit}
        /&gt;
        &lt;VoiceButton onResult={handleVoiceResult} /&gt;
      &lt;/View&gt;

      &lt;Text style={styles.sectionTitle}&gt;Recent Queries&lt;/Text&gt;

      &lt;FlatList
        data={recentQueries}
        keyExtractor={item =&gt; item.id}
        renderItem={({ item }) =&gt; (
          &lt;TouchableOpacity
            style={styles.recentItem}
            onPress={() =&gt; navigation.navigate(&#039;QueryResult&#039;, { result: item })}
          &gt;
            &lt;Text style={styles.queryText}&gt;{item.query}&lt;/Text&gt;
            &lt;Text style={styles.metaText}&gt;
              {item.project} â€¢ {formatTimeAgo(item.timestamp)}
            &lt;/Text&gt;
          &lt;/TouchableOpacity&gt;
        )}
      /&gt;

      &lt;TouchableOpacity
        style={[styles.askButton, isLoading &amp;&amp; styles.askButtonDisabled]}
        onPress={handleSubmit}
        disabled={isLoading}
      &gt;
        &lt;Text style={styles.askButtonText}&gt;
          {isLoading ? &#039;Asking...&#039; : &#039;ðŸŽ¤ Ask&#039;}
        &lt;/Text&gt;
      &lt;/TouchableOpacity&gt;
    &lt;/View&gt;
  );
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Voice Input Component</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// components/VoiceButton.tsx
import React, { useState } from &#039;react&#039;;
import { TouchableOpacity, StyleSheet, Animated } from &#039;react-native&#039;;
import Voice from &#039;@react-native-voice/voice&#039;;

interface VoiceButtonProps {
  onResult: (transcript: string) =&gt; void;
}

export function VoiceButton({ onResult }: VoiceButtonProps) {
  const [isListening, setIsListening] = useState(false);
  const pulseAnim = new Animated.Value(1);

  const startListening = async () =&gt; {
    setIsListening(true);

    // Start pulse animation
    Animated.loop(
      Animated.sequence([
        Animated.timing(pulseAnim, {
          toValue: 1.2,
          duration: 500,
          useNativeDriver: true
        }),
        Animated.timing(pulseAnim, {
          toValue: 1,
          duration: 500,
          useNativeDriver: true
        })
      ])
    ).start();

    Voice.onSpeechResults = (e) =&gt; {
      const transcript = e.value?.[0] || &#039;&#039;;
      stopListening();
      onResult(transcript);
    };

    Voice.onSpeechError = () =&gt; {
      stopListening();
    };

    await Voice.start(&#039;en-US&#039;);
  };

  const stopListening = async () =&gt; {
    setIsListening(false);
    pulseAnim.stopAnimation();
    await Voice.stop();
  };

  return (
    &lt;Animated.View style={{ transform: [{ scale: pulseAnim }] }}&gt;
      &lt;TouchableOpacity
        style={[
          styles.voiceButton,
          isListening &amp;&amp; styles.voiceButtonActive
        ]}
        onPress={isListening ? stopListening : startListening}
      &gt;
        &lt;Text style={styles.voiceIcon}&gt;ðŸŽ¤&lt;/Text&gt;
      &lt;/TouchableOpacity&gt;
    &lt;/Animated.View&gt;
  );
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Notification Service</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// services/notifications.ts
import messaging from &#039;@react-native-firebase/messaging&#039;;
import PushNotification from &#039;react-native-push-notification&#039;;
import { amplifier } from &#039;./amplifier&#039;;

export class NotificationService {
  async initialize() {
    // Request permission
    const authStatus = await messaging().requestPermission();

    if (authStatus === messaging.AuthorizationStatus.AUTHORIZED) {
      // Get FCM token
      const token = await messaging().getToken();
      await this.registerToken(token);

      // Handle token refresh
      messaging().onTokenRefresh(token =&gt; this.registerToken(token));

      // Handle foreground messages
      messaging().onMessage(async remoteMessage =&gt; {
        this.handleNotification(remoteMessage);
      });

      // Handle background messages
      messaging().setBackgroundMessageHandler(async remoteMessage =&gt; {
        this.handleNotification(remoteMessage);
      });
    }
  }

  async registerToken(token: string) {
    await amplifier.api.post(&#039;/v1/notifications/register&#039;, {
      token,
      platform: Platform.OS
    });
  }

  handleNotification(message: any) {
    const { type, data } = message.data;

    switch (type) {
      case &#039;build_failed&#039;:
        PushNotification.localNotification({
          title: &#039;âŒ Build Failed&#039;,
          message: `${data.project} â€¢ ${data.branch}`,
          data: { type, ...data }
        });
        break;

      case &#039;review_requested&#039;:
        PushNotification.localNotification({
          title: &#039;ðŸ”” Review Requested&#039;,
          message: `PR #${data.pr_number}: ${data.title}`,
          data: { type, ...data }
        });
        break;

      case &#039;deploy_complete&#039;:
        PushNotification.localNotification({
          title: &#039;âœ… Deploy Complete&#039;,
          message: `${data.project} â€¢ ${data.environment}`,
          data: { type, ...data }
        });
        break;
    }
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">PR Review Screen</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// screens/PRReviewScreen.tsx
import React, { useState, useEffect } from &#039;react&#039;;
import {
  View,
  ScrollView,
  Text,
  TouchableOpacity,
  TextInput,
  StyleSheet
} from &#039;react-native&#039;;
import { amplifier } from &#039;../services/amplifier&#039;;

export function PRReviewScreen({ route }) {
  const { prNumber, repoUrl } = route.params;
  const [pr, setPR] = useState(null);
  const [aiSummary, setAISummary] = useState(null);
  const [comment, setComment] = useState(&#039;&#039;);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() =&gt; {
    loadPR();
  }, []);

  const loadPR = async () =&gt; {
    setIsLoading(true);

    // Load PR details
    const prData = await amplifier.api.get(`/v1/github/pr/${prNumber}`);
    setPR(prData);

    // Get AI summary
    const summary = await amplifier.execute({
      prompt: `Summarize this PR for mobile review:\n\n${prData.diff}`,
      profile: &#039;enterprise-dev:mobile-review&#039;
    });
    setAISummary(summary.response);

    setIsLoading(false);
  };

  const handleApprove = async () =&gt; {
    await amplifier.api.post(`/v1/github/pr/${prNumber}/approve`, {
      comment: comment || &#039;Approved via Amplifier Mobile&#039;
    });
    navigation.goBack();
  };

  const handleComment = async () =&gt; {
    await amplifier.api.post(`/v1/github/pr/${prNumber}/comment`, {
      body: comment
    });
    setComment(&#039;&#039;);
  };

  const handleRequestChanges = async () =&gt; {
    await amplifier.api.post(`/v1/github/pr/${prNumber}/request-changes`, {
      comment
    });
    navigation.goBack();
  };

  if (isLoading) {
    return &lt;LoadingScreen /&gt;;
  }

  return (
    &lt;ScrollView style={styles.container}&gt;
      &lt;View style={styles.header}&gt;
        &lt;Text style={styles.title}&gt;{pr.title}&lt;/Text&gt;
        &lt;Text style={styles.meta}&gt;
          @{pr.author} â†’ {pr.base} â€¢ +{pr.additions} -{pr.deletions}
        &lt;/Text&gt;
      &lt;/View&gt;

      &lt;View style={styles.aiSummary}&gt;
        &lt;Text style={styles.sectionTitle}&gt;ðŸ¤– Amplifier Summary&lt;/Text&gt;
        &lt;Text style={styles.summaryText}&gt;{aiSummary}&lt;/Text&gt;
      &lt;/View&gt;

      &lt;View style={styles.files}&gt;
        &lt;Text style={styles.sectionTitle}&gt;Files ({pr.files.length})&lt;/Text&gt;
        {pr.files.map(file =&gt; (
          &lt;TouchableOpacity
            key={file.path}
            style={styles.fileItem}
            onPress={() =&gt; navigation.navigate(&#039;FileDiff&#039;, { file })}
          &gt;
            &lt;Text style={styles.fileName}&gt;{file.path}&lt;/Text&gt;
            &lt;Text style={styles.fileChanges}&gt;+{file.additions}&lt;/Text&gt;
          &lt;/TouchableOpacity&gt;
        ))}
      &lt;/View&gt;

      &lt;View style={styles.commentBox}&gt;
        &lt;TextInput
          style={styles.commentInput}
          value={comment}
          onChangeText={setComment}
          placeholder=&quot;Add a comment...&quot;
          multiline
        /&gt;
      &lt;/View&gt;

      &lt;View style={styles.actions}&gt;
        &lt;TouchableOpacity
          style={[styles.actionButton, styles.approveButton]}
          onPress={handleApprove}
        &gt;
          &lt;Text style={styles.actionButtonText}&gt;âœ… Approve&lt;/Text&gt;
        &lt;/TouchableOpacity&gt;

        &lt;TouchableOpacity
          style={[styles.actionButton, styles.commentButton]}
          onPress={handleComment}
        &gt;
          &lt;Text style={styles.actionButtonText}&gt;ðŸ’¬ Comment&lt;/Text&gt;
        &lt;/TouchableOpacity&gt;

        &lt;TouchableOpacity
          style={[styles.actionButton, styles.denyButton]}
          onPress={handleRequestChanges}
        &gt;
          &lt;Text style={styles.actionButtonText}&gt;âŒ Request Changes&lt;/Text&gt;
        &lt;/TouchableOpacity&gt;
      &lt;/View&gt;
    &lt;/ScrollView&gt;
  );
}</code></pre>
        </div>
        <p>---</p>
        <h3>Notification Types</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Type</th><th>Trigger</th><th>Actions</th></tr>
          </thead>
          <tbody>
            <tr><td><code>build_failed</code></td><td>CI build fails</td><td>View details, Ask Amplifier</td></tr>
            <tr><td><code>build_success</code></td><td>CI build passes</td><td>View logs</td></tr>
            <tr><td><code>review_requested</code></td><td>PR review assigned</td><td>Quick review, Open PR</td></tr>
            <tr><td><code>review_approved</code></td><td>PR approved</td><td>View PR</td></tr>
            <tr><td><code>deploy_started</code></td><td>Deployment begins</td><td>View progress</td></tr>
            <tr><td><code>deploy_complete</code></td><td>Deployment finishes</td><td>View logs</td></tr>
            <tr><td><code>deploy_failed</code></td><td>Deployment fails</td><td>View error, Ask Amplifier</td></tr>
            <tr><td><code>mention</code></td><td>Mentioned in comment</td><td>View context, Reply</td></tr>
            <tr><td><code>session_update</code></td><td>Desktop session update</td><td>Continue session</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Offline Support</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Offline-first architecture
const offlineConfig = {
  // Cache queries for offline viewing
  queryCaching: {
    enabled: true,
    maxItems: 100,
    maxAge: &#039;7d&#039;
  },

  // Queue actions when offline
  actionQueue: {
    enabled: true,
    syncOnReconnect: true
  },

  // Sync desktop sessions
  sessionSync: {
    enabled: true,
    backgroundSync: true,
    syncInterval: &#039;5m&#039;
  }
};</code></pre>
        </div>
        <p>---</p>
        <h3>Security</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">security:
  auth:
    - oauth2 (GitHub, Google)
    - biometric (Face ID, fingerprint)
    - api_key

  data:
    - encrypted_storage (Keychain/Keystore)
    - no_code_cache (queries only)
    - auto_logout: 24h

  network:
    - certificate_pinning: true
    - min_tls: 1.3</code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>mobile:query_sent</code></td><td>Query submitted</td><td>query, voice</td></tr>
            <tr><td><code>mobile:notification_received</code></td><td>Push received</td><td>type</td></tr>
            <tr><td><code>mobile:pr_reviewed</code></td><td>PR action taken</td><td>action, pr</td></tr>
            <tr><td><code>mobile:session_continued</code></td><td>Session resumed</td><td>session_id</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Offline queries</strong>: Pre-cache common queries per project?</li>
        <li><strong>Widget support</strong>: iOS widgets for quick status?</li>
        <li><strong>Watch app</strong>: Apple Watch / Wear OS companion?</li>
        <li><strong>Code viewing</strong>: How to display code diffs effectively on mobile?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-observability" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Observability</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Medium Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-integration-observability</code></p>
        </div>
        <h3>Overview</h3>
        <p>Unified observability integration connecting Amplifier to monitoring platforms (Datadog, Prometheus, Grafana, New Relic, etc.). Enables AI-powered analysis of metrics, logs, and traces during incident response and proactive monitoring.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual metric correlation</td><td>AI-driven anomaly detection</td></tr>
            <tr><td>Siloed observability data</td><td>Unified query interface</td></tr>
            <tr><td>Reactive incident response</td><td>Proactive issue identification</td></tr>
            <tr><td>Context switching between tools</td><td>Single AI interface</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Unified Metrics Query</h4>
        <p>Query metrics across multiple platforms with natural language.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Natural language query
&quot;Show me the error rate for payment-api in the last hour&quot;

# Amplifier translates to appropriate platform queries:
# Datadog: avg:payment_api.error_rate{service:payment-api}.rollup(avg, 60)
# Prometheus: rate(payment_api_errors_total{service=&quot;payment-api&quot;}[1h])
# New Relic: SELECT average(errorRate) FROM Transaction WHERE appName=&#039;payment-api&#039;

# Returns unified response:
{
    &quot;metric&quot;: &quot;error_rate&quot;,
    &quot;service&quot;: &quot;payment-api&quot;,
    &quot;time_range&quot;: &quot;1h&quot;,
    &quot;data_points&quot;: [...],
    &quot;summary&quot;: {
        &quot;current&quot;: 0.02,
        &quot;average&quot;: 0.015,
        &quot;trend&quot;: &quot;increasing&quot;,
        &quot;anomaly_detected&quot;: True
    }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Log Analysis</h4>
        <p>AI-powered log search and analysis.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Query logs across platforms
async with AmplifierSession(config=OBSERVABILITY_CONFIG) as session:
    result = await session.execute(
        prompt=&quot;Find errors related to database connections in the last 30 minutes&quot;,
        tools=[&quot;tool-log-query&quot;]
    )

# Result:
&quot;&quot;&quot;
Found 47 database connection errors across 3 services:

**payment-api** (32 errors)
- Pattern: &quot;Connection pool exhausted&quot; at 14:23-14:28 UTC
- Affected endpoints: /api/payments, /api/refunds

**user-service** (12 errors)
- Pattern: &quot;Connection timeout after 30s&quot;
- Started after payment-api errors

**order-service** (3 errors)
- Pattern: &quot;Unable to acquire connection&quot;
- Isolated incidents, likely cascade effect

**Root Cause Analysis:**
The connection pool in payment-api reached capacity at 14:23 UTC.
This coincides with traffic spike (3x normal) from marketing campaign.

**Recommended Actions:**
1. Increase payment-api connection pool size
2. Add connection pool metrics alerting
3. Review query efficiency in /api/payments endpoint
&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Trace Analysis</h4>
        <p>Distributed trace correlation and analysis.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Analyze slow traces
async with AmplifierSession(config=TRACE_CONFIG) as session:
    result = await session.execute(
        prompt=&quot;Why are checkout requests taking over 5 seconds?&quot;,
        tools=[&quot;tool-trace-query&quot;]
    )

# Result with trace visualization:
&quot;&quot;&quot;
**Slow Checkout Analysis** (traces &gt; 5s in last hour)

Sample trace: `trace-id-abc123`
Total duration: 7.2s</code></pre>
        </div>
        <p>checkout-api    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  1.2s (17%)</p>
        <p>  â””â”€ inventory  â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  5.8s (81%) â† Bottleneck</p>
        <p>      â””â”€ db     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  4.1s (57%)</p>
        <p>  â””â”€ payment    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆ  0.2s (3%)</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">**Analysis:**
- Inventory service is the bottleneck (81% of total time)
- Database queries in inventory taking 4.1s average
- Query: `SELECT * FROM inventory WHERE sku IN (...)` - scanning 2M rows

**Recommendations:**
1. Add index on `inventory.sku` column
2. Implement inventory caching for frequently accessed SKUs
3. Consider pagination for bulk inventory checks
&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Anomaly Detection</h4>
        <p>Proactive anomaly detection with AI analysis.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Configure anomaly detection
config = {
    &quot;anomaly_detection&quot;: {
        &quot;enabled&quot;: True,
        &quot;metrics&quot;: [
            &quot;error_rate&quot;,
            &quot;latency_p99&quot;,
            &quot;throughput&quot;,
            &quot;cpu_usage&quot;,
            &quot;memory_usage&quot;
        ],
        &quot;sensitivity&quot;: &quot;medium&quot;,  # low | medium | high
        &quot;notification_channel&quot;: &quot;slack:#observability-alerts&quot;
    }
}

# Automatic anomaly report:
&quot;&quot;&quot;
ðŸ” **Anomaly Detected** - payment-api

**Metric:** latency_p99
**Current:** 2.3s (normal: 0.4s)
**Started:** 14:15 UTC (25 minutes ago)
**Severity:** High

**Correlated Events:**
- 14:12 UTC: Deployment `payment-api@v2.4.1`
- 14:13 UTC: Config change in Redis cluster
- 14:14 UTC: Traffic spike +40%

**AI Analysis:**
The latency increase correlates strongly with the Redis config change.
The new configuration reduced connection pool from 100 to 20.

**Suggested Investigation:**
1. Check Redis connection metrics
2. Review config change in `redis-cluster-config@v1.2.3`
3. Consider rollback if latency doesn&#039;t recover

[View Dashboard](link) | [Start Investigation](link)
&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Dashboard Generation</h4>
        <p>AI-generated dashboards based on service architecture.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Generate dashboard from service description
async with AmplifierSession(config=DASHBOARD_CONFIG) as session:
    result = await session.execute(
        prompt=&quot;Create a dashboard for our payment processing service&quot;,
        context={
            &quot;service&quot;: &quot;payment-api&quot;,
            &quot;dependencies&quot;: [&quot;postgres&quot;, &quot;redis&quot;, &quot;stripe-api&quot;],
            &quot;key_metrics&quot;: [&quot;throughput&quot;, &quot;error_rate&quot;, &quot;latency&quot;]
        }
    )

# Result: Dashboard configuration
{
    &quot;title&quot;: &quot;Payment API Dashboard&quot;,
    &quot;panels&quot;: [
        {
            &quot;title&quot;: &quot;Request Throughput&quot;,
            &quot;type&quot;: &quot;timeseries&quot;,
            &quot;query&quot;: &quot;rate(payment_api_requests_total[5m])&quot;
        },
        {
            &quot;title&quot;: &quot;Error Rate&quot;,
            &quot;type&quot;: &quot;gauge&quot;,
            &quot;query&quot;: &quot;rate(payment_api_errors_total[5m]) / rate(payment_api_requests_total[5m])&quot;,
            &quot;thresholds&quot;: [0.01, 0.05]
        },
        {
            &quot;title&quot;: &quot;P99 Latency&quot;,
            &quot;type&quot;: &quot;timeseries&quot;,
            &quot;query&quot;: &quot;histogram_quantile(0.99, payment_api_latency_bucket)&quot;
        },
        {
            &quot;title&quot;: &quot;Dependency Health&quot;,
            &quot;type&quot;: &quot;status&quot;,
            &quot;targets&quot;: [&quot;postgres&quot;, &quot;redis&quot;, &quot;stripe-api&quot;]
        }
    ]
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">6. Incident Context Enrichment</h4>
        <p>Automatically enrich incident data with observability context.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># When incident is triggered, gather observability context
async def enrich_incident_context(incident: dict) -&gt; dict:
    &quot;&quot;&quot;Gather comprehensive observability context for incident.&quot;&quot;&quot;

    service = incident[&quot;service&quot;]
    start_time = incident[&quot;started_at&quot;]

    context = {}

    # Get metrics around incident start
    context[&quot;metrics&quot;] = await query_metrics(
        service=service,
        start=start_time - timedelta(minutes=30),
        end=start_time + timedelta(minutes=10)
    )

    # Get error logs
    context[&quot;error_logs&quot;] = await query_logs(
        service=service,
        level=&quot;error&quot;,
        start=start_time - timedelta(minutes=5),
        limit=100
    )

    # Get recent traces with errors
    context[&quot;error_traces&quot;] = await query_traces(
        service=service,
        status=&quot;error&quot;,
        start=start_time - timedelta(minutes=5),
        limit=20
    )

    # Get recent deployments
    context[&quot;deployments&quot;] = await query_deployments(
        service=service,
        start=start_time - timedelta(hours=2)
    )

    # Get correlated alerts
    context[&quot;alerts&quot;] = await query_alerts(
        service=service,
        start=start_time - timedelta(minutes=10)
    )

    return context</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Observability Integration                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Unified Query Layer                       â”‚   â”‚
â”‚  â”‚  â€¢ Natural language â†’ Platform-specific queries              â”‚   â”‚
â”‚  â”‚  â€¢ Result normalization and aggregation                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â–¼                        â–¼                        â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Datadog  â”‚          â”‚Prometheusâ”‚          â”‚ Grafana  â”‚          â”‚
â”‚  â”‚ Adapter  â”‚          â”‚ Adapter  â”‚          â”‚ Adapter  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ New Relicâ”‚          â”‚   Loki   â”‚          â”‚  Jaeger  â”‚          â”‚
â”‚  â”‚ Adapter  â”‚          â”‚ Adapter  â”‚          â”‚ Adapter  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Analysis Engine                           â”‚   â”‚
â”‚  â”‚  â€¢ Anomaly detection  â€¢ Correlation  â€¢ Root cause analysis   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Platform Adapters</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Datadog Adapter</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># adapters/datadog.py

from datadog_api_client import ApiClient, Configuration
from datadog_api_client.v1.api import metrics_api, logs_api

class DatadogAdapter:
    &quot;&quot;&quot;Adapter for Datadog APIs.&quot;&quot;&quot;

    def __init__(self, config: DatadogConfig):
        self.config = config
        self.api_config = Configuration()
        self.api_config.api_key[&quot;apiKeyAuth&quot;] = config.api_key
        self.api_config.api_key[&quot;appKeyAuth&quot;] = config.app_key

    async def query_metrics(
        self,
        query: str,
        start: datetime,
        end: datetime
    ) -&gt; MetricsResult:
        &quot;&quot;&quot;Query Datadog metrics.&quot;&quot;&quot;

        with ApiClient(self.api_config) as client:
            api = metrics_api.MetricsApi(client)
            response = api.query_metrics(
                query=query,
                _from=int(start.timestamp()),
                to=int(end.timestamp())
            )

        return self._normalize_metrics(response)

    async def query_logs(
        self,
        query: str,
        start: datetime,
        end: datetime,
        limit: int = 100
    ) -&gt; LogsResult:
        &quot;&quot;&quot;Query Datadog logs.&quot;&quot;&quot;

        with ApiClient(self.api_config) as client:
            api = logs_api.LogsApi(client)
            response = api.list_logs(
                body={
                    &quot;filter&quot;: {
                        &quot;query&quot;: query,
                        &quot;from&quot;: start.isoformat(),
                        &quot;to&quot;: end.isoformat()
                    },
                    &quot;page&quot;: {&quot;limit&quot;: limit}
                }
            )

        return self._normalize_logs(response)

    def translate_query(self, natural_query: str, context: dict) -&gt; str:
        &quot;&quot;&quot;Translate natural language to Datadog query.&quot;&quot;&quot;

        # Use AI to translate
        # This would call Amplifier to do the translation
        pass

    def _normalize_metrics(self, response) -&gt; MetricsResult:
        &quot;&quot;&quot;Normalize Datadog metrics to unified format.&quot;&quot;&quot;

        return MetricsResult(
            source=&quot;datadog&quot;,
            data_points=[
                DataPoint(
                    timestamp=datetime.fromtimestamp(p[0] / 1000),
                    value=p[1]
                )
                for series in response.series
                for p in series.pointlist
            ],
            metadata={
                &quot;query&quot;: response.query,
                &quot;unit&quot;: response.series[0].unit if response.series else None
            }
        )</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Prometheus Adapter</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># adapters/prometheus.py

import aiohttp

class PrometheusAdapter:
    &quot;&quot;&quot;Adapter for Prometheus API.&quot;&quot;&quot;

    def __init__(self, config: PrometheusConfig):
        self.config = config
        self.base_url = config.url

    async def query_metrics(
        self,
        query: str,
        start: datetime,
        end: datetime,
        step: str = &quot;1m&quot;
    ) -&gt; MetricsResult:
        &quot;&quot;&quot;Query Prometheus metrics.&quot;&quot;&quot;

        async with aiohttp.ClientSession() as session:
            async with session.get(
                f&quot;{self.base_url}/api/v1/query_range&quot;,
                params={
                    &quot;query&quot;: query,
                    &quot;start&quot;: start.timestamp(),
                    &quot;end&quot;: end.timestamp(),
                    &quot;step&quot;: step
                }
            ) as response:
                data = await response.json()

        return self._normalize_metrics(data)

    async def query_instant(self, query: str) -&gt; MetricsResult:
        &quot;&quot;&quot;Query current metric value.&quot;&quot;&quot;

        async with aiohttp.ClientSession() as session:
            async with session.get(
                f&quot;{self.base_url}/api/v1/query&quot;,
                params={&quot;query&quot;: query}
            ) as response:
                data = await response.json()

        return self._normalize_instant(data)

    def translate_query(self, natural_query: str, context: dict) -&gt; str:
        &quot;&quot;&quot;Translate natural language to PromQL.&quot;&quot;&quot;

        # Common translations
        translations = {
            &quot;error_rate&quot;: &#039;rate({service}_errors_total{{service=&quot;{service}&quot;}}[{window}])&#039;,
            &quot;latency_p99&quot;: &#039;histogram_quantile(0.99, rate({service}_latency_bucket{{service=&quot;{service}&quot;}}[{window}]))&#039;,
            &quot;throughput&quot;: &#039;rate({service}_requests_total{{service=&quot;{service}&quot;}}[{window}])&#039;,
        }

        # Would use AI for complex translations
        pass

    def _normalize_metrics(self, data: dict) -&gt; MetricsResult:
        &quot;&quot;&quot;Normalize Prometheus response to unified format.&quot;&quot;&quot;

        result = data.get(&quot;data&quot;, {}).get(&quot;result&quot;, [])
        if not result:
            return MetricsResult(source=&quot;prometheus&quot;, data_points=[])

        return MetricsResult(
            source=&quot;prometheus&quot;,
            data_points=[
                DataPoint(
                    timestamp=datetime.fromtimestamp(float(p[0])),
                    value=float(p[1]),
                    labels=series.get(&quot;metric&quot;, {})
                )
                for series in result
                for p in series.get(&quot;values&quot;, [])
            ],
            metadata={
                &quot;result_type&quot;: data.get(&quot;data&quot;, {}).get(&quot;resultType&quot;)
            }
        )</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Grafana Adapter</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># adapters/grafana.py

class GrafanaAdapter:
    &quot;&quot;&quot;Adapter for Grafana API.&quot;&quot;&quot;

    def __init__(self, config: GrafanaConfig):
        self.config = config
        self.base_url = config.url
        self.api_key = config.api_key

    async def query_dashboard(
        self,
        dashboard_uid: str,
        panel_id: int,
        start: datetime,
        end: datetime
    ) -&gt; MetricsResult:
        &quot;&quot;&quot;Query specific dashboard panel.&quot;&quot;&quot;

        headers = {&quot;Authorization&quot;: f&quot;Bearer {self.api_key}&quot;}

        async with aiohttp.ClientSession() as session:
            async with session.get(
                f&quot;{self.base_url}/api/dashboards/uid/{dashboard_uid}&quot;,
                headers=headers
            ) as response:
                dashboard = await response.json()

        # Find panel and execute its queries
        panel = self._find_panel(dashboard, panel_id)
        return await self._execute_panel_queries(panel, start, end)

    async def create_dashboard(
        self,
        config: DashboardConfig
    ) -&gt; dict:
        &quot;&quot;&quot;Create a new Grafana dashboard.&quot;&quot;&quot;

        headers = {
            &quot;Authorization&quot;: f&quot;Bearer {self.api_key}&quot;,
            &quot;Content-Type&quot;: &quot;application/json&quot;
        }

        dashboard_json = self._build_dashboard(config)

        async with aiohttp.ClientSession() as session:
            async with session.post(
                f&quot;{self.base_url}/api/dashboards/db&quot;,
                headers=headers,
                json={&quot;dashboard&quot;: dashboard_json}
            ) as response:
                return await response.json()

    async def list_dashboards(
        self,
        folder_id: int | None = None,
        tag: str | None = None
    ) -&gt; list[dict]:
        &quot;&quot;&quot;List available dashboards.&quot;&quot;&quot;

        headers = {&quot;Authorization&quot;: f&quot;Bearer {self.api_key}&quot;}
        params = {}
        if folder_id:
            params[&quot;folderIds&quot;] = folder_id
        if tag:
            params[&quot;tag&quot;] = tag

        async with aiohttp.ClientSession() as session:
            async with session.get(
                f&quot;{self.base_url}/api/search&quot;,
                headers=headers,
                params=params
            ) as response:
                return await response.json()</code></pre>
        </div>
        <p>---</p>
        <h3>Unified Query Interface</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># query/unified.py

class UnifiedObservabilityQuery:
    &quot;&quot;&quot;Unified interface for querying observability data.&quot;&quot;&quot;

    def __init__(self, adapters: dict[str, Adapter]):
        self.adapters = adapters

    async def query_metrics(
        self,
        natural_query: str,
        context: QueryContext
    ) -&gt; UnifiedResult:
        &quot;&quot;&quot;Query metrics using natural language.&quot;&quot;&quot;

        # Parse natural query
        parsed = await self._parse_query(natural_query, context)

        # Execute on relevant platforms
        results = []
        for platform in parsed.target_platforms:
            adapter = self.adapters.get(platform)
            if adapter:
                platform_query = adapter.translate_query(
                    natural_query, context.to_dict()
                )
                result = await adapter.query_metrics(
                    platform_query,
                    parsed.start_time,
                    parsed.end_time
                )
                results.append(result)

        # Aggregate and normalize
        return self._aggregate_results(results)

    async def query_logs(
        self,
        natural_query: str,
        context: QueryContext
    ) -&gt; UnifiedResult:
        &quot;&quot;&quot;Query logs using natural language.&quot;&quot;&quot;

        parsed = await self._parse_query(natural_query, context)

        results = []
        for platform in self._get_log_platforms():
            adapter = self.adapters.get(platform)
            if adapter and hasattr(adapter, &quot;query_logs&quot;):
                result = await adapter.query_logs(
                    parsed.translated_query,
                    parsed.start_time,
                    parsed.end_time
                )
                results.append(result)

        return self._aggregate_log_results(results)

    async def query_traces(
        self,
        trace_id: str | None = None,
        service: str | None = None,
        operation: str | None = None,
        start: datetime | None = None,
        end: datetime | None = None,
        status: str | None = None
    ) -&gt; list[Trace]:
        &quot;&quot;&quot;Query distributed traces.&quot;&quot;&quot;

        results = []
        for platform in self._get_trace_platforms():
            adapter = self.adapters.get(platform)
            if adapter and hasattr(adapter, &quot;query_traces&quot;):
                result = await adapter.query_traces(
                    trace_id=trace_id,
                    service=service,
                    operation=operation,
                    start=start,
                    end=end,
                    status=status
                )
                results.extend(result)

        return self._deduplicate_traces(results)

    async def _parse_query(
        self,
        natural_query: str,
        context: QueryContext
    ) -&gt; ParsedQuery:
        &quot;&quot;&quot;Parse natural language query into structured form.&quot;&quot;&quot;

        # Use AI to parse the query
        async with AmplifierSession(config=QUERY_PARSER_CONFIG) as session:
            result = await session.execute(
                prompt=f&quot;&quot;&quot;Parse this observability query:
                Query: {natural_query}
                Context: {context.to_dict()}

                Extract:
                - Target metrics/logs/traces
                - Time range
                - Filters (service, environment, etc.)
                - Aggregations
                &quot;&quot;&quot;,
            )

        return ParsedQuery.from_ai_response(result)</code></pre>
        </div>
        <p>---</p>
        <h3>Analysis Engine</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Anomaly Detection</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># analysis/anomaly.py

class AnomalyDetector:
    &quot;&quot;&quot;Detect anomalies in metrics data.&quot;&quot;&quot;

    def __init__(self, config: AnomalyConfig):
        self.config = config
        self.baseline_window = config.baseline_window
        self.sensitivity = config.sensitivity

    async def detect(
        self,
        metric_data: MetricsResult,
        context: dict
    ) -&gt; list[Anomaly]:
        &quot;&quot;&quot;Detect anomalies in metric data.&quot;&quot;&quot;

        anomalies = []

        # Statistical anomaly detection
        stats_anomalies = self._detect_statistical_anomalies(metric_data)
        anomalies.extend(stats_anomalies)

        # Pattern-based detection
        pattern_anomalies = self._detect_pattern_anomalies(metric_data)
        anomalies.extend(pattern_anomalies)

        # AI-enhanced detection for complex patterns
        ai_anomalies = await self._detect_ai_anomalies(metric_data, context)
        anomalies.extend(ai_anomalies)

        # Deduplicate and rank
        return self._rank_anomalies(anomalies)

    def _detect_statistical_anomalies(
        self,
        data: MetricsResult
    ) -&gt; list[Anomaly]:
        &quot;&quot;&quot;Detect anomalies using statistical methods.&quot;&quot;&quot;

        values = [p.value for p in data.data_points]
        if len(values) &lt; 10:
            return []

        mean = statistics.mean(values)
        stdev = statistics.stdev(values)

        threshold_multiplier = {
            &quot;low&quot;: 3,
            &quot;medium&quot;: 2.5,
            &quot;high&quot;: 2
        }[self.sensitivity]

        threshold = mean + (stdev * threshold_multiplier)

        anomalies = []
        for point in data.data_points:
            if point.value &gt; threshold:
                anomalies.append(Anomaly(
                    timestamp=point.timestamp,
                    metric=data.metadata.get(&quot;metric_name&quot;),
                    value=point.value,
                    expected_range=(mean - stdev, mean + stdev),
                    severity=self._calculate_severity(point.value, mean, stdev),
                    detection_method=&quot;statistical&quot;
                ))

        return anomalies

    async def _detect_ai_anomalies(
        self,
        data: MetricsResult,
        context: dict
    ) -&gt; list[Anomaly]:
        &quot;&quot;&quot;Use AI to detect complex anomaly patterns.&quot;&quot;&quot;

        async with AmplifierSession(config=ANOMALY_CONFIG) as session:
            result = await session.execute(
                prompt=f&quot;&quot;&quot;Analyze this metric data for anomalies:

                Data: {data.to_summary()}
                Context: {context}

                Look for:
                - Sudden spikes or drops
                - Trend changes
                - Seasonal pattern violations
                - Correlation anomalies with other metrics

                Return structured anomaly data.
                &quot;&quot;&quot;,
            )

        return self._parse_ai_anomalies(result)


class CorrelationAnalyzer:
    &quot;&quot;&quot;Analyze correlations between metrics and events.&quot;&quot;&quot;

    async def correlate_with_deployments(
        self,
        anomaly: Anomaly,
        service: str
    ) -&gt; list[Correlation]:
        &quot;&quot;&quot;Find deployments that correlate with anomaly.&quot;&quot;&quot;

        # Get deployments in time window
        deployments = await self.deployment_adapter.get_deployments(
            service=service,
            start=anomaly.timestamp - timedelta(hours=2),
            end=anomaly.timestamp
        )

        correlations = []
        for deployment in deployments:
            time_diff = (anomaly.timestamp - deployment.timestamp).total_seconds()
            if 0 &lt; time_diff &lt; 3600:  # Within 1 hour after deployment
                correlations.append(Correlation(
                    event_type=&quot;deployment&quot;,
                    event=deployment,
                    time_offset=time_diff,
                    confidence=self._calculate_confidence(time_diff)
                ))

        return correlations

    async def correlate_with_config_changes(
        self,
        anomaly: Anomaly,
        service: str
    ) -&gt; list[Correlation]:
        &quot;&quot;&quot;Find config changes that correlate with anomaly.&quot;&quot;&quot;

        config_changes = await self.config_adapter.get_changes(
            service=service,
            start=anomaly.timestamp - timedelta(hours=1),
            end=anomaly.timestamp
        )

        correlations = []
        for change in config_changes:
            time_diff = (anomaly.timestamp - change.timestamp).total_seconds()
            if 0 &lt; time_diff &lt; 1800:  # Within 30 minutes
                correlations.append(Correlation(
                    event_type=&quot;config_change&quot;,
                    event=change,
                    time_offset=time_diff,
                    confidence=self._calculate_confidence(time_diff)
                ))

        return correlations</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Root Cause Analysis</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># analysis/root_cause.py

class RootCauseAnalyzer:
    &quot;&quot;&quot;Analyze root cause of incidents using observability data.&quot;&quot;&quot;

    async def analyze(
        self,
        incident: dict,
        context: ObservabilityContext
    ) -&gt; RootCauseReport:
        &quot;&quot;&quot;Perform root cause analysis.&quot;&quot;&quot;

        # Gather all relevant data
        metrics = context.metrics
        logs = context.error_logs
        traces = context.error_traces
        deployments = context.deployments
        config_changes = context.config_changes

        # Use AI for root cause analysis
        async with AmplifierSession(config=RCA_CONFIG) as session:
            result = await session.execute(
                prompt=f&quot;&quot;&quot;Analyze this incident and determine root cause:

                Incident: {incident}

                Metrics (around incident time):
                {self._summarize_metrics(metrics)}

                Error Logs:
                {self._summarize_logs(logs)}

                Error Traces:
                {self._summarize_traces(traces)}

                Recent Deployments:
                {self._summarize_deployments(deployments)}

                Recent Config Changes:
                {self._summarize_config_changes(config_changes)}

                Provide:
                1. Most likely root cause
                2. Evidence supporting this conclusion
                3. Alternative hypotheses
                4. Recommended remediation steps
                5. Preventive measures for the future
                &quot;&quot;&quot;,
            )

        return self._parse_rca_result(result)

    def _summarize_metrics(self, metrics: dict) -&gt; str:
        &quot;&quot;&quot;Summarize metrics for AI analysis.&quot;&quot;&quot;

        summaries = []
        for metric_name, data in metrics.items():
            trend = self._calculate_trend(data)
            anomalies = self._find_anomalies(data)
            summaries.append(
                f&quot;{metric_name}: trend={trend}, anomalies={len(anomalies)}&quot;
            )
        return &quot;\n&quot;.join(summaries)</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># .amplifier/integrations/observability.yaml
observability:
  enabled: true

  # Platform configurations
  platforms:
    datadog:
      enabled: true
      api_key: ${DATADOG_API_KEY}
      app_key: ${DATADOG_APP_KEY}
      site: &quot;datadoghq.com&quot;  # or datadoghq.eu

    prometheus:
      enabled: true
      url: &quot;http://prometheus.monitoring.svc:9090&quot;
      # Optional authentication
      auth:
        type: bearer
        token: ${PROMETHEUS_TOKEN}

    grafana:
      enabled: true
      url: &quot;https://grafana.example.com&quot;
      api_key: ${GRAFANA_API_KEY}

    loki:
      enabled: true
      url: &quot;http://loki.monitoring.svc:3100&quot;

    jaeger:
      enabled: true
      url: &quot;http://jaeger.monitoring.svc:16686&quot;

  # Anomaly detection configuration
  anomaly_detection:
    enabled: true
    sensitivity: medium  # low | medium | high
    baseline_window: 7d  # Historical data for baseline
    metrics:
      - name: &quot;error_rate&quot;
        threshold: 0.05  # 5% error rate
        alert_channel: &quot;slack:#alerts&quot;
      - name: &quot;latency_p99&quot;
        threshold: 2.0   # 2 seconds
        alert_channel: &quot;slack:#alerts&quot;
      - name: &quot;throughput&quot;
        change_threshold: 50  # 50% change
        alert_channel: &quot;slack:#alerts&quot;

  # Dashboard generation
  dashboards:
    auto_generate: true
    output_platform: grafana
    folder: &quot;Amplifier Generated&quot;
    refresh_interval: &quot;30s&quot;

  # Query settings
  query:
    default_time_range: 1h
    max_time_range: 7d
    max_data_points: 1000
    cache_ttl: 60s

  # Correlation settings
  correlation:
    deployment_window: 2h      # Look back 2 hours for deployments
    config_change_window: 1h   # Look back 1 hour for config changes
    alert_window: 30m          # Look for related alerts

  # Export settings
  export:
    enabled: true
    formats:
      - json
      - csv
    retention: 30d</code></pre>
        </div>
        <p>---</p>
        <h3>Tools</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">tool-metrics-query</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># tools/tool-metrics-query.yaml
name: tool-metrics-query
description: Query metrics from observability platforms

parameters:
  query:
    type: string
    description: Natural language query or platform-specific query
    required: true
  platform:
    type: string
    enum: [datadog, prometheus, grafana, auto]
    default: auto
  start_time:
    type: string
    description: Start time (ISO8601 or relative like &quot;1h ago&quot;)
    default: &quot;1h ago&quot;
  end_time:
    type: string
    description: End time
    default: &quot;now&quot;
  aggregation:
    type: string
    enum: [avg, sum, min, max, count]
    default: avg

returns:
  type: object
  properties:
    data_points:
      type: array
      description: Time series data
    summary:
      type: object
      description: Statistical summary
    anomalies:
      type: array
      description: Detected anomalies</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">tool-log-query</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># tools/tool-log-query.yaml
name: tool-log-query
description: Query logs from observability platforms

parameters:
  query:
    type: string
    description: Natural language or platform-specific log query
    required: true
  platform:
    type: string
    enum: [datadog, loki, cloudwatch, auto]
    default: auto
  start_time:
    type: string
    default: &quot;30m ago&quot;
  end_time:
    type: string
    default: &quot;now&quot;
  limit:
    type: integer
    default: 100
  level:
    type: string
    enum: [debug, info, warn, error, fatal, all]
    default: all

returns:
  type: object
  properties:
    logs:
      type: array
      description: Log entries
    patterns:
      type: array
      description: Detected patterns
    summary:
      type: object
      description: Log analysis summary</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">tool-trace-query</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># tools/tool-trace-query.yaml
name: tool-trace-query
description: Query distributed traces

parameters:
  trace_id:
    type: string
    description: Specific trace ID to retrieve
  service:
    type: string
    description: Filter by service name
  operation:
    type: string
    description: Filter by operation name
  status:
    type: string
    enum: [ok, error, all]
    default: all
  min_duration:
    type: string
    description: Minimum trace duration (e.g., &quot;1s&quot;, &quot;500ms&quot;)
  start_time:
    type: string
    default: &quot;1h ago&quot;
  end_time:
    type: string
    default: &quot;now&quot;
  limit:
    type: integer
    default: 20

returns:
  type: object
  properties:
    traces:
      type: array
      description: Trace data with spans
    analysis:
      type: object
      description: Trace analysis (bottlenecks, patterns)</code></pre>
        </div>
        <p>---</p>
        <h3>Security</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Credentials Management</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Secrets should be managed via environment variables or secret manager
observability:
  platforms:
    datadog:
      api_key: ${DATADOG_API_KEY}       # From environment
      app_key: ${DATADOG_APP_KEY}

    prometheus:
      auth:
        type: bearer
        token_secret: vault://secret/prometheus/token  # From Vault</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Access Control</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># security/access.py

class ObservabilityAccessControl:
    &quot;&quot;&quot;Control access to observability data.&quot;&quot;&quot;

    def __init__(self, config: AccessConfig):
        self.config = config

    async def can_query(
        self,
        user: str,
        query_type: str,
        scope: dict
    ) -&gt; bool:
        &quot;&quot;&quot;Check if user can execute query.&quot;&quot;&quot;

        # Get user&#039;s allowed scopes
        user_scopes = await self.get_user_scopes(user)

        # Check service access
        if scope.get(&quot;service&quot;):
            if scope[&quot;service&quot;] not in user_scopes.get(&quot;services&quot;, []):
                return False

        # Check environment access
        if scope.get(&quot;environment&quot;):
            if scope[&quot;environment&quot;] not in user_scopes.get(&quot;environments&quot;, []):
                return False

        # Check query type permissions
        allowed_queries = user_scopes.get(&quot;query_types&quot;, [&quot;metrics&quot;, &quot;logs&quot;])
        if query_type not in allowed_queries:
            return False

        return True

    async def redact_sensitive_data(
        self,
        data: dict,
        user: str
    ) -&gt; dict:
        &quot;&quot;&quot;Redact sensitive data based on user permissions.&quot;&quot;&quot;

        # Redact PII from logs if user doesn&#039;t have PII access
        if not await self.has_pii_access(user):
            data = self._redact_pii(data)

        # Redact secrets
        data = self._redact_secrets(data)

        return data</code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>observability:query:start</code></td><td>Query started</td><td>query, platforms</td></tr>
            <tr><td><code>observability:query:complete</code></td><td>Query completed</td><td>query, results, duration</td></tr>
            <tr><td><code>observability:anomaly:detected</code></td><td>Anomaly detected</td><td>metric, value, severity</td></tr>
            <tr><td><code>observability:correlation:found</code></td><td>Correlation found</td><td>anomaly, correlated_event</td></tr>
            <tr><td><code>observability:rca:complete</code></td><td>Root cause analysis complete</td><td>incident, root_cause</td></tr>
            <tr><td><code>observability:dashboard:created</code></td><td>Dashboard generated</td><td>dashboard_id, platform</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li>Platform-specific API clients (datadog-api-client, prometheus-api-client, etc.)</li>
        <li>aiohttp for async HTTP requests</li>
        <li>Statistics libraries for anomaly detection</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>Machine learning libraries for advanced anomaly detection</li>
        <li>Visualization libraries for dashboard generation</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Data retention</strong>: How long to cache observability data locally?</li>
        <li><strong>Cost management</strong>: Rate limiting for expensive platform queries?</li>
        <li><strong>Multi-tenancy</strong>: Support multiple observability stacks per environment?</li>
        <li><strong>Alerting integration</strong>: Integrate with PagerDuty/OpsGenie for anomaly alerts?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-obsidian-plugin" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Obsidian Plugin</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Enhancement)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-obsidian-plugin</code></p>
        </div>
        <h3>Overview</h3>
        <p>Obsidian plugin connecting your knowledge base to your codebase through Amplifier. Generate documentation from code, link notes to source files, capture technical decisions, and query your combined knowledge (notes + code) with AI assistance.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Separate knowledge and code</td><td>Unified knowledge graph</td></tr>
            <tr><td>Manual documentation updates</td><td>Auto-generated from code</td></tr>
            <tr><td>Lost architectural decisions</td><td>Captured and linked</td></tr>
            <tr><td>Search notes OR code</td><td>Query both simultaneously</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Code-to-Documentation Generation</h4>
        <p>Generate markdown documentation from codebase.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Obsidian: Architecture Notes                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  # Payment Processing Architecture                                   â”‚
â”‚                                                                      â”‚
â”‚  [ðŸ¤– Generate from Code]                                            â”‚
â”‚                                                                      â”‚
â”‚  &gt; Generated from `src/payments/` on 2025-01-15                     â”‚
â”‚                                                                      â”‚
â”‚  ## Overview                                                         â”‚
â”‚                                                                      â”‚
â”‚  The payment system handles transaction processing through          â”‚
â”‚  Stripe integration with retry logic and fraud detection.           â”‚
â”‚                                                                      â”‚
â”‚  ## Components                                                       â”‚
â”‚                                                                      â”‚
â”‚  - [[PaymentProcessor]] - Core processing logic                     â”‚
â”‚  - [[StripeGateway]] - Stripe API integration                       â”‚
â”‚  - [[FraudDetector]] - Fraud signal analysis                        â”‚
â”‚                                                                      â”‚
â”‚  ## Data Flow                                                        â”‚
â”‚                                                                      â”‚
â”‚  ```mermaid                                                          â”‚
â”‚  graph LR                                                            â”‚
â”‚    A[Order] --&gt; B[Validator]                                        â”‚
â”‚    B --&gt; C[FraudDetector]                                           â”‚
â”‚    C --&gt; D[PaymentProcessor]                                        â”‚
â”‚    D --&gt; E[StripeGateway]                                           â”‚
â”‚  ```                                                                 â”‚
â”‚                                                                      â”‚
â”‚  ## Source Links                                                     â”‚
â”‚  - `src/payments/processor.ts:45` [[#^processor-entry]]             â”‚
â”‚  - `src/payments/gateway.ts:12` [[#^gateway-init]]                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Codebase Query from Notes</h4>
        <p>Ask questions about your codebase from within Obsidian.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Obsidian: Technical Queries                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  # How does authentication work?                                     â”‚
â”‚                                                                      â”‚
â”‚  ```amplifier                                                        â”‚
â”‚  query: How does the authentication flow work in this codebase?     â”‚
â”‚  include: src/auth/**                                                â”‚
â”‚  ```                                                                 â”‚
â”‚                                                                      â”‚
â”‚  &gt; ðŸ¤– **Amplifier Response** (generated 2025-01-15 10:30)           â”‚
â”‚  &gt;                                                                   â”‚
â”‚  &gt; The authentication system uses JWT tokens with the following     â”‚
â”‚  &gt; flow:                                                             â”‚
â”‚  &gt;                                                                   â”‚
â”‚  &gt; 1. **Login** (`src/auth/login.ts:23`)                            â”‚
â”‚  &gt;    - Validates credentials against database                       â”‚
â”‚  &gt;    - Generates JWT with 24h expiration                           â”‚
â”‚  &gt;                                                                   â”‚
â”‚  &gt; 2. **Middleware** (`src/auth/middleware.ts:45`)                  â”‚
â”‚  &gt;    - Extracts token from Authorization header                     â”‚
â”‚  &gt;    - Validates signature and expiration                          â”‚
â”‚  &gt;                                                                   â”‚
â”‚  &gt; 3. **Refresh** (`src/auth/refresh.ts:12`)                        â”‚
â”‚  &gt;    - Issues new token before expiration                          â”‚
â”‚  &gt;                                                                   â”‚
â”‚  &gt; See also: [[Authentication ADR-003]]                              â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Decision Capture</h4>
        <p>Capture architectural decisions linked to code.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Obsidian: ADR-005 Retry Strategy                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  # ADR-005: Exponential Backoff for Payment Retries                 â”‚
â”‚                                                                      â”‚
â”‚  **Status**: Accepted                                                â”‚
â”‚  **Date**: 2025-01-15                                                â”‚
â”‚  **Deciders**: @alice, @bob                                         â”‚
â”‚                                                                      â”‚
â”‚  ## Context                                                          â”‚
â”‚                                                                      â”‚
â”‚  Payment API calls to Stripe occasionally fail due to rate          â”‚
â”‚  limiting and transient network issues.                              â”‚
â”‚                                                                      â”‚
â”‚  ```amplifier-context                                                â”‚
â”‚  related_code:                                                       â”‚
â”‚    - src/payments/processor.ts                                       â”‚
â”‚    - src/payments/retry.ts                                           â”‚
â”‚  issue: #234                                                         â”‚
â”‚  ```                                                                 â”‚
â”‚                                                                      â”‚
â”‚  ## Decision                                                         â”‚
â”‚                                                                      â”‚
â”‚  Implement exponential backoff with jitter:                         â”‚
â”‚  - Base delay: 1 second                                              â”‚
â”‚  - Max retries: 3                                                    â”‚
â”‚  - Jitter: Â±20%                                                      â”‚
â”‚                                                                      â”‚
â”‚  ## Implementation                                                   â”‚
â”‚                                                                      â”‚
â”‚  [ðŸ¤– View Implementation Status]                                    â”‚
â”‚                                                                      â”‚
â”‚  &gt; âœ… `src/payments/retry.ts` - Retry logic implemented             â”‚
â”‚  &gt; âœ… `src/payments/processor.ts:89` - Integrated with processor    â”‚
â”‚  &gt; âš ï¸  Tests pending for edge cases                                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Combined Knowledge Search</h4>
        <p>Search across notes AND codebase simultaneously.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Obsidian: Amplifier Search                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ðŸ” Search: &quot;payment validation&quot;                    [Notes + Code]  â”‚
â”‚                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  ðŸ“ Notes (3)                                                        â”‚
â”‚  â”œâ”€â”€ [[Payment Processing Architecture]]                            â”‚
â”‚  â”‚   &quot;...validation occurs in PaymentValidator before...&quot;           â”‚
â”‚  â”œâ”€â”€ [[ADR-002 Validation Strategy]]                                â”‚
â”‚  â”‚   &quot;...decided to validate at API boundary...&quot;                    â”‚
â”‚  â””â”€â”€ [[Q4 Payment Improvements]]                                    â”‚
â”‚       &quot;...improve validation error messages...&quot;                      â”‚
â”‚                                                                      â”‚
â”‚  ðŸ’» Code (5)                                                         â”‚
â”‚  â”œâ”€â”€ src/payments/validator.ts:23                                   â”‚
â”‚  â”‚   `export class PaymentValidator { validate(order)...`           â”‚
â”‚  â”œâ”€â”€ src/payments/processor.ts:45                                   â”‚
â”‚  â”‚   `const validated = await this.validator.validate...`           â”‚
â”‚  â”œâ”€â”€ src/api/payments.ts:12                                         â”‚
â”‚  â”‚   `// Validate payment request before processing`                â”‚
â”‚  â”œâ”€â”€ tests/payments/validator.test.ts:34                            â”‚
â”‚  â”‚   `describe(&#039;PaymentValidator&#039;, () =&gt; {...`                      â”‚
â”‚  â””â”€â”€ src/types/payment.ts:8                                         â”‚
â”‚       `interface ValidationResult { valid: boolean...`              â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– AI Summary                                                       â”‚
â”‚  &quot;Payment validation is handled by PaymentValidator class,          â”‚
â”‚   following the ADR-002 decision to validate at API boundaries.     â”‚
â”‚   Currently 5 files implement validation logic...&quot;                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Code Block Sync</h4>
        <p>Keep code blocks in notes synchronized with actual code.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"># Example Usage

This code block is synced with the actual source:</code></pre>
        </div>
        <p>// Amplifier will update this block when source changes</p>
        <p>async processPayment(order: Order): Promise<PaymentResult> {</p>
        <p>  const validated = await this.validator.validate(order);</p>
        <p>  if (!validated.valid) {</p>
        <p>    throw new ValidationError(validated.errors);</p>
        <p>  }</p>
        <p>  return this.gateway.charge(order.total);</p>
        <p>}</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">&gt; âš ï¸ Source changed on 2025-01-15. [View diff] [Update block]</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Obsidian Plugin                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Doc          â”‚  â”‚ Query        â”‚  â”‚ Sync         â”‚              â”‚
â”‚  â”‚ Generator    â”‚  â”‚ Interface    â”‚  â”‚ Manager      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                 â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                           â–¼                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚ Amplifier       â”‚                                â”‚
â”‚                  â”‚ Connector       â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                           â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â–¼                 â–¼                 â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Local CLI  â”‚   â”‚ API Server â”‚   â”‚ File       â”‚                  â”‚
â”‚  â”‚            â”‚   â”‚            â”‚   â”‚ Watcher    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Plugin Structure</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">amplifier-obsidian-plugin/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                 # Plugin entry point
â”‚   â”œâ”€â”€ settings.ts             # Settings management
â”‚   â”œâ”€â”€ connector.ts            # Amplifier connection
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ doc-generator.ts    # Documentation generation
â”‚   â”‚   â”œâ”€â”€ query-interface.ts  # Codebase queries
â”‚   â”‚   â”œâ”€â”€ decision-capture.ts # ADR management
â”‚   â”‚   â”œâ”€â”€ combined-search.ts  # Unified search
â”‚   â”‚   â””â”€â”€ code-sync.ts        # Code block sync
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ search-modal.ts     # Search UI
â”‚   â”‚   â”œâ”€â”€ query-view.ts       # Query results
â”‚   â”‚   â””â”€â”€ settings-tab.ts     # Settings UI
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ markdown.ts         # Markdown processing
â”‚       â””â”€â”€ code-parser.ts      # Code reference parsing
â”œâ”€â”€ styles.css
â”œâ”€â”€ manifest.json
â””â”€â”€ package.json</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Plugin Entry Point</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/main.ts
import { Plugin, MarkdownPostProcessorContext } from &#039;obsidian&#039;;
import { AmplifierConnector } from &#039;./connector&#039;;
import { DocGenerator } from &#039;./features/doc-generator&#039;;
import { QueryInterface } from &#039;./features/query-interface&#039;;
import { CombinedSearch } from &#039;./features/combined-search&#039;;
import { CodeSync } from &#039;./features/code-sync&#039;;
import { AmplifierSettingTab, AmplifierSettings } from &#039;./settings&#039;;

export default class AmplifierPlugin extends Plugin {
  settings: AmplifierSettings;
  connector: AmplifierConnector;

  async onload() {
    await this.loadSettings();

    // Initialize connector
    this.connector = new AmplifierConnector(this.settings);
    await this.connector.connect();

    // Initialize features
    const docGenerator = new DocGenerator(this.connector);
    const queryInterface = new QueryInterface(this.connector);
    const combinedSearch = new CombinedSearch(this.connector);
    const codeSync = new CodeSync(this.connector, this.app.vault);

    // Register commands
    this.addCommand({
      id: &#039;generate-docs&#039;,
      name: &#039;Generate Documentation from Code&#039;,
      callback: () =&gt; docGenerator.generate()
    });

    this.addCommand({
      id: &#039;query-codebase&#039;,
      name: &#039;Query Codebase&#039;,
      callback: () =&gt; queryInterface.openQueryModal()
    });

    this.addCommand({
      id: &#039;combined-search&#039;,
      name: &#039;Search Notes + Code&#039;,
      callback: () =&gt; combinedSearch.openSearchModal()
    });

    this.addCommand({
      id: &#039;sync-code-blocks&#039;,
      name: &#039;Sync Code Blocks in Current Note&#039;,
      callback: () =&gt; codeSync.syncCurrentNote()
    });

    // Register markdown processors
    this.registerMarkdownCodeBlockProcessor(
      &#039;amplifier&#039;,
      (source, el, ctx) =&gt; queryInterface.processQueryBlock(source, el, ctx)
    );

    this.registerMarkdownCodeBlockProcessor(
      &#039;amplifier-context&#039;,
      (source, el, ctx) =&gt; docGenerator.processContextBlock(source, el, ctx)
    );

    // Settings tab
    this.addSettingTab(new AmplifierSettingTab(this.app, this));

    // Ribbon icon
    this.addRibbonIcon(&#039;bot&#039;, &#039;Amplifier&#039;, () =&gt; {
      combinedSearch.openSearchModal();
    });
  }

  async onunload() {
    await this.connector.disconnect();
  }

  async loadSettings() {
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
  }

  async saveSettings() {
    await this.saveData(this.settings);
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Documentation Generator</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/features/doc-generator.ts
import { Modal, Notice, TFile } from &#039;obsidian&#039;;
import { AmplifierConnector } from &#039;../connector&#039;;

export class DocGenerator {
  constructor(private connector: AmplifierConnector) {}

  async generate() {
    const modal = new GenerateDocsModal(this.connector);
    modal.open();
  }

  async generateFromPath(codePath: string, options: GenerateOptions): Promise&lt;string&gt; {
    const response = await this.connector.execute({
      prompt: `Generate comprehensive markdown documentation for the code at ${codePath}.

Include:
- Overview and purpose
- Component descriptions with links
- Data flow diagrams (mermaid)
- Source file references
- Related concepts

Format for Obsidian with [[wiki links]] for components.`,
      context: {
        type: &#039;doc_generation&#039;,
        code_path: codePath,
        options
      }
    });

    return response.response;
  }

  async processContextBlock(
    source: string,
    el: HTMLElement,
    ctx: MarkdownPostProcessorContext
  ) {
    // Parse context block
    const context = parseYaml(source);

    // Create UI for viewing related code
    const container = el.createDiv({ cls: &#039;amplifier-context&#039; });

    if (context.related_code) {
      const codeList = container.createEl(&#039;ul&#039;);
      for (const codePath of context.related_code) {
        const item = codeList.createEl(&#039;li&#039;);
        item.createEl(&#039;a&#039;, {
          text: codePath,
          href: `vscode://file/${codePath}`
        });

        // Add status indicator
        const status = await this.checkImplementationStatus(codePath);
        item.createSpan({
          text: status.implemented ? &#039; âœ…&#039; : &#039; âš ï¸&#039;,
          cls: status.implemented ? &#039;status-done&#039; : &#039;status-pending&#039;
        });
      }
    }
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Query Interface</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/features/query-interface.ts
import { Modal, TextAreaComponent } from &#039;obsidian&#039;;
import { AmplifierConnector } from &#039;../connector&#039;;

export class QueryInterface {
  constructor(private connector: AmplifierConnector) {}

  openQueryModal() {
    new QueryModal(this.connector).open();
  }

  async processQueryBlock(
    source: string,
    el: HTMLElement,
    ctx: MarkdownPostProcessorContext
  ) {
    const container = el.createDiv({ cls: &#039;amplifier-query&#039; });

    // Parse query block
    const lines = source.split(&#039;\n&#039;);
    const queryLine = lines.find(l =&gt; l.startsWith(&#039;query:&#039;));
    const includeLine = lines.find(l =&gt; l.startsWith(&#039;include:&#039;));

    const query = queryLine?.replace(&#039;query:&#039;, &#039;&#039;).trim();
    const include = includeLine?.replace(&#039;include:&#039;, &#039;&#039;).trim();

    if (!query) {
      container.createEl(&#039;p&#039;, { text: &#039;No query specified&#039; });
      return;
    }

    // Check for cached response
    const cacheKey = `query:${query}:${include}`;
    const cached = await this.getCache(cacheKey);

    if (cached) {
      this.renderResponse(container, cached);
      return;
    }

    // Show loading
    const loading = container.createEl(&#039;p&#039;, { text: &#039;ðŸ¤– Querying codebase...&#039; });

    try {
      const response = await this.connector.execute({
        prompt: query,
        context: {
          type: &#039;codebase_query&#039;,
          include_pattern: include
        }
      });

      loading.remove();
      this.renderResponse(container, response.response);

      // Cache response
      await this.setCache(cacheKey, response.response);
    } catch (error) {
      loading.remove();
      container.createEl(&#039;p&#039;, {
        text: `Error: ${error.message}`,
        cls: &#039;amplifier-error&#039;
      });
    }
  }

  private renderResponse(container: HTMLElement, response: string) {
    const responseEl = container.createDiv({ cls: &#039;amplifier-response&#039; });

    // Add timestamp
    responseEl.createEl(&#039;small&#039;, {
      text: `Generated ${new Date().toLocaleDateString()}`,
      cls: &#039;amplifier-timestamp&#039;
    });

    // Render markdown response
    MarkdownRenderer.renderMarkdown(
      response,
      responseEl,
      &#039;&#039;,
      null
    );

    // Add refresh button
    const refreshBtn = responseEl.createEl(&#039;button&#039;, {
      text: &#039;ðŸ”„ Refresh&#039;,
      cls: &#039;amplifier-refresh&#039;
    });
    refreshBtn.onclick = () =&gt; this.refreshQuery(container);
  }
}

class QueryModal extends Modal {
  private query: string = &#039;&#039;;
  private result: string = &#039;&#039;;

  constructor(private connector: AmplifierConnector) {
    super(connector.app);
  }

  onOpen() {
    const { contentEl } = this;

    contentEl.createEl(&#039;h2&#039;, { text: &#039;ðŸ¤– Query Codebase&#039; });

    // Query input
    new TextAreaComponent(contentEl)
      .setPlaceholder(&#039;Ask about your codebase...&#039;)
      .onChange(value =&gt; this.query = value);

    // Submit button
    const submitBtn = contentEl.createEl(&#039;button&#039;, { text: &#039;Query&#039; });
    submitBtn.onclick = () =&gt; this.executeQuery();

    // Results area
    this.resultEl = contentEl.createDiv({ cls: &#039;query-results&#039; });
  }

  async executeQuery() {
    this.resultEl.empty();
    this.resultEl.createEl(&#039;p&#039;, { text: &#039;Querying...&#039; });

    try {
      const response = await this.connector.execute({
        prompt: this.query,
        context: { type: &#039;codebase_query&#039; }
      });

      this.resultEl.empty();
      MarkdownRenderer.renderMarkdown(
        response.response,
        this.resultEl,
        &#039;&#039;,
        null
      );
    } catch (error) {
      this.resultEl.empty();
      this.resultEl.createEl(&#039;p&#039;, {
        text: `Error: ${error.message}`,
        cls: &#039;error&#039;
      });
    }
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Combined Search</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/features/combined-search.ts
import { FuzzySuggestModal, TFile } from &#039;obsidian&#039;;
import { AmplifierConnector } from &#039;../connector&#039;;

interface SearchResult {
  type: &#039;note&#039; | &#039;code&#039;;
  title: string;
  excerpt: string;
  path: string;
  line?: number;
}

export class CombinedSearch {
  constructor(private connector: AmplifierConnector) {}

  openSearchModal() {
    new CombinedSearchModal(this.connector).open();
  }

  async search(query: string): Promise&lt;{
    notes: SearchResult[];
    code: SearchResult[];
    summary: string;
  }&gt; {
    // Search notes locally
    const notes = await this.searchNotes(query);

    // Search code via Amplifier
    const codeResponse = await this.connector.execute({
      prompt: `Search the codebase for: &quot;${query}&quot;

Return results as JSON array with fields:
- path: file path
- line: line number
- excerpt: relevant code snippet
- relevance: why this matches`,
      context: { type: &#039;code_search&#039; }
    });

    const code = this.parseCodeResults(codeResponse.response);

    // Generate AI summary
    const summaryResponse = await this.connector.execute({
      prompt: `Summarize these search results for &quot;${query}&quot;:

Notes found: ${notes.length}
${notes.map(n =&gt; `- ${n.title}: ${n.excerpt}`).join(&#039;\n&#039;)}

Code found: ${code.length}
${code.map(c =&gt; `- ${c.path}:${c.line}: ${c.excerpt}`).join(&#039;\n&#039;)}

Provide a brief summary connecting these results.`,
      context: { type: &#039;search_summary&#039; }
    });

    return {
      notes,
      code,
      summary: summaryResponse.response
    };
  }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Amplifier settings in Obsidian
connection:
  mode: local  # local | api
  api_url: https://api.amplifier.example.com
  api_key: xxx

codebase:
  root: /path/to/project
  include:
    - src/**
    - lib/**
  exclude:
    - node_modules/**
    - dist/**

features:
  doc_generation: true
  query_interface: true
  combined_search: true
  code_sync: true
  decision_capture: true

sync:
  auto_sync: false
  check_interval: 300  # seconds

cache:
  enabled: true
  ttl: 3600  # seconds</code></pre>
        </div>
        <p>---</p>
        <h3>Code Block Syntax</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Query Block</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"></code></pre>
        </div>
        <p>query: How does the payment system handle retries?</p>
        <p>include: src/payments/**</p>
        <p>profile: enterprise-dev:analysis</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text"></code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Context Block</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"></code></pre>
        </div>
        <p>related_code:</p>
        <p>  - src/payments/processor.ts</p>
        <p>  - src/payments/retry.ts</p>
        <p>issue: #234</p>
        <p>decision: ADR-005</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text"></code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Synced Code Block</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"></code></pre>
        </div>
        <p>// Code here will be kept in sync</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text"></code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>obsidian:doc_generated</code></td><td>Documentation created</td><td>path, source</td></tr>
            <tr><td><code>obsidian:query_executed</code></td><td>Query completed</td><td>query, results_count</td></tr>
            <tr><td><code>obsidian:search_combined</code></td><td>Combined search done</td><td>query, notes, code</td></tr>
            <tr><td><code>obsidian:code_synced</code></td><td>Code block synced</td><td>file, lines</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Bidirectional sync</strong>: Should code changes update notes automatically?</li>
        <li><strong>Graph integration</strong>: Visualize code-note relationships in graph view?</li>
        <li><strong>Version control</strong>: Track documentation versions with code versions?</li>
        <li><strong>Collaboration</strong>: Share queries and results across team?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-slack" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Slack</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-integration-slack</code></p>
        </div>
        <h3>Overview</h3>
        <p>Slack app integration providing AI-powered assistance directly within team conversations. Enables code questions, incident response, PR notifications, and interactive workflows without leaving Slack.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Context switching to IDE/terminal</td><td>AI assistance in Slack</td></tr>
            <tr><td>Manual incident notifications</td><td>Automated alerts with context</td></tr>
            <tr><td>Separate tools for collaboration</td><td>Unified team AI interface</td></tr>
            <tr><td>No audit trail in conversations</td><td>Integrated team knowledge</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Direct Message Assistant</h4>
        <p>Personal AI assistant for code questions.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">User: @Amplifier How does our payment retry logic work?

Amplifier: Based on the codebase analysis:

**Payment Retry Logic** (`src/services/payment/retry.ts`)

The retry mechanism uses exponential backoff:

1. **Initial attempt** - Direct charge via Stripe
2. **On failure** - Wait 2^attempt seconds (max 5 attempts)
3. **Retry conditions**:
   - Network errors: Always retry
   - Rate limits: Retry with backoff
   - Card declined: No retry, notify user</code></pre>
        </div>
        <p>const RETRY_CONFIG = {</p>
        <p>  maxAttempts: 5,</p>
        <p>  baseDelay: 1000,</p>
        <p>  maxDelay: 32000,</p>
        <p>  retryableErrors: ['network_error', 'rate_limit']</p>
        <p>};</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Want me to explain any specific part?</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Channel Integration</h4>
        <p>Team-wide AI assistance in public channels.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">#engineering channel:

Sarah: @Amplifier What&#039;s the status of PR #1234?

Amplifier: **PR #1234: Add user authentication**

ðŸ“Š **Status**: Ready for review
ðŸ‘¤ **Author**: @john
ðŸ“ **Changes**: +423 / -89 lines across 12 files

**AI Review Summary**:
- âœ… Security: No issues found
- âš ï¸ Code Quality: 2 suggestions
- âœ… Tests: Coverage increased to 87%

**Suggested Reviewers**: @alice (auth expert), @bob (security)

[View PR](https://github.com/org/repo/pull/1234) | [Full Review](link)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Incident Response Bot</h4>
        <p>Automated incident assistance.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">#incidents channel:

ðŸš¨ **Incident Alert** (triggered by PagerDuty)
Service: payment-api
Status: HIGH_ERROR_RATE
Started: 5 minutes ago

Amplifier: ðŸ” **Investigating incident...**

**Initial Analysis**:
- Error rate spiked from 0.1% to 15% at 14:23 UTC
- Affected endpoint: POST /api/payments
- Recent deployment: `payment-api@v2.3.1` (deployed 14:20 UTC)

**Likely Cause**:
Database connection pool exhaustion. `payment-api@v2.3.1`
increased pool size from 10 to 50, but RDS max_connections is 100.

**Recommended Actions**:
1. ðŸ”„ Rollback to `payment-api@v2.3.0`
2. ðŸ“Š Monitor error rate recovery
3. ðŸ”§ Increase RDS max_connections before redeploying

React with âœ… to execute rollback, âŒ to dismiss.</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. PR Notifications</h4>
        <p>Smart PR lifecycle notifications.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Notification triggers
notifications:
  pr_opened:
    channel: &quot;#code-review&quot;
    include_ai_summary: true
    mention_suggested_reviewers: true

  pr_review_completed:
    channel: &quot;#code-review&quot;
    include_ai_summary: true

  pr_merged:
    channel: &quot;#deployments&quot;
    include_changelog_entry: true

  ci_failed:
    channel: &quot;#ci-alerts&quot;
    include_ai_diagnosis: true</code></pre>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">#code-review channel:

ðŸ“¬ **New PR: Implement rate limiting** (#1456)
Author: @alice | +156 / -23 | 4 files

**AI Summary**: Adds Redis-based rate limiting to API endpoints.
Implements token bucket algorithm with configurable limits per user tier.

**Key Changes**:
- New `RateLimiter` middleware
- Redis integration for distributed counting
- Configuration via environment variables

**Suggested Reviewers**: @bob (API), @carol (Redis)

[Review PR](link) | [View Changes](link)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Slash Commands</h4>
        <p>Interactive commands for common workflows.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">/amplifier review https://github.com/org/repo/pull/1234
/amplifier search &quot;payment retry logic&quot;
/amplifier explain src/services/auth.ts
/amplifier incident start &quot;API latency spike&quot;
/amplifier deploy staging payment-api</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">6. Interactive Workflows</h4>
        <p>Button-based workflows for approvals and actions.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Amplifier: ðŸš€ **Deployment Request**

Service: `payment-api`
Version: `v2.3.2`
Environment: `staging`
Requested by: @john

**Pre-deployment Checks**:
- âœ… Tests passing
- âœ… Security scan clean
- âœ… No breaking changes detected

[Approve] [Reject] [Request Changes]

---

@alice clicked [Approve]

Amplifier: âœ… Deployment approved by @alice
Deploying `payment-api@v2.3.2` to staging...

Deployment complete!
ðŸ”— https://staging.example.com/api/health</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Slack Integration                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Event       â”‚    â”‚ Slash       â”‚    â”‚ Interactive â”‚             â”‚
â”‚  â”‚ Handler     â”‚    â”‚ Commands    â”‚    â”‚ Components  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                  â”‚                  â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                            â–¼                                        â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                   â”‚ Request Router  â”‚                               â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                            â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚         â–¼                  â–¼                  â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Context     â”‚   â”‚ Amplifier   â”‚   â”‚ Response    â”‚              â”‚
â”‚  â”‚ Builder     â”‚   â”‚ Session     â”‚   â”‚ Formatter   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Notification Service (webhooks, scheduled, event-driven)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Event Handler</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># handlers/events.py

from slack_bolt import App
from slack_bolt.adapter.socket_mode import SocketModeHandler
from amplifier import AmplifierSession

app = App(token=os.environ[&quot;SLACK_BOT_TOKEN&quot;])

@app.event(&quot;app_mention&quot;)
async def handle_mention(event, say, client):
    &quot;&quot;&quot;Handle @Amplifier mentions in channels.&quot;&quot;&quot;

    user = event[&quot;user&quot;]
    channel = event[&quot;channel&quot;]
    text = event[&quot;text&quot;]
    thread_ts = event.get(&quot;thread_ts&quot;, event[&quot;ts&quot;])

    # Remove bot mention from text
    query = remove_mention(text)

    # Build context from thread history
    context = await build_thread_context(client, channel, thread_ts)

    # Get channel-specific configuration
    config = get_channel_config(channel)

    # Execute with Amplifier
    async with AmplifierSession(config=config) as session:
        result = await session.execute(
            prompt=query,
            context={
                &quot;slack_channel&quot;: channel,
                &quot;slack_user&quot;: user,
                &quot;thread_context&quot;: context
            }
        )

    # Format and send response
    blocks = format_response_blocks(result)
    await say(blocks=blocks, thread_ts=thread_ts)


@app.event(&quot;message&quot;)
async def handle_dm(event, say):
    &quot;&quot;&quot;Handle direct messages to the bot.&quot;&quot;&quot;

    # Only handle DMs
    if event.get(&quot;channel_type&quot;) != &quot;im&quot;:
        return

    user = event[&quot;user&quot;]
    text = event[&quot;text&quot;]

    # Get user-specific context
    user_context = await get_user_context(user)

    # Execute with Amplifier
    async with AmplifierSession(config=DM_CONFIG) as session:
        result = await session.execute(
            prompt=text,
            context={
                &quot;user&quot;: user,
                &quot;user_projects&quot;: user_context.get(&quot;projects&quot;),
                &quot;user_repositories&quot;: user_context.get(&quot;repositories&quot;)
            }
        )

    # Send response
    await say(text=result.response)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Slash Commands</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># handlers/commands.py

@app.command(&quot;/amplifier&quot;)
async def handle_command(ack, command, respond):
    &quot;&quot;&quot;Handle /amplifier slash commands.&quot;&quot;&quot;

    await ack()  # Acknowledge immediately

    text = command[&quot;text&quot;]
    user = command[&quot;user_id&quot;]
    channel = command[&quot;channel_id&quot;]

    # Parse command
    parts = text.split(maxsplit=1)
    action = parts[0] if parts else &quot;help&quot;
    args = parts[1] if len(parts) &gt; 1 else &quot;&quot;

    # Route to handler
    handlers = {
        &quot;review&quot;: handle_review_command,
        &quot;search&quot;: handle_search_command,
        &quot;explain&quot;: handle_explain_command,
        &quot;incident&quot;: handle_incident_command,
        &quot;deploy&quot;: handle_deploy_command,
        &quot;help&quot;: handle_help_command
    }

    handler = handlers.get(action, handle_unknown_command)
    await handler(respond, user, channel, args)


async def handle_review_command(respond, user, channel, args):
    &quot;&quot;&quot;Handle /amplifier review &lt;pr_url&gt;&quot;&quot;&quot;

    pr_url = args.strip()

    if not pr_url:
        await respond(&quot;Usage: `/amplifier review &lt;pr_url&gt;`&quot;)
        return

    # Show loading state
    await respond({
        &quot;response_type&quot;: &quot;in_channel&quot;,
        &quot;text&quot;: f&quot;ðŸ” Analyzing PR: {pr_url}...&quot;
    })

    # Execute PR review
    async with AmplifierSession(config=PR_REVIEW_CONFIG) as session:
        result = await session.execute(
            prompt=&quot;Review this PR&quot;,
            context={&quot;pr_url&quot;: pr_url}
        )

    # Format as Slack blocks
    blocks = format_pr_review_blocks(result)

    await respond({
        &quot;response_type&quot;: &quot;in_channel&quot;,
        &quot;blocks&quot;: blocks
    })


async def handle_incident_command(respond, user, channel, args):
    &quot;&quot;&quot;Handle /amplifier incident &lt;action&gt; [args]&quot;&quot;&quot;

    parts = args.split(maxsplit=1)
    action = parts[0] if parts else &quot;help&quot;
    details = parts[1] if len(parts) &gt; 1 else &quot;&quot;

    if action == &quot;start&quot;:
        # Create incident channel
        incident_id = generate_incident_id()
        incident_channel = await create_incident_channel(incident_id, details)

        # Start incident response workflow
        async with AmplifierSession(config=INCIDENT_CONFIG) as session:
            result = await session.execute(
                prompt=f&quot;Start incident response: {details}&quot;,
                context={
                    &quot;incident_id&quot;: incident_id,
                    &quot;reported_by&quot;: user,
                    &quot;description&quot;: details
                }
            )

        await respond({
            &quot;response_type&quot;: &quot;in_channel&quot;,
            &quot;blocks&quot;: [
                {
                    &quot;type&quot;: &quot;section&quot;,
                    &quot;text&quot;: {
                        &quot;type&quot;: &quot;mrkdwn&quot;,
                        &quot;text&quot;: f&quot;ðŸš¨ Incident `{incident_id}` created\n&quot;
                               f&quot;Channel: &lt;#{incident_channel}&gt;&quot;
                    }
                }
            ]
        })</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Interactive Components</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># handlers/interactions.py

@app.action(&quot;approve_deployment&quot;)
async def handle_deployment_approval(ack, body, client):
    &quot;&quot;&quot;Handle deployment approval button click.&quot;&quot;&quot;

    await ack()

    user = body[&quot;user&quot;][&quot;id&quot;]
    deployment_id = body[&quot;actions&quot;][0][&quot;value&quot;]

    # Verify user has approval permission
    if not await can_approve_deployment(user, deployment_id):
        await client.chat_postEphemeral(
            channel=body[&quot;channel&quot;][&quot;id&quot;],
            user=user,
            text=&quot;âŒ You don&#039;t have permission to approve this deployment.&quot;
        )
        return

    # Update message to show approval
    await client.chat_update(
        channel=body[&quot;channel&quot;][&quot;id&quot;],
        ts=body[&quot;message&quot;][&quot;ts&quot;],
        blocks=format_approved_deployment_blocks(deployment_id, user)
    )

    # Execute deployment
    async with AmplifierSession(config=DEPLOY_CONFIG) as session:
        result = await session.execute(
            prompt=&quot;Execute approved deployment&quot;,
            context={
                &quot;deployment_id&quot;: deployment_id,
                &quot;approved_by&quot;: user
            }
        )

    # Post deployment result
    await client.chat_postMessage(
        channel=body[&quot;channel&quot;][&quot;id&quot;],
        thread_ts=body[&quot;message&quot;][&quot;ts&quot;],
        blocks=format_deployment_result_blocks(result)
    )


@app.action(&quot;rollback_deployment&quot;)
async def handle_rollback(ack, body, client):
    &quot;&quot;&quot;Handle rollback button click during incident.&quot;&quot;&quot;

    await ack()

    user = body[&quot;user&quot;][&quot;id&quot;]
    rollback_info = json.loads(body[&quot;actions&quot;][0][&quot;value&quot;])

    # Require confirmation for production
    if rollback_info[&quot;environment&quot;] == &quot;production&quot;:
        await show_rollback_confirmation_modal(client, body, rollback_info)
        return

    # Execute rollback
    await execute_rollback(client, body, rollback_info, user)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Notification Service</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># services/notifications.py

class SlackNotificationService:
    &quot;&quot;&quot;Send notifications to Slack channels.&quot;&quot;&quot;

    def __init__(self, client: WebClient, config: NotificationConfig):
        self.client = client
        self.config = config

    async def notify_pr_opened(self, pr_data: dict) -&gt; None:
        &quot;&quot;&quot;Notify channel of new PR with AI summary.&quot;&quot;&quot;

        channel = self.config.get_channel(&quot;pr_opened&quot;)
        if not channel:
            return

        # Generate AI summary if enabled
        summary = None
        if self.config.include_ai_summary:
            async with AmplifierSession(config=SUMMARY_CONFIG) as session:
                summary = await session.execute(
                    prompt=&quot;Summarize this PR for team review&quot;,
                    context={&quot;pr&quot;: pr_data}
                )

        # Build notification blocks
        blocks = self._build_pr_opened_blocks(pr_data, summary)

        # Send notification
        await self.client.chat_postMessage(
            channel=channel,
            blocks=blocks
        )

    async def notify_incident(
        self,
        incident: dict,
        analysis: dict | None = None
    ) -&gt; str:
        &quot;&quot;&quot;Notify incidents channel and return message ts for threading.&quot;&quot;&quot;

        channel = self.config.get_channel(&quot;incidents&quot;)

        blocks = self._build_incident_blocks(incident, analysis)

        response = await self.client.chat_postMessage(
            channel=channel,
            blocks=blocks
        )

        return response[&quot;ts&quot;]

    async def notify_ci_failure(self, build_data: dict) -&gt; None:
        &quot;&quot;&quot;Notify of CI failure with AI diagnosis.&quot;&quot;&quot;

        channel = self.config.get_channel(&quot;ci_failed&quot;)
        if not channel:
            return

        # Generate AI diagnosis
        diagnosis = None
        if self.config.include_ai_diagnosis:
            async with AmplifierSession(config=CI_DIAGNOSIS_CONFIG) as session:
                diagnosis = await session.execute(
                    prompt=&quot;Diagnose this CI failure&quot;,
                    context={&quot;build&quot;: build_data}
                )

        blocks = self._build_ci_failure_blocks(build_data, diagnosis)

        await self.client.chat_postMessage(
            channel=channel,
            blocks=blocks
        )

    def _build_pr_opened_blocks(
        self,
        pr_data: dict,
        summary: dict | None
    ) -&gt; list[dict]:
        &quot;&quot;&quot;Build Slack blocks for PR opened notification.&quot;&quot;&quot;

        blocks = [
            {
                &quot;type&quot;: &quot;header&quot;,
                &quot;text&quot;: {
                    &quot;type&quot;: &quot;plain_text&quot;,
                    &quot;text&quot;: f&quot;ðŸ“¬ New PR: {pr_data[&#039;title&#039;]}&quot;
                }
            },
            {
                &quot;type&quot;: &quot;section&quot;,
                &quot;fields&quot;: [
                    {&quot;type&quot;: &quot;mrkdwn&quot;, &quot;text&quot;: f&quot;*Author:* &lt;@{pr_data[&#039;author_slack&#039;]}&gt;&quot;},
                    {&quot;type&quot;: &quot;mrkdwn&quot;, &quot;text&quot;: f&quot;*Changes:* +{pr_data[&#039;additions&#039;]} / -{pr_data[&#039;deletions&#039;]}&quot;},
                    {&quot;type&quot;: &quot;mrkdwn&quot;, &quot;text&quot;: f&quot;*Files:* {pr_data[&#039;changed_files&#039;]}&quot;},
                    {&quot;type&quot;: &quot;mrkdwn&quot;, &quot;text&quot;: f&quot;*Branch:* `{pr_data[&#039;head_branch&#039;]}`&quot;}
                ]
            }
        ]

        if summary:
            blocks.append({
                &quot;type&quot;: &quot;section&quot;,
                &quot;text&quot;: {
                    &quot;type&quot;: &quot;mrkdwn&quot;,
                    &quot;text&quot;: f&quot;*AI Summary:*\n{summary.response[:500]}&quot;
                }
            })

        # Suggested reviewers
        if pr_data.get(&quot;suggested_reviewers&quot;):
            reviewers = &quot;, &quot;.join(
                f&quot;&lt;@{r[&#039;slack_id&#039;]}&gt;&quot; for r in pr_data[&quot;suggested_reviewers&quot;]
            )
            blocks.append({
                &quot;type&quot;: &quot;section&quot;,
                &quot;text&quot;: {
                    &quot;type&quot;: &quot;mrkdwn&quot;,
                    &quot;text&quot;: f&quot;*Suggested Reviewers:* {reviewers}&quot;
                }
            })

        blocks.append({
            &quot;type&quot;: &quot;actions&quot;,
            &quot;elements&quot;: [
                {
                    &quot;type&quot;: &quot;button&quot;,
                    &quot;text&quot;: {&quot;type&quot;: &quot;plain_text&quot;, &quot;text&quot;: &quot;Review PR&quot;},
                    &quot;url&quot;: pr_data[&quot;url&quot;],
                    &quot;action_id&quot;: &quot;view_pr&quot;
                },
                {
                    &quot;type&quot;: &quot;button&quot;,
                    &quot;text&quot;: {&quot;type&quot;: &quot;plain_text&quot;, &quot;text&quot;: &quot;AI Review&quot;},
                    &quot;action_id&quot;: &quot;request_ai_review&quot;,
                    &quot;value&quot;: json.dumps({&quot;pr_url&quot;: pr_data[&quot;url&quot;]})
                }
            ]
        })

        return blocks</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Context Builder</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># services/context.py

async def build_thread_context(
    client: WebClient,
    channel: str,
    thread_ts: str
) -&gt; dict:
    &quot;&quot;&quot;Build context from Slack thread history.&quot;&quot;&quot;

    # Get thread messages
    response = await client.conversations_replies(
        channel=channel,
        ts=thread_ts,
        limit=20
    )

    messages = response.get(&quot;messages&quot;, [])

    # Extract relevant context
    context = {
        &quot;thread_summary&quot;: summarize_thread(messages),
        &quot;participants&quot;: extract_participants(messages),
        &quot;mentioned_files&quot;: extract_file_mentions(messages),
        &quot;mentioned_prs&quot;: extract_pr_mentions(messages),
        &quot;mentioned_issues&quot;: extract_issue_mentions(messages)
    }

    return context


async def get_user_context(user_id: str) -&gt; dict:
    &quot;&quot;&quot;Get user-specific context for personalized responses.&quot;&quot;&quot;

    # Get user&#039;s recent activity
    recent_prs = await get_user_recent_prs(user_id)
    recent_commits = await get_user_recent_commits(user_id)
    assigned_issues = await get_user_assigned_issues(user_id)

    # Get user&#039;s team and repositories
    team_info = await get_user_team(user_id)

    return {
        &quot;recent_prs&quot;: recent_prs,
        &quot;recent_commits&quot;: recent_commits,
        &quot;assigned_issues&quot;: assigned_issues,
        &quot;team&quot;: team_info.get(&quot;team&quot;),
        &quot;repositories&quot;: team_info.get(&quot;repositories&quot;),
        &quot;role&quot;: team_info.get(&quot;role&quot;)
    }</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">App Manifest</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># manifest.yaml
display_information:
  name: Amplifier
  description: AI-powered code assistant
  background_color: &quot;#4A154B&quot;

features:
  bot_user:
    display_name: Amplifier
    always_online: true
  slash_commands:
    - command: /amplifier
      description: AI-powered code assistance
      usage_hint: &quot;[review|search|explain|incident|deploy] [args]&quot;

oauth_config:
  scopes:
    bot:
      - app_mentions:read
      - channels:history
      - channels:read
      - chat:write
      - commands
      - files:read
      - groups:history
      - groups:read
      - im:history
      - im:read
      - im:write
      - reactions:read
      - reactions:write
      - users:read
      - users:read.email

settings:
  event_subscriptions:
    bot_events:
      - app_mention
      - message.im
      - message.channels
      - reaction_added
  interactivity:
    is_enabled: true
  socket_mode_enabled: true</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Configuration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># .amplifier/integrations/slack.yaml
slack:
  enabled: true

  # Authentication
  auth:
    bot_token: ${SLACK_BOT_TOKEN}
    app_token: ${SLACK_APP_TOKEN}  # For socket mode
    signing_secret: ${SLACK_SIGNING_SECRET}

  # Channel mappings
  channels:
    code_review: &quot;#code-review&quot;
    incidents: &quot;#incidents&quot;
    deployments: &quot;#deployments&quot;
    ci_alerts: &quot;#ci-alerts&quot;
    general_support: &quot;#engineering&quot;

  # Feature configuration
  features:
    direct_messages: true
    channel_mentions: true
    slash_commands: true
    interactive_components: true

    # AI features per channel type
    ai_summaries:
      pr_notifications: true
      incident_alerts: true
      ci_failures: true

    # Incident response
    incidents:
      auto_create_channel: true
      channel_prefix: &quot;inc-&quot;
      invite_oncall: true
      post_runbook_links: true

  # Notification rules
  notifications:
    pr_opened:
      enabled: true
      channel: code_review
      include_ai_summary: true
      mention_suggested_reviewers: true
      min_lines_changed: 10  # Skip trivial PRs

    pr_merged:
      enabled: true
      channel: deployments
      include_changelog: true

    ci_failed:
      enabled: true
      channel: ci_alerts
      include_ai_diagnosis: true
      only_main_branch: true

    incident_triggered:
      enabled: true
      channel: incidents
      auto_investigate: true

  # Rate limiting
  rate_limits:
    mentions_per_minute: 30
    slash_commands_per_minute: 60
    notifications_per_minute: 20

  # User mapping
  user_mapping:
    source: ldap  # ldap | github | manual
    github_to_slack:
      johndoe: U01234567
      janedoe: U01234568</code></pre>
        </div>
        <p>---</p>
        <h3>Security</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Access Control</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># security/access.py

class SlackAccessControl:
    &quot;&quot;&quot;Control access to Amplifier features in Slack.&quot;&quot;&quot;

    def __init__(self, config: AccessConfig):
        self.config = config

    async def can_use_feature(
        self,
        user_id: str,
        feature: str,
        channel_id: str
    ) -&gt; bool:
        &quot;&quot;&quot;Check if user can use feature in channel.&quot;&quot;&quot;

        # Get user info
        user_groups = await self.get_user_groups(user_id)
        channel_type = await self.get_channel_type(channel_id)

        # Check feature-specific rules
        rules = self.config.get_feature_rules(feature)

        # Allow if user is in allowed groups
        if rules.allowed_groups:
            if not any(g in user_groups for g in rules.allowed_groups):
                return False

        # Check channel restrictions
        if rules.allowed_channels:
            if channel_id not in rules.allowed_channels:
                return False

        # Check channel type restrictions
        if rules.allowed_channel_types:
            if channel_type not in rules.allowed_channel_types:
                return False

        return True

    async def can_approve_deployment(
        self,
        user_id: str,
        deployment: dict
    ) -&gt; bool:
        &quot;&quot;&quot;Check if user can approve deployment.&quot;&quot;&quot;

        environment = deployment.get(&quot;environment&quot;)
        service = deployment.get(&quot;service&quot;)

        # Get approval rules for environment
        rules = self.config.get_approval_rules(environment)

        # Check if user is in approvers list
        user_groups = await self.get_user_groups(user_id)

        for required_group in rules.required_groups:
            if required_group in user_groups:
                return True

        # Check service-specific owners
        if service in rules.service_owners:
            if user_id in rules.service_owners[service]:
                return True

        return False</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Audit Logging</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># security/audit.py

class SlackAuditLogger:
    &quot;&quot;&quot;Log all Slack interactions for audit.&quot;&quot;&quot;

    async def log_interaction(
        self,
        interaction_type: str,
        user_id: str,
        channel_id: str,
        details: dict
    ) -&gt; None:
        &quot;&quot;&quot;Log Slack interaction.&quot;&quot;&quot;

        await self.emit_event(&quot;slack:interaction&quot;, {
            &quot;type&quot;: interaction_type,
            &quot;user_id&quot;: user_id,
            &quot;channel_id&quot;: channel_id,
            &quot;timestamp&quot;: datetime.utcnow().isoformat(),
            &quot;details&quot;: details
        })

    async def log_deployment_approval(
        self,
        user_id: str,
        deployment_id: str,
        approved: bool,
        reason: str | None = None
    ) -&gt; None:
        &quot;&quot;&quot;Log deployment approval decision.&quot;&quot;&quot;

        await self.emit_event(&quot;slack:deployment_approval&quot;, {
            &quot;user_id&quot;: user_id,
            &quot;deployment_id&quot;: deployment_id,
            &quot;approved&quot;: approved,
            &quot;reason&quot;: reason,
            &quot;timestamp&quot;: datetime.utcnow().isoformat()
        })</code></pre>
        </div>
        <p>---</p>
        <h3>Response Formatting</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Block Builders</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># formatters/blocks.py

def format_code_block(code: str, language: str = &quot;&quot;) -&gt; dict:
    &quot;&quot;&quot;Format code as Slack code block.&quot;&quot;&quot;
    return {
        &quot;type&quot;: &quot;section&quot;,
        &quot;text&quot;: {
            &quot;type&quot;: &quot;mrkdwn&quot;,
            &quot;text&quot;: f&quot;```{language}\n{code}\n```&quot;
        }
    }


def format_file_reference(file_path: str, line: int | None = None) -&gt; str:
    &quot;&quot;&quot;Format file reference with optional line number.&quot;&quot;&quot;
    if line:
        return f&quot;`{file_path}:{line}`&quot;
    return f&quot;`{file_path}`&quot;


def format_error_response(error: str, suggestion: str | None = None) -&gt; list[dict]:
    &quot;&quot;&quot;Format error response blocks.&quot;&quot;&quot;
    blocks = [
        {
            &quot;type&quot;: &quot;section&quot;,
            &quot;text&quot;: {
                &quot;type&quot;: &quot;mrkdwn&quot;,
                &quot;text&quot;: f&quot;âŒ {error}&quot;
            }
        }
    ]

    if suggestion:
        blocks.append({
            &quot;type&quot;: &quot;context&quot;,
            &quot;elements&quot;: [
                {
                    &quot;type&quot;: &quot;mrkdwn&quot;,
                    &quot;text&quot;: f&quot;ðŸ’¡ {suggestion}&quot;
                }
            ]
        })

    return blocks


def truncate_for_slack(text: str, max_length: int = 3000) -&gt; str:
    &quot;&quot;&quot;Truncate text to fit Slack&#039;s limits.&quot;&quot;&quot;
    if len(text) &lt;= max_length:
        return text
    return text[:max_length - 20] + &quot;\n\n... (truncated)&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-tauri-desktop" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Tauri Desktop</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <h3>Overview</h3>
        <p>Amplifier Desktop is a Tauri-based native desktop application providing a full-featured AI coding assistant. It uses a three-tier architecture with WebSocket streaming for real-time communication between the React frontend and Python sidecar.</p>
        <p><strong>Value Proposition:</strong></p>
        <li>Native desktop experience with system tray, notifications, keyboard shortcuts</li>
        <li>Offline-capable with local providers (Ollama)</li>
        <li>Real-time streaming UI with thinking blocks and tool execution visualization</li>
        <li>Cross-platform: macOS, Windows, Linux</li>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Three-Tier Design</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TAURI SHELL (Rust)                            â”‚
â”‚  - Window management, system tray, native menus                         â”‚
â”‚  - Sidecar process management (spawn, health check, restart)            â”‚
â”‚  - SQLite database (conversations, messages, settings)                  â”‚
â”‚  - IPC bridge between frontend and native APIs                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
                    â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     REACT FRONTEND (TS)       â”‚   â”‚      PYTHON SIDECAR (FastAPI)     â”‚
â”‚                               â”‚   â”‚                                   â”‚
â”‚  - Zustand state management   â”‚â—„â”€â–ºâ”‚  - AmplifierSession orchestration â”‚
â”‚  - WebSocket client           â”‚WS â”‚  - Provider loading (local/cached)â”‚
â”‚  - Markdown rendering         â”‚   â”‚  - Tool execution                 â”‚
â”‚  - Thinking/tool UI           â”‚   â”‚  - Hook event emission            â”‚
â”‚  - Settings/profiles UI       â”‚   â”‚  - Memory extraction              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Locations</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Layer</th><th>Directory</th><th>Key Files</th></tr>
          </thead>
          <tbody>
            <tr><td>Tauri Shell</td><td><code>src-tauri/</code></td><td><code>lib.rs</code>, <code>main.rs</code>, <code>Cargo.toml</code></td></tr>
            <tr><td>React Frontend</td><td><code>src/</code></td><td><code>App.tsx</code>, <code>components/</code>, <code>hooks/</code>, <code>lib/</code></td></tr>
            <tr><td>Python Sidecar</td><td><code>sidecar/</code></td><td><code>server.py</code>, <code>local_modules.py</code>, <code>config.py</code></td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Streaming Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">User Input â†’ WebSocket â†’ Sidecar â†’ AmplifierSession â†’ Provider
                                                          â”‚
                                                          â–¼
UI Update â† WebSocket â† Hooks â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Streaming Events</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">WebSocket Message Protocol</h4>
        <p><strong>Client â†’ Server (Request Types)</strong></p>
        <table class="ref-table">
          <thead>
            <tr><th>Type</th><th>Purpose</th><th>Payload</th></tr>
          </thead>
          <tbody>
            <tr><td><code>prompt</code></td><td>Send user message</td><td><code>{content, images?, history?, conversationId}</code></td></tr>
            <tr><td><code>cancel</code></td><td>Stop execution</td><td><code>{conversationId}</code></td></tr>
            <tr><td><code>clear</code></td><td>Reset session</td><td><code>{}</code></td></tr>
            <tr><td><code>settings</code></td><td>Sync settings</td><td><code>{}</code> (triggers backend reload)</td></tr>
          </tbody>
        </table>
        <p><strong>Server â†’ Client (Response Types)</strong></p>
        <table class="ref-table">
          <thead>
            <tr><th>Type</th><th>Purpose</th><th>Payload</th></tr>
          </thead>
          <tbody>
            <tr><td><code>delta</code></td><td>Incremental text content</td><td><code>{content: string, conversationId}</code></td></tr>
            <tr><td><code>thinking</code></td><td>Extended thinking content</td><td><code>{content: string, conversationId}</code></td></tr>
            <tr><td><code>tool_start</code></td><td>Tool execution begins</td><td><code>{content: toolName, metadata: {input, call_id}}</code></td></tr>
            <tr><td><code>tool_end</code></td><td>Tool execution complete</td><td><code>{content: toolName, metadata: {output, success}}</code></td></tr>
            <tr><td><code>done</code></td><td>Response complete</td><td><code>{content: response, metadata: {tokens, cost}}</code></td></tr>
            <tr><td><code>error</code></td><td>Error occurred</td><td><code>{content: errorMessage}</code></td></tr>
            <tr><td><code>cancelled</code></td><td>Execution stopped</td><td><code>{content: "Execution stopped by user"}</code></td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Hook-to-WebSocket Mapping</h4>
        <p>The sidecar registers hooks on <code>AmplifierSession.coordinator.hooks</code> that convert provider events to WebSocket messages:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># server.py - Hook Registration
hooks.register(&quot;content_block:delta&quot;, on_content_delta)   â†’ type=&quot;delta&quot;
hooks.register(&quot;thinking:delta&quot;, on_thinking_delta)       â†’ type=&quot;thinking&quot;
hooks.register(&quot;tool:pre&quot;, on_tool_pre)                   â†’ type=&quot;tool_start&quot;
hooks.register(&quot;tool:post&quot;, on_tool_post)                 â†’ type=&quot;tool_end&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Streaming vs Non-Streaming Providers</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Provider Source</th><th>Streaming Support</th><th>Event Emission</th></tr>
          </thead>
          <tbody>
            <tr><td>Local (<code>sidecar/providers/</code>)</td><td>Yes</td><td>Emits <code>content_block:delta</code> during API streaming</td></tr>
            <tr><td>Cached (<code>~/.amplifier/module-cache/</code>)</td><td>No</td><td>Returns complete response</td></tr>
          </tbody>
        </table>
        <p><strong>Non-Streaming Fallback:</strong></p>
        <p>When using cached providers (Amplifier mode), the sidecar extracts content from the complete response and sends synthetic delta messages:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># server.py - Fallback for non-streaming providers
if response and not self._streaming_happened:
    if response_thinking:
        await self._send(websocket, StreamMessage(type=&quot;thinking&quot;, content=response_thinking))
    if response_text:
        await self._send(websocket, StreamMessage(type=&quot;delta&quot;, content=response_text))</code></pre>
        </div>
        <p>---</p>
        <h3>Frontend State Management</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Zustand Store (`src/lib/store.ts`)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">interface ChatState {
  conversations: Conversation[];
  currentConversationId: string | null;

  // Actions for streaming
  addMessage: (msg: Message) =&gt; void;
  appendToMessage: (id: string, delta: string) =&gt; void;
  appendThinking: (id: string, delta: string) =&gt; void;
  addToolCall: (msgId: string, toolCall: ToolCall) =&gt; void;
  updateToolCall: (msgId: string, callId: string, update: Partial&lt;ToolCall&gt;) =&gt; void;
  updateMessage: (id: string, update: Partial&lt;Message&gt;) =&gt; void;
}

interface Message {
  id: string;
  role: &#039;user&#039; | &#039;assistant&#039;;
  content: string;           // Accumulated from &#039;delta&#039; messages
  thinking?: string;         // Accumulated from &#039;thinking&#039; messages
  toolCalls?: ToolCall[];    // From tool_start/tool_end
  isStreaming: boolean;      // True while receiving
  contentParts?: ContentBlock[]; // Structured blocks from &#039;done&#039;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Message Accumulation Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">1. User submits prompt
   â””â”€â–º addMessage({id: streamingId, role: &#039;assistant&#039;, isStreaming: true, content: &#039;&#039;})

2. Delta arrives
   â””â”€â–º appendToMessage(streamingId, delta.content)
   â””â”€â–º UI re-renders with accumulated content

3. Thinking arrives
   â””â”€â–º appendThinking(streamingId, thinking.content)
   â””â”€â–º ThinkingBlock expands

4. Tool starts
   â””â”€â–º addToolCall(streamingId, {name, input, status: &#039;running&#039;})
   â””â”€â–º ToolCallDisplay shows spinner

5. Tool ends
   â””â”€â–º updateToolCall(streamingId, callId, {output, status: &#039;complete&#039;})
   â””â”€â–º ToolCallDisplay shows result

6. Done arrives
   â””â”€â–º updateMessage(streamingId, {isStreaming: false, contentParts})
   â””â”€â–º Final render with all content</code></pre>
        </div>
        <p>---</p>
        <h3>UI Components</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Hierarchy</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">ChatContainer
â”œâ”€â”€ MessageList
â”‚   â””â”€â”€ ChatMessage (for each message)
â”‚       â”œâ”€â”€ ThinkingBlock (collapsible)
â”‚       â”œâ”€â”€ ToolCallDisplay[] (for each tool call)
â”‚       â”‚   â”œâ”€â”€ Tool name + input preview
â”‚       â”‚   â”œâ”€â”€ Spinner (while running)
â”‚       â”‚   â””â”€â”€ Output (when complete)
â”‚       â””â”€â”€ MarkdownRenderer (main content)
â”‚           â”œâ”€â”€ Code blocks with syntax highlighting
â”‚           â”œâ”€â”€ Tables, lists, headings
â”‚           â””â”€â”€ Inline code, links
â”œâ”€â”€ ChatInput
â”‚   â”œâ”€â”€ Textarea with Ctrl+Enter submit
â”‚   â”œâ”€â”€ Image attachment button
â”‚   â””â”€â”€ Send/Cancel button
â””â”€â”€ StatusBar
    â””â”€â”€ Token count, cost estimate, model info</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Key Component Files</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Component</th><th>File</th><th>Purpose</th></tr>
          </thead>
          <tbody>
            <tr><td>ChatMessage</td><td><code>src/components/ChatMessage.tsx</code></td><td>Message container, role-based styling</td></tr>
            <tr><td>ThinkingBlock</td><td><code>src/components/ThinkingBlock.tsx</code></td><td>Collapsible thinking content</td></tr>
            <tr><td>ToolCallDisplay</td><td><code>src/components/ToolCallDisplay.tsx</code></td><td>Tool execution visualization</td></tr>
            <tr><td>MarkdownRenderer</td><td><code>src/components/MarkdownRenderer.tsx</code></td><td>react-markdown with plugins</td></tr>
            <tr><td>ChatInput</td><td><code>src/components/ChatInput.tsx</code></td><td>User input with image support</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Provider Configuration</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Execution Modes</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Mode</th><th>Provider Source</th><th>Use Case</th></tr>
          </thead>
          <tbody>
            <tr><td><code>local</code></td><td><code>sidecar/providers/</code></td><td>Development, offline, custom providers</td></tr>
            <tr><td><code>amplifier</code></td><td><code>~/.amplifier/module-cache/</code></td><td>Production, versioned modules</td></tr>
            <tr><td><code>hybrid</code></td><td>Cache preferred, local fallback</td><td>Recommended default</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Extended Thinking</h4>
        <p>Extended thinking (Claude's internal reasoning) requires:</p>
        <li><strong>Model support</strong>: Opus 4.5, Sonnet 4.5 with thinking capability</li>
        <li><strong>Provider configuration</strong>: <code>extended_thinking=True</code> kwarg</li>
        <li><strong>UI handling</strong>: ThinkingBlock component renders collapsed by default</li>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># local_modules.py - Enable thinking for capable models
if reasoning_cap:
    provider_kwargs[&quot;extended_thinking&quot;] = True
    provider_kwargs[&quot;thinking_budget_tokens&quot;] = 8192
return await provider.complete(request, **provider_kwargs)</code></pre>
        </div>
        <p>---</p>
        <h3>Session Management</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Session Pool (`server.py`)</h4>
        <p>Sessions are cached per conversation with config-based invalidation:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SessionPool:
    sessions: dict[str, AmplifierSession]

    async def get_or_create_session(self, conversation_id, websocket, provider, model):
        # Hash current config
        config_hash = hash(provider + model + settings_json)

        existing = self.sessions.get(conversation_id)
        if existing and existing._config_hash == config_hash:
            # Reuse session, update websocket reference
            self._websocket = websocket
            return existing

        # Create new session
        session = AmplifierSession(config, loader=LocalLoader(...))
        await session.initialize()
        self.sessions[conversation_id] = session
        return session</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Context Restoration</h4>
        <p>When switching conversations, message history is restored to the session:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def restore_context(self, session, history):
    for msg in history:
        session.coordinator.context.add_message(
            role=msg.role,
            content=msg.content,
            tool_calls=msg.tool_calls
        )</code></pre>
        </div>
        <p>---</p>
        <h3>Settings &amp; Profiles</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Settings Hierarchy</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">1. Profile settings (from active profile YAML)
2. Global settings (~/.amplifier/settings.yaml)
3. Environment variables
4. Defaults (hardcoded)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Profile Format</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># ~/.amplifier/profiles/dev.md
---
name: dev
version: &quot;1.0&quot;
description: Development profile

providers:
  - module: provider-anthropic
    config:
      model: claude-opus-4-5-20251101

tools:
  - module: tool-filesystem
  - module: tool-bash
  - module: tool-grep

session:
  max_iterations: 100
  temperature: 0.7
---

# Profile documentation in markdown body</code></pre>
        </div>
        <p>---</p>
        <h3>Build &amp; Distribution</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">PyInstaller Bundling</h4>
        <p>The Python sidecar is bundled as a native binary:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># scripts/bundle-sidecar.cjs
pyinstaller sidecar.spec --distpath src-tauri/binaries/</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Sidecar Naming Convention</h4>
        <p>Tauri requires platform-specific naming:</p>
        <li>macOS ARM: <code>amplifier-sidecar-aarch64-apple-darwin</code></li>
        <li>macOS Intel: <code>amplifier-sidecar-x86_64-apple-darwin</code></li>
        <li>Windows: <code>amplifier-sidecar-x86_64-pc-windows-msvc.exe</code></li>
        <li>Linux: <code>amplifier-sidecar-x86_64-unknown-linux-gnu</code></li>
        <p>---</p>
        <h3>Testing</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Frontend Tests (Vitest)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">npm run test:frontend
# Covers: store actions, WebSocket handling, component rendering</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Backend Tests (pytest)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">cd sidecar &amp;&amp; uv run pytest tests/ -v
# Covers: API endpoints, session management, tool execution</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Testing</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash">npm run dev:all  # Start full stack
# Manual testing: send prompts, verify streaming, check tool calls</code></pre>
        </div>
        <p>---</p>
        <h3>Decisions &amp; Trade-offs</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Streaming (Resolved 2025-12-10)</h4>
        <p><strong>Decision:</strong> Keep the non-streaming fallback approach for cached providers.</p>
        <p><strong>Rationale:</strong></p>
        <li>Cached providers use <code>messages.create()</code> API (non-streaming) vs local's <code>messages.stream()</code></li>
        <li>Current workarounds emit synthetic delta messages after response completes</li>
        <li>Content appears BEFORE "done" message, maintaining responsive UX</li>
        <li>Thinking signatures and tool calls work correctly</li>
        <li>No upstream changes required to amplifier-core</li>
        <p><strong>Trade-off:</strong> Text appears all at once (not character-by-character) in Amplifier mode. This is acceptable because:</p>
        <li>Response still appears before completion message</li>
        <li>Consistent architecture across all cached providers</li>
        <li>Future improvement possible via upstream contribution</li>
        <p>---</p>
        <h3>Comparison: Desktop vs CLI</h3>
        <p>Key differences between <code>amplifier-desktop</code> and <code>amplifier-app-cli</code>:</p>
        <table class="ref-table">
          <thead>
            <tr><th>Aspect</th><th>Desktop</th><th>CLI</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Architecture</strong></td><td>Three-tier (React + Tauri + Python)</td><td>Single Python process</td></tr>
            <tr><td><strong>Session</strong></td><td>Custom LocalOrchestrator</td><td>Direct AmplifierSession</td></tr>
            <tr><td><strong>Module Loading</strong></td><td>LocalLoader (local/cached modes)</td><td>Module resolver (git+, collections)</td></tr>
            <tr><td><strong>Providers</strong></td><td>Bundled + module-cache</td><td>Entry points from packages</td></tr>
            <tr><td><strong>Config</strong></td><td>2-scope JSON</td><td>3-scope YAML with profiles</td></tr>
            <tr><td><strong>Agent Delegation</strong></td><td>Not implemented</td><td>Full sub-session support</td></tr>
            <tr><td><strong>Memory</strong></td><td>SQLite with auto-extraction</td><td>Not built-in</td></tr>
            <tr><td><strong>MCP</strong></td><td>Full client</td><td>Not built-in</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Desktop-Exclusive Features</h4>
        <li>React GUI with real-time streaming</li>
        <li>MCP tool integration</li>
        <li>Memory system with auto-extraction</li>
        <li>Voice input/output</li>
        <li>Artifacts panel</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">CLI-Exclusive Features</h4>
        <li>Profile/collection system</li>
        <li>Agent delegation (sub-sessions)</li>
        <li>Plan mode (read-only)</li>
        <li>@mentions for context loading</li>
        <li>Module-based extensibility</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Convergence Opportunities</h4>
        <li>Add profile system to Desktop</li>
        <li>Add agent delegation to Desktop</li>
        <li>Add MCP to CLI</li>
        <li>Add memory system to CLI</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Session persistence</strong>: Should sessions survive app restart? Currently they're recreated.</li>
        <li><strong>Multi-window support</strong>: How to handle multiple chat windows with separate sessions?</li>
        <li><strong>Offline mode</strong>: Full offline support requires local embeddings for memory search.</li>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-teams-bot" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Teams Bot</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P2 (Enhancement)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-teams-bot</code></p>
        </div>
        <h3>Overview</h3>
        <p>Microsoft Teams bot for enterprise team collaboration with Amplifier. Query codebases in team channels, get AI assistance in meetings, share code explanations, and integrate with enterprise workflows (Azure DevOps, SharePoint).</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Switch to terminal for AI help</td><td>Ask in Teams where you work</td></tr>
            <tr><td>Share screenshots of code</td><td>Interactive code explanations</td></tr>
            <tr><td>Manual incident triage</td><td>AI-assisted investigation</td></tr>
            <tr><td>Siloed knowledge</td><td>Team-shared AI insights</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Channel Queries</h4>
        <p>Ask Amplifier questions in team channels.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  #engineering-backend                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ Alice Chen                                          10:30 AM    â”‚
â”‚  @Amplifier How does the payment retry logic work?                  â”‚
â”‚                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– Amplifier                                           10:30 AM    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ **Payment Retry Logic**                                         â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ The payment system uses exponential backoff for retries:        â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ 1. **Initial attempt** â†’ If fails, wait 1s                      â”‚â”‚
â”‚  â”‚ 2. **Retry 1** â†’ If fails, wait 2s                              â”‚â”‚
â”‚  â”‚ 3. **Retry 2** â†’ If fails, wait 4s                              â”‚â”‚
â”‚  â”‚ 4. **Final retry** â†’ If fails, raise alert                      â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ ðŸ“„ Source: `src/payments/retry.ts:45`                           â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ [View Code] [Ask Follow-up] [Share to Thread]                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ Bob Smith                                           10:32 AM    â”‚
â”‚  @Amplifier What happens if all retries fail?                       â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– Amplifier                                           10:32 AM    â”‚
â”‚  When all retries are exhausted:                                    â”‚
â”‚  1. Transaction marked as `FAILED`                                  â”‚
â”‚  2. Alert sent to #payments-alerts                                  â”‚
â”‚  3. Customer notified via email                                     â”‚
â”‚  ...                                                                â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Direct Message Assistant</h4>
        <p>Private AI assistance via DM.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chat with Amplifier                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ You                                                 2:15 PM     â”‚
â”‚  I&#039;m getting a weird error in the auth module. Can you help?        â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– Amplifier                                           2:15 PM     â”‚
â”‚  I&#039;d be happy to help! Can you share more details:                  â”‚
â”‚                                                                      â”‚
â”‚  1. What error message are you seeing?                              â”‚
â”‚  2. Which file/function is causing it?                              â”‚
â”‚  3. Any recent changes to the auth module?                          â”‚
â”‚                                                                      â”‚
â”‚  Or you can paste the error/stacktrace directly.                    â”‚
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ You                                                 2:16 PM     â”‚
â”‚  ```                                                                â”‚
â”‚  Error: Token expired at validateToken (auth/middleware.ts:45)      â”‚
â”‚  ```                                                                â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– Amplifier                                           2:16 PM     â”‚
â”‚  I found the issue. Looking at `auth/middleware.ts:45`:             â”‚
â”‚                                                                      â”‚
â”‚  The token expiration check uses system time which can drift.       â”‚
â”‚  There&#039;s a known issue (#892) about this.                           â”‚
â”‚                                                                      â”‚
â”‚  **Quick fix:**                                                     â”‚
â”‚  Add clock skew tolerance in `config/auth.ts`:                      â”‚
â”‚  ```ts                                                              â”‚
â”‚  clockTolerance: 30 // seconds                                      â”‚
â”‚  ```                                                                â”‚
â”‚                                                                      â”‚
â”‚  [View Issue #892] [Apply Fix] [Explain More]                       â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Incident Response</h4>
        <p>AI-assisted incident investigation in dedicated channels.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  #incident-2025-01-15-payment-outage                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ðŸš¨ PagerDuty                                           3:00 PM     â”‚
â”‚  ALERT: Payment processing failure rate &gt; 50%                       â”‚
â”‚  Severity: P1 | Service: payment-api | Region: us-east-1            â”‚
â”‚                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ On-Call Engineer                                    3:01 PM     â”‚
â”‚  @Amplifier /incident analyze                                       â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– Amplifier                                           3:01 PM     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ðŸ” **Incident Analysis**                                        â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ **Timeline:**                                                   â”‚â”‚
â”‚  â”‚ â€¢ 2:55 PM - Error rate started climbing                         â”‚â”‚
â”‚  â”‚ â€¢ 2:58 PM - Stripe API latency spike detected                   â”‚â”‚
â”‚  â”‚ â€¢ 3:00 PM - Alert triggered                                     â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ **Probable Cause:**                                             â”‚â”‚
â”‚  â”‚ Stripe API returning 503 errors. Retry logic exhausting         â”‚â”‚
â”‚  â”‚ but circuit breaker not triggering.                             â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ **Recent Changes:**                                             â”‚â”‚
â”‚  â”‚ â€¢ PR #234 merged 2 hours ago (payment retry logic)              â”‚â”‚
â”‚  â”‚ â€¢ No config changes in last 24h                                 â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ **Recommended Actions:**                                        â”‚â”‚
â”‚  â”‚ 1. Enable circuit breaker: `config/payments.ts:12`              â”‚â”‚
â”‚  â”‚ 2. Check Stripe status page                                     â”‚â”‚
â”‚  â”‚ 3. Consider rollback of PR #234                                 â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ [View Metrics] [Recent PRs] [Rollback PR #234]                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ On-Call Engineer                                    3:02 PM     â”‚
â”‚  @Amplifier Show me the circuit breaker config                      â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Meeting Assistant</h4>
        <p>AI assistance during Teams meetings.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Meeting: Architecture Review - Payment System                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  [Video Call in Progress]                                           â”‚
â”‚                                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Meeting Chat                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ Alice                                               2:30 PM     â”‚
â”‚  @Amplifier Can you show the current payment flow diagram?          â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– Amplifier                                           2:30 PM     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ **Payment Flow** (generated from codebase)                      â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚â”‚
â”‚  â”‚  â”‚ Request â”‚â”€â”€â”€â–¶â”‚ Validate â”‚â”€â”€â”€â–¶â”‚ Process â”‚                    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â”‚â”‚
â”‚  â”‚                                       â”‚                         â”‚â”‚
â”‚  â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚â”‚
â”‚  â”‚                      â–¼                â–¼                â–¼        â”‚â”‚
â”‚  â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚â”‚
â”‚  â”‚                 â”‚ Stripe â”‚      â”‚ PayPal â”‚      â”‚ Manual â”‚     â”‚â”‚
â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ [Share to Meeting] [Download] [Update]                          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ Bob                                                 2:32 PM     â”‚
â”‚  @Amplifier What&#039;s the error rate for each payment method?          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Azure DevOps Integration</h4>
        <p>Connect with Azure DevOps work items and pipelines.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  #project-alpha                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ðŸ‘¤ PM                                                  11:00 AM    â”‚
â”‚  @Amplifier What&#039;s the status of the payment feature (Epic #45)?    â”‚
â”‚                                                                      â”‚
â”‚  ðŸ¤– Amplifier                                           11:00 AM    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ **Epic #45: Payment System Improvements**                       â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ ðŸ“Š Progress: 67% complete (8/12 items done)                     â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ **Completed:**                                                  â”‚â”‚
â”‚  â”‚ âœ… #101 - Retry logic implementation                            â”‚â”‚
â”‚  â”‚ âœ… #102 - Error handling improvements                           â”‚â”‚
â”‚  â”‚ âœ… #103 - Stripe v3 upgrade                                     â”‚â”‚
â”‚  â”‚ ... 5 more                                                      â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ **In Progress:**                                                â”‚â”‚
â”‚  â”‚ ðŸ”„ #108 - Circuit breaker (@alice)                              â”‚â”‚
â”‚  â”‚ ðŸ”„ #109 - Metrics dashboard (@bob)                              â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ **Blocked:**                                                    â”‚â”‚
â”‚  â”‚ âš ï¸ #110 - PayPal integration (waiting on API access)            â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ **Code Status:**                                                â”‚â”‚
â”‚  â”‚ â€¢ 3 PRs open, 2 ready for review                                â”‚â”‚
â”‚  â”‚ â€¢ Pipeline: All passing âœ…                                       â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚ [View in Azure DevOps] [PRs] [Pipeline]                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Teams Bot Service                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Bot Framework SDK                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ Channel  â”‚ â”‚ DM       â”‚ â”‚ Meeting  â”‚ â”‚ Adaptive â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚ Handler  â”‚ â”‚ Cards    â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚ Amplifier Client  â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                              â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â–¼                    â–¼                    â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Amplifier  â”‚      â”‚ Azure      â”‚      â”‚ Graph      â”‚            â”‚
â”‚  â”‚ API Server â”‚      â”‚ DevOps API â”‚      â”‚ API        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Bot Commands</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Command</th><th>Description</th><th>Example</th></tr>
          </thead>
          <tbody>
            <tr><td><code>@Amplifier [question]</code></td><td>Ask about codebase</td><td><code>@Amplifier how does auth work?</code></td></tr>
            <tr><td><code>@Amplifier /explain [code]</code></td><td>Explain code snippet</td><td><code>@Amplifier /explain \</code>\<code>\</code>code\<code>\</code>\``</td></tr>
            <tr><td><code>@Amplifier /incident analyze</code></td><td>Analyze incident</td><td>In incident channel</td></tr>
            <tr><td><code>@Amplifier /pr [number]</code></td><td>PR summary</td><td><code>@Amplifier /pr 234</code></td></tr>
            <tr><td><code>@Amplifier /work-item [id]</code></td><td>Work item status</td><td><code>@Amplifier /work-item 45</code></td></tr>
            <tr><td><code>@Amplifier /pipeline [name]</code></td><td>Pipeline status</td><td><code>@Amplifier /pipeline main</code></td></tr>
            <tr><td><code>@Amplifier /help</code></td><td>Show commands</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Bot Service (Node.js)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/bot.ts
import {
  ActivityHandler,
  TurnContext,
  TeamsActivityHandler,
  CardFactory
} from &#039;botbuilder&#039;;
import { AmplifierClient } from &#039;./amplifier-client&#039;;
import { AdaptiveCardBuilder } from &#039;./cards&#039;;
import { CommandParser } from &#039;./commands&#039;;

export class AmplifierBot extends TeamsActivityHandler {
  private amplifier: AmplifierClient;
  private cardBuilder: AdaptiveCardBuilder;
  private commandParser: CommandParser;

  constructor() {
    super();

    this.amplifier = new AmplifierClient({
      apiUrl: process.env.AMPLIFIER_API_URL,
      apiKey: process.env.AMPLIFIER_API_KEY
    });

    this.cardBuilder = new AdaptiveCardBuilder();
    this.commandParser = new CommandParser();

    // Handle messages
    this.onMessage(async (context, next) =&gt; {
      await this.handleMessage(context);
      await next();
    });

    // Handle reactions
    this.onReactionsAdded(async (context, next) =&gt; {
      await this.handleReaction(context);
      await next();
    });
  }

  async handleMessage(context: TurnContext) {
    const text = context.activity.text?.trim() || &#039;&#039;;

    // Remove bot mention
    const cleanText = this.removeMention(text);

    // Parse command
    const { command, args } = this.commandParser.parse(cleanText);

    switch (command) {
      case &#039;explain&#039;:
        await this.handleExplain(context, args);
        break;

      case &#039;incident&#039;:
        await this.handleIncident(context, args);
        break;

      case &#039;pr&#039;:
        await this.handlePR(context, args);
        break;

      case &#039;work-item&#039;:
        await this.handleWorkItem(context, args);
        break;

      case &#039;help&#039;:
        await this.handleHelp(context);
        break;

      default:
        // General question
        await this.handleQuestion(context, cleanText);
    }
  }

  async handleQuestion(context: TurnContext, question: string) {
    // Send typing indicator
    await context.sendActivity({ type: &#039;typing&#039; });

    // Get team/channel context
    const teamContext = this.getTeamContext(context);

    // Execute query
    const result = await this.amplifier.execute({
      prompt: question,
      context: {
        type: &#039;teams_query&#039;,
        team: teamContext.teamName,
        channel: teamContext.channelName,
        user: context.activity.from.name
      }
    });

    // Build response card
    const card = this.cardBuilder.queryResponse({
      question,
      response: result.response,
      sources: result.sources
    });

    await context.sendActivity({
      attachments: [CardFactory.adaptiveCard(card)]
    });
  }

  async handleIncident(context: TurnContext, args: string[]) {
    const subCommand = args[0];

    if (subCommand === &#039;analyze&#039;) {
      // Get channel messages for context
      const messages = await this.getChannelMessages(context);

      const result = await this.amplifier.execute({
        prompt: `Analyze this incident based on the channel discussion:\n\n${messages}`,
        profile: &#039;enterprise-dev:incident&#039;,
        context: {
          type: &#039;incident_analysis&#039;,
          channel: context.activity.channelId
        }
      });

      const card = this.cardBuilder.incidentAnalysis(result.response);

      await context.sendActivity({
        attachments: [CardFactory.adaptiveCard(card)]
      });
    }
  }

  async handlePR(context: TurnContext, args: string[]) {
    const prNumber = args[0];

    const result = await this.amplifier.execute({
      prompt: `Summarize PR #${prNumber}`,
      context: {
        type: &#039;pr_summary&#039;,
        pr_number: prNumber
      }
    });

    const card = this.cardBuilder.prSummary({
      number: prNumber,
      summary: result.response
    });

    await context.sendActivity({
      attachments: [CardFactory.adaptiveCard(card)]
    });
  }

  async handleWorkItem(context: TurnContext, args: string[]) {
    const workItemId = args[0];

    // Get work item from Azure DevOps
    const workItem = await this.getAzureDevOpsWorkItem(workItemId);

    // Get AI analysis
    const result = await this.amplifier.execute({
      prompt: `Analyze the status of this work item:\n\n${JSON.stringify(workItem)}`,
      context: {
        type: &#039;work_item_analysis&#039;
      }
    });

    const card = this.cardBuilder.workItemStatus({
      workItem,
      analysis: result.response
    });

    await context.sendActivity({
      attachments: [CardFactory.adaptiveCard(card)]
    });
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Adaptive Card Builder</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// src/cards.ts
export class AdaptiveCardBuilder {
  queryResponse(data: QueryResponseData) {
    return {
      type: &#039;AdaptiveCard&#039;,
      $schema: &#039;http://adaptivecards.io/schemas/adaptive-card.json&#039;,
      version: &#039;1.4&#039;,
      body: [
        {
          type: &#039;TextBlock&#039;,
          text: data.response,
          wrap: true
        },
        {
          type: &#039;FactSet&#039;,
          facts: data.sources?.map(s =&gt; ({
            title: &#039;ðŸ“„ Source&#039;,
            value: s.path
          })) || []
        }
      ],
      actions: [
        {
          type: &#039;Action.Submit&#039;,
          title: &#039;Ask Follow-up&#039;,
          data: { action: &#039;followup&#039;, context: data }
        },
        {
          type: &#039;Action.OpenUrl&#039;,
          title: &#039;View Code&#039;,
          url: data.sources?.[0]?.url
        }
      ]
    };
  }

  incidentAnalysis(analysis: string) {
    // Parse analysis into structured sections
    const sections = this.parseAnalysis(analysis);

    return {
      type: &#039;AdaptiveCard&#039;,
      $schema: &#039;http://adaptivecards.io/schemas/adaptive-card.json&#039;,
      version: &#039;1.4&#039;,
      body: [
        {
          type: &#039;TextBlock&#039;,
          text: &#039;ðŸ” **Incident Analysis**&#039;,
          size: &#039;large&#039;,
          weight: &#039;bolder&#039;
        },
        {
          type: &#039;Container&#039;,
          items: [
            {
              type: &#039;TextBlock&#039;,
              text: &#039;**Timeline**&#039;,
              weight: &#039;bolder&#039;
            },
            {
              type: &#039;TextBlock&#039;,
              text: sections.timeline,
              wrap: true
            }
          ]
        },
        {
          type: &#039;Container&#039;,
          items: [
            {
              type: &#039;TextBlock&#039;,
              text: &#039;**Probable Cause**&#039;,
              weight: &#039;bolder&#039;
            },
            {
              type: &#039;TextBlock&#039;,
              text: sections.cause,
              wrap: true
            }
          ]
        },
        {
          type: &#039;Container&#039;,
          items: [
            {
              type: &#039;TextBlock&#039;,
              text: &#039;**Recommended Actions**&#039;,
              weight: &#039;bolder&#039;
            },
            {
              type: &#039;TextBlock&#039;,
              text: sections.actions,
              wrap: true
            }
          ]
        }
      ],
      actions: [
        {
          type: &#039;Action.OpenUrl&#039;,
          title: &#039;View Metrics&#039;,
          url: sections.metricsUrl
        },
        {
          type: &#039;Action.Submit&#039;,
          title: &#039;Rollback&#039;,
          data: { action: &#039;rollback&#039;, pr: sections.recentPR }
        }
      ]
    };
  }

  prSummary(data: PRSummaryData) {
    return {
      type: &#039;AdaptiveCard&#039;,
      $schema: &#039;http://adaptivecards.io/schemas/adaptive-card.json&#039;,
      version: &#039;1.4&#039;,
      body: [
        {
          type: &#039;TextBlock&#039;,
          text: `**PR #${data.number}**`,
          size: &#039;large&#039;
        },
        {
          type: &#039;TextBlock&#039;,
          text: data.summary,
          wrap: true
        }
      ],
      actions: [
        {
          type: &#039;Action.OpenUrl&#039;,
          title: &#039;View PR&#039;,
          url: `https://github.com/org/repo/pull/${data.number}`
        },
        {
          type: &#039;Action.Submit&#039;,
          title: &#039;Approve&#039;,
          data: { action: &#039;approve_pr&#039;, pr: data.number }
        }
      ]
    };
  }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Deployment</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Azure Bot Service</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># azure-pipelines.yml
trigger:
  - main

pool:
  vmImage: &#039;ubuntu-latest&#039;

stages:
  - stage: Build
    jobs:
      - job: BuildBot
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: &#039;18.x&#039;

          - script: |
              npm ci
              npm run build
            displayName: &#039;Build&#039;

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: &#039;$(System.DefaultWorkingDirectory)&#039;
              includeRootFolder: false
              archiveFile: &#039;$(Build.ArtifactStagingDirectory)/bot.zip&#039;

          - publish: $(Build.ArtifactStagingDirectory)/bot.zip
            artifact: bot

  - stage: Deploy
    jobs:
      - deployment: DeployBot
        environment: &#039;production&#039;
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: &#039;Azure-Sub&#039;
                    appName: &#039;amplifier-teams-bot&#039;
                    package: &#039;$(Pipeline.Workspace)/bot/bot.zip&#039;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">App Manifest</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">// manifest.json
{
  &quot;$schema&quot;: &quot;https://developer.microsoft.com/json-schemas/teams/v1.14/MicrosoftTeams.schema.json&quot;,
  &quot;manifestVersion&quot;: &quot;1.14&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;id&quot;: &quot;{{BOT_ID}}&quot;,
  &quot;packageName&quot;: &quot;com.amplifier.teams&quot;,
  &quot;developer&quot;: {
    &quot;name&quot;: &quot;Microsoft&quot;,
    &quot;websiteUrl&quot;: &quot;https://amplifier.dev&quot;,
    &quot;privacyUrl&quot;: &quot;https://amplifier.dev/privacy&quot;,
    &quot;termsOfUseUrl&quot;: &quot;https://amplifier.dev/terms&quot;
  },
  &quot;name&quot;: {
    &quot;short&quot;: &quot;Amplifier&quot;,
    &quot;full&quot;: &quot;Amplifier AI Assistant&quot;
  },
  &quot;description&quot;: {
    &quot;short&quot;: &quot;AI-powered code assistant for Teams&quot;,
    &quot;full&quot;: &quot;Query your codebase, get AI assistance, and collaborate with your team using Amplifier.&quot;
  },
  &quot;icons&quot;: {
    &quot;outline&quot;: &quot;outline.png&quot;,
    &quot;color&quot;: &quot;color.png&quot;
  },
  &quot;accentColor&quot;: &quot;#6366f1&quot;,
  &quot;bots&quot;: [
    {
      &quot;botId&quot;: &quot;{{BOT_ID}}&quot;,
      &quot;scopes&quot;: [&quot;personal&quot;, &quot;team&quot;, &quot;groupchat&quot;],
      &quot;supportsFiles&quot;: false,
      &quot;isNotificationOnly&quot;: false,
      &quot;commandLists&quot;: [
        {
          &quot;scopes&quot;: [&quot;personal&quot;, &quot;team&quot;, &quot;groupchat&quot;],
          &quot;commands&quot;: [
            {
              &quot;title&quot;: &quot;help&quot;,
              &quot;description&quot;: &quot;Show available commands&quot;
            },
            {
              &quot;title&quot;: &quot;explain&quot;,
              &quot;description&quot;: &quot;Explain code snippet&quot;
            },
            {
              &quot;title&quot;: &quot;pr&quot;,
              &quot;description&quot;: &quot;Get PR summary&quot;
            },
            {
              &quot;title&quot;: &quot;incident&quot;,
              &quot;description&quot;: &quot;Analyze incident&quot;
            }
          ]
        }
      ]
    }
  ],
  &quot;permissions&quot;: [&quot;identity&quot;, &quot;messageTeamMembers&quot;],
  &quot;validDomains&quot;: [&quot;amplifier.dev&quot;, &quot;*.amplifier.dev&quot;]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Bot configuration
bot:
  app_id: ${AZURE_BOT_APP_ID}
  app_password: ${AZURE_BOT_APP_PASSWORD}

amplifier:
  api_url: https://api.amplifier.example.com
  api_key: ${AMPLIFIER_API_KEY}
  default_profile: enterprise-dev:teams

azure_devops:
  organization: myorg
  project: myproject
  pat: ${AZURE_DEVOPS_PAT}

features:
  channel_queries: true
  dm_assistant: true
  meeting_assistant: true
  incident_response: true
  azure_devops: true

permissions:
  # Who can use the bot
  allowed_teams: [&quot;*&quot;]  # or specific team IDs
  admin_users: [&quot;user1@company.com&quot;]</code></pre>
        </div>
        <p>---</p>
        <h3>Events</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>Description</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>teams:query_received</code></td><td>Query in channel/DM</td><td>team, channel, user</td></tr>
            <tr><td><code>teams:response_sent</code></td><td>Response delivered</td><td>type, tokens</td></tr>
            <tr><td><code>teams:command_executed</code></td><td>Slash command used</td><td>command, args</td></tr>
            <tr><td><code>teams:incident_analyzed</code></td><td>Incident analysis done</td><td>channel, findings</td></tr>
            <tr><td><code>teams:pr_action</code></td><td>PR action taken</td><td>action, pr_number</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Security</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">security:
  # Azure AD authentication
  auth:
    tenant_id: ${AZURE_AD_TENANT_ID}
    validate_issuer: true

  # Bot-specific
  bot:
    validate_activity: true
    allowed_callers: [&quot;*.botframework.com&quot;]

  # Data handling
  data:
    log_queries: true
    redact_sensitive: true
    retention_days: 30</code></pre>
        </div>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Multi-tenant</strong>: Support for multiple Azure AD tenants?</li>
        <li><strong>Meeting transcripts</strong>: Integrate with Teams meeting transcripts?</li>
        <li><strong>Proactive messages</strong>: Notify teams about CI/CD events?</li>
        <li><strong>Message threading</strong>: Reply in threads vs new messages?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-vscode" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Vscode</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-integration-vscode</code></p>
        </div>
        <h3>Overview</h3>
        <p>VS Code extension providing native Amplifier integration within the IDE. Enables context-aware AI assistance, inline code actions, project-aware suggestions, and seamless access to all Amplifier capabilities.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Context switching to terminal</td><td>Inline AI assistance</td></tr>
            <tr><td>Manual context sharing</td><td>Auto-detect project context</td></tr>
            <tr><td>Generic AI suggestions</td><td>Codebase-aware responses</td></tr>
            <tr><td>Separate tool windows</td><td>Integrated experience</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Inline Chat</h4>
        <p>AI chat panel integrated in VS Code sidebar.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Chat with full project context
User: &quot;How does the payment processing work?&quot;

// Amplifier searches codebase, finds relevant files
Assistant: &quot;Based on the codebase analysis:

The payment processing flow works as follows:

1. **Entry Point** (`src/api/payments.ts:45`)
   - Receives payment request via POST /api/payments

2. **Validation** (`src/services/PaymentValidator.ts`)
   - Validates card details
   - Checks fraud signals

3. **Processing** (`src/services/PaymentProcessor.ts`)
   - Integrates with Stripe API
   - Implements retry logic with exponential backoff

4. **Completion** (`src/services/PaymentNotifier.ts`)
   - Sends confirmation email
   - Updates order status

Would you like me to explain any specific part in detail?&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Inline Code Actions</h4>
        <p>Context menu and lightbulb actions for selected code.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Right-click on code or use lightbulb
Code Actions:
  ðŸ”§ Amplifier: Explain this code
  ðŸ”§ Amplifier: Suggest improvements
  ðŸ”§ Amplifier: Find bugs
  ðŸ”§ Amplifier: Generate tests
  ðŸ”§ Amplifier: Add documentation
  ðŸ”§ Amplifier: Refactor</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Smart Completions</h4>
        <p>AI-powered code completions with codebase awareness.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// While typing in payment.ts
async function processRefund(orderId: string) {
  // Amplifier suggests based on existing patterns
  const order = await this.orderService.getOrder(orderId);
  const payment = await this.paymentService.getPaymentByOrder(orderId);

  // Suggestion shows: &quot;Based on pattern in processPayment...&quot;
  if (!payment.refundable) {
    throw new PaymentError(&#039;Payment is not refundable&#039;, &#039;REFUND_NOT_ALLOWED&#039;);
  }
  //...
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Project Commands</h4>
        <p>Command palette commands for project-wide operations.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Cmd/Ctrl + Shift + P:

&gt; Amplifier: Explain Repository Architecture
&gt; Amplifier: Find Dead Code
&gt; Amplifier: Analyze Dependencies
&gt; Amplifier: Generate Documentation
&gt; Amplifier: Review Uncommitted Changes
&gt; Amplifier: Find Similar Code
&gt; Amplifier: Create Feature Plan</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Problems Integration</h4>
        <p>AI-detected issues in VS Code Problems panel.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">PROBLEMS (3)
  src/payments/gateway.ts
    âš ï¸ [Amplifier] Potential SQL injection at line 45
    âš ï¸ [Amplifier] Missing error handling for network timeout
  src/auth/login.ts
    âš ï¸ [Amplifier] Weak password validation pattern</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VS Code Extension                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Chat View    â”‚  â”‚ Code Actions â”‚  â”‚ Completions  â”‚              â”‚
â”‚  â”‚ Provider     â”‚  â”‚ Provider     â”‚  â”‚ Provider     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                 â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                           â–¼                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚ Amplifier Clientâ”‚                                â”‚
â”‚                  â”‚   (TypeScript)  â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                           â”‚                                         â”‚
â”‚                           â–¼                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                  â”‚  Amplifier CLI  â”‚â—€â”€â”€ Local or Remote            â”‚
â”‚                  â”‚    Process      â”‚                                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Extension Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">json</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-json">// .vscode/settings.json
{
  &quot;amplifier.enabled&quot;: true,

  // Connection
  &quot;amplifier.connection&quot;: {
    &quot;type&quot;: &quot;local&quot;,              // local | remote | cloud
    &quot;path&quot;: &quot;amplifier&quot;           // CLI path for local
  },

  // Profile
  &quot;amplifier.profile&quot;: &quot;enterprise-dev:development&quot;,
  &quot;amplifier.collection&quot;: &quot;enterprise-dev&quot;,

  // Features
  &quot;amplifier.features&quot;: {
    &quot;inlineChat&quot;: true,
    &quot;codeActions&quot;: true,
    &quot;completions&quot;: true,
    &quot;problemsIntegration&quot;: true,
    &quot;hoverInfo&quot;: true
  },

  // Completions
  &quot;amplifier.completions&quot;: {
    &quot;enabled&quot;: true,
    &quot;triggerCharacters&quot;: [&quot;.&quot;, &quot;(&quot;, &quot; &quot;],
    &quot;maxSuggestions&quot;: 3,
    &quot;codebaseAware&quot;: true
  },

  // Security
  &quot;amplifier.security&quot;: {
    &quot;redactSecrets&quot;: true,
    &quot;excludePatterns&quot;: [
      &quot;*.env&quot;,
      &quot;*.pem&quot;,
      &quot;**/secrets/**&quot;
    ]
  },

  // Keybindings
  &quot;amplifier.keybindings&quot;: {
    &quot;openChat&quot;: &quot;cmd+shift+a&quot;,
    &quot;explainSelection&quot;: &quot;cmd+shift+e&quot;,
    &quot;generateTests&quot;: &quot;cmd+shift+t&quot;
  }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Extension Entry Point</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// extension.ts
import * as vscode from &#039;vscode&#039;;
import { AmplifierClient } from &#039;./client&#039;;
import { ChatViewProvider } from &#039;./providers/chat&#039;;
import { CodeActionProvider } from &#039;./providers/codeActions&#039;;
import { CompletionProvider } from &#039;./providers/completions&#039;;
import { ProblemsProvider } from &#039;./providers/problems&#039;;

export async function activate(context: vscode.ExtensionContext) {
  const config = vscode.workspace.getConfiguration(&#039;amplifier&#039;);

  // Initialize Amplifier client
  const client = new AmplifierClient({
    connection: config.get(&#039;connection&#039;),
    profile: config.get(&#039;profile&#039;)
  });

  await client.connect();

  // Register Chat View
  const chatProvider = new ChatViewProvider(client, context);
  context.subscriptions.push(
    vscode.window.registerWebviewViewProvider(
      &#039;amplifier.chatView&#039;,
      chatProvider
    )
  );

  // Register Code Actions
  const codeActionProvider = new CodeActionProvider(client);
  context.subscriptions.push(
    vscode.languages.registerCodeActionsProvider(
      { scheme: &#039;file&#039; },
      codeActionProvider,
      { providedCodeActionKinds: [vscode.CodeActionKind.QuickFix] }
    )
  );

  // Register Completions
  if (config.get(&#039;features.completions&#039;)) {
    const completionProvider = new CompletionProvider(client);
    context.subscriptions.push(
      vscode.languages.registerCompletionItemProvider(
        { scheme: &#039;file&#039; },
        completionProvider,
        ...config.get(&#039;completions.triggerCharacters&#039;)
      )
    );
  }

  // Register Problems Integration
  if (config.get(&#039;features.problemsIntegration&#039;)) {
    const problemsProvider = new ProblemsProvider(client, context);
    context.subscriptions.push(problemsProvider);
  }

  // Register Commands
  registerCommands(context, client);
}

function registerCommands(
  context: vscode.ExtensionContext,
  client: AmplifierClient
) {
  // Explain selection
  context.subscriptions.push(
    vscode.commands.registerCommand(&#039;amplifier.explainSelection&#039;, async () =&gt; {
      const editor = vscode.window.activeTextEditor;
      if (!editor) return;

      const selection = editor.selection;
      const text = editor.document.getText(selection);

      const result = await client.execute({
        prompt: `Explain this code:\n\n${text}`,
        context: {
          file: editor.document.fileName,
          language: editor.document.languageId
        }
      });

      // Show in chat panel
      vscode.commands.executeCommand(&#039;amplifier.chatView.focus&#039;);
      chatProvider.addMessage(&#039;assistant&#039;, result.response);
    })
  );

  // More commands...
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Chat View Provider</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// providers/chat.ts
export class ChatViewProvider implements vscode.WebviewViewProvider {
  private view?: vscode.WebviewView;
  private messages: Message[] = [];

  constructor(
    private client: AmplifierClient,
    private context: vscode.ExtensionContext
  ) {}

  resolveWebviewView(webviewView: vscode.WebviewView) {
    this.view = webviewView;

    webviewView.webview.options = {
      enableScripts: true,
      localResourceRoots: [this.context.extensionUri]
    };

    webviewView.webview.html = this.getHtml();

    // Handle messages from webview
    webviewView.webview.onDidReceiveMessage(async (message) =&gt; {
      if (message.type === &#039;userMessage&#039;) {
        await this.handleUserMessage(message.text);
      }
    });
  }

  async handleUserMessage(text: string) {
    // Add user message
    this.addMessage(&#039;user&#039;, text);

    // Get project context
    const context = await this.gatherContext();

    // Execute with Amplifier
    const result = await this.client.execute({
      prompt: text,
      context: context
    });

    // Add assistant response
    this.addMessage(&#039;assistant&#039;, result.response);
  }

  async gatherContext(): Promise&lt;ProjectContext&gt; {
    const editor = vscode.window.activeTextEditor;
    const workspaceFolder = vscode.workspace.workspaceFolders?.[0];

    return {
      // Current file context
      currentFile: editor?.document.fileName,
      currentSelection: editor?.selection
        ? editor.document.getText(editor.selection)
        : undefined,
      currentLanguage: editor?.document.languageId,

      // Project context
      workspaceRoot: workspaceFolder?.uri.fsPath,
      openFiles: vscode.window.visibleTextEditors.map(e =&gt; e.document.fileName),

      // Git context
      gitBranch: await this.getGitBranch(),
      gitStatus: await this.getGitStatus()
    };
  }

  addMessage(role: &#039;user&#039; | &#039;assistant&#039;, content: string) {
    this.messages.push({ role, content, timestamp: new Date() });
    this.updateView();
  }

  private updateView() {
    this.view?.webview.postMessage({
      type: &#039;updateMessages&#039;,
      messages: this.messages
    });
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Code Action Provider</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// providers/codeActions.ts
export class CodeActionProvider implements vscode.CodeActionProvider {
  constructor(private client: AmplifierClient) {}

  async provideCodeActions(
    document: vscode.TextDocument,
    range: vscode.Range
  ): Promise&lt;vscode.CodeAction[]&gt; {
    const actions: vscode.CodeAction[] = [];

    // Only show when there&#039;s a selection
    if (range.isEmpty) return actions;

    const selectedText = document.getText(range);

    // Explain code
    const explainAction = new vscode.CodeAction(
      &#039;ðŸ”§ Amplifier: Explain this code&#039;,
      vscode.CodeActionKind.QuickFix
    );
    explainAction.command = {
      command: &#039;amplifier.explainSelection&#039;,
      title: &#039;Explain Code&#039;
    };
    actions.push(explainAction);

    // Suggest improvements
    const improveAction = new vscode.CodeAction(
      &#039;ðŸ”§ Amplifier: Suggest improvements&#039;,
      vscode.CodeActionKind.QuickFix
    );
    improveAction.command = {
      command: &#039;amplifier.suggestImprovements&#039;,
      title: &#039;Suggest Improvements&#039;
    };
    actions.push(improveAction);

    // Generate tests
    const testAction = new vscode.CodeAction(
      &#039;ðŸ”§ Amplifier: Generate tests&#039;,
      vscode.CodeActionKind.QuickFix
    );
    testAction.command = {
      command: &#039;amplifier.generateTests&#039;,
      title: &#039;Generate Tests&#039;
    };
    actions.push(testAction);

    // Add documentation
    const docAction = new vscode.CodeAction(
      &#039;ðŸ”§ Amplifier: Add documentation&#039;,
      vscode.CodeActionKind.QuickFix
    );
    docAction.command = {
      command: &#039;amplifier.addDocumentation&#039;,
      title: &#039;Add Documentation&#039;
    };
    actions.push(docAction);

    return actions;
  }
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Problems Integration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// providers/problems.ts
export class ProblemsProvider implements vscode.Disposable {
  private diagnosticCollection: vscode.DiagnosticCollection;
  private debounceTimer?: NodeJS.Timeout;

  constructor(
    private client: AmplifierClient,
    context: vscode.ExtensionContext
  ) {
    this.diagnosticCollection = vscode.languages.createDiagnosticCollection(&#039;amplifier&#039;);

    // Analyze on save
    context.subscriptions.push(
      vscode.workspace.onDidSaveTextDocument((doc) =&gt; {
        this.analyzeDocument(doc);
      })
    );

    // Analyze open documents
    vscode.workspace.textDocuments.forEach((doc) =&gt; {
      this.analyzeDocument(doc);
    });
  }

  async analyzeDocument(document: vscode.TextDocument) {
    // Debounce
    if (this.debounceTimer) {
      clearTimeout(this.debounceTimer);
    }

    this.debounceTimer = setTimeout(async () =&gt; {
      const result = await this.client.execute({
        prompt: &#039;Analyze this code for potential issues&#039;,
        context: {
          file: document.fileName,
          content: document.getText(),
          language: document.languageId
        },
        scenario: &#039;quick-analysis&#039;
      });

      const diagnostics = this.parseIssues(result, document);
      this.diagnosticCollection.set(document.uri, diagnostics);
    }, 1000);
  }

  private parseIssues(
    result: ExecutionResult,
    document: vscode.TextDocument
  ): vscode.Diagnostic[] {
    const diagnostics: vscode.Diagnostic[] = [];

    for (const issue of result.issues || []) {
      const range = new vscode.Range(
        issue.line - 1, 0,
        issue.line - 1, document.lineAt(issue.line - 1).text.length
      );

      const severity = {
        critical: vscode.DiagnosticSeverity.Error,
        high: vscode.DiagnosticSeverity.Error,
        medium: vscode.DiagnosticSeverity.Warning,
        low: vscode.DiagnosticSeverity.Information
      }[issue.severity] || vscode.DiagnosticSeverity.Information;

      const diagnostic = new vscode.Diagnostic(
        range,
        `[Amplifier] ${issue.message}`,
        severity
      );
      diagnostic.source = &#039;amplifier&#039;;
      diagnostic.code = issue.code;

      diagnostics.push(diagnostic);
    }

    return diagnostics;
  }

  dispose() {
    this.diagnosticCollection.dispose();
  }
}</code></pre>
        </div>
        <p>---</p>
        <h3>User Interface</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Chat Panel</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">html</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-html">&lt;!-- Chat webview HTML --&gt;
&lt;div class=&quot;amplifier-chat&quot;&gt;
  &lt;div class=&quot;chat-messages&quot; id=&quot;messages&quot;&gt;
    &lt;!-- Messages rendered here --&gt;
  &lt;/div&gt;

  &lt;div class=&quot;chat-input&quot;&gt;
    &lt;textarea
      id=&quot;input&quot;
      placeholder=&quot;Ask about your code...&quot;
      rows=&quot;3&quot;
    &gt;&lt;/textarea&gt;
    &lt;button onclick=&quot;sendMessage()&quot;&gt;Send&lt;/button&gt;
  &lt;/div&gt;

  &lt;div class=&quot;chat-actions&quot;&gt;
    &lt;button onclick=&quot;clearChat()&quot;&gt;Clear&lt;/button&gt;
    &lt;button onclick=&quot;exportChat()&quot;&gt;Export&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Status Bar</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">typescript</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-typescript">// Status bar integration
const statusBarItem = vscode.window.createStatusBarItem(
  vscode.StatusBarAlignment.Right,
  100
);

statusBarItem.text = &quot;$(hubot) Amplifier&quot;;
statusBarItem.tooltip = &quot;Amplifier AI Assistant - Click to open chat&quot;;
statusBarItem.command = &quot;amplifier.chatView.focus&quot;;
statusBarItem.show();

// Update status based on connection
client.on(&#039;connected&#039;, () =&gt; {
  statusBarItem.text = &quot;$(hubot) Amplifier&quot;;
  statusBarItem.backgroundColor = undefined;
});

client.on(&#039;disconnected&#039;, () =&gt; {
  statusBarItem.text = &quot;$(hubot) Amplifier (Offline)&quot;;
  statusBarItem.backgroundColor = new vscode.ThemeColor(
    &#039;statusBarItem.warningBackground&#039;
  );
});</code></pre>
        </div>
        <p>---</p>
        <h3>Commands Reference</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Command</th><th>Keybinding</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>amplifier.openChat</code></td><td><code>Cmd+Shift+A</code></td><td>Open chat panel</td></tr>
            <tr><td><code>amplifier.explainSelection</code></td><td><code>Cmd+Shift+E</code></td><td>Explain selected code</td></tr>
            <tr><td><code>amplifier.generateTests</code></td><td><code>Cmd+Shift+T</code></td><td>Generate tests</td></tr>
            <tr><td><code>amplifier.suggestImprovements</code></td><td>-</td><td>Suggest improvements</td></tr>
            <tr><td><code>amplifier.addDocumentation</code></td><td>-</td><td>Add documentation</td></tr>
            <tr><td><code>amplifier.findSimilarCode</code></td><td>-</td><td>Find similar code</td></tr>
            <tr><td><code>amplifier.reviewChanges</code></td><td>-</td><td>Review uncommitted changes</td></tr>
            <tr><td><code>amplifier.explainArchitecture</code></td><td>-</td><td>Explain repository architecture</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-integration-web-dashboard" data-category="integrations">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Integration Web Dashboard</span>
            <span class="spec-category">integrations</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-web-dashboard</code></p>
        </div>
        <h3>Overview</h3>
        <p>Web-based dashboard for managing Amplifier: collections, profiles, sessions, analytics, and interactive chat. Provides visual management without requiring CLI knowledge. Built on top of the API Server.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>CLI-only management</td><td>Visual point-and-click interface</td></tr>
            <tr><td>Manual profile editing</td><td>Profile builder with live preview</td></tr>
            <tr><td>Log file inspection</td><td>Real-time analytics dashboard</td></tr>
            <tr><td>Single-session terminal</td><td>Multi-session workspace</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Features</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">1. Interactive Chat Workspace</h4>
        <p>Multi-panel chat interface with session management.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Amplifier Dashboard                          [user@email.com] [âš™ï¸] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                                                       â”‚
â”‚  Sessions   â”‚  Session: Code Review #42                    [Profile]â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚             â”‚                                                       â”‚
â”‚  â— Active   â”‚  User: Explain the payment processing flow           â”‚
â”‚    #42      â”‚                                                       â”‚
â”‚    #38      â”‚  Assistant: Based on my analysis of the codebase:    â”‚
â”‚             â”‚                                                       â”‚
â”‚  â—‹ Recent   â”‚  1. **Entry Point** (src/api/payments.ts:45)         â”‚
â”‚    #35      â”‚     - Receives POST /api/payments                    â”‚
â”‚    #31      â”‚                                                       â”‚
â”‚             â”‚  2. **Validation** (src/services/PaymentValidator.ts)â”‚
â”‚  + New      â”‚     - Card validation                                â”‚
â”‚             â”‚     - Fraud detection                                â”‚
â”‚             â”‚                                                       â”‚
â”‚             â”‚  [Referenced Files]                                   â”‚
â”‚             â”‚  â€¢ payments.ts â€¢ PaymentValidator.ts                  â”‚
â”‚             â”‚                                                       â”‚
â”‚             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚             â”‚  [Type your message...]                    [Send] [ðŸ“Ž]â”‚
â”‚             â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">2. Collection Manager</h4>
        <p>Visual interface for browsing, installing, and managing collections.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Collections                                    [+ Install] [ðŸ”„]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Installed (4)                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸ“¦ enterprise-dev                                    v1.2.0   â”‚ â”‚
â”‚  â”‚    Enterprise development tools and profiles                  â”‚ â”‚
â”‚  â”‚    Profiles: 3  Agents: 5  Tools: 8                          â”‚ â”‚
â”‚  â”‚    [View] [Update Available] [Remove]                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸ“¦ foundation                                        v2.0.0   â”‚ â”‚
â”‚  â”‚    Core profiles and base configurations                      â”‚ â”‚
â”‚  â”‚    Profiles: 2  Agents: 3  Tools: 0                          â”‚ â”‚
â”‚  â”‚    [View] [Up to date]                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  Available (12)                                          [Browse â†’] â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">3. Profile Builder</h4>
        <p>Visual profile editor with inheritance visualization.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Profile Builder: my-custom-profile                        [Save]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Extends: [foundation:base â–¼]                                       â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Inheritance Chain                                               â”‚â”‚
â”‚  â”‚ foundation:base â†’ enterprise-dev:development â†’ my-custom        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                     â”‚
â”‚  Providers                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ðŸ¤– provider-anthropic    â”‚  â”‚ + Add Provider           â”‚        â”‚
â”‚  â”‚    Model: claude-sonnet  â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚    Temperature: 0.7      â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚    [Configure] [Remove]  â”‚  â”‚                          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â”‚  Tools                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [x] filesystem   [x] bash   [x] web   [ ] task   [+ Add Tool]     â”‚
â”‚                                                                     â”‚
â”‚  Hooks                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [x] logging   [x] security-scan   [ ] audit-trail   [+ Add Hook]  â”‚
â”‚                                                                     â”‚
â”‚  Preview YAML                                              [Copy]   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ extends: foundation:base                                        â”‚â”‚
â”‚  â”‚ providers:                                                      â”‚â”‚
â”‚  â”‚   - module: provider-anthropic                                  â”‚â”‚
â”‚  â”‚     config:                                                     â”‚â”‚
â”‚  â”‚       model: claude-sonnet-4-5                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">4. Analytics Dashboard</h4>
        <p>Real-time usage analytics and insights.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Analytics                                    [Last 7 days â–¼] [ðŸ”„]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   1,247     â”‚ â”‚   45.2K     â”‚ â”‚   $127.50   â”‚ â”‚   2.3s      â”‚   â”‚
â”‚  â”‚  Sessions   â”‚ â”‚   Tokens    â”‚ â”‚   Cost      â”‚ â”‚   Avg Time  â”‚   â”‚
â”‚  â”‚   â†‘ 12%     â”‚ â”‚   â†‘ 8%      â”‚ â”‚   â†“ 5%      â”‚ â”‚   â†“ 15%     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Usage Over Time                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”‚                                                                  â”‚
â”‚  â”‚     â•­â”€â”€â•®                       â•­â”€â”€â”€â”€â•®                           â”‚
â”‚  â”‚  â•­â”€â”€â•¯  â•°â”€â”€â•®               â•­â”€â”€â”€â”€â•¯    â•°â”€â”€â•®                        â”‚
â”‚  â”‚â”€â”€â•¯        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯            â•°â”€â”€â”€â”€                    â”‚
â”‚  â”‚                                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚    Mon   Tue   Wed   Thu   Fri   Sat   Sun                         â”‚
â”‚                                                                     â”‚
â”‚  Top Profiles                    â”‚  Top Tools                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. enterprise-dev:dev    42%   â”‚  1. codebase-search      35%     â”‚
â”‚  2. foundation:base       28%   â”‚  2. filesystem           28%     â”‚
â”‚  3. custom:review         15%   â”‚  3. bash                 22%     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">5. Session History &amp; Search</h4>
        <p>Browse and search past sessions.</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Session History                              [Search...] [Filter]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Today                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ #47 â€¢ 10:30 AM â€¢ enterprise-dev:development                     â”‚â”‚
â”‚  â”‚ &quot;How does the payment processing work?&quot;                         â”‚â”‚
â”‚  â”‚ 12 messages â€¢ 4.5K tokens â€¢ [Resume] [Export]                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ #46 â€¢ 9:15 AM â€¢ foundation:base                                 â”‚â”‚
â”‚  â”‚ &quot;Generate unit tests for UserService&quot;                           â”‚â”‚
â”‚  â”‚ 8 messages â€¢ 2.1K tokens â€¢ [Resume] [Export]                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                     â”‚
â”‚  Yesterday                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ #45 â€¢ 4:45 PM â€¢ enterprise-dev:review                           â”‚â”‚
â”‚  â”‚ &quot;Review PR #234 for security issues&quot;                            â”‚â”‚
â”‚  â”‚ 15 messages â€¢ 8.2K tokens â€¢ [Resume] [Export]                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                     â”‚
â”‚  [Load More]                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Web Dashboard                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    React/Next.js Frontend                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ Chat     â”‚ â”‚Collectionâ”‚ â”‚ Profile  â”‚ â”‚Analytics â”‚        â”‚   â”‚
â”‚  â”‚  â”‚ Workspaceâ”‚ â”‚ Manager  â”‚ â”‚ Builder  â”‚ â”‚Dashboard â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â”‚                           â”‚                                   â”‚   â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚                    â”‚ API Client  â”‚                           â”‚   â”‚
â”‚  â”‚                    â”‚ (SDK)       â”‚                           â”‚   â”‚
â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                    â”‚ Amplifier API   â”‚                              â”‚
â”‚                    â”‚ Server          â”‚                              â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Tech Stack</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">frontend:
  framework: Next.js 14
  language: TypeScript
  styling: Tailwind CSS
  state: Zustand or React Query
  components: shadcn/ui
  charts: Recharts

api_client:
  type: Generated from OpenAPI
  websocket: Native WebSocket

deployment:
  options:
    - Vercel (recommended)
    - Docker + nginx
    - Static export + CDN</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Pages Structure</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">app/
â”œâ”€â”€ page.tsx                 # Landing / redirect to dashboard
â”œâ”€â”€ login/
â”‚   â””â”€â”€ page.tsx             # Authentication
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ page.tsx             # Main dashboard (analytics)
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ page.tsx         # Chat workspace
â”‚   â”‚   â””â”€â”€ [sessionId]/
â”‚   â”‚       â””â”€â”€ page.tsx     # Specific session
â”‚   â”œâ”€â”€ collections/
â”‚   â”‚   â”œâ”€â”€ page.tsx         # Collection manager
â”‚   â”‚   â””â”€â”€ [name]/
â”‚   â”‚       â””â”€â”€ page.tsx     # Collection details
â”‚   â”œâ”€â”€ profiles/
â”‚   â”‚   â”œâ”€â”€ page.tsx         # Profile list
â”‚   â”‚   â”œâ”€â”€ new/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx     # Profile builder
â”‚   â”‚   â””â”€â”€ [name]/
â”‚   â”‚       â””â”€â”€ page.tsx     # Edit profile
â”‚   â”œâ”€â”€ history/
â”‚   â”‚   â””â”€â”€ page.tsx         # Session history
â”‚   â””â”€â”€ settings/
â”‚       â””â”€â”€ page.tsx         # User settings
â””â”€â”€ api/
    â””â”€â”€ [...proxy]/
        â””â”€â”€ route.ts         # API proxy (optional)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Chat Component</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">tsx</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-tsx">// components/chat/ChatWorkspace.tsx
&quot;use client&quot;;

import { useState, useEffect, useRef } from &quot;react&quot;;
import { useSession } from &quot;@/hooks/useSession&quot;;
import { MessageList } from &quot;./MessageList&quot;;
import { ChatInput } from &quot;./ChatInput&quot;;
import { SessionSidebar } from &quot;./SessionSidebar&quot;;
import { ProfileSelector } from &quot;./ProfileSelector&quot;;

export function ChatWorkspace() {
  const [sessionId, setSessionId] = useState&lt;string | null&gt;(null);
  const [messages, setMessages] = useState&lt;Message[]&gt;([]);
  const [isStreaming, setIsStreaming] = useState(false);
  const messagesEndRef = useRef&lt;HTMLDivElement&gt;(null);

  const { createSession, executePrompt, sessions } = useSession();

  const handleNewSession = async (profile: string) =&gt; {
    const session = await createSession(profile);
    setSessionId(session.id);
    setMessages([]);
  };

  const handleSendMessage = async (content: string) =&gt; {
    if (!sessionId) return;

    // Add user message
    setMessages((prev) =&gt; [...prev, { role: &quot;user&quot;, content }]);
    setIsStreaming(true);

    // Stream response
    let assistantMessage = &quot;&quot;;
    for await (const event of executePrompt(sessionId, content)) {
      if (event.type === &quot;token&quot;) {
        assistantMessage += event.content;
        setMessages((prev) =&gt; {
          const updated = [...prev];
          const lastIdx = updated.length - 1;
          if (updated[lastIdx]?.role === &quot;assistant&quot;) {
            updated[lastIdx].content = assistantMessage;
          } else {
            updated.push({ role: &quot;assistant&quot;, content: assistantMessage });
          }
          return updated;
        });
      }
    }

    setIsStreaming(false);
  };

  return (
    &lt;div className=&quot;flex h-screen&quot;&gt;
      {/* Sidebar */}
      &lt;SessionSidebar
        sessions={sessions}
        activeSessionId={sessionId}
        onSelectSession={setSessionId}
        onNewSession={() =&gt; setSessionId(null)}
      /&gt;

      {/* Main chat area */}
      &lt;div className=&quot;flex-1 flex flex-col&quot;&gt;
        {/* Header */}
        &lt;div className=&quot;border-b p-4 flex justify-between items-center&quot;&gt;
          &lt;h2&gt;
            {sessionId ? `Session #${sessionId.slice(0, 8)}` : &quot;New Session&quot;}
          &lt;/h2&gt;
          &lt;ProfileSelector
            onSelect={handleNewSession}
            disabled={!!sessionId}
          /&gt;
        &lt;/div&gt;

        {/* Messages */}
        &lt;div className=&quot;flex-1 overflow-y-auto p-4&quot;&gt;
          &lt;MessageList messages={messages} isStreaming={isStreaming} /&gt;
          &lt;div ref={messagesEndRef} /&gt;
        &lt;/div&gt;

        {/* Input */}
        &lt;ChatInput
          onSend={handleSendMessage}
          disabled={!sessionId || isStreaming}
          placeholder={sessionId ? &quot;Type your message...&quot; : &quot;Select a profile to start&quot;}
        /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Collection Manager Component</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">tsx</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-tsx">// components/collections/CollectionManager.tsx
&quot;use client&quot;;

import { useCollections } from &quot;@/hooks/useCollections&quot;;
import { CollectionCard } from &quot;./CollectionCard&quot;;
import { InstallModal } from &quot;./InstallModal&quot;;
import { useState } from &quot;react&quot;;

export function CollectionManager() {
  const { collections, install, remove, checkUpdates } = useCollections();
  const [showInstall, setShowInstall] = useState(false);

  const handleInstall = async (source: string) =&gt; {
    await install(source);
    setShowInstall(false);
  };

  return (
    &lt;div className=&quot;p-6&quot;&gt;
      &lt;div className=&quot;flex justify-between items-center mb-6&quot;&gt;
        &lt;h1 className=&quot;text-2xl font-bold&quot;&gt;Collections&lt;/h1&gt;
        &lt;div className=&quot;flex gap-2&quot;&gt;
          &lt;button
            onClick={() =&gt; checkUpdates()}
            className=&quot;btn btn-secondary&quot;
          &gt;
            Check Updates
          &lt;/button&gt;
          &lt;button
            onClick={() =&gt; setShowInstall(true)}
            className=&quot;btn btn-primary&quot;
          &gt;
            + Install Collection
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;section className=&quot;mb-8&quot;&gt;
        &lt;h2 className=&quot;text-lg font-semibold mb-4&quot;&gt;
          Installed ({collections.length})
        &lt;/h2&gt;
        &lt;div className=&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;&gt;
          {collections.map((collection) =&gt; (
            &lt;CollectionCard
              key={collection.name}
              collection={collection}
              onRemove={() =&gt; remove(collection.name)}
            /&gt;
          ))}
        &lt;/div&gt;
      &lt;/section&gt;

      {showInstall &amp;&amp; (
        &lt;InstallModal
          onInstall={handleInstall}
          onClose={() =&gt; setShowInstall(false)}
        /&gt;
      )}
    &lt;/div&gt;
  );
}</code></pre>
        </div>
        <p>---</p>
        <h3>Authentication</h3>
        <p>Integrates with API server authentication:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">tsx</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-tsx">// lib/auth.ts
import { signIn, signOut, useSession } from &quot;next-auth/react&quot;;

export const authConfig = {
  providers: [
    // GitHub OAuth
    GitHubProvider({
      clientId: process.env.GITHUB_ID,
      clientSecret: process.env.GITHUB_SECRET,
    }),
    // API Key auth
    CredentialsProvider({
      name: &quot;API Key&quot;,
      credentials: {
        apiKey: { label: &quot;API Key&quot;, type: &quot;password&quot; }
      },
      async authorize(credentials) {
        // Validate API key against Amplifier API
        const res = await fetch(`${API_URL}/v1/auth/validate`, {
          headers: { &quot;X-API-Key&quot;: credentials.apiKey }
        });
        if (res.ok) {
          return await res.json();
        }
        return null;
      }
    })
  ]
};</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Dashboard configuration
dashboard:
  title: &quot;Amplifier Dashboard&quot;
  logo: &quot;/logo.svg&quot;

  api:
    url: &quot;https://api.amplifier.example.com&quot;
    # Or local
    # url: &quot;http://localhost:8000&quot;

  features:
    chat: true
    collections: true
    profiles: true
    analytics: true
    history: true

  theme:
    primary: &quot;#6366f1&quot;
    mode: &quot;system&quot;  # light | dark | system

  auth:
    providers: [&quot;github&quot;, &quot;api_key&quot;]
    required: true</code></pre>
        </div>
        <p>---</p>
        <h3>Deployment</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Vercel (Recommended)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">bash</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-bash"># Deploy to Vercel
vercel deploy

# Environment variables
NEXT_PUBLIC_API_URL=https://api.amplifier.example.com
NEXTAUTH_SECRET=xxx
GITHUB_ID=xxx
GITHUB_SECRET=xxx</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Docker</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">dockerfile</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-dockerfile">FROM node:20-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:20-alpine AS runner
WORKDIR /app
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

EXPOSE 3000
CMD [&quot;node&quot;, &quot;server.js&quot;]</code></pre>
        </div>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Self-hosted vs Cloud</strong>: Should we offer a hosted version?</li>
        <li><strong>Offline mode</strong>: Support for local-only without API server?</li>
        <li><strong>Team features</strong>: Shared sessions, team profiles?</li>
        <li><strong>Plugin system</strong>: Allow dashboard extensions?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-context-codebase-knowledge-graph" data-category="contexts">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Context Codebase Knowledge Graph</span>
            <span class="spec-category">contexts</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-context-codebase-knowledge-graph</code></p>
        </div>
        <h3>Overview</h3>
        <p>A context manager that maintains a living knowledge graph of the codebase structure (files, functions, classes, dependencies, data flow) and injects relevant subgraphs into conversation context. Enables graph-based queries like "What depends on X?", "How does data flow from A to B?", and "What's the impact radius of changing Y?"</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Flat file view of codebase</td><td>Relationship-aware graph view</td></tr>
            <tr><td>"What depends on this?" requires manual tracing</td><td>Graph traversal shows all dependencies instantly</td></tr>
            <tr><td>Impact analysis is guesswork</td><td>Precise impact radius calculation</td></tr>
            <tr><td>Dead code unknown</td><td>Graph reachability detects unused code</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Refactoring impact analysis</strong>: "What breaks if I change this module?"</li>
        <li><strong>Dependency tracing</strong>: "What does this function call? What calls it?"</li>
        <li><strong>Data flow analysis</strong>: "How does user data get to the database?"</li>
        <li><strong>Dead code detection</strong>: "What code is unreachable from entry points?"</li>
        <li><strong>Architecture understanding</strong>: "Show me the call graph for authentication"</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">ContextManager Interface</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class CodebaseKnowledgeGraphContext:
    &quot;&quot;&quot;
    Context manager with codebase graph integration.
    
    Extends standard context with:
    - Codebase graph construction and maintenance
    - Graph-based queries
    - Relevant subgraph injection into context
    - Impact analysis
    &quot;&quot;&quot;
    
    async def add_message(
        self, 
        message: dict[str, Any],
    ) -&gt; None:
        &quot;&quot;&quot;
        Add message to context.
        
        If message mentions code entities:
        1. Query graph for related entities
        2. Inject relevant subgraph into context
        &quot;&quot;&quot;
    
    async def get_messages(
        self,
        include_graph_context: bool = True
    ) -&gt; list[dict[str, Any]]:
        &quot;&quot;&quot;
        Get messages with optional graph context.
        
        Args:
            include_graph_context: Include relevant graph data
        &quot;&quot;&quot;
    
    # Graph query methods
    
    async def find_dependencies(
        self,
        entity: str
    ) -&gt; list[Dependency]:
        &quot;&quot;&quot;Find all dependencies of an entity.&quot;&quot;&quot;
    
    async def find_dependents(
        self,
        entity: str
    ) -&gt; list[Dependent]:
        &quot;&quot;&quot;Find all entities that depend on this entity.&quot;&quot;&quot;
    
    async def trace_call_chain(
        self,
        from_func: str,
        to_func: str
    ) -&gt; list[CallPath]:
        &quot;&quot;&quot;Find call paths between functions.&quot;&quot;&quot;
    
    async def calculate_impact_radius(
        self,
        changed_files: list[str]
    ) -&gt; ImpactAnalysis:
        &quot;&quot;&quot;Calculate impact of changing files.&quot;&quot;&quot;
    
    async def detect_circular_dependencies(self) -&gt; list[Cycle]:
        &quot;&quot;&quot;Find circular dependency chains.&quot;&quot;&quot;
    
    async def find_unused_code(
        self,
        entry_points: list[str]
    ) -&gt; list[str]:
        &quot;&quot;&quot;Find code unreachable from entry points.&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Configuration Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">toml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-toml">[[contexts]]
module = &quot;context-codebase-knowledge-graph&quot;
config = {
  # Graph construction
  codebase_paths = [&quot;src/&quot;, &quot;lib/&quot;]
  exclude_paths = [&quot;node_modules/&quot;, &quot;dist/&quot;, &quot;.git/&quot;]
  languages = [&quot;typescript&quot;, &quot;python&quot;, &quot;rust&quot;]
  
  # Graph storage
  graph_database = &quot;neo4j://localhost:7687&quot;  # or &quot;sqlite&quot;, &quot;memory&quot;
  persistence = true
  incremental_updates = true
  
  # Indexing strategy
  index_on_startup = false                   # Build graph on first use
  watch_for_changes = true                   # Update graph on file changes
  debounce_ms = 1000                         # Debounce rapid changes
  
  # Node types to track
  track_files = true
  track_functions = true
  track_classes = true
  track_variables = true
  track_imports = true
  track_tables = true                        # Database tables
  
  # Relationship types to track
  track_imports_relations = true             # File imports file
  track_calls_relations = true               # Function calls function
  track_inherits_relations = true            # Class inherits class
  track_modifies_relations = true            # Function modifies table
  track_reads_relations = true               # Function reads table
  
  # Context injection
  auto_inject_graph = true                   # Auto-inject relevant subgraph
  max_depth = 3                              # Max traversal depth
  max_nodes = 50                             # Max nodes in subgraph
  
  # Query optimization
  cache_queries = true
  cache_ttl_seconds = 300
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Graph node types
@dataclass
class FileNode:
    path: str
    language: str
    lines_of_code: int
    last_modified: datetime

@dataclass
class FunctionNode:
    name: str
    file: str
    signature: str
    line_start: int
    line_end: int

@dataclass
class ClassNode:
    name: str
    file: str
    methods: list[str]
    line_start: int

@dataclass
class TableNode:
    name: str
    database: str
    columns: list[str]

# Graph relationship types
@dataclass
class ImportsRelation:
    from_file: str
    to_file: str

@dataclass
class CallsRelation:
    from_func: str
    to_func: str
    call_count: int

@dataclass
class InheritsRelation:
    child_class: str
    parent_class: str

@dataclass
class ModifiesRelation:
    function: str
    table: str
    operation: str  # INSERT, UPDATE, DELETE

# Query results
@dataclass
class Dependency:
    entity: str
    type: str
    relationship: str

@dataclass
class ImpactAnalysis:
    directly_affected: list[str]      # Files directly importing changed files
    indirectly_affected: list[str]    # Files transitively affected
    estimated_risk: str               # &quot;low&quot; | &quot;medium&quot; | &quot;high&quot;
    affected_count: int
    depth_levels: dict[int, list[str]]  # {depth: [files at that depth]}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>context:graph:building</code></td><td>Graph construction starts</td><td>codebase_path, file_count</td></tr>
            <tr><td><code>context:graph:built</code></td><td>Graph construction complete</td><td>node_count, edge_count, duration_ms</td></tr>
            <tr><td><code>context:graph:updated</code></td><td>Incremental update</td><td>changed_files, updated_nodes</td></tr>
            <tr><td><code>context:graph:queried</code></td><td>Graph query executed</td><td>query_type, result_count</td></tr>
            <tr><td><code>context:graph:injected</code></td><td>Subgraph injected into context</td><td>entity, subgraph_size</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          context-codebase-knowledge-graph                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Codebase    â”‚â”€â”€â”€â–¶â”‚    Graph     â”‚â”€â”€â”€â–¶â”‚   Query    â”‚   â”‚
â”‚  â”‚   Parser     â”‚    â”‚   Builder    â”‚    â”‚   Engine   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚         â”‚
â”‚                                                  â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Change     â”‚    â”‚  Subgraph    â”‚    â”‚   Graph    â”‚   â”‚
â”‚  â”‚   Watcher    â”‚    â”‚  Extractor   â”‚    â”‚   Store    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Graph Schema:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  File   â”‚â”€IMPORTSâ†’â”‚   File   â”‚â”€DEFINESâ†’â”‚Function â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                               â”‚CALLS
                                               â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Table   â”‚â—€MODIFIESâ”€â”‚ Function â”‚â”€CALLSâ”€â†’â”‚Function â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Codebase Parser</p>
        <p>Parses code to extract entities and relationships:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class CodebaseParser:
    &quot;&quot;&quot;Parses codebase to extract graph nodes and edges.&quot;&quot;&quot;
    
    def __init__(self, languages: list[str]):
        self.parsers = {
            lang: self._init_parser(lang)
            for lang in languages
        }
    
    def _init_parser(self, language: str):
        &quot;&quot;&quot;Initialize TreeSitter parser for language.&quot;&quot;&quot;
        import tree_sitter
        
        language_lib = tree_sitter.Language(
            f&#039;build/{language}.so&#039;,
            language
        )
        
        parser = tree_sitter.Parser()
        parser.set_language(language_lib)
        
        return parser
    
    async def parse_file(self, file_path: Path) -&gt; FileParseResult:
        &quot;&quot;&quot;
        Parse file and extract entities and relationships.
        
        Returns:
        - Nodes: functions, classes, variables
        - Edges: calls, imports, inherits
        &quot;&quot;&quot;
        
        language = self._detect_language(file_path)
        parser = self.parsers.get(language)
        
        if not parser:
            return FileParseResult.empty()
        
        # Read and parse file
        content = file_path.read_text()
        tree = parser.parse(bytes(content, &quot;utf8&quot;))
        
        # Extract entities
        nodes = []
        edges = []
        
        # Extract functions
        functions = self._extract_functions(tree, file_path)
        nodes.extend(functions)
        
        # Extract classes
        classes = self._extract_classes(tree, file_path)
        nodes.extend(classes)
        
        # Extract imports
        imports = self._extract_imports(tree, file_path)
        edges.extend(imports)
        
        # Extract function calls
        calls = self._extract_calls(tree, file_path)
        edges.extend(calls)
        
        return FileParseResult(nodes=nodes, edges=edges)
    
    def _extract_functions(
        self,
        tree: tree_sitter.Tree,
        file_path: Path
    ) -&gt; list[FunctionNode]:
        &quot;&quot;&quot;Extract function definitions.&quot;&quot;&quot;
        
        functions = []
        
        # Query for function definitions
        query = &quot;&quot;&quot;
        (function_declaration
          name: (identifier) @func_name
          parameters: (formal_parameters) @params
        ) @function
        &quot;&quot;&quot;
        
        matches = self._query_tree(tree, query)
        
        for match in matches:
            func_node = match[&quot;function&quot;]
            name = match[&quot;func_name&quot;].text.decode()
            
            functions.append(FunctionNode(
                name=name,
                file=str(file_path),
                signature=self._extract_signature(match),
                line_start=func_node.start_point[0],
                line_end=func_node.end_point[0]
            ))
        
        return functions
    
    def _extract_calls(
        self,
        tree: tree_sitter.Tree,
        file_path: Path
    ) -&gt; list[CallsRelation]:
        &quot;&quot;&quot;Extract function calls.&quot;&quot;&quot;
        
        calls = []
        
        # Query for call expressions
        query = &quot;&quot;&quot;
        (call_expression
          function: (identifier) @callee
        ) @call
        &quot;&quot;&quot;
        
        matches = self._query_tree(tree, query)
        
        # Track which function contains this call
        current_function = None  # Determined by context
        
        for match in matches:
            callee = match[&quot;callee&quot;].text.decode()
            
            if current_function:
                calls.append(CallsRelation(
                    from_func=current_function,
                    to_func=callee,
                    call_count=1
                ))
        
        return calls</code></pre>
        </div>
        <p>#### 2. Graph Builder</p>
        <p>Constructs and maintains graph:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class GraphBuilder:
    &quot;&quot;&quot;Builds and maintains codebase knowledge graph.&quot;&quot;&quot;
    
    def __init__(self, graph_store: GraphStore):
        self.graph_store = graph_store
        self.parser = CodebaseParser([&quot;typescript&quot;, &quot;python&quot;, &quot;rust&quot;])
    
    async def build_graph(self, codebase_paths: list[Path]) -&gt; GraphStats:
        &quot;&quot;&quot;Build complete graph from codebase.&quot;&quot;&quot;
        
        stats = GraphStats()
        
        # Find all source files
        files = []
        for path in codebase_paths:
            files.extend(self._find_source_files(path))
        
        stats.files_found = len(files)
        
        # Parse all files in parallel
        parse_tasks = [
            self.parser.parse_file(file)
            for file in files
        ]
        
        results = await asyncio.gather(*parse_tasks)
        
        # Build graph
        for file, result in zip(files, results):
            # Add file node
            await self.graph_store.add_node(FileNode(
                path=str(file),
                language=self._detect_language(file),
                lines_of_code=self._count_lines(file),
                last_modified=file.stat().st_mtime
            ))
            
            # Add entity nodes
            for node in result.nodes:
                await self.graph_store.add_node(node)
                stats.nodes_added += 1
            
            # Add relationships
            for edge in result.edges:
                await self.graph_store.add_edge(edge)
                stats.edges_added += 1
        
        return stats
    
    async def update_file(self, file_path: Path):
        &quot;&quot;&quot;Incrementally update graph for changed file.&quot;&quot;&quot;
        
        # Remove existing nodes/edges for this file
        await self.graph_store.remove_nodes_by_file(str(file_path))
        
        # Re-parse file
        result = await self.parser.parse_file(file_path)
        
        # Add updated nodes/edges
        for node in result.nodes:
            await self.graph_store.add_node(node)
        
        for edge in result.edges:
            await self.graph_store.add_edge(edge)</code></pre>
        </div>
        <p>#### 3. Graph Store</p>
        <p>Persists and queries graph:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class GraphStore:
    &quot;&quot;&quot;Graph database abstraction.&quot;&quot;&quot;
    
    def __init__(self, backend: str = &quot;neo4j&quot;):
        self.backend = backend
        self.conn = self._connect(backend)
    
    async def add_node(self, node: Node):
        &quot;&quot;&quot;Add node to graph.&quot;&quot;&quot;
        
        if self.backend == &quot;neo4j&quot;:
            await self._neo4j_add_node(node)
        elif self.backend == &quot;sqlite&quot;:
            await self._sqlite_add_node(node)
    
    async def add_edge(self, edge: Relation):
        &quot;&quot;&quot;Add edge to graph.&quot;&quot;&quot;
        # Implementation depends on backend
        ...
    
    async def query(
        self,
        cypher_query: str,
        params: dict | None = None
    ) -&gt; list[dict]:
        &quot;&quot;&quot;Execute Cypher query (or SQL equivalent).&quot;&quot;&quot;
        
        if self.backend == &quot;neo4j&quot;:
            result = await self.conn.execute_read(
                lambda tx: tx.run(cypher_query, params or {})
            )
            return [record.data() for record in result]
        
        # Translate to SQL for sqlite backend
        ...
    
    # Common query patterns
    
    async def find_dependencies(self, entity: str) -&gt; list[str]:
        &quot;&quot;&quot;Find all dependencies of entity.&quot;&quot;&quot;
        
        query = &quot;&quot;&quot;
        MATCH (e {name: $entity})-[r:IMPORTS|CALLS|INHERITS]-&gt;(dep)
        RETURN dep.name as dependency
        &quot;&quot;&quot;
        
        results = await self.query(query, {&quot;entity&quot;: entity})
        return [r[&quot;dependency&quot;] for r in results]
    
    async def find_dependents(self, entity: str) -&gt; list[str]:
        &quot;&quot;&quot;Find all entities that depend on this entity.&quot;&quot;&quot;
        
        query = &quot;&quot;&quot;
        MATCH (dependent)-[r:IMPORTS|CALLS|INHERITS]-&gt;(e {name: $entity})
        RETURN dependent.name as dependent
        &quot;&quot;&quot;
        
        results = await self.query(query, {&quot;entity&quot;: entity})
        return [r[&quot;dependent&quot;] for r in results]
    
    async def find_call_paths(
        self,
        from_func: str,
        to_func: str,
        max_depth: int = 5
    ) -&gt; list[list[str]]:
        &quot;&quot;&quot;Find call paths between functions.&quot;&quot;&quot;
        
        query = &quot;&quot;&quot;
        MATCH path = (start:Function {name: $from})-[:CALLS*1..${max_depth}]-&gt;(end:Function {name: $to})
        RETURN [node in nodes(path) | node.name] as path
        LIMIT 10
        &quot;&quot;&quot;
        
        results = await self.query(query, {
            &quot;from&quot;: from_func,
            &quot;to&quot;: to_func,
            &quot;max_depth&quot;: max_depth
        })
        
        return [r[&quot;path&quot;] for r in results]
    
    async def calculate_impact(
        self,
        changed_files: list[str],
        max_depth: int = 5
    ) -&gt; dict[int, list[str]]:
        &quot;&quot;&quot;Calculate impact radius (BFS from changed files).&quot;&quot;&quot;
        
        query = &quot;&quot;&quot;
        MATCH (changed:File)
        WHERE changed.path IN $changed_files
        CALL {
          WITH changed
          MATCH path = (changed)&lt;-[:IMPORTS*1..${max_depth}]-(dependent:File)
          RETURN dependent.path as file, length(path) as depth
        }
        RETURN depth, collect(DISTINCT file) as files
        ORDER BY depth
        &quot;&quot;&quot;
        
        results = await self.query(query, {
            &quot;changed_files&quot;: changed_files,
            &quot;max_depth&quot;: max_depth
        })
        
        return {r[&quot;depth&quot;]: r[&quot;files&quot;] for r in results}</code></pre>
        </div>
        <p>#### 4. Subgraph Extractor</p>
        <p>Extracts relevant subgraph for context:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SubgraphExtractor:
    &quot;&quot;&quot;Extracts relevant subgraph for conversation context.&quot;&quot;&quot;
    
    def __init__(self, graph_store: GraphStore):
        self.graph_store = graph_store
    
    async def extract_relevant_subgraph(
        self,
        entities: list[str],
        max_depth: int = 2,
        max_nodes: int = 50
    ) -&gt; Subgraph:
        &quot;&quot;&quot;
        Extract subgraph relevant to entities.
        
        Strategy:
        1. Start from mentioned entities
        2. Expand outward (BFS) up to max_depth
        3. Stop at max_nodes
        4. Format for context injection
        &quot;&quot;&quot;
        
        subgraph = Subgraph(nodes=[], edges=[])
        visited = set()
        queue = [(entity, 0) for entity in entities]
        
        while queue and len(subgraph.nodes) &lt; max_nodes:
            entity, depth = queue.pop(0)
            
            if entity in visited or depth &gt; max_depth:
                continue
            
            visited.add(entity)
            
            # Get node
            node = await self.graph_store.get_node(entity)
            if node:
                subgraph.nodes.append(node)
            
            # Get edges
            edges = await self.graph_store.get_edges(entity)
            subgraph.edges.extend(edges)
            
            # Expand to neighbors (if within depth)
            if depth &lt; max_depth:
                neighbors = await self.graph_store.get_neighbors(entity)
                queue.extend((n, depth + 1) for n in neighbors)
        
        return subgraph
    
    def format_for_context(self, subgraph: Subgraph) -&gt; str:
        &quot;&quot;&quot;Format subgraph for injection into context.&quot;&quot;&quot;
        
        sections = []
        
        # Files
        files = [n for n in subgraph.nodes if isinstance(n, FileNode)]
        if files:
            sections.append(&quot;# Files&quot;)
            for file in files:
                sections.append(f&quot;- {file.path} ({file.lines_of_code} LOC)&quot;)
        
        # Functions
        functions = [n for n in subgraph.nodes if isinstance(n, FunctionNode)]
        if functions:
            sections.append(&quot;\n# Functions&quot;)
            for func in functions:
                sections.append(f&quot;- {func.name} in {func.file}:{func.line_start}&quot;)
        
        # Relationships
        sections.append(&quot;\n# Relationships&quot;)
        for edge in subgraph.edges[:20]:  # Limit to 20 edges
            sections.append(f&quot;- {edge.from_entity} {edge.relation_type} {edge.to_entity}&quot;)
        
        return &quot;\n&quot;.join(sections)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">File Change Detected
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Re-parse File      â”‚
â”‚ - Extract entities â”‚
â”‚ - Extract relationsâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Graph       â”‚
â”‚ - Remove old nodes â”‚
â”‚ - Add new nodes    â”‚
â”‚ - Update edges     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   Graph Updated

Conversation Message:
&quot;Refactor auth module&quot;
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detect Entity      â”‚
â”‚ &quot;auth module&quot;      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Graph        â”‚
â”‚ - Find dependenciesâ”‚
â”‚ - Calculate impact â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extract Subgraph   â”‚
â”‚ - auth + deps      â”‚
â”‚ - Max 50 nodes     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Inject into Contextâ”‚
â”‚ (as system message)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Dependency Analysis</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># User asks
&quot;What depends on the User model?&quot;

# Graph query
find_dependents(&quot;User&quot;)

# Results
Dependencies on User model:
- src/api/users.py: Imports User model
  - createUser() reads User
  - updateUser() modifies User
- src/api/auth.py: Imports User model
  - authenticate() reads User
- src/services/email.py: Imports User
  - sendWelcomeEmail() reads User.email
- tests/test_users.py: Imports User (test code)

Direct dependents: 4 files
Indirect dependents: 12 files (via imports)
Impact: Medium

# Injected into context
---
Codebase Context: User Model Dependencies

## Direct Dependencies (4)
- src/api/users.py (IMPORTS User, MODIFIES users table)
- src/api/auth.py (IMPORTS User, READS users table)
- src/services/email.py (IMPORTS User)
- tests/test_users.py (IMPORTS User)

## Call Chains
- User.save() â† createUser() â† POST /api/users
- User.authenticate() â† authenticate() â† POST /api/auth/login

## Impact Estimate
Changing User model will affect:
- 4 files directly
- 12 files indirectly
- Risk: MEDIUM (auth flow impacted)
---</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Impact Analysis for Refactoring</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># User asks
&quot;I want to refactor the authentication module. What will break?&quot;

# Graph queries
changed_files = [&quot;src/auth/middleware.py&quot;, &quot;src/auth/tokens.py&quot;]
impact = calculate_impact_radius(changed_files)

# Results
Impact Analysis: Authentication Module Refactor

## Direct Impact (Depth 1) - 4 files
Files that directly import auth modules:
- src/api/routes/users.py (imports auth/middleware)
- src/api/routes/admin.py (imports auth/middleware)
- src/services/email.py (imports auth/tokens)
- src/background/jobs/cleanup.py (imports auth/sessions)

## Indirect Impact (Depth 2) - 14 files
Files that depend on direct dependents:
- src/api/routes/posts.py â†’ users.py â†’ auth
- src/api/routes/comments.py â†’ users.py â†’ auth
- [12 more files...]

## Database Impact
Tables modified by auth modules:
- users table (auth/sessions.py MODIFIES)
- refresh_tokens table (auth/tokens.py MODIFIES)
- Migration 003_add_auth.sql needs review

## Call Chains
Critical paths through auth:
1. POST /api/users â†’ users.create() â†’ auth.hashPassword() â†’ bcrypt.hash()
2. POST /api/login â†’ auth.authenticate() â†’ auth.verifyPassword()
3. Middleware: ALL protected routes â†’ auth.middleware.verify()

## Risk Assessment
- Files affected: 18 total
- Critical paths: 3 (all authentication flows)
- Database changes: 2 tables
- **Estimated Risk: HIGH** (auth is central, widely used)

## Recommendations
1. Update 4 direct imports (check API contracts)
2. Run test suite: pytest tests/auth/**
3. Check for breaking changes in middleware signature
4. Review migration 003_add_auth for schema dependencies
5. Consider feature flag for gradual rollout

# Injected subgraph into context
---
Codebase Context: Authentication Module Structure

[Full graph with 50 most relevant nodes showing structure]
---</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Call Path Tracing</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># User asks
&quot;How does a user login request get to the database?&quot;

# Graph query
trace_call_chain(&quot;POST /api/login&quot;, &quot;database.execute&quot;)

# Results
Call Path: Login Request â†’ Database

Path 1 (most common):
POST /api/login â†’ routes/auth.login()
                 â†’ auth.authenticate()
                 â†’ User.findByEmail()
                 â†’ database.query()
                 â†’ database.execute()

Path 2 (with caching):
POST /api/login â†’ routes/auth.login()
                 â†’ auth.authenticate()
                 â†’ cache.get() [cache miss]
                 â†’ User.findByEmail()
                 â†’ database.query()
                 â†’ database.execute()

## Data Flow
1. Request: { email, password }
2. Validation: auth.validateCredentials()
3. Query: SELECT * FROM users WHERE email = ?
4. Password Check: bcrypt.compare()
5. Token Generation: auth.generateToken()
6. Response: { token, user }

## Tables Accessed
- users (READ: email, password_hash)
- refresh_tokens (WRITE: new token)</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Full configuration example
contexts:
  - module: context-codebase-knowledge-graph
    config:
      # Source paths
      codebase_paths:
        - src/
        - lib/
      exclude_paths:
        - node_modules/
        - dist/
        - .git/
        - &quot;**/*.test.ts&quot;
      languages:
        - typescript
        - python
        - rust
      
      # Graph storage
      graph_database: neo4j://localhost:7687  # or sqlite, memory
      persistence: true
      incremental_updates: true
      
      # Indexing
      index_on_startup: false
      watch_for_changes: true
      debounce_ms: 1000
      
      # Node types
      track_files: true
      track_functions: true
      track_classes: true
      track_variables: true
      track_tables: true
      
      # Relationships
      track_imports_relations: true
      track_calls_relations: true
      track_inherits_relations: true
      track_modifies_relations: true
      track_reads_relations: true
      
      # Context injection
      auto_inject_graph: true
      max_depth: 3
      max_nodes: 50
      injection_format: markdown
      
      # Performance
      cache_queries: true
      cache_ttl_seconds: 300
      parallel_parsing: true
      max_parse_workers: 4</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Access</h4>
        <li><strong>Codebase access</strong>: Reads all source files</li>
        <li><strong>Graph data</strong>: Complete codebase structure exposed</li>
        <li><strong>Sensitive paths</strong>: May reveal internal architecture</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Resource Usage</h4>
        <li><strong>Graph construction</strong>: CPU/memory intensive</li>
        <li><strong>Graph storage</strong>: Disk space for persistence</li>
        <li><strong>Query performance</strong>: Complex graph queries may be slow</li>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;context:read&quot;,
    &quot;context:write&quot;,
    &quot;filesystem:read&quot;,              # Read codebase
    &quot;filesystem:watch&quot;,             # Watch for changes
]</code></pre>
        </div>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_parser_extracts_functions():
    parser = CodebaseParser([&quot;python&quot;])
    result = parser.parse_file(Path(&quot;test.py&quot;))
    assert len(result.nodes) &gt; 0
    assert any(isinstance(n, FunctionNode) for n in result.nodes)

def test_graph_store_finds_dependencies():
    store = GraphStore(&quot;memory&quot;)
    # Add nodes and edges
    deps = store.find_dependencies(&quot;User&quot;)
    assert &quot;auth.py&quot; in deps</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_full_graph_construction():
    context = CodebaseKnowledgeGraphContext(config)
    
    # Build graph
    await context.build_graph()
    
    # Query
    deps = await context.find_dependencies(&quot;User&quot;)
    assert len(deps) &gt; 0
    
    # Calculate impact
    impact = await context.calculate_impact_radius([&quot;src/user.py&quot;])
    assert impact.directly_affected &gt; 0</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>tree-sitter</code> + language grammars - Code parsing</li>
        <li><code>neo4j</code> or <code>sqlite3</code> - Graph storage</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>watchdog</code> - File watching</li>
        <li><code>networkx</code> - Graph algorithms (if not using Neo4j)</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Graph granularity</strong>: Track variable-level dependencies or just function-level?</li>
        <li><strong>Cross-language support</strong>: How to handle calls between languages (Python â†’ TypeScript)?</li>
        <li><strong>Database schema tracking</strong>: Extract schema from migrations vs runtime inspection?</li>
        <li><strong>Performance at scale</strong>: How to handle codebases with 100K+ files?</li>
        <li><strong>Semantic understanding</strong>: Should we use LLM to understand code semantics beyond syntax?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-context-decision-journal" data-category="contexts">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Context Decision Journal</span>
            <span class="spec-category">contexts</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-context-decision-journal</code></p>
        </div>
        <h3>Overview</h3>
        <p>A context manager that automatically detects, extracts, and indexes architectural and product decisions from conversations. Maintains a queryable decision log with full context, rationale, alternatives considered, and temporal tracking of how decisions evolve or get revisited.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>"Why did we choose X?" lost in history</td><td>Complete decision record with rationale</td></tr>
            <tr><td>Re-litigating old decisions</td><td>Quick lookup: "We decided this because..."</td></tr>
            <tr><td>New team members missing context</td><td>Decision journal as onboarding material</td></tr>
            <tr><td>Inconsistent decision-making</td><td>Learn from past decisions</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Onboarding</strong>: New engineers/PMs quickly understand past architectural decisions</li>
        <li><strong>Decision review</strong>: "Why did we choose Postgres over MongoDB?" - instant answer</li>
        <li><strong>Architecture evolution</strong>: Track how decisions changed over time</li>
        <li><strong>Pattern recognition</strong>: Identify decision patterns and principles</li>
        <li><strong>Compliance/audit</strong>: Maintain decision trail for governance</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">ContextManager Interface</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class DecisionJournalContext:
    &quot;&quot;&quot;
    Context manager with decision detection and indexing.
    
    Extends standard context manager with:
    - Automatic decision detection in conversations
    - Structured decision extraction
    - Queryable decision index
    - Temporal decision tracking
    &quot;&quot;&quot;
    
    async def add_message(
        self, 
        message: dict[str, Any],
    ) -&gt; None:
        &quot;&quot;&quot;
        Add message and detect decisions.
        
        If decision detected:
        1. Extract decision metadata
        2. Store in decision index
        3. Link to related code/features
        &quot;&quot;&quot;
    
    async def get_messages(self) -&gt; list[dict[str, Any]]:
        &quot;&quot;&quot;Get conversation messages (standard behavior).&quot;&quot;&quot;
    
    async def search_decisions(
        self,
        query: str,
        filters: DecisionFilters | None = None
    ) -&gt; list[Decision]:
        &quot;&quot;&quot;
        Search decision journal.
        
        Args:
            query: Text search query
            filters: Optional filters (by tech, date, stakeholder)
            
        Returns:
            Matching decisions with full context
        &quot;&quot;&quot;
    
    async def get_decision_chain(
        self,
        decision_id: str
    ) -&gt; DecisionChain:
        &quot;&quot;&quot;
        Get evolution of a decision.
        
        Returns:
        - Original decision
        - Revisions/updates
        - Superseded decisions
        &quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Configuration Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">toml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-toml">[[contexts]]
module = &quot;context-decision-journal&quot;
config = {
  # Decision detection
  auto_detect = true
  detection_keywords = [
    &quot;decided&quot;, &quot;decision:&quot;, &quot;let&#039;s go with&quot;, &quot;we should&quot;,
    &quot;agreed&quot;, &quot;consensus&quot;, &quot;choosing&quot;, &quot;selected&quot;
  ]
  detection_threshold = 0.7                 # Confidence threshold for LLM detection
  
  # Extraction
  structured_extraction = true              # Extract metadata (what, why, alternatives)
  extract_rationale = true
  extract_alternatives = true
  extract_trade_offs = true
  
  # Linking
  link_to_code = true                       # Link decisions to code files
  link_to_features = true                   # Link to features/epics
  auto_link_strategy = &quot;file_mention&quot;       # &quot;file_mention&quot; | &quot;git_context&quot; | &quot;llm_inference&quot;
  
  # Indexing
  search_index = &quot;sqlite&quot;                   # &quot;memory&quot; | &quot;sqlite&quot; | &quot;elasticsearch&quot;
  index_embeddings = true                   # Enable semantic search
  embedding_model = &quot;text-embedding-3-small&quot;
  
  # Storage
  persistence = true                        # Persist decisions across sessions
  storage_path = &quot;.amplifier/decisions/&quot;
  retention_days = 730                      # 2 years default
  
  # Querying
  enable_temporal_queries = true            # &quot;decisions made in Q2 2024&quot;
  enable_stakeholder_queries = true         # &quot;decisions by @alice&quot;
  enable_technology_queries = true          # &quot;decisions about databases&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class Decision:
    &quot;&quot;&quot;Structured decision record.&quot;&quot;&quot;
    id: str                                  # UUID
    timestamp: datetime
    session_id: str
    
    # Core decision
    decision: str                            # What was decided
    context: str                             # Why was it being discussed
    rationale: str                           # Why this choice
    
    # Alternatives
    alternatives: list[Alternative]          # Other options considered
    trade_offs: TradeOffs | None            # Pros/cons analysis
    
    # Stakeholders
    stakeholders: list[str]                  # Who was involved
    decision_maker: str | None               # Final decision maker
    
    # Links
    related_code: list[str]                  # File paths affected
    related_features: list[str]              # Features/epics
    related_docs: list[str]                  # Documentation
    
    # Status
    status: DecisionStatus                   # active | superseded | revisited
    superseded_by: str | None                # Decision ID if replaced
    supersedes: str | None                   # Decision ID if this replaces another
    
    # Search
    tags: list[str]                          # [&quot;database&quot;, &quot;architecture&quot;]
    keywords: list[str]                      # Extracted key terms

@dataclass
class Alternative:
    &quot;&quot;&quot;Alternative option that was considered.&quot;&quot;&quot;
    option: str
    pros: list[str]
    cons: list[str]
    why_not_chosen: str | None

@dataclass
class TradeOffs:
    &quot;&quot;&quot;Structured pros/cons.&quot;&quot;&quot;
    pros: list[str]
    cons: list[str]
    risks: list[str]
    assumptions: list[str]

@dataclass
class DecisionChain:
    &quot;&quot;&quot;Evolution of a decision over time.&quot;&quot;&quot;
    original: Decision
    revisions: list[Decision]
    current: Decision
    
enum DecisionStatus:
    ACTIVE = &quot;active&quot;                        # Current decision
    SUPERSEDED = &quot;superseded&quot;                # Replaced by newer decision
    REVISITED = &quot;revisited&quot;                  # Reconsidered but kept</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>context:decision:detected</code></td><td>Decision detected</td><td>decision_id, confidence</td></tr>
            <tr><td><code>context:decision:extracted</code></td><td>Metadata extracted</td><td>decision_id, decision_summary</td></tr>
            <tr><td><code>context:decision:indexed</code></td><td>Added to index</td><td>decision_id</td></tr>
            <tr><td><code>context:decision:superseded</code></td><td>Decision replaced</td><td>old_decision_id, new_decision_id</td></tr>
            <tr><td><code>context:decision:searched</code></td><td>Search performed</td><td>query, result_count</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              context-decision-journal                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Decision   â”‚â”€â”€â”€â–¶â”‚  Metadata    â”‚â”€â”€â”€â–¶â”‚    Decision   â”‚   â”‚
â”‚  â”‚  Detector   â”‚    â”‚  Extractor   â”‚    â”‚     Index     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚           â”‚
â”‚                                                  â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Code      â”‚    â”‚   Temporal   â”‚    â”‚    Search     â”‚   â”‚
â”‚  â”‚   Linker    â”‚    â”‚   Tracker    â”‚    â”‚    Engine     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Decision Detector</p>
        <p>Identifies decision points in conversations:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class DecisionDetector:
    &quot;&quot;&quot;Detects when decisions are made in conversations.&quot;&quot;&quot;
    
    DECISION_KEYWORDS = [
        &quot;decided&quot;, &quot;decision:&quot;, &quot;let&#039;s go with&quot;, &quot;we should&quot;,
        &quot;agreed&quot;, &quot;consensus&quot;, &quot;choosing&quot;, &quot;selected&quot;, &quot;approved&quot;,
        &quot;going with&quot;, &quot;will use&quot;, &quot;settled on&quot;
    ]
    
    def __init__(self, threshold: float = 0.7):
        self.threshold = threshold
    
    async def detect(
        self,
        message: dict[str, Any],
        conversation_context: list[dict[str, Any]]
    ) -&gt; DetectionResult:
        &quot;&quot;&quot;
        Detect if message contains a decision.
        
        Detection strategy:
        1. Keyword matching (fast, high recall)
        2. LLM confirmation (slower, high precision)
        3. Context analysis (is this really a decision?)
        &quot;&quot;&quot;
        content = message.get(&quot;content&quot;, &quot;&quot;)
        
        # Fast keyword check
        has_keyword = any(
            keyword in content.lower()
            for keyword in self.DECISION_KEYWORDS
        )
        
        if not has_keyword:
            return DetectionResult(is_decision=False, confidence=0.0)
        
        # LLM confirmation
        confidence = await self._llm_confirm(message, conversation_context)
        
        return DetectionResult(
            is_decision=confidence &gt;= self.threshold,
            confidence=confidence,
            decision_snippet=self._extract_snippet(content)
        )
    
    async def _llm_confirm(
        self,
        message: dict[str, Any],
        context: list[dict[str, Any]]
    ) -&gt; float:
        &quot;&quot;&quot;Use LLM to confirm this is a decision.&quot;&quot;&quot;
        
        context_str = self._format_context(context[-5:])  # Last 5 messages
        
        prompt = f&quot;&quot;&quot;
Analyze if this message contains a finalized decision:

Recent context:
{context_str}

Current message:
{message[&#039;content&#039;]}

Is this a decision being made (not just a proposal or discussion)?

Answer with a confidence score (0.0-1.0) and brief explanation:
- 1.0: Definitely a decision
- 0.5: Possibly a decision
- 0.0: Not a decision

Format: score|explanation
&quot;&quot;&quot;
        
        # Parse LLM response
        response = await self._call_llm(prompt)
        score, explanation = self._parse_response(response)
        
        return score</code></pre>
        </div>
        <p>#### 2. Metadata Extractor</p>
        <p>Extracts structured decision data:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class MetadataExtractor:
    &quot;&quot;&quot;Extracts structured metadata from decision conversations.&quot;&quot;&quot;
    
    async def extract(
        self,
        decision_message: dict[str, Any],
        conversation_context: list[dict[str, Any]]
    ) -&gt; Decision:
        &quot;&quot;&quot;
        Extract structured decision data.
        
        Extracts:
        - What was decided
        - Why (rationale)
        - What alternatives were considered
        - Who decided
        - What it relates to
        &quot;&quot;&quot;
        
        # Build extraction prompt with conversation context
        prompt = self._build_extraction_prompt(
            decision_message,
            conversation_context
        )
        
        # Get structured extraction from LLM
        raw_extraction = await self._call_llm(prompt)
        
        # Parse into Decision object
        decision = self._parse_extraction(raw_extraction)
        
        # Enrich with additional metadata
        decision = await self._enrich_decision(decision, conversation_context)
        
        return decision
    
    def _build_extraction_prompt(
        self,
        message: dict[str, Any],
        context: list[dict[str, Any]]
    ) -&gt; str:
        &quot;&quot;&quot;Build prompt for structured extraction.&quot;&quot;&quot;
        
        context_str = self._format_context(context[-10:])
        
        return f&quot;&quot;&quot;
Extract structured decision information:

Conversation context:
{context_str}

Decision message:
{message[&#039;content&#039;]}

Extract the following in JSON format:
{{
  &quot;decision&quot;: &quot;What was decided (one sentence)&quot;,
  &quot;context&quot;: &quot;Why was this being discussed&quot;,
  &quot;rationale&quot;: &quot;Why was this choice made&quot;,
  &quot;alternatives&quot;: [
    {{
      &quot;option&quot;: &quot;Alternative that was considered&quot;,
      &quot;pros&quot;: [&quot;advantage 1&quot;, &quot;advantage 2&quot;],
      &quot;cons&quot;: [&quot;disadvantage 1&quot;],
      &quot;why_not_chosen&quot;: &quot;Reason not selected&quot;
    }}
  ],
  &quot;trade_offs&quot;: {{
    &quot;pros&quot;: [&quot;advantage of chosen option&quot;],
    &quot;cons&quot;: [&quot;disadvantage of chosen option&quot;],
    &quot;risks&quot;: [&quot;potential risks&quot;],
    &quot;assumptions&quot;: [&quot;assumptions made&quot;]
  }},
  &quot;stakeholders&quot;: [&quot;@person1&quot;, &quot;@person2&quot;],
  &quot;decision_maker&quot;: &quot;@person or null&quot;,
  &quot;tags&quot;: [&quot;technology&quot;, &quot;domain&quot;]
}}

Be specific and extract actual information from the conversation.
&quot;&quot;&quot;
    
    async def _enrich_decision(
        self,
        decision: Decision,
        context: list[dict[str, Any]]
    ) -&gt; Decision:
        &quot;&quot;&quot;Enrich decision with additional context.&quot;&quot;&quot;
        
        # Extract stakeholders from conversation
        decision.stakeholders = self._extract_stakeholders(context)
        
        # Extract related code/files mentioned
        decision.related_code = self._extract_file_mentions(context)
        
        # Generate keywords for search
        decision.keywords = await self._generate_keywords(decision)
        
        return decision
    
    def _extract_file_mentions(
        self,
        context: list[dict[str, Any]]
    ) -&gt; list[str]:
        &quot;&quot;&quot;Extract file paths mentioned in conversation.&quot;&quot;&quot;
        import re
        
        file_pattern = r&#039;([a-zA-Z0-9_/.-]+\.(py|js|ts|go|java|rb|rs|md))&#039;
        
        files = set()
        for msg in context:
            content = msg.get(&quot;content&quot;, &quot;&quot;)
            matches = re.findall(file_pattern, content)
            files.update(match[0] for match in matches)
        
        return list(files)</code></pre>
        </div>
        <p>#### 3. Decision Index</p>
        <p>Searchable decision storage:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class DecisionIndex:
    &quot;&quot;&quot;Searchable index of decisions.&quot;&quot;&quot;
    
    def __init__(
        self,
        storage_path: Path,
        enable_embeddings: bool = True
    ):
        self.storage_path = storage_path
        self.db = self._init_database()
        self.embeddings = EmbeddingIndex() if enable_embeddings else None
    
    def _init_database(self) -&gt; sqlite3.Connection:
        &quot;&quot;&quot;Initialize SQLite database for decisions.&quot;&quot;&quot;
        
        conn = sqlite3.connect(self.storage_path / &quot;decisions.db&quot;)
        
        conn.execute(&quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS decisions (
                id TEXT PRIMARY KEY,
                timestamp DATETIME,
                session_id TEXT,
                decision TEXT,
                context TEXT,
                rationale TEXT,
                alternatives JSON,
                trade_offs JSON,
                stakeholders JSON,
                decision_maker TEXT,
                related_code JSON,
                related_features JSON,
                status TEXT,
                superseded_by TEXT,
                supersedes TEXT,
                tags JSON,
                keywords JSON
            )
        &quot;&quot;&quot;)
        
        conn.execute(&quot;&quot;&quot;
            CREATE VIRTUAL TABLE IF NOT EXISTS decisions_fts
            USING fts5(decision, context, rationale, content=&#039;decisions&#039;)
        &quot;&quot;&quot;)
        
        return conn
    
    async def store(self, decision: Decision):
        &quot;&quot;&quot;Store decision in index.&quot;&quot;&quot;
        
        # Store in SQLite
        self.db.execute(&quot;&quot;&quot;
            INSERT INTO decisions VALUES (
                :id, :timestamp, :session_id, :decision, :context,
                :rationale, :alternatives, :trade_offs, :stakeholders,
                :decision_maker, :related_code, :related_features,
                :status, :superseded_by, :supersedes, :tags, :keywords
            )
        &quot;&quot;&quot;, self._decision_to_dict(decision))
        
        # Store in FTS
        self.db.execute(&quot;&quot;&quot;
            INSERT INTO decisions_fts (rowid, decision, context, rationale)
            SELECT rowid, decision, context, rationale FROM decisions
            WHERE id = ?
        &quot;&quot;&quot;, (decision.id,))
        
        self.db.commit()
        
        # Store embedding for semantic search
        if self.embeddings:
            text = f&quot;{decision.decision} {decision.context} {decision.rationale}&quot;
            await self.embeddings.add(decision.id, text)
    
    async def search(
        self,
        query: str,
        filters: DecisionFilters | None = None,
        limit: int = 10
    ) -&gt; list[Decision]:
        &quot;&quot;&quot;
        Search decisions.
        
        Search strategies:
        1. Semantic search (if embeddings enabled)
        2. Full-text search (SQLite FTS)
        3. Filtered search (by tags, dates, stakeholders)
        &quot;&quot;&quot;
        
        results = []
        
        # Semantic search
        if self.embeddings:
            semantic_results = await self.embeddings.search(query, k=limit)
            results.extend(semantic_results)
        
        # Full-text search
        fts_results = self.db.execute(&quot;&quot;&quot;
            SELECT id FROM decisions_fts
            WHERE decisions_fts MATCH ?
            LIMIT ?
        &quot;&quot;&quot;, (query, limit)).fetchall()
        
        # Deduplicate and load full decisions
        decision_ids = list(set(
            r[0] for r in fts_results
        ) | set(r.id for r in results))
        
        decisions = [
            self._load_decision(did)
            for did in decision_ids[:limit]
        ]
        
        # Apply filters
        if filters:
            decisions = self._apply_filters(decisions, filters)
        
        return decisions
    
    async def get_chain(self, decision_id: str) -&gt; DecisionChain:
        &quot;&quot;&quot;Get decision evolution chain.&quot;&quot;&quot;
        
        decision = self._load_decision(decision_id)
        
        # Find all related decisions
        revisions = []
        current = decision
        
        # Walk forward (superseded by)
        while current.superseded_by:
            next_decision = self._load_decision(current.superseded_by)
            revisions.append(next_decision)
            current = next_decision
        
        # Walk backward (supersedes)
        original = decision
        while original.supersedes:
            prev_decision = self._load_decision(original.supersedes)
            original = prev_decision
        
        return DecisionChain(
            original=original,
            revisions=revisions,
            current=current
        )</code></pre>
        </div>
        <p>#### 4. Temporal Tracker</p>
        <p>Tracks decision evolution:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class TemporalTracker:
    &quot;&quot;&quot;Tracks how decisions evolve over time.&quot;&quot;&quot;
    
    async def link_superseding_decision(
        self,
        old_decision_id: str,
        new_decision_id: str,
        reason: str
    ):
        &quot;&quot;&quot;Link new decision as superseding old one.&quot;&quot;&quot;
        
        # Update old decision
        await self.index.update(old_decision_id, {
            &quot;status&quot;: DecisionStatus.SUPERSEDED,
            &quot;superseded_by&quot;: new_decision_id
        })
        
        # Update new decision
        await self.index.update(new_decision_id, {
            &quot;supersedes&quot;: old_decision_id
        })
    
    async def detect_revisited_decisions(
        self,
        current_discussion: str,
        existing_decisions: list[Decision]
    ) -&gt; list[Decision]:
        &quot;&quot;&quot;
        Detect if current discussion revisits past decisions.
        
        Uses semantic similarity to find related decisions.
        &quot;&quot;&quot;
        
        if not self.embeddings:
            return []
        
        # Semantic search for similar decisions
        similar = await self.embeddings.search(
            current_discussion,
            k=5
        )
        
        # Filter by similarity threshold
        revisited = [
            d for d in similar
            if d.similarity_score &gt; 0.7
        ]
        
        return revisited</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Conversation Message
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Decision Detector  â”‚
â”‚ - Keywords match?  â”‚
â”‚ - LLM confirms?    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ (Decision detected)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Metadata Extractor â”‚
â”‚ - What decided?    â”‚
â”‚ - Why?             â”‚
â”‚ - Alternatives?    â”‚
â”‚ - Stakeholders?    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Code Linker        â”‚
â”‚ - Extract files    â”‚
â”‚ - Link features    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Decision Index     â”‚
â”‚ - SQLite storage   â”‚
â”‚ - FTS index        â”‚
â”‚ - Embedding index  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Later Query:
&quot;Why did we choose X?&quot;
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Search Engine      â”‚
â”‚ - Semantic search  â”‚
â”‚ - FTS search       â”‚
â”‚ - Filter results   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   Decision(s)
   with full context</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Decision Detection and Extraction</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Conversation
User: &quot;Should we use REST or GraphQL for the new API?&quot;
Agent: &quot;Let&#039;s evaluate both options...&quot;
[10 messages discussing trade-offs]
User: &quot;Based on this, I think we should go with REST for now.&quot;
Agent: &quot;Agreed. REST gives us simplicity and we can add GraphQL later if needed.&quot;

# Decision Detection
Message: &quot;Agreed. REST gives us simplicity...&quot;
Keywords matched: [&quot;Agreed&quot;]
LLM confirmation: 0.92 (high confidence)
â†’ Decision detected!

# Metadata Extraction
Decision extracted:
{
  &quot;id&quot;: &quot;dec-789&quot;,
  &quot;timestamp&quot;: &quot;2024-03-15T14:30:00Z&quot;,
  &quot;decision&quot;: &quot;Use REST API instead of GraphQL for new API&quot;,
  &quot;context&quot;: &quot;Choosing API architecture for new service&quot;,
  &quot;rationale&quot;: &quot;Team has REST expertise, simpler to implement, client needs are straightforward. Can add GraphQL later if requirements change.&quot;,
  &quot;alternatives&quot;: [
    {
      &quot;option&quot;: &quot;GraphQL&quot;,
      &quot;pros&quot;: [&quot;Flexible queries&quot;, &quot;Single endpoint&quot;, &quot;Type safety&quot;],
      &quot;cons&quot;: [&quot;Learning curve&quot;, &quot;Overhead for simple queries&quot;, &quot;Caching complexity&quot;],
      &quot;why_not_chosen&quot;: &quot;Team lacks GraphQL experience, current requirements don&#039;t justify complexity&quot;
    },
    {
      &quot;option&quot;: &quot;gRPC&quot;,
      &quot;pros&quot;: [&quot;Performance&quot;, &quot;Type safety&quot;, &quot;Streaming&quot;],
      &quot;cons&quot;: [&quot;Browser support limited&quot;, &quot;Tooling not familiar&quot;],
      &quot;why_not_chosen&quot;: &quot;Primarily HTTP clients, no need for streaming yet&quot;
    }
  ],
  &quot;trade_offs&quot;: {
    &quot;pros&quot;: [&quot;Simpler implementation&quot;, &quot;Team expertise&quot;, &quot;Easier caching&quot;],
    &quot;cons&quot;: [&quot;Over-fetching&quot;, &quot;Multiple round-trips for complex queries&quot;],
    &quot;risks&quot;: [&quot;May need to migrate to GraphQL later if requirements change&quot;],
    &quot;assumptions&quot;: [&quot;Client needs remain simple&quot;, &quot;Performance acceptable with caching&quot;]
  },
  &quot;stakeholders&quot;: [&quot;@alice (architect)&quot;, &quot;@bob (tech lead)&quot;, &quot;@carol (PM)&quot;],
  &quot;decision_maker&quot;: &quot;@alice&quot;,
  &quot;related_code&quot;: [&quot;src/api/routes/&quot;, &quot;docs/api-design.md&quot;],
  &quot;tags&quot;: [&quot;architecture&quot;, &quot;api&quot;, &quot;rest&quot;, &quot;graphql&quot;],
  &quot;status&quot;: &quot;active&quot;
}

# Indexed and searchable</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Decision Search</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Query (6 months later)
New engineer: &quot;Why aren&#039;t we using GraphQL?&quot;

# Search
search_decisions(&quot;GraphQL&quot;)

# Results
[
  {
    &quot;id&quot;: &quot;dec-789&quot;,
    &quot;decision&quot;: &quot;Use REST API instead of GraphQL&quot;,
    &quot;context&quot;: &quot;Choosing API architecture for new service&quot;,
    &quot;rationale&quot;: &quot;Team has REST expertise, simpler to implement...&quot;,
    &quot;timestamp&quot;: &quot;2024-03-15&quot;,
    &quot;stakeholders&quot;: [&quot;@alice&quot;, &quot;@bob&quot;, &quot;@carol&quot;],
    &quot;status&quot;: &quot;active&quot;
  }
]

# Agent Response
&quot;We decided on REST in March 2024. Here&#039;s the full context:

**Decision**: Use REST API instead of GraphQL

**Made by**: @alice (architect), with @bob and @carol

**Rationale**: 
- Team had REST expertise (faster to ship)
- Client needs were simple (no complex queries needed)
- Could revisit later if requirements change

**Alternatives Considered**:
- GraphQL: Flexible but steeper learning curve
- gRPC: High performance but limited browser support

**Current Status**: Active (6 months old)

**Related Code**: src/api/routes/, docs/api-design.md

**Should we revisit?** 
Current context suggests:
- We now have 15 endpoints (growing complexity)
- Mobile team requesting flexible queries
- GraphQL expertise improved (new hires)

Consider scheduling a review meeting to reassess.&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 3: Decision Chain</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Original decision (March 2024)
Decision: &quot;Use PostgreSQL for primary database&quot;
Rationale: &quot;ACID guarantees, team expertise&quot;

# Revisited (September 2024)
Discussion: &quot;Should we migrate to DynamoDB for better scale?&quot;
[Discussion happens]
Decision: &quot;Keep PostgreSQL, add Redis for caching&quot;
Supersedes: dec-123 (partial revision)

# Query decision chain
get_decision_chain(&quot;dec-123&quot;)

# Returns
{
  &quot;original&quot;: {
    &quot;decision&quot;: &quot;Use PostgreSQL&quot;,
    &quot;timestamp&quot;: &quot;2024-03-15&quot;,
    &quot;status&quot;: &quot;revisited&quot;
  },
  &quot;revisions&quot;: [
    {
      &quot;decision&quot;: &quot;Keep PostgreSQL, add Redis for caching&quot;,
      &quot;timestamp&quot;: &quot;2024-09-20&quot;,
      &quot;rationale&quot;: &quot;Scaling issues addressed with caching, migration cost not justified&quot;,
      &quot;supersedes&quot;: &quot;dec-123&quot;
    }
  ],
  &quot;current&quot;: { /* latest decision */ }
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Full configuration example
contexts:
  - module: context-decision-journal
    config:
      # Detection
      auto_detect: true
      detection_keywords:
        - decided
        - decision:
        - &quot;let&#039;s go with&quot;
        - we should
        - agreed
        - consensus
      detection_threshold: 0.7
      llm_confirmation: true            # Use LLM to confirm
      
      # Extraction
      structured_extraction: true
      extract_rationale: true
      extract_alternatives: true
      extract_trade_offs: true
      extract_stakeholders: true
      
      # Linking
      link_to_code: true
      link_to_features: true
      auto_link_strategy: file_mention  # Look for file mentions
      
      # Indexing
      search_index: sqlite
      index_embeddings: true
      embedding_model: text-embedding-3-small
      enable_fts: true                  # Full-text search
      
      # Storage
      persistence: true
      storage_path: .amplifier/decisions/
      retention_days: 730               # 2 years
      
      # Querying
      enable_temporal_queries: true
      enable_stakeholder_queries: true
      enable_technology_queries: true
      
      # Evolution tracking
      track_superseded_decisions: true
      detect_revisited_decisions: true</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Storage</h4>
        <li><strong>Persistence</strong>: Decisions stored on disk (configurable retention)</li>
        <li><strong>Sensitive decisions</strong>: May contain confidential information</li>
        <li><strong>Access control</strong>: Decisions inherit session permissions</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Privacy</h4>
        <li><strong>Stakeholder attribution</strong>: Names extracted from conversations</li>
        <li><strong>Code links</strong>: File paths exposed in decisions</li>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;context:read&quot;,
    &quot;context:write&quot;,
    &quot;filesystem:read&quot;,              # For storage
]</code></pre>
        </div>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_decision_detector_detects_keywords():
    detector = DecisionDetector()
    message = {&quot;content&quot;: &quot;We&#039;ve decided to use PostgreSQL&quot;}
    result = detector.detect(message, [])
    assert result.is_decision

def test_metadata_extractor_extracts_alternatives():
    extractor = MetadataExtractor()
    # Test extraction from sample conversation
    ...

def test_decision_index_search():
    index = DecisionIndex(storage_path=Path(&quot;/tmp/test&quot;))
    # Store decisions
    # Search and verify results
    ...</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_full_decision_lifecycle():
    context = DecisionJournalContext(config)
    
    # Add conversation leading to decision
    await context.add_message({&quot;content&quot;: &quot;Should we use X or Y?&quot;})
    await context.add_message({&quot;content&quot;: &quot;Let&#039;s go with X&quot;})
    
    # Search for decision
    results = await context.search_decisions(&quot;use X&quot;)
    assert len(results) == 1
    assert &quot;X&quot; in results[0].decision</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>amplifier-core</code></li>
        <li><code>sqlite3</code> (stdlib)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>openai</code> - For embeddings</li>
        <li><code>tiktoken</code> - Token counting</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Decision confidence</strong>: Should we track confidence/certainty of decisions?</li>
        <li><strong>Decision categories</strong>: Should we categorize decisions (technical, product, design)?</li>
        <li><strong>Automatic linking</strong>: How aggressive should automatic code linking be?</li>
        <li><strong>Notification</strong>: Should stakeholders be notified when their decisions are superseded?</li>
        <li><strong>Export</strong>: Should decisions be exportable to Markdown/Confluence/etc.?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-context-stakeholder-lenses" data-category="contexts">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Context Stakeholder Lenses</span>
            <span class="spec-category">contexts</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-context-stakeholder-lenses</code></p>
        </div>
        <h3>Overview</h3>
        <p>A context manager that filters and shapes conversation context based on stakeholder roles (PM, engineering, design, security, etc.). Each role sees a tailored view of the conversation with relevant information emphasized and irrelevant details filtered out, while maintaining the ability to reference cross-lens information when needed.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Everyone sees all technical details</td><td>PM sees business context, engineers see code, designers see UX</td></tr>
            <tr><td>Wading through irrelevant information</td><td>Role-specific context filtering</td></tr>
            <tr><td>One-size-fits-all responses</td><td>Responses tailored to stakeholder needs</td></tr>
            <tr><td>Context window filled with noise</td><td>Efficient token usage per role</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Cross-functional reviews</strong>: PM, eng, and design review same feature with different context</li>
        <li><strong>Team collaboration</strong>: Each team member gets relevant context for their role</li>
        <li><strong>Onboarding</strong>: New PMs see business context, new engineers see architecture</li>
        <li><strong>Documentation</strong>: Generate role-specific documentation from conversations</li>
        <li><strong>Meeting summaries</strong>: Different summaries for technical and non-technical stakeholders</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">ContextManager Interface</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class StakeholderLensesContext:
    &quot;&quot;&quot;
    Context manager with role-based filtering.
    
    Each stakeholder lens:
    - Filters messages by relevance to role
    - Emphasizes role-specific information
    - Hides low-relevance details
    - Maintains references to other lenses
    &quot;&quot;&quot;
    
    async def add_message(
        self, 
        message: dict[str, Any],
        metadata: MessageMetadata | None = None
    ) -&gt; None:
        &quot;&quot;&quot;
        Add message to context.
        
        Args:
            message: Standard Anthropic message format
            metadata: Optional metadata (tags, relevance scores per role)
        &quot;&quot;&quot;
    
    async def get_messages(
        self,
        role: str | None = None,
        max_tokens: int | None = None
    ) -&gt; list[dict[str, Any]]:
        &quot;&quot;&quot;
        Get messages for specific role lens.
        
        Args:
            role: Role to filter for (None = base context)
            max_tokens: Optional token limit
            
        Returns:
            Filtered message list for role
        &quot;&quot;&quot;
    
    async def set_active_role(self, role: str):
        &quot;&quot;&quot;Set the active stakeholder role for filtering.&quot;&quot;&quot;
    
    async def get_cross_lens_reference(
        self,
        message_id: str,
        source_role: str
    ) -&gt; dict[str, Any]:
        &quot;&quot;&quot;Retrieve message from another role&#039;s lens.&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Configuration Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">toml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-toml">[[contexts]]
module = &quot;context-stakeholder-lenses&quot;
config = {
  # Role definitions
  lenses = [
    {
      role = &quot;product&quot;,
      includes = [&quot;business&quot;, &quot;user_feedback&quot;, &quot;roadmap&quot;, &quot;metrics&quot;, &quot;decisions&quot;],
      excludes = [&quot;implementation_details&quot;, &quot;code_snippets&quot;, &quot;technical_architecture&quot;],
      weight = 1.0,
      emoji = &quot;ðŸ“Š&quot;
    },
    {
      role = &quot;engineering&quot;,
      includes = [&quot;architecture&quot;, &quot;tech_debt&quot;, &quot;performance&quot;, &quot;code&quot;, &quot;dependencies&quot;],
      excludes = [&quot;marketing_copy&quot;, &quot;design_tokens&quot;, &quot;brand_guidelines&quot;],
      weight = 1.0,
      emoji = &quot;âš™ï¸&quot;
    },
    {
      role = &quot;design&quot;,
      includes = [&quot;ux&quot;, &quot;accessibility&quot;, &quot;design_system&quot;, &quot;brand&quot;, &quot;user_research&quot;],
      excludes = [&quot;database_schemas&quot;, &quot;api_contracts&quot;, &quot;infrastructure&quot;],
      weight = 1.0,
      emoji = &quot;ðŸŽ¨&quot;
    },
    {
      role = &quot;security&quot;,
      includes = [&quot;security&quot;, &quot;compliance&quot;, &quot;authentication&quot;, &quot;data_protection&quot;],
      excludes = [&quot;ui_details&quot;, &quot;design_tokens&quot;],
      weight = 1.2,
      emoji = &quot;ðŸ”’&quot;
    }
  ]
  
  # Filtering strategy
  filtering_strategy = &quot;relevance_score&quot;  # &quot;relevance_score&quot; | &quot;tag_based&quot; | &quot;hybrid&quot;
  min_relevance_threshold = 0.3           # Messages below this are filtered
  
  # Cross-lens references
  allow_cross_lens_references = true
  cross_lens_reference_format = &quot;summary&quot;  # &quot;summary&quot; | &quot;full&quot; | &quot;link&quot;
  
  # Compaction
  compaction_strategy = &quot;per_lens&quot;        # Compact each lens independently
  preserve_shared_decisions = true        # Important decisions visible to all lenses
  
  # Auto-tagging
  auto_tag_messages = true                # Use LLM to tag messages with topics
  auto_score_relevance = true             # Calculate relevance scores per role
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class MessageMetadata:
    &quot;&quot;&quot;Metadata for context messages.&quot;&quot;&quot;
    tags: list[str]                      # [&quot;business&quot;, &quot;technical&quot;, &quot;design&quot;]
    relevance_scores: dict[str, float]   # {role: score} - 0.0 to 1.0
    importance: str                      # &quot;critical&quot; | &quot;high&quot; | &quot;medium&quot; | &quot;low&quot;
    is_decision: bool                    # Shared decisions visible to all lenses
    
@dataclass
class LensDefinition:
    role: str                            # Role identifier
    includes: list[str]                  # Topics to include
    excludes: list[str]                  # Topics to exclude
    weight: float                        # Importance weight
    emoji: str                           # Visual identifier
    
@dataclass
class FilteredMessage:
    message: dict[str, Any]              # Original message
    relevance_score: float               # Relevance to current lens
    filtered_content: str | None         # Optional filtered version
    summary: str | None                  # Optional summary for low-relevance</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>context:lens:activated</code></td><td>Lens switched</td><td>role, previous_role</td></tr>
            <tr><td><code>context:message:tagged</code></td><td>Message auto-tagged</td><td>message_id, tags</td></tr>
            <tr><td><code>context:message:filtered</code></td><td>Message filtered</td><td>message_id, role, reason</td></tr>
            <tr><td><code>context:cross_lens:accessed</code></td><td>Cross-lens reference</td><td>target_role, message_id</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              context-stakeholder-lenses                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Message   â”‚â”€â”€â”€â–¶â”‚   Relevance  â”‚â”€â”€â”€â–¶â”‚    Lens       â”‚   â”‚
â”‚  â”‚   Storage   â”‚    â”‚   Scorer     â”‚    â”‚   Filter      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                        â”‚           â”‚
â”‚         â”‚                                        â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Auto      â”‚    â”‚  Cross-Lens  â”‚    â”‚  Compaction   â”‚   â”‚
â”‚  â”‚   Tagger    â”‚    â”‚  References  â”‚    â”‚   Engine      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Storage Structure:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Base Storage                   â”‚
â”‚ - All messages                 â”‚
â”‚ - Metadata per message         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼           â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Product â”‚ â”‚ Eng    â”‚ â”‚Design  â”‚ â”‚Securityâ”‚
â”‚Lens    â”‚ â”‚Lens    â”‚ â”‚Lens    â”‚ â”‚Lens    â”‚
â”‚View    â”‚ â”‚View    â”‚ â”‚View    â”‚ â”‚View    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 Filtered   Filtered   Filtered   Filtered</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Message Storage</p>
        <p>Central storage with metadata:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class MessageStorage:
    &quot;&quot;&quot;Stores all messages with metadata.&quot;&quot;&quot;
    
    def __init__(self):
        self.messages: list[StoredMessage] = []
        self.message_index: dict[str, StoredMessage] = {}
    
    async def store(self, message: dict[str, Any], metadata: MessageMetadata) -&gt; str:
        &quot;&quot;&quot;Store message with metadata.&quot;&quot;&quot;
        message_id = str(uuid.uuid4())
        
        stored = StoredMessage(
            id=message_id,
            message=message,
            metadata=metadata,
            timestamp=datetime.now()
        )
        
        self.messages.append(stored)
        self.message_index[message_id] = stored
        
        return message_id
    
    async def get_all(self) -&gt; list[StoredMessage]:
        &quot;&quot;&quot;Get all messages (base view).&quot;&quot;&quot;
        return self.messages.copy()
    
    async def get_by_id(self, message_id: str) -&gt; StoredMessage | None:
        &quot;&quot;&quot;Get specific message by ID.&quot;&quot;&quot;
        return self.message_index.get(message_id)</code></pre>
        </div>
        <p>#### 2. Relevance Scorer</p>
        <p>Calculates relevance per role:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class RelevanceScorer:
    &quot;&quot;&quot;Calculates message relevance per role.&quot;&quot;&quot;
    
    def __init__(self, lenses: list[LensDefinition]):
        self.lenses = {lens.role: lens for lens in lenses}
    
    async def score_message(
        self,
        message: dict[str, Any],
        tags: list[str]
    ) -&gt; dict[str, float]:
        &quot;&quot;&quot;
        Calculate relevance score per role.
        
        Scoring:
        1. Check includes: +1.0 per matching tag
        2. Check excludes: -1.0 per matching tag
        3. Normalize to 0.0-1.0 range
        &quot;&quot;&quot;
        scores = {}
        
        for role, lens in self.lenses.items():
            score = 0.0
            
            # Positive signal from includes
            included_tags = set(tags) &amp; set(lens.includes)
            score += len(included_tags)
            
            # Negative signal from excludes
            excluded_tags = set(tags) &amp; set(lens.excludes)
            score -= len(excluded_tags)
            
            # Normalize (assume max 10 tags)
            normalized = max(0.0, min(1.0, (score + 5) / 10))
            
            scores[role] = normalized
        
        return scores
    
    async def score_message_with_llm(
        self,
        message: dict[str, Any],
        roles: list[str]
    ) -&gt; dict[str, float]:
        &quot;&quot;&quot;
        Use LLM to score relevance (more accurate but slower).
        
        Asks LLM: &quot;On a scale of 0-10, how relevant is this message
        to a [role] stakeholder?&quot;
        &quot;&quot;&quot;
        prompt = f&quot;&quot;&quot;
Score this message&#039;s relevance to each role (0-10):

Message: {message[&#039;content&#039;][:500]}

Roles: {&#039;, &#039;.join(roles)}

Output as JSON: {{&quot;role&quot;: score, ...}}
&quot;&quot;&quot;
        # Call LLM and parse scores
        ...</code></pre>
        </div>
        <p>#### 3. Lens Filter</p>
        <p>Filters messages for specific role:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class LensFilter:
    &quot;&quot;&quot;Filters messages for specific stakeholder lens.&quot;&quot;&quot;
    
    def __init__(
        self, 
        lens: LensDefinition,
        min_relevance: float = 0.3
    ):
        self.lens = lens
        self.min_relevance = min_relevance
    
    async def filter_messages(
        self,
        messages: list[StoredMessage]
    ) -&gt; list[FilteredMessage]:
        &quot;&quot;&quot;
        Filter messages for this lens.
        
        Rules:
        1. Always include messages with is_decision=True
        2. Include messages with relevance &gt;= threshold
        3. Summarize borderline messages (0.2-0.3 relevance)
        4. Exclude low-relevance messages (&lt; 0.2)
        &quot;&quot;&quot;
        filtered = []
        
        for stored in messages:
            relevance = stored.metadata.relevance_scores.get(self.lens.role, 0.0)
            
            # Always include decisions
            if stored.metadata.is_decision:
                filtered.append(FilteredMessage(
                    message=stored.message,
                    relevance_score=1.0,
                    filtered_content=None,
                    summary=None
                ))
                continue
            
            # High relevance - include fully
            if relevance &gt;= self.min_relevance:
                filtered.append(FilteredMessage(
                    message=stored.message,
                    relevance_score=relevance,
                    filtered_content=None,
                    summary=None
                ))
            
            # Borderline - include as summary
            elif relevance &gt;= (self.min_relevance - 0.1):
                summary = await self._summarize_for_lens(stored.message)
                filtered.append(FilteredMessage(
                    message=stored.message,
                    relevance_score=relevance,
                    filtered_content=None,
                    summary=summary
                ))
            
            # Low relevance - exclude
            # (but keep reference for cross-lens lookups)
        
        return filtered
    
    async def _summarize_for_lens(self, message: dict[str, Any]) -&gt; str:
        &quot;&quot;&quot;Create brief summary for borderline messages.&quot;&quot;&quot;
        content = message.get(&quot;content&quot;, &quot;&quot;)
        
        # Simple truncation or LLM-based summarization
        if len(content) &lt; 100:
            return content
        
        # LLM summarization
        prompt = f&quot;&quot;&quot;
Summarize this message in one sentence for a {self.lens.role} stakeholder:

{content}

One-sentence summary:
&quot;&quot;&quot;
        # Returns brief summary
        ...</code></pre>
        </div>
        <p>#### 4. Auto-Tagger</p>
        <p>Automatically tags messages:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class AutoTagger:
    &quot;&quot;&quot;Automatically tags messages with topic categories.&quot;&quot;&quot;
    
    KEYWORD_MAP = {
        &quot;business&quot;: [&quot;revenue&quot;, &quot;market&quot;, &quot;user&quot;, &quot;customer&quot;, &quot;roadmap&quot;],
        &quot;technical&quot;: [&quot;code&quot;, &quot;architecture&quot;, &quot;database&quot;, &quot;api&quot;, &quot;performance&quot;],
        &quot;design&quot;: [&quot;ux&quot;, &quot;ui&quot;, &quot;component&quot;, &quot;design system&quot;, &quot;accessibility&quot;],
        &quot;security&quot;: [&quot;auth&quot;, &quot;security&quot;, &quot;encryption&quot;, &quot;vulnerability&quot;, &quot;compliance&quot;],
        # ... more mappings
    }
    
    async def tag_message(self, message: dict[str, Any]) -&gt; list[str]:
        &quot;&quot;&quot;
        Auto-tag message with topic categories.
        
        Strategy:
        1. Keyword matching (fast, simple)
        2. LLM tagging (accurate, slower) - optional
        &quot;&quot;&quot;
        content = message.get(&quot;content&quot;, &quot;&quot;).lower()
        tags = set()
        
        # Keyword matching
        for category, keywords in self.KEYWORD_MAP.items():
            if any(keyword in content for keyword in keywords):
                tags.add(category)
        
        # Optional: LLM enhancement
        if self.use_llm_tagging and len(tags) &lt; 2:
            llm_tags = await self._llm_tag(message)
            tags.update(llm_tags)
        
        return list(tags)
    
    async def _llm_tag(self, message: dict[str, Any]) -&gt; list[str]:
        &quot;&quot;&quot;Use LLM to tag message.&quot;&quot;&quot;
        prompt = f&quot;&quot;&quot;
Categorize this message with relevant tags:

{message[&#039;content&#039;][:500]}

Available categories: business, technical, design, security, product, 
infrastructure, compliance, user_research, marketing

Tags (comma-separated):
&quot;&quot;&quot;
        # Returns tags
        ...</code></pre>
        </div>
        <p>#### 5. Cross-Lens References</p>
        <p>Enable viewing other lenses:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class CrossLensReference:
    &quot;&quot;&quot;Handle cross-lens references.&quot;&quot;&quot;
    
    def __init__(self, storage: MessageStorage):
        self.storage = storage
    
    async def get_reference(
        self,
        message_id: str,
        target_lens: str,
        format: str = &quot;summary&quot;
    ) -&gt; dict[str, Any]:
        &quot;&quot;&quot;
        Get message from another lens&#039;s perspective.
        
        Formats:
        - &quot;summary&quot;: Brief summary
        - &quot;full&quot;: Complete message
        - &quot;link&quot;: Reference pointer
        &quot;&quot;&quot;
        stored = await self.storage.get_by_id(message_id)
        if not stored:
            return None
        
        if format == &quot;summary&quot;:
            return {
                &quot;type&quot;: &quot;cross_lens_reference&quot;,
                &quot;source_lens&quot;: target_lens,
                &quot;message_id&quot;: message_id,
                &quot;summary&quot;: f&quot;[From {target_lens}] {stored.message[&#039;content&#039;][:100]}...&quot;
            }
        elif format == &quot;full&quot;:
            return {
                &quot;type&quot;: &quot;cross_lens_reference&quot;,
                &quot;source_lens&quot;: target_lens,
                &quot;message&quot;: stored.message
            }
        else:  # link
            return {
                &quot;type&quot;: &quot;cross_lens_reference&quot;,
                &quot;source_lens&quot;: target_lens,
                &quot;message_id&quot;: message_id,
                &quot;reference&quot;: f&quot;See {target_lens} lens for details&quot;
            }</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Message Added
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Auto-Tag Message    â”‚
â”‚ tags: [&quot;technical&quot;, â”‚
â”‚        &quot;architecture&quot;]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Score Relevance     â”‚
â”‚ product: 0.2        â”‚
â”‚ engineering: 0.9    â”‚
â”‚ design: 0.3         â”‚
â”‚ security: 0.4       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store with Metadata â”‚
â”‚ (central storage)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼             â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Product  â”‚  â”‚Engineer â”‚ â”‚Design  â”‚ â”‚Securityâ”‚
â”‚Lens     â”‚  â”‚Lens     â”‚ â”‚Lens    â”‚ â”‚Lens    â”‚
â”‚         â”‚  â”‚         â”‚ â”‚        â”‚ â”‚        â”‚
â”‚Score:0.2â”‚  â”‚Score:0.9â”‚ â”‚Score:  â”‚ â”‚Score:  â”‚
â”‚â†’Exclude â”‚  â”‚â†’Include â”‚ â”‚0.3     â”‚ â”‚0.4     â”‚
â”‚         â”‚  â”‚ (full)  â”‚ â”‚â†’Summaryâ”‚ â”‚â†’Includeâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Feature Discussion</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Message 1: Feature request
User (PM): &quot;We need PDF export. Users requested it 247 times.&quot;

Auto-tags: [&quot;business&quot;, &quot;user_feedback&quot;, &quot;product&quot;]
Relevance scores:
  product: 0.95 (user feedback, feature request)
  engineering: 0.60 (feature to build)
  design: 0.40 (UI needed)
  security: 0.20 (low relevance)

Product Lens: âœ“ Include (high relevance)
Engineering Lens: âœ“ Include (moderate relevance)
Design Lens: âœ“ Include as summary
Security Lens: âœ— Exclude (below threshold)

# Message 2: Technical implementation
Developer: &quot;We&#039;ll use Puppeteer for rendering. Need 200MB Docker image...&quot;

Auto-tags: [&quot;technical&quot;, &quot;implementation&quot;, &quot;infrastructure&quot;]
Relevance scores:
  product: 0.20 (implementation detail)
  engineering: 1.00 (technical detail)
  design: 0.30 (affects design delivery)
  security: 0.50 (Docker image security)

Product Lens: âœ— Exclude (technical detail)
Engineering Lens: âœ“ Include (highly relevant)
Design Lens: âœ“ Include as summary (&quot;Implementation uses Puppeteer&quot;)
Security Lens: âœ“ Include (Docker security relevant)

# Message 3: Design concern
Designer: &quot;Export modal needs format picker (PDF, PNG, SVG)&quot;

Auto-tags: [&quot;design&quot;, &quot;ux&quot;, &quot;component&quot;]
Relevance scores:
  product: 0.60 (feature scope)
  engineering: 0.50 (interface to implement)
  design: 1.00 (design specification)
  security: 0.10 (low relevance)

Product Lens: âœ“ Include (affects feature scope)
Engineering Lens: âœ“ Include (needs implementation)
Design Lens: âœ“ Include (full detail)
Security Lens: âœ— Exclude

# Message 4: DECISION
Team: &quot;DECISION: Build PDF export in Q2 with security review&quot;

Metadata: is_decision=True
Relevance scores: N/A (always included)

All Lenses: âœ“ Include (decisions visible to all)

# Context retrieval examples

## Product Manager perspective
get_messages(role=&quot;product&quot;) returns:
1. &quot;We need PDF export. Users requested it 247 times.&quot;
2. (Summary) &quot;Export modal needs format picker&quot;
3. &quot;DECISION: Build PDF export in Q2 with security review&quot;

## Engineering perspective
get_messages(role=&quot;engineering&quot;) returns:
1. &quot;We need PDF export. Users requested it 247 times.&quot;
2. &quot;We&#039;ll use Puppeteer for rendering. Need 200MB Docker image...&quot;
3. &quot;Export modal needs format picker (PDF, PNG, SVG)&quot;
4. &quot;DECISION: Build PDF export in Q2 with security review&quot;

## Design perspective
get_messages(role=&quot;design&quot;) returns:
1. (Summary) &quot;PDF export requested by users&quot;
2. (Summary) &quot;Implementation uses Puppeteer&quot;
3. &quot;Export modal needs format picker (PDF, PNG, SVG)&quot;
4. &quot;DECISION: Build PDF export in Q2 with security review&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: Cross-Lens Reference</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Designer asks: &quot;What did engineering say about the timeline?&quot;
# System detects query about engineering lens

# Retrieve from engineering lens
engineering_message = await context.get_cross_lens_reference(
    message_id=&quot;msg-123&quot;,
    source_role=&quot;engineering&quot;
)

# Returns summary format
{
    &quot;type&quot;: &quot;cross_lens_reference&quot;,
    &quot;source_lens&quot;: &quot;engineering&quot;,
    &quot;summary&quot;: &quot;[From engineering] Implementation needs 12 weeks: 6 for infrastructure, 6 for feature development&quot;
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Full configuration example
contexts:
  - module: context-stakeholder-lenses
    config:
      # Lens definitions
      lenses:
        - role: product
          includes: [business, user_feedback, roadmap, metrics, decisions]
          excludes: [implementation_details, code_snippets, technical_architecture]
          weight: 1.0
          emoji: &quot;ðŸ“Š&quot;
          
        - role: engineering
          includes: [architecture, tech_debt, performance, code, dependencies]
          excludes: [marketing_copy, design_tokens, brand_guidelines]
          weight: 1.0
          emoji: &quot;âš™ï¸&quot;
          
        - role: design
          includes: [ux, accessibility, design_system, brand, user_research]
          excludes: [database_schemas, api_contracts, infrastructure]
          weight: 1.0
          emoji: &quot;ðŸŽ¨&quot;
          
        - role: security
          includes: [security, compliance, authentication, data_protection]
          excludes: [ui_details, design_tokens]
          weight: 1.2
          emoji: &quot;ðŸ”’&quot;
      
      # Filtering
      filtering_strategy: hybrid          # relevance_score | tag_based | hybrid
      min_relevance_threshold: 0.3
      summary_threshold: 0.2              # Summarize messages between 0.2-0.3
      
      # Auto-processing
      auto_tag_messages: true
      auto_score_relevance: true
      use_llm_scoring: false              # Keyword-based by default (faster)
      
      # Cross-lens
      allow_cross_lens_references: true
      cross_lens_reference_format: summary
      
      # Compaction
      compaction_strategy: per_lens
      preserve_shared_decisions: true
      max_tokens_per_lens: 150000
      
      # Base context (no lens)
      include_base_context: true          # Allow viewing unfiltered context</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Isolation</h4>
        <li><strong>Lens isolation</strong>: Each lens sees filtered view only</li>
        <li><strong>Cross-lens access</strong>: Controlled via configuration</li>
        <li><strong>Shared decisions</strong>: Flagged messages visible to all roles</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Privacy</h4>
        <li><strong>Role-based filtering</strong>: Prevents accidental exposure of sensitive info</li>
        <li><strong>Metadata privacy</strong>: Relevance scores not exposed to users</li>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;context:read&quot;,
    &quot;context:write&quot;,
]</code></pre>
        </div>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_relevance_scorer_calculates_scores():
    scorer = RelevanceScorer(lenses=[...])
    scores = scorer.score_message(
        message={&quot;content&quot;: &quot;Deploy to production&quot;},
        tags=[&quot;technical&quot;, &quot;infrastructure&quot;]
    )
    assert scores[&quot;engineering&quot;] &gt; 0.5
    assert scores[&quot;product&quot;] &lt; 0.5

def test_lens_filter_excludes_low_relevance():
    filter = LensFilter(lens=product_lens, min_relevance=0.3)
    messages = [
        StoredMessage(metadata=MessageMetadata(relevance_scores={&quot;product&quot;: 0.9})),
        StoredMessage(metadata=MessageMetadata(relevance_scores={&quot;product&quot;: 0.1}))
    ]
    filtered = filter.filter_messages(messages)
    assert len(filtered) == 1  # Only high-relevance included</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_full_lens_filtering():
    context = StakeholderLensesContext(config)
    
    # Add messages
    await context.add_message({&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;User wants feature X&quot;})
    await context.add_message({&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;Technical: Use database Y&quot;})
    
    # Product lens should see first, not second
    product_messages = await context.get_messages(role=&quot;product&quot;)
    assert len(product_messages) == 1
    assert &quot;feature X&quot; in product_messages[0][&quot;content&quot;]
    
    # Engineering lens should see both
    eng_messages = await context.get_messages(role=&quot;engineering&quot;)
    assert len(eng_messages) == 2</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>amplifier-core</code></li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>tiktoken</code> - Token counting per lens</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Dynamic lens creation</strong>: Should users be able to define custom lenses?</li>
        <li><strong>LLM scoring frequency</strong>: Always use LLM or only for ambiguous messages?</li>
        <li><strong>Lens switching UX</strong>: How should users switch between lenses in CLI/UI?</li>
        <li><strong>Historical lens views</strong>: Should past conversations be re-filtered when lenses change?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-orchestrator-loop-iterative-refinement" data-category="orchestrators">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Orchestrator Loop Iterative Refinement</span>
            <span class="spec-category">orchestrators</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-loop-iterative-refinement</code></p>
        </div>
        <h3>Overview</h3>
        <p>An orchestrator that manages iterative refinement workflows with structured feedback loops, version tracking, and convergence detection. Enables design sprint-style iteration where each cycle produces a versioned artifact, captures feedback, and tracks what changed and why.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual iteration tracking, lost context between versions</td><td>Automatic version tracking with delta visualization</td></tr>
            <tr><td>"What changed since last time?" requires memory</td><td>Side-by-side diffs with rationale for each change</td></tr>
            <tr><td>Feedback scattered across messages</td><td>Structured feedback correlation to specific changes</td></tr>
            <tr><td>No convergence signal</td><td>Automatic detection when iterations stabilize</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Design system component iteration</strong>: Designer reviews and refines component specs through multiple rounds</li>
        <li><strong>API design refinement</strong>: Architecture evolves based on stakeholder feedback</li>
        <li><strong>Feature specification</strong>: PM iterates on PRD with eng/design input</li>
        <li><strong>Code refactoring</strong>: Large refactors broken into reviewable iterations</li>
        <li><strong>Documentation writing</strong>: Technical docs refined with SME feedback</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Orchestrator Interface</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class IterativeRefinementOrchestrator:
    &quot;&quot;&quot;
    Orchestrator that manages iterative refinement with feedback tracking.
    
    Each iteration:
    1. Generate or refine artifact
    2. Checkpoint version
    3. Present for review (optional pause)
    4. Capture feedback
    5. Assess convergence
    6. Continue or conclude
    &quot;&quot;&quot;
    
    async def execute(
        self,
        prompt: str,
        context: ContextManager,
        providers: dict[str, Any],
        tools: dict[str, Any],
        hooks: HookRegistry,
        coordinator: ModuleCoordinator | None = None,
    ) -&gt; str:
        &quot;&quot;&quot;
        Execute iterative refinement loop.
        
        Args:
            prompt: Initial user request
            context: Conversation context
            providers: Available LLM providers
            tools: Available tools
            hooks: Hook registry for events
            coordinator: Module coordinator for capabilities
            
        Returns:
            Final refined artifact with evolution history
        &quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Configuration Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">toml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-toml">[[orchestrators]]
module = &quot;loop-iterative-refinement&quot;
config = {
  # Iteration control
  max_iterations = 10                    # Maximum refinement cycles
  min_iterations = 1                     # Minimum cycles before allowing convergence
  
  # Convergence detection
  convergence_threshold = 0.9            # 0.0-1.0: fraction of feedback addressed
  auto_converge = true                   # Stop when threshold reached
  
  # Review flow
  pause_for_review = true                # Pause between iterations for human review
  review_prompt = &quot;Review iteration {n}. Provide feedback or approve:&quot;
  
  # Version tracking
  track_deltas = true                    # Calculate and show diffs between versions
  delta_format = &quot;semantic&quot;              # &quot;semantic&quot; | &quot;line-by-line&quot; | &quot;summary&quot;
  track_rationale = true                 # Capture &quot;why&quot; for each change
  
  # Feedback correlation
  correlate_changes_to_feedback = true   # Map changes back to feedback items
  feedback_scoring = true                # Score how well each feedback was addressed
  
  # Output control
  show_evolution_history = true          # Include complete history in final output
  checkpoint_storage = &quot;memory&quot;          # &quot;memory&quot; | &quot;file&quot; | &quot;database&quot;
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>orchestrator:iteration:start</code></td><td>Iteration begins</td><td>iteration_number, total_iterations</td></tr>
            <tr><td><code>orchestrator:iteration:complete</code></td><td>Iteration done</td><td>iteration_number, artifact_id, changes_count</td></tr>
            <tr><td><code>orchestrator:review:pause</code></td><td>Paused for review</td><td>iteration_number, artifact_preview</td></tr>
            <tr><td><code>orchestrator:review:resume</code></td><td>Review complete</td><td>iteration_number, feedback_items</td></tr>
            <tr><td><code>orchestrator:convergence:detected</code></td><td>Convergence reached</td><td>convergence_score, iterations_completed</td></tr>
            <tr><td><code>orchestrator:refinement:complete</code></td><td>All iterations done</td><td>final_artifact_id, total_iterations, evolution_summary</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           orchestrator-loop-iterative-refinement                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Iteration    â”‚â”€â”€â”€â–¶â”‚    Version     â”‚â”€â”€â”€â–¶â”‚  Convergence  â”‚  â”‚
â”‚  â”‚   Controller   â”‚    â”‚    Tracker     â”‚    â”‚   Detector    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                     â”‚                    â”‚           â”‚
â”‚           â”‚                     â”‚                    â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Feedback    â”‚    â”‚     Delta      â”‚    â”‚   Evolution   â”‚  â”‚
â”‚  â”‚   Correlator   â”‚    â”‚   Calculator   â”‚    â”‚   Historian   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Iteration Controller</p>
        <p>Manages the refinement loop lifecycle:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class Iteration:
    number: int
    artifact: str                    # Current version of work
    artifact_id: str                 # UUID for this version
    feedback: list[FeedbackItem]     # Feedback to address
    changes: list[Change]            # Changes made this iteration
    timestamp: datetime
    convergence_score: float         # 0.0-1.0

@dataclass
class FeedbackItem:
    id: str
    source: str                      # &quot;user&quot; | &quot;agent&quot; | &quot;automated&quot;
    content: str
    priority: str                    # &quot;must&quot; | &quot;should&quot; | &quot;could&quot;
    addressed: bool
    iteration_addressed: int | None

@dataclass
class Change:
    description: str
    rationale: str
    addresses_feedback: list[str]    # Feedback IDs
    diff: str | None

class IterationController:
    &quot;&quot;&quot;Manages iteration lifecycle and flow control.&quot;&quot;&quot;
    
    def __init__(self, config: IterativeRefinementConfig):
        self.config = config
        self.iterations: list[Iteration] = []
        self.current_iteration = 0
    
    async def should_continue(self) -&gt; bool:
        &quot;&quot;&quot;Determine if another iteration is needed.&quot;&quot;&quot;
        if self.current_iteration &gt;= self.config.max_iterations:
            return False
        
        if self.current_iteration &lt; self.config.min_iterations:
            return True
        
        if self.config.auto_converge:
            score = await self.convergence_detector.check()
            if score &gt;= self.config.convergence_threshold:
                return False
        
        return True
    
    async def execute_iteration(self, prompt: str, context: ContextManager) -&gt; Iteration:
        &quot;&quot;&quot;Execute one refinement iteration.&quot;&quot;&quot;
        self.current_iteration += 1
        
        # Get pending feedback
        pending_feedback = self._get_pending_feedback()
        
        # Build iteration prompt
        iteration_prompt = self._build_iteration_prompt(
            iteration_num=self.current_iteration,
            base_prompt=prompt,
            feedback=pending_feedback,
            previous_artifact=self._get_latest_artifact()
        )
        
        # Execute with standard loop (delegate to loop-basic)
        result = await self._execute_standard_loop(iteration_prompt, context)
        
        # Create iteration record
        iteration = Iteration(
            number=self.current_iteration,
            artifact=result,
            artifact_id=str(uuid.uuid4()),
            feedback=pending_feedback,
            changes=[],  # Extracted in post-processing
            timestamp=datetime.now(),
            convergence_score=0.0
        )
        
        # Post-process: extract changes, calculate deltas
        iteration = await self._post_process_iteration(iteration)
        
        self.iterations.append(iteration)
        return iteration
    
    def _build_iteration_prompt(
        self, 
        iteration_num: int, 
        base_prompt: str,
        feedback: list[FeedbackItem],
        previous_artifact: str | None
    ) -&gt; str:
        &quot;&quot;&quot;Build prompt for this iteration.&quot;&quot;&quot;
        if iteration_num == 1:
            return base_prompt
        
        prompt_parts = [
            f&quot;# Iteration {iteration_num}&quot;,
            &quot;&quot;,
            &quot;## Previous Version&quot;,
            previous_artifact,
            &quot;&quot;,
            &quot;## Feedback to Address&quot;,
        ]
        
        for item in feedback:
            priority_marker = {
                &quot;must&quot;: &quot;ðŸ”´ MUST FIX&quot;,
                &quot;should&quot;: &quot;ðŸŸ¡ SHOULD FIX&quot;,
                &quot;could&quot;: &quot;ðŸŸ¢ NICE TO HAVE&quot;
            }[item.priority]
            
            prompt_parts.append(f&quot;{priority_marker}: {item.content}&quot;)
        
        prompt_parts.extend([
            &quot;&quot;,
            &quot;## Task&quot;,
            &quot;Refine the previous version based on the feedback above.&quot;,
            &quot;For each change, explain WHY you made it and which feedback it addresses.&quot;,
            &quot;&quot;,
            base_prompt
        ])
        
        return &quot;\n&quot;.join(prompt_parts)</code></pre>
        </div>
        <p>#### 2. Version Tracker</p>
        <p>Tracks artifact versions and changes:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class VersionTracker:
    &quot;&quot;&quot;Tracks versions and computes deltas between iterations.&quot;&quot;&quot;
    
    def __init__(self):
        self.versions: dict[str, str] = {}  # artifact_id -&gt; content
    
    def store_version(self, artifact_id: str, content: str):
        &quot;&quot;&quot;Store a version.&quot;&quot;&quot;
        self.versions[artifact_id] = content
    
    async def compute_delta(
        self, 
        from_artifact_id: str, 
        to_artifact_id: str,
        format: str = &quot;semantic&quot;
    ) -&gt; Delta:
        &quot;&quot;&quot;Compute changes between versions.&quot;&quot;&quot;
        from_content = self.versions[from_artifact_id]
        to_content = self.versions[to_artifact_id]
        
        if format == &quot;semantic&quot;:
            return await self._semantic_diff(from_content, to_content)
        elif format == &quot;line-by-line&quot;:
            return self._line_diff(from_content, to_content)
        else:  # summary
            return self._summary_diff(from_content, to_content)
    
    async def _semantic_diff(self, old: str, new: str) -&gt; SemanticDelta:
        &quot;&quot;&quot;Use LLM to identify semantic changes.&quot;&quot;&quot;
        # Ask LLM to identify what changed conceptually
        prompt = f&quot;&quot;&quot;
        Compare these two versions and identify semantic changes:
        
        VERSION A:
        {old}
        
        VERSION B:
        {new}
        
        List changes as: [Added|Modified|Removed] - &lt;description&gt;
        &quot;&quot;&quot;
        # Returns structured list of semantic changes
        ...
    
    def _line_diff(self, old: str, new: str) -&gt; LineDelta:
        &quot;&quot;&quot;Traditional unified diff.&quot;&quot;&quot;
        import difflib
        diff = difflib.unified_diff(
            old.splitlines(keepends=True),
            new.splitlines(keepends=True),
            lineterm=&#039;&#039;
        )
        return LineDelta(lines=list(diff))</code></pre>
        </div>
        <p>#### 3. Feedback Correlator</p>
        <p>Links changes back to feedback items:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class FeedbackCorrelator:
    &quot;&quot;&quot;Correlates changes to feedback items and scores addressing.&quot;&quot;&quot;
    
    async def correlate_changes(
        self,
        changes: list[Change],
        feedback: list[FeedbackItem]
    ) -&gt; CorrelationResult:
        &quot;&quot;&quot;
        Determine which changes address which feedback.
        Uses LLM to understand if a change addresses feedback.
        &quot;&quot;&quot;
        correlations = []
        
        for feedback_item in feedback:
            addressing_changes = []
            
            for change in changes:
                # Check if change explicitly mentions feedback
                if feedback_item.id in change.addresses_feedback:
                    addressing_changes.append(change)
                    continue
                
                # Use LLM to infer if change addresses feedback
                is_addressing = await self._infer_correlation(
                    feedback_item, 
                    change
                )
                if is_addressing:
                    addressing_changes.append(change)
            
            correlation = FeedbackCorrelation(
                feedback_item=feedback_item,
                changes=addressing_changes,
                fully_addressed=len(addressing_changes) &gt; 0,
                quality_score=self._score_addressing_quality(
                    feedback_item, 
                    addressing_changes
                )
            )
            correlations.append(correlation)
        
        return CorrelationResult(correlations=correlations)
    
    async def _infer_correlation(
        self,
        feedback: FeedbackItem,
        change: Change
    ) -&gt; bool:
        &quot;&quot;&quot;Use LLM to determine if change addresses feedback.&quot;&quot;&quot;
        prompt = f&quot;&quot;&quot;
        Feedback: {feedback.content}
        Change: {change.description} - {change.rationale}
        
        Does this change address the feedback? (yes/no)
        &quot;&quot;&quot;
        # Returns boolean
        ...
    
    def _score_addressing_quality(
        self,
        feedback: FeedbackItem,
        changes: list[Change]
    ) -&gt; float:
        &quot;&quot;&quot;Score 0.0-1.0: how well was feedback addressed.&quot;&quot;&quot;
        if not changes:
            return 0.0
        
        # Simple heuristic: more changes = better (could be LLM-based)
        return min(1.0, len(changes) * 0.5)</code></pre>
        </div>
        <p>#### 4. Convergence Detector</p>
        <p>Determines when iteration can stop:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ConvergenceDetector:
    &quot;&quot;&quot;Detects when iterations have converged.&quot;&quot;&quot;
    
    def __init__(self, threshold: float = 0.9):
        self.threshold = threshold
    
    async def check_convergence(
        self,
        iterations: list[Iteration],
        all_feedback: list[FeedbackItem]
    ) -&gt; ConvergenceScore:
        &quot;&quot;&quot;
        Check if iteration has converged.
        
        Convergence signals:
        1. High percentage of feedback addressed
        2. Small deltas between recent iterations
        3. No critical feedback outstanding
        &quot;&quot;&quot;
        if len(iterations) &lt; 2:
            return ConvergenceScore(score=0.0, reason=&quot;Too few iterations&quot;)
        
        # Signal 1: Feedback addressed
        feedback_score = self._feedback_addressed_score(all_feedback)
        
        # Signal 2: Delta shrinking
        delta_score = await self._delta_shrinking_score(iterations[-3:])
        
        # Signal 3: No blockers
        blocker_score = self._no_blockers_score(all_feedback)
        
        # Weighted average
        overall_score = (
            feedback_score * 0.5 +
            delta_score * 0.3 +
            blocker_score * 0.2
        )
        
        converged = overall_score &gt;= self.threshold
        
        return ConvergenceScore(
            score=overall_score,
            converged=converged,
            reason=self._explain_score(feedback_score, delta_score, blocker_score)
        )
    
    def _feedback_addressed_score(self, feedback: list[FeedbackItem]) -&gt; float:
        &quot;&quot;&quot;What fraction of feedback has been addressed.&quot;&quot;&quot;
        if not feedback:
            return 1.0
        
        addressed = sum(1 for f in feedback if f.addressed)
        return addressed / len(feedback)
    
    async def _delta_shrinking_score(self, recent_iterations: list[Iteration]) -&gt; float:
        &quot;&quot;&quot;Are changes getting smaller (convergence signal)?&quot;&quot;&quot;
        if len(recent_iterations) &lt; 2:
            return 0.0
        
        # Compare delta sizes (smaller = converging)
        deltas = [len(it.changes) for it in recent_iterations]
        
        # If deltas are decreasing, score high
        if all(deltas[i] &gt;= deltas[i+1] for i in range(len(deltas)-1)):
            return 1.0
        
        # Otherwise score by how small the latest delta is
        latest_delta = deltas[-1]
        return max(0.0, 1.0 - (latest_delta / 10))  # Assume 10+ changes = big delta</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">User Prompt
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Iteration 1: Create â”‚
â”‚ - Generate initial  â”‚
â”‚ - Store version v1  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Pause for   â”‚â”€â”€â”€ Optional: Wait for human review
    â”‚   Review    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ (Feedback captured)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Iteration 2: Refine â”‚
â”‚ - Apply feedback    â”‚
â”‚ - Compute delta     â”‚
â”‚ - Store version v2  â”‚
â”‚ - Correlate changes â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Check           â”‚
    â”‚ Convergence     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚       â”‚
    No   â”‚       â”‚ Yes
         â”‚       â”‚
         â–¼       â–¼
    [Continue]  [Done]
                 â”‚
                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Generate      â”‚
         â”‚ Evolution     â”‚
         â”‚ Report        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Full configuration example
orchestrators:
  - module: loop-iterative-refinement
    config:
      # Iteration control
      max_iterations: 10
      min_iterations: 1
      
      # Convergence
      convergence_threshold: 0.9
      auto_converge: true
      convergence_signals:
        - feedback_addressed
        - delta_shrinking
        - no_critical_issues
      
      # Review workflow
      pause_for_review: true
      review_prompt: |
        ## Iteration {iteration_number} Review
        
        {artifact_preview}
        
        Please provide feedback:
        - What&#039;s working well?
        - What needs improvement?
        - Any blockers or must-fix issues?
        
        Type &#039;approve&#039; when satisfied.
      
      # Version tracking
      track_deltas: true
      delta_format: semantic              # semantic | line-by-line | summary
      track_rationale: true
      store_intermediate_versions: true
      
      # Feedback management
      correlate_changes_to_feedback: true
      feedback_scoring: true
      feedback_priorities:
        must: 1.0                         # Weight for &quot;must fix&quot; feedback
        should: 0.7                       # Weight for &quot;should fix&quot;
        could: 0.3                        # Weight for &quot;nice to have&quot;
      
      # Output formatting
      show_evolution_history: true
      evolution_format: detailed          # detailed | summary | minimal
      include_all_versions: false         # Include full text of all versions
      
      # Storage
      checkpoint_storage: memory          # memory | file | database
      checkpoint_path: .amplifier/iterations/</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Design Component Iteration</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Initial prompt
&quot;Design a data table component for our design system&quot;

# Iteration 1: Initial design
Agent generates:
&quot;&quot;&quot;
# DataTable Component

## Props
- data: array of objects
- columns: column definitions
- onRowClick: callback

## Variants
- default: standard table
- compact: dense spacing
&quot;&quot;&quot;

# Pause for review
User feedback:
&quot;Needs sorting, filtering, and column resize&quot;

# Iteration 2: Add features
Agent refines:
&quot;&quot;&quot;
# DataTable Component (v2)

## Props
- data: array of objects
- columns: column definitions  
- onRowClick: callback
+ sortable: boolean
+ filterable: boolean
+ resizable: boolean

## Features
+ Sorting: Click column header to sort
+ Filtering: Filter panel above table
+ Resize: Drag column borders
&quot;&quot;&quot;

Changes:
- Added: sortable, filterable, resizable props [Addresses: &quot;needs sorting, filtering, column resize&quot;]
- Added: Sorting feature with header click [Addresses: &quot;needs sorting&quot;]
- Added: Filtering feature with filter panel [Addresses: &quot;needs filtering&quot;]
- Added: Resize feature with drag borders [Addresses: &quot;needs column resize&quot;]

# Pause for review
User feedback:
&quot;Sorting looks good, but filter UX unclear&quot;

# Iteration 3: Refine filtering
Agent refines:
&quot;&quot;&quot;
[Previous content]

## Filtering Details
- Filter button in header opens panel
- Panel shows filter inputs per column
- Presets: &quot;Clear All&quot;, &quot;Save Filter&quot;
- Visual: Shows active filter count badge
&quot;&quot;&quot;

Changes:
- Modified: Filter feature with detailed UX [Addresses: &quot;filter UX unclear&quot;]
- Added: Filter presets for common actions
- Added: Active filter indicator

# Convergence check
Feedback addressed: 100% (3/3 items)
Delta size: Small (1 feature refined)
Critical issues: None
Convergence score: 0.95

â†’ Iteration complete!

# Final output
&quot;&quot;&quot;
# DataTable Component - Evolution Report

## Final Specification
[Full spec]

## Iteration History
Iteration 1: Initial design (baseline)
Iteration 2: Added sorting, filtering, resize (+3 features)
Iteration 3: Refined filter UX (+1 detail)

## Feedback Tracking
âœ“ Needs sorting â†’ Addressed in iteration 2
âœ“ Needs filtering â†’ Addressed in iteration 2, refined in 3
âœ“ Needs column resize â†’ Addressed in iteration 2
âœ“ Filter UX unclear â†’ Addressed in iteration 3

## Design Decisions
- Sorting: Chose click-to-sort (standard pattern)
- Filtering: Chose panel over inline (more space for complex filters)
- Resize: Chose drag borders (familiar to users)
&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 2: API Design Refinement</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Initial prompt
&quot;Design a REST API for user permissions&quot;

# Iteration 1
{
    &quot;artifact&quot;: &quot;&quot;&quot;
    POST /api/v1/users/{id}/permissions
    GET /api/v1/users/{id}/permissions
    DELETE /api/v1/users/{id}/permissions/{permissionId}
    &quot;&quot;&quot;,
    &quot;iteration&quot;: 1
}

# Feedback
[
    {&quot;content&quot;: &quot;Need bulk operations&quot;, &quot;priority&quot;: &quot;should&quot;},
    {&quot;content&quot;: &quot;Missing permission inheritance&quot;, &quot;priority&quot;: &quot;must&quot;}
]

# Iteration 2
{
    &quot;artifact&quot;: &quot;&quot;&quot;
    POST /api/v1/users/{id}/permissions (bulk support via array)
    GET /api/v1/users/{id}/permissions?include=inherited
    DELETE /api/v1/users/{id}/permissions (bulk support)
    POST /api/v1/permissions/inherit
    &quot;&quot;&quot;,
    &quot;iteration&quot;: 2,
    &quot;changes&quot;: [
        {
            &quot;description&quot;: &quot;Added bulk support to POST/DELETE&quot;,
            &quot;addresses_feedback&quot;: [&quot;Need bulk operations&quot;]
        },
        {
            &quot;description&quot;: &quot;Added ?include=inherited query param&quot;,
            &quot;addresses_feedback&quot;: [&quot;Missing permission inheritance&quot;]
        },
        {
            &quot;description&quot;: &quot;Added /inherit endpoint for inheritance rules&quot;,
            &quot;addresses_feedback&quot;: [&quot;Missing permission inheritance&quot;]
        }
    ]
}

# Convergence: Score 1.0 (all feedback addressed)</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Storage</h4>
        <li><strong>Iteration checkpoints</strong>: May contain sensitive work-in-progress</li>
        <li><strong>Feedback</strong>: User feedback may contain sensitive context</li>
        <li><strong>Versioning</strong>: All versions stored until session end</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Access Control</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;orchestrator:execute&quot;,      # Execute orchestration loops
    &quot;context:read&quot;,              # Read conversation context
    &quot;context:write&quot;,             # Write iteration checkpoints
]</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Risk Mitigations</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Risk</th><th>Mitigation</th></tr>
          </thead>
          <tbody>
            <tr><td>Large version history consuming memory</td><td>Configurable storage backend (memory/file/database)</td></tr>
            <tr><td>Sensitive iterations persisted</td><td>Clear checkpoints on session end</td></tr>
            <tr><td>Feedback leaking to other users</td><td>Feedback scoped to session</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_iteration_controller_respects_max_iterations():
    controller = IterationController(max_iterations=3)
    assert controller.should_continue() == True  # iteration 1
    # ... execute 3 iterations
    assert controller.should_continue() == False  # max reached

def test_convergence_detector_identifies_high_score():
    detector = ConvergenceDetector(threshold=0.9)
    feedback = [
        FeedbackItem(id=&quot;1&quot;, addressed=True),
        FeedbackItem(id=&quot;2&quot;, addressed=True),
        FeedbackItem(id=&quot;3&quot;, addressed=False)
    ]
    score = detector._feedback_addressed_score(feedback)
    assert score == 0.67  # 2/3

def test_feedback_correlator_links_changes():
    correlator = FeedbackCorrelator()
    feedback = FeedbackItem(id=&quot;1&quot;, content=&quot;Add sorting&quot;)
    change = Change(
        description=&quot;Added sort&quot;,
        addresses_feedback=[&quot;1&quot;]
    )
    # Should link change to feedback
    ...</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_full_iteration_flow():
    &quot;&quot;&quot;Test complete iteration cycle.&quot;&quot;&quot;
    orchestrator = IterativeRefinementOrchestrator(config)
    
    result = await orchestrator.execute(
        prompt=&quot;Design a button component&quot;,
        context=mock_context
    )
    
    # Should have multiple iterations
    assert len(orchestrator.iterations) &gt; 1
    
    # Should track changes
    assert all(it.changes for it in orchestrator.iterations[1:])
    
    # Should converge
    assert orchestrator.iterations[-1].convergence_score &gt; 0.9</code></pre>
        </div>
        <p>---</p>
        <h3>Implementation Notes</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Delegation to Standard Loop</h4>
        <p>The iterative refinement orchestrator <strong>delegates</strong> to the standard <code>loop-basic</code> for each iteration's execution. It provides:</p>
        <li><strong>Pre-processing</strong>: Build iteration-specific prompt with feedback</li>
        <li><strong>Post-processing</strong>: Extract changes, compute deltas, correlate feedback</li>
        <p>This keeps the orchestrator focused on <strong>iteration management</strong> rather than reimplementing execution logic.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">LLM Usage</h4>
        <p>The orchestrator uses the LLM for:</p>
        <li><strong>Semantic diff</strong>: Understanding what changed conceptually</li>
        <li><strong>Change extraction</strong>: Parsing change descriptions from agent responses</li>
        <li><strong>Feedback correlation</strong>: Inferring if a change addresses feedback</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Performance Considerations</h4>
        <li><strong>Checkpoint storage</strong>: Memory mode is fast but limited; file mode scales better</li>
        <li><strong>Delta computation</strong>: Semantic diffs require LLM calls (slower but higher quality)</li>
        <li><strong>Convergence detection</strong>: Runs after each iteration (overhead acceptable)</li>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>amplifier-core</code> - Core session and module infrastructure</li>
        <li><code>amplifier-module-loop-basic</code> - Delegates iteration execution</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>difflib</code> - Line-by-line diffs (stdlib)</li>
        <li><code>tiktoken</code> - Token counting for large artifacts</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Feedback format</strong>: Should feedback be structured (schema) or free-form text?</li>
        <p>   - Option A: Structured (easier to correlate, requires template)</p>
        <p>   - Option B: Free-form (flexible, harder to correlate)</p>
        <li><strong>Convergence tuning</strong>: Should convergence be project-configurable?</li>
        <p>   - Some projects may want stricter convergence (critical systems)</p>
        <p>   - Others may want looser (creative work)</p>
        <li><strong>Parallel iterations</strong>: Should we support exploring multiple refinement paths simultaneously?</li>
        <p>   - Would enable A/B comparison of different approaches</p>
        <p>   - Increases complexity significantly</p>
        <li><strong>Human-in-the-loop</strong>: How to best pause for review?</li>
        <p>   - Option A: Block orchestrator, wait for user input</p>
        <p>   - Option B: Emit event, allow async review submission</p>
        <p>   - Option C: Interactive review UI (requires integration)</p>
        <li><strong>Version persistence</strong>: Should intermediate versions be saved long-term?</li>
        <p>   - Useful for audit trails but increases storage</p>
        <p>   - Could offer configurable retention policy</p>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-orchestrator-loop-parallel-exploration" data-category="orchestrators">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Orchestrator Loop Parallel Exploration</span>
            <span class="spec-category">orchestrators</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-loop-parallel-exploration</code></p>
        </div>
        <h3>Overview</h3>
        <p>An orchestrator that explores multiple solution approaches in parallel, evaluates each against defined criteria, and presents a comparative analysis with recommendations. Enables rapid exploration of solution space by generating multiple prototypes simultaneously rather than exploring sequentially.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Sequential exploration (try A, fail, try B, etc.)</td><td>Parallel exploration of 3-5 approaches simultaneously</td></tr>
            <tr><td>Anchor on first solution</td><td>Fair evaluation of multiple alternatives</td></tr>
            <tr><td>Miss better alternatives</td><td>Comprehensive solution space coverage</td></tr>
            <tr><td>Subjective comparison</td><td>Structured evaluation matrix with criteria</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Architecture decisions</strong>: Evaluate multiple database choices (Postgres, MongoDB, DynamoDB) in parallel</li>
        <li><strong>API design</strong>: Compare REST, GraphQL, gRPC with working examples</li>
        <li><strong>Algorithm selection</strong>: Test multiple sorting/search algorithms with benchmarks</li>
        <li><strong>Design patterns</strong>: Explore different implementation patterns (Strategy, Factory, etc.)</li>
        <li><strong>Technology choices</strong>: Compare frameworks/libraries with proof-of-concepts</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Orchestrator Interface</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ParallelExplorationOrchestrator:
    &quot;&quot;&quot;
    Orchestrator that explores multiple solution approaches in parallel.
    
    Flow:
    1. Receive problem statement
    2. Generate N different approaches
    3. Spawn sub-agents to develop each approach in parallel
    4. Collect all approach results
    5. Evaluate against criteria
    6. Generate comparison matrix
    7. Recommend best approach(es)
    &quot;&quot;&quot;
    
    async def execute(
        self,
        prompt: str,
        context: ContextManager,
        providers: dict[str, Any],
        tools: dict[str, Any],
        hooks: HookRegistry,
        coordinator: ModuleCoordinator | None = None,
    ) -&gt; str:
        &quot;&quot;&quot;
        Execute parallel exploration.
        
        Args:
            prompt: Problem to solve
            context: Conversation context
            providers: Available LLM providers
            tools: Available tools
            hooks: Hook registry for events
            coordinator: Module coordinator
            
        Returns:
            Comparison matrix with recommendations
        &quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Configuration Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">toml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-toml">[[orchestrators]]
module = &quot;loop-parallel-exploration&quot;
config = {
  # Exploration parameters
  num_approaches = 4                     # How many alternatives to explore
  approach_generation = &quot;automatic&quot;      # &quot;automatic&quot; | &quot;user_specified&quot;
  
  # Evaluation criteria
  evaluation_criteria = [
    &quot;performance&quot;,
    &quot;cost&quot;, 
    &quot;complexity&quot;,
    &quot;scalability&quot;,
    &quot;maintainability&quot;
  ]
  
  # Criteria weights (for scoring)
  weights = {
    performance = 1.0,
    cost = 0.8,
    complexity = 1.2,
    scalability = 0.9,
    maintainability = 1.0
  }
  
  # Prototype generation
  generate_prototypes = true             # Generate working examples
  prototype_depth = &quot;proof_of_concept&quot;   # &quot;sketch&quot; | &quot;proof_of_concept&quot; | &quot;production_ready&quot;
  
  # Execution
  parallel_execution = true              # Run all explorations simultaneously
  timeout_per_approach = 180             # Seconds per approach
  
  # Output control
  comparison_format = &quot;matrix&quot;           # &quot;matrix&quot; | &quot;narrative&quot; | &quot;both&quot;
  include_code_samples = true
  include_trade_off_analysis = true
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>orchestrator:exploration:start</code></td><td>Exploration begins</td><td>num_approaches, criteria</td></tr>
            <tr><td><code>orchestrator:approach:generated</code></td><td>Approach identified</td><td>approach_id, description</td></tr>
            <tr><td><code>orchestrator:approach:start</code></td><td>Approach exploration starts</td><td>approach_id</td></tr>
            <tr><td><code>orchestrator:approach:complete</code></td><td>Approach done</td><td>approach_id, scores</td></tr>
            <tr><td><code>orchestrator:evaluation:complete</code></td><td>All evaluated</td><td>top_approach, comparison_matrix</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          orchestrator-loop-parallel-exploration               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Approach    â”‚â”€â”€â”€â–¶â”‚    Parallel    â”‚â”€â”€â”€â–¶â”‚  Evaluator  â”‚  â”‚
â”‚  â”‚  Generator    â”‚    â”‚    Executor    â”‚    â”‚             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                     â”‚         â”‚
â”‚                                                     â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Prototype    â”‚    â”‚  Comparison    â”‚    â”‚  Scoring    â”‚  â”‚
â”‚  â”‚  Generator    â”‚    â”‚    Matrix      â”‚    â”‚   Engine    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Approach Generator</p>
        <p>Generates alternative solution approaches:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class Approach:
    id: str                          # UUID
    name: str                        # &quot;Approach A: PostgreSQL&quot;
    description: str                 # High-level description
    rationale: str                   # Why this approach?
    key_characteristics: list[str]   # Defining features
    prototype: str | None            # Code/config example
    evaluation_scores: dict[str, float] | None  # Criteria scores

class ApproachGenerator:
    &quot;&quot;&quot;Generates diverse solution approaches for exploration.&quot;&quot;&quot;
    
    def __init__(self, num_approaches: int = 4):
        self.num_approaches = num_approaches
    
    async def generate_approaches(
        self,
        problem: str,
        context: ContextManager
    ) -&gt; list[Approach]:
        &quot;&quot;&quot;
        Generate diverse approaches to solve the problem.
        
        Uses LLM to brainstorm alternatives, aiming for:
        - Different paradigms (SQL vs NoSQL, REST vs GraphQL)
        - Different trade-offs (performance vs simplicity)
        - Different implementation strategies
        &quot;&quot;&quot;
        prompt = f&quot;&quot;&quot;
You are exploring solutions to this problem:

{problem}

Generate {self.num_approaches} different approaches. Each approach should:
1. Take a fundamentally different strategy
2. Have clear pros and cons
3. Be viable (not strawman alternatives)

For each approach, provide:
- Name: Brief identifier
- Description: What is this approach?
- Rationale: Why would someone choose this?
- Key characteristics: What defines this approach?

Output as JSON array.
&quot;&quot;&quot;
        
        # Get LLM to generate approaches
        result = await self._call_llm(prompt, context)
        approaches = self._parse_approaches(result)
        
        # Assign UUIDs
        for approach in approaches:
            approach.id = str(uuid.uuid4())
        
        return approaches
    
    def _parse_approaches(self, llm_output: str) -&gt; list[Approach]:
        &quot;&quot;&quot;Parse LLM output into Approach objects.&quot;&quot;&quot;
        # Extract JSON, create Approach objects
        ...</code></pre>
        </div>
        <p>#### 2. Parallel Executor</p>
        <p>Executes exploration of all approaches simultaneously:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ParallelExecutor:
    &quot;&quot;&quot;Executes exploration of approaches in parallel.&quot;&quot;&quot;
    
    async def explore_all(
        self,
        approaches: list[Approach],
        problem: str,
        context: ContextManager,
        coordinator: ModuleCoordinator,
        config: ExplorationConfig
    ) -&gt; list[Approach]:
        &quot;&quot;&quot;Explore all approaches in parallel.&quot;&quot;&quot;
        
        # Create exploration tasks
        tasks = [
            self._explore_approach(approach, problem, context, coordinator, config)
            for approach in approaches
        ]
        
        # Execute in parallel
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # Filter errors
        explored_approaches = []
        for i, result in enumerate(results):
            if isinstance(result, Exception):
                logger.error(f&quot;Approach {approaches[i].name} failed: {result}&quot;)
            else:
                explored_approaches.append(result)
        
        return explored_approaches
    
    async def _explore_approach(
        self,
        approach: Approach,
        problem: str,
        context: ContextManager,
        coordinator: ModuleCoordinator,
        config: ExplorationConfig
    ) -&gt; Approach:
        &quot;&quot;&quot;Explore a single approach in depth.&quot;&quot;&quot;
        
        # Build exploration prompt
        exploration_prompt = f&quot;&quot;&quot;
# Approach: {approach.name}

## Description
{approach.description}

## Original Problem
{problem}

## Task
Develop this approach in detail:

1. **Architecture**: How would this work?
2. **Implementation**: {&quot;Generate working code example&quot; if config.generate_prototypes else &quot;Describe implementation&quot;}
3. **Pros**: What are the advantages?
4. **Cons**: What are the disadvantages?
5. **Evaluation**: Score this approach on:
   {chr(10).join(f&quot;   - {criterion}: 0-10 scale&quot; for criterion in config.evaluation_criteria)}

Be specific and realistic. This will be compared to other approaches.
&quot;&quot;&quot;
        
        # Use task tool to spawn exploration
        result = await coordinator.call_tool(&quot;task&quot;, {
            &quot;agent&quot;: &quot;developer-expertise:zen-architect&quot;,  # Or configurable agent
            &quot;instruction&quot;: exploration_prompt
        })
        
        # Parse result and update approach
        return self._parse_exploration_result(result, approach, config)
    
    def _parse_exploration_result(
        self,
        result: str,
        approach: Approach,
        config: ExplorationConfig
    ) -&gt; Approach:
        &quot;&quot;&quot;Parse exploration result and extract scores.&quot;&quot;&quot;
        
        # Extract prototype code (if generated)
        if config.generate_prototypes:
            approach.prototype = self._extract_code(result)
        
        # Extract evaluation scores
        scores = {}
        for criterion in config.evaluation_criteria:
            score = self._extract_score(result, criterion)
            scores[criterion] = score
        
        approach.evaluation_scores = scores
        
        return approach</code></pre>
        </div>
        <p>#### 3. Evaluator & Scoring Engine</p>
        <p>Evaluates approaches against criteria:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ScoringEngine:
    &quot;&quot;&quot;Scores and ranks approaches based on evaluation criteria.&quot;&quot;&quot;
    
    def __init__(self, weights: dict[str, float]):
        self.weights = weights
    
    def score_approaches(
        self,
        approaches: list[Approach],
        criteria: list[str]
    ) -&gt; list[ScoredApproach]:
        &quot;&quot;&quot;
        Score and rank approaches.
        
        Scoring:
        1. Normalize scores to 0-1 range
        2. Apply weights per criterion
        3. Calculate weighted average
        4. Rank by total score
        &quot;&quot;&quot;
        scored = []
        
        for approach in approaches:
            # Calculate weighted score
            total_score = 0.0
            max_possible = 0.0
            
            for criterion in criteria:
                score = approach.evaluation_scores.get(criterion, 0.0)
                weight = self.weights.get(criterion, 1.0)
                
                # Normalize to 0-1 (assuming scores are 0-10)
                normalized_score = score / 10.0
                
                total_score += normalized_score * weight
                max_possible += weight
            
            # Final score (0-1 range)
            final_score = total_score / max_possible if max_possible &gt; 0 else 0.0
            
            scored.append(ScoredApproach(
                approach=approach,
                total_score=final_score,
                criterion_scores=approach.evaluation_scores,
                rank=0  # Assigned after sorting
            ))
        
        # Sort by score (descending)
        scored.sort(key=lambda x: x.total_score, reverse=True)
        
        # Assign ranks
        for i, scored_approach in enumerate(scored):
            scored_approach.rank = i + 1
        
        return scored
    
    def identify_best_approach(
        self,
        scored_approaches: list[ScoredApproach],
        threshold: float = 0.1
    ) -&gt; tuple[ScoredApproach, list[ScoredApproach]]:
        &quot;&quot;&quot;
        Identify best approach and close alternatives.
        
        Returns:
        - Best approach (highest score)
        - Close alternatives (within threshold of best)
        &quot;&quot;&quot;
        if not scored_approaches:
            raise ValueError(&quot;No approaches to evaluate&quot;)
        
        best = scored_approaches[0]
        
        # Find alternatives within threshold
        alternatives = [
            a for a in scored_approaches[1:]
            if (best.total_score - a.total_score) &lt;= threshold
        ]
        
        return best, alternatives</code></pre>
        </div>
        <p>#### 4. Comparison Matrix Generator</p>
        <p>Generates structured comparison:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ComparisonMatrix:
    &quot;&quot;&quot;Generates comparison matrix for approaches.&quot;&quot;&quot;
    
    def generate_matrix(
        self,
        scored_approaches: list[ScoredApproach],
        criteria: list[str]
    ) -&gt; str:
        &quot;&quot;&quot;
        Generate comparison matrix table.
        
        Format:
        | Approach | Performance | Cost | Complexity | ... | Total Score | Rank |
        |----------|-------------|------|------------|-----|-------------|------|
        | A: Redis | 9/10        | 6/10 | 7/10       | ... | 0.85        | 1    |
        | B: CDN   | 8/10        | 8/10 | 6/10       | ... | 0.82        | 2    |
        &quot;&quot;&quot;
        
        # Build header
        header = [&quot;Approach&quot;] + criteria + [&quot;Total Score&quot;, &quot;Rank&quot;]
        
        # Build rows
        rows = []
        for scored in scored_approaches:
            row = [scored.approach.name]
            
            # Add criterion scores
            for criterion in criteria:
                score = scored.criterion_scores.get(criterion, 0.0)
                row.append(f&quot;{score:.1f}/10&quot;)
            
            # Add total score and rank
            row.append(f&quot;{scored.total_score:.2f}&quot;)
            row.append(str(scored.rank))
            
            rows.append(row)
        
        # Format as markdown table
        return self._format_table(header, rows)
    
    def generate_trade_off_analysis(
        self,
        scored_approaches: list[ScoredApproach],
        criteria: list[str]
    ) -&gt; str:
        &quot;&quot;&quot;
        Generate prose explanation of trade-offs.
        
        Example:
        &quot;Approach A excels in performance (9/10) but is more expensive (6/10).
        Approach B offers better cost efficiency (8/10) at the expense of 
        slightly lower performance (8/10).&quot;
        &quot;&quot;&quot;
        analysis = []
        
        # Find best/worst per criterion
        for criterion in criteria:
            scores = [
                (a.approach.name, a.criterion_scores.get(criterion, 0.0))
                for a in scored_approaches
            ]
            scores.sort(key=lambda x: x[1], reverse=True)
            
            best_name, best_score = scores[0]
            worst_name, worst_score = scores[-1]
            
            analysis.append(
                f&quot;**{criterion.title()}**: {best_name} leads ({best_score:.1f}/10), &quot;
                f&quot;{worst_name} trails ({worst_score:.1f}/10)&quot;
            )
        
        return &quot;\n&quot;.join(analysis)</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">User Problem: &quot;Design a caching strategy&quot;
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Generate Approaches                     â”‚
â”‚ â†’ A: Redis in-memory cache              â”‚
â”‚ â†’ B: CDN edge caching                   â”‚
â”‚ â†’ C: Application-level cache            â”‚
â”‚ â†’ D: Database query cache               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Explore All Approaches (Parallel)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Approach A: Redis                       â”‚
â”‚ - Architecture: Centralized cache       â”‚
â”‚ - Prototype: Redis config + code        â”‚
â”‚ - Scores: perf=9, cost=6, complex=7     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Approach B: CDN                         â”‚
â”‚ - Architecture: Edge distribution       â”‚
â”‚ - Prototype: CDN rules + headers        â”‚
â”‚ - Scores: perf=8, cost=8, complex=6     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [... C and D ...]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (All complete)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Score &amp; Rank                            â”‚
â”‚ Weights: perf=1.0, cost=0.8, complex=1.2â”‚
â”‚                                         â”‚
â”‚ A: Redis â†’ 0.85 (rank 1)                â”‚
â”‚ B: CDN   â†’ 0.82 (rank 2)                â”‚
â”‚ C: App   â†’ 0.75 (rank 3)                â”‚
â”‚ D: DB    â†’ 0.60 (rank 4)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Generate Comparison Matrix              â”‚
â”‚ + Trade-off Analysis                    â”‚
â”‚ + Recommendation                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Caching Strategy</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Input
&quot;Design a caching strategy for our API&quot;

# Generated Approaches (4)

Approach A: Redis In-Memory Cache
Description: Centralized Redis cache with TTL
Rationale: Fast, mature, horizontal scale
Characteristics: [Centralized, Network-based, Configurable TTL]

Approach B: CDN Edge Caching
Description: Cache at CDN edge locations
Rationale: Geographic distribution, offload origin
Characteristics: [Distributed, HTTP-level, Edge computing]

Approach C: Application-Level Cache
Description: In-process cache (in-memory map)
Rationale: Zero network latency, simple
Characteristics: [Local, Fast, No shared state]

Approach D: Database Query Cache
Description: PostgreSQL query result cache
Rationale: Transparent, built-in, no new infra
Characteristics: [Database-level, Automatic, Limited control]

# Exploration Results (parallel)

## Approach A: Redis
Architecture:
- Redis cluster with read replicas
- Cache-aside pattern (lazy loading)
- TTL-based expiration

Prototype:</code></pre>
        </div>
        <p>import redis</p>
        <p>client = redis.Redis(host='localhost', decode_responses=True)</p>
        <p>def get_user(user_id):</p>
        <p>    # Check cache</p>
        <p>    cached = client.get(f"user:{user_id}")</p>
        <p>    if cached:</p>
        <p>        return json.loads(cached)</p>
        <p>    # Cache miss - fetch from DB</p>
        <p>    user = db.query_user(user_id)</p>
        <p>    client.setex(f"user:{user_id}", 3600, json.dumps(user))</p>
        <p>    return user</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Scores:
- Performance: 9/10 (sub-ms reads)
- Cost: 6/10 ($200/month for cluster)
- Complexity: 7/10 (need cluster ops)
- Scalability: 9/10 (horizontal scale)
- Maintainability: 7/10 (new dependency)

## Approach B: CDN Edge Caching
Architecture:
- CloudFlare/Fastly edge caching
- Cache-Control headers
- Purge API for invalidation

Prototype:</code></pre>
        </div>
        <p>@app.route('/api/users/<id>')</p>
        <p>def get_user(id):</p>
        <p>    user = db.query_user(id)</p>
        <p>    response = jsonify(user)</p>
        <p>    response.headers['Cache-Control'] = 'public, max-age=3600'</p>
        <p>    response.headers['Vary'] = 'Authorization'</p>
        <p>    return response</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">Scores:
- Performance: 8/10 (CDN latency)
- Cost: 8/10 ($50/month)
- Complexity: 6/10 (simpler than Redis)
- Scalability: 10/10 (global edge network)
- Maintainability: 8/10 (managed service)

[... Approaches C and D ...]

# Evaluation Matrix

| Approach | Performance | Cost | Complexity | Scalability | Maintainability | Total | Rank |
|----------|-------------|------|------------|-------------|-----------------|-------|------|
| A: Redis | 9/10 | 6/10 | 7/10 | 9/10 | 7/10 | 0.85 | 1 |
| B: CDN   | 8/10 | 8/10 | 6/10 | 10/10 | 8/10 | 0.82 | 2 |
| C: App   | 10/10 | 10/10 | 9/10 | 4/10 | 9/10 | 0.75 | 3 |
| D: DB    | 6/10 | 9/10 | 8/10 | 5/10 | 8/10 | 0.60 | 4 |

Weights applied: performance=1.0, cost=0.8, complexity=1.2, scalability=0.9, maintainability=1.0

# Trade-off Analysis

**Performance**: Application-level cache leads (10/10, zero latency), Database cache trails (6/10)
**Cost**: Application and Database caches are cheapest (no infra), Redis most expensive (cluster required)
**Complexity**: Application cache is simplest (9/10), Redis cluster is most complex (7/10)
**Scalability**: CDN excels (10/10, global), Application cache limited (4/10, single-instance)
**Maintainability**: Application and Database caches easiest (no ops), Redis requires cluster management

# Recommendation

**Primary Choice: Approach A (Redis)**
- Score: 0.85/1.0
- Best for: High-traffic APIs needing shared cache across instances
- Trade-off: Higher cost and complexity, but superior scalability

**Close Alternative: Approach B (CDN)**
- Score: 0.82/1.0 (within 0.03 of best)
- Consider if: API is mostly public, read-heavy, geographically distributed users
- Trade-off: Less control over cache invalidation

**Use Case Guidance:**
- Start with **Application-level cache** (C) if: Small app, single instance, simplicity critical
- Use **Redis** (A) if: Multi-instance, shared state, high traffic
- Use **CDN** (B) if: Public API, read-heavy, global users
- Avoid **Database cache** (D): Lowest scores, limited control</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Full configuration example
orchestrators:
  - module: loop-parallel-exploration
    config:
      # Exploration
      num_approaches: 4
      approach_generation: automatic
      approach_diversity: high          # Encourage different paradigms
      
      # Evaluation criteria
      evaluation_criteria:
        - performance
        - cost
        - complexity
        - scalability
        - maintainability
        - security                      # Optional: add domain-specific criteria
      
      # Weights (customize per project)
      weights:
        performance: 1.0
        cost: 0.8
        complexity: 1.2                 # Emphasize simplicity
        scalability: 0.9
        maintainability: 1.0
        security: 1.5                   # High priority for security
      
      # Prototype generation
      generate_prototypes: true
      prototype_depth: proof_of_concept
      prototype_format: code            # code | pseudocode | diagram
      
      # Execution
      parallel_execution: true
      timeout_per_approach: 180
      agent_per_approach: developer-expertise:zen-architect
      
      # Output
      comparison_format: both           # matrix and narrative
      include_code_samples: true
      include_trade_off_analysis: true
      include_recommendation: true
      recommendation_style: decisive    # decisive | options | conditional</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Resource Limits</h4>
        <li><strong>Timeout per approach</strong>: Prevents runaway explorations</li>
        <li><strong>Max approaches</strong>: Configurable limit (default 4, max 10)</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Code Generation</h4>
        <li><strong>Prototype code</strong>: May execute code if depth = production_ready</li>
        <li><strong>Validation</strong>: Generated code should be reviewed before use</li>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;orchestrator:execute&quot;,
    &quot;tool:task:spawn&quot;,
    &quot;context:read&quot;,
]</code></pre>
        </div>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_approach_generator_creates_diverse_approaches():
    generator = ApproachGenerator(num_approaches=3)
    approaches = generator.generate_approaches(&quot;Design a cache&quot;)
    assert len(approaches) == 3
    # Should have different strategies
    assert len(set(a.name for a in approaches)) == 3

def test_scoring_engine_applies_weights():
    engine = ScoringEngine(weights={&quot;perf&quot;: 2.0, &quot;cost&quot;: 1.0})
    approach = Approach(
        evaluation_scores={&quot;perf&quot;: 5, &quot;cost&quot;: 5}
    )
    score = engine.score_approaches([approach], [&quot;perf&quot;, &quot;cost&quot;])
    # Performance weighted 2x should dominate
    assert score[0].total_score &gt; 0.5</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_full_parallel_exploration():
    orchestrator = ParallelExplorationOrchestrator(config)
    result = await orchestrator.execute(
        prompt=&quot;Design an API authentication system&quot;,
        context=mock_context
    )
    # Should explore multiple approaches
    assert &quot;Approach A&quot; in result
    assert &quot;Approach B&quot; in result
    # Should have comparison matrix
    assert &quot;| Approach |&quot; in result
    # Should have recommendation
    assert &quot;Recommendation&quot; in result</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>amplifier-core</code></li>
        <li><code>amplifier-module-tool-task</code></li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>tabulate</code> - For pretty tables</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Approach diversity</strong>: How to ensure approaches are sufficiently different?</li>
        <li><strong>Domain-specific criteria</strong>: Should criteria be customizable per domain (web, ML, infra)?</li>
        <li><strong>Interactive exploration</strong>: Allow user to add approaches mid-exploration?</li>
        <li><strong>Cost estimation</strong>: Should we estimate actual costs ($$) vs relative scoring?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-orchestrator-loop-perspective-synthesis" data-category="orchestrators">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Orchestrator Loop Perspective Synthesis</span>
            <span class="spec-category">orchestrators</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-module-loop-perspective-synthesis</code></p>
        </div>
        <h3>Overview</h3>
        <p>An orchestrator that analyzes problems from multiple stakeholder perspectives in parallel, then synthesizes insights into a cohesive recommendation. Enables cross-functional decision-making by spawning specialized sub-agents for each role (PM, engineering, design, security, etc.) and combining their analyses.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>One-size-fits-all analysis</td><td>Role-specific perspectives (PM, eng, design, security)</td></tr>
            <tr><td>Sequential stakeholder consultation</td><td>Parallel analysis, faster results</td></tr>
            <tr><td>Missing blind spots</td><td>Each role highlights different concerns</td></tr>
            <tr><td>Vague recommendations</td><td>Clear trade-offs per stakeholder</td></tr>
          </tbody>
        </table>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Use Cases</h4>
        <li><strong>Feature decisions</strong>: "Should we build feature X?" analyzed by PM (market), eng (feasibility), design (UX)</li>
        <li><strong>Architecture reviews</strong>: System design evaluated by multiple technical specialists</li>
        <li><strong>Incident post-mortems</strong>: Root cause from ops, eng, product, security angles</li>
        <li><strong>Compliance assessment</strong>: Legal, security, privacy perspectives on new feature</li>
        <li><strong>Technical design</strong>: Database choice evaluated by performance, cost, ops perspectives</li>
        <p>---</p>
        <h3>Contract</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Orchestrator Interface</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class PerspectiveSynthesisOrchestrator:
    &quot;&quot;&quot;
    Orchestrator that analyzes from multiple perspectives in parallel.
    
    Flow:
    1. Receive user query/problem
    2. Spawn sub-agents for each configured perspective
    3. Execute all perspectives in parallel
    4. Detect conflicts between perspectives
    5. Synthesize unified recommendation
    6. Generate role-specific reports
    &quot;&quot;&quot;
    
    async def execute(
        self,
        prompt: str,
        context: ContextManager,
        providers: dict[str, Any],
        tools: dict[str, Any],
        hooks: HookRegistry,
        coordinator: ModuleCoordinator | None = None,
    ) -&gt; str:
        &quot;&quot;&quot;
        Execute multi-perspective analysis.
        
        Args:
            prompt: User&#039;s question or problem
            context: Conversation context
            providers: Available LLM providers
            tools: Available tools
            hooks: Hook registry for events
            coordinator: Module coordinator
            
        Returns:
            Synthesized recommendation with all perspectives
        &quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Configuration Schema</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">toml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-toml">[[orchestrators]]
module = &quot;loop-perspective-synthesis&quot;
config = {
  # Perspectives to analyze
  perspectives = [
    { 
      role = &quot;product&quot;,
      agent = &quot;agent-product-analyst&quot;,
      weight = 1.0,
      focus_areas = [&quot;market&quot;, &quot;user_feedback&quot;, &quot;roadmap&quot;, &quot;metrics&quot;]
    },
    { 
      role = &quot;engineering&quot;,
      agent = &quot;agent-architect&quot;,
      weight = 1.0,
      focus_areas = [&quot;architecture&quot;, &quot;tech_debt&quot;, &quot;performance&quot;, &quot;scale&quot;]
    },
    { 
      role = &quot;design&quot;,
      agent = &quot;agent-design-system&quot;,
      weight = 0.8,
      focus_areas = [&quot;ux&quot;, &quot;accessibility&quot;, &quot;design_system&quot;, &quot;brand&quot;]
    },
    { 
      role = &quot;security&quot;,
      agent = &quot;agent-security-guardian&quot;,
      weight = 1.2,
      focus_areas = [&quot;threat_model&quot;, &quot;compliance&quot;, &quot;data_protection&quot;]
    }
  ]
  
  # Synthesis strategy
  synthesis_strategy = &quot;weighted_voting&quot;  # &quot;weighted_voting&quot; | &quot;consensus&quot; | &quot;veto&quot;
  conflict_resolution = &quot;surface&quot;         # &quot;surface&quot; | &quot;mediate&quot; | &quot;escalate&quot;
  
  # Execution
  parallel_execution = true               # Run all perspectives simultaneously
  timeout_per_perspective = 120           # Seconds per perspective
  
  # Output control
  include_individual_reports = true       # Show each perspective&#039;s full analysis
  include_conflict_analysis = true        # Highlight disagreements
  generate_role_specific_summaries = true # Summary per stakeholder type
}</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Events Emitted</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Event</th><th>When</th><th>Data</th></tr>
          </thead>
          <tbody>
            <tr><td><code>orchestrator:perspectives:start</code></td><td>Analysis begins</td><td>perspectives_count, roles</td></tr>
            <tr><td><code>orchestrator:perspective:start</code></td><td>Perspective analysis starts</td><td>role, agent</td></tr>
            <tr><td><code>orchestrator:perspective:complete</code></td><td>Perspective done</td><td>role, recommendation, confidence</td></tr>
            <tr><td><code>orchestrator:conflict:detected</code></td><td>Disagreement found</td><td>conflicting_roles, topic</td></tr>
            <tr><td><code>orchestrator:synthesis:complete</code></td><td>Synthesis done</td><td>final_recommendation, consensus_score</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Architecture</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Component Diagram</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           orchestrator-loop-perspective-synthesis              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Perspective   â”‚â”€â”€â”€â–¶â”‚   Parallel     â”‚â”€â”€â”€â–¶â”‚  Conflict    â”‚ â”‚
â”‚  â”‚   Spawner      â”‚    â”‚   Executor     â”‚    â”‚  Detector    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚         â”‚
â”‚                                                      â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Synthesis    â”‚â—€â”€â”€â”€â”‚   Weighting    â”‚â—€â”€â”€â”€â”‚   Report     â”‚ â”‚
â”‚  â”‚    Engine      â”‚    â”‚    Engine      â”‚    â”‚  Generator   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Internal Components</h4>
        <p>#### 1. Perspective Spawner</p>
        <p>Spawns specialized sub-agents for each role:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class PerspectiveDefinition:
    role: str                        # &quot;product&quot;, &quot;engineering&quot;, etc.
    agent: str                       # Agent/profile to use
    weight: float                    # Importance weight (0.0-2.0)
    focus_areas: list[str]          # Areas this perspective focuses on
    prompt_template: str | None      # Custom prompt per perspective

@dataclass
class PerspectiveResult:
    role: str
    recommendation: str              # Main recommendation
    rationale: str                   # Reasoning
    confidence: float                # 0.0-1.0
    concerns: list[str]              # Risks/concerns raised
    questions: list[str]             # Questions for other perspectives
    metadata: dict[str, Any]         # Role-specific data

class PerspectiveSpawner:
    &quot;&quot;&quot;Spawns and manages sub-agents for each perspective.&quot;&quot;&quot;
    
    def __init__(self, perspectives: list[PerspectiveDefinition]):
        self.perspectives = perspectives
    
    async def spawn_all(
        self, 
        query: str,
        context: ContextManager,
        coordinator: ModuleCoordinator
    ) -&gt; list[PerspectiveResult]:
        &quot;&quot;&quot;Spawn all perspectives in parallel.&quot;&quot;&quot;
        tasks = [
            self._spawn_perspective(p, query, context, coordinator)
            for p in self.perspectives
        ]
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # Filter out errors, log them
        valid_results = []
        for i, result in enumerate(results):
            if isinstance(result, Exception):
                logger.error(f&quot;Perspective {self.perspectives[i].role} failed: {result}&quot;)
            else:
                valid_results.append(result)
        
        return valid_results
    
    async def _spawn_perspective(
        self,
        perspective: PerspectiveDefinition,
        query: str,
        context: ContextManager,
        coordinator: ModuleCoordinator
    ) -&gt; PerspectiveResult:
        &quot;&quot;&quot;Spawn a single perspective analysis.&quot;&quot;&quot;
        # Build role-specific prompt
        perspective_prompt = self._build_perspective_prompt(
            perspective, 
            query
        )
        
        # Use task tool to spawn sub-agent with specific perspective
        result = await coordinator.call_tool(&quot;task&quot;, {
            &quot;agent&quot;: perspective.agent,
            &quot;instruction&quot;: perspective_prompt
        })
        
        # Parse result into structured format
        return self._parse_result(result, perspective.role)
    
    def _build_perspective_prompt(
        self,
        perspective: PerspectiveDefinition,
        query: str
    ) -&gt; str:
        &quot;&quot;&quot;Build a role-specific prompt.&quot;&quot;&quot;
        template = perspective.prompt_template or self._default_template(perspective.role)
        
        prompt = f&quot;&quot;&quot;
# Your Role: {perspective.role.upper()} Perspective

You are analyzing this question from the {perspective.role} perspective.

## Focus Areas
{chr(10).join(f&quot;- {area}&quot; for area in perspective.focus_areas)}

## Query
{query}

## Task
Analyze this question from your role&#039;s perspective. Provide:

1. **Recommendation**: What should we do?
2. **Rationale**: Why do you recommend this?
3. **Concerns**: What risks or issues do you see?
4. **Questions**: What do you need to know from other perspectives?
5. **Confidence**: How confident are you? (0-100%)

Be specific and focus on your domain. Other perspectives will cover other areas.
&quot;&quot;&quot;
        return prompt.strip()</code></pre>
        </div>
        <p>#### 2. Conflict Detector</p>
        <p>Identifies disagreements between perspectives:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">@dataclass
class Conflict:
    topic: str
    conflicting_roles: list[str]
    positions: dict[str, str]        # role -&gt; position
    severity: str                    # &quot;minor&quot; | &quot;moderate&quot; | &quot;critical&quot;

class ConflictDetector:
    &quot;&quot;&quot;Detects conflicts between perspective recommendations.&quot;&quot;&quot;
    
    async def detect_conflicts(
        self,
        results: list[PerspectiveResult]
    ) -&gt; list[Conflict]:
        &quot;&quot;&quot;
        Identify conflicts between perspectives.
        
        Conflicts occur when:
        1. Direct contradictions (build vs don&#039;t build)
        2. Different priorities (cost vs quality)
        3. Unresolved concerns between roles
        &quot;&quot;&quot;
        conflicts = []
        
        # Check for direct contradictions
        recommendations = [r.recommendation for r in results]
        if self._has_contradictions(recommendations):
            conflicts.append(
                self._create_contradiction_conflict(results)
            )
        
        # Check for concern overlaps
        concern_conflicts = await self._analyze_concern_conflicts(results)
        conflicts.extend(concern_conflicts)
        
        # Check for priority misalignment
        priority_conflicts = self._detect_priority_conflicts(results)
        conflicts.extend(priority_conflicts)
        
        return conflicts
    
    def _has_contradictions(self, recommendations: list[str]) -&gt; bool:
        &quot;&quot;&quot;Detect if recommendations contradict each other.&quot;&quot;&quot;
        # Simple heuristic: look for opposing keywords
        has_build = any(&quot;build&quot; in r.lower() or &quot;implement&quot; in r.lower() 
                       for r in recommendations)
        has_dont_build = any(&quot;don&#039;t&quot; in r.lower() or &quot;defer&quot; in r.lower() 
                            for r in recommendations)
        
        return has_build and has_dont_build
    
    async def _analyze_concern_conflicts(
        self,
        results: list[PerspectiveResult]
    ) -&gt; list[Conflict]:
        &quot;&quot;&quot;Use LLM to identify concern conflicts.&quot;&quot;&quot;
        # Ask LLM to identify where concerns conflict
        prompt = f&quot;&quot;&quot;
        Analyze these perspectives for conflicting concerns:
        
        {self._format_results(results)}
        
        List conflicts where one role&#039;s concern conflicts with another&#039;s recommendation.
        &quot;&quot;&quot;
        # Returns structured conflicts
        ...</code></pre>
        </div>
        <p>#### 3. Synthesis Engine</p>
        <p>Combines perspectives into unified recommendation:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class SynthesisEngine:
    &quot;&quot;&quot;Synthesizes multiple perspectives into cohesive recommendation.&quot;&quot;&quot;
    
    def __init__(self, strategy: str = &quot;weighted_voting&quot;):
        self.strategy = strategy
    
    async def synthesize(
        self,
        results: list[PerspectiveResult],
        conflicts: list[Conflict],
        weights: dict[str, float]
    ) -&gt; SynthesisResult:
        &quot;&quot;&quot;
        Synthesize perspectives based on configured strategy.
        &quot;&quot;&quot;
        if self.strategy == &quot;weighted_voting&quot;:
            return await self._weighted_synthesis(results, weights)
        elif self.strategy == &quot;consensus&quot;:
            return await self._consensus_synthesis(results)
        elif self.strategy == &quot;veto&quot;:
            return await self._veto_synthesis(results)
        else:
            raise ValueError(f&quot;Unknown strategy: {self.strategy}&quot;)
    
    async def _weighted_synthesis(
        self,
        results: list[PerspectiveResult],
        weights: dict[str, float]
    ) -&gt; SynthesisResult:
        &quot;&quot;&quot;
        Weighted voting: higher weight = more influence.
        
        Example:
        - Security (weight 1.2): Don&#039;t build
        - Product (weight 1.0): Build
        - Design (weight 0.8): Build
        
        Weighted scores:
        - Don&#039;t build: 1.2
        - Build: 1.8
        
        â†’ Recommendation: Build (but highlight security concerns)
        &quot;&quot;&quot;
        # Calculate weighted scores per recommendation
        recommendation_scores = {}
        
        for result in results:
            weight = weights.get(result.role, 1.0)
            score = result.confidence * weight
            
            rec = self._normalize_recommendation(result.recommendation)
            recommendation_scores[rec] = recommendation_scores.get(rec, 0) + score
        
        # Top recommendation
        top_rec = max(recommendation_scores, key=recommendation_scores.get)
        consensus_score = recommendation_scores[top_rec] / sum(recommendation_scores.values())
        
        # Collect dissenting perspectives
        dissenters = [
            r for r in results 
            if self._normalize_recommendation(r.recommendation) != top_rec
        ]
        
        return SynthesisResult(
            recommendation=top_rec,
            consensus_score=consensus_score,
            supporting_roles=[r.role for r in results if self._normalize_recommendation(r.recommendation) == top_rec],
            dissenting_roles=[r.role for r in dissenters],
            synthesis_rationale=await self._generate_rationale(results, top_rec),
            role_breakdowns=results
        )
    
    async def _consensus_synthesis(
        self,
        results: list[PerspectiveResult]
    ) -&gt; SynthesisResult:
        &quot;&quot;&quot;
        Consensus: Only recommend if all (or majority) agree.
        &quot;&quot;&quot;
        recommendations = [
            self._normalize_recommendation(r.recommendation) 
            for r in results
        ]
        
        # Check for unanimous agreement
        if len(set(recommendations)) == 1:
            return SynthesisResult(
                recommendation=recommendations[0],
                consensus_score=1.0,
                supporting_roles=[r.role for r in results],
                dissenting_roles=[],
                synthesis_rationale=&quot;Unanimous agreement across all perspectives&quot;
            )
        
        # No consensus - highlight disagreement
        return SynthesisResult(
            recommendation=&quot;No consensus reached&quot;,
            consensus_score=0.0,
            supporting_roles=[],
            dissenting_roles=[r.role for r in results],
            synthesis_rationale=&quot;Perspectives disagree. See individual analyses.&quot;,
            needs_escalation=True
        )
    
    async def _veto_synthesis(
        self,
        results: list[PerspectiveResult]
    ) -&gt; SynthesisResult:
        &quot;&quot;&quot;
        Veto: Any critical concern blocks recommendation.
        &quot;&quot;&quot;
        # Check for critical concerns (typically from security, legal, compliance)
        blocking_concerns = [
            r for r in results
            if any(c.lower().startswith(&quot;critical&quot;) or c.lower().startswith(&quot;blocker&quot;) 
                   for c in r.concerns)
        ]
        
        if blocking_concerns:
            return SynthesisResult(
                recommendation=&quot;Blocked by critical concerns&quot;,
                consensus_score=0.0,
                supporting_roles=[],
                dissenting_roles=[r.role for r in blocking_concerns],
                synthesis_rationale=f&quot;Blocked by {&#039;, &#039;.join(r.role for r in blocking_concerns)}&quot;,
                blocking_concerns=[c for r in blocking_concerns for c in r.concerns]
            )
        
        # No blocks - synthesize normally
        return await self._weighted_synthesis(results, {r.role: 1.0 for r in results})</code></pre>
        </div>
        <p>#### 4. Report Generator</p>
        <p>Generates role-specific summaries:</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class ReportGenerator:
    &quot;&quot;&quot;Generates reports tailored to different stakeholders.&quot;&quot;&quot;
    
    def generate_full_report(
        self,
        synthesis: SynthesisResult,
        conflicts: list[Conflict]
    ) -&gt; str:
        &quot;&quot;&quot;Generate comprehensive report with all perspectives.&quot;&quot;&quot;
        sections = [
            self._executive_summary(synthesis),
            self._recommendation_section(synthesis),
            self._perspective_breakdowns(synthesis.role_breakdowns),
            self._conflict_analysis(conflicts),
            self._next_steps(synthesis)
        ]
        
        return &quot;\n\n&quot;.join(sections)
    
    def generate_role_specific_summary(
        self,
        role: str,
        synthesis: SynthesisResult
    ) -&gt; str:
        &quot;&quot;&quot;Generate summary for specific role (PM, eng, design).&quot;&quot;&quot;
        # Emphasize information relevant to this role
        
        if role == &quot;product&quot;:
            return self._product_summary(synthesis)
        elif role == &quot;engineering&quot;:
            return self._engineering_summary(synthesis)
        elif role == &quot;design&quot;:
            return self._design_summary(synthesis)
        else:
            return self._generic_summary(synthesis)
    
    def _executive_summary(self, synthesis: SynthesisResult) -&gt; str:
        &quot;&quot;&quot;High-level summary for decision-makers.&quot;&quot;&quot;
        return f&quot;&quot;&quot;
# Executive Summary

**Recommendation**: {synthesis.recommendation}
**Consensus Level**: {synthesis.consensus_score:.0%}
**Supporting**: {&#039;, &#039;.join(synthesis.supporting_roles)}
**Concerns**: {&#039;, &#039;.join(synthesis.dissenting_roles) if synthesis.dissenting_roles else &#039;None&#039;}

{synthesis.synthesis_rationale}
&quot;&quot;&quot;</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Flow</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">User Query: &quot;Should we build feature X?&quot;
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spawn Perspectives (Parallel)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â†’ Product Agent: Market analysis       â”‚
â”‚ â†’ Engineering Agent: Feasibility       â”‚
â”‚ â†’ Design Agent: UX impact              â”‚
â”‚ â†’ Security Agent: Threat model         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (All complete)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Collect Results                        â”‚
â”‚ - Product: Build (conf: 0.9)           â”‚
â”‚ - Engineering: Build, needs SRE (0.7)  â”‚
â”‚ - Design: Build, 8 weeks (0.8)         â”‚
â”‚ - Security: Build, review req&#039;d (0.6)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detect Conflicts                       â”‚
â”‚ - Moderate: Timeline (eng vs product)  â”‚
â”‚ - Minor: Security review process       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Synthesize (Weighted Voting)           â”‚
â”‚ Weights: Product=1.0, Eng=1.0,         â”‚
â”‚          Design=0.8, Security=1.2      â”‚
â”‚                                        â”‚
â”‚ Result: BUILD (consensus: 0.75)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Generate Reports                       â”‚
â”‚ - Full report (all perspectives)       â”‚
â”‚ - PM summary (business focus)          â”‚
â”‚ - Eng summary (technical focus)        â”‚
â”‚ - Design summary (UX focus)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Example 1: Feature Decision</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml"># Query
&quot;Should we add real-time collaboration to our editor?&quot;

# Spawned Perspectives (parallel)

## Product Perspective
Role: product
Agent: agent-product-analyst
Result:
  Recommendation: Build in Q2
  Rationale: |
    - Market: Top 3 feature request (247 users)
    - Competition: Figma, Google Docs have it
    - Revenue: Unblocks 3 enterprise deals ($450K ARR)
    - Risk: Delays Q1 roadmap
  Concerns:
    - Delays other priorities
    - Complex, may take longer than estimated
  Confidence: 0.85

## Engineering Perspective
Role: engineering
Agent: agent-architect
Result:
  Recommendation: Build, but hire SRE first
  Rationale: |
    - Architecture: Need WebSocket infra (6 weeks)
    - Tech debt: State management refactor needed (2 weeks)
    - Scale: 10K concurrent = $5K/month infra
    - Ops: No on-call experience with WebSockets
  Concerns:
    - Operational complexity
    - Hiring timeline unknown
  Confidence: 0.70

## Design Perspective
Role: design
Agent: agent-design-system
Result:
  Recommendation: Build, budget 8 weeks for design
  Rationale: |
    - UX: Need conflict resolution UI
    - Components: Cursors, avatars, presence (4 new)
    - Accessibility: Real-time updates for screen readers
    - Risk: Can&#039;t half-ship, UX must be polished
  Concerns:
    - 8 weeks design is optimistic
    - Need design system expansion
  Confidence: 0.80

## Security Perspective
Role: security
Agent: agent-security-guardian
Result:
  Recommendation: Build with security review
  Rationale: |
    - Threat: User impersonation, data leakage
    - Compliance: GDPR for shared sessions
    - Audit: Need activity logs for enterprise
  Concerns:
    - Critical: Security review before launch
    - Moderate: Pen test required
  Confidence: 0.60

# Conflict Detection
Conflicts:
  - Topic: Timeline
    Roles: [product, engineering]
    Severity: moderate
    Details: Product wants Q1, engineering needs Q2
    
  - Topic: Prerequisites
    Roles: [engineering]
    Severity: moderate
    Details: Engineering blocks on SRE hire

# Synthesis (Weighted Voting)
Weights:
  product: 1.0
  engineering: 1.0
  design: 0.8
  security: 1.2

Scores:
  &quot;Build&quot;: 1.0 + 1.0 + 0.8 = 2.8
  &quot;Build with conditions&quot;: 1.2 = 1.2
  Total: 4.0
  
Final Recommendation: Build (consensus: 70%)

# Generated Report

## Executive Summary
**Recommendation**: Build real-time collaboration feature
**Consensus**: 70% (weighted agreement)
**Timeline**: Q2 target (not Q1)
**Prerequisites**: Hire SRE, complete security review

All perspectives agree the feature should be built, but disagree on timing
and prerequisites.

## Recommendation Details

**Build the feature with these conditions:**
1. Target Q2 (not Q1) - allows time for infrastructure
2. Hire SRE before starting - mitigates operational risk
3. Security review required - addresses compliance concerns
4. Budget 8 weeks for design - ensures quality UX

**Estimated Investment:**
- Engineering: 12 weeks (6 infra + 6 feature)
- Design: 8 weeks
- Infrastructure: $60K/year
- Prerequisites: 1 SRE hire

**Expected Return:**
- Unlocks $450K ARR in enterprise deals
- Top user-requested feature (247 requests)
- Competitive parity with Figma, Google Docs

## Perspective Breakdowns
[Full details from each perspective]

## Conflicts &amp; Trade-offs
1. **Timeline** (Product vs Engineering)
   - Product wants Q1 for enterprise deals
   - Engineering needs Q2 for proper infrastructure
   - Resolution: Q2 target, communicate delay to prospects

2. **Prerequisites** (Engineering)
   - SRE hire needed before starting
   - Hiring timeline: 1-2 months
   - Mitigation: Start recruiting now

## Next Steps
1. [ ] Approve Q2 timeline
2. [ ] Start SRE recruitment
3. [ ] Schedule security review meeting
4. [ ] Allocate design team capacity</code></pre>
        </div>
        <p>---</p>
        <h3>Security Considerations</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Sub-agent Spawning</h4>
        <li><strong>Isolation</strong>: Each perspective gets isolated context</li>
        <li><strong>Resource limits</strong>: Timeout per perspective prevents runaway agents</li>
        <li><strong>Error handling</strong>: Failed perspectives don't block synthesis</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Data Access</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">REQUIRED_CAPABILITIES = [
    &quot;orchestrator:execute&quot;,
    &quot;tool:task:spawn&quot;,           # Spawn sub-agents
    &quot;context:read&quot;,
    &quot;context:write&quot;,
]</code></pre>
        </div>
        <p>---</p>
        <h3>Testing Strategy</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Unit Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">def test_conflict_detector_identifies_contradictions():
    results = [
        PerspectiveResult(role=&quot;pm&quot;, recommendation=&quot;Build now&quot;),
        PerspectiveResult(role=&quot;security&quot;, recommendation=&quot;Don&#039;t build&quot;)
    ]
    detector = ConflictDetector()
    conflicts = detector.detect_conflicts(results)
    assert len(conflicts) &gt; 0
    assert &quot;Build&quot; in conflicts[0].topic

def test_weighted_synthesis_respects_weights():
    results = [
        PerspectiveResult(role=&quot;pm&quot;, recommendation=&quot;Build&quot;, confidence=1.0),
        PerspectiveResult(role=&quot;security&quot;, recommendation=&quot;Don&#039;t&quot;, confidence=1.0)
    ]
    weights = {&quot;pm&quot;: 1.0, &quot;security&quot;: 2.0}
    engine = SynthesisEngine(&quot;weighted_voting&quot;)
    result = engine.synthesize(results, [], weights)
    assert &quot;Don&#039;t&quot; in result.recommendation  # Security weight wins</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Integration Tests</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">async def test_full_perspective_synthesis():
    orchestrator = PerspectiveSynthesisOrchestrator(config)
    result = await orchestrator.execute(
        prompt=&quot;Should we migrate to microservices?&quot;,
        context=mock_context
    )
    # Should have multiple perspectives
    assert len(orchestrator.perspectives_results) &gt;= 3
    # Should have synthesis
    assert &quot;recommendation&quot; in result.lower()</code></pre>
        </div>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required</h4>
        <li><code>amplifier-core</code></li>
        <li><code>amplifier-module-tool-task</code> - For spawning sub-agents</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>amplifier-collection-recipes</code> - For agent profiles</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Dynamic perspective selection</strong>: Should perspectives be auto-selected based on query?</li>
        <li><strong>Async review</strong>: How to handle long-running perspective analyses?</li>
        <li><strong>Perspective plugins</strong>: Should perspectives be pluggable/configurable?</li>
        <li><strong>Cross-perspective dialogue</strong>: Should perspectives be able to ask each other questions?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-codebase-onboarder" data-category="scenario-tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Codebase Onboarder</span>
            <span class="spec-category">scenario-tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-scenario-codebase-onboarder</code></p>
        </div>
        <h3>Overview</h3>
        <p>Interactive codebase exploration and learning tool for new team members. Generates personalized learning paths, explains architecture, answers questions with full context, and tracks onboarding progress.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Weeks to understand codebase</td><td>Days with guided exploration</td></tr>
            <tr><td>Scattered documentation</td><td>Unified, contextual explanations</td></tr>
            <tr><td>Constant interruptions to seniors</td><td>Self-service learning</td></tr>
            <tr><td>No visibility into onboarding progress</td><td>Tracked milestones</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Workflow Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Codebase Onboarding Pipeline                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Profile  â”‚â”€â”€â”€â–¶â”‚ Generate â”‚â”€â”€â”€â–¶â”‚ Explore  â”‚â”€â”€â”€â–¶â”‚ Assess   â”‚      â”‚
â”‚  â”‚ Setup    â”‚    â”‚ Path     â”‚    â”‚ &amp; Learn  â”‚    â”‚ Progress â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚               â”‚               â”‚               â”‚              â”‚
â”‚       â–¼               â–¼               â–¼               â–¼              â”‚
â”‚  â€¢ Role           â€¢ Learning      â€¢ Interactive   â€¢ Quiz           â”‚
â”‚  â€¢ Experience       modules        Q&amp;A           â€¢ Practical       â”‚
â”‚  â€¢ Focus areas    â€¢ Milestones   â€¢ Code walks     challenges      â”‚
â”‚  â€¢ Time budget    â€¢ Resources    â€¢ Architecture  â€¢ Knowledge       â”‚
â”‚                                    explanations    check           â”‚
â”‚                                                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                    â”‚ Progress      â”‚â—€â”€â”€ Throughout                  â”‚
â”‚                    â”‚ Tracking      â”‚                                â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">scenario:
  name: codebase-onboarder
  version: &quot;1.0.0&quot;

  # User profile
  profile:
    collect:
      - role                         # frontend, backend, fullstack, etc.
      - experience_level             # junior, mid, senior
      - prior_technologies           # Familiar languages/frameworks
      - focus_areas                  # What they&#039;ll work on
      - time_budget                  # Hours per day for learning

  # Content generation
  content:
    # Documentation sources
    sources:
      readme_files: true
      inline_docs: true
      architecture_docs: true
      adr_files: true
      wiki: false
      confluence: false

    # Learning modules to generate
    modules:
      architecture_overview:
        priority: 1
        estimated_time: 2h
      core_concepts:
        priority: 2
        estimated_time: 3h
      development_workflow:
        priority: 3
        estimated_time: 1h
      key_components:
        priority: 4
        estimated_time: 4h
      common_patterns:
        priority: 5
        estimated_time: 2h
      testing_practices:
        priority: 6
        estimated_time: 1h

  # Interactive features
  interactive:
    code_walkthrough: true
    architecture_diagrams: true
    live_questions: true
    practical_exercises: true

  # Assessment
  assessment:
    knowledge_checks: true
    practical_challenges: true
    mentor_review_points: true

  # Progress tracking
  progress:
    storage: file                   # file | database
    path: &quot;.amplifier/onboarding/&quot;
    milestones: true
    time_tracking: true

  # Output
  output:
    format: interactive              # interactive | static | both
    export_pdf: false</code></pre>
        </div>
        <p>---</p>
        <h3>Pipeline Implementation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class CodebaseOnboarderScenario:
    &quot;&quot;&quot;Interactive codebase onboarding experience.&quot;&quot;&quot;

    def __init__(self, config: OnboarderConfig):
        self.config = config
        self.tools = ToolRegistry()
        self.progress = OnboardingProgress()

    async def start_onboarding(self, user_id: str) -&gt; OnboardingSession:
        &quot;&quot;&quot;Initialize onboarding for a new user.&quot;&quot;&quot;

        # Stage 1: Collect Profile
        profile = await self._collect_profile(user_id)

        # Stage 2: Analyze Codebase
        codebase_info = await self._analyze_codebase()

        # Stage 3: Generate Learning Path
        learning_path = await self._generate_learning_path(profile, codebase_info)

        # Stage 4: Start Interactive Session
        session = OnboardingSession(
            user_id=user_id,
            profile=profile,
            learning_path=learning_path,
            codebase_info=codebase_info,
            progress=self.progress.load(user_id)
        )

        return session

    async def _collect_profile(self, user_id: str) -&gt; UserProfile:
        &quot;&quot;&quot;Stage 1: Collect user profile through interactive questions.&quot;&quot;&quot;

        questions = [
            ProfileQuestion(
                id=&quot;role&quot;,
                text=&quot;What&#039;s your primary role?&quot;,
                options=[&quot;Frontend&quot;, &quot;Backend&quot;, &quot;Full-stack&quot;, &quot;DevOps&quot;, &quot;Data/ML&quot;, &quot;Other&quot;]
            ),
            ProfileQuestion(
                id=&quot;experience&quot;,
                text=&quot;What&#039;s your experience level?&quot;,
                options=[&quot;Junior (0-2 years)&quot;, &quot;Mid (2-5 years)&quot;, &quot;Senior (5+ years)&quot;]
            ),
            ProfileQuestion(
                id=&quot;languages&quot;,
                text=&quot;Which languages/frameworks are you already familiar with?&quot;,
                multi_select=True,
                options=[&quot;Python&quot;, &quot;JavaScript/TypeScript&quot;, &quot;Go&quot;, &quot;Java&quot;, &quot;React&quot;, &quot;Node.js&quot;, &quot;Other&quot;]
            ),
            ProfileQuestion(
                id=&quot;focus&quot;,
                text=&quot;What area will you primarily work on?&quot;,
                options=await self._get_codebase_areas()
            ),
            ProfileQuestion(
                id=&quot;time&quot;,
                text=&quot;How much time can you dedicate to onboarding daily?&quot;,
                options=[&quot;1 hour&quot;, &quot;2 hours&quot;, &quot;4 hours&quot;, &quot;Full day&quot;]
            )
        ]

        # Collect answers (interactive or from config)
        answers = await self._collect_answers(questions)

        return UserProfile(
            user_id=user_id,
            role=answers[&quot;role&quot;],
            experience=answers[&quot;experience&quot;],
            familiar_with=answers[&quot;languages&quot;],
            focus_area=answers[&quot;focus&quot;],
            daily_time_budget=self._parse_time(answers[&quot;time&quot;])
        )

    async def _analyze_codebase(self) -&gt; CodebaseInfo:
        &quot;&quot;&quot;Stage 2: Analyze codebase structure and content.&quot;&quot;&quot;

        info = CodebaseInfo()

        # Get architecture
        arch_tool = self.tools.get(&quot;tool-architecture-map&quot;)
        info.architecture = await arch_tool.execute({
            &quot;action&quot;: &quot;generate&quot;,
            &quot;include_descriptions&quot;: True
        })

        # Get key components
        search_tool = self.tools.get(&quot;tool-codebase-search&quot;)

        # Find main entry points
        info.entry_points = await search_tool.execute({
            &quot;query&quot;: &quot;main entry point&quot;,
            &quot;file_patterns&quot;: [&quot;main.*&quot;, &quot;index.*&quot;, &quot;app.*&quot;]
        })

        # Find core modules
        info.core_modules = await self._identify_core_modules()

        # Collect documentation
        info.documentation = await self._collect_documentation()

        # Identify patterns
        info.patterns = await self._identify_patterns()

        # Get tech stack
        info.tech_stack = await self._identify_tech_stack()

        return info

    async def _generate_learning_path(
        self,
        profile: UserProfile,
        codebase: CodebaseInfo
    ) -&gt; LearningPath:
        &quot;&quot;&quot;Stage 3: Generate personalized learning path.&quot;&quot;&quot;

        modules = []

        # Module 1: Architecture Overview (always first)
        modules.append(await self._generate_architecture_module(codebase))

        # Module 2: Core Concepts (tailored to tech stack)
        modules.append(await self._generate_concepts_module(
            codebase, profile.familiar_with
        ))

        # Module 3: Development Workflow
        modules.append(await self._generate_workflow_module(codebase))

        # Module 4: Focus Area Deep Dive
        if profile.focus_area:
            modules.append(await self._generate_focus_module(
                codebase, profile.focus_area
            ))

        # Module 5: Key Components
        modules.append(await self._generate_components_module(
            codebase, profile.focus_area
        ))

        # Module 6: Common Patterns
        modules.append(await self._generate_patterns_module(
            codebase, profile.experience
        ))

        # Module 7: Testing Practices
        modules.append(await self._generate_testing_module(codebase))

        # Adjust based on time budget
        learning_path = LearningPath(
            modules=modules,
            estimated_total_time=sum(m.estimated_time for m in modules),
            daily_schedule=self._create_schedule(modules, profile.daily_time_budget)
        )

        return learning_path

    async def _generate_architecture_module(
        self,
        codebase: CodebaseInfo
    ) -&gt; LearningModule:
        &quot;&quot;&quot;Generate architecture overview module.&quot;&quot;&quot;

        sections = []

        # High-level overview
        sections.append(Section(
            title=&quot;System Overview&quot;,
            content=await self._generate_overview(codebase),
            type=&quot;reading&quot;,
            estimated_time=timedelta(minutes=15)
        ))

        # Architecture diagram
        sections.append(Section(
            title=&quot;Architecture Diagram&quot;,
            content=self._render_architecture_diagram(codebase.architecture),
            type=&quot;visual&quot;,
            estimated_time=timedelta(minutes=10)
        ))

        # Key services/components
        for component in codebase.architecture.main_components[:5]:
            sections.append(Section(
                title=f&quot;Component: {component.name}&quot;,
                content=await self._explain_component(component),
                type=&quot;reading&quot;,
                code_references=component.key_files,
                estimated_time=timedelta(minutes=10)
            ))

        # Interactive exploration
        sections.append(Section(
            title=&quot;Explore the Architecture&quot;,
            content=&quot;Let&#039;s walk through the codebase interactively.&quot;,
            type=&quot;interactive&quot;,
            exercise=ArchitectureExploration(codebase),
            estimated_time=timedelta(minutes=30)
        ))

        # Knowledge check
        sections.append(Section(
            title=&quot;Architecture Quiz&quot;,
            type=&quot;quiz&quot;,
            questions=await self._generate_arch_quiz(codebase),
            estimated_time=timedelta(minutes=10)
        ))

        return LearningModule(
            id=&quot;architecture&quot;,
            title=&quot;Architecture Overview&quot;,
            description=&quot;Understand the high-level structure of the codebase&quot;,
            sections=sections,
            estimated_time=sum(s.estimated_time for s in sections, timedelta())
        )

    async def answer_question(
        self,
        session: OnboardingSession,
        question: str
    ) -&gt; Answer:
        &quot;&quot;&quot;Answer a question about the codebase with full context.&quot;&quot;&quot;

        # Search for relevant code
        search_tool = self.tools.get(&quot;tool-codebase-search&quot;)
        relevant_code = await search_tool.execute({
            &quot;query&quot;: question,
            &quot;search_type&quot;: &quot;semantic&quot;,
            &quot;max_results&quot;: 10
        })

        # Get architecture context
        arch_context = self._get_relevant_architecture(
            question, session.codebase_info.architecture
        )

        # Check documentation
        doc_context = self._search_documentation(
            question, session.codebase_info.documentation
        )

        # Generate answer with full context
        answer = await self._generate_answer(
            question=question,
            code_context=relevant_code,
            architecture_context=arch_context,
            documentation_context=doc_context,
            user_profile=session.profile,
            learning_progress=session.progress
        )

        # Track question for learning insights
        session.questions_asked.append(QuestionRecord(
            question=question,
            topic=answer.topic,
            timestamp=datetime.utcnow()
        ))

        return answer

    async def run_code_walkthrough(
        self,
        session: OnboardingSession,
        starting_point: str
    ) -&gt; CodeWalkthrough:
        &quot;&quot;&quot;Interactive code walkthrough from a starting point.&quot;&quot;&quot;

        walkthrough = CodeWalkthrough(starting_point=starting_point)

        # Load starting file
        current_file = await self._load_file(starting_point)

        # Explain the file
        explanation = await self._explain_file(
            current_file, session.profile, session.codebase_info
        )

        walkthrough.add_step(WalkthroughStep(
            file=starting_point,
            explanation=explanation,
            highlights=explanation.key_lines
        ))

        # Follow imports/dependencies
        dependencies = await self._get_file_dependencies(current_file)

        walkthrough.suggested_next = [
            SuggestedExploration(
                file=dep.path,
                reason=dep.relationship,
                relevance=dep.relevance_score
            )
            for dep in dependencies[:5]
        ]

        return walkthrough


class InteractiveExplorer:
    &quot;&quot;&quot;Interactive code exploration features.&quot;&quot;&quot;

    async def explain_function(
        self,
        file_path: str,
        function_name: str,
        profile: UserProfile
    ) -&gt; FunctionExplanation:
        &quot;&quot;&quot;Explain a specific function in detail.&quot;&quot;&quot;

        # Load function code
        code = await self._extract_function(file_path, function_name)

        # Generate explanation based on experience level
        explanation = await self._generate_explanation(
            code=code,
            experience_level=profile.experience,
            familiar_technologies=profile.familiar_with
        )

        return FunctionExplanation(
            name=function_name,
            purpose=explanation.purpose,
            parameters=explanation.parameters,
            return_value=explanation.return_value,
            algorithm=explanation.algorithm,
            complexity=explanation.complexity,
            related_functions=explanation.related,
            example_usage=explanation.examples
        )

    async def trace_data_flow(
        self,
        starting_point: str,
        data_name: str
    ) -&gt; DataFlowTrace:
        &quot;&quot;&quot;Trace how data flows through the system.&quot;&quot;&quot;

        trace = DataFlowTrace(data=data_name)

        # Use dependency graph to trace
        dep_tool = self.tools.get(&quot;tool-dependency-graph&quot;)

        # Find where data originates
        sources = await dep_tool.execute({
            &quot;action&quot;: &quot;find_sources&quot;,
            &quot;symbol&quot;: data_name,
            &quot;start_file&quot;: starting_point
        })

        trace.sources = sources

        # Find transformations
        transforms = await dep_tool.execute({
            &quot;action&quot;: &quot;find_transforms&quot;,
            &quot;symbol&quot;: data_name
        })

        trace.transformations = transforms

        # Find consumers
        consumers = await dep_tool.execute({
            &quot;action&quot;: &quot;find_consumers&quot;,
            &quot;symbol&quot;: data_name
        })

        trace.consumers = consumers

        # Generate visual
        trace.diagram = self._generate_flow_diagram(sources, transforms, consumers)

        return trace


class ProgressTracker:
    &quot;&quot;&quot;Track onboarding progress and milestones.&quot;&quot;&quot;

    async def update_progress(
        self,
        user_id: str,
        module_id: str,
        section_id: str,
        completion: float
    ) -&gt; ProgressUpdate:
        &quot;&quot;&quot;Update learning progress.&quot;&quot;&quot;

        progress = self.load(user_id)

        # Update section progress
        if module_id not in progress.modules:
            progress.modules[module_id] = ModuleProgress(module_id=module_id)

        progress.modules[module_id].sections[section_id] = completion

        # Calculate module completion
        module_completion = self._calculate_module_completion(
            progress.modules[module_id]
        )
        progress.modules[module_id].completion = module_completion

        # Check milestones
        new_milestones = self._check_milestones(progress)
        for milestone in new_milestones:
            progress.milestones_achieved.append(milestone)

        # Update total progress
        progress.total_completion = self._calculate_total_completion(progress)
        progress.time_spent += self._session_time()

        self.save(user_id, progress)

        return ProgressUpdate(
            module_completion=module_completion,
            total_completion=progress.total_completion,
            new_milestones=new_milestones,
            next_recommended=self._recommend_next(progress)
        )

    def generate_report(self, user_id: str) -&gt; OnboardingReport:
        &quot;&quot;&quot;Generate progress report.&quot;&quot;&quot;

        progress = self.load(user_id)

        return OnboardingReport(
            user_id=user_id,
            started=progress.started_at,
            total_completion=progress.total_completion,
            time_spent=progress.time_spent,
            modules=[
                ModuleReport(
                    module_id=m.module_id,
                    completion=m.completion,
                    quiz_scores=m.quiz_scores,
                    challenges_completed=m.challenges_completed
                )
                for m in progress.modules.values()
            ],
            milestones=progress.milestones_achieved,
            topics_explored=progress.topics_explored,
            questions_asked=len(progress.questions),
            strengths=self._identify_strengths(progress),
            areas_for_focus=self._identify_focus_areas(progress)
        )</code></pre>
        </div>
        <p>---</p>
        <h3>Learning Module Examples</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Architecture Overview</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"># Architecture Overview

## System Structure

This codebase follows a **microservices architecture** with the following
key components:

### API Gateway (`/services/gateway/`)
The entry point for all client requests. Handles:
- Authentication/authorization
- Rate limiting
- Request routing

### User Service (`/services/users/`)
Manages user accounts, profiles, and authentication.

### Payment Service (`/services/payments/`)
Handles all payment processing with Stripe integration.

[View Architecture Diagram]

---

## Interactive Exploration

Let&#039;s explore the architecture together. I&#039;ll guide you through the
main entry points and how requests flow through the system.

**Starting point**: `services/gateway/src/index.ts`

&gt; &quot;This is the API gateway entry point. When a request comes in,
&gt; it first goes through the authentication middleware (line 45),
&gt; then gets routed to the appropriate service (line 67).&quot;

Would you like to:
1. Dive deeper into the authentication flow
2. See how a payment request is processed
3. Explore the user service
4. Ask a question

---

## Knowledge Check

1. What is the primary role of the API Gateway?
   - [ ] Database management
   - [x] Request routing and authentication
   - [ ] Payment processing

2. Where would you find the code that handles user registration?
   - [ ] services/gateway/
   - [x] services/users/
   - [ ] services/payments/</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>profile.collect</code></td><td>list</td><td>[all]</td><td>Profile info to collect</td></tr>
            <tr><td><code>content.sources.*</code></td><td>bool</td><td>varies</td><td>Documentation sources</td></tr>
            <tr><td><code>interactive.code_walkthrough</code></td><td>bool</td><td>true</td><td>Enable walkthroughs</td></tr>
            <tr><td><code>assessment.knowledge_checks</code></td><td>bool</td><td>true</td><td>Enable quizzes</td></tr>
            <tr><td><code>progress.storage</code></td><td>string</td><td>"file"</td><td>Progress storage</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required Tools</h4>
        <li><code>tool-codebase-search</code> - Code search and analysis</li>
        <li><code>tool-architecture-map</code> - Architecture visualization</li>
        <li><code>tool-dependency-graph</code> - Code flow analysis</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li>Documentation platforms (Confluence, Notion)</li>
        <li>LMS integrations</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Team integration</strong>: Assign mentors based on onboarding progress?</li>
        <li><strong>Gamification</strong>: Add achievements/badges for motivation?</li>
        <li><strong>Adaptive learning</strong>: Adjust difficulty based on performance?</li>
        <li><strong>Content updates</strong>: Auto-update when codebase changes?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-feature-planner" data-category="scenario-tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Feature Planner</span>
            <span class="spec-category">scenario-tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-scenario-feature-planner</code></p>
        </div>
        <h3>Overview</h3>
        <p>Collaborative feature planning workflow that transforms requirements into actionable technical specifications. Analyzes codebase architecture, identifies integration points, estimates complexity, and generates implementation plans with tasks.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Requirements lost in translation</td><td>Structured technical specs</td></tr>
            <tr><td>Unclear integration points</td><td>Automated architecture analysis</td></tr>
            <tr><td>Inaccurate estimates</td><td>Data-driven complexity scoring</td></tr>
            <tr><td>Scattered planning docs</td><td>Integrated planning workflow</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Workflow Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Feature Planning Pipeline                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Require- â”‚â”€â”€â”€â–¶â”‚ Analysis â”‚â”€â”€â”€â–¶â”‚ Design   â”‚â”€â”€â”€â–¶â”‚ Plan     â”‚      â”‚
â”‚  â”‚ ments    â”‚    â”‚          â”‚    â”‚          â”‚    â”‚ Output   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚               â”‚               â”‚               â”‚              â”‚
â”‚       â–¼               â–¼               â–¼               â–¼              â”‚
â”‚  â€¢ PRD/spec       â€¢ Codebase     â€¢ Components   â€¢ Tech spec        â”‚
â”‚  â€¢ User stories     analysis     â€¢ APIs         â€¢ Tasks            â”‚
â”‚  â€¢ Constraints    â€¢ Integration  â€¢ Data models  â€¢ Estimates        â”‚
â”‚  â€¢ Acceptance       points       â€¢ Sequences    â€¢ Risks            â”‚
â”‚    criteria       â€¢ Dependencies â€¢ Trade-offs   â€¢ JIRA tickets     â”‚
â”‚                                                                      â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                        â”‚ Human Review  â”‚â—€â”€â”€ At each stage           â”‚
â”‚                        â”‚ &amp; Iteration   â”‚                            â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">scenario:
  name: feature-planner
  version: &quot;1.0.0&quot;

  # Input
  input:
    requirements:
      source: markdown              # markdown | jira | notion | confluence
      path: &quot;${REQUIREMENTS_PATH}&quot;

  # Analysis stage
  analysis:
    codebase:
      enabled: true
      tools:
        - tool-codebase-search
        - tool-architecture-map
        - tool-dependency-graph
      scope:
        include:
          - &quot;src/**&quot;
          - &quot;api/**&quot;
        exclude:
          - &quot;**/*.test.*&quot;
          - &quot;node_modules/**&quot;

    patterns:
      enabled: true
      detect:
        - existing_implementations
        - coding_patterns
        - api_conventions
        - data_models

  # Design stage
  design:
    outputs:
      component_diagram: true
      sequence_diagrams: true
      api_spec: true
      data_model: true

    constraints:
      max_components: 10
      prefer_existing_patterns: true
      backwards_compatible: true

  # Planning stage
  planning:
    task_breakdown:
      granularity: medium          # fine | medium | coarse
      include_tests: true
      include_docs: true

    estimation:
      method: complexity_points    # complexity_points | hours | story_points
      confidence_threshold: 0.7

    risk_analysis:
      enabled: true
      categories:
        - technical_risk
        - integration_risk
        - scope_risk
        - dependency_risk

  # Output
  output:
    formats:
      - tech_spec_markdown
      - jira_tickets
      - architecture_diagram

    jira:
      project: &quot;${JIRA_PROJECT}&quot;
      epic_type: Epic
      story_type: Story
      task_type: Task
      create_tickets: false        # false = dry run</code></pre>
        </div>
        <p>---</p>
        <h3>Pipeline Implementation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class FeaturePlannerScenario:
    &quot;&quot;&quot;Transform requirements into implementation plans.&quot;&quot;&quot;

    def __init__(self, config: FeaturePlannerConfig):
        self.config = config
        self.tools = ToolRegistry()

    async def plan(self, requirements_path: str) -&gt; FeaturePlan:
        &quot;&quot;&quot;Execute feature planning pipeline.&quot;&quot;&quot;

        # Stage 1: Parse Requirements
        requirements = await self._parse_requirements(requirements_path)

        # Stage 2: Analyze Codebase
        analysis = await self._analyze_codebase(requirements)

        # Stage 3: Design Solution
        design = await self._design_solution(requirements, analysis)

        # Stage 4: Generate Plan
        plan = await self._generate_plan(requirements, analysis, design)

        # Stage 5: Output
        return await self._generate_outputs(plan)

    async def _parse_requirements(self, path: str) -&gt; Requirements:
        &quot;&quot;&quot;Stage 1: Parse and structure requirements.&quot;&quot;&quot;

        content = Path(path).read_text()

        # Extract structured requirements using LLM
        parsed = await self._extract_requirements(content)

        return Requirements(
            title=parsed[&quot;title&quot;],
            summary=parsed[&quot;summary&quot;],
            user_stories=parsed[&quot;user_stories&quot;],
            acceptance_criteria=parsed[&quot;acceptance_criteria&quot;],
            constraints=parsed[&quot;constraints&quot;],
            non_functional=parsed[&quot;non_functional_requirements&quot;],
            out_of_scope=parsed[&quot;out_of_scope&quot;]
        )

    async def _analyze_codebase(self, requirements: Requirements) -&gt; CodebaseAnalysis:
        &quot;&quot;&quot;Stage 2: Analyze codebase for implementation context.&quot;&quot;&quot;

        analysis = CodebaseAnalysis()

        # Search for related code
        search_tool = self.tools.get(&quot;tool-codebase-search&quot;)

        # Extract key concepts from requirements
        concepts = await self._extract_concepts(requirements)

        for concept in concepts:
            results = await search_tool.execute({
                &quot;query&quot;: concept,
                &quot;search_type&quot;: &quot;semantic&quot;,
                &quot;max_results&quot;: 10
            })
            analysis.related_code[concept] = results

        # Get architecture map
        arch_tool = self.tools.get(&quot;tool-architecture-map&quot;)
        analysis.architecture = await arch_tool.execute({
            &quot;action&quot;: &quot;generate&quot;,
            &quot;format&quot;: &quot;json&quot;
        })

        # Identify integration points
        analysis.integration_points = await self._find_integration_points(
            requirements, analysis.related_code, analysis.architecture
        )

        # Get dependency information
        dep_tool = self.tools.get(&quot;tool-dependency-graph&quot;)
        analysis.dependencies = await dep_tool.execute({
            &quot;paths&quot;: [ip.file_path for ip in analysis.integration_points]
        })

        # Detect patterns
        analysis.patterns = await self._detect_patterns(analysis.related_code)

        return analysis

    async def _find_integration_points(
        self,
        requirements: Requirements,
        related_code: dict,
        architecture: Architecture
    ) -&gt; list[IntegrationPoint]:
        &quot;&quot;&quot;Identify where new feature integrates with existing code.&quot;&quot;&quot;

        integration_points = []

        # Analyze with LLM
        prompt = f&quot;&quot;&quot;
        Given these requirements:
        {requirements.summary}

        And this existing architecture:
        {json.dumps(architecture.components)}

        Identify integration points where the new feature should connect.
        For each point, specify:
        - Component name
        - File path
        - Type (API, Event, Database, Service)
        - Why this integration is needed
        &quot;&quot;&quot;

        result = await self._llm_analyze(prompt)

        for point in result[&quot;integration_points&quot;]:
            integration_points.append(IntegrationPoint(
                component=point[&quot;component&quot;],
                file_path=point[&quot;file_path&quot;],
                integration_type=point[&quot;type&quot;],
                rationale=point[&quot;rationale&quot;],
                existing_code=related_code.get(point[&quot;component&quot;], [])
            ))

        return integration_points

    async def _design_solution(
        self,
        requirements: Requirements,
        analysis: CodebaseAnalysis
    ) -&gt; Design:
        &quot;&quot;&quot;Stage 3: Design the solution.&quot;&quot;&quot;

        design = Design()

        # Generate component design
        design.components = await self._design_components(requirements, analysis)

        # Generate API design (if needed)
        if self._needs_api(requirements):
            design.api = await self._design_api(requirements, analysis)

        # Generate data model (if needed)
        if self._needs_data_model(requirements):
            design.data_model = await self._design_data_model(requirements, analysis)

        # Generate sequence diagrams
        design.sequences = await self._design_sequences(
            requirements, design.components, analysis
        )

        # Identify trade-offs
        design.trade_offs = await self._identify_trade_offs(design, requirements)

        return design

    async def _design_components(
        self,
        requirements: Requirements,
        analysis: CodebaseAnalysis
    ) -&gt; list[ComponentDesign]:
        &quot;&quot;&quot;Design new/modified components.&quot;&quot;&quot;

        # Use existing patterns
        patterns = analysis.patterns

        prompt = f&quot;&quot;&quot;
        Design components for this feature:
        {requirements.summary}

        Integration points:
        {json.dumps([ip.to_dict() for ip in analysis.integration_points])}

        Existing patterns to follow:
        {json.dumps(patterns)}

        For each component, specify:
        - Name and purpose
        - Responsibilities
        - Interfaces (methods/APIs)
        - Dependencies
        - New vs modification of existing
        &quot;&quot;&quot;

        result = await self._llm_design(prompt)

        components = []
        for comp in result[&quot;components&quot;]:
            components.append(ComponentDesign(
                name=comp[&quot;name&quot;],
                purpose=comp[&quot;purpose&quot;],
                responsibilities=comp[&quot;responsibilities&quot;],
                interfaces=comp[&quot;interfaces&quot;],
                dependencies=comp[&quot;dependencies&quot;],
                is_new=comp[&quot;is_new&quot;],
                modifies=comp.get(&quot;modifies&quot;),
                file_path=comp.get(&quot;file_path&quot;)
            ))

        return components

    async def _generate_plan(
        self,
        requirements: Requirements,
        analysis: CodebaseAnalysis,
        design: Design
    ) -&gt; ImplementationPlan:
        &quot;&quot;&quot;Stage 4: Generate implementation plan.&quot;&quot;&quot;

        plan = ImplementationPlan(
            feature=requirements.title,
            summary=requirements.summary
        )

        # Generate tasks
        plan.tasks = await self._generate_tasks(design, analysis)

        # Estimate complexity
        plan.estimates = await self._estimate_complexity(plan.tasks, analysis)

        # Analyze risks
        plan.risks = await self._analyze_risks(requirements, design, analysis)

        # Determine milestones
        plan.milestones = await self._define_milestones(plan.tasks)

        # Calculate dependencies between tasks
        plan.task_dependencies = await self._calculate_task_dependencies(plan.tasks)

        return plan

    async def _generate_tasks(
        self,
        design: Design,
        analysis: CodebaseAnalysis
    ) -&gt; list[Task]:
        &quot;&quot;&quot;Break down design into tasks.&quot;&quot;&quot;

        tasks = []

        # Tasks for each component
        for component in design.components:
            component_tasks = await self._tasks_for_component(component, analysis)
            tasks.extend(component_tasks)

        # API tasks
        if design.api:
            api_tasks = await self._tasks_for_api(design.api)
            tasks.extend(api_tasks)

        # Data model tasks
        if design.data_model:
            data_tasks = await self._tasks_for_data_model(design.data_model)
            tasks.extend(data_tasks)

        # Testing tasks
        if self.config.planning.task_breakdown.include_tests:
            test_tasks = await self._generate_test_tasks(tasks)
            tasks.extend(test_tasks)

        # Documentation tasks
        if self.config.planning.task_breakdown.include_docs:
            doc_tasks = await self._generate_doc_tasks(design)
            tasks.extend(doc_tasks)

        return tasks

    async def _estimate_complexity(
        self,
        tasks: list[Task],
        analysis: CodebaseAnalysis
    ) -&gt; Estimates:
        &quot;&quot;&quot;Estimate task complexity.&quot;&quot;&quot;

        estimates = Estimates()

        for task in tasks:
            # Factors affecting complexity
            factors = {
                &quot;code_familiarity&quot;: self._calculate_familiarity(
                    task, analysis.patterns
                ),
                &quot;integration_complexity&quot;: self._calculate_integration_complexity(
                    task, analysis.integration_points
                ),
                &quot;technical_uncertainty&quot;: task.uncertainty,
                &quot;dependency_count&quot;: len(task.dependencies)
            }

            # Calculate complexity score
            complexity = self._calculate_complexity_score(factors)

            estimates.task_estimates[task.id] = TaskEstimate(
                complexity_points=complexity,
                confidence=self._estimate_confidence(factors),
                factors=factors
            )

        # Total estimate
        estimates.total = sum(e.complexity_points for e in estimates.task_estimates.values())
        estimates.confidence = min(e.confidence for e in estimates.task_estimates.values())

        return estimates

    async def _analyze_risks(
        self,
        requirements: Requirements,
        design: Design,
        analysis: CodebaseAnalysis
    ) -&gt; list[Risk]:
        &quot;&quot;&quot;Analyze implementation risks.&quot;&quot;&quot;

        risks = []

        # Technical risks
        if any(c.is_new for c in design.components):
            risks.append(Risk(
                category=&quot;technical_risk&quot;,
                title=&quot;New component complexity&quot;,
                description=&quot;New components may have unforeseen complexity&quot;,
                likelihood=&quot;medium&quot;,
                impact=&quot;medium&quot;,
                mitigation=&quot;Prototype new components early, get architecture review&quot;
            ))

        # Integration risks
        if len(analysis.integration_points) &gt; 3:
            risks.append(Risk(
                category=&quot;integration_risk&quot;,
                title=&quot;Multiple integration points&quot;,
                description=f&quot;Feature touches {len(analysis.integration_points)} integration points&quot;,
                likelihood=&quot;medium&quot;,
                impact=&quot;high&quot;,
                mitigation=&quot;Create integration tests early, coordinate with component owners&quot;
            ))

        # Scope risks
        if len(requirements.user_stories) &gt; 5:
            risks.append(Risk(
                category=&quot;scope_risk&quot;,
                title=&quot;Large scope&quot;,
                description=&quot;Feature has many user stories that may expand&quot;,
                likelihood=&quot;high&quot;,
                impact=&quot;medium&quot;,
                mitigation=&quot;Prioritize MVP stories, defer nice-to-haves&quot;
            ))

        # Dependency risks
        external_deps = [d for d in analysis.dependencies if d.is_external]
        if external_deps:
            risks.append(Risk(
                category=&quot;dependency_risk&quot;,
                title=&quot;External dependencies&quot;,
                description=f&quot;Feature depends on {len(external_deps)} external services&quot;,
                likelihood=&quot;medium&quot;,
                impact=&quot;high&quot;,
                mitigation=&quot;Create mocks/stubs, have fallback behavior&quot;
            ))

        return risks


class TaskGenerator:
    &quot;&quot;&quot;Generate implementation tasks from design.&quot;&quot;&quot;

    async def tasks_for_component(
        self,
        component: ComponentDesign,
        analysis: CodebaseAnalysis,
        granularity: str
    ) -&gt; list[Task]:
        &quot;&quot;&quot;Generate tasks for a component.&quot;&quot;&quot;

        tasks = []

        if component.is_new:
            # New component tasks
            tasks.append(Task(
                title=f&quot;Create {component.name} component&quot;,
                description=f&quot;Implement {component.purpose}&quot;,
                type=&quot;implementation&quot;,
                component=component.name,
                acceptance_criteria=[
                    f&quot;Implements: {&#039;, &#039;.join(component.responsibilities)}&quot;,
                    &quot;Follows existing code patterns&quot;,
                    &quot;Has unit tests&quot;
                ]
            ))

            if granularity in (&quot;fine&quot;, &quot;medium&quot;):
                # Add interface tasks
                for interface in component.interfaces:
                    tasks.append(Task(
                        title=f&quot;Implement {component.name}.{interface.name}&quot;,
                        description=interface.description,
                        type=&quot;implementation&quot;,
                        component=component.name,
                        parent=tasks[0].id
                    ))

        else:
            # Modification tasks
            tasks.append(Task(
                title=f&quot;Modify {component.modifies} for {component.name}&quot;,
                description=f&quot;Add {component.purpose} to existing component&quot;,
                type=&quot;modification&quot;,
                component=component.modifies,
                file_path=component.file_path
            ))

        return tasks</code></pre>
        </div>
        <p>---</p>
        <h3>Output Formats</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Technical Specification (Markdown)</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"># Technical Specification: User Notification Preferences

## Overview

Allow users to customize their notification preferences across email,
push, and in-app channels.

## Requirements Summary

### User Stories
1. As a user, I want to enable/disable notification channels
2. As a user, I want to set quiet hours
3. As a user, I want per-notification-type preferences

### Constraints
- Must be backwards compatible with existing notifications
- Must support GDPR data export

---

## Architecture

### Components

#### 1. NotificationPreferenceService (New)
**Purpose**: Manage user notification preferences
**Location**: `src/services/notification-preferences/`

**Interfaces**:
- `getPreferences(userId): Preferences`
- `updatePreferences(userId, updates): Preferences`
- `checkShouldNotify(userId, type, channel): boolean`

**Dependencies**:
- UserService
- NotificationService (existing, to be modified)

#### 2. NotificationService (Modification)
**Changes**: Add preference checking before sending
**Location**: `src/services/notifications/notification-service.ts`

### Data Model</code></pre>
        </div>
        <p>CREATE TABLE notification_preferences (</p>
        <p>  id UUID PRIMARY KEY,</p>
        <p>  user_id UUID REFERENCES users(id),</p>
        <p>  channel VARCHAR(50),           -- email, push, in_app</p>
        <p>  notification_type VARCHAR(100),</p>
        <p>  enabled BOOLEAN DEFAULT true,</p>
        <p>  quiet_hours_start TIME,</p>
        <p>  quiet_hours_end TIME,</p>
        <p>  created_at TIMESTAMP,</p>
        <p>  updated_at TIMESTAMP</p>
        <p>);</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">### API</code></pre>
        </div>
        <p>/api/v1/users/{userId}/notification-preferences:</p>
        <p>  GET:</p>
        <p>    summary: Get user notification preferences</p>
        <p>    responses:</p>
        <p>      200:</p>
        <p>        schema: NotificationPreferences</p>
        <p>  PATCH:</p>
        <p>    summary: Update notification preferences</p>
        <p>    body:</p>
        <p>      schema: NotificationPreferenceUpdate</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">---

## Implementation Plan

### Milestone 1: Core Preference Management (Week 1)
- [ ] Create NotificationPreferenceService
- [ ] Create database migration
- [ ] Implement CRUD API endpoints
- [ ] Add unit tests

### Milestone 2: Integration (Week 2)
- [ ] Modify NotificationService to check preferences
- [ ] Add quiet hours logic
- [ ] Integration tests

### Milestone 3: UI &amp; Polish (Week 3)
- [ ] Settings UI component
- [ ] Notification preview
- [ ] Documentation

---

## Estimates

| Task | Complexity | Confidence |
|------|------------|------------|
| NotificationPreferenceService | 5 points | 85% |
| Database migration | 2 points | 95% |
| API endpoints | 3 points | 90% |
| NotificationService modification | 3 points | 80% |
| UI components | 5 points | 75% |
| **Total** | **18 points** | **80%** |

---

## Risks

### Medium Risk: NotificationService Modification
**Impact**: Could affect existing notification delivery
**Mitigation**: Feature flag, comprehensive integration tests

### Low Risk: Performance
**Impact**: Additional DB query per notification
**Mitigation**: Cache preferences, batch queries</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">JIRA Export</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python"># Generated JIRA tickets
{
    &quot;epic&quot;: {
        &quot;project&quot;: &quot;PROJ&quot;,
        &quot;type&quot;: &quot;Epic&quot;,
        &quot;summary&quot;: &quot;User Notification Preferences&quot;,
        &quot;description&quot;: &quot;Allow users to customize notification preferences...&quot;
    },
    &quot;stories&quot;: [
        {
            &quot;type&quot;: &quot;Story&quot;,
            &quot;summary&quot;: &quot;User can enable/disable notification channels&quot;,
            &quot;description&quot;: &quot;As a user, I want to...&quot;,
            &quot;acceptance_criteria&quot;: &quot;...&quot;,
            &quot;story_points&quot;: 5
        },
        # ...
    ],
    &quot;tasks&quot;: [
        {
            &quot;type&quot;: &quot;Task&quot;,
            &quot;summary&quot;: &quot;Create NotificationPreferenceService&quot;,
            &quot;parent&quot;: &quot;PROJ-123&quot;,  # Story key
            &quot;description&quot;: &quot;Implement service with CRUD operations&quot;,
            &quot;complexity_points&quot;: 5
        },
        # ...
    ]
}</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>analysis.scope.include</code></td><td>list</td><td>["src/**"]</td><td>Paths to analyze</td></tr>
            <tr><td><code>design.constraints.backwards_compatible</code></td><td>bool</td><td>true</td><td>Require backwards compat</td></tr>
            <tr><td><code>planning.task_breakdown.granularity</code></td><td>string</td><td>"medium"</td><td>Task detail level</td></tr>
            <tr><td><code>planning.estimation.method</code></td><td>string</td><td>"complexity_points"</td><td>Estimation method</td></tr>
            <tr><td><code>output.jira.create_tickets</code></td><td>bool</td><td>false</td><td>Create actual tickets</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required Tools</h4>
        <li><code>tool-codebase-search</code> - Code analysis</li>
        <li><code>tool-architecture-map</code> - Architecture visualization</li>
        <li><code>tool-dependency-graph</code> - Dependency analysis</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional Integrations</h4>
        <li>JIRA API</li>
        <li>Confluence API</li>
        <li>Notion API</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Template library</strong>: Provide templates for common feature types?</li>
        <li><strong>Historical data</strong>: Use past estimates to improve accuracy?</li>
        <li><strong>Collaboration</strong>: Support multi-user planning sessions?</li>
        <li><strong>Integration</strong>: Deeper IDE integration for viewing plans?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-incident-responder" data-category="scenario-tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Incident Responder</span>
            <span class="spec-category">scenario-tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Critical Path)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-scenario-incident-responder</code></p>
        </div>
        <h3>Overview</h3>
        <p>Automated incident response workflow that gathers context, analyzes symptoms, suggests root causes, and coordinates remediation. Reduces MTTR by automating the information gathering and initial diagnosis phases.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual log diving</td><td>Automated log aggregation</td></tr>
            <tr><td>Knowledge scattered</td><td>Relevant context surfaced</td></tr>
            <tr><td>Slow initial diagnosis</td><td>Rapid symptom analysis</td></tr>
            <tr><td>War room chaos</td><td>Structured response workflow</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Workflow Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Incident Response Pipeline                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Alert   â”‚â”€â”€â”€â–¶â”‚ Context  â”‚â”€â”€â”€â–¶â”‚ Diagnose â”‚â”€â”€â”€â–¶â”‚ Remediateâ”‚      â”‚
â”‚  â”‚ Ingest   â”‚    â”‚ Gather   â”‚    â”‚          â”‚    â”‚          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚               â”‚               â”‚               â”‚              â”‚
â”‚       â–¼               â–¼               â–¼               â–¼              â”‚
â”‚  â€¢ PagerDuty     â€¢ Recent deploys  â€¢ Log analysis  â€¢ Rollback?      â”‚
â”‚  â€¢ Datadog       â€¢ Code changes    â€¢ Error patternsâ€¢ Config fix?    â”‚
â”‚  â€¢ Slack         â€¢ Related alerts  â€¢ Correlation   â€¢ Scale?         â”‚
â”‚  â€¢ Custom        â€¢ System metrics  â€¢ Root cause    â€¢ Communicate    â”‚
â”‚                                                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                    â”‚ Document â”‚â—€â”€â”€ Throughout                        â”‚
â”‚                    â”‚ &amp; Learn  â”‚                                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                         â”‚                                            â”‚
â”‚                         â–¼                                            â”‚
â”‚                    â€¢ Timeline                                        â”‚
â”‚                    â€¢ Postmortem                                      â”‚
â”‚                    â€¢ Runbook update                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">scenario:
  name: incident-responder
  version: &quot;1.0.0&quot;

  # Alert sources
  alerts:
    sources:
      pagerduty:
        enabled: true
        api_key: &quot;${PAGERDUTY_API_KEY}&quot;
      datadog:
        enabled: true
        api_key: &quot;${DD_API_KEY}&quot;
        app_key: &quot;${DD_APP_KEY}&quot;
      slack:
        enabled: true
        channel: &quot;#incidents&quot;

  # Context gathering
  context:
    # Recent deployments
    deployments:
      sources:
        - github-actions
        - argocd
        - jenkins
      lookback: 24h

    # Code changes
    code:
      lookback: 48h
      focus_areas:              # Priority areas to check
        - config
        - database
        - api
        - dependencies

    # Observability
    metrics:
      provider: datadog         # datadog | prometheus | cloudwatch
      queries:
        error_rate: &quot;sum:http.requests{status:5xx}.as_rate()&quot;
        latency_p99: &quot;avg:http.request.latency.p99{*}&quot;
        cpu: &quot;avg:system.cpu.user{*}&quot;
        memory: &quot;avg:system.mem.used{*}&quot;
      lookback: 4h

    # Logs
    logs:
      provider: datadog         # datadog | elasticsearch | cloudwatch
      lookback: 2h
      max_entries: 1000
      focus_patterns:
        - &quot;error&quot;
        - &quot;exception&quot;
        - &quot;timeout&quot;
        - &quot;connection refused&quot;

    # Related incidents
    history:
      similar_lookback: 90d
      correlation_threshold: 0.7

  # Diagnosis
  diagnosis:
    # Analysis approaches
    approaches:
      log_pattern_analysis: true
      metric_correlation: true
      change_correlation: true
      similar_incident_match: true

    # Root cause categories
    categories:
      - deployment_issue
      - configuration_error
      - capacity_problem
      - dependency_failure
      - code_bug
      - external_factor

  # Remediation
  remediation:
    # Automated actions (require approval)
    actions:
      rollback:
        enabled: true
        require_approval: true
      scale:
        enabled: true
        require_approval: true
      config_revert:
        enabled: true
        require_approval: true

    # Communication
    communication:
      slack_channel: &quot;#incidents&quot;
      status_page: true
      stakeholder_notify: true

  # Documentation
  documentation:
    timeline: true
    auto_postmortem: true
    runbook_suggestions: true</code></pre>
        </div>
        <p>---</p>
        <h3>Pipeline Implementation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class IncidentResponderScenario:
    &quot;&quot;&quot;Automated incident response workflow.&quot;&quot;&quot;

    def __init__(self, config: IncidentConfig):
        self.config = config
        self.tools = ToolRegistry()
        self.timeline = Timeline()

    async def respond(self, alert: Alert) -&gt; IncidentReport:
        &quot;&quot;&quot;Execute incident response pipeline.&quot;&quot;&quot;

        # Initialize incident
        incident = await self._initialize_incident(alert)
        self.timeline.add(&quot;Incident started&quot;, alert.summary)

        # Stage 1: Gather Context
        context = await self._gather_context(incident)
        self.timeline.add(&quot;Context gathered&quot;, f&quot;{len(context.items)} items&quot;)

        # Stage 2: Diagnose
        diagnosis = await self._diagnose(incident, context)
        self.timeline.add(&quot;Diagnosis complete&quot;, diagnosis.summary)

        # Stage 3: Suggest Remediation
        remediation = await self._suggest_remediation(diagnosis)
        self.timeline.add(&quot;Remediation suggested&quot;, remediation.summary)

        # Stage 4: Coordinate Response
        if self.config.remediation.communication.slack_channel:
            await self._post_status(incident, diagnosis, remediation)

        # Generate report
        return await self._generate_report(
            incident, context, diagnosis, remediation
        )

    async def _gather_context(self, incident: Incident) -&gt; IncidentContext:
        &quot;&quot;&quot;Stage 1: Gather all relevant context.&quot;&quot;&quot;

        context = IncidentContext()

        # Parallel context gathering
        tasks = [
            self._get_recent_deploys(incident),
            self._get_recent_changes(incident),
            self._get_metrics(incident),
            self._get_logs(incident),
            self._get_similar_incidents(incident),
            self._get_related_alerts(incident),
        ]

        results = await asyncio.gather(*tasks, return_exceptions=True)

        context.deployments = results[0] if not isinstance(results[0], Exception) else []
        context.code_changes = results[1] if not isinstance(results[1], Exception) else []
        context.metrics = results[2] if not isinstance(results[2], Exception) else {}
        context.logs = results[3] if not isinstance(results[3], Exception) else []
        context.similar_incidents = results[4] if not isinstance(results[4], Exception) else []
        context.related_alerts = results[5] if not isinstance(results[5], Exception) else []

        return context

    async def _get_recent_deploys(self, incident: Incident) -&gt; list[Deployment]:
        &quot;&quot;&quot;Get recent deployments.&quot;&quot;&quot;
        deployments = []

        for source in self.config.context.deployments.sources:
            if source == &quot;github-actions&quot;:
                runs = await self._query_github_actions(incident)
                deployments.extend(runs)
            elif source == &quot;argocd&quot;:
                syncs = await self._query_argocd(incident)
                deployments.extend(syncs)

        # Sort by time, most recent first
        deployments.sort(key=lambda d: d.timestamp, reverse=True)

        return deployments

    async def _get_logs(self, incident: Incident) -&gt; list[LogEntry]:
        &quot;&quot;&quot;Fetch relevant logs.&quot;&quot;&quot;
        metrics_tool = self.tools.get(&quot;tool-metrics-query&quot;)

        # Build log query based on incident
        query = self._build_log_query(incident)

        logs = await metrics_tool.execute({
            &quot;action&quot;: &quot;query_logs&quot;,
            &quot;provider&quot;: self.config.context.logs.provider,
            &quot;query&quot;: query,
            &quot;start_time&quot;: incident.started_at - timedelta(
                hours=int(self.config.context.logs.lookback.rstrip(&#039;h&#039;))
            ),
            &quot;end_time&quot;: datetime.utcnow(),
            &quot;limit&quot;: self.config.context.logs.max_entries
        })

        # Filter for relevant entries
        filtered = self._filter_relevant_logs(logs, incident)

        return filtered

    async def _diagnose(
        self,
        incident: Incident,
        context: IncidentContext
    ) -&gt; Diagnosis:
        &quot;&quot;&quot;Stage 2: Analyze and diagnose.&quot;&quot;&quot;

        hypotheses = []

        # Approach 1: Log pattern analysis
        if self.config.diagnosis.approaches.log_pattern_analysis:
            log_hypothesis = await self._analyze_log_patterns(context.logs)
            if log_hypothesis:
                hypotheses.append(log_hypothesis)

        # Approach 2: Metric correlation
        if self.config.diagnosis.approaches.metric_correlation:
            metric_hypothesis = await self._analyze_metric_correlation(
                context.metrics, incident
            )
            if metric_hypothesis:
                hypotheses.append(metric_hypothesis)

        # Approach 3: Change correlation
        if self.config.diagnosis.approaches.change_correlation:
            change_hypothesis = await self._correlate_changes(
                context.deployments, context.code_changes, incident
            )
            if change_hypothesis:
                hypotheses.append(change_hypothesis)

        # Approach 4: Similar incident matching
        if self.config.diagnosis.approaches.similar_incident_match:
            similar_hypothesis = await self._match_similar_incidents(
                context.similar_incidents, incident
            )
            if similar_hypothesis:
                hypotheses.append(similar_hypothesis)

        # Synthesize diagnosis
        diagnosis = await self._synthesize_diagnosis(hypotheses, context)

        return diagnosis

    async def _analyze_log_patterns(self, logs: list[LogEntry]) -&gt; Hypothesis | None:
        &quot;&quot;&quot;Analyze logs for error patterns.&quot;&quot;&quot;

        # Extract error patterns
        error_patterns = defaultdict(int)
        error_examples = defaultdict(list)

        for log in logs:
            if log.level in (&quot;error&quot;, &quot;fatal&quot;):
                pattern = self._extract_pattern(log.message)
                error_patterns[pattern] += 1
                if len(error_examples[pattern]) &lt; 3:
                    error_examples[pattern].append(log)

        if not error_patterns:
            return None

        # Find dominant pattern
        dominant = max(error_patterns, key=error_patterns.get)
        count = error_patterns[dominant]

        # Analyze pattern
        analysis = await self._analyze_error_pattern(
            dominant, error_examples[dominant]
        )

        return Hypothesis(
            category=analysis.category,
            description=analysis.description,
            confidence=min(0.9, count / 100),  # More occurrences = higher confidence
            evidence=[
                f&quot;Error pattern occurred {count} times&quot;,
                f&quot;First occurrence: {error_examples[dominant][0].timestamp}&quot;,
                f&quot;Example: {error_examples[dominant][0].message[:200]}&quot;
            ],
            suggested_actions=analysis.suggested_actions
        )

    async def _correlate_changes(
        self,
        deployments: list[Deployment],
        code_changes: list[CodeChange],
        incident: Incident
    ) -&gt; Hypothesis | None:
        &quot;&quot;&quot;Correlate incident with recent changes.&quot;&quot;&quot;

        # Find changes in time window before incident
        window_start = incident.started_at - timedelta(hours=4)

        suspect_deploys = [
            d for d in deployments
            if window_start &lt;= d.timestamp &lt;= incident.started_at
        ]

        if not suspect_deploys:
            return None

        # Most recent deployment is prime suspect
        prime_suspect = suspect_deploys[0]

        # Analyze what changed
        changes = await self._analyze_deployment_changes(prime_suspect)

        return Hypothesis(
            category=&quot;deployment_issue&quot;,
            description=f&quot;Incident correlates with deployment {prime_suspect.id}&quot;,
            confidence=0.7,
            evidence=[
                f&quot;Deployment at {prime_suspect.timestamp}&quot;,
                f&quot;Incident started at {incident.started_at}&quot;,
                f&quot;Time between: {incident.started_at - prime_suspect.timestamp}&quot;,
                f&quot;Changes: {&#039;, &#039;.join(changes.summary)}&quot;
            ],
            suggested_actions=[
                f&quot;Consider rollback to {prime_suspect.previous_version}&quot;,
                &quot;Review deployment changes for issues&quot;,
                &quot;Check deployment health metrics&quot;
            ],
            metadata={
                &quot;deployment_id&quot;: prime_suspect.id,
                &quot;previous_version&quot;: prime_suspect.previous_version,
                &quot;changes&quot;: changes
            }
        )

    async def _suggest_remediation(self, diagnosis: Diagnosis) -&gt; Remediation:
        &quot;&quot;&quot;Stage 3: Suggest remediation actions.&quot;&quot;&quot;

        actions = []

        for hypothesis in diagnosis.hypotheses:
            if hypothesis.category == &quot;deployment_issue&quot;:
                if hypothesis.confidence &gt;= 0.6:
                    actions.append(RemediationAction(
                        type=&quot;rollback&quot;,
                        description=&quot;Roll back to previous version&quot;,
                        command=f&quot;kubectl rollout undo deployment/{hypothesis.metadata[&#039;deployment&#039;]}&quot;,
                        risk=&quot;low&quot;,
                        require_approval=True
                    ))

            elif hypothesis.category == &quot;capacity_problem&quot;:
                actions.append(RemediationAction(
                    type=&quot;scale&quot;,
                    description=&quot;Scale up affected service&quot;,
                    command=f&quot;kubectl scale deployment/{hypothesis.metadata[&#039;service&#039;]} --replicas=+2&quot;,
                    risk=&quot;low&quot;,
                    require_approval=True
                ))

            elif hypothesis.category == &quot;configuration_error&quot;:
                actions.append(RemediationAction(
                    type=&quot;config_revert&quot;,
                    description=&quot;Revert configuration change&quot;,
                    risk=&quot;medium&quot;,
                    require_approval=True
                ))

        # Add communication actions
        actions.append(RemediationAction(
            type=&quot;communicate&quot;,
            description=&quot;Update status page&quot;,
            risk=&quot;none&quot;,
            require_approval=False
        ))

        return Remediation(
            primary_action=actions[0] if actions else None,
            alternative_actions=actions[1:],
            communication_plan=await self._generate_comms_plan(diagnosis)
        )

    async def _post_status(
        self,
        incident: Incident,
        diagnosis: Diagnosis,
        remediation: Remediation
    ) -&gt; None:
        &quot;&quot;&quot;Post status update to Slack.&quot;&quot;&quot;

        slack_tool = self.tools.get(&quot;tool-slack-search&quot;)

        message = self._format_status_message(incident, diagnosis, remediation)

        await slack_tool.execute({
            &quot;action&quot;: &quot;post&quot;,
            &quot;channel&quot;: self.config.remediation.communication.slack_channel,
            &quot;message&quot;: message,
            &quot;thread_ts&quot;: incident.slack_thread_ts  # Continue in thread if exists
        })</code></pre>
        </div>
        <p>---</p>
        <h3>Status Message Format</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown">ðŸš¨ **Incident Update: Payment Processing Errors**

**Status**: Investigating
**Severity**: P1
**Duration**: 23 minutes

---

### Summary
Payment API returning 500 errors for ~15% of requests since 14:32 UTC.

### Initial Diagnosis
**Most Likely Cause**: Recent deployment (deploy-abc123 at 14:28 UTC)
**Confidence**: 75%

**Evidence**:
- Error spike began 4 minutes after deployment
- Errors concentrated in new payment validation code
- No infrastructure anomalies detected

### Suggested Actions
1. âš¡ **Recommended**: Rollback to previous version (v2.3.4)
2. ðŸ”§ Alternative: Hot-fix validation logic
3. ðŸ“ž Notify payment team

### Timeline
- 14:28 - Deployment deploy-abc123 completed
- 14:32 - First errors detected
- 14:35 - Alert triggered (PagerDuty)
- 14:37 - Incident responder activated
- 14:45 - Initial diagnosis complete

---
ðŸ¤– *Generated by Incident Responder*</code></pre>
        </div>
        <p>---</p>
        <h3>Postmortem Generation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class PostmortemGenerator:
    &quot;&quot;&quot;Generate postmortem from incident data.&quot;&quot;&quot;

    async def generate(
        self,
        incident: Incident,
        timeline: Timeline,
        diagnosis: Diagnosis,
        remediation_taken: RemediationAction
    ) -&gt; Postmortem:
        &quot;&quot;&quot;Generate structured postmortem.&quot;&quot;&quot;

        return Postmortem(
            title=f&quot;Postmortem: {incident.title}&quot;,
            date=incident.started_at.date(),
            duration=incident.resolved_at - incident.started_at,
            severity=incident.severity,

            summary=await self._generate_summary(incident, diagnosis),

            impact=Impact(
                users_affected=incident.metrics.users_affected,
                requests_failed=incident.metrics.requests_failed,
                revenue_impact=incident.metrics.revenue_impact,
                sla_breach=incident.metrics.sla_breach
            ),

            timeline=timeline.entries,

            root_cause=RootCause(
                category=diagnosis.primary_hypothesis.category,
                description=diagnosis.primary_hypothesis.description,
                evidence=diagnosis.primary_hypothesis.evidence
            ),

            resolution=Resolution(
                action_taken=remediation_taken.description,
                time_to_resolve=incident.resolved_at - incident.started_at,
                verified_by=remediation_taken.verified_by
            ),

            lessons_learned=await self._extract_lessons(incident, diagnosis),

            action_items=await self._generate_action_items(incident, diagnosis),

            appendix=Appendix(
                logs=incident.key_logs,
                metrics=incident.key_metrics,
                related_links=incident.related_links
            )
        )

    async def _generate_action_items(
        self,
        incident: Incident,
        diagnosis: Diagnosis
    ) -&gt; list[ActionItem]:
        &quot;&quot;&quot;Generate follow-up action items.&quot;&quot;&quot;

        items = []

        # Prevention items
        if diagnosis.primary_hypothesis.category == &quot;deployment_issue&quot;:
            items.append(ActionItem(
                type=&quot;prevention&quot;,
                title=&quot;Improve deployment canary analysis&quot;,
                description=&quot;Add automated canary metrics checking&quot;,
                priority=&quot;high&quot;,
                owner=None  # To be assigned
            ))

        # Detection items
        if incident.time_to_detect &gt; timedelta(minutes=5):
            items.append(ActionItem(
                type=&quot;detection&quot;,
                title=&quot;Improve alerting thresholds&quot;,
                description=f&quot;Current TTD was {incident.time_to_detect}, target is &lt;5min&quot;,
                priority=&quot;medium&quot;
            ))

        # Documentation items
        items.append(ActionItem(
            type=&quot;documentation&quot;,
            title=&quot;Update runbook for this failure mode&quot;,
            description=f&quot;Add steps for {diagnosis.primary_hypothesis.category}&quot;,
            priority=&quot;low&quot;
        ))

        return items</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>context.deployments.lookback</code></td><td>string</td><td>"24h"</td><td>Deploy history window</td></tr>
            <tr><td><code>context.logs.lookback</code></td><td>string</td><td>"2h"</td><td>Log query window</td></tr>
            <tr><td><code>context.metrics.lookback</code></td><td>string</td><td>"4h"</td><td>Metrics window</td></tr>
            <tr><td><code>diagnosis.approaches.*</code></td><td>bool</td><td>true</td><td>Enable diagnosis approaches</td></tr>
            <tr><td><code>remediation.actions.*.require_approval</code></td><td>bool</td><td>true</td><td>Require human approval</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required Tools</h4>
        <li><code>tool-metrics-query</code> - Observability data</li>
        <li><code>tool-git-advanced</code> - Change correlation</li>
        <li><code>tool-slack-search</code> - Communication</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">External Integrations</h4>
        <li>PagerDuty / OpsGenie API</li>
        <li>Datadog / Prometheus</li>
        <li>GitHub / GitLab</li>
        <li>Slack</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Automated remediation</strong>: How much automation without human approval?</li>
        <li><strong>ML diagnosis</strong>: Train on past incidents for better pattern matching?</li>
        <li><strong>Runbook integration</strong>: Link to and execute runbooks?</li>
        <li><strong>Multi-service correlation</strong>: Handle distributed system incidents?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-pr-reviewer" data-category="scenario-tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Pr Reviewer</span>
            <span class="spec-category">scenario-tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P0 (Critical Path)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-scenario-pr-reviewer</code></p>
        </div>
        <h3>Overview</h3>
        <p>Comprehensive pull request review automation that analyzes code changes, checks for issues, runs tests, and provides structured feedback. Combines multiple tools and hooks into a coherent review workflow that augments human reviewers.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Manual code inspection</td><td>Automated issue detection</td></tr>
            <tr><td>Missed edge cases</td><td>Systematic coverage analysis</td></tr>
            <tr><td>Inconsistent review quality</td><td>Standardized review checklist</td></tr>
            <tr><td>Hours per complex PR</td><td>Minutes with human verification</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Workflow Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PR Review Pipeline                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Context  â”‚â”€â”€â”€â–¶â”‚ Analysis â”‚â”€â”€â”€â–¶â”‚ Testing  â”‚â”€â”€â”€â–¶â”‚ Report   â”‚      â”‚
â”‚  â”‚ Gather   â”‚    â”‚ Phase    â”‚    â”‚ Phase    â”‚    â”‚ Generate â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚               â”‚               â”‚               â”‚              â”‚
â”‚       â–¼               â–¼               â–¼               â–¼              â”‚
â”‚  â€¢ PR metadata    â€¢ Security     â€¢ Run tests    â€¢ Summary          â”‚
â”‚  â€¢ File diffs     â€¢ Code quality â€¢ Coverage     â€¢ Issues list      â”‚
â”‚  â€¢ Related PRs    â€¢ Breaking     â€¢ Performance  â€¢ Suggestions      â”‚
â”‚  â€¢ Linked issues    changes      â€¢ Linting      â€¢ Approval rec     â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">scenario:
  name: pr-reviewer
  version: &quot;1.0.0&quot;

  # Input
  input:
    pr_url: &quot;${PR_URL}&quot;                 # Required: GitHub/GitLab PR URL
    depth: standard                      # quick | standard | thorough

  # Pipeline stages
  stages:
    context:
      enabled: true
      tools:
        - tool-pr-context
        - tool-jira-ops
      config:
        fetch_linked_issues: true
        fetch_related_prs: true
        max_related: 5

    analysis:
      enabled: true
      parallel: true                     # Run analyses in parallel
      analyses:
        security:
          enabled: true
          hook: hooks-security-scan
          severity_threshold: medium

        code_quality:
          enabled: true
          tool: tool-codebase-search
          checks:
            - complexity
            - duplication
            - naming
            - documentation

        breaking_changes:
          enabled: true
          hook: hooks-breaking-change
          check_api: true
          check_schema: true

        license:
          enabled: true
          hook: hooks-license-checker

        architecture:
          enabled: true
          tool: tool-dependency-graph
          check_cycles: true
          check_boundaries: true

    testing:
      enabled: true
      tool: tool-test-runner
      config:
        run_affected: true              # Only tests affected by changes
        coverage_threshold: 80
        require_new_tests: true         # New code needs tests

    style:
      enabled: true
      hook: hooks-style-enforcer
      auto_fix: false                   # Don&#039;t auto-fix in review

  # Output
  output:
    format: markdown                    # markdown | json | github-review
    post_comment: true                  # Post as PR comment
    request_changes: auto               # auto | manual | never
    approve_threshold: 0                # 0 issues = auto approve suggestion

  # Customization
  rules:
    # File-specific rules
    paths:
      - pattern: &quot;src/api/**&quot;
        require_openapi_update: true
      - pattern: &quot;migrations/**&quot;
        require_dba_approval: true
      - pattern: &quot;*.test.*&quot;
        skip_coverage_check: true

    # Reviewer-specific
    expertise_match: true               # Match reviewers to changed areas</code></pre>
        </div>
        <p>---</p>
        <h3>Pipeline Implementation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class PRReviewerScenario:
    &quot;&quot;&quot;Comprehensive PR review automation.&quot;&quot;&quot;

    def __init__(self, config: PRReviewerConfig):
        self.config = config
        self.tools = ToolRegistry()
        self.hooks = HookRegistry()

    async def run(self, pr_url: str) -&gt; ReviewReport:
        &quot;&quot;&quot;Execute full review pipeline.&quot;&quot;&quot;

        # Stage 1: Gather Context
        context = await self._gather_context(pr_url)

        # Stage 2: Run Analyses (parallel)
        analyses = await self._run_analyses(context)

        # Stage 3: Run Tests
        test_results = await self._run_tests(context)

        # Stage 4: Style Check
        style_results = await self._check_style(context)

        # Stage 5: Generate Report
        report = await self._generate_report(
            context, analyses, test_results, style_results
        )

        # Stage 6: Post Results
        if self.config.output.post_comment:
            await self._post_comment(pr_url, report)

        return report

    async def _gather_context(self, pr_url: str) -&gt; PRContext:
        &quot;&quot;&quot;Stage 1: Gather all relevant context.&quot;&quot;&quot;

        # Get PR details
        pr_context_tool = self.tools.get(&quot;tool-pr-context&quot;)
        pr_data = await pr_context_tool.execute({
            &quot;pr_url&quot;: pr_url,
            &quot;include_diff&quot;: True,
            &quot;include_comments&quot;: True,
            &quot;include_reviews&quot;: True
        })

        # Get linked issues
        jira_tool = self.tools.get(&quot;tool-jira-ops&quot;)
        linked_issues = []

        for issue_ref in pr_data.get(&quot;linked_issues&quot;, []):
            issue = await jira_tool.execute({
                &quot;action&quot;: &quot;get&quot;,
                &quot;issue_key&quot;: issue_ref
            })
            linked_issues.append(issue)

        # Get related PRs
        related_prs = await pr_context_tool.execute({
            &quot;action&quot;: &quot;find_related&quot;,
            &quot;pr_url&quot;: pr_url,
            &quot;max_results&quot;: self.config.stages.context.config.max_related
        })

        return PRContext(
            pr=pr_data,
            linked_issues=linked_issues,
            related_prs=related_prs,
            changed_files=pr_data[&quot;changed_files&quot;],
            diff=pr_data[&quot;diff&quot;]
        )

    async def _run_analyses(self, context: PRContext) -&gt; AnalysisResults:
        &quot;&quot;&quot;Stage 2: Run all configured analyses in parallel.&quot;&quot;&quot;

        tasks = []
        results = AnalysisResults()

        if self.config.stages.analysis.analyses.security.enabled:
            tasks.append(self._analyze_security(context))

        if self.config.stages.analysis.analyses.code_quality.enabled:
            tasks.append(self._analyze_quality(context))

        if self.config.stages.analysis.analyses.breaking_changes.enabled:
            tasks.append(self._analyze_breaking(context))

        if self.config.stages.analysis.analyses.license.enabled:
            tasks.append(self._analyze_licenses(context))

        if self.config.stages.analysis.analyses.architecture.enabled:
            tasks.append(self._analyze_architecture(context))

        # Run in parallel
        completed = await asyncio.gather(*tasks, return_exceptions=True)

        # Collect results
        for result in completed:
            if isinstance(result, Exception):
                results.errors.append(str(result))
            else:
                results.merge(result)

        return results

    async def _analyze_security(self, context: PRContext) -&gt; SecurityAnalysis:
        &quot;&quot;&quot;Run security analysis on changed files.&quot;&quot;&quot;

        security_hook = self.hooks.get(&quot;hooks-security-scan&quot;)
        issues = []

        for file in context.changed_files:
            result = await security_hook({
                &quot;file_path&quot;: file.path,
                &quot;content&quot;: file.new_content,
                &quot;diff&quot;: file.diff
            })

            if result.findings:
                issues.extend(result.findings)

        # Filter by severity threshold
        threshold = self.config.stages.analysis.analyses.security.severity_threshold
        filtered = [i for i in issues if i.severity &gt;= threshold]

        return SecurityAnalysis(
            issues=filtered,
            passed=len([i for i in filtered if i.severity == &quot;high&quot;]) == 0
        )

    async def _analyze_breaking(self, context: PRContext) -&gt; BreakingAnalysis:
        &quot;&quot;&quot;Check for breaking changes.&quot;&quot;&quot;

        breaking_hook = self.hooks.get(&quot;hooks-breaking-change&quot;)
        changes = []

        for file in context.changed_files:
            if file.old_content:  # Existing file modified
                result = await breaking_hook.analyze(
                    file.path,
                    file.old_content,
                    file.new_content
                )
                changes.extend(result.breaking_changes)

        return BreakingAnalysis(
            changes=changes,
            requires_version_bump=len(changes) &gt; 0
        )

    async def _run_tests(self, context: PRContext) -&gt; TestResults:
        &quot;&quot;&quot;Stage 3: Run relevant tests.&quot;&quot;&quot;

        test_tool = self.tools.get(&quot;tool-test-runner&quot;)

        # Determine affected tests
        affected = await test_tool.execute({
            &quot;action&quot;: &quot;find_affected&quot;,
            &quot;changed_files&quot;: [f.path for f in context.changed_files]
        })

        # Run tests
        results = await test_tool.execute({
            &quot;action&quot;: &quot;run&quot;,
            &quot;test_files&quot;: affected,
            &quot;coverage&quot;: True
        })

        # Check coverage for new code
        if self.config.stages.testing.config.require_new_tests:
            new_code_coverage = self._calculate_new_code_coverage(
                context, results.coverage
            )
            results.new_code_coverage = new_code_coverage

        return results

    async def _generate_report(
        self,
        context: PRContext,
        analyses: AnalysisResults,
        tests: TestResults,
        style: StyleResults
    ) -&gt; ReviewReport:
        &quot;&quot;&quot;Stage 5: Generate comprehensive review report.&quot;&quot;&quot;

        # Collect all issues
        all_issues = []
        all_issues.extend(analyses.security.issues)
        all_issues.extend(analyses.breaking.changes)
        all_issues.extend(analyses.quality.issues)
        all_issues.extend(style.issues)

        # Determine recommendation
        blocking_issues = [i for i in all_issues if i.blocking]
        recommendation = self._determine_recommendation(
            blocking_issues, tests, analyses
        )

        # Generate summary using LLM
        summary = await self._generate_summary(context, all_issues, tests)

        return ReviewReport(
            pr_url=context.pr[&quot;url&quot;],
            summary=summary,
            recommendation=recommendation,
            issues=all_issues,
            test_results=tests,
            analyses=analyses,
            suggested_reviewers=await self._suggest_reviewers(context)
        )

    def _determine_recommendation(
        self,
        blocking_issues: list,
        tests: TestResults,
        analyses: AnalysisResults
    ) -&gt; ReviewRecommendation:
        &quot;&quot;&quot;Determine review recommendation.&quot;&quot;&quot;

        if blocking_issues:
            return ReviewRecommendation(
                action=&quot;request_changes&quot;,
                reason=f&quot;{len(blocking_issues)} blocking issues found&quot;,
                confidence=0.9
            )

        if not tests.passed:
            return ReviewRecommendation(
                action=&quot;request_changes&quot;,
                reason=&quot;Tests failing&quot;,
                confidence=0.95
            )

        if analyses.security.issues:
            return ReviewRecommendation(
                action=&quot;comment&quot;,
                reason=&quot;Security findings require review&quot;,
                confidence=0.7
            )

        # All checks passed
        return ReviewRecommendation(
            action=&quot;approve&quot;,
            reason=&quot;All automated checks passed&quot;,
            confidence=0.8
        )</code></pre>
        </div>
        <p>---</p>
        <h3>Report Format</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Markdown Output</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"># PR Review: Add payment retry logic (#1234)

## Summary

This PR adds exponential backoff retry logic to the payment gateway.
Changes look good overall with a few minor suggestions.

**Recommendation: âœ… Approve** (with comments)

---

## Analysis Results

### Security (âœ… Passed)
No security issues detected.

### Breaking Changes (âš ï¸ Warning)
- API endpoint `POST /payments` has new required field `idempotency_key`
  - **Suggestion**: Make field optional for backward compatibility

### Code Quality (âœ… Passed)
- Complexity: Within limits
- Duplication: None detected
- Test coverage: 87% (threshold: 80%)

### License Check (âœ… Passed)
No new dependencies with restricted licenses.

---

## Test Results

| Suite | Passed | Failed | Skipped |
|-------|--------|--------|---------|
| Unit  | 45     | 0      | 2       |
| Integration | 12 | 0   | 0       |

**Coverage**: 87% overall, 92% for new code

---

## Issues (3)

### ðŸ”´ High Priority

1. **Missing error handling** (src/payments/gateway.py:142)
   ```python
   # Current
   response = await client.post(url, data)

   # Suggested
   try:
       response = await client.post(url, data)
   except TimeoutError:
       raise PaymentTimeoutError(...)
   ```

### ðŸŸ¡ Medium Priority

2. **Consider adding type hints** (src/payments/retry.py:28)
   Function `calculate_backoff` lacks return type annotation.

### ðŸŸ¢ Low Priority

3. **Documentation update needed** (README.md)
   New retry behavior should be documented.

---

## Suggested Reviewers

Based on code ownership and expertise:
- **@alice** - Primary owner of payments module
- **@bob** - Recent contributor to gateway code

---

*Generated by PR Reviewer v1.0.0*</code></pre>
        </div>
        <p>---</p>
        <h3>Integration with CI/CD</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">GitHub Actions</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">name: PR Review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run PR Review
        uses: amplifier/pr-reviewer-action@v1
        with:
          pr-url: ${{ github.event.pull_request.html_url }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          depth: standard
          post-comment: true</code></pre>
        </div>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">GitLab CI</h4>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">pr-review:
  stage: review
  script:
    - amplifier run pr-reviewer --pr-url $CI_MERGE_REQUEST_IID
  rules:
    - if: $CI_PIPELINE_SOURCE == &quot;merge_request_event&quot;</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>input.depth</code></td><td>string</td><td>"standard"</td><td>Review depth</td></tr>
            <tr><td><code>stages.*.enabled</code></td><td>bool</td><td>true</td><td>Enable/disable stages</td></tr>
            <tr><td><code>output.format</code></td><td>string</td><td>"markdown"</td><td>Output format</td></tr>
            <tr><td><code>output.post_comment</code></td><td>bool</td><td>true</td><td>Post as PR comment</td></tr>
            <tr><td><code>output.request_changes</code></td><td>string</td><td>"auto"</td><td>When to request changes</td></tr>
            <tr><td><code>rules.expertise_match</code></td><td>bool</td><td>true</td><td>Match reviewers to areas</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required Tools</h4>
        <li><code>tool-pr-context</code> - PR data fetching</li>
        <li><code>tool-test-runner</code> - Test execution</li>
        <li><code>tool-codebase-search</code> - Code analysis</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required Hooks</h4>
        <li><code>hooks-security-scan</code> - Security analysis</li>
        <li><code>hooks-breaking-change</code> - Breaking change detection</li>
        <li><code>hooks-license-checker</code> - License compliance</li>
        <li><code>hooks-style-enforcer</code> - Style checking</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">External</h4>
        <li>GitHub/GitLab API access</li>
        <li>CI/CD integration (optional)</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>ML enhancement</strong>: Train on past reviews to improve suggestions?</li>
        <li><strong>Custom rules</strong>: Support organization-specific review rules?</li>
        <li><strong>Review history</strong>: Track review patterns and outcomes?</li>
        <li><strong>Batch review</strong>: Review multiple related PRs together?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        <div class="spec-section" id="spec-tech-debt-prioritizer" data-category="scenario-tools">
          <div class="spec-header" onclick="toggleSpec(this)">
            <span class="spec-title">Tech Debt Prioritizer</span>
            <span class="spec-category">scenario-tools</span>
            <svg class="spec-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="spec-content">
            
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Priority</strong>: P1 (High Value)</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Status</strong>: Draft</p>
        </div>
        <div class="info-box" style="border-left: 4px solid var(--accent);">
          <p style="margin: 0; color: var(--text-1);"><strong>Module</strong>: <code>amplifier-scenario-tech-debt-prioritizer</code></p>
        </div>
        <h3>Overview</h3>
        <p>Systematic technical debt identification and prioritization workflow. Scans codebase for debt indicators, calculates business impact, estimates remediation effort, and generates prioritized action plans aligned with product goals.</p>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Value Proposition</h4>
        <table class="ref-table">
          <thead>
            <tr><th>Without</th><th>With</th></tr>
          </thead>
          <tbody>
            <tr><td>Invisible accumulating debt</td><td>Visible, tracked inventory</td></tr>
            <tr><td>Arbitrary prioritization</td><td>Data-driven decisions</td></tr>
            <tr><td>Debt addressed reactively</td><td>Strategic planning</td></tr>
            <tr><td>No ROI visibility</td><td>Clear cost/benefit analysis</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Workflow Architecture</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Tech Debt Prioritization Pipeline                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Scan    â”‚â”€â”€â”€â–¶â”‚ Analyze  â”‚â”€â”€â”€â–¶â”‚ Priorit- â”‚â”€â”€â”€â–¶â”‚ Plan     â”‚      â”‚
â”‚  â”‚          â”‚    â”‚ Impact   â”‚    â”‚ ize      â”‚    â”‚          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚               â”‚               â”‚               â”‚              â”‚
â”‚       â–¼               â–¼               â–¼               â–¼              â”‚
â”‚  â€¢ Code smell     â€¢ Velocity      â€¢ Business     â€¢ Sprints          â”‚
â”‚    detection        impact          alignment   â€¢ Resources         â”‚
â”‚  â€¢ Complexity     â€¢ Bug           â€¢ Cost/        â€¢ Dependencies     â”‚
â”‚  â€¢ Duplication      correlation     benefit    â€¢ Risks             â”‚
â”‚  â€¢ Dependencies   â€¢ Change risk   â€¢ Quick wins  â€¢ Tracking         â”‚
â”‚  â€¢ Test coverage  â€¢ Team pain     â€¢ Critical                       â”‚
â”‚                                                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                    â”‚ Dashboard     â”‚â—€â”€â”€ Continuous                  â”‚
â”‚                    â”‚ &amp; Reporting   â”‚                                â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">yaml</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-yaml">scenario:
  name: tech-debt-prioritizer
  version: &quot;1.0.0&quot;

  # Scanning
  scan:
    # Code analysis
    code:
      complexity:
        enabled: true
        threshold:
          cyclomatic: 10
          cognitive: 15
      duplication:
        enabled: true
        min_tokens: 50
        min_occurrences: 2
      code_smells:
        enabled: true
        rules:
          - long_method
          - large_class
          - feature_envy
          - shotgun_surgery
          - god_object
      naming:
        enabled: true
        conventions: auto-detect

    # Architecture
    architecture:
      dependency_cycles: true
      layer_violations: true
      unstable_dependencies: true
      dead_code: true

    # Testing
    testing:
      coverage_threshold: 80
      test_quality: true
      flaky_tests: true

    # Dependencies
    dependencies:
      outdated: true
      security_vulnerabilities: true
      deprecated_usage: true
      unmaintained: 365d          # Not updated in X days

    # Documentation
    documentation:
      missing_docs: true
      stale_docs: true
      incomplete_api_docs: true

  # Impact analysis
  impact:
    # Correlations
    correlations:
      bugs_by_file: true
      change_frequency: true
      review_time: true
      deployment_failures: true

    # Sources
    sources:
      jira:
        enabled: true
        bug_labels: [&quot;bug&quot;, &quot;defect&quot;]
        lookback: 180d
      github:
        enabled: true
        lookback: 365d

  # Prioritization
  prioritization:
    # Scoring weights
    weights:
      business_impact: 0.30
      remediation_effort: 0.20       # Inverse - prefer easier
      bug_correlation: 0.20
      change_risk: 0.15
      team_pain: 0.15

    # Business alignment
    alignment:
      roadmap_areas:                # Priority multiplier for roadmap areas
        - path: &quot;src/payments/&quot;
          multiplier: 1.5
        - path: &quot;src/onboarding/&quot;
          multiplier: 1.3

    # Categories
    categories:
      critical:                     # Address immediately
        threshold: 0.9
      high:                         # Next quarter
        threshold: 0.7
      medium:                       # Future planning
        threshold: 0.4
      low:                          # Track but defer
        threshold: 0.0

  # Output
  output:
    report_format: markdown
    jira_export: true
    dashboard_data: true
    tracking:
      create_epics: false
      update_existing: true</code></pre>
        </div>
        <p>---</p>
        <h3>Pipeline Implementation</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">python</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-python">class TechDebtPrioritizerScenario:
    &quot;&quot;&quot;Systematic tech debt identification and prioritization.&quot;&quot;&quot;

    def __init__(self, config: TechDebtConfig):
        self.config = config
        self.tools = ToolRegistry()

    async def run(self) -&gt; TechDebtReport:
        &quot;&quot;&quot;Execute full tech debt analysis pipeline.&quot;&quot;&quot;

        # Stage 1: Scan Codebase
        debt_items = await self._scan_codebase()

        # Stage 2: Analyze Impact
        for item in debt_items:
            item.impact = await self._analyze_impact(item)

        # Stage 3: Prioritize
        prioritized = await self._prioritize(debt_items)

        # Stage 4: Generate Plan
        plan = await self._generate_plan(prioritized)

        # Stage 5: Output
        return await self._generate_report(prioritized, plan)

    async def _scan_codebase(self) -&gt; list[DebtItem]:
        &quot;&quot;&quot;Stage 1: Scan for all tech debt indicators.&quot;&quot;&quot;

        debt_items = []

        # Code analysis
        if self.config.scan.code.complexity.enabled:
            complexity_issues = await self._scan_complexity()
            debt_items.extend(complexity_issues)

        if self.config.scan.code.duplication.enabled:
            duplication_issues = await self._scan_duplication()
            debt_items.extend(duplication_issues)

        if self.config.scan.code.code_smells.enabled:
            smell_issues = await self._scan_code_smells()
            debt_items.extend(smell_issues)

        # Architecture analysis
        if self.config.scan.architecture.dependency_cycles:
            cycle_issues = await self._scan_dependency_cycles()
            debt_items.extend(cycle_issues)

        if self.config.scan.architecture.dead_code:
            dead_code_issues = await self._scan_dead_code()
            debt_items.extend(dead_code_issues)

        # Testing analysis
        coverage_issues = await self._scan_test_coverage()
        debt_items.extend(coverage_issues)

        # Dependency analysis
        dep_issues = await self._scan_dependencies()
        debt_items.extend(dep_issues)

        # Deduplicate and merge related issues
        debt_items = self._consolidate_issues(debt_items)

        return debt_items

    async def _scan_complexity(self) -&gt; list[DebtItem]:
        &quot;&quot;&quot;Scan for code complexity issues.&quot;&quot;&quot;

        debt_tool = self.tools.get(&quot;tool-tech-debt-scanner&quot;)

        results = await debt_tool.execute({
            &quot;scan_type&quot;: &quot;complexity&quot;,
            &quot;thresholds&quot;: {
                &quot;cyclomatic&quot;: self.config.scan.code.complexity.threshold.cyclomatic,
                &quot;cognitive&quot;: self.config.scan.code.complexity.threshold.cognitive
            }
        })

        items = []
        for result in results:
            items.append(DebtItem(
                id=f&quot;complexity-{hash(result[&#039;file&#039;] + str(result[&#039;line&#039;]))}&quot;,
                type=&quot;complexity&quot;,
                title=f&quot;High complexity in {result[&#039;function&#039;]}&quot;,
                description=f&quot;Cyclomatic: {result[&#039;cyclomatic&#039;]}, Cognitive: {result[&#039;cognitive&#039;]}&quot;,
                location=Location(
                    file=result[&quot;file&quot;],
                    line_start=result[&quot;line&quot;],
                    line_end=result[&quot;line_end&quot;]
                ),
                severity=self._complexity_severity(result),
                raw_data=result
            ))

        return items

    async def _scan_duplication(self) -&gt; list[DebtItem]:
        &quot;&quot;&quot;Scan for code duplication.&quot;&quot;&quot;

        debt_tool = self.tools.get(&quot;tool-tech-debt-scanner&quot;)

        results = await debt_tool.execute({
            &quot;scan_type&quot;: &quot;duplication&quot;,
            &quot;min_tokens&quot;: self.config.scan.code.duplication.min_tokens,
            &quot;min_occurrences&quot;: self.config.scan.code.duplication.min_occurrences
        })

        items = []
        for dup in results:
            items.append(DebtItem(
                id=f&quot;dup-{hash(str(dup[&#039;locations&#039;]))}&quot;,
                type=&quot;duplication&quot;,
                title=f&quot;Duplicated code ({dup[&#039;occurrences&#039;]} occurrences)&quot;,
                description=f&quot;{dup[&#039;tokens&#039;]} tokens duplicated across {dup[&#039;occurrences&#039;]} locations&quot;,
                locations=[Location(**loc) for loc in dup[&quot;locations&quot;]],
                severity=self._duplication_severity(dup),
                raw_data=dup
            ))

        return items

    async def _scan_dependencies(self) -&gt; list[DebtItem]:
        &quot;&quot;&quot;Scan for dependency issues.&quot;&quot;&quot;

        dep_tool = self.tools.get(&quot;tool-dependency-graph&quot;)
        items = []

        # Outdated dependencies
        if self.config.scan.dependencies.outdated:
            outdated = await dep_tool.execute({
                &quot;action&quot;: &quot;check_outdated&quot;
            })

            for dep in outdated:
                severity = &quot;high&quot; if dep[&quot;major_versions_behind&quot;] &gt; 1 else &quot;medium&quot;
                items.append(DebtItem(
                    id=f&quot;outdated-{dep[&#039;name&#039;]}&quot;,
                    type=&quot;outdated_dependency&quot;,
                    title=f&quot;Outdated: {dep[&#039;name&#039;]}&quot;,
                    description=f&quot;Current: {dep[&#039;current&#039;]}, Latest: {dep[&#039;latest&#039;]}&quot;,
                    severity=severity,
                    metadata={
                        &quot;package&quot;: dep[&quot;name&quot;],
                        &quot;current&quot;: dep[&quot;current&quot;],
                        &quot;latest&quot;: dep[&quot;latest&quot;],
                        &quot;breaking_changes&quot;: dep.get(&quot;breaking_changes&quot;, [])
                    }
                ))

        # Security vulnerabilities
        if self.config.scan.dependencies.security_vulnerabilities:
            vulns = await dep_tool.execute({
                &quot;action&quot;: &quot;security_audit&quot;
            })

            for vuln in vulns:
                items.append(DebtItem(
                    id=f&quot;vuln-{vuln[&#039;id&#039;]}&quot;,
                    type=&quot;security_vulnerability&quot;,
                    title=f&quot;Security: {vuln[&#039;package&#039;]} ({vuln[&#039;severity&#039;]})&quot;,
                    description=vuln[&quot;description&quot;],
                    severity=&quot;critical&quot; if vuln[&quot;severity&quot;] == &quot;high&quot; else vuln[&quot;severity&quot;],
                    metadata=vuln
                ))

        return items

    async def _analyze_impact(self, item: DebtItem) -&gt; ImpactAnalysis:
        &quot;&quot;&quot;Stage 2: Analyze impact of a debt item.&quot;&quot;&quot;

        impact = ImpactAnalysis()

        # Bug correlation
        if self.config.impact.correlations.bugs_by_file and item.location:
            jira_tool = self.tools.get(&quot;tool-jira-ops&quot;)
            bugs = await jira_tool.execute({
                &quot;action&quot;: &quot;search&quot;,
                &quot;jql&quot;: f&#039;labels in ({&quot;,&quot;.join(self.config.impact.sources.jira.bug_labels)}) &#039;
                       f&#039;AND text ~ &quot;{item.location.file}&quot;&#039;
            })
            impact.bug_count = len(bugs)
            impact.bug_correlation = min(len(bugs) / 10, 1.0)  # Normalize

        # Change frequency
        if self.config.impact.correlations.change_frequency and item.location:
            git_tool = self.tools.get(&quot;tool-git-advanced&quot;)
            history = await git_tool.execute({
                &quot;action&quot;: &quot;file_history&quot;,
                &quot;file&quot;: item.location.file,
                &quot;days&quot;: 365
            })
            impact.change_frequency = len(history)
            impact.change_risk = self._calculate_change_risk(history)

        # Team pain (from PR review times)
        if self.config.impact.correlations.review_time and item.location:
            pr_tool = self.tools.get(&quot;tool-pr-context&quot;)
            prs = await pr_tool.execute({
                &quot;action&quot;: &quot;search&quot;,
                &quot;file&quot;: item.location.file
            })
            if prs:
                avg_review_time = sum(pr[&quot;review_hours&quot;] for pr in prs) / len(prs)
                impact.team_pain = min(avg_review_time / 24, 1.0)  # Normalize

        # Business impact (based on area)
        impact.business_impact = self._calculate_business_impact(item)

        return impact

    def _calculate_business_impact(self, item: DebtItem) -&gt; float:
        &quot;&quot;&quot;Calculate business impact score.&quot;&quot;&quot;

        base_impact = {
            &quot;security_vulnerability&quot;: 1.0,
            &quot;complexity&quot;: 0.5,
            &quot;duplication&quot;: 0.3,
            &quot;outdated_dependency&quot;: 0.4,
            &quot;test_coverage&quot;: 0.5,
            &quot;dead_code&quot;: 0.2
        }.get(item.type, 0.3)

        # Apply roadmap multiplier
        if item.location:
            for area in self.config.prioritization.alignment.roadmap_areas:
                if item.location.file.startswith(area[&quot;path&quot;]):
                    base_impact *= area[&quot;multiplier&quot;]
                    break

        return min(base_impact, 1.0)

    async def _prioritize(self, items: list[DebtItem]) -&gt; list[PrioritizedDebt]:
        &quot;&quot;&quot;Stage 3: Score and prioritize debt items.&quot;&quot;&quot;

        weights = self.config.prioritization.weights
        prioritized = []

        for item in items:
            # Calculate composite score
            score = (
                weights.business_impact * item.impact.business_impact +
                weights.remediation_effort * (1 - item.estimated_effort / 40) +  # Inverse
                weights.bug_correlation * item.impact.bug_correlation +
                weights.change_risk * item.impact.change_risk +
                weights.team_pain * item.impact.team_pain
            )

            # Determine category
            category = self._categorize_score(score)

            prioritized.append(PrioritizedDebt(
                item=item,
                score=score,
                category=category,
                score_breakdown={
                    &quot;business_impact&quot;: item.impact.business_impact,
                    &quot;effort_score&quot;: 1 - item.estimated_effort / 40,
                    &quot;bug_correlation&quot;: item.impact.bug_correlation,
                    &quot;change_risk&quot;: item.impact.change_risk,
                    &quot;team_pain&quot;: item.impact.team_pain
                }
            ))

        # Sort by score descending
        prioritized.sort(key=lambda x: x.score, reverse=True)

        return prioritized

    async def _generate_plan(
        self,
        prioritized: list[PrioritizedDebt]
    ) -&gt; RemediationPlan:
        &quot;&quot;&quot;Stage 4: Generate actionable remediation plan.&quot;&quot;&quot;

        plan = RemediationPlan()

        # Quick wins (high score, low effort)
        plan.quick_wins = [
            p for p in prioritized
            if p.score &gt;= 0.6 and p.item.estimated_effort &lt;= 4
        ][:5]

        # Critical items (must address)
        plan.critical = [
            p for p in prioritized
            if p.category == &quot;critical&quot;
        ]

        # Sprint candidates (next 2 weeks)
        sprint_capacity = 40  # Story points
        plan.next_sprint = self._fit_to_capacity(
            [p for p in prioritized if p.category in (&quot;critical&quot;, &quot;high&quot;)],
            sprint_capacity
        )

        # Quarterly roadmap
        plan.quarterly = self._plan_quarterly(prioritized)

        # Track improvements
        plan.expected_improvements = self._calculate_improvements(plan)

        return plan

    def _fit_to_capacity(
        self,
        items: list[PrioritizedDebt],
        capacity: int
    ) -&gt; list[PrioritizedDebt]:
        &quot;&quot;&quot;Fit items into sprint capacity.&quot;&quot;&quot;

        selected = []
        remaining_capacity = capacity

        for item in items:
            if item.item.estimated_effort &lt;= remaining_capacity:
                selected.append(item)
                remaining_capacity -= item.item.estimated_effort

        return selected


class TechDebtScanner:
    &quot;&quot;&quot;Scanner for various tech debt indicators.&quot;&quot;&quot;

    async def scan_code_smells(
        self,
        rules: list[str]
    ) -&gt; list[dict]:
        &quot;&quot;&quot;Detect code smells.&quot;&quot;&quot;

        findings = []

        for rule in rules:
            if rule == &quot;long_method&quot;:
                findings.extend(await self._find_long_methods())
            elif rule == &quot;large_class&quot;:
                findings.extend(await self._find_large_classes())
            elif rule == &quot;god_object&quot;:
                findings.extend(await self._find_god_objects())
            elif rule == &quot;shotgun_surgery&quot;:
                findings.extend(await self._find_shotgun_surgery())

        return findings

    async def _find_god_objects(self) -&gt; list[dict]:
        &quot;&quot;&quot;Find god objects (classes that do too much).&quot;&quot;&quot;

        # Use AST analysis
        findings = []

        for file in self._get_source_files():
            classes = await self._parse_classes(file)

            for cls in classes:
                # God object indicators
                indicators = {
                    &quot;method_count&quot;: len(cls.methods),
                    &quot;dependency_count&quot;: len(cls.dependencies),
                    &quot;loc&quot;: cls.lines_of_code,
                    &quot;responsibility_count&quot;: self._estimate_responsibilities(cls)
                }

                if (indicators[&quot;method_count&quot;] &gt; 20 or
                    indicators[&quot;dependency_count&quot;] &gt; 10 or
                    indicators[&quot;responsibility_count&quot;] &gt; 3):
                    findings.append({
                        &quot;type&quot;: &quot;god_object&quot;,
                        &quot;file&quot;: file,
                        &quot;class&quot;: cls.name,
                        &quot;indicators&quot;: indicators,
                        &quot;suggestion&quot;: f&quot;Consider splitting {cls.name} into smaller, focused classes&quot;
                    })

        return findings</code></pre>
        </div>
        <p>---</p>
        <h3>Report Format</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">markdown</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-markdown"># Technical Debt Report

**Generated**: 2024-01-15
**Scan Coverage**: 1,234 files analyzed
**Total Debt Items**: 156

## Executive Summary

| Category | Count | Estimated Effort |
|----------|-------|------------------|
| Critical | 8     | 45 hours        |
| High     | 23    | 120 hours       |
| Medium   | 67    | 280 hours       |
| Low      | 58    | 200 hours       |

**Total Estimated Effort**: 645 hours (~16 weeks)

### Key Findings

1. **Security vulnerabilities** in 3 dependencies require immediate attention
2. **Payment module** has highest complexity debt (affects roadmap priority)
3. **Test coverage** below threshold in 12 modules

---

## Quick Wins (High Impact, Low Effort)

### 1. Update vulnerable dependency: lodash
**Effort**: 1 hour | **Impact Score**: 0.95

Current: 4.17.15 â†’ Latest: 4.17.21
- Fixes prototype pollution vulnerability (CVE-2021-23337)
- No breaking changes</code></pre>
        </div>
        <p>npm update lodash</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">### 2. Extract duplicated validation logic
**Effort**: 2 hours | **Impact Score**: 0.82

Found in:
- `src/api/users.ts:45`
- `src/api/payments.ts:67`
- `src/api/orders.ts:89`

Suggested: Create `src/utils/validation.ts`

---

## Critical Items

### CRIT-1: SQL Injection Vulnerability
**Location**: `src/db/queries.ts:123`
**Severity**: Critical
**Bug Correlation**: 0 (not yet exploited)

Raw SQL string concatenation detected. Must use parameterized queries.

**Current Code**:</code></pre>
        </div>
        <p>const query = <code>SELECT * FROM users WHERE id = '${userId}'</code>;</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">**Remediation**:</code></pre>
        </div>
        <p>const query = 'SELECT * FROM users WHERE id = $1';</p>
        <p>await db.query(query, [userId]);</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">---

## Sprint Recommendations

### Next Sprint (40 points capacity)

| Item | Points | Score | Category |
|------|--------|-------|----------|
| CRIT-1: SQL Injection | 2 | 0.98 | Critical |
| CRIT-2: Auth bypass | 4 | 0.95 | Critical |
| HIGH-1: Payment complexity | 8 | 0.85 | High |
| HIGH-2: Duplicate handlers | 4 | 0.78 | High |

**Total**: 18 points (45% capacity)

**Remaining capacity** for feature work or additional debt.

---

## Quarterly Roadmap

### Q1 Focus: Security &amp; Stability
- All critical security items
- Payment module refactoring
- Test coverage improvement

### Q2 Focus: Architecture
- Dependency cycle resolution
- Dead code removal
- Documentation updates

---

## Trends

### Debt Accumulation (6 months)</code></pre>
        </div>
        <p>Jan: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 89 items</p>
        <p>Feb: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 102 items</p>
        <p>Mar: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 118 items</p>
        <p>Apr: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 134 items</p>
        <p>May: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 145 items</p>
        <p>Jun: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 156 items</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">text</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre><code class="language-text">**Trend**: +12% monthly accumulation
**Recommendation**: Allocate 20% sprint capacity to debt reduction

---

## Appendix

### Methodology
- Complexity: Cyclomatic + Cognitive complexity analysis
- Duplication: Token-based detection (min 50 tokens)
- Impact: Weighted score based on bugs, changes, team pain

### Configuration Used
- Complexity threshold: Cyclomatic &gt; 10, Cognitive &gt; 15
- Coverage threshold: 80%
- Lookback period: 180 days for correlation analysis</code></pre>
        </div>
        <p>---</p>
        <h3>Configuration Options</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>scan.code.complexity.threshold.*</code></td><td>int</td><td>varies</td><td>Complexity thresholds</td></tr>
            <tr><td><code>scan.code.duplication.min_tokens</code></td><td>int</td><td>50</td><td>Min duplication size</td></tr>
            <tr><td><code>impact.sources.jira.lookback</code></td><td>string</td><td>"180d"</td><td>Bug correlation period</td></tr>
            <tr><td><code>prioritization.weights.*</code></td><td>float</td><td>varies</td><td>Scoring weights</td></tr>
          </tbody>
        </table>
        <p>---</p>
        <h3>Dependencies</h3>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Required Tools</h4>
        <li><code>tool-tech-debt-scanner</code> - Code analysis</li>
        <li><code>tool-dependency-graph</code> - Dependency analysis</li>
        <li><code>tool-git-advanced</code> - Change history</li>
        <h4 style="color: var(--text-1); font-size: 14px; margin: 16px 0 8px;">Optional</h4>
        <li><code>tool-jira-ops</code> - Bug correlation</li>
        <li><code>tool-pr-context</code> - Review time analysis</li>
        <p>---</p>
        <h3>Open Questions</h3>
        <li><strong>Baseline tracking</strong>: Track debt trends over time?</li>
        <li><strong>Team allocation</strong>: Suggest who should work on what?</li>
        <li><strong>Automated fixing</strong>: Auto-remediate simple issues?</li>
        <li><strong>CI integration</strong>: Block PRs that increase debt?</li>
        <p>---</p>
        <h3>Changelog</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Version</th><th>Date</th><th>Changes</th></tr>
          </thead>
          <tbody>
            <tr><td>0.1.0</td><td>Draft</td><td>Initial specification</td></tr>
          </tbody>
        </table>
          </div>
        </div>
        </div>
        <!-- END AUTO-GENERATED -->
      </div>

      <!-- Roadmap Tab -->
      <div id="contrib-roadmap" class="tab-content">
        <div class="callout" style="background: #fef3c7; border-color: #f59e0b; border-left: 4px solid #f59e0b; color: #92400e;">
          <p style="color: #92400e; margin: 0;"><strong>âš ï¸ Guidelines, Not Commitments:</strong> This roadmap is subject to change based on new information, priorities, and discoveries.</p>
        </div>

        <h3>Project Status</h3>
        <p>Amplifier is an <strong>experimental platform</strong> focused on discovering what's possible when AI partnership amplifies human capability. We're building a system that makes AI assistants dramatically more effective.</p>

        <h3>Current Focus Areas</h3>
        <div class="personas">
          <div class="persona">
            <strong>ðŸ”§ Building Amplifier with Amplifier</strong>
            <p>Using Amplifier to improve and extend Amplifier. Building new capabilities, improving existing features, and climbing the ladder of metacognitive recipes.</p>
          </div>
          <div class="persona">
            <strong>ðŸŒŸ Discovering Emergent Value</strong>
            <p>Recognizing and amplifying use-cases that emerge from the system. Surfacing emergent uses, especially those extending beyond code development.</p>
          </div>
        </div>

        <h3>Exploration Directions</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Area</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Orchestration Strategies</strong></td>
              <td>Specialized orchestrators tailored to specific workflows, optimization goals, or interaction patterns.</td>
            </tr>
            <tr>
              <td><strong>Collections &amp; Workflows</strong></td>
              <td>Collections for new domains, workflows, or ways of organizing reusable knowledge and patterns.</td>
            </tr>
            <tr>
              <td><strong>Metacognitive Recipes</strong></td>
              <td>Structured workflows mixing tasks with higher-level philosophy, decision-making rationale, and problem-solving.</td>
            </tr>
            <tr>
              <td><strong>Context &amp; Memory</strong></td>
              <td>Richer approaches to memory, knowledge synthesis, session learning, and team context sharing.</td>
            </tr>
            <tr>
              <td><strong>Learning from Sessions</strong></td>
              <td>Tools to parse session data, reconstruct logs, and analyze patterns for system improvement.</td>
            </tr>
          </tbody>
        </table>

        <h3>Naming Conventions</h3>
        <p>When creating your own repositories:</p>
        <ul>
          <li><strong>Applications:</strong> <code>amplifier-app-{name}</code></li>
          <li><strong>Modules:</strong> <code>amplifier-module-{type}-{name}</code></li>
          <li><strong>Collections:</strong> <code>amplifier-collection-{name}</code></li>
        </ul>

        <h3>Security Warning</h3>
        <div class="callout" style="background: #fee2e2; border-color: #ef4444; border-left: 4px solid #ef4444; color: #991b1b;">
          <p style="color: #991b1b; margin: 0;"><strong>âš ï¸ Critical:</strong> Modules and applications execute arbitrary code with full system access. Users must review code before installation. Build with security in mind.</p>
        </div>
      </div>

      <!-- Repository Rules Tab -->
      <div id="contrib-rules" class="tab-content">
        <div class="callout" style="border-left: 4px solid var(--accent);">
          <p><strong>Single Source of Truth:</strong> Content lives in ONE place. Other repos link via GitHub URLs. No duplication.</p>
        </div>

        <h3>Core Principles</h3>
        <div class="info-box">
          <ul style="margin: 0;">
            <li><strong>Link, don't duplicate</strong> - Reference via GitHub URLs, never copy content</li>
            <li><strong>Respect awareness</strong> - Only reference repos you actually depend on</li>
            <li><strong>Docs are contract</strong> - Documentation defines what code must implement</li>
            <li><strong>Challenge necessity</strong> - Only create content that provides unique value</li>
          </ul>
        </div>

        <h3>Dependency-Based Awareness</h3>
        <p><strong>The Golden Rule:</strong> A repository can only reference another if it has a <strong>declared dependency</strong> on it.</p>
        
        <table class="ref-table">
          <thead>
            <tr><th>Repository Type</th><th>Can Reference</th><th>Cannot Reference</th></tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Entry Point</strong> (amplifier)</td>
              <td>Everything</td>
              <td>â€”</td>
            </tr>
            <tr>
              <td><strong>Kernel</strong> (amplifier-core)</td>
              <td>Only entry point</td>
              <td>Libraries, modules, apps</td>
            </tr>
            <tr>
              <td><strong>Libraries</strong></td>
              <td>Core + entry + declared dependencies</td>
              <td>Peer libraries, apps</td>
            </tr>
            <tr>
              <td><strong>Modules</strong></td>
              <td>Core only (+ entry for "getting started")</td>
              <td>Other modules, libraries, apps</td>
            </tr>
            <tr>
              <td><strong>Applications</strong></td>
              <td>Everything they consume</td>
              <td>â€”</td>
            </tr>
          </tbody>
        </table>

        <h3>What Goes Where</h3>
        <table class="ref-table">
          <thead>
            <tr><th>Content Type</th><th>Repository</th><th>Example</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>Kernel contracts</td>
              <td><code>amplifier-core</code></td>
              <td>Mount Plan spec, event taxonomy</td>
            </tr>
            <tr>
              <td>Library APIs</td>
              <td><code>amplifier-{library}</code></td>
              <td>ProfileLoader API â†’ amplifier-profiles</td>
            </tr>
            <tr>
              <td>Bundles &amp; best practices</td>
              <td><code>amplifier-foundation</code></td>
              <td>Reference bundles, composition patterns</td>
            </tr>
            <tr>
              <td>Module catalog</td>
              <td><code>amplifier</code></td>
              <td>MODULES.md with all ecosystem modules</td>
            </tr>
            <tr>
              <td>App implementation</td>
              <td><code>amplifier-app-*</code></td>
              <td>CLI commands, search paths</td>
            </tr>
            <tr>
              <td>Module-specific docs</td>
              <td><code>amplifier-module-*</code></td>
              <td>Config options, usage examples</td>
            </tr>
          </tbody>
        </table>

        <h3>Bundle Composition Model</h3>
        <div class="callout" style="border-left: 4px solid var(--green);">
          <p><strong>Key Insight:</strong> Bundles compose <strong>ON TOP</strong> of foundation. They don't merge INTO it.</p>
        </div>

        <div class="pattern-card correct">
          <div class="pattern-label">âœ“ CORRECT: Compose on top</div>
          <pre><code class="language-yaml"># your-app/bundle.yaml
bundle:
  name: my-app

# Compose ON TOP of foundation
includes:
  - source: git+https://github.com/microsoft/amplifier-foundation@main
    path: bundles/default/bundle.md

# Add your modules
tools:
  - module: tool-custom
    source: git+https://github.com/you/amplifier-module-tool-custom@v1.0.0</code></pre>
        </div>

        <div class="pattern-card incorrect">
          <div class="pattern-label">âœ— WRONG: Merge into foundation</div>
          <pre><code class="language-yaml"># DON'T: Submit PR to amplifier-foundation with your app's bundle
# DON'T: Put app-specific modules in foundation
# DON'T: Modify foundation bundles for your use case</code></pre>
        </div>

        <h3>Contributing Modules to Ecosystem</h3>
        <div class="info-box">
          <strong>To add your module to MODULES.md:</strong>
          <ol style="margin: 8px 0 0 0;">
            <li>Build module following <a href="https://github.com/microsoft/amplifier/blob/main/docs/DEVELOPER.md" target="_blank">DEVELOPER.md</a></li>
            <li>Publish to GitHub with comprehensive README</li>
            <li>Include tests and specify compatible versions</li>
            <li>Submit PR to <code>microsoft/amplifier</code> â†’ <code>docs/MODULES.md</code></li>
          </ol>
          <p style="margin-top: 12px; color: var(--text-2);"><strong>Note:</strong> Module contributions go to <code>amplifier</code> repo, NOT <code>amplifier-core</code> or <code>amplifier-foundation</code>.</p>
        </div>

        <h3>Anti-Patterns to Avoid</h3>
        <div class="pattern-card incorrect" style="margin-bottom: 12px;">
          <div class="pattern-label">âœ— Duplicate content</div>
          <p style="margin: 0; color: var(--text-1);">Don't copy profile docs to amplifier README. Link to amplifier-profiles instead.</p>
        </div>
        <div class="pattern-card incorrect" style="margin-bottom: 12px;">
          <div class="pattern-label">âœ— Core references library</div>
          <p style="margin: 0; color: var(--text-1);">amplifier-core shouldn't mention amplifier-profiles. Core doesn't know libraries exist.</p>
        </div>
        <div class="pattern-card incorrect" style="margin-bottom: 12px;">
          <div class="pattern-label">âœ— Module references module</div>
          <p style="margin: 0; color: var(--text-1);">tool-bash shouldn't reference tool-filesystem. Modules don't know about peers.</p>
        </div>
        <div class="pattern-card incorrect">
          <div class="pattern-label">âœ— Local file links to external repo</div>
          <p style="margin: 0; color: var(--text-1);">Don't use <code>../amplifier-profiles/docs/</code>. Use GitHub URLs for external refs.</p>
        </div>

        <h3>Quick Reference Links</h3>
        <div class="info-box">
          <table class="mini-table">
            <tr><td><strong>Full Repository Rules</strong></td><td><a href="https://github.com/microsoft/amplifier/blob/main/docs/REPOSITORY_RULES.md" target="_blank">REPOSITORY_RULES.md</a></td></tr>
            <tr><td><strong>Module Catalog</strong></td><td><a href="https://github.com/microsoft/amplifier/blob/main/docs/MODULES.md" target="_blank">MODULES.md</a></td></tr>
            <tr><td><strong>Developer Guide</strong></td><td><a href="https://github.com/microsoft/amplifier/blob/main/docs/DEVELOPER.md" target="_blank">DEVELOPER.md</a></td></tr>
            <tr><td><strong>Bundle Guide</strong></td><td><a href="https://github.com/microsoft/amplifier-foundation/blob/main/docs/BUNDLE_GUIDE.md" target="_blank">BUNDLE_GUIDE.md</a></td></tr>
          </table>
        </div>
      </div>

    </section>

    <!-- UPDATES SECTION -->
    <section id="section-updates" class="section">
      <h1>Ecosystem Updates</h1>
      <p class="section-desc">Recent commits and changes across the Amplifier ecosystem repositories.</p>

      <!-- Repo Filter -->
      <div class="notification-tabs" id="updates-tabs" style="margin-bottom: 24px; padding: 0; border: none; background: transparent;">
        <button class="notification-tab active" data-repo="all">All Repos</button>
        <button class="notification-tab" data-repo="amplifier">amplifier</button>
        <button class="notification-tab" data-repo="amplifier-core">amplifier-core</button>
        <button class="notification-tab" data-repo="amplifier-foundation">amplifier-foundation</button>
      </div>

      <!-- Updates List -->
      <div id="updates-list" class="updates-list">
        <div class="notification-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5;">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          <div>Loading updates...</div>
        </div>
      </div>

      <!-- Links -->
      <div style="margin-top: 32px; padding: 20px; background: var(--bg-1); border: 1px solid var(--border); border-radius: 8px;">
        <h3 style="margin-top: 0;">Repository Links</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">
          <a href="https://github.com/microsoft/amplifier" target="_blank" class="btn-secondary" style="text-align: center;">
            amplifier (CLI)
          </a>
          <a href="https://github.com/microsoft/amplifier-core" target="_blank" class="btn-secondary" style="text-align: center;">
            amplifier-core (Kernel)
          </a>
          <a href="https://github.com/microsoft/amplifier-foundation" target="_blank" class="btn-secondary" style="text-align: center;">
            amplifier-foundation (Bundles)
          </a>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-links">
      <a href="https://github.com/microsoft/amplifier" target="_blank">GitHub</a>
      <a href="https://github.com/microsoft/amplifier/issues" target="_blank">Issues</a>
      <a href="https://microsoft.github.io/amplifier-docs" target="_blank">Official Docs</a>
    </div>
    <p class="footer-copy">Â© Microsoft Corporation Â· MIT License</p>
  </footer>

  <!-- Prism.js -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-toml.min.js"></script>

  <!-- ES Module App -->
  <script type="module" src="js/app.js"></script>

  <!-- Chat Widget -->
  <script src="js/chat-widget.js"></script>
</body>
</html>
